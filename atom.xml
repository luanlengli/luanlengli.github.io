<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>luanlengli&#39;s Blog</title>
  
  <subtitle>“不知道”的五大理由，不读，不查，不试，理解能力差，满脑子想着怎么利用他人</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://luanlengli.github.io/"/>
  <updated>2020-02-21T08:40:07.504Z</updated>
  <id>https://luanlengli.github.io/</id>
  
  <author>
    <name>乱愣黎</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>开发语言包管理工具设置国内镜像源</title>
    <link href="https://luanlengli.github.io/2020/01/17/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80%E5%8C%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E8%AE%BE%E7%BD%AE%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E6%BA%90.html"/>
    <id>https://luanlengli.github.io/2020/01/17/开发语言包管理工具设置国内镜像源.html</id>
    <published>2020-01-17T01:23:33.000Z</published>
    <updated>2020-02-21T08:40:07.504Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>开发语言内置的包管理工具一般都是使用国外服务器作为源，国内访问非常慢</li><li>国内各大云厂商基本都做了对应的镜像源，果断用起来！</li></ul><h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1><h2 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure><h2 id="华为云"><a href="#华为云" class="headerlink" title="华为云"></a>华为云</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.huaweicloud.com/repository/pypi/simple</span><br></pre></td></tr></table></figure><h2 id="腾讯云"><a href="#腾讯云" class="headerlink" title="腾讯云"></a>腾讯云</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.cloud.tencent.com/pypi/simple</span><br></pre></td></tr></table></figure><h2 id="清华大学"><a href="#清华大学" class="headerlink" title="清华大学"></a>清华大学</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><h2 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">pip config set global.trusted-host mirrors.aliyun.com</span><br><span class="line">pip config set global.timeout 120</span><br><span class="line">pip config set install.trusted-host mirrors.aliyun.com</span><br></pre></td></tr></table></figure><h1 id="NPM"><a href="#NPM" class="headerlink" title="NPM"></a>NPM</h1><h2 id="淘宝"><a href="#淘宝" class="headerlink" title="淘宝"></a>淘宝</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">https://npm.taobao.org/mirrors/npm/</span><br><span class="line"># 设置nodejs工具的镜像地址</span><br><span class="line">http://npm.taobao.org/mirrors/node</span><br><span class="line"># 设置alinode镜像</span><br><span class="line">http://npm.taobao.org/mirrors/alinode</span><br><span class="line"># 设置浏览器引擎驱动镜像地址</span><br><span class="line">http://npm.taobao.org/mirrors/phantomjs</span><br><span class="line">http://npm.taobao.org/mirrors/chromedriver</span><br><span class="line">http://npm.taobao.org/mirrors/operadriver</span><br><span class="line">http://npm.taobao.org/mirrors/selenium</span><br><span class="line"># 设置Electron和node-inspector的镜像地址</span><br><span class="line">https://npm.taobao.org/mirrors/electron/</span><br><span class="line">https://npm.taobao.org/mirrors/node-inspector/</span><br></pre></td></tr></table></figure><h2 id="华为云-1"><a href="#华为云-1" class="headerlink" title="华为云"></a>华为云</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.huaweicloud.com/repository/npm/</span><br><span class="line"># 设置nodejs工具的镜像地址</span><br><span class="line">https://mirrors.huaweicloud.com/nodejs</span><br><span class="line"># 设置Node-Sass的镜像地址</span><br><span class="line">https://mirrors.huaweicloud.com/node-sass</span><br><span class="line"># 设置浏览器引擎驱动镜像地址</span><br><span class="line">https://mirrors.huaweicloud.com/phantomjs</span><br><span class="line">https://mirrors.huaweicloud.com/chromedriver</span><br><span class="line">https://mirrors.huaweicloud.com/operadriver</span><br><span class="line"># 设置Electron和Python的镜像地址</span><br><span class="line">https://mirrors.huaweicloud.com/electron/</span><br><span class="line">https://mirrors.huaweicloud.com/python</span><br></pre></td></tr></table></figure><h2 id="腾讯云-1"><a href="#腾讯云-1" class="headerlink" title="腾讯云"></a>腾讯云</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://mirrors.cloud.tencent.com/npm/</span><br></pre></td></tr></table></figure><h2 id="配置方法-1"><a href="#配置方法-1" class="headerlink" title="配置方法"></a>配置方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">npm config set registry https://mirrors.huaweicloud.com/repository/npm/</span><br><span class="line">npm config set disturl https://mirrors.huaweicloud.com/nodejs</span><br><span class="line">npm config set sass_binary_site https://mirrors.huaweicloud.com/node-sass</span><br><span class="line">npm config set phantomjs_cdnurl https://mirrors.huaweicloud.com/phantomjs</span><br><span class="line">npm config set chromedriver_cdnurl https://mirrors.huaweicloud.com/chromedriver</span><br><span class="line">npm config set operadriver_cdnurl https://mirrors.huaweicloud.com/operadriver</span><br><span class="line">npm config set electron_mirror https://mirrors.huaweicloud.com/electron/</span><br><span class="line">npm config set python_mirror https://mirrors.huaweicloud.com/python </span><br><span class="line">npm cache clean -f</span><br></pre></td></tr></table></figure><h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ol><li>Golang 1.11+</li><li>开启Go Module</li><li>Golang 1.13+里面的GOPROXY变成了数组，可以定义多个Proxy</li></ol><h2 id="阿里云-1"><a href="#阿里云-1" class="headerlink" title="阿里云"></a>阿里云</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.aliyun.com/goproxy/</span><br><span class="line">https://mirrors.cloud.aliyuncs.com/goproxy/</span><br></pre></td></tr></table></figure><h2 id="华为云-2"><a href="#华为云-2" class="headerlink" title="华为云"></a>华为云</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.huaweicloud.com/goproxy</span><br></pre></td></tr></table></figure><h2 id="腾讯云-2"><a href="#腾讯云-2" class="headerlink" title="腾讯云"></a>腾讯云</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.cloud.tencent.com/go/</span><br></pre></td></tr></table></figure><h2 id="七牛云"><a href="#七牛云" class="headerlink" title="七牛云"></a>七牛云</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://goproxy.cn</span><br></pre></td></tr></table></figure><h2 id="针对Golang-1-11"><a href="#针对Golang-1-11" class="headerlink" title="针对Golang 1.11"></a>针对Golang 1.11</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go env -w GO111MODULE=on</span><br><span class="line">go env -w GOPROXY='https://mirrors.aliyun.com/goproxy/'</span><br></pre></td></tr></table></figure><h2 id="针对Golang-1-13"><a href="#针对Golang-1-13" class="headerlink" title="针对Golang 1.13+"></a>针对Golang 1.13+</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go env -w GO111MODULE=on</span><br><span class="line">go env -w GOPROXY='https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,direct'</span><br></pre></td></tr></table></figure><h1 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h1><h2 id="阿里云-2"><a href="#阿里云-2" class="headerlink" title="阿里云"></a>阿里云</h2><p>阿里云代理了Maven的公共仓库，这里是<a href="https://help.aliyun.com/document_detail/102512.html?spm=a2c40.aliyun_maven_repo.0.0.db313054wI5b5B" target="_blank" rel="noopener">说明文档</a></p><h2 id="腾讯云-3"><a href="#腾讯云-3" class="headerlink" title="腾讯云"></a>腾讯云</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://mirrors.cloud.tencent.com/nexus/repository/maven-public/</span><br></pre></td></tr></table></figure><h2 id="华为云-3"><a href="#华为云-3" class="headerlink" title="华为云"></a>华为云</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.huaweicloud.com/repository/maven/</span><br></pre></td></tr></table></figure><h2 id="Maven配置"><a href="#Maven配置" class="headerlink" title="Maven配置"></a>Maven配置</h2><p>打开 Maven 的配置文件(windows机器一般在maven安装目录的conf/settings.xml)，在<code>&lt;mirrors&gt;&lt;/mirrors&gt;</code>标签中添加 mirror 子节点:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>aliyunmaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>huaweicloud<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mirrors.huaweicloud.com/repository/maven/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-tencentyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirrors.cloud.tencent.com/nexus/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果想使用其它代理仓库,可在<code>&lt;repository&gt;&lt;/repository&gt;</code>节点中加入对应的仓库使用地址。以使用spring代理仓为例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/spring<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Gradle配置"><a href="#Gradle配置" class="headerlink" title="Gradle配置"></a>Gradle配置</h2><p>在 build.gradle 文件中加入以下代码:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url 'https://maven.aliyun.com/repository/public/' &#125;</span><br><span class="line">        mavenLocal()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果想使用 maven.aliyun.com 提供的其它代理仓，以使用 spring 仓为例，代码如下:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url 'https://maven.aliyun.com/repository/public/' &#125;</span><br><span class="line">        maven &#123; url 'https://maven.aliyun.com/repository/spring/'&#125;</span><br><span class="line">        mavenLocal()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;开发语言内置的包管理工具一般都是使用国外服务器作为源，国内访问非常慢&lt;/li&gt;&lt;li&gt;国内各大云厂商基本都做了对应的镜像源，果断用
      
    
    </summary>
    
      <category term="Development" scheme="https://luanlengli.github.io/categories/Development/"/>
    
    
      <category term="Development" scheme="https://luanlengli.github.io/tags/Development/"/>
    
  </entry>
  
  <entry>
    <title>阿里云GPU计算型ECS实例安装NVIDIA驱动和CUDA</title>
    <link href="https://luanlengli.github.io/2019/12/31/%E9%98%BF%E9%87%8C%E4%BA%91GPU%E8%AE%A1%E7%AE%97%E5%9E%8BECS%E5%AE%9E%E4%BE%8B%E5%AE%89%E8%A3%85NVIDIA%E9%A9%B1%E5%8A%A8%E5%92%8CCUDA.html"/>
    <id>https://luanlengli.github.io/2019/12/31/阿里云GPU计算型ECS实例安装NVIDIA驱动和CUDA.html</id>
    <published>2019-12-31T15:40:43.000Z</published>
    <updated>2020-01-03T12:45:47.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>理论上适用于其他云平台的<code>GPU计算型实例</code>或者<code>自建GPU计算服务器</code></li><li>阿里云实例类型<code>GPU计算型 gn5</code></li><li>GPU型号<code>Nvidia Tesla P100</code></li><li>操作系统<code>CentOS-7.7-1908 64位</code></li><li>Nvidia驱动版本<code>390.116</code></li><li>CUDA Driver版本<code>9.1.85</code></li><li>CUDA Runtime版本<code>9.0.176</code></li><li>cuDNN版本<code>v7.6.0.64</code></li><li>Nvidia GPU 兼容性的可以看<a href="http://wsfdl.com/kubernetes/2019/05/08/versions_in_gpu.html" target="_blank" rel="noopener">这篇文章</a></li><li>Docker版本<code>19.03.5</code></li><li><font color="red">GPU驱动、CUDA、cuDNN版本的选择，请自行根据项目要求进行调整！</font></li></ul><h1 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="禁用SELINUX"><a href="#禁用SELINUX" class="headerlink" title="禁用SELINUX"></a>禁用SELINUX</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's,^SELINUX=.*,SELINUX=disabled,g' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><h3 id="禁用防火墙"><a href="#禁用防火墙" class="headerlink" title="禁用防火墙"></a>禁用防火墙</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld.service</span><br></pre></td></tr></table></figure><h3 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h3><h4 id="fs参数"><a href="#fs参数" class="headerlink" title="fs参数"></a>fs参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-fs.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同一时间异步IO请求数</span></span><br><span class="line">fs.aio-max-nr=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在CentOS7.4引入了一个新的参数来控制内核的行为。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /proc/sys/fs/may_detach_mounts 默认设置为0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统有容器运行的时候，需要将该值设置为1。</span></span><br><span class="line">fs.may_detach_mounts=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="vm参数"><a href="#vm参数" class="headerlink" title="vm参数"></a>vm参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-vm.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当内存耗尽时，内核会触发OOM killer根据oom_score杀掉最耗内存的进程</span></span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许overcommit</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义了进程能拥有的最多内存区域，默认65536</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="net参数"><a href="#net参数" class="headerlink" title="net参数"></a>net参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-net.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径，默认值1</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进程间通信发送数据, 默认100</span></span><br><span class="line">net.unix.max_dgram_qlen=512</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 conntrack 的上限</span></span><br><span class="line">net.netfilter.nf_conntrack_max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置连接跟踪表中处于TIME_WAIT状态的超时时间</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_timewait=30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置连接跟踪表中TCP连接超时时间</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established=1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=21644</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收自网卡、但未被内核协议栈处理的报文队列长度</span></span><br><span class="line">net.core.netdev_max_backlog=262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统无内存压力、启动压力模式阈值、最大值，单位为页的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_mem=1541646 2055528 3083292</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核socket接收缓存区字节数min/default/max</span></span><br><span class="line">net.core.rmem=4096 65536 8388608</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核socket发送缓存区字节数min/default/max</span></span><br><span class="line">net.core.wmem=4096 65536 8388608</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启自动调节缓存模式</span></span><br><span class="line">net.ipv4.tcp_moderate_rcvbuf=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP阻塞控制算法BBR，Linux内核版本4.9开始内置BBR算法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用作本地随机TCP端口的范围</span></span><br><span class="line">net.ipv4.ip_local_port_range=10000 65000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog=16384</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets=5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定重发 SYN/ACK 的次数</span></span><br><span class="line">net.ipv4.tcp_synack_retries=2</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接中TIME_WAIT sockets的快速回收</span></span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不属于任何进程的tcp socket最大数量. 超过这个数量的socket会被reset, 并告警</span></span><br><span class="line">net.ipv4.tcp_max_orphans=1024</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FIN报文重试次数</span></span><br><span class="line">net.ipv4.tcp_orphan_retries=8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout=15</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接keepalive的持续时间，默认7200</span></span><br><span class="line">net.ipv4.tcp_keepalive_time=600</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP keepalive探测包发送间隔</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl=30</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP keepalive探测包重试次数</span></span><br><span class="line">net.ipv4.tcp_keepalive_probes=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FastOpen</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0:关闭 ; 1:作为客户端时使用 ; 2:作为服务器端时使用 ; 3:无论作为客户端还是服务器端都使用</span></span><br><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制TCP重传次数</span></span><br><span class="line">net.ipv4.tcp_retries1=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP重传次数到达上限时，关闭TCP连接</span></span><br><span class="line">net.ipv4.tcp_retries2=15</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-centos.conf &lt;&lt;EOF</span><br><span class="line">* - nproc 1048576</span><br><span class="line">* - nofile 1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="修改journal设置"><a href="#修改journal设置" class="headerlink" title="修改journal设置"></a>修改journal设置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#Compress=yes,Compress=yes,' \</span><br><span class="line">    -e 's,^#SystemMaxUse=,SystemMaxUse=2G,' \</span><br><span class="line">    -e 's,^#Seal=yes,Seal=yes,' \</span><br><span class="line">    -e 's,^#RateLimitBurst=1000,RateLimitBurst=5000,' \</span><br><span class="line">    -i /etc/systemd/journald.conf</span><br></pre></td></tr></table></figure><h3 id="修改history参数"><a href="#修改history参数" class="headerlink" title="修改history参数"></a>修改history参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/profile.d/history.sh &lt;&lt;EOF</span><br><span class="line">export HISTSIZE=10000</span><br><span class="line">export HISTFILESIZE=10000</span><br><span class="line">export HISTCONTROL=ignoredups</span><br><span class="line">export HISTTIMEFORMAT="`whoami` %F %T "</span><br><span class="line">export HISTIGNORE="ls:pwd:ll:ls -l:ls -a:ll -a"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="更新软件"><a href="#更新软件" class="headerlink" title="更新软件"></a>更新软件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h3 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum groups install base 'Development Tools'</span><br></pre></td></tr></table></figure><h3 id="安装常用工具"><a href="#安装常用工具" class="headerlink" title="安装常用工具"></a>安装常用工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nc \</span><br><span class="line">               git \</span><br><span class="line">               vim \</span><br><span class="line">               ipvsadm \</span><br><span class="line">               tree \</span><br><span class="line">               dstat \</span><br><span class="line">               iotop \</span><br><span class="line">               htop \</span><br><span class="line">               socat \</span><br><span class="line">               ipset\</span><br><span class="line">               conntrack \</span><br><span class="line">               bash-completion-extras \</span><br><span class="line">               tcpdump \</span><br><span class="line">               wireshark \</span><br><span class="line">               bcc-tools \</span><br><span class="line">               perf \</span><br><span class="line">               trace-cmd \</span><br><span class="line">               systemtap \</span><br><span class="line">               nethogs \</span><br><span class="line">               lshw</span><br></pre></td></tr></table></figure><h3 id="检查GPU"><a href="#检查GPU" class="headerlink" title="检查GPU"></a>检查GPU</h3><h4 id="查看PCI设备"><a href="#查看PCI设备" class="headerlink" title="查看PCI设备"></a>查看PCI设备</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lspci | grep -i nvidia</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00:08.0 3D controller: NVIDIA Corporation GP100GL [Tesla P100 PCIe 16GB] (rev a1)</span><br></pre></td></tr></table></figure><h4 id="查看硬件信息"><a href="#查看硬件信息" class="headerlink" title="查看硬件信息"></a>查看硬件信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lshw -numeric -C display</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">*-display:0               </span><br><span class="line">     description: VGA compatible controller</span><br><span class="line">     product: GD 5446 [1013:B8]</span><br><span class="line">     vendor: Cirrus Logic [1013]</span><br><span class="line">     physical id: 2</span><br><span class="line">     bus info: pci@0000:00:02.0</span><br><span class="line">     version: 00</span><br><span class="line">     width: 32 bits</span><br><span class="line">     clock: 33MHz</span><br><span class="line">     capabilities: vga_controller rom</span><br><span class="line">     configuration: driver=cirrus latency=0</span><br><span class="line">     resources: irq:0 memory:fa000000-fbffffff memory:fe850000-fe850fff memory:fe840000-fe84ffff</span><br><span class="line">*-display:1</span><br><span class="line">     description: 3D controller</span><br><span class="line">     product: GP100GL [Tesla P100 PCIe 16GB] [10DE:15F8]</span><br><span class="line">     vendor: NVIDIA Corporation [10DE]</span><br><span class="line">     physical id: 8</span><br><span class="line">     bus info: pci@0000:00:08.0</span><br><span class="line">     logical name: /dev/fb0</span><br><span class="line">     version: a1</span><br><span class="line">     width: 64 bits</span><br><span class="line">     clock: 33MHz</span><br><span class="line">     capabilities: pm msi pciexpress bus_master cap_list fb</span><br><span class="line">     configuration: depth=16 driver=nvidia latency=0 mode=1024x768 visual=truecolor xres=1024 yres=768</span><br><span class="line">     resources: iomemory:100-ff iomemory:140-13f irq:11 memory:fd000000-fdffffff memory:1000000000-13ffffffff memory:1400000000-1401ffffff</span><br></pre></td></tr></table></figure><h4 id="禁用nouveau驱动"><a href="#禁用nouveau驱动" class="headerlink" title="禁用nouveau驱动"></a>禁用nouveau驱动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo "blacklist nouveau" &gt; /etc/modprobe.d/blacklist-nouveau.conf</span><br><span class="line">echo "options nouveau modeset=0" &gt;&gt; /etc/modprobe.d/blacklist-nouveau.conf</span><br><span class="line">rmmod nouveau</span><br><span class="line">dracut --force</span><br></pre></td></tr></table></figure><h4 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><h2 id="安装GPU驱动"><a href="#安装GPU驱动" class="headerlink" title="安装GPU驱动"></a>安装GPU驱动</h2><h3 id="访问Nvidia官网"><a href="#访问Nvidia官网" class="headerlink" title="访问Nvidia官网"></a>访问Nvidia官网</h3><p><a href="https://www.nvidia.cn/Download/index.aspx?lang=cn" target="_blank" rel="noopener">Nvidia驱动程序下载</a></p><h3 id="下载驱动"><a href="#下载驱动" class="headerlink" title="下载驱动"></a>下载驱动</h3><h4 id="网页下载"><a href="#网页下载" class="headerlink" title="网页下载"></a>网页下载</h4><ol><li>产品类型<code>Tesla</code></li><li>产品类型<code>P-Series</code></li><li>产品家族<code>Tesla P100</code></li><li>操作系统<code>Linux 64-bit RHEL7</code></li><li>CUDA Toolkit<code>9.1</code></li><li>点击<code>搜索</code>，跳转到<code>驱动程序下载</code>页面</li><li>点击<code>下载</code>，跳转到<code>驱动下载</code></li><li>再次点击<code>下载</code>，保存驱动文件</li></ol><h4 id="命令行下载"><a href="#命令行下载" class="headerlink" title="命令行下载"></a>命令行下载</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -t 10 --timeout=10 http://cn.download.nvidia.com/tesla/390.116/nvidia-diag-driver-local-repo-rhel7-390.116-1.0-1.x86_64.rpm</span><br></pre></td></tr></table></figure><h4 id="安装驱动"><a href="#安装驱动" class="headerlink" title="安装驱动"></a>安装驱动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install nvidia-diag-driver-local-repo-rhel7-390.116-1.0-1.x86_64.rpm</span><br><span class="line">yum clean all</span><br><span class="line">yum install cuda-drivers-390.116-1.x86_64</span><br></pre></td></tr></table></figure><h4 id="重启-1"><a href="#重启-1" class="headerlink" title="重启"></a>重启</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><h3 id="检查驱动情况"><a href="#检查驱动情况" class="headerlink" title="检查驱动情况"></a>检查驱动情况</h3><h4 id="检查是否加载开源驱动nouveau"><a href="#检查是否加载开源驱动nouveau" class="headerlink" title="检查是否加载开源驱动nouveau"></a>检查是否加载开源驱动nouveau</h4><blockquote><p>这里不应该有结果输出！</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep nouveau</span><br></pre></td></tr></table></figure><h4 id="检查驱动版本"><a href="#检查驱动版本" class="headerlink" title="检查驱动版本"></a>检查驱动版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/driver/nvidia/version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NVRM version: NVIDIA UNIX x86_64 Kernel Module  390.116  Sun Jan 27 07:21:36 PST 2019</span><br><span class="line">GCC version:  gcc version 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC)</span><br></pre></td></tr></table></figure><h4 id="查看GPU-Summary"><a href="#查看GPU-Summary" class="headerlink" title="查看GPU Summary"></a>查看GPU Summary</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 390.116                Driver Version: 390.116                   |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla P100-PCIE...  Off  | 00000000:00:08.0 Off |                    0 |</span><br><span class="line">| N/A   32C    P0    27W / 250W |      0MiB / 16280MiB |      3%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">                                                                               </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                       GPU Memory |</span><br><span class="line">|  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|  No running processes found                                                 |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h4 id="查看GPU详细信息"><a href="#查看GPU详细信息" class="headerlink" title="查看GPU详细信息"></a>查看GPU详细信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi -i 0 -q</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">==============NVSMI LOG==============</span><br><span class="line"></span><br><span class="line">Driver Version                      : 390.116</span><br><span class="line">CUDA Version                        : 9.1</span><br><span class="line"></span><br><span class="line">Attached GPUs                       : 1</span><br><span class="line">GPU 00000000:00:08.0</span><br><span class="line">    Product Name                    : Tesla P100-PCIE-16GB</span><br><span class="line">    Product Brand                   : Tesla</span><br><span class="line">    Display Mode                    : Enabled</span><br><span class="line">    Display Active                  : Disabled</span><br><span class="line">    Persistence Mode                : Enabled</span><br><span class="line">    Accounting Mode                 : Disabled</span><br><span class="line">    Accounting Mode Buffer Size     : 4000</span><br><span class="line">    Driver Model</span><br><span class="line">        Current                     : N/A</span><br><span class="line">        Pending                     : N/A</span><br><span class="line">    Serial Number                   : 0322818005606</span><br><span class="line">    GPU UUID                        : GPU-81662b67-e58c-d9b6-763f-8adc65071cba</span><br><span class="line">    Minor Number                    : 0</span><br><span class="line">    VBIOS Version                   : 86.00.4D.00.01</span><br><span class="line">    MultiGPU Board                  : No</span><br><span class="line">    Board ID                        : 0x8</span><br><span class="line">    GPU Part Number                 : 900-2H400-0000-000</span><br><span class="line">    Inforom Version</span><br><span class="line">        Image Version               : H400.0201.00.08</span><br><span class="line">        OEM Object                  : 1.1</span><br><span class="line">        ECC Object                  : 4.1</span><br><span class="line">        Power Management Object     : N/A</span><br><span class="line">    GPU Operation Mode</span><br><span class="line">        Current                     : N/A</span><br><span class="line">        Pending                     : N/A</span><br><span class="line">    GPU Virtualization Mode</span><br><span class="line">        Virtualization mode         : Pass-Through</span><br><span class="line">    IBMNPU</span><br><span class="line">        Relaxed Ordering Mode       : N/A</span><br><span class="line">    PCI</span><br><span class="line">        Bus                         : 0x00</span><br><span class="line">        Device                      : 0x08</span><br><span class="line">        Domain                      : 0x0000</span><br><span class="line">        Device Id                   : 0x15F810DE</span><br><span class="line">        Bus Id                      : 00000000:00:08.0</span><br><span class="line">        Sub System Id               : 0x118F10DE</span><br><span class="line">        GPU Link Info</span><br><span class="line">            PCIe Generation</span><br><span class="line">                Max                 : 3</span><br><span class="line">                Current             : 3</span><br><span class="line">            Link Width</span><br><span class="line">                Max                 : 16x</span><br><span class="line">                Current             : 16x</span><br><span class="line">        Bridge Chip</span><br><span class="line">            Type                    : N/A</span><br><span class="line">            Firmware                : N/A</span><br><span class="line">        Replays since reset         : 0</span><br><span class="line">        Tx Throughput               : 0 KB/s</span><br><span class="line">        Rx Throughput               : 0 KB/s</span><br><span class="line">    Fan Speed                       : N/A</span><br><span class="line">    Performance State               : P0</span><br><span class="line">    Clocks Throttle Reasons</span><br><span class="line">        Idle                        : Not Active</span><br><span class="line">        Applications Clocks Setting : Not Active</span><br><span class="line">        SW Power Cap                : Not Active</span><br><span class="line">        HW Slowdown                 : Not Active</span><br><span class="line">            HW Thermal Slowdown     : Not Active</span><br><span class="line">            HW Power Brake Slowdown : Not Active</span><br><span class="line">        Sync Boost                  : Not Active</span><br><span class="line">        SW Thermal Slowdown         : Not Active</span><br><span class="line">        Display Clock Setting       : Not Active</span><br><span class="line">    FB Memory Usage</span><br><span class="line">        Total                       : 16280 MiB</span><br><span class="line">        Used                        : 8133 MiB</span><br><span class="line">        Free                        : 8147 MiB</span><br><span class="line">    BAR1 Memory Usage</span><br><span class="line">        Total                       : 16384 MiB</span><br><span class="line">        Used                        : 2 MiB</span><br><span class="line">        Free                        : 16382 MiB</span><br><span class="line">    Compute Mode                    : Default</span><br><span class="line">    Utilization</span><br><span class="line">        Gpu                         : 0 %</span><br><span class="line">        Memory                      : 0 %</span><br><span class="line">        Encoder                     : 0 %</span><br><span class="line">        Decoder                     : 0 %</span><br><span class="line">    Encoder Stats</span><br><span class="line">        Active Sessions             : 0</span><br><span class="line">        Average FPS                 : 0</span><br><span class="line">        Average Latency             : 0</span><br><span class="line">    FBC Stats</span><br><span class="line">        Active Sessions             : 0</span><br><span class="line">        Average FPS                 : 0</span><br><span class="line">        Average Latency             : 0</span><br><span class="line">    Ecc Mode</span><br><span class="line">        Current                     : Enabled</span><br><span class="line">        Pending                     : Enabled</span><br><span class="line">    ECC Errors</span><br><span class="line">        Volatile</span><br><span class="line">            Single Bit            </span><br><span class="line">                Device Memory       : 0</span><br><span class="line">                Register File       : 0</span><br><span class="line">                L1 Cache            : N/A</span><br><span class="line">                L2 Cache            : 0</span><br><span class="line">                Texture Memory      : 0</span><br><span class="line">                Texture Shared      : 0</span><br><span class="line">                CBU                 : N/A</span><br><span class="line">                Total               : 0</span><br><span class="line">            Double Bit            </span><br><span class="line">                Device Memory       : 0</span><br><span class="line">                Register File       : 0</span><br><span class="line">                L1 Cache            : N/A</span><br><span class="line">                L2 Cache            : 0</span><br><span class="line">                Texture Memory      : 0</span><br><span class="line">                Texture Shared      : 0</span><br><span class="line">                CBU                 : N/A</span><br><span class="line">                Total               : 0</span><br><span class="line">        Aggregate</span><br><span class="line">            Single Bit            </span><br><span class="line">                Device Memory       : 0</span><br><span class="line">                Register File       : 0</span><br><span class="line">                L1 Cache            : N/A</span><br><span class="line">                L2 Cache            : 0</span><br><span class="line">                Texture Memory      : 0</span><br><span class="line">                Texture Shared      : 0</span><br><span class="line">                CBU                 : N/A</span><br><span class="line">                Total               : 0</span><br><span class="line">            Double Bit            </span><br><span class="line">                Device Memory       : 0</span><br><span class="line">                Register File       : 0</span><br><span class="line">                L1 Cache            : N/A</span><br><span class="line">                L2 Cache            : 0</span><br><span class="line">                Texture Memory      : 0</span><br><span class="line">                Texture Shared      : 0</span><br><span class="line">                CBU                 : N/A</span><br><span class="line">                Total               : 0</span><br><span class="line">    Retired Pages</span><br><span class="line">        Single Bit ECC              : 0</span><br><span class="line">        Double Bit ECC              : 0</span><br><span class="line">        Pending Page Blacklist      : No</span><br><span class="line">    Temperature</span><br><span class="line">        GPU Current Temp            : 34 C</span><br><span class="line">        GPU Shutdown Temp           : 85 C</span><br><span class="line">        GPU Slowdown Temp           : 82 C</span><br><span class="line">        GPU Max Operating Temp      : N/A</span><br><span class="line">        Memory Current Temp         : N/A</span><br><span class="line">        Memory Max Operating Temp   : N/A</span><br><span class="line">    Power Readings</span><br><span class="line">        Power Management            : Supported</span><br><span class="line">        Power Draw                  : 31.01 W</span><br><span class="line">        Power Limit                 : 250.00 W</span><br><span class="line">        Default Power Limit         : 250.00 W</span><br><span class="line">        Enforced Power Limit        : 250.00 W</span><br><span class="line">        Min Power Limit             : 125.00 W</span><br><span class="line">        Max Power Limit             : 250.00 W</span><br><span class="line">    Clocks</span><br><span class="line">        Graphics                    : 1189 MHz</span><br><span class="line">        SM                          : 1189 MHz</span><br><span class="line">        Memory                      : 715 MHz</span><br><span class="line">        Video                       : 1063 MHz</span><br><span class="line">    Applications Clocks</span><br><span class="line">        Graphics                    : 1189 MHz</span><br><span class="line">        Memory                      : 715 MHz</span><br><span class="line">    Default Applications Clocks</span><br><span class="line">        Graphics                    : 1189 MHz</span><br><span class="line">        Memory                      : 715 MHz</span><br><span class="line">    Max Clocks</span><br><span class="line">        Graphics                    : 1328 MHz</span><br><span class="line">        SM                          : 1328 MHz</span><br><span class="line">        Memory                      : 715 MHz</span><br><span class="line">        Video                       : 1328 MHz</span><br><span class="line">    Max Customer Boost Clocks</span><br><span class="line">        Graphics                    : 1328 MHz</span><br><span class="line">    Clock Policy</span><br><span class="line">        Auto Boost                  : N/A</span><br><span class="line">        Auto Boost Default          : N/A</span><br><span class="line">    Processes</span><br></pre></td></tr></table></figure><h4 id="禁用本地YUM源"><a href="#禁用本地YUM源" class="headerlink" title="禁用本地YUM源"></a>禁用本地YUM源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --disable nvidia-diag-driver-local-390.116</span><br></pre></td></tr></table></figure><h2 id="安装CUDA环境"><a href="#安装CUDA环境" class="headerlink" title="安装CUDA环境"></a>安装CUDA环境</h2><h3 id="添加CUDA源"><a href="#添加CUDA源" class="headerlink" title="添加CUDA源"></a>添加CUDA源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-rhel7.repo</span><br></pre></td></tr></table></figure><h3 id="修改CUDA源地址"><a href="#修改CUDA源地址" class="headerlink" title="修改CUDA源地址"></a>修改CUDA源地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,developer.download.nvidia.cn/compute/cuda/repos/,mirrors.aliyun.com/nvidia-cuda,g' \</span><br><span class="line">    -e 's,developer.download.nvidia.com/compute/cuda/repos,mirrors.aliyun.com/nvidia-cuda,g' \</span><br><span class="line">    -i /etc/yum.repos.d/cuda-rhel7.repo</span><br></pre></td></tr></table></figure><h3 id="安装CUDA"><a href="#安装CUDA" class="headerlink" title="安装CUDA"></a>安装CUDA</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br><span class="line">yum install cuda-9-0</span><br></pre></td></tr></table></figure><h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 'export PATH=/usr/local/cuda-9.0/bin:$PATH' &gt;&gt; /etc/profile.d/cuda-9.0.sh</span><br><span class="line">echo 'export LD_LIBRARY_PATH=/usr/local/cuda-9.0/lib64:$LD_LIBRARY_PATH' &gt;&gt; /etc/profile.d/cuda-9.0.sh</span><br><span class="line">source /etc/profile.d/cuda-9.0.sh</span><br></pre></td></tr></table></figure><h3 id="测试CUDA"><a href="#测试CUDA" class="headerlink" title="测试CUDA"></a>测试CUDA</h3><h4 id="查看安装路径"><a href="#查看安装路径" class="headerlink" title="查看安装路径"></a>查看安装路径</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -ld /usr/local/cuda*</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lrwxrwxrwx  1 root root    8 Jan  1 11:08 /usr/local/cuda -&gt; cuda-9.0</span><br><span class="line">drwxr-xr-x 15 root root 4096 Jan  1 11:08 /usr/local/cuda-9.0</span><br></pre></td></tr></table></figure><h4 id="检查CUDA版本"><a href="#检查CUDA版本" class="headerlink" title="检查CUDA版本"></a>检查CUDA版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc --version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nvcc: NVIDIA (R) Cuda compiler driver</span><br><span class="line">Copyright (c) 2005-2017 NVIDIA Corporation</span><br><span class="line">Built on Fri_Sep__1_21:08:03_CDT_2017</span><br><span class="line">Cuda compilation tools, release 9.0, V9.0.176</span><br></pre></td></tr></table></figure><h4 id="运行Samples"><a href="#运行Samples" class="headerlink" title="运行Samples"></a>运行Samples</h4><p>以下两个测试结果都为<code>Result=PASS</code>，则说明CUDA安装成功</p><h5 id="deviceQuery"><a href="#deviceQuery" class="headerlink" title="deviceQuery"></a>deviceQuery</h5><h6 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/cuda-9.0/samples/1_Utilities/deviceQuery</span><br></pre></td></tr></table></figure><h6 id="编译运行"><a href="#编译运行" class="headerlink" title="编译运行"></a>编译运行</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; ./deviceQuery</span><br></pre></td></tr></table></figure><h6 id="输出示例"><a href="#输出示例" class="headerlink" title="输出示例"></a>输出示例</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">./deviceQuery Starting...</span><br><span class="line"></span><br><span class="line"> CUDA Device Query (Runtime API) version (CUDART static linking)</span><br><span class="line"></span><br><span class="line">Detected 1 CUDA Capable device(s)</span><br><span class="line"></span><br><span class="line">Device 0: "Tesla P100-PCIE-16GB"</span><br><span class="line">  CUDA Driver Version / Runtime Version          9.1 / 9.0</span><br><span class="line">  CUDA Capability Major/Minor version number:    6.0</span><br><span class="line">  Total amount of global memory:                 16281 MBytes (17071734784 bytes)</span><br><span class="line">  (56) Multiprocessors, ( 64) CUDA Cores/MP:     3584 CUDA Cores</span><br><span class="line">  GPU Max Clock rate:                            1329 MHz (1.33 GHz)</span><br><span class="line">  Memory Clock rate:                             715 Mhz</span><br><span class="line">  Memory Bus Width:                              4096-bit</span><br><span class="line">  L2 Cache Size:                                 4194304 bytes</span><br><span class="line">  Maximum Texture Dimension Size (x,y,z)         1D=(131072), 2D=(131072, 65536), 3D=(16384, 16384, 16384)</span><br><span class="line">  Maximum Layered 1D Texture Size, (num) layers  1D=(32768), 2048 layers</span><br><span class="line">  Maximum Layered 2D Texture Size, (num) layers  2D=(32768, 32768), 2048 layers</span><br><span class="line">  Total amount of constant memory:               65536 bytes</span><br><span class="line">  Total amount of shared memory per block:       49152 bytes</span><br><span class="line">  Total number of registers available per block: 65536</span><br><span class="line">  Warp size:                                     32</span><br><span class="line">  Maximum number of threads per multiprocessor:  2048</span><br><span class="line">  Maximum number of threads per block:           1024</span><br><span class="line">  Max dimension size of a thread block (x,y,z): (1024, 1024, 64)</span><br><span class="line">  Max dimension size of a grid size    (x,y,z): (2147483647, 65535, 65535)</span><br><span class="line">  Maximum memory pitch:                          2147483647 bytes</span><br><span class="line">  Texture alignment:                             512 bytes</span><br><span class="line">  Concurrent copy and kernel execution:          Yes with 2 copy engine(s)</span><br><span class="line">  Run time limit on kernels:                     No</span><br><span class="line">  Integrated GPU sharing Host Memory:            No</span><br><span class="line">  Support host page-locked memory mapping:       Yes</span><br><span class="line">  Alignment requirement for Surfaces:            Yes</span><br><span class="line">  Device has ECC support:                        Enabled</span><br><span class="line">  Device supports Unified Addressing (UVA):      Yes</span><br><span class="line">  Supports Cooperative Kernel Launch:            Yes</span><br><span class="line">  Supports MultiDevice Co-op Kernel Launch:      Yes</span><br><span class="line">  Device PCI Domain ID / Bus ID / location ID:   0 / 0 / 8</span><br><span class="line">  Compute Mode:</span><br><span class="line">     &lt; Default (multiple host threads can use ::cudaSetDevice() with device simultaneously) &gt;</span><br><span class="line"></span><br><span class="line">deviceQuery, CUDA Driver = CUDART, CUDA Driver Version = 9.1, CUDA Runtime Version = 9.0, NumDevs = 1</span><br><span class="line">Result = PASS</span><br></pre></td></tr></table></figure><h5 id="bandwidthTest"><a href="#bandwidthTest" class="headerlink" title="bandwidthTest"></a>bandwidthTest</h5><h6 id="切换目录-1"><a href="#切换目录-1" class="headerlink" title="切换目录"></a>切换目录</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/cuda-9.0/samples/1_Utilities/bandwidthTest</span><br></pre></td></tr></table></figure><h6 id="编译运行-1"><a href="#编译运行-1" class="headerlink" title="编译运行"></a>编译运行</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; ./bandwidthTest</span><br></pre></td></tr></table></figure><h6 id="输出示例-1"><a href="#输出示例-1" class="headerlink" title="输出示例"></a>输出示例</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[CUDA Bandwidth Test] - Starting...</span><br><span class="line">Running on...</span><br><span class="line"></span><br><span class="line"> Device 0: Tesla P100-PCIE-16GB</span><br><span class="line"> Quick Mode</span><br><span class="line"></span><br><span class="line"> Host to Device Bandwidth, 1 Device(s)</span><br><span class="line"> PINNED Memory Transfers</span><br><span class="line">   Transfer Size (Bytes)Bandwidth(MB/s)</span><br><span class="line">   3355443210731.5</span><br><span class="line"></span><br><span class="line"> Device to Host Bandwidth, 1 Device(s)</span><br><span class="line"> PINNED Memory Transfers</span><br><span class="line">   Transfer Size (Bytes)Bandwidth(MB/s)</span><br><span class="line">   3355443212833.8</span><br><span class="line"></span><br><span class="line"> Device to Device Bandwidth, 1 Device(s)</span><br><span class="line"> PINNED Memory Transfers</span><br><span class="line">   Transfer Size (Bytes)Bandwidth(MB/s)</span><br><span class="line">   33554432499641.4</span><br><span class="line"></span><br><span class="line">Result = PASS</span><br><span class="line"></span><br><span class="line">NOTE: The CUDA Samples are not meant for performance measurements. Results may vary when GPU Boost is enabled.</span><br></pre></td></tr></table></figure><h3 id="禁用CUDA源"><a href="#禁用CUDA源" class="headerlink" title="禁用CUDA源"></a>禁用CUDA源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --disable cuda</span><br></pre></td></tr></table></figure><h2 id="安装cuDNN"><a href="#安装cuDNN" class="headerlink" title="安装cuDNN"></a>安装cuDNN</h2><h3 id="确定cuDNN下载地址"><a href="#确定cuDNN下载地址" class="headerlink" title="确定cuDNN下载地址"></a>确定cuDNN下载地址</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>访问<a href="https://developer.nvidia.com/rdp/cudnn-archive" target="_blank" rel="noopener">cuDNN Archive</a>，登录之后下载</p><h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>访问Nvidia托管在Gitlab的<a href="https://gitlab.com/nvidia/container-images/cuda" target="_blank" rel="noopener">容器项目地址</a>，根据自己操作系统的版本，找到对应的Dockerfile，提取cuDNN的下载地址</p><ul><li><a href="https://gitlab.com/nvidia/container-images/cuda/tree/centos6" target="_blank" rel="noopener">CentOS-6</a></li><li><a href="https://gitlab.com/nvidia/container-images/cuda/tree/centos7" target="_blank" rel="noopener">CentOS-7</a></li><li><a href="https://gitlab.com/nvidia/container-images/cuda/tree/ubuntu16.04" target="_blank" rel="noopener">Ubuntu-16.04</a></li><li><a href="https://gitlab.com/nvidia/container-images/cuda/tree/ubuntu18.04" target="_blank" rel="noopener">Ubuntu-18.04</a></li></ul><h3 id="下载cuDNN"><a href="#下载cuDNN" class="headerlink" title="下载cuDNN"></a>下载cuDNN</h3><blockquote><p>这里直接用CUDA-9.0能用到的、最新的<code>cuDNN 7.6.0.64</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://developer.download.nvidia.cn/compute/redist/cudnn/v7.6.0/cudnn-9.0-linux-x64-v7.6.0.64.tgz | tar xz</span><br></pre></td></tr></table></figure><h3 id="安装cuDNN-1"><a href="#安装cuDNN-1" class="headerlink" title="安装cuDNN"></a>安装cuDNN</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cp cuda/include/cudnn.h /usr/local/cuda-9.0/include</span><br><span class="line">cp cuda/lib64/libcudnn.so.7.6.0 cuda/lib64/libcudnn_static.a /usr/local/cuda-9.0/lib64</span><br><span class="line">cd /usr/local/cuda-9.0/lib64</span><br><span class="line">ln -sv libcudnn.so.7.6.0 libcudnn.so</span><br><span class="line">ln -sv libcudnn.so.7.6.0 libcudnn.so.7</span><br><span class="line">ldconfig -v</span><br></pre></td></tr></table></figure><h3 id="验证cuDNN"><a href="#验证cuDNN" class="headerlink" title="验证cuDNN"></a>验证cuDNN</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/wilhelmguo/cudnn_samples_v7.git</span><br><span class="line">cd cudnn_samples_v7/mnistCUDNN</span><br><span class="line">make &amp;&amp; ./mnistCUDNN</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">cudnnGetVersion() : 7600 , CUDNN_VERSION from cudnn.h : 7600 (7.6.0)</span><br><span class="line">Host compiler version : GCC 4.8.5</span><br><span class="line">There are 1 CUDA capable devices on your machine :</span><br><span class="line">device 0 : sms 56  Capabilities 6.0, SmClock 1328.5 Mhz, MemSize (Mb) 16280, MemClock 715.0 Mhz, Ecc=1, boardGroupID=0</span><br><span class="line">Using device 0</span><br><span class="line"></span><br><span class="line">Testing single precision</span><br><span class="line">Loading image data/one_28x28.pgm</span><br><span class="line">Performing forward propagation ...</span><br><span class="line">Testing cudnnGetConvolutionForwardAlgorithm ...</span><br><span class="line">Fastest algorithm is Algo 1</span><br><span class="line">Testing cudnnFindConvolutionForwardAlgorithm ...</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 0: 0.040256 time requiring 0 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 1: 0.048864 time requiring 3464 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 2: 0.066016 time requiring 57600 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 7: 0.090944 time requiring 2057744 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 5: 0.115776 time requiring 203008 memory</span><br><span class="line">Resulting weights from Softmax:</span><br><span class="line">0.0000000 0.9999399 0.0000000 0.0000000 0.0000561 0.0000000 0.0000012 0.0000017 0.0000010 0.0000000 </span><br><span class="line">Loading image data/three_28x28.pgm</span><br><span class="line">Performing forward propagation ...</span><br><span class="line">Resulting weights from Softmax:</span><br><span class="line">0.0000000 0.0000000 0.0000000 0.9999288 0.0000000 0.0000711 0.0000000 0.0000000 0.0000000 0.0000000 </span><br><span class="line">Loading image data/five_28x28.pgm</span><br><span class="line">Performing forward propagation ...</span><br><span class="line">Resulting weights from Softmax:</span><br><span class="line">0.0000000 0.0000008 0.0000000 0.0000002 0.0000000 0.9999820 0.0000154 0.0000000 0.0000012 0.0000006 </span><br><span class="line"></span><br><span class="line">Result of classification: 1 3 5</span><br><span class="line"></span><br><span class="line">Test passed!</span><br><span class="line"></span><br><span class="line">Testing half precision (math in single precision)</span><br><span class="line">Loading image data/one_28x28.pgm</span><br><span class="line">Performing forward propagation ...</span><br><span class="line">Testing cudnnGetConvolutionForwardAlgorithm ...</span><br><span class="line">Fastest algorithm is Algo 1</span><br><span class="line">Testing cudnnFindConvolutionForwardAlgorithm ...</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 0: 0.045184 time requiring 0 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 1: 0.051328 time requiring 3464 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 2: 0.067872 time requiring 28800 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 7: 0.087776 time requiring 2057744 memory</span><br><span class="line">^^^^ CUDNN_STATUS_SUCCESS for Algo 4: 0.112032 time requiring 207360 memory</span><br><span class="line">Resulting weights from Softmax:</span><br><span class="line">0.0000001 1.0000000 0.0000001 0.0000000 0.0000563 0.0000001 0.0000012 0.0000017 0.0000010 0.0000001 </span><br><span class="line">Loading image data/three_28x28.pgm</span><br><span class="line">Performing forward propagation ...</span><br><span class="line">Resulting weights from Softmax:</span><br><span class="line">0.0000000 0.0000000 0.0000000 1.0000000 0.0000000 0.0000714 0.0000000 0.0000000 0.0000000 0.0000000 </span><br><span class="line">Loading image data/five_28x28.pgm</span><br><span class="line">Performing forward propagation ...</span><br><span class="line">Resulting weights from Softmax:</span><br><span class="line">0.0000000 0.0000008 0.0000000 0.0000002 0.0000000 1.0000000 0.0000154 0.0000000 0.0000012 0.0000006 </span><br><span class="line"></span><br><span class="line">Result of classification: 1 3 5</span><br><span class="line"></span><br><span class="line">Test passed!</span><br></pre></td></tr></table></figure><h2 id="设置GPU"><a href="#设置GPU" class="headerlink" title="设置GPU"></a>设置GPU</h2><h3 id="手动设置"><a href="#手动设置" class="headerlink" title="手动设置"></a>手动设置</h3><h4 id="开启Persistence-Mode"><a href="#开启Persistence-Mode" class="headerlink" title="开启Persistence Mode"></a>开启Persistence Mode</h4><ul><li>在Linux平台上，可以设置PersistenceMode让Nvidia GPU驱动在空闲的时候依然保持加载状态。</li><li>此功能可以加快频繁运行短任务，避免频繁加载驱动</li><li>会提高待机功耗</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvidia-persistenced</span><br><span class="line">nvidia-smi -pm 1</span><br></pre></td></tr></table></figure><h4 id="禁用受限模式"><a href="#禁用受限模式" class="headerlink" title="禁用受限模式"></a>禁用受限模式</h4><ul><li>允许非管理员运行的CUDA程序调整频率</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi -acp 0</span><br></pre></td></tr></table></figure><h4 id="禁用GPU-Boost"><a href="#禁用GPU-Boost" class="headerlink" title="禁用GPU Boost"></a>禁用GPU Boost</h4><ul><li>GPU Boost功能可以让GPU根据<code>负载、散热、供电</code>动态超频运行</li><li>GPU Boost功能需要管理员权限才能调用，这里把权限放开给非管理员程序使用</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi --auto-boost-permission=0</span><br><span class="line">nvidia-smi --auto-boost-default=0</span><br></pre></td></tr></table></figure><h4 id="设置GPU运行频率"><a href="#设置GPU运行频率" class="headerlink" title="设置GPU运行频率"></a>设置GPU运行频率</h4><ul><li>获取GPU支持的频率</li><li>设置GPU运行频率</li><li><code>-i</code>参数指定显卡ID</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CLOCK=$(nvidia-smi -i 0 --query-supported-clocks=mem,gr --format=csv,noheader| head -n1 | awk 'BEGIN &#123; FS=" " &#125; ; &#123; print $1 "," $3 &#125;')</span><br><span class="line">nvidia-smi -ac $CLOCK -i 0</span><br></pre></td></tr></table></figure><h4 id="加载Nvidia模块"><a href="#加载Nvidia模块" class="headerlink" title="加载Nvidia模块"></a>加载Nvidia模块</h4><ul><li><font color="red">按需调整</font></li><li>这里可以独立于Linux发行版的方式创建Nvidia设备文件</li><li><code>create-nvidia-device-file</code>创建给定编号的Nvidia设备文件</li><li><code>unified-memory</code>加载<code>Nvidia Unified Memory</code>模块</li><li><code>modeset</code>加载Nvidia内核模块并创建设备文件</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-modprobe --unified-memory --create-nvidia-device-file=0 --modeset</span><br></pre></td></tr></table></figure><h3 id="开机自动设置"><a href="#开机自动设置" class="headerlink" title="开机自动设置"></a>开机自动设置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/rc.local &lt;&lt;EOF</span><br><span class="line">nvidia-smi -pm 1 || true</span><br><span class="line">nvidia-smi -acp 0 || true</span><br><span class="line">nvidia-smi --auto-boost-default=0 || true</span><br><span class="line">nvidia-smi --auto-boost-permission=0 || true</span><br><span class="line"><span class="meta">#</span><span class="bash">nvidia-modprobe --unified-memory --create-nvidia-device-file=0 --modeset || <span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">nvidia-smi -ac $(nvidia-smi -i 0 --query-supported-clocks=mem,gr --format=csv,noheader| head -n1 | awk <span class="string">'BEGIN &#123; FS=" " &#125; ; &#123; print $1 "," $3 &#125;'</span>) -i 0</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="使用阿里云自动安装脚本"><a href="#使用阿里云自动安装脚本" class="headerlink" title="使用阿里云自动安装脚本"></a>使用阿里云自动安装脚本</h1><h2 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h2><ul><li>阿里云在创建GPU计算型实例时，可以通过metadata的方式传入初始化脚本，实现自动安装Nvidia GPU驱动和CUDA</li><li>详细流程可以看阿里云的<a href="https://help.aliyun.com/document_detail/60149.html?spm=a2c4g.11186623.6.609.31771bd1cL1PMA" target="_blank" rel="noopener">操作文档</a></li></ul><h2 id="运行脚本"><a href="#运行脚本" class="headerlink" title="运行脚本"></a>运行脚本</h2><ul><li>驱动版本<code>390.116</code></li><li>CUDA版本<code>9.0.176</code></li><li>cuDNN版本<code>7.5.0</code>（阿里云没提供<code>7.6.0.64</code>的版本，根据文档选择了最新的<code>7.5.0</code>）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DRIVER_VERSION="390.116"</span><br><span class="line">CUDA_VERSION="9.0.176"</span><br><span class="line">CUDNN_VERSION="7.5.0"</span><br><span class="line">IS_INSTALL_RAPIDS="FALSE"</span><br><span class="line">IS_INSTALL_PERSEUS="TRUE"</span><br><span class="line"></span><br><span class="line">INSTALL_DIR="/root/auto_install"</span><br><span class="line">log=$&#123;INSTALL_DIR&#125;/nvidia_install.log</span><br><span class="line"></span><br><span class="line">mkdir $INSTALL_DIR &amp;&amp; cd $INSTALL_DIR</span><br><span class="line">script_download_url=$(curl http://100.100.100.200/latest/meta-data/source-address | head -1)"/opsx/ecs/linux/binary/script/auto_install.sh"</span><br><span class="line">wget -t 10 --timeout=10 $script_download_url</span><br><span class="line">sh $&#123;INSTALL_DIR&#125;/$&#123;auto_install_script&#125; $DRIVER_VERSION $CUDA_VERSION $CUDNN_VERSION $IS_INSTALL_PERSEUS $IS_INSTALL_RAPIDS</span><br></pre></td></tr></table></figure><h1 id="Nvidia-Docker"><a href="#Nvidia-Docker" class="headerlink" title="Nvidia-Docker"></a>Nvidia-Docker</h1><h2 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h2><ul><li>安装<code>Docker-CE Stable</code></li><li>安装<code>Nvidia-Docker</code></li></ul><h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><blockquote><p>这里以docker-ce 最新版本为例</p></blockquote><ul><li>清理旧Docker包</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine</span><br></pre></td></tr></table></figure><ul><li>安装Docker依赖包</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure><ul><li>添加Docker-CE源</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><ul><li>安装Docker-CE</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce -y</span><br></pre></td></tr></table></figure><ul><li>配置Docker启动参数</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">    "registry-mirrors": ["https://dockerhub.azk8s.cn"],</span><br><span class="line">    "insecure-registries": [],</span><br><span class="line">    "log-driver": "json-file",</span><br><span class="line">    "log-opts": &#123;</span><br><span class="line">        "max-size": "100m",</span><br><span class="line">        "max-file": "3"</span><br><span class="line">    &#125;,</span><br><span class="line">    "storage-driver": "overlay2",</span><br><span class="line">    "storage-opts": [</span><br><span class="line">        "overlay2.override_kernel_check=true"</span><br><span class="line">    ],</span><br><span class="line">    "data-root": "/var/lib/docker",</span><br><span class="line">    "max-concurrent-downloads": 10</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>设置Docker命令补全</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/bash-completion/completions/docker /etc/bash_completion.d/</span><br></pre></td></tr></table></figure><ul><li>禁用Docker-CE源</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --disable docker-ce-stable</span><br></pre></td></tr></table></figure><ul><li>启动Docker</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now docker.service</span><br></pre></td></tr></table></figure><ul><li>检查Docker信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure><h2 id="安装Nvidia-Docker"><a href="#安装Nvidia-Docker" class="headerlink" title="安装Nvidia-Docker"></a>安装Nvidia-Docker</h2><ul><li>添加YUM源</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;echo $ID$VERSION_ID)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.repo | tee /etc/yum.repos.d/nvidia-docker.repo</span><br></pre></td></tr></table></figure><ul><li>安装NVIDIA Container Toolkit</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nvidia-container-toolkit</span><br></pre></td></tr></table></figure><ul><li>重启Docker</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure><h2 id="测试容器调用GPU"><a href="#测试容器调用GPU" class="headerlink" title="测试容器调用GPU"></a>测试容器调用GPU</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --gpus all nvidia/cuda:9.0-base nvidia-smi</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Unable to find image 'nvidia/cuda:9.0-base' locally</span><br><span class="line">9.0-base: Pulling from nvidia/cuda</span><br><span class="line">976a760c94fc: Pull complete </span><br><span class="line">c58992f3c37b: Pull complete </span><br><span class="line">0ca0e5e7f12e: Pull complete </span><br><span class="line">f2a274cc00ca: Pull complete </span><br><span class="line">708a53113e13: Pull complete </span><br><span class="line">371ddc2ca87b: Pull complete </span><br><span class="line">f81888eb6932: Pull complete </span><br><span class="line">Digest: sha256:56bfa4e0b6d923bf47a71c91b4e00b62ea251a04425598d371a5807d6ac471cb</span><br><span class="line">Status: Downloaded newer image for nvidia/cuda:9.0-base</span><br><span class="line">      </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 390.116                Driver Version: 390.116                   |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla P100-PCIE...  On   | 00000000:00:08.0 Off |                    0 |</span><br><span class="line">| N/A   33C    P0    25W / 250W |      0MiB / 16280MiB |      0%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">                                                                               </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                       GPU Memory |</span><br><span class="line">|  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|  No running processes found                                                 |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;理论上适用于其他云平台的&lt;code&gt;GPU计算型实例&lt;/code&gt;或者&lt;code&gt;自建GPU计算服务器&lt;/code&gt;&lt;/li&gt;&lt;l
      
    
    </summary>
    
      <category term="Linux" scheme="https://luanlengli.github.io/categories/Linux/"/>
    
      <category term="CUDA" scheme="https://luanlengli.github.io/categories/Linux/CUDA/"/>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
      <category term="CUDA" scheme="https://luanlengli.github.io/tags/CUDA/"/>
    
  </entry>
  
  <entry>
    <title>从零搭建基于Istio的ServiceMesh-03流量管理</title>
    <link href="https://luanlengli.github.io/2019/12/19/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8EIstio%E7%9A%84ServiceMesh-03%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86.html"/>
    <id>https://luanlengli.github.io/2019/12/19/从零搭建基于Istio的ServiceMesh-03流量管理.html</id>
    <published>2019-12-19T07:16:33.000Z</published>
    <updated>2020-03-20T02:39:26.461Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>istio版本号<code>1.4.2</code></li><li>k8s集群版本<code>v1.14.8</code></li><li>istio在<code>1.4</code>提供了基于istioctl命令直接部署的功能，这里使用istioctl部署istio。<ul><li>自带配置校验、和丰富的自定义配置选项</li><li>API版本号还在<font color="red">Alpha阶段</font>，<code>install.istio.io/v1alpha2</code>，请自行判断是否适用</li><li>部署要求<ul><li>至少得有Kubernetes集群</li><li>Istio-1.4版本在<code>1.13</code>、<code>1.14</code>、<code>1.15</code>的k8s集群上是做过测试通过的</li><li>最新的<code>1.16</code>没在官方文档里注明，应该也是可以用的。<a href="https://istio.io/docs/setup/platform-setup/" target="_blank" rel="noopener">官方说明在此</a></li></ul></li></ul></li><li>这里通过官方示例熟悉一下istio的ServiceMesh特性</li></ul><h1 id="流量管理-Traffic-Management"><a href="#流量管理-Traffic-Management" class="headerlink" title="流量管理 Traffic Management"></a>流量管理 Traffic Management</h1><h2 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h2><ul><li>流量管理包含了<code>Ingress</code>和<code>Egress</code>，这里单独拎出来介绍，避免章节篇幅太长</li><li>下面继续</li></ul><h2 id="请求路由-Request-Routing"><a href="#请求路由-Request-Routing" class="headerlink" title="请求路由 Request Routing"></a>请求路由 Request Routing</h2><h3 id="部署VirtualService"><a href="#部署VirtualService" class="headerlink" title="部署VirtualService"></a>部署VirtualService</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h3 id="检查VirtualService"><a href="#检查VirtualService" class="headerlink" title="检查VirtualService"></a>检查VirtualService</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get virtualservice.networking.istio.io</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME          GATEWAYS             HOSTS           AGE</span><br><span class="line">bookinfo      [bookinfo-gateway]   [*]             28m</span><br><span class="line">details                            [details]       43s</span><br><span class="line">productpage                        [productpage]   43s</span><br><span class="line">ratings                            [ratings]       43s</span><br><span class="line">reviews                            [reviews]       43s</span><br></pre></td></tr></table></figure><h3 id="检查DestinationRule"><a href="#检查DestinationRule" class="headerlink" title="检查DestinationRule"></a>检查DestinationRule</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get destinationrules.networking.istio.io</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME          HOST          AGE</span><br><span class="line">details       details       11m</span><br><span class="line">productpage   productpage   11m</span><br><span class="line">ratings       ratings       11m</span><br><span class="line">reviews       reviews       11m</span><br></pre></td></tr></table></figure><h3 id="测试路由配置"><a href="#测试路由配置" class="headerlink" title="测试路由配置"></a>测试路由配置</h3><ul><li><p>通过浏览器打开<code>http://${GATEWAY_URL}/productpage</code></p></li><li><p>会发现无论刷新多少次页面都只能访问到<code>reviewers-v1</code>的页面。</p></li><li><p>即所有流量都被路由到了<code>reviewers:v1</code></p></li></ul><h3 id="配置新的VirtualService"><a href="#配置新的VirtualService" class="headerlink" title="配置新的VirtualService"></a>配置新的VirtualService</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        end-user:</span></span><br><span class="line"><span class="attr">          exact:</span> <span class="string">jason</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><h3 id="测试新的配置"><a href="#测试新的配置" class="headerlink" title="测试新的配置"></a>测试新的配置</h3><ul><li>不登陆，返回的页面依旧是<code>reviews-v1</code></li><li>点击右上角的<code>sign in</code>，登录之后，返回的页面是<code>reviews-v2</code><ul><li>UserName填入<code>jason</code></li><li>Password不填或者随便填</li></ul></li><li>登录其他用户，返回的页面是<code>reviews-v1</code></li></ul><h3 id="技术总结"><a href="#技术总结" class="headerlink" title="技术总结"></a>技术总结</h3><blockquote><p>通过配置<code>VirtualService</code>将请求的数据流修改如下</p></blockquote><ul><li><code>productpage</code> → <code>reviews:v2</code> → <code>ratings</code> (only for user <code>jason</code>)</li><li><code>productpage</code> → <code>reviews:v1</code> (for everyone else)</li></ul><h3 id="清理现场"><a href="#清理现场" class="headerlink" title="清理现场"></a>清理现场</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><h2 id="HTTP故障注入-HTTP-Fault-Injection"><a href="#HTTP故障注入-HTTP-Fault-Injection" class="headerlink" title="HTTP故障注入 HTTP Fault Injection"></a>HTTP故障注入 HTTP Fault Injection</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li>部署VirtualService</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</span><br></pre></td></tr></table></figure><ul><li>上面两个YAML文件会将请求的数据流变成这样(这一步跟流量管理一样)<ul><li><code>productpage</code> → <code>reviews:v2</code> → <code>ratings</code> (only for user <code>jason</code>)</li><li><code>productpage</code> → <code>reviews:v1</code> (for everyone else)</li></ul></li></ul><h3 id="注入HTTP延迟错误"><a href="#注入HTTP延迟错误" class="headerlink" title="注入HTTP延迟错误"></a>注入HTTP延迟错误</h3><h4 id="实验设计"><a href="#实验设计" class="headerlink" title="实验设计"></a>实验设计</h4><ul><li>为<code>jason</code>用户访问<code>reviews-v2</code>和<code>rateings</code>注入7s延迟</li><li><code>reviews-v2</code>服务，代码里设置了10s的连接超时时间</li><li>理论上，注入7s延迟不会导致<code>reviews-v2</code>超时出错</li></ul><h4 id="创建故障注入规则"><a href="#创建故障注入规则" class="headerlink" title="创建故障注入规则"></a>创建故障注入规则</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        end-user:</span></span><br><span class="line"><span class="attr">          exact:</span> <span class="string">jason</span></span><br><span class="line"><span class="attr">    fault:</span></span><br><span class="line"><span class="attr">      delay:</span></span><br><span class="line"><span class="attr">        percentage:</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">100.0</span></span><br><span class="line"><span class="attr">        fixedDelay:</span> <span class="number">7</span><span class="string">s</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><h4 id="测试故障注入"><a href="#测试故障注入" class="headerlink" title="测试故障注入"></a>测试故障注入</h4><ul><li>浏览器打开<code>http://${GATEWAY_URL}/productpage</code></li><li>按<code>F12</code>打开开发者工具，切换到<code>network</code>标签</li><li>登录<code>jason</code>用户，等待7s之后可以看到页面返回以下内容</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error fetching product reviews!</span><br><span class="line">Sorry, product reviews are currently unavailable for this book.</span><br></pre></td></tr></table></figure><ul><li>在开发者工具里面能看到请求<code>productpage</code>的时间是6s</li><li>登录其他用户或者不登陆，刷新页面并不会引入延迟</li></ul><h4 id="技术总结-1"><a href="#技术总结-1" class="headerlink" title="技术总结"></a>技术总结</h4><ol><li><code>reviews-v2</code>服务，代码里面设置10s超时，延时7s并不会引发报错</li><li><code>productpage</code>和<code>ratings</code>服务之间的超时时间是3s，重试次数为1，因此只能容忍3s+3s总共6s的延迟，这里设置7s，导致超时出错</li><li>这样就可以通过延迟注入，来检查服务间调用的超时时间是否合理</li></ol><h4 id="清理现场-1"><a href="#清理现场-1" class="headerlink" title="清理现场"></a>清理现场</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><h3 id="注入HTTP状态码错误"><a href="#注入HTTP状态码错误" class="headerlink" title="注入HTTP状态码错误"></a>注入HTTP状态码错误</h3><h4 id="实验设计-1"><a href="#实验设计-1" class="headerlink" title="实验设计"></a>实验设计</h4><ul><li>为<code>jason</code>用户引入HTTP状态码错误</li></ul><h4 id="创建故障注入规则-1"><a href="#创建故障注入规则-1" class="headerlink" title="创建故障注入规则"></a>创建故障注入规则</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        end-user:</span></span><br><span class="line"><span class="attr">          exact:</span> <span class="string">jason</span></span><br><span class="line"><span class="attr">    fault:</span></span><br><span class="line"><span class="attr">      abort:</span></span><br><span class="line"><span class="attr">        percentage:</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">100.0</span></span><br><span class="line"><span class="attr">        httpStatus:</span> <span class="number">500</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><h4 id="测试故障注入-1"><a href="#测试故障注入-1" class="headerlink" title="测试故障注入"></a>测试故障注入</h4><ul><li>浏览器打开<code>http://${GATEWAY_URL}/productpage</code></li><li>按<code>F12</code>打开开发者工具，切换到<code>network</code>标签</li><li>登录<code>jason</code>用户，可以看到<ul><li>页面很快就加载完毕</li><li><code>ratings</code>服务不可用，提示<font color="red"><em>Ratings service is currently unavailable</em></font></li></ul></li><li>登录其他用户或者不登陆，刷新页面并不会看到此报错信息</li></ul><h4 id="技术总结-2"><a href="#技术总结-2" class="headerlink" title="技术总结"></a>技术总结</h4><ol><li>HTTP状态码注入只影响<code>jason</code>用户，由于没有引入延迟错误，所以是立刻返回<code>HTTP 500</code></li><li>在浏览器开发者工具的<code>network</code>标签里，看不到请求有<code>HTTP500</code>状态码</li><li>查看<code>reviews-v2</code>服务的日志，可以看到日志，证明是在<code>reviews-v2</code>和<code>ratings</code>之间注入故障的</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: unable to contact http://ratings:9080/ratings got status of 500</span><br></pre></td></tr></table></figure><h3 id="清理现场-2"><a href="#清理现场-2" class="headerlink" title="清理现场"></a>清理现场</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><h2 id="HTTP流量切换-HTTP-Traffic-Shifting"><a href="#HTTP流量切换-HTTP-Traffic-Shifting" class="headerlink" title="HTTP流量切换 HTTP Traffic Shifting"></a>HTTP流量切换 HTTP Traffic Shifting</h2><h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li>部署bookinfo应用</li><li>配置默认的DestinationRule</li></ul><h3 id="配置所有流量走v1服务"><a href="#配置所有流量走v1服务" class="headerlink" title="配置所有流量走v1服务"></a>配置所有流量走v1服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><h3 id="配置权重路由"><a href="#配置权重路由" class="headerlink" title="配置权重路由"></a>配置权重路由</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v3</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure><h3 id="验证流量切换"><a href="#验证流量切换" class="headerlink" title="验证流量切换"></a>验证流量切换</h3><ul><li>浏览器打开<code>http://${GATEWAY_URL}/productpage</code></li><li>不断按<code>ctrl+F5</code>刷新页面，可以看到页面不断在<code>reviews-v1</code>和<code>reviews-v3</code>之间切换</li></ul><h3 id="技术总结-3"><a href="#技术总结-3" class="headerlink" title="技术总结"></a>技术总结</h3><ul><li>在所有流量都走v1的情况下，通过权重路由的方式，将部分流量切换到了新版本</li><li>通过流量比例的调整，达到灰度更新的目的</li></ul><h3 id="清理现场-3"><a href="#清理现场-3" class="headerlink" title="清理现场"></a>清理现场</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><h2 id="TCP流量切换-TCP-Traffic-Shifting"><a href="#TCP流量切换-TCP-Traffic-Shifting" class="headerlink" title="TCP流量切换 TCP Traffic Shifting"></a>TCP流量切换 TCP Traffic Shifting</h2><h3 id="环境准备-2"><a href="#环境准备-2" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li><p>部署多版本<code>TCP-echo</code>服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/tcp-echo/tcp-echo-services.yaml</span><br></pre></td></tr></table></figure></li><li><p>检查部署情况</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get pod -l app=tcp-echo</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">tcp-echo-5ff7fd7996-ds72s      2/2     Running   0          40m</span><br><span class="line">tcp-echo-v1-b559f69bd-5mbj8    2/2     Running   0          3m48s</span><br><span class="line">tcp-echo-v2-547bb5f4d5-trlh9   2/2     Running   0          3m48s</span><br></pre></td></tr></table></figure></li></ul><h3 id="配置默认TCP流量路由到v1版本"><a href="#配置默认TCP流量路由到v1版本" class="headerlink" title="配置默认TCP流量路由到v1版本"></a>配置默认TCP流量路由到v1版本</h3><blockquote><p>这里把TCP流量路由到<code>v1</code>版本</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/tcp-echo/tcp-echo-all-v1.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tcp-echo-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">31400</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tcp</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"*"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tcp-echo-destination</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"*"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">tcp-echo-gateway</span></span><br><span class="line"><span class="attr">  tcp:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">31400</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><h3 id="测试TCP路由"><a href="#测试TCP路由" class="headerlink" title="测试TCP路由"></a>测试TCP路由</h3><ol><li>获取<code>IngressGateway</code>访问方式，这里的<code>istio-ingressGateway</code>使用<code>NodePort</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST=$(kubectl get pod -l istio=ingressgateway -n istio-system -o jsonpath='&#123;.items[0].status.hostIP&#125;')</span><br><span class="line">export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="tcp")].NodePort&#125;')</span><br></pre></td></tr></table></figure><ol start="2"><li>访问<code>TCP-echo</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..10&#125;;do /bin/bash -c "(date ; sleep 1) | nc $INGRESS_HOST $INGRESS_PORT";done</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">one Mon Dec 23 10:13:54 CST 2019</span><br><span class="line">one Mon Dec 23 10:13:55 CST 2019</span><br><span class="line">one Mon Dec 23 10:13:56 CST 2019</span><br><span class="line">one Mon Dec 23 10:13:57 CST 2019</span><br><span class="line">one Mon Dec 23 10:13:58 CST 2019</span><br><span class="line">one Mon Dec 23 10:13:59 CST 2019</span><br><span class="line">one Mon Dec 23 10:14:00 CST 2019</span><br><span class="line">one Mon Dec 23 10:14:01 CST 2019</span><br><span class="line">one Mon Dec 23 10:14:02 CST 2019</span><br><span class="line">one Mon Dec 23 10:14:03 CST 2019</span><br></pre></td></tr></table></figure><blockquote><font color="red">可以看到输出的信息是以<code>one</code>开头的，证明访问的是v1的服务</font></blockquote><h3 id="配置新的TCP流量路由"><a href="#配置新的TCP流量路由" class="headerlink" title="配置新的TCP流量路由"></a>配置新的TCP流量路由</h3><blockquote><p>把20%的流量路由到<code>tcp-echo:v2</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/tcp-echo/tcp-echo-20-v2.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"*"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">tcp-echo-gateway</span></span><br><span class="line"><span class="attr">  tcp:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">31400</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">tcp-echo</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure><h3 id="测试新的TCP路由"><a href="#测试新的TCP路由" class="headerlink" title="测试新的TCP路由"></a>测试新的TCP路由</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..10&#125;;do /bin/bash -c "(date ; sleep 1) | nc $INGRESS_HOST $INGRESS_PORT";done</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">one Mon Dec 23 10:19:14 CST 2019</span><br><span class="line">one Mon Dec 23 10:19:15 CST 2019</span><br><span class="line">two Mon Dec 23 10:19:16 CST 2019</span><br><span class="line">one Mon Dec 23 10:19:17 CST 2019</span><br><span class="line">one Mon Dec 23 10:19:18 CST 2019</span><br><span class="line">one Mon Dec 23 10:19:19 CST 2019</span><br><span class="line">one Mon Dec 23 10:19:20 CST 2019</span><br><span class="line">two Mon Dec 23 10:19:21 CST 2019</span><br><span class="line">one Mon Dec 23 10:19:22 CST 2019</span><br><span class="line">one Mon Dec 23 10:19:23 CST 2019</span><br></pre></td></tr></table></figure><h3 id="技术总结-4"><a href="#技术总结-4" class="headerlink" title="技术总结"></a>技术总结</h3><ul><li><code>istio-ingressGateway</code>通过<code>VirtualService</code>定义的流量转发权重分配流量</li><li>Kubernetes的Service是根据Pod数量，轮询分配TCP流量，无法灵活调配流量比例</li><li>V<code>irtualService</code>流量分配比例独立于Kubernetes的Pod副本数量，因此可以独立控制两个版本的数量。</li></ul><h3 id="清理现场-4"><a href="#清理现场-4" class="headerlink" title="清理现场"></a>清理现场</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f samples/tcp-echo/tcp-echo-all-v1.yaml</span><br><span class="line">kubectl delete -f samples/tcp-echo/tcp-echo-services.yaml</span><br></pre></td></tr></table></figure><h2 id="请求超时-Request-Timeout"><a href="#请求超时-Request-Timeout" class="headerlink" title="请求超时 Request Timeout"></a>请求超时 Request Timeout</h2><h3 id="环境准备-3"><a href="#环境准备-3" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li>部署带有默认<code>DestionationRules</code>的<code>bookinfo</code></li><li>配置所有流量走v1服务</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><h3 id="配置请求延迟"><a href="#配置请求延迟" class="headerlink" title="配置请求延迟"></a>配置请求延迟</h3><p>通过配置HTTP路由里面的<code>delay</code>字段，可以人为地把请求延迟。</p><ol><li>把请求路由到<code>reviews-v2</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ol start="2"><li>给<code>ratings</code>添加2s延迟，让<code>istio-proxy</code>接到请求时延迟2s再处理</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: ratings</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - ratings</span><br><span class="line">  http:</span><br><span class="line">  - fault:</span><br><span class="line">      delay:</span><br><span class="line">        percent: 100</span><br><span class="line">        fixedDelay: 2s</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: ratings</span><br><span class="line">        subset: v1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="测试请求延迟"><a href="#测试请求延迟" class="headerlink" title="测试请求延迟"></a>测试请求延迟</h3><ol><li><p>用浏览器打开<code>http://${GATEWAY_URL}/productpage</code></p></li><li><p>等待2s之后页面才加载完毕，<code>reviews</code>显示正常</p></li></ol><h3 id="配置请求超时"><a href="#配置请求超时" class="headerlink" title="配置请求超时"></a>配置请求超时</h3><ul><li>现在给<code>reviews</code>服务添加0.5秒的超时</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v2</span><br><span class="line">    timeout: 0.5s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="测试请求超时"><a href="#测试请求超时" class="headerlink" title="测试请求超时"></a>测试请求超时</h3><ol><li>用浏览器打开<code>http://${GATEWAY_URL}/productpage</code></li><li>等待0.5s之后页面加载完毕，<code>reviews</code>服务提示<code>unavailable</code></li></ol><h3 id="技术总结-5"><a href="#技术总结-5" class="headerlink" title="技术总结"></a>技术总结</h3><ol><li><p>请求延迟是在<font color="red"><code>ratings</code></font>服务引入的，也就是<code>reviews</code>服务的<code>upstream</code></p></li><li><p><code>reviews</code>服务配置了超时时间后，在访问<code>ratings</code>，超过0.5s之后，<code>ratings</code>还没返回数据，直接就报<code>unavailable</code></p></li><li><p>请求流程如下</p><p><code>productpage</code> → <code>reviews:v2(timeout=0.5s)</code> → <code>ratings(delay=2s)</code></p></li><li><p>这里的延迟和超时，是由<code>istio-proxy</code>控制，程序无法感知</p></li><li><p>除了在istio路由规则中配置注入超时时间，程序可以在<code>HTTP Header</code>里添加<code>x-envoy-upstream-rq-timeout-ms</code>来覆盖掉istio路由规则里配置的超时时间</p></li></ol><h3 id="清理现场-5"><a href="#清理现场-5" class="headerlink" title="清理现场"></a>清理现场</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><h2 id="熔断-Circuit-Breaking"><a href="#熔断-Circuit-Breaking" class="headerlink" title="熔断 Circuit Breaking"></a>熔断 Circuit Breaking</h2><h3 id="环境准备-4"><a href="#环境准备-4" class="headerlink" title="环境准备"></a>环境准备</h3><ol><li>部署<code>httpbin</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/httpbin/httpbin.yaml</span><br></pre></td></tr></table></figure><ol start="2"><li>检查<code>httpbin</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l app=httpbin</span><br></pre></td></tr></table></figure><h3 id="配置熔断"><a href="#配置熔断" class="headerlink" title="配置熔断"></a>配置熔断</h3><ol><li>为<code>httpbin</code>创建带有熔断配置的DestinationRule，这里超过1个以上的并发请求会触发熔断<ul><li><code>maxConnections</code>限制对后端服务发起的 <code>HTTP/1.1</code> 连接数，如果超过了这个限制，就会开启熔断。</li><li><code>http1MaxPendingRequests: 1</code>最大HTTP请求pending数</li><li><code>maxRequestsPerConnection: 1</code>在任何给定时间内限制对后端服务发起的 <code>HTTP/2</code> 请求数，如果超过了这个限制，就会开启熔断。</li></ul></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  host: httpbin</span><br><span class="line">  trafficPolicy:</span><br><span class="line">    connectionPool:</span><br><span class="line">      tcp:</span><br><span class="line">        maxConnections: 1</span><br><span class="line">      http:</span><br><span class="line">        http1MaxPendingRequests: 1</span><br><span class="line">        maxRequestsPerConnection: 1</span><br><span class="line">    outlierDetection:</span><br><span class="line">      consecutiveErrors: 1</span><br><span class="line">      interval: 1s</span><br><span class="line">      baseEjectionTime: 3m</span><br><span class="line">      maxEjectionPercent: 100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建客户端程序"><a href="#创建客户端程序" class="headerlink" title="创建客户端程序"></a>创建客户端程序</h3><ol><li>部署客户端</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/httpbin/sample-client/fortio-deploy.yaml</span><br></pre></td></tr></table></figure><ol start="2"><li>查看客户端日志</li></ol><p>这里登录到客户端Pod终端使用fortio工具调用<code>httpbin</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FORTIO_POD=$(kubectl get pod | grep fortio | awk '&#123; print $1 &#125;')</span><br><span class="line">kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -curl  http://httpbin:8000/get</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line">date: Sat, 28 Dec 2019 02:45:09 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 371</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: true</span><br><span class="line">x-envoy-upstream-service-time: 3</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "args": &#123;&#125;, </span><br><span class="line">  "headers": &#123;</span><br><span class="line">    "Content-Length": "0", </span><br><span class="line">    "Host": "httpbin:8000", </span><br><span class="line">    "User-Agent": "fortio.org/fortio-1.3.1", </span><br><span class="line">    "X-B3-Parentspanid": "fcd70a478623c81e", </span><br><span class="line">    "X-B3-Sampled": "1", </span><br><span class="line">    "X-B3-Spanid": "6f6213dc72981add", </span><br><span class="line">    "X-B3-Traceid": "8aabe5c0b403be4ffcd70a478623c81e"</span><br><span class="line">  &#125;, </span><br><span class="line">  "origin": "127.0.0.1", </span><br><span class="line">  "url": "http://httpbin:8000/get"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="触发熔断"><a href="#触发熔断" class="headerlink" title="触发熔断"></a>触发熔断</h3><blockquote><p>上面配置的熔断触发条件，只要超过1个并发请求就会触发熔断，这里演示一下</p></blockquote><ol><li><p>在客户端并发2个连接并发送20个请求</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">08:09:41 I logger.go:97&gt; Log level is now 3 Warning (was 2 Info)</span><br><span class="line">Fortio 1.3.1 running at 0 queries per second, 12-&gt;12 procs, for 20 calls: http://httpbin:8000/get</span><br><span class="line">Starting at max qps with 2 thread(s) [gomax 12] for exactly 20 calls (10 per thread + 0)</span><br><span class="line">08:09:41 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">Ended after 16.699105ms : 20 calls. qps=1197.7</span><br><span class="line">Aggregated Function Time : count 20 avg 0.0016200426 +/- 0.0003949 min 0.00039727 max 0.002612624 sum 0.032400851</span><br><span class="line"><span class="meta">#</span><span class="bash"> range, mid point, percentile, count</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">= 0.00039727 &lt;= 0.001 , 0.000698635 , 5.00, 1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 0.001 &lt;= 0.002 , 0.0015 , 90.00, 17</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 0.002 &lt;= 0.00261262 , 0.00230631 , 100.00, 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 50% 0.00152941</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 75% 0.00182353</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 90% 0.002</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 99% 0.00255136</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 99.9% 0.0026065</span></span><br><span class="line">Sockets used: 3 (for perfect keepalive, would be 2)</span><br><span class="line">Code 200 : 19 (95.0 %)</span><br><span class="line">Code 503 : 1 (5.0 %)</span><br><span class="line">Response Header Sizes : count 20 avg 218.5 +/- 50.13 min 0 max 230 sum 4370</span><br><span class="line">Response Body/Total Sizes : count 20 avg 583 +/- 78.46 min 241 max 601 sum 11660</span><br><span class="line">All done 20 calls (plus 0 warmup) 1.620 ms avg, 1197.7 qps</span><br></pre></td></tr></table></figure></li><li><p>在客户端并发3个连接并发送30个请求</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -c 3 -qps 0 -n 30 -loglevel Warning http://httpbin:8000/get</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">10:25:52 I logger.go:97&gt; Log level is now 3 Warning (was 2 Info)</span><br><span class="line">Fortio 1.3.1 running at 0 queries per second, 12-&gt;12 procs, for 30 calls: http://httpbin:8000/get</span><br><span class="line">Starting at max qps with 3 thread(s) [gomax 12] for exactly 30 calls (10 per thread + 0)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">10:25:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1.1 503)</span><br><span class="line">Ended after 29.802582ms : 30 calls. qps=1006.6</span><br><span class="line">Aggregated Function Time : count 30 avg 0.0022023969 +/- 0.001246 min 0.000148903 max 0.00409224 sum 0.066071906</span><br><span class="line"><span class="meta">#</span><span class="bash"> range, mid point, percentile, count</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">= 0.000148903 &lt;= 0.001 , 0.000574451 , 26.67, 8</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 0.001 &lt;= 0.002 , 0.0015 , 30.00, 1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 0.002 &lt;= 0.003 , 0.0025 , 73.33, 13</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 0.003 &lt;= 0.004 , 0.0035 , 96.67, 7</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 0.004 &lt;= 0.00409224 , 0.00404612 , 100.00, 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 50% 0.00246154</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 75% 0.00307143</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 90% 0.00371429</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 99% 0.00406457</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> target 99.9% 0.00408947</span></span><br><span class="line">Sockets used: 11 (for perfect keepalive, would be 3)</span><br><span class="line">Code 200 : 21 (70.0 %)</span><br><span class="line">Code 503 : 9 (30.0 %)</span><br><span class="line">Response Header Sizes : count 30 avg 161 +/- 105.4 min 0 max 230 sum 4830</span><br><span class="line">Response Body/Total Sizes : count 30 avg 493 +/- 165 min 241 max 601 sum 14790</span><br><span class="line">All done 30 calls (plus 0 warmup) 2.202 ms avg, 1006.6 qps</span><br></pre></td></tr></table></figure></li></ol><h3 id="查看istio-proxy状态"><a href="#查看istio-proxy状态" class="headerlink" title="查看istio-proxy状态"></a>查看istio-proxy状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec $FORTIO_POD -c istio-proxy -- pilot-agent request GET stats | grep httpbin | grep upstream_rq_pending</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_active: 0</span><br><span class="line">cluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_failure_eject: 0</span><br><span class="line">cluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_overflow: 21</span><br><span class="line">cluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_total: 140</span><br></pre></td></tr></table></figure><p>其中<code>upstream_rq_pending_overflow</code>为溢出连接池熔断和失败的总请求，它的值是21，说明有 21 次调用触发了熔断</p><h3 id="技术总结-6"><a href="#技术总结-6" class="headerlink" title="技术总结"></a>技术总结</h3><h2 id="流量镜像-Traffic-Mirror"><a href="#流量镜像-Traffic-Mirror" class="headerlink" title="流量镜像 Traffic Mirror"></a>流量镜像 Traffic Mirror</h2><h3 id="环境准备-5"><a href="#环境准备-5" class="headerlink" title="环境准备"></a>环境准备</h3><ol><li><p>部署<code>httpbin-v1</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin-v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: httpbin</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: httpbin</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: docker.io/kennethreitz/httpbin</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: httpbin</span><br><span class="line">        command: ["gunicorn", "--access-logfile", "-", "-b", "0.0.0.0:80", "httpbin:app"]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>部署<code>httpbin-v2</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin-v2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: httpbin</span><br><span class="line">      version: v2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: httpbin</span><br><span class="line">        version: v2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: docker.io/kennethreitz/httpbin</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: httpbin</span><br><span class="line">        command: ["gunicorn", "--access-logfile", "-", "-b", "0.0.0.0:80", "httpbin:app"]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>配置Service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">  labels:</span><br><span class="line">    app: httpbin</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 8000</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: httpbin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>创建curl服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: sleep</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: sleep</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: sleep</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: sleep</span><br><span class="line">        image: tutum/curl</span><br><span class="line">        command: ["/bin/sleep","infinity"]</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ol><h3 id="配置默认路由"><a href="#配置默认路由" class="headerlink" title="配置默认路由"></a>配置默认路由</h3><p>将所有流量路由到<code>httpbin-v1</code>服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - httpbin</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: httpbin</span><br><span class="line">        subset: v1</span><br><span class="line">      weight: 100</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  host: httpbin</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="测试默认路由"><a href="#测试默认路由" class="headerlink" title="测试默认路由"></a>测试默认路由</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line">kubectl exec -it $SLEEP_POD -c sleep -- sh -c 'curl  http://httpbin:8000/headers' | python -m json.tool</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "headers": &#123;</span><br><span class="line">        "Accept": "*/*",</span><br><span class="line">        "Content-Length": "0",</span><br><span class="line">        "Host": "httpbin:8000",</span><br><span class="line">        "User-Agent": "curl/7.35.0",</span><br><span class="line">        "X-B3-Parentspanid": "601d07480eb04924",</span><br><span class="line">        "X-B3-Sampled": "1",</span><br><span class="line">        "X-B3-Spanid": "bffbefc545619374",</span><br><span class="line">        "X-B3-Traceid": "be4d5069467d569f601d07480eb04924"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="检查日志"><a href="#检查日志" class="headerlink" title="检查日志"></a>检查日志</h3><blockquote><p>检查v1和v2两个版本的Pod日志，只会在v1上看到访问日志</p></blockquote><ul><li>v1的日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export V1_POD=$(kubectl get pod -l app=httpbin,version=v1 -o jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line">kubectl logs -f $V1_POD -c httpbin</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 - - [30/Dec/2019:05:27:31 +0000] "GET /headers HTTP/1.1" 200 303 "-" "curl/7.35.0"</span><br></pre></td></tr></table></figure><ul><li>v2的日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export V2_POD=$(kubectl get pod -l app=httpbin,version=v2 -o jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line">kubectl logs -f $V2_POD -c httpbin</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="配置镜像流量到v2"><a href="#配置镜像流量到v2" class="headerlink" title="配置镜像流量到v2"></a>配置镜像流量到v2</h3><blockquote><p>这里把所有流量路由到v1，并且把流量镜像到v2，镜像流量的比例是100%。</p><p>当流量被镜像的时候，被镜像请求流量会在HTTP Header里面添加<code>-shadow</code></p><p><code>mirror_persent</code>可以控制镜像流量的比例，如果不定义则所有流量会被镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - httpbin</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: httpbin</span><br><span class="line">        subset: v1</span><br><span class="line">      weight: 100</span><br><span class="line">    mirror:</span><br><span class="line">      host: httpbin</span><br><span class="line">      subset: v2</span><br><span class="line">    mirror_percent: 100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="测试镜像流量"><a href="#测试镜像流量" class="headerlink" title="测试镜像流量"></a>测试镜像流量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $SLEEP_POD -c sleep -- sh -c 'curl  http://httpbin:8000/headers' | python -m json.tool</span><br></pre></td></tr></table></figure><h3 id="验证镜像流量"><a href="#验证镜像流量" class="headerlink" title="验证镜像流量"></a>验证镜像流量</h3><blockquote><p>查看v1和v2两个Pod的日志，可以发现会同时收到请求</p></blockquote><ul><li>v1的日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 - - [30/Dec/2019:05:33:18 +0000] "GET /headers HTTP/1.1" 200 303 "-" "curl/7.35.0"</span><br></pre></td></tr></table></figure><ul><li>v2的日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 - - [30/Dec/2019:05:33:18 +0000] "GET /headers HTTP/1.1" 200 303 "-" "curl/7.35.0"</span><br></pre></td></tr></table></figure><h3 id="网络抓包"><a href="#网络抓包" class="headerlink" title="网络抓包"></a>网络抓包</h3><blockquote><p>为了验证流量是真的被镜像了，通过tcpdump命令抓包</p></blockquote><ul><li>另起一个终端，运行tcpdump命令</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line">export V1_POD_IP=$(kubectl get pod -l app=httpbin,version=v1 -o jsonpath=&#123;.items..status.podIP&#125;)</span><br><span class="line">export V2_POD_IP=$(kubectl get pod -l app=httpbin,version=v2 -o jsonpath=&#123;.items..status.podIP&#125;)</span><br><span class="line">kubectl exec -it $SLEEP_POD -c istio-proxy -- sudo tcpdump -A -s 0 "((tcp) and (host $V1_POD_IP or host $V2_POD_IP))"</span><br></pre></td></tr></table></figure><ul><li>继续发起访问</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $SLEEP_POD -c sleep -- sh -c 'curl  http://httpbin:8000/headers' | python -m json.tool</span><br></pre></td></tr></table></figure><ul><li>在tcpdump的输出中可以看到，确实会往<code>v2 POD</code>发送了HTTP Header为<code>Host: httpbin-shadow</code>的请求</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">05:50:37.899317 IP sleep-b48bfdb67-79sss.39106 &gt; 10-244-0-97.httpbin.default.svc.cluster.local.80: Flags [P.], seq 1377715903:1377716635, ack 3041513480, win 288, options [nop,nop,TS val 616957010 ecr 616814401], length 732: HTTP: GET /headers HTTP/1.1</span><br><span class="line">E....!@.@...</span><br><span class="line">..c</span><br><span class="line">..a...PR.F..I..... .......</span><br><span class="line"><span class="meta">$</span><span class="bash">..R$..AGET /headers HTTP/1.1</span></span><br><span class="line">host: httpbin:8000</span><br><span class="line">user-agent: curl/7.35.0</span><br><span class="line">accept: */*</span><br><span class="line">x-forwarded-proto: http</span><br><span class="line">x-request-id: 6a86ff11-0a97-9d96-9ac4-55e83dca7af3</span><br><span class="line">x-envoy-decorator-operation: httpbin.default.svc.cluster.local:8000/*</span><br><span class="line">x-istio-attributes: CiUKGGRlc3RpbmF0aW9uLnNlcnZpY2UubmFtZRIJEgdodHRwYmluCioKHWRlc3RpbmF0aW9uLnNlcnZpY2UubmFtZXNwYWNlEgkSB2RlZmF1bHQKOgoKc291cmNlLnVpZBIsEiprdWJlcm5ldGVzOi8vc2xlZXAtYjQ4YmZkYjY3LTc5c3NzLmRlZmF1bHQKPwoYZGVzdGluYXRpb24uc2VydmljZS5ob3N0EiMSIWh0dHBiaW4uZGVmYXVsdC5zdmMuY2x1c3Rlci5sb2NhbAo9ChdkZXN0aW5hdGlvbi5zZXJ2aWNlLnVpZBIiEiBpc3RpbzovL2RlZmF1bHQvc2VydmljZXMvaHR0cGJpbg==</span><br><span class="line">x-b3-traceid: 8bd08e38b48384de25be6a75798bf068</span><br><span class="line">x-b3-spanid: 25be6a75798bf068</span><br><span class="line">x-b3-sampled: 1</span><br><span class="line">content-length: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">05:50:37.899386 IP sleep-b48bfdb67-79sss.48708 &gt; 10-244-0-98.httpbin.default.svc.cluster.local.80: Flags [P.], seq 818093502:818094295, ack 1670553383, win 293, options [nop,nop,TS val 616957010 ecr 616814401], length 793: HTTP: GET /headers HTTP/1.1</span><br><span class="line">E..M,.@.@..N</span><br><span class="line">..c</span><br><span class="line">..b.D.P0...c..'...%.......</span><br><span class="line"><span class="meta">$</span><span class="bash">..R$..AGET /headers HTTP/1.1</span></span><br><span class="line">host: httpbin-shadow:8000</span><br><span class="line">user-agent: curl/7.35.0</span><br><span class="line">accept: */*</span><br><span class="line">x-forwarded-proto: http</span><br><span class="line">x-request-id: 6a86ff11-0a97-9d96-9ac4-55e83dca7af3</span><br><span class="line">x-envoy-decorator-operation: httpbin.default.svc.cluster.local:8000/*</span><br><span class="line">x-istio-attributes: CiUKGGRlc3RpbmF0aW9uLnNlcnZpY2UubmFtZRIJEgdodHRwYmluCioKHWRlc3RpbmF0aW9uLnNlcnZpY2UubmFtZXNwYWNlEgkSB2RlZmF1bHQKOgoKc291cmNlLnVpZBIsEiprdWJlcm5ldGVzOi8vc2xlZXAtYjQ4YmZkYjY3LTc5c3NzLmRlZmF1bHQKPwoYZGVzdGluYXRpb24uc2VydmljZS5ob3N0EiMSIWh0dHBiaW4uZGVmYXVsdC5zdmMuY2x1c3Rlci5sb2NhbAo9ChdkZXN0aW5hdGlvbi5zZXJ2aWNlLnVpZBIiEiBpc3RpbzovL2RlZmF1bHQvc2VydmljZXMvaHR0cGJpbg==</span><br><span class="line">x-b3-traceid: 8bd08e38b48384de25be6a75798bf068</span><br><span class="line">x-b3-spanid: 25be6a75798bf068</span><br><span class="line">x-b3-sampled: 1</span><br><span class="line">x-envoy-internal: true</span><br><span class="line">x-forwarded-for: 10.244.0.99</span><br><span class="line">content-length: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">05:50:37.900503 IP 10-244-0-98.httpbin.default.svc.cluster.local.80 &gt; sleep-b48bfdb67-79sss.48708: Flags [P.], seq 1:237, ack 793, win 306, options [nop,nop,TS val 616957012 ecr 616957010], length 236: HTTP: HTTP/1.1 200 OK</span><br><span class="line">E.. ..@.@.m.</span><br><span class="line">..b</span><br><span class="line">..c.P.Dc..'0. ....2.......</span><br><span class="line"><span class="meta">$</span><span class="bash">..T$..RHTTP/1.1 200 OK</span></span><br><span class="line">server: istio-envoy</span><br><span class="line">date: Mon, 30 Dec 2019 05:50:37 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 343</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: true</span><br><span class="line">x-envoy-upstream-service-time: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">05:50:37.900513 IP sleep-b48bfdb67-79sss.48708 &gt; 10-244-0-98.httpbin.default.svc.cluster.local.80: Flags [.], ack 237, win 302, options [nop,nop,TS val 616957012 ecr 616957012], length 0</span><br><span class="line">E..4,.@.@..f</span><br><span class="line">..c</span><br><span class="line">..b.D.P0. .c..............</span><br><span class="line"><span class="meta">$</span><span class="bash">..T$..T</span></span><br><span class="line">05:50:37.900672 IP 10-244-0-98.httpbin.default.svc.cluster.local.80 &gt; sleep-b48bfdb67-79sss.48708: Flags [P.], seq 237:580, ack 793, win 306, options [nop,nop,TS val 616957012 ecr 616957012], length 343: HTTP</span><br><span class="line">E.....@.@.l.</span><br><span class="line">..b</span><br><span class="line">..c.P.Dc...0. ....2.*.....</span><br><span class="line"><span class="meta">$</span><span class="bash">..T$..T&#123;</span></span><br><span class="line">  "headers": &#123;</span><br><span class="line">    "Accept": "*/*", </span><br><span class="line">    "Content-Length": "0", </span><br><span class="line">    "Host": "httpbin-shadow:8000", </span><br><span class="line">    "User-Agent": "curl/7.35.0", </span><br><span class="line">    "X-B3-Parentspanid": "25be6a75798bf068", </span><br><span class="line">    "X-B3-Sampled": "1", </span><br><span class="line">    "X-B3-Spanid": "a80ddc34652a28dd", </span><br><span class="line">    "X-B3-Traceid": "8bd08e38b48384de25be6a75798bf068", </span><br><span class="line">    "X-Envoy-Internal": "true"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">05:50:37.900679 IP sleep-b48bfdb67-79sss.48708 &gt; 10-244-0-98.httpbin.default.svc.cluster.local.80: Flags [.], ack 580, win 311, options [nop,nop,TS val 616957012 ecr 616957012], length 0</span><br><span class="line">E..4,.@.@..e</span><br><span class="line">..c</span><br><span class="line">..b.D.P0. .c..j...7.......</span><br><span class="line"><span class="meta">$</span><span class="bash">..T$..T</span></span><br><span class="line">05:50:37.900856 IP 10-244-0-97.httpbin.default.svc.cluster.local.80 &gt; sleep-b48bfdb67-79sss.39106: Flags [P.], seq 1:540, ack 732, win 299, options [nop,nop,TS val 616957012 ecr 616957010], length 539: HTTP: HTTP/1.1 200 OK</span><br><span class="line">E..O..@.@.=.</span><br><span class="line">..a</span><br><span class="line">..c.P...I..R.I....+.......</span><br><span class="line"><span class="meta">$</span><span class="bash">..T$..RHTTP/1.1 200 OK</span></span><br><span class="line">server: istio-envoy</span><br><span class="line">date: Mon, 30 Dec 2019 05:50:37 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 303</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: true</span><br><span class="line">x-envoy-upstream-service-time: 1</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "headers": &#123;</span><br><span class="line">    "Accept": "*/*", </span><br><span class="line">    "Content-Length": "0", </span><br><span class="line">    "Host": "httpbin:8000", </span><br><span class="line">    "User-Agent": "curl/7.35.0", </span><br><span class="line">    "X-B3-Parentspanid": "25be6a75798bf068", </span><br><span class="line">    "X-B3-Sampled": "1", </span><br><span class="line">    "X-B3-Spanid": "5afe9681c8064c5d", </span><br><span class="line">    "X-B3-Traceid": "8bd08e38b48384de25be6a75798bf068"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">05:50:37.900868 IP sleep-b48bfdb67-79sss.39106 &gt; 10-244-0-97.httpbin.default.svc.cluster.local.80: Flags [.], ack 540, win 297, options [nop,nop,TS val 616957012 ecr 616957012], length 0</span><br><span class="line">E..4."@.@...</span><br><span class="line">..c</span><br><span class="line">..a...PR.I..I.#...).......</span><br><span class="line"><span class="meta">$</span><span class="bash">..T$..T</span></span><br></pre></td></tr></table></figure><h3 id="清理现场-6"><a href="#清理现场-6" class="headerlink" title="清理现场"></a>清理现场</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete virtualservice httpbin</span><br><span class="line">kubectl delete destinationrule httpbin</span><br><span class="line">kubectl delete deploy httpbin-v1 httpbin-v2 sleep</span><br><span class="line">kubectl delete svc httpbin</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;istio版本号&lt;code&gt;1.4.2&lt;/code&gt;&lt;/li&gt;&lt;li&gt;k8s集群版本&lt;code&gt;v1.14.8&lt;/code&gt;&lt;/l
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
      <category term="Istio" scheme="https://luanlengli.github.io/categories/Kubernetes/Istio/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="Istio" scheme="https://luanlengli.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>Python pip命令行设置国内镜像源</title>
    <link href="https://luanlengli.github.io/2019/12/19/Python-pip%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%AE%BE%E7%BD%AE%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E6%BA%90.html"/>
    <id>https://luanlengli.github.io/2019/12/19/Python-pip命令行设置国内镜像源.html</id>
    <published>2019-12-19T01:52:26.000Z</published>
    <updated>2020-01-17T02:30:26.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>pip是Python自带的包管理工具。</li><li>国内的网络环境影响，使用默认设置进行包依赖安装会非常慢，经常卡住导致安装失败。</li><li>为此特地记录下配置过程</li></ul><h1 id="配置pip"><a href="#配置pip" class="headerlink" title="配置pip"></a>配置pip</h1><h2 id="国内的PYPI源"><a href="#国内的PYPI源" class="headerlink" title="国内的PYPI源"></a>国内的PYPI源</h2><ul><li><a href="https://pypi.tuna.tsinghua.edu.cn/simple" target="_blank" rel="noopener">清华大学</a></li><li><a href="http://pypi.doubanio.com/simple/" target="_blank" rel="noopener">豆瓣</a></li><li><a href="https://mirrors.aliyun.com/pypi/simple" target="_blank" rel="noopener">阿里云</a></li><li><a href="https://mirrors.cloud.tencent.com/pypi/simple" target="_blank" rel="noopener">腾讯云</a></li><li><a href="https://mirrors.huaweicloud.com/repository/pypi/simple" target="_blank" rel="noopener">华为云</a></li></ul><h2 id="永久生效"><a href="#永久生效" class="headerlink" title="永久生效"></a>永久生效</h2><ul><li>这里以阿里云的pip镜像作为演示</li><li>Windows平台【打开命令行提示符或者PowerShell】</li><li>Linux/Mac平台打开终端</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip config set global.index-url <span class="string">'https://mirrors.aliyun.com/pypi/simple'</span></span><br><span class="line">pip config set global.timeout <span class="string">'120'</span></span><br><span class="line">pip config set global.trusted-host <span class="string">'mirrors.aliyun.com'</span></span><br></pre></td></tr></table></figure><h2 id="临时使用"><a href="#临时使用" class="headerlink" title="临时使用"></a>临时使用</h2><ul><li>这里以阿里云的pip镜像作为演示</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://mirrors.aliyun.com/pypi/simple &lt;PACKAGE_NAME&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;pip是Python自带的包管理工具。&lt;/li&gt;&lt;li&gt;国内的网络环境影响，使用默认设置进行包依赖安装会非常慢，经常卡住导致安装失
      
    
    </summary>
    
      <category term="Python" scheme="https://luanlengli.github.io/categories/Python/"/>
    
    
      <category term="Python" scheme="https://luanlengli.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes挂载NFS添加挂载选项</title>
    <link href="https://luanlengli.github.io/2019/12/18/Kubernetes%E6%8C%82%E8%BD%BDNFS%E6%B7%BB%E5%8A%A0%E6%8C%82%E8%BD%BD%E9%80%89%E9%A1%B9.html"/>
    <id>https://luanlengli.github.io/2019/12/18/Kubernetes挂载NFS添加挂载选项.html</id>
    <published>2019-12-18T14:54:55.000Z</published>
    <updated>2019-12-20T00:58:49.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h1><blockquote><p>这里引用阿里云的说明文档</p></blockquote><ol><li><p>为什么要使用<code>noresvport</code>参数挂载NAS？不重新挂载会有什么后果？</p><p>如果发生网络切换或者后端服务的HA倒换，小概率会造成NFS文件系统阻塞，那就可能需要几分钟时间连接才会自动恢复，极端情况下甚至需要重启ECS才能恢复。使用<code>noresvport</code>参数后，这个恢复几秒就可以自动完成。</p></li><li><p>什么情况会引发网络切换或者后端服务的HA倒换？</p><p>NAS服务是稳定的，网络切换或者后端服务的HA倒换都是罕见情况。</p><p>后端服务升级会触发上述切换，但导致客户端阻塞的概率很低，并且在升级之前我们会提前通知相关集群的用户，留出充足时间使用<code>noresvport</code>参数。</p><p>其他可能引发切换的场景，还有负载均衡调整、服务端硬件故障等情况，有一定的不可预测性，所以即使服务端没有升级安排，也请尽快使用<code>noresvport</code>参数避免这样的风险。</p></li><li><p>为什么需要重新挂载？还有没有其他的方案？</p><p>需要重新挂载的原因是要把之前没有使用<code>noresvport</code>参数的TCP连接断掉，然后使用<code>noresvport</code>参数挂载时，会建立新的TCP连接。</p><p>为了把老的TCP连接断掉，就必须把NAS相关的业务都停掉，然后执行<code>umount</code>卸载。</p><p>如果不希望重新挂载，可以考虑新建NAS挂载点，使用<code>noresvport</code>参数挂载到新的本地路径，然后把业务进程逐步迁移过去，最后废弃老的挂载路径和挂载点。</p></li></ol><h1 id="挂载NFS"><a href="#挂载NFS" class="headerlink" title="挂载NFS"></a>挂载NFS</h1><h2 id="静态存储卷"><a href="#静态存储卷" class="headerlink" title="静态存储卷"></a>静态存储卷</h2><ul><li>NFS v3版</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pv-nfs-v3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">2</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  mountOptions:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">vers=3</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nolock,tcp,noresvport</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/nfs-v3</span></span><br><span class="line"><span class="attr">    server:</span> <span class="string">nas_server</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><ul><li>NFS v4.0版</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pv-nfs-v4.0</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">2</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  mountOptions:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">vers=4.0</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">noresvport</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/nfs-v4.0</span></span><br><span class="line"><span class="attr">    server:</span> <span class="string">nas_server</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><h2 id="动态存储卷"><a href="#动态存储卷" class="headerlink" title="动态存储卷"></a>动态存储卷</h2><blockquote><p>假设集群已经部署了<code>nfs-client-provisioner</code>用来实现在动态提供<code>PersistentVolume</code></p></blockquote><h3 id="创建StorageClass"><a href="#创建StorageClass" class="headerlink" title="创建StorageClass"></a>创建StorageClass</h3><ul><li>NFS v3版</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfsv3-sc</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">vers=3</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">nolock,tcp,noresvport</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><ul><li>NFS v4.0版</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfsv4-sc</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">vers=4.0</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">nolock,tcp,noresvport</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><h3 id="创建PVC"><a href="#创建PVC" class="headerlink" title="创建PVC"></a>创建PVC</h3><ul><li>NFS v3版</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfsv3-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">nfsv3-sc</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br></pre></td></tr></table></figure><ul><li>NFS v4.0版</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfsv4-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">nfsv4-sc</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br></pre></td></tr></table></figure><h3 id="测试挂载PV"><a href="#测试挂载PV" class="headerlink" title="测试挂载PV"></a>测试挂载PV</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-nfs-pod</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">test-nfs-pod</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:1.24</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"/bin/sh"</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"-c"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"while true; do sleep 99999;done"</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nfsv3-pvc</span></span><br><span class="line"><span class="attr">      mountPath:</span> <span class="string">"/mnt/nfsv3"</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nfsv4-pvc</span></span><br><span class="line"><span class="attr">      mountPath:</span> <span class="string">"/mnt/nfsv4"</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nfsv3-pvc</span></span><br><span class="line"><span class="attr">    persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">      claimName:</span> <span class="string">nfsv3-pvc</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nfsv4-pvc</span></span><br><span class="line"><span class="attr">    persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">      claimName:</span> <span class="string">nfsv4-pvc</span></span><br></pre></td></tr></table></figure><h3 id="验证挂载选项"><a href="#验证挂载选项" class="headerlink" title="验证挂载选项"></a>验证挂载选项</h3><ul><li>确认Pod所在宿主机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get pod test-nfs-pod -o wide</span><br></pre></td></tr></table></figure><ul><li>登录到宿主机查看mount，关注是否有<code>noresvport</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount | grep nfs</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nas_server:</span><span class="string">/default</span> <span class="string">on</span> <span class="string">/var/lib/kubelet/pods/a3d10191-04f2-11ea-b668-162fb9b39758/volumes/kubernetes.io~nfs/nfsv4-pvc</span> <span class="string">type</span> <span class="string">nfs4</span> <span class="string">(rw,relatime,vers=4.0,rsize=1048576,wsize=1048576,namlen=255,hard,noresvport,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=192.168.0.146,local_lock=none,addr=192.168.0.128,_netdev)</span></span><br></pre></td></tr></table></figure><h1 id="存量NFS存储卷更新"><a href="#存量NFS存储卷更新" class="headerlink" title="存量NFS存储卷更新"></a>存量NFS存储卷更新</h1><ul><li>修改NFS存储卷对应的PV，添加<code>mount</code>参数</li><li>重新调度使用NFS存储卷的Pod</li></ul><blockquote><font color="red">注意！</font><p>如果服务器上还有其他挂载点使用了同一个NFS存储，有可能无法更新挂载选项</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前情概要&quot;&gt;&lt;a href=&quot;#前情概要&quot; class=&quot;headerlink&quot; title=&quot;前情概要&quot;&gt;&lt;/a&gt;前情概要&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里引用阿里云的说明文档&lt;/p&gt;&lt;/blockquote&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;为什么要使用&lt;cod
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>从零搭建基于Istio的ServiceMesh-02Ingress&amp;Egress</title>
    <link href="https://luanlengli.github.io/2019/12/18/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8EIstio%E7%9A%84ServiceMesh-02Ingress&amp;Egress.html"/>
    <id>https://luanlengli.github.io/2019/12/18/从零搭建基于Istio的ServiceMesh-02Ingress&amp;Egress.html</id>
    <published>2019-12-18T07:16:33.000Z</published>
    <updated>2020-03-20T02:39:11.758Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>istio版本号<code>1.4.2</code></li><li>k8s集群版本<code>v1.14.8</code></li><li>istio在<code>1.4</code>提供了基于istioctl命令直接部署的功能，这里使用istioctl部署istio。<ul><li>自带配置校验、和丰富的自定义配置选项</li><li>API版本号还在<font color="red">Alpha阶段</font>，<code>install.istio.io/v1alpha2</code>，请自行判断是否适用</li><li>部署要求<ul><li>至少得有Kubernetes集群</li><li>Istio-1.4版本在<code>1.13</code>、<code>1.14</code>、<code>1.15</code>的k8s集群上是做过测试通过的</li><li>最新的<code>1.16</code>没在官方文档里注明，应该也是可以用的。<a href="https://istio.io/docs/setup/platform-setup/" target="_blank" rel="noopener">官方说明在此</a></li></ul></li></ul></li><li>这里通过官方示例熟悉一下istio的ServiceMesh特性</li></ul><h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><h2 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h2><ul><li><p>在Kubernetes环境中，Kubernetes的Ingress资源用于配置集群外部访问集群内部的服务。</p></li><li><p>在Istio中，使用Istio Gateway进行替代。</p></li></ul><h2 id="Istio通过Gateway实现对进入集群的流量进行路由和监控。"><a href="#Istio通过Gateway实现对进入集群的流量进行路由和监控。" class="headerlink" title="Istio通过Gateway实现对进入集群的流量进行路由和监控。"></a>Istio通过Gateway实现对进入集群的流量进行路由和监控。</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li>部署<code>httpbin</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/httpbin/httpbin.yaml</span><br></pre></td></tr></table></figure><h3 id="确定Ingress的IP地址端口"><a href="#确定Ingress的IP地址端口" class="headerlink" title="确定Ingress的IP地址端口"></a>确定Ingress的IP地址端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc istio-ingressgateway -n istio-system</span><br></pre></td></tr></table></figure><blockquote><p>输出示例，家境贫寒，这里用的是<code>NodePort</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                                                                                                                                      AGE</span><br><span class="line">istio-ingressgateway   NodePort   10.96.33.206   &lt;none&gt;        15020:31226/TCP,80:31355/TCP,443:30885/TCP,15029:31094/TCP,15030:31128/TCP,15031:30163/TCP,31400:31400/TCP,15032:31966/TCP,15443:30659/TCP   7d3h</span><br></pre></td></tr></table></figure><h3 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h3><blockquote><p>对于使用<code>LoadBalancer</code>的Service，可以通过<code>EXTERNAL-IP</code>加端口的形式访问<code>Istio-Gateway</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.status.loadBalancer.ingress[0].ip&#125;')</span><br><span class="line">export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http2")].port&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].port&#125;')</span><br></pre></td></tr></table></figure><h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><blockquote><p>我的实验环境没有<code>LoadBalancer</code>，因此用了<code>NodePort</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='&#123;.items[0].status.hostIP&#125;')</span><br><span class="line">export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http2")].nodePort&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].nodePort&#125;')</span><br></pre></td></tr></table></figure><h2 id="基础的Ingress"><a href="#基础的Ingress" class="headerlink" title="基础的Ingress"></a>基础的Ingress</h2><h3 id="使用Gateway配置ingress"><a href="#使用Gateway配置ingress" class="headerlink" title="使用Gateway配置ingress"></a>使用Gateway配置ingress</h3><blockquote><p>与Kubernetes自带的Ingress对象不同</p><p>Istio Gateway会使用istio自己的路由规则来转发流量，转发方式跟集群内部路由方式相同。</p></blockquote><h4 id="创建Gateway"><a href="#创建Gateway" class="headerlink" title="创建Gateway"></a>创建Gateway</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    istio: ingressgateway # use Istio default gateway implementation</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 80</span><br><span class="line">      name: http</span><br><span class="line">      protocol: HTTP</span><br><span class="line">    hosts:</span><br><span class="line">    - "httpbin.example.com"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建VirtualService"><a href="#创建VirtualService" class="headerlink" title="创建VirtualService"></a>创建VirtualService</h4><blockquote><p>指定了<code>httpbin-gateway</code>作为Istio Gateway</p><p>只允许<code>/status</code>和<code>/delay</code>两个请求，其他外部请求会<code>404</code></p><p>主机名指定<code>httpbin.example.com</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - "httpbin.example.com"</span><br><span class="line">  gateways:</span><br><span class="line">  - httpbin-gateway</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /status</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /delay</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        port:</span><br><span class="line">          number: 8000</span><br><span class="line">        host: httpbin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="集群外部访问"><a href="#集群外部访问" class="headerlink" title="集群外部访问"></a>集群外部访问</h3><h4 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h4><ul><li>正确访问方式</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I -H 'Host:httpbin.example.com' http://$INGRESS_HOST:$INGRESS_PORT/status/200</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: istio-envoy</span><br><span class="line">date: Mon, 30 Dec 2019 06:21:10 GMT</span><br><span class="line">content-type: text/html; charset=utf-8</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: true</span><br><span class="line">content-length: 0</span><br><span class="line">x-envoy-upstream-service-time: 3</span><br></pre></td></tr></table></figure><ul><li>错误访问方式</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 不带Host字段或者Host字段不匹配</span></span><br><span class="line">curl -I  http://$INGRESS_HOST:$INGRESS_PORT/status/200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 访问其他URL</span></span><br><span class="line">curl -I -H 'Host:httpbin.example.com' http://$INGRESS_HOST:$INGRESS_PORT/index.html</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">date: Mon, 30 Dec 2019 06:21:46 GMT</span><br><span class="line">server: istio-envoy</span><br><span class="line">transfer-encoding: chunked</span><br></pre></td></tr></table></figure><h4 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h4><h5 id="修改hosts文件"><a href="#修改hosts文件" class="headerlink" title="修改hosts文件"></a>修改hosts文件</h5><blockquote><p>添加以下内容，注意替换<font color="red"><code>Ingress_HOST</code></font>的值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Ingress_HOST&gt; httpbin.example.com</span><br></pre></td></tr></table></figure><h5 id="打开网页"><a href="#打开网页" class="headerlink" title="打开网页"></a>打开网页</h5><blockquote><p>注意替换<font color="red"><code>Ingress_Port</code></font>的值</p></blockquote><p><code>http://httpbin.example.com:&lt;Ingress_PORT&gt;/status/200</code></p><h3 id="清理环境"><a href="#清理环境" class="headerlink" title="清理环境"></a>清理环境</h3><blockquote><p>按需清理，后面做HTTPS还要用到httpbin</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete gateway httpbin-gateway</span><br><span class="line">kubectl delete virtualservice httpbin</span><br><span class="line">kubectl delete --ignore-not-found=true -f samples/httpbin/httpbin.yaml</span><br></pre></td></tr></table></figure><h2 id="基于SSL-TLS的Ingress-File-Mount文件挂载"><a href="#基于SSL-TLS的Ingress-File-Mount文件挂载" class="headerlink" title="基于SSL/TLS的Ingress (File Mount文件挂载)"></a>基于SSL/TLS的Ingress (File Mount文件挂载)</h2><h3 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h3><ul><li>Istio-Gateway同样可以处理HTTPS请求</li><li>TLS类型的Secret会被挂载到<code>/etc/istio/ingressgateway-certs</code></li><li>Secret对象的名字必须是<code>istio-ingressgateway-certs</code>并且命名空间是在<code>istio-system</code>，否则istio-Gateway无法识别</li></ul><h3 id="创建TLS类型的Secret"><a href="#创建TLS类型的Secret" class="headerlink" title="创建TLS类型的Secret"></a>创建TLS类型的Secret</h3><h4 id="已有证书"><a href="#已有证书" class="headerlink" title="已有证书"></a>已有证书</h4><p>如果购买了公网的可信任证书，可以跳过自建证书的步骤。</p><h4 id="自建证书"><a href="#自建证书" class="headerlink" title="自建证书"></a>自建证书</h4><h5 id="创建CA证书"><a href="#创建CA证书" class="headerlink" title="创建CA证书"></a>创建CA证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 \</span><br><span class="line">            -sha256 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -days 365 \</span><br><span class="line">            -newkey rsa:2048 \</span><br><span class="line">            -subj '/O=example Inc./CN=example.com' \</span><br><span class="line">            -keyout example.com.key \</span><br><span class="line">            -out example.com.crt</span><br></pre></td></tr></table></figure><h5 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">openssl req -out \</span><br><span class="line">            httpbin.example.com.csr \</span><br><span class="line">            -newkey rsa:2048 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -keyout httpbin.example.com.key \</span><br><span class="line">            -subj "/CN=httpbin.example.com/O=httpbin organization"</span><br><span class="line">openssl x509 -req \</span><br><span class="line">             -days 365 \</span><br><span class="line">             -CA example.com.crt \</span><br><span class="line">             -CAkey example.com.key \</span><br><span class="line">             -set_serial 0 \</span><br><span class="line">             -in httpbin.example.com.csr \</span><br><span class="line">             -out httpbin.example.com.crt</span><br></pre></td></tr></table></figure><h4 id="创建Secret"><a href="#创建Secret" class="headerlink" title="创建Secret"></a>创建Secret</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n istio-system create secret tls \</span><br><span class="line">        istio-ingressgateway-certs \</span><br><span class="line">        --key httpbin.example.com.key \</span><br><span class="line">        --cert httpbin.example.com.crt</span><br></pre></td></tr></table></figure><h4 id="检查证书是否挂载"><a href="#检查证书是否挂载" class="headerlink" title="检查证书是否挂载"></a>检查证书是否挂载</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it -n istio-system $(kubectl -n istio-system get pods -l istio=ingressgateway -o jsonpath='&#123;.items[0].metadata.name&#125;') -- ls -al /etc/istio/ingressgateway-certs</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">total 0</span><br><span class="line">drwxrwxrwt 3 root root 120 Dec 30 06:54 .</span><br><span class="line">drwxr-xr-x 1 root root  78 Dec 23 02:51 ..</span><br><span class="line">drwxr-xr-x 2 root root  80 Dec 30 06:54 ..2019_12_30_06_54_28.616938615</span><br><span class="line">lrwxrwxrwx 1 root root  31 Dec 30 06:54 ..data -&gt; ..2019_12_30_06_54_28.616938615</span><br><span class="line">lrwxrwxrwx 1 root root  14 Dec 30 06:54 tls.crt -&gt; ..data/tls.crt</span><br><span class="line">lrwxrwxrwx 1 root root  14 Dec 30 06:54 tls.key -&gt; ..data/tls.key</span><br></pre></td></tr></table></figure><h3 id="使用Gateway配置Ingress"><a href="#使用Gateway配置Ingress" class="headerlink" title="使用Gateway配置Ingress"></a>使用Gateway配置Ingress</h3><h4 id="创建Gateway-1"><a href="#创建Gateway-1" class="headerlink" title="创建Gateway"></a>创建Gateway</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    istio: ingressgateway # use istio default ingress gateway</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 443</span><br><span class="line">      name: https</span><br><span class="line">      protocol: HTTPS</span><br><span class="line">    tls:</span><br><span class="line">      mode: SIMPLE</span><br><span class="line">      serverCertificate: /etc/istio/ingressgateway-certs/tls.crt</span><br><span class="line">      privateKey: /etc/istio/ingressgateway-certs/tls.key</span><br><span class="line">    hosts:</span><br><span class="line">    - "httpbin.example.com"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建VirtualService-1"><a href="#创建VirtualService-1" class="headerlink" title="创建VirtualService"></a>创建VirtualService</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - "httpbin.example.com"</span><br><span class="line">  gateways:</span><br><span class="line">  - httpbin-gateway</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /status</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /delay</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        port:</span><br><span class="line">          number: 8000</span><br><span class="line">        host: httpbin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="访问HTTPS服务"><a href="#访问HTTPS服务" class="headerlink" title="访问HTTPS服务"></a>访问HTTPS服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -v \</span><br><span class="line">     -k \</span><br><span class="line">     -H 'Host:httpbin.example.com' \</span><br><span class="line">     --resolve httpbin.example.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \</span><br><span class="line">     --cacert example.com.crt \</span><br><span class="line">     https://httpbin.example.com:$SECURE_INGRESS_PORT/status/418</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">* Added httpbin.example.com:30885:192.168.48.37 to DNS cache</span><br><span class="line">* About to connect() to httpbin.example.com port 30885 (#0)</span><br><span class="line">*   Trying 192.168.48.37...</span><br><span class="line">* Connected to httpbin.example.com (192.168.48.37) port 30885 (#0)</span><br><span class="line">* Initializing NSS with certpath: sql:/etc/pki/nssdb</span><br><span class="line">* skipping SSL peer certificate verification</span><br><span class="line">* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">* Server certificate:</span><br><span class="line">* subject: O=httpbin organization,CN=httpbin.example.com</span><br><span class="line">* start date: Dec 30 06:53:12 2019 GMT</span><br><span class="line">* expire date: Dec 29 06:53:12 2020 GMT</span><br><span class="line">* common name: httpbin.example.com</span><br><span class="line">* issuer: CN=example.com,O=example Inc.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GET /status/418 HTTP/1.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Accept: */*</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Host:httpbin.example.com</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line">&lt; HTTP/1.1 418 Unknown</span><br><span class="line">&lt; server: istio-envoy</span><br><span class="line">&lt; date: Mon, 30 Dec 2019 07:09:01 GMT</span><br><span class="line">&lt; x-more-info: http://tools.ietf.org/html/rfc2324</span><br><span class="line">&lt; access-control-allow-origin: *</span><br><span class="line">&lt; access-control-allow-credentials: true</span><br><span class="line">&lt; content-length: 135</span><br><span class="line">&lt; x-envoy-upstream-service-time: 1</span><br><span class="line">&lt; </span><br><span class="line"></span><br><span class="line">    -=[ teapot ]=-</span><br><span class="line"></span><br><span class="line">       _...._</span><br><span class="line">     .'  _ _ `.</span><br><span class="line">    | ."` ^ `". _,</span><br><span class="line">    \_;`"---"`|//</span><br><span class="line">      |       ;/</span><br><span class="line">      \_     _/</span><br><span class="line">        `"""`</span><br><span class="line">* Connection #0 to host httpbin.example.com left intact</span><br></pre></td></tr></table></figure><h3 id="配置多Host的TLS-Ingress"><a href="#配置多Host的TLS-Ingress" class="headerlink" title="配置多Host的TLS Ingress"></a>配置多Host的TLS Ingress</h3><h4 id="创建TLS类型的Secret-1"><a href="#创建TLS类型的Secret-1" class="headerlink" title="创建TLS类型的Secret"></a>创建TLS类型的Secret</h4><blockquote><p>这里以bookinfo.com作为示例</p></blockquote><h5 id="创建证书-1"><a href="#创建证书-1" class="headerlink" title="创建证书"></a>创建证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">openssl req \</span><br><span class="line">        -out bookinfo.com.csr \</span><br><span class="line">        -newkey rsa:2048 \</span><br><span class="line">        -nodes \</span><br><span class="line">        -keyout bookinfo.com.key \</span><br><span class="line">        -subj "/CN=bookinfo.com/O=bookinfo organization"</span><br><span class="line">openssl x509 -req \</span><br><span class="line">        -days 365 \</span><br><span class="line">        -CA example.com.crt \</span><br><span class="line">        -CAkey example.com.key \</span><br><span class="line">        -set_serial 0 \</span><br><span class="line">        -in bookinfo.com.csr \</span><br><span class="line">        -out bookinfo.com.crt</span><br></pre></td></tr></table></figure><h5 id="创建Secret-1"><a href="#创建Secret-1" class="headerlink" title="创建Secret"></a>创建Secret</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n istio-system create secret tls \</span><br><span class="line">        istio-ingressgateway-bookinfo-certs \</span><br><span class="line">        --key bookinfo.com.key \</span><br><span class="line">        --cert bookinfo.com.crt</span><br></pre></td></tr></table></figure><h4 id="更新istio-ingressgateway"><a href="#更新istio-ingressgateway" class="headerlink" title="更新istio-ingressgateway"></a>更新istio-ingressgateway</h4><p>这里需要重新配置<code>istio-ingressgateway</code>的<code>deployment</code>以挂载新的证书</p><h5 id="创建Patch-file"><a href="#创建Patch-file" class="headerlink" title="创建Patch file"></a>创建Patch file</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; gateway-patch.json &lt;&lt;EOF</span><br><span class="line">[&#123;</span><br><span class="line">  "op": "add",</span><br><span class="line">  "path": "/spec/template/spec/containers/0/volumeMounts/0",</span><br><span class="line">  "value": &#123;</span><br><span class="line">    "mountPath": "/etc/istio/ingressgateway-bookinfo-certs",</span><br><span class="line">    "name": "ingressgateway-bookinfo-certs",</span><br><span class="line">    "readOnly": true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  "op": "add",</span><br><span class="line">  "path": "/spec/template/spec/volumes/0",</span><br><span class="line">  "value": &#123;</span><br><span class="line">  "name": "ingressgateway-bookinfo-certs",</span><br><span class="line">    "secret": &#123;</span><br><span class="line">      "secretName": "istio-ingressgateway-bookinfo-certs",</span><br><span class="line">      "optional": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h5 id="部署Patch"><a href="#部署Patch" class="headerlink" title="部署Patch"></a>部署Patch</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n istio-system patch --type=json deploy istio-ingressgateway -p "$(cat gateway-patch.json)"</span><br></pre></td></tr></table></figure><h5 id="检查证书挂载"><a href="#检查证书挂载" class="headerlink" title="检查证书挂载"></a>检查证书挂载</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it -n istio-system $(kubectl -n istio-system get pods -l istio=ingressgateway -o jsonpath='&#123;.items[0].metadata.name&#125;') -- ls -al /etc/istio/ingressgateway-bookinfo-certs</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">total 0</span><br><span class="line">drwxrwxrwt 3 root root 120 Dec 30 07:18 .</span><br><span class="line">drwxr-xr-x 1 root root 115 Dec 30 07:18 ..</span><br><span class="line">drwxr-xr-x 2 root root  80 Dec 30 07:18 ..2019_12_30_07_18_56.019679131</span><br><span class="line">lrwxrwxrwx 1 root root  31 Dec 30 07:18 ..data -&gt; ..2019_12_30_07_18_56.019679131</span><br><span class="line">lrwxrwxrwx 1 root root  14 Dec 30 07:18 tls.crt -&gt; ..data/tls.crt</span><br><span class="line">lrwxrwxrwx 1 root root  14 Dec 30 07:18 tls.key -&gt; ..data/tls.key</span><br></pre></td></tr></table></figure><h4 id="配置bookinfo-com路由"><a href="#配置bookinfo-com路由" class="headerlink" title="配置bookinfo.com路由"></a>配置bookinfo.com路由</h4><h5 id="部署bookinfo"><a href="#部署bookinfo" class="headerlink" title="部署bookinfo"></a>部署bookinfo</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span><br></pre></td></tr></table></figure><h5 id="定义Gateway"><a href="#定义Gateway" class="headerlink" title="定义Gateway"></a>定义Gateway</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    istio: ingressgateway # use istio default ingress gateway</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 443</span><br><span class="line">      name: https-bookinfo</span><br><span class="line">      protocol: HTTPS</span><br><span class="line">    tls:</span><br><span class="line">      mode: SIMPLE</span><br><span class="line">      serverCertificate: /etc/istio/ingressgateway-bookinfo-certs/tls.crt</span><br><span class="line">      privateKey: /etc/istio/ingressgateway-bookinfo-certs/tls.key</span><br><span class="line">    hosts:</span><br><span class="line">    - "bookinfo.com"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h5 id="定义VirtualService"><a href="#定义VirtualService" class="headerlink" title="定义VirtualService"></a>定义VirtualService</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - "bookinfo.com"</span><br><span class="line">  gateways:</span><br><span class="line">  - bookinfo-gateway</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /productpage</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /login</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /logout</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /api/v1/products</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: productpage</span><br><span class="line">        port:</span><br><span class="line">          number: 9080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="访问服务"><a href="#访问服务" class="headerlink" title="访问服务"></a>访问服务</h4><h5 id="bookinfo"><a href="#bookinfo" class="headerlink" title="bookinfo"></a>bookinfo</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -o /dev/null \</span><br><span class="line">     -s \</span><br><span class="line">     -v \</span><br><span class="line">     -w "%&#123;http_code&#125;\n" \</span><br><span class="line">     -H 'Host:bookinfo.com' \</span><br><span class="line">     --resolve bookinfo.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \</span><br><span class="line">     --cacert example.com.crt \</span><br><span class="line">     https://bookinfo.com:$SECURE_INGRESS_PORT/productpage</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">* Added bookinfo.com:30885:192.168.48.37 to DNS cache</span><br><span class="line">* About to connect() to bookinfo.com port 30885 (#0)</span><br><span class="line">*   Trying 192.168.48.37...</span><br><span class="line">* Connected to bookinfo.com (192.168.48.37) port 30885 (#0)</span><br><span class="line">* Initializing NSS with certpath: sql:/etc/pki/nssdb</span><br><span class="line">*   CAfile: example.com.crt</span><br><span class="line">  CApath: none</span><br><span class="line">* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">* Server certificate:</span><br><span class="line">* subject: O=bookinfo organization,CN=bookinfo.com</span><br><span class="line">* start date: Dec 30 07:13:53 2019 GMT</span><br><span class="line">* expire date: Dec 29 07:13:53 2020 GMT</span><br><span class="line">* common name: bookinfo.com</span><br><span class="line">* issuer: CN=example.com,O=example Inc.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GET /productpage HTTP/1.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Accept: */*</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Host:bookinfo.com</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; content-type: text/html; charset=utf-8</span><br><span class="line">&lt; content-length: 3889</span><br><span class="line">&lt; server: istio-envoy</span><br><span class="line">&lt; date: Mon, 30 Dec 2019 07:25:10 GMT</span><br><span class="line">&lt; x-envoy-upstream-service-time: 1015</span><br><span class="line">&lt; </span><br><span class="line">&#123; [data not shown]</span><br><span class="line">* Connection #0 to host bookinfo.com left intact</span><br><span class="line">200</span><br></pre></td></tr></table></figure><h5 id="httpbin"><a href="#httpbin" class="headerlink" title="httpbin"></a>httpbin</h5><blockquote><p>httpbin服务依然能正常访问</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -H 'Host:httpbin.example.com' \</span><br><span class="line">     --resolve httpbin.example.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \</span><br><span class="line">     --cacert example.com.crt \</span><br><span class="line">     --cert httpbin-client.example.com.crt \</span><br><span class="line">     --key httpbin-client.example.com.key \</span><br><span class="line">     https://httpbin.example.com:$SECURE_INGRESS_PORT/status/418</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-=[ teapot ]=-</span><br><span class="line"></span><br><span class="line">   _...._</span><br><span class="line"> .'  _ _ `.</span><br><span class="line">| ."` ^ `". _,</span><br><span class="line">\_;`"---"`|//</span><br><span class="line">  |       ;/</span><br><span class="line">  \_     _/</span><br><span class="line">    `"""`</span><br></pre></td></tr></table></figure><h4 id="清理现场"><a href="#清理现场" class="headerlink" title="清理现场"></a>清理现场</h4><h5 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h5><p><font color="red">请按需清理！</font>后面做SSL/TLS实验还会用到！</p><h5 id="清理istio资源对象"><a href="#清理istio资源对象" class="headerlink" title="清理istio资源对象"></a>清理istio资源对象</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete gateway --ignore-not-found=true httpbin-gateway bookinfo-gateway</span><br><span class="line">kubectl delete virtualservice httpbin</span><br><span class="line">kubectl delete --ignore-not-found=true virtualservice bookinfo</span><br></pre></td></tr></table></figure><h5 id="清理证书"><a href="#清理证书" class="headerlink" title="清理证书"></a>清理证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -rf example.com.crt example.com.key</span><br><span class="line">rm -rf bookinfo.com.crt bookinfo.com.csr bookinfo.com.key</span><br><span class="line">rm -rf httpbin.example.com.crt httpbin.example.com.csr httpbin.example.com.key</span><br></pre></td></tr></table></figure><h5 id="清理Patch文件"><a href="#清理Patch文件" class="headerlink" title="清理Patch文件"></a>清理Patch文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf gateway-patch.json</span><br></pre></td></tr></table></figure><h5 id="清理httpbin服务"><a href="#清理httpbin服务" class="headerlink" title="清理httpbin服务"></a>清理httpbin服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete --ignore-not-found=true -f samples/httpbin/httpbin.yaml</span><br></pre></td></tr></table></figure><h2 id="基于SSL-TLS的Ingress-SDS密钥发现服务"><a href="#基于SSL-TLS的Ingress-SDS密钥发现服务" class="headerlink" title="基于SSL/TLS的Ingress(SDS密钥发现服务)"></a>基于SSL/TLS的Ingress(SDS密钥发现服务)</h2><h3 id="说明-4"><a href="#说明-4" class="headerlink" title="说明"></a>说明</h3><ul><li><p>通过<code>Secret Discovery Service</code>可以监视<code>TLS Credential</code>的生成</p></li><li><p><code>IngressGateway</code>可以动态增删改查证书，而不是通过Patch的方式重新部署<code>IngressGateway</code></p></li><li><p>不需要配置<code>IngressGateway</code>挂载<code>Secret</code>卷</p></li><li><p><code>IngressGateway</code>可以监控多个密钥对，因此只需要更新<code>Gateway</code>定义即可</p></li><li><p><code>Demo</code>默认不开启<code>SDS</code>功能，需要通过istioctl重新配置istio，配置如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--set values.gateways.istio-egressgateway.enabled=false</span><br><span class="line">--set values.gateways.istio-ingressgateway.sds.enabled=true</span><br></pre></td></tr></table></figure></li></ul><h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="Istio特性部署要求"><a href="#Istio特性部署要求" class="headerlink" title="Istio特性部署要求"></a>Istio特性部署要求</h4><ul><li>启用SDS功能</li></ul><h4 id="Istio部署参数"><a href="#Istio部署参数" class="headerlink" title="Istio部署参数"></a>Istio部署参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest apply \</span><br><span class="line">         --set values.gateways.istio-egressgateway.enabled=false \</span><br><span class="line">         --set values.gateways.istio-ingressgateway.sds.enabled=true</span><br></pre></td></tr></table></figure><p><strong>为了方便测试，这里额外添加了部署参数</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest apply \</span><br><span class="line">    --set profile='demo' \</span><br><span class="line">    --set cni.enabled=true \</span><br><span class="line">    --set cni.components.cni.namespace='kube-system' \</span><br><span class="line">    --set hub='dockerhub.azk8s.cn/istio' \</span><br><span class="line">    --set values.gateways.istio-ingressgateway.type='NodePort' \</span><br><span class="line">    --set values.gateways.istio-egressgateway.enabled=false \</span><br><span class="line">    --set values.gateways.istio-ingressgateway.sds.enabled=true \</span><br><span class="line">    --set values.global.controlPlaneSecurityEnabled=true \</span><br><span class="line">    --set values.global.mtls.enabled=false</span><br></pre></td></tr></table></figure><h4 id="获取Ingress环境变量"><a href="#获取Ingress环境变量" class="headerlink" title="获取Ingress环境变量"></a>获取Ingress环境变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='&#123;.items[0].status.hostIP&#125;')</span><br><span class="line">export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http2")].nodePort&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].nodePort&#125;')</span><br></pre></td></tr></table></figure><h3 id="部署httpbin"><a href="#部署httpbin" class="headerlink" title="部署httpbin"></a>部署httpbin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/httpbin/httpbin.yaml</span><br></pre></td></tr></table></figure><h3 id="创建Secret-2"><a href="#创建Secret-2" class="headerlink" title="创建Secret"></a>创建Secret</h3><h4 id="说明-5"><a href="#说明-5" class="headerlink" title="说明"></a>说明</h4><ul><li>Secret对象的名字不能以<code>istio</code>或者<code>prometheus</code>开头</li><li>Secret对象不能包含<code>token</code>字段</li></ul><h4 id="已有证书-1"><a href="#已有证书-1" class="headerlink" title="已有证书"></a>已有证书</h4><p>如果购买了公网的可信任证书，可以跳过自建证书的步骤。</p><h4 id="自建证书-1"><a href="#自建证书-1" class="headerlink" title="自建证书"></a>自建证书</h4><h5 id="创建CA证书-1"><a href="#创建CA证书-1" class="headerlink" title="创建CA证书"></a>创建CA证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 \</span><br><span class="line">            -sha256 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -days 365 \</span><br><span class="line">            -newkey rsa:2048 \</span><br><span class="line">            -subj '/O=example Inc./CN=example.com' \</span><br><span class="line">            -keyout example.com.key \</span><br><span class="line">            -out example.com.crt</span><br></pre></td></tr></table></figure><h5 id="创建证书-2"><a href="#创建证书-2" class="headerlink" title="创建证书"></a>创建证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">openssl req -out \</span><br><span class="line">            httpbin.example.com.csr \</span><br><span class="line">            -newkey rsa:2048 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -keyout httpbin.example.com.key \</span><br><span class="line">            -subj "/CN=httpbin.example.com/O=httpbin organization"</span><br><span class="line">openssl x509 -req \</span><br><span class="line">             -days 365 \</span><br><span class="line">             -CA example.com.crt \</span><br><span class="line">             -CAkey example.com.key \</span><br><span class="line">             -set_serial 0 \</span><br><span class="line">             -in httpbin.example.com.csr \</span><br><span class="line">             -out httpbin.example.com.crt</span><br></pre></td></tr></table></figure><h5 id="创建Secret-3"><a href="#创建Secret-3" class="headerlink" title="创建Secret"></a>创建Secret</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n istio-system \</span><br><span class="line">        create \</span><br><span class="line">        secret \</span><br><span class="line">        generic \</span><br><span class="line">        httpbin-credential \</span><br><span class="line">        --from-file=key=httpbin.example.com.key \</span><br><span class="line">        --from-file=cert=httpbin.example.com.crt</span><br></pre></td></tr></table></figure><h3 id="使用Gateway配置Ingress-1"><a href="#使用Gateway配置Ingress-1" class="headerlink" title="使用Gateway配置Ingress"></a>使用Gateway配置Ingress</h3><h4 id="创建Gateway-2"><a href="#创建Gateway-2" class="headerlink" title="创建Gateway"></a>创建Gateway</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: sds-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    istio: ingressgateway # use istio default ingress gateway</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 443</span><br><span class="line">      name: https</span><br><span class="line">      protocol: HTTPS</span><br><span class="line">    tls:</span><br><span class="line">      mode: SIMPLE</span><br><span class="line">      credentialName: "httpbin-credential" # must be the same as secret</span><br><span class="line">    hosts:</span><br><span class="line">    - "httpbin.example.com"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建VirtualService-2"><a href="#创建VirtualService-2" class="headerlink" title="创建VirtualService"></a>创建VirtualService</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - "httpbin.example.com"</span><br><span class="line">  gateways:</span><br><span class="line">  - sds-gateway</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /status</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /delay</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        port:</span><br><span class="line">          number: 8000</span><br><span class="line">        host: httpbin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="访问HTTPS服务-1"><a href="#访问HTTPS服务-1" class="headerlink" title="访问HTTPS服务"></a>访问HTTPS服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -v \</span><br><span class="line">     -H 'Host:httpbin.example.com' \</span><br><span class="line">     --resolve httpbin.example.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \</span><br><span class="line">     --cacert example.com.crt \</span><br><span class="line">     https://httpbin.example.com:$SECURE_INGRESS_PORT/status/418</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">* Added httpbin.example.com:31944:192.168.48.37 to DNS cache</span><br><span class="line">* About to connect() to httpbin.example.com port 31944 (#0)</span><br><span class="line">*   Trying 192.168.48.37...</span><br><span class="line">* Connected to httpbin.example.com (192.168.48.37) port 31944 (#0)</span><br><span class="line">* Initializing NSS with certpath: sql:/etc/pki/nssdb</span><br><span class="line">*   CAfile: example.com.crt</span><br><span class="line">  CApath: none</span><br><span class="line">* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">* Server certificate:</span><br><span class="line">* subject: O=httpbin organization,CN=httpbin.example.com</span><br><span class="line">* start date: Dec 30 06:53:12 2019 GMT</span><br><span class="line">* expire date: Dec 29 06:53:12 2020 GMT</span><br><span class="line">* common name: httpbin.example.com</span><br><span class="line">* issuer: CN=example.com,O=example Inc.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GET /status/418 HTTP/1.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Accept: */*</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Host:httpbin.example.com</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line">&lt; HTTP/1.1 418 Unknown</span><br><span class="line">&lt; server: istio-envoy</span><br><span class="line">&lt; date: Mon, 30 Dec 2019 08:53:33 GMT</span><br><span class="line">&lt; x-more-info: http://tools.ietf.org/html/rfc2324</span><br><span class="line">&lt; access-control-allow-origin: *</span><br><span class="line">&lt; access-control-allow-credentials: true</span><br><span class="line">&lt; content-length: 135</span><br><span class="line">&lt; x-envoy-upstream-service-time: 1</span><br><span class="line">&lt; </span><br><span class="line"></span><br><span class="line">    -=[ teapot ]=-</span><br><span class="line"></span><br><span class="line">       _...._</span><br><span class="line">     .'  _ _ `.</span><br><span class="line">    | ."` ^ `". _,</span><br><span class="line">    \_;`"---"`|//</span><br><span class="line">      |       ;/</span><br><span class="line">      \_     _/</span><br><span class="line">        `"""`</span><br></pre></td></tr></table></figure><h3 id="配置多Host的TLS-Ingress-1"><a href="#配置多Host的TLS-Ingress-1" class="headerlink" title="配置多Host的TLS Ingress"></a>配置多Host的TLS Ingress</h3><h4 id="创建TLS类型的Secret-2"><a href="#创建TLS类型的Secret-2" class="headerlink" title="创建TLS类型的Secret"></a>创建TLS类型的Secret</h4><blockquote><p>这里以bookinfo.com作为示例</p></blockquote><h5 id="创建证书-3"><a href="#创建证书-3" class="headerlink" title="创建证书"></a>创建证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">openssl req \</span><br><span class="line">        -out bookinfo.com.csr \</span><br><span class="line">        -newkey rsa:2048 \</span><br><span class="line">        -nodes \</span><br><span class="line">        -keyout bookinfo.com.key \</span><br><span class="line">        -subj "/CN=bookinfo.com/O=bookinfo organization"</span><br><span class="line">openssl x509 -req \</span><br><span class="line">        -days 365 \</span><br><span class="line">        -CA example.com.crt \</span><br><span class="line">        -CAkey example.com.key \</span><br><span class="line">        -set_serial 0 \</span><br><span class="line">        -in bookinfo.com.csr \</span><br><span class="line">        -out bookinfo.com.crt</span><br></pre></td></tr></table></figure><h5 id="创建Secret-4"><a href="#创建Secret-4" class="headerlink" title="创建Secret"></a>创建Secret</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n istio-system \</span><br><span class="line">        create \</span><br><span class="line">        secret \</span><br><span class="line">        generic \</span><br><span class="line">        bookinfo-credential \</span><br><span class="line">        --from-file=key=bookinfo.com.key \</span><br><span class="line">        --from-file=cert=bookinfo.com.crt</span><br></pre></td></tr></table></figure><h4 id="配置Gateway"><a href="#配置Gateway" class="headerlink" title="配置Gateway"></a>配置Gateway</h4><blockquote><p>添加bookinfo的host</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: sds-gateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    istio: ingressgateway # use istio default ingress gateway</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 443</span><br><span class="line">      name: https-httpbin</span><br><span class="line">      protocol: HTTPS</span><br><span class="line">    tls:</span><br><span class="line">      mode: SIMPLE</span><br><span class="line">      credentialName: "httpbin-credential"</span><br><span class="line">    hosts:</span><br><span class="line">    - "httpbin.example.com"</span><br><span class="line">  - port:</span><br><span class="line">      number: 443</span><br><span class="line">      name: https-bookinfo</span><br><span class="line">      protocol: HTTPS</span><br><span class="line">    tls:</span><br><span class="line">      mode: SIMPLE</span><br><span class="line">      credentialName: "bookinfo-credential"</span><br><span class="line">    hosts:</span><br><span class="line">    - "bookinfo.com"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="配置VirtualService"><a href="#配置VirtualService" class="headerlink" title="配置VirtualService"></a>配置VirtualService</h4><blockquote><p>配置bookinfo的VirtualService</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - "bookinfo.com"</span><br><span class="line">  gateways:</span><br><span class="line">  - sds-gateway</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /productpage</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /login</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /logout</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /api/v1/products</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: productpage</span><br><span class="line">        port:</span><br><span class="line">          number: 9080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="访问HTTPS服务-2"><a href="#访问HTTPS服务-2" class="headerlink" title="访问HTTPS服务"></a>访问HTTPS服务</h4><h5 id="bookinfo-1"><a href="#bookinfo-1" class="headerlink" title="bookinfo"></a>bookinfo</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -o /dev/null \</span><br><span class="line">     -s \</span><br><span class="line">     -v \</span><br><span class="line">     -w "%&#123;http_code&#125;\n" \</span><br><span class="line">     -H 'Host:bookinfo.com' \</span><br><span class="line">     --resolve bookinfo.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \</span><br><span class="line">     --cacert example.com.crt \</span><br><span class="line">     https://bookinfo.com:$SECURE_INGRESS_PORT/productpage</span><br></pre></td></tr></table></figure><h5 id="httpbin-1"><a href="#httpbin-1" class="headerlink" title="httpbin"></a>httpbin</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -H 'Host:httpbin.example.com' \</span><br><span class="line">     --resolve httpbin.example.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \</span><br><span class="line">     --cacert example.com.crt \</span><br><span class="line">     --cert httpbin-client.example.com.crt \</span><br><span class="line">     --key httpbin-client.example.com.key \</span><br><span class="line">     https://httpbin.example.com:$SECURE_INGRESS_PORT/status/418</span><br></pre></td></tr></table></figure><h3 id="清理现场-1"><a href="#清理现场-1" class="headerlink" title="清理现场"></a>清理现场</h3><h4 id="清理istio资源对象-1"><a href="#清理istio资源对象-1" class="headerlink" title="清理istio资源对象"></a>清理istio资源对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete sds-gateway mygateway</span><br><span class="line">kubectl delete virtualservice httpbin bookinfo</span><br><span class="line">kubectl delete --ignore-not-found=true -n istio-system secret httpbin-credential \</span><br><span class="line">bookinfo-credential</span><br><span class="line">kubectl delete --ignore-not-found=true virtualservice bookinfo httpbin</span><br></pre></td></tr></table></figure><h4 id="清理证书-1"><a href="#清理证书-1" class="headerlink" title="清理证书"></a>清理证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf httpbin.example.com.crt httpbin.example.com.csr httpbin.example.com.key</span><br><span class="line">rm -rf bookinfo.com.crt bookinfo.com.csr bookinfo.com.key</span><br></pre></td></tr></table></figure><h4 id="清理Kubernetes资源对象"><a href="#清理Kubernetes资源对象" class="headerlink" title="清理Kubernetes资源对象"></a>清理Kubernetes资源对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete service --ignore-not-found=true bookinfo</span><br><span class="line">kubectl delete service --ignore-not-found=true httpbin</span><br></pre></td></tr></table></figure><h2 id="Ingress-Gateway-without-TLS-Termination"><a href="#Ingress-Gateway-without-TLS-Termination" class="headerlink" title="Ingress Gateway without TLS Termination"></a>Ingress Gateway without TLS Termination</h2><h3 id="说明-6"><a href="#说明-6" class="headerlink" title="说明"></a>说明</h3><ul><li>这个TLS Termination不知道怎么翻译，简单的说就是Gateway不处理TLS/HTTPS，直接透传后端的TLS</li><li>这里简单部署一个提供HTTPS的Nginx服务作为实验样例</li></ul><h3 id="环境准备-2"><a href="#环境准备-2" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="创建证书-4"><a href="#创建证书-4" class="headerlink" title="创建证书"></a>创建证书</h4><blockquote><p>沿用上面的证书生成方式</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">openssl req \</span><br><span class="line">        -out nginx.example.com.csr \</span><br><span class="line">        -newkey rsa:2048 \</span><br><span class="line">        -nodes \</span><br><span class="line">        -keyout nginx.example.com.key \</span><br><span class="line">        -subj "/CN=nginx.example.com/O=Nginx organization"</span><br><span class="line">openssl x509 -req \</span><br><span class="line">        -days 365 \</span><br><span class="line">        -CA example.com.crt \</span><br><span class="line">        -CAkey example.com.key \</span><br><span class="line">        -set_serial 0 \</span><br><span class="line">        -in nginx.example.com.csr \</span><br><span class="line">        -out nginx.example.com.crt</span><br></pre></td></tr></table></figure><h4 id="创建Secret-5"><a href="#创建Secret-5" class="headerlink" title="创建Secret"></a>创建Secret</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl create \</span><br><span class="line">        secret \</span><br><span class="line">        tls \</span><br><span class="line">        nginx-server-certs \</span><br><span class="line">        --key nginx.example.com.key \</span><br><span class="line">        --cert nginx.example.com.crt</span><br></pre></td></tr></table></figure><h4 id="创建Nginx配置"><a href="#创建Nginx配置" class="headerlink" title="创建Nginx配置"></a>创建Nginx配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>]  <span class="variable">$status</span> '</span></span><br><span class="line">  <span class="string">'"<span class="variable">$request</span>" <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">  <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line">  <span class="attribute">access_log</span> /var/log/nginx/access.log main;</span><br><span class="line">  <span class="attribute">error_log</span>  /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> nginx.example.com;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx-server-certs/tls.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx-server-certs/tls.key;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="创建ConfigMap"><a href="#创建ConfigMap" class="headerlink" title="创建ConfigMap"></a>创建ConfigMap</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap nginx-configmap --from-file=nginx.conf=./nginx.conf</span><br></pre></td></tr></table></figure><h4 id="部署Nginx"><a href="#部署Nginx" class="headerlink" title="部署Nginx"></a>部署Nginx</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | istioctl kube-inject -f - | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-nginx</span><br><span class="line">  labels:</span><br><span class="line">    run: my-nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    run: my-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: my-nginx</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: my-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 443</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: nginx-config</span><br><span class="line">          mountPath: /etc/nginx</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: nginx-server-certs</span><br><span class="line">          mountPath: /etc/nginx-server-certs</span><br><span class="line">          readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">      - name: nginx-config</span><br><span class="line">        configMap:</span><br><span class="line">          name: nginx-configmap</span><br><span class="line">      - name: nginx-server-certs</span><br><span class="line">        secret:</span><br><span class="line">          secretName: nginx-server-certs</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="测试Nginx服务"><a href="#测试Nginx服务" class="headerlink" title="测试Nginx服务"></a>测试Nginx服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NGINX_POD=$(kubectl get pod  -l run=my-nginx -o jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line">kubectl exec -it $NGINX_POD -c istio-proxy \</span><br><span class="line">        -- \</span><br><span class="line">        curl -I -k \</span><br><span class="line">        --resolve nginx.example.com:443:127.0.0.1 \</span><br><span class="line">        https://nginx.example.com</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.17.6</span><br><span class="line">Date: Mon, 30 Dec 2019 14:26:15 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 19 Nov 2019 12:50:08 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: "5dd3e500-264"</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h3 id="使用Gateway配置Ingress-2"><a href="#使用Gateway配置Ingress-2" class="headerlink" title="使用Gateway配置Ingress"></a>使用Gateway配置Ingress</h3><h4 id="配置Gateway-1"><a href="#配置Gateway-1" class="headerlink" title="配置Gateway"></a>配置Gateway</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: mygateway</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    istio: ingressgateway # use istio default ingress gateway</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 443</span><br><span class="line">      name: https</span><br><span class="line">      protocol: HTTPS</span><br><span class="line">    tls:</span><br><span class="line">      mode: PASSTHROUGH</span><br><span class="line">    hosts:</span><br><span class="line">    - nginx.example.com</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="配置VirtualService-1"><a href="#配置VirtualService-1" class="headerlink" title="配置VirtualService"></a>配置VirtualService</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - nginx.example.com</span><br><span class="line">  gateways:</span><br><span class="line">  - mygateway</span><br><span class="line">  tls:</span><br><span class="line">  - match:</span><br><span class="line">    - port: 443</span><br><span class="line">      sni_hosts:</span><br><span class="line">      - nginx.example.com</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: my-nginx</span><br><span class="line">        port:</span><br><span class="line">          number: 443</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="测试TLS直通"><a href="#测试TLS直通" class="headerlink" title="测试TLS直通"></a>测试TLS直通</h3><blockquote><p>从集群外部访问Nginx服务</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -v \</span><br><span class="line">     --resolve nginx.example.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \</span><br><span class="line">     --cacert example.com.crt \</span><br><span class="line">     https://nginx.example.com:$SECURE_INGRESS_PORT</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p><p>这里可以看到证书信息是<code>nginx.example.com</code>，并且证书能顺利通过验证</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">* Added nginx.example.com:31944:192.168.48.37 to DNS cache</span><br><span class="line">* About to connect() to nginx.example.com port 31944 (#0)</span><br><span class="line">*   Trying 192.168.48.37...</span><br><span class="line">* Connected to nginx.example.com (192.168.48.37) port 31944 (#0)</span><br><span class="line">* Initializing NSS with certpath: sql:/etc/pki/nssdb</span><br><span class="line">*   CAfile: example.com.crt</span><br><span class="line">  CApath: none</span><br><span class="line">* SSL connection using TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">* Server certificate:</span><br><span class="line">* subject: O=Nginx organization,CN=nginx.example.com</span><br><span class="line">* start date: Dec 30 13:55:24 2019 GMT</span><br><span class="line">* expire date: Dec 29 13:55:24 2020 GMT</span><br><span class="line">* common name: nginx.example.com</span><br><span class="line">* issuer: CN=example.com,O=example Inc.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GET / HTTP/1.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Host: nginx.example.com:31944</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Accept: */*</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Server: nginx/1.17.6</span><br><span class="line">&lt; Date: Mon, 30 Dec 2019 14:30:45 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 612</span><br><span class="line">&lt; Last-Modified: Tue, 19 Nov 2019 12:50:08 GMT</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; ETag: "5dd3e500-264"</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt; </span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="清理现场-2"><a href="#清理现场-2" class="headerlink" title="清理现场"></a>清理现场</h3><h4 id="清理Kubernetes资源对象-1"><a href="#清理Kubernetes资源对象-1" class="headerlink" title="清理Kubernetes资源对象"></a>清理Kubernetes资源对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete secret nginx-server-certs</span><br><span class="line">kubectl delete configmap nginx-configmap</span><br><span class="line">kubectl delete service my-nginx</span><br><span class="line">kubectl delete deployment my-nginx</span><br><span class="line">kubectl delete gateway mygateway</span><br><span class="line">kubectl delete virtualservice nginx</span><br></pre></td></tr></table></figure><h4 id="清理证书和配置文件"><a href="#清理证书和配置文件" class="headerlink" title="清理证书和配置文件"></a>清理证书和配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf nginx.conf nginx.example.com.crt nginx.example.com.csr nginx.example.com.key</span><br></pre></td></tr></table></figure><h2 id="Ingress-With-Cert-Manager"><a href="#Ingress-With-Cert-Manager" class="headerlink" title="Ingress With Cert-Manager"></a>Ingress With Cert-Manager</h2><h3 id="暂时没这块需求就不弄了"><a href="#暂时没这块需求就不弄了" class="headerlink" title="[暂时没这块需求就不弄了]"></a>[暂时没这块需求就不弄了]</h3><h3 id="说明-7"><a href="#说明-7" class="headerlink" title="说明"></a>说明</h3><ul><li><code>Cert-Manager</code>是一个社区项目，这里是<a href="https://docs.cert-manager.io/" target="_blank" rel="noopener">文档</a></li><li>项目状态是<code>pre-1.0</code>，还没GA，API可能还会变更，所以谨慎使用！</li><li>可以通过这个项目申请<code>Let&#39;s Encrypt</code>证书</li><li>自动管理和颁发证书</li><li>定期更新轮换证书</li></ul><h3 id="环境准备-3"><a href="#环境准备-3" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="Istio特性部署要求-1"><a href="#Istio特性部署要求-1" class="headerlink" title="Istio特性部署要求"></a>Istio特性部署要求</h4><ul><li>SDS(Secrect Discovery Service)</li><li>Ingress</li></ul><h4 id="Istio部署参数-1"><a href="#Istio部署参数-1" class="headerlink" title="Istio部署参数"></a>Istio部署参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest apply \</span><br><span class="line">  --set values.gateways.istio-ingressgateway.sds.enabled=true \</span><br><span class="line">  --set values.global.k8sIngress.enabled=true \</span><br><span class="line">  --set values.global.k8sIngress.enableHttps=true \</span><br><span class="line">  --set values.global.k8sIngress.gatewayName=ingressgateway</span><br></pre></td></tr></table></figure><p><strong>为了测试方便，这里额外添加参数</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest apply \</span><br><span class="line">    --set profile='demo' \</span><br><span class="line">    --set cni.enabled=true \</span><br><span class="line">    --set cni.components.cni.namespace='kube-system' \</span><br><span class="line">    --set hub='dockerhub.azk8s.cn/istio' \</span><br><span class="line">    --set values.gateways.istio-ingressgateway.type='NodePort' \</span><br><span class="line">    --set values.gateways.istio-egressgateway.enabled=false \</span><br><span class="line">    --set values.gateways.istio-ingressgateway.sds.enabled=true \</span><br><span class="line">    --set values.global.controlPlaneSecurityEnabled=true \</span><br><span class="line">    --set values.global.k8sIngress.enabled=true \</span><br><span class="line">    --set values.global.k8sIngress.enableHttps=true \</span><br><span class="line">    --set values.global.k8sIngress.gatewayName=ingressgateway \</span><br><span class="line">    --set values.global.mtls.enabled=false</span><br></pre></td></tr></table></figure><h4 id="部署Cert-Manager"><a href="#部署Cert-Manager" class="headerlink" title="部署Cert-Manager"></a>部署Cert-Manager</h4><blockquote><p>参考这里的<a href="https://cert-manager.io/docs/installation/kubernetes/" target="_blank" rel="noopener">Cert-Manager安装部署文档</a></p></blockquote><h5 id="创建命名空间"><a href="#创建命名空间" class="headerlink" title="创建命名空间"></a>创建命名空间</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace cert-manager</span><br></pre></td></tr></table></figure><h5 id="部署CRD和Cert-Manager"><a href="#部署CRD和Cert-Manager" class="headerlink" title="部署CRD和Cert-Manager"></a>部署CRD和Cert-Manager</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v0.12.0/cert-manager.yaml</span><br></pre></td></tr></table></figure><h5 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --namespace cert-manager</span><br></pre></td></tr></table></figure><h1 id="Egress"><a href="#Egress" class="headerlink" title="Egress"></a>Egress</h1><h3 id="暂时没这块需求就不弄了-1"><a href="#暂时没这块需求就不弄了-1" class="headerlink" title="[暂时没这块需求就不弄了]"></a>[暂时没这块需求就不弄了]</h3><h2 id="说明-8"><a href="#说明-8" class="headerlink" title="说明"></a>说明</h2><ul><li>Egress是用来管控Istio服务网格的出口流量</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;istio版本号&lt;code&gt;1.4.2&lt;/code&gt;&lt;/li&gt;&lt;li&gt;k8s集群版本&lt;code&gt;v1.14.8&lt;/code&gt;&lt;/l
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
      <category term="Istio" scheme="https://luanlengli.github.io/categories/Kubernetes/Istio/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="Istio" scheme="https://luanlengli.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>从零搭建基于Istio的ServiceMesh-01快速部署</title>
    <link href="https://luanlengli.github.io/2019/12/17/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8EIstio%E7%9A%84ServiceMesh-01%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2.html"/>
    <id>https://luanlengli.github.io/2019/12/17/从零搭建基于Istio的ServiceMesh-01快速部署.html</id>
    <published>2019-12-17T07:16:33.000Z</published>
    <updated>2020-01-13T07:05:58.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>istio版本号<code>1.4.2</code></li><li>k8s集群版本<code>v1.14.8</code></li><li>istio在<code>1.4</code>提供了基于istioctl命令直接部署的功能，这里使用istioctl部署istio。<ul><li>自带配置校验、和丰富的自定义配置选项</li><li>API版本号还在<font color="red">Alpha阶段</font>，<code>install.istio.io/v1alpha2</code>，请自行判断是否适用</li><li>部署要求<ul><li>至少得有Kubernetes集群</li><li>Istio-1.4版本在<code>1.13</code>、<code>1.14</code>、<code>1.15</code>的k8s集群上是做过测试通过的</li><li>最新的<code>1.16</code>没在官方文档里注明，应该也是可以用的。<a href="https://istio.io/docs/setup/platform-setup/" target="_blank" rel="noopener">官方说明在此</a></li></ul></li></ul></li><li>这里通过官方示例熟悉一下istio的ServiceMesh特性</li></ul><h1 id="下载Istio项目文件"><a href="#下载Istio项目文件" class="headerlink" title="下载Istio项目文件"></a>下载Istio项目文件</h1><h2 id="在Github上下载"><a href="#在Github上下载" class="headerlink" title="在Github上下载"></a>在Github上下载</h2><p>在Github项目地址可以在<a href="https://github.com/istio/istio/releases" target="_blank" rel="noopener">release页面</a>找到对应版本的部署文件下载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://github.com/istio/istio/releases/download/1.4.2/istio-1.4.2-linux.tar.gz | tar xz</span><br></pre></td></tr></table></figure><h2 id="通过Shell脚本安装"><a href="#通过Shell脚本安装" class="headerlink" title="通过Shell脚本安装"></a>通过Shell脚本安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://istio.io/downloadIstio | sh -</span><br></pre></td></tr></table></figure><h2 id="切换工作目录"><a href="#切换工作目录" class="headerlink" title="切换工作目录"></a>切换工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd istio-1.4.2</span><br></pre></td></tr></table></figure><h2 id="目录内容"><a href="#目录内容" class="headerlink" title="目录内容"></a>目录内容</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tree ~/istio-1.4.2 -L 1</span><br><span class="line">./istio-1.4.2</span><br><span class="line">├── bin</span><br><span class="line">├── install</span><br><span class="line">├── LICENSE</span><br><span class="line">├── manifest.yaml</span><br><span class="line">├── README.md</span><br><span class="line">├── samples</span><br><span class="line">└── tools</span><br></pre></td></tr></table></figure><p>项目目录：</p><ul><li><code>install/kubernetes</code>包含了部署在Kubernetes集群的YAML文件</li><li><code>samples</code>包含了测试样例</li><li><code>bin</code>包含了<code>istioctl</code>二进制文件</li><li><code>tools</code>包含了命令补全和一些其他用途的脚本</li></ul><h2 id="拷贝二进制文件"><a href="#拷贝二进制文件" class="headerlink" title="拷贝二进制文件"></a>拷贝二进制文件</h2><blockquote><p>这里把<code>istioctl</code>拷贝到<code>/usr/local/bin</code>目录</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp bin/istioctl /usr/local/bin/</span><br></pre></td></tr></table></figure><h2 id="设置命令补全"><a href="#设置命令补全" class="headerlink" title="设置命令补全"></a>设置命令补全</h2><ul><li>支持bash和zsh的命令补全，官方文档在<a href="https://istio.io/docs/ops/diagnostic-tools/istioctl/#enabling-auto-completion" target="_blank" rel="noopener">这里</a></li><li>这里只做bash的</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp tools/istioctl.bash /etc/bash_completion.d/istioctl</span><br><span class="line">source /etc/bash_completion.d/istioctl</span><br></pre></td></tr></table></figure><h1 id="部署istio"><a href="#部署istio" class="headerlink" title="部署istio"></a>部署istio</h1><p><code>istioctl</code>提供了内建的多个<code>profile</code>用于部署<code>istio</code></p><h2 id="查看内建的profile"><a href="#查看内建的profile" class="headerlink" title="查看内建的profile"></a>查看内建的profile</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl profile list</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Istio configuration profiles:</span><br><span class="line">    minimal</span><br><span class="line">    remote</span><br><span class="line">    sds</span><br><span class="line">    default</span><br><span class="line">    demo</span><br></pre></td></tr></table></figure><h2 id="查看Profile的默认值"><a href="#查看Profile的默认值" class="headerlink" title="查看Profile的默认值"></a>查看Profile的默认值</h2><p>Profile对应的YAML文件存放在<code>install/kubernetes/operator/profiles</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">install/kubernetes/operator/profiles</span><br><span class="line">├── default.yaml</span><br><span class="line">├── demo.yaml</span><br><span class="line">├── minimal.yaml</span><br><span class="line">├── remote.yaml</span><br><span class="line">└── sds.yaml</span><br></pre></td></tr></table></figure><h2 id="Profile之间的区别"><a href="#Profile之间的区别" class="headerlink" title="Profile之间的区别"></a>Profile之间的区别</h2><blockquote><p>这里直接照搬了官方文档的说明</p></blockquote><ol><li><p><strong>default</strong>: enables components according to the default settings of the <a href="https://istio.io/docs/reference/config/istio.operator.v1alpha12.pb/" target="_blank" rel="noopener"><code>IstioControlPlane</code> API</a> (recommend for production deployments). You can display the default setting by running the command <code>istioctl profile dump</code>.</p></li><li><p><strong>demo</strong>: configuration designed to showcase Istio functionality with modest resource requirements. It is suitable to run the <a href="https://istio.io/docs/examples/bookinfo/" target="_blank" rel="noopener">Bookinfo</a> application and associated tasks. This is the configuration that is installed with the <a href="https://istio.io/docs/setup/getting-started/" target="_blank" rel="noopener">quick start</a> instructions, but you can later <a href="https://istio.io/docs/setup/install/istioctl/#customizing-the-configuration" target="_blank" rel="noopener">customize the configuration</a> to enable additional features if you wish to explore more advanced tasks.</p><blockquote><p>This profile enables high levels of tracing and access logging so it is not suitable for performance tests.</p></blockquote></li><li><p><strong>minimal</strong>: the minimal set of components necessary to use Istio’s <a href="https://istio.io/docs/tasks/traffic-management/" target="_blank" rel="noopener">traffic management</a> features.</p></li><li><p><strong>sds</strong>: similar to the <strong>default</strong> profile, but also enables Istio’s <a href="https://istio.io/docs/tasks/security/citadel-config/auth-sds" target="_blank" rel="noopener">SDS (secret discovery service)</a>. This profile comes with additional authentication features enabled by default (Strict Mutual TLS).</p></li><li><p><strong>remote</strong>: used for configuring remote clusters of a <a href="https://istio.io/docs/ops/deployment/deployment-models/#multiple-clusters" target="_blank" rel="noopener">multicluster mesh</a> with a <a href="https://istio.io/docs/setup/install/multicluster/shared-vpn/" target="_blank" rel="noopener">shared control plane</a> configuration.</p></li></ol><table><thead><tr><th></th><th>default</th><th>demo</th><th>minimal</th><th>sds</th><th>remote</th></tr></thead><tbody><tr><td>Core components</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>istio-citadel</code></td><td>X</td><td>X</td><td></td><td>X</td><td>X</td></tr><tr><td><code>istio-egressgateway</code></td><td></td><td>X</td><td></td><td></td><td></td></tr><tr><td><code>istio-galley</code></td><td>X</td><td>X</td><td></td><td>X</td><td></td></tr><tr><td><code>istio-ingressgateway</code></td><td>X</td><td>X</td><td></td><td>X</td><td></td></tr><tr><td><code>istio-nodeagent</code></td><td></td><td></td><td></td><td>X</td><td></td></tr><tr><td><code>istio-pilot</code></td><td>X</td><td>X</td><td>X</td><td>X</td><td></td></tr><tr><td><code>istio-policy</code></td><td>X</td><td>X</td><td></td><td>X</td><td></td></tr><tr><td><code>istio-sidecar-injector</code></td><td>X</td><td>X</td><td></td><td>X</td><td>X</td></tr><tr><td><code>istio-telemetry</code></td><td>X</td><td>X</td><td></td><td>X</td><td></td></tr><tr><td>Addons</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>grafana</code></td><td></td><td>X</td><td></td><td></td><td></td></tr><tr><td><code>istio-tracing</code></td><td></td><td>X</td><td></td><td></td><td></td></tr><tr><td><code>kiali</code></td><td></td><td>X</td><td></td><td></td><td></td></tr><tr><td><code>prometheus</code></td><td>X</td><td>X</td><td></td><td>X</td></tr></tbody></table><h2 id="QuickStart"><a href="#QuickStart" class="headerlink" title="QuickStart"></a>QuickStart</h2><h3 id="使用内建的profile部署"><a href="#使用内建的profile部署" class="headerlink" title="使用内建的profile部署"></a>使用内建的profile部署</h3><p>这里用<code>demo</code>作为演示</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest apply --set profile=demo</span><br></pre></td></tr></table></figure><h3 id="部署时指定参数"><a href="#部署时指定参数" class="headerlink" title="部署时指定参数"></a>部署时指定参数</h3><blockquote><p>注意下！istioctl部署支持两种API，分别是<code>IstioControlPlane API</code>和<code>Helm API</code></p><ul><li>使用<code>demo</code>作为部署默认参数</li><li>开启<code>CNI</code>插件，并且把<code>CNI</code>插件部署到<code>kube-system</code>命名空间</li><li>修改镜像源地址为<code>dockerhub.azk8s.cn</code></li><li><code>istio-ingressgateway</code>的<code>Service</code>类型设置为<code>NodePort</code></li><li>开启控制平面安全功能</li><li>关闭<code>全局mTLS</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest apply \</span><br><span class="line">--set profile='demo' \</span><br><span class="line">--set cni.enabled=true \</span><br><span class="line">--set cni.components.cni.namespace='kube-system' \</span><br><span class="line">--set hub='dockerhub.azk8s.cn/istio' \</span><br><span class="line">--set values.gateways.istio-ingressgateway.type='LoadBalancer' \</span><br><span class="line">--set values.gateways.istio-egressgateway.enabled=false \</span><br><span class="line">--set values.gateways.istio-ingressgateway.sds.enabled=true \</span><br><span class="line">--set values.global.controlPlaneSecurityEnabled=true \</span><br><span class="line">--set values.global.mtls.enabled=false</span><br></pre></td></tr></table></figure><h3 id="验证istio安装情况"><a href="#验证istio安装情况" class="headerlink" title="验证istio安装情况"></a>验证istio安装情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n istio-system</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                                                                                                                      AGE</span><br><span class="line">grafana                  ClusterIP      172.21.211.123   &lt;none&gt;          3000/TCP                                                                                                                                     2m</span><br><span class="line">istio-citadel            ClusterIP      172.21.177.222   &lt;none&gt;          8060/TCP,15014/TCP                                                                                                                           2m</span><br><span class="line">istio-egressgateway      ClusterIP      172.21.113.24    &lt;none&gt;          80/TCP,443/TCP,15443/TCP                                                                                                                     2m</span><br><span class="line">istio-galley             ClusterIP      172.21.132.247   &lt;none&gt;          443/TCP,15014/TCP,9901/TCP                                                                                                                   2m</span><br><span class="line">istio-ingressgateway     LoadBalancer   172.21.144.254   52.116.22.242   15020:31831/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30318/TCP,15030:32645/TCP,15031:31933/TCP,15032:31188/TCP,15443:30838/TCP   2m</span><br><span class="line">istio-pilot              ClusterIP      172.21.105.205   &lt;none&gt;          15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       2m</span><br><span class="line">istio-policy             ClusterIP      172.21.14.236    &lt;none&gt;          9091/TCP,15004/TCP,15014/TCP                                                                                                                 2m</span><br><span class="line">istio-sidecar-injector   ClusterIP      172.21.155.47    &lt;none&gt;          443/TCP,15014/TCP                                                                                                                            2m</span><br><span class="line">istio-telemetry          ClusterIP      172.21.196.79    &lt;none&gt;          9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       2m</span><br><span class="line">jaeger-agent             ClusterIP      None             &lt;none&gt;          5775/UDP,6831/UDP,6832/UDP                                                                                                                   2m</span><br><span class="line">jaeger-collector         ClusterIP      172.21.135.51    &lt;none&gt;          14267/TCP,14268/TCP                                                                                                                          2m</span><br><span class="line">jaeger-query             ClusterIP      172.21.26.187    &lt;none&gt;          16686/TCP                                                                                                                                    2m</span><br><span class="line">kiali                    ClusterIP      172.21.155.201   &lt;none&gt;          20001/TCP                                                                                                                                    2m</span><br><span class="line">prometheus               ClusterIP      172.21.63.159    &lt;none&gt;          9090/TCP                                                                                                                                     2m</span><br><span class="line">tracing                  ClusterIP      172.21.2.245     &lt;none&gt;          80/TCP                                                                                                                                       2m</span><br><span class="line">zipkin                   ClusterIP      172.21.182.245   &lt;none&gt;          9411/TCP</span><br></pre></td></tr></table></figure><h3 id="获取Istio-IngressGateway访问方式"><a href="#获取Istio-IngressGateway访问方式" class="headerlink" title="获取Istio-IngressGateway访问方式"></a>获取Istio-IngressGateway访问方式</h3><h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='&#123;.items[0].status.hostIP&#125;')</span><br><span class="line">export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http2")].nodePort&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].nodePort&#125;')</span><br></pre></td></tr></table></figure><h4 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.status.loadBalancer.ingress[0].ip&#125;')</span><br><span class="line">export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http2")].port&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].port&#125;')</span><br></pre></td></tr></table></figure><h2 id="基于IstioControlPlane-API部署"><a href="#基于IstioControlPlane-API部署" class="headerlink" title="基于IstioControlPlane API部署"></a>基于IstioControlPlane API部署</h2><p>Istio提供的部署选项非常多，想在部署的时候做深度定制，最好基于IstioControlPlane API来实现。</p><h3 id="官方示例模板"><a href="#官方示例模板" class="headerlink" title="官方示例模板"></a>官方示例模板</h3><blockquote><p>官方文档有点坑！不带<code>apiVersion</code>和<code>kind</code>，格式也有点不对。</p><p>这里根据官方部署文件里面的Profile补齐了<code>apiVersion</code>和<code>kind</code>，并且魔改了一下</p></blockquote><ol><li>使用istio默认值部署</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br></pre></td></tr></table></figure><ol start="2"><li>使用minimal Profile默认值部署</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  profile:</span> <span class="string">minimal</span></span><br></pre></td></tr></table></figure><ol start="3"><li>使用istio默认值部署，关闭telemetry功能</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  telemetry:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ol start="4"><li>使用istio默认值部署，每个功能和安全组件安装在单独的namespace</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  traffic_management:</span></span><br><span class="line"><span class="attr">    components:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">istio-traffic-management</span></span><br><span class="line"><span class="attr">  policy:</span></span><br><span class="line"><span class="attr">    components:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">istio-policy</span></span><br><span class="line"><span class="attr">  telemetry:</span></span><br><span class="line"><span class="attr">    components:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">istio-telemetry</span></span><br><span class="line"><span class="attr">  config_management:</span></span><br><span class="line"><span class="attr">    components:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">istio-config-management</span></span><br><span class="line"><span class="attr">  security:</span></span><br><span class="line"><span class="attr">    components:</span></span><br><span class="line"><span class="attr">      citadel:</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="string">istio-citadel</span></span><br><span class="line"><span class="attr">      cert_manager:</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="string">istio-cert-manager</span></span><br><span class="line"><span class="attr">      node_agent:</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="string">istio-node-agent</span></span><br></pre></td></tr></table></figure><ol start="5"><li>使用istio默认值部署，并且配置k8s相关配置</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  traffic_management:</span></span><br><span class="line"><span class="attr">    components:</span></span><br><span class="line"><span class="attr">      pilot:</span></span><br><span class="line"><span class="attr">        k8s:</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">444</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">333</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">222</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">111</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          readinessProbe:</span></span><br><span class="line"><span class="attr">            failureThreshold:</span> <span class="number">44</span></span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">11</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">22</span></span><br><span class="line"><span class="attr">            successThreshold:</span> <span class="number">33</span></span><br></pre></td></tr></table></figure><ol start="6"><li>使用istio默认值部署，使用values.yaml来自定义proxy组件</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  values:</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">proxy:</span></span><br><span class="line">      <span class="attr">enableCoreDump:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsRefreshRate:</span> <span class="number">10</span><span class="string">s</span></span><br></pre></td></tr></table></figure><ol start="7"><li>使用istio默认值部署，自定义gallery容器的配置</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  configManagement:</span></span><br><span class="line"><span class="attr">    components:</span></span><br><span class="line"><span class="attr">      galley:</span></span><br><span class="line"><span class="attr">        k8s:</span></span><br><span class="line"><span class="attr">          overlays:</span></span><br><span class="line"><span class="attr">          - apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">            kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">istio-galley</span></span><br><span class="line"><span class="attr">            patches:</span></span><br><span class="line"><span class="attr">            - path:</span> <span class="string">spec.template.spec.containers.[name:galley].command.[--livenessProbeInterval]</span></span><br><span class="line"><span class="attr">              value:</span> <span class="bullet">--livenessProbeInterval=123s</span></span><br></pre></td></tr></table></figure><ol start="8"><li>使用istio内建的Profile来生成</li></ol><blockquote><p>这里用demo作为演示，dump出来的文件不带<code>apiVerion</code>和<code>kind</code>所以没法直接用！</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl profile dump demo</span><br></pre></td></tr></table></figure><blockquote><p>修正版如下，快700行了，好长！</p><p>可以根据生成的模板文件来修改所需配置！</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  autoInjection:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">  cni:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">  configManagement:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">  policy:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">  secure:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">  values:</span></span><br><span class="line"><span class="attr">    global:</span></span><br><span class="line">      <span class="string">...</span></span><br></pre></td></tr></table></figure><h3 id="部署istio-1"><a href="#部署istio-1" class="headerlink" title="部署istio"></a>部署istio</h3><h4 id="编辑模板文件"><a href="#编辑模板文件" class="headerlink" title="编辑模板文件"></a>编辑模板文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim istio-template.yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioControlPlane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  profile:</span> <span class="string">demo</span></span><br></pre></td></tr></table></figure><h4 id="直接使用模板文件部署"><a href="#直接使用模板文件部署" class="headerlink" title="直接使用模板文件部署"></a>直接使用模板文件部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest deploy -f istio-template.yaml</span><br></pre></td></tr></table></figure><h4 id="将模板文件转成部署文件再部署"><a href="#将模板文件转成部署文件再部署" class="headerlink" title="将模板文件转成部署文件再部署"></a>将模板文件转成部署文件再部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest generate --set profile=demo \</span><br><span class="line">                           --set hub='dockerhub.azk8s.cn' \</span><br><span class="line">                           &gt; istio-install.yaml</span><br><span class="line">kubectl apply -f istio-install.yaml</span><br></pre></td></tr></table></figure><h3 id="验证istio安装情况-1"><a href="#验证istio安装情况-1" class="headerlink" title="验证istio安装情况"></a>验证istio安装情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n istio-system</span><br></pre></td></tr></table></figure><h1 id="体验Istio功能特性"><a href="#体验Istio功能特性" class="headerlink" title="体验Istio功能特性"></a>体验Istio功能特性</h1><blockquote><p>这里跟随官方文档的Task来探索Istio的功能特性</p><font color="red">演示使用demo默认设置部署istio</font></blockquote><h2 id="samples目录"><a href="#samples目录" class="headerlink" title="samples目录"></a>samples目录</h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><ul><li>samples目录存放istio的官方示例</li></ul><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree samples/ -L 3 --dirsfirst</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">samples/</span><br><span class="line">├── bookinfo</span><br><span class="line">│   ├── networking</span><br><span class="line">│   │   ├── bookinfo-gateway.yaml</span><br><span class="line">│   │   ├── certmanager-gateway.yaml</span><br><span class="line">│   │   ├── destination-rule-all-mtls.yaml</span><br><span class="line">│   │   ├── destination-rule-all.yaml</span><br><span class="line">│   │   ├── destination-rule-reviews.yaml</span><br><span class="line">│   │   ├── egress-rule-google-apis.yaml</span><br><span class="line">│   │   ├── fault-injection-details-v1.yaml</span><br><span class="line">│   │   ├── virtual-service-all-v1.yaml</span><br><span class="line">│   │   ├── virtual-service-details-v2.yaml</span><br><span class="line">│   │   ├── virtual-service-ratings-db.yaml</span><br><span class="line">│   │   ├── virtual-service-ratings-mysql-vm.yaml</span><br><span class="line">│   │   ├── virtual-service-ratings-mysql.yaml</span><br><span class="line">│   │   ├── virtual-service-ratings-test-abort.yaml</span><br><span class="line">│   │   ├── virtual-service-ratings-test-delay.yaml</span><br><span class="line">│   │   ├── virtual-service-reviews-50-v3.yaml</span><br><span class="line">│   │   ├── virtual-service-reviews-80-20.yaml</span><br><span class="line">│   │   ├── virtual-service-reviews-90-10.yaml</span><br><span class="line">│   │   ├── virtual-service-reviews-jason-v2-v3.yaml</span><br><span class="line">│   │   ├── virtual-service-reviews-test-v2.yaml</span><br><span class="line">│   │   ├── virtual-service-reviews-v2-v3.yaml</span><br><span class="line">│   │   └── virtual-service-reviews-v3.yaml</span><br><span class="line">│   ├── platform</span><br><span class="line">│   │   ├── consul</span><br><span class="line">│   │   └── kube</span><br><span class="line">│   ├── policy</span><br><span class="line">│   │   ├── mixer-rule-deny-ip-crd.yaml</span><br><span class="line">│   │   ├── mixer-rule-deny-ip.yaml</span><br><span class="line">│   │   ├── mixer-rule-deny-label-crd.yaml</span><br><span class="line">│   │   ├── mixer-rule-deny-label.yaml</span><br><span class="line">│   │   ├── mixer-rule-deny-serviceaccount.yaml</span><br><span class="line">│   │   ├── mixer-rule-deny-whitelist-crd.yaml</span><br><span class="line">│   │   ├── mixer-rule-deny-whitelist.yaml</span><br><span class="line">│   │   ├── mixer-rule-ingress-denial.yaml</span><br><span class="line">│   │   ├── mixer-rule-kubernetesenv-telemetry.yaml</span><br><span class="line">│   │   ├── mixer-rule-productpage-ratelimit-crd.yaml</span><br><span class="line">│   │   ├── mixer-rule-productpage-ratelimit.yaml</span><br><span class="line">│   │   ├── mixer-rule-productpage-redis-quota-fixed-window.yaml</span><br><span class="line">│   │   ├── mixer-rule-productpage-redis-quota-rolling-window.yaml</span><br><span class="line">│   │   ├── mixer-rule-ratings-denial.yaml</span><br><span class="line">│   │   ├── mixer-rule-ratings-ratelimit.yaml</span><br><span class="line">│   │   ├── mixer-rule-ratings-redis-quota-fixed-window.yaml</span><br><span class="line">│   │   ├── mixer-rule-ratings-redis-quota-rolling-window.yaml</span><br><span class="line">│   │   ├── prometheus-adapter-deployment.yaml</span><br><span class="line">│   │   └── prometheus-oop-rule.yaml</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── src</span><br><span class="line">│   │   ├── details</span><br><span class="line">│   │   ├── mongodb</span><br><span class="line">│   │   ├── mysql</span><br><span class="line">│   │   ├── productpage</span><br><span class="line">│   │   ├── ratings</span><br><span class="line">│   │   └── reviews</span><br><span class="line">│   ├── swagger.yaml</span><br><span class="line">│   └── telemetry</span><br><span class="line">│       ├── fluentd-istio-crd.yaml</span><br><span class="line">│       ├── fluentd-istio.yaml</span><br><span class="line">│       ├── log-entry-crd.yaml</span><br><span class="line">│       ├── log-entry.yaml</span><br><span class="line">│       ├── metrics-crd.yaml</span><br><span class="line">│       ├── metrics.yaml</span><br><span class="line">│       ├── tcp-metrics-crd.yaml</span><br><span class="line">│       └── tcp-metrics.yaml</span><br><span class="line">├── certs</span><br><span class="line">│   ├── ca-cert.pem</span><br><span class="line">│   ├── ca-key.pem</span><br><span class="line">│   ├── cert-chain.pem</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   └── root-cert.pem</span><br><span class="line">├── custom-bootstrap</span><br><span class="line">│   ├── custom-bootstrap.yaml</span><br><span class="line">│   ├── example-app.yaml</span><br><span class="line">│   └── README.md</span><br><span class="line">├── external</span><br><span class="line">│   ├── aptget.yaml</span><br><span class="line">│   ├── github.yaml</span><br><span class="line">│   ├── pypi.yaml</span><br><span class="line">│   └── README.md</span><br><span class="line">├── fortio</span><br><span class="line">│   └── stackdriver.yaml</span><br><span class="line">├── health-check</span><br><span class="line">│   ├── liveness-command.yaml</span><br><span class="line">│   ├── liveness-http-same-port.yaml</span><br><span class="line">│   └── liveness-http.yaml</span><br><span class="line">├── helloworld</span><br><span class="line">│   ├── helloworld-gateway.yaml</span><br><span class="line">│   ├── helloworld.yaml</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   └── src</span><br><span class="line">│       └── requirements.txt</span><br><span class="line">├── httpbin</span><br><span class="line">│   ├── httpbin-gateway.yaml</span><br><span class="line">│   ├── httpbin-nodeport.yaml</span><br><span class="line">│   ├── httpbin-vault.yaml</span><br><span class="line">│   ├── httpbin.yaml</span><br><span class="line">│   ├── policy</span><br><span class="line">│   │   ├── keyval-template.yaml</span><br><span class="line">│   │   └── keyval.yaml</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   └── sample-client</span><br><span class="line">│       └── fortio-deploy.yaml</span><br><span class="line">├── https</span><br><span class="line">│   ├── default.conf</span><br><span class="line">│   └── nginx-app.yaml</span><br><span class="line">├── kubernetes-blog</span><br><span class="line">│   ├── bookinfo-ratings.yaml</span><br><span class="line">│   ├── bookinfo-reviews-v2.yaml</span><br><span class="line">│   └── bookinfo-v1.yaml</span><br><span class="line">├── multicluster</span><br><span class="line">│   └── README.md</span><br><span class="line">├── operator</span><br><span class="line">│   ├── pilot-advanced-override.yaml</span><br><span class="line">│   ├── pilot-k8s.yaml</span><br><span class="line">│   ├── sds-policy-off.yaml</span><br><span class="line">│   ├── sds.yaml</span><br><span class="line">│   ├── trafficManagement-namespace.yaml</span><br><span class="line">│   ├── values-global.yaml</span><br><span class="line">│   └── values-pilot.yaml</span><br><span class="line">├── rawvm</span><br><span class="line">│   └── README.md</span><br><span class="line">├── README.md</span><br><span class="line">├── security</span><br><span class="line">│   └── psp</span><br><span class="line">│       ├── all-pods-psp.yaml</span><br><span class="line">│       └── citadel-agent-psp.yaml</span><br><span class="line">├── sleep</span><br><span class="line">│   ├── policy</span><br><span class="line">│   │   ├── sni-serviceaccount.yaml</span><br><span class="line">│   │   └── sni-wikipedia.yaml</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── sleep-vault.yaml</span><br><span class="line">│   ├── sleep.yaml</span><br><span class="line">│   └── telemetry</span><br><span class="line">│       └── sni-logging.yaml</span><br><span class="line">├── tcp-echo</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── src</span><br><span class="line">│   ├── tcp-echo-20-v2.yaml</span><br><span class="line">│   ├── tcp-echo-all-v1.yaml</span><br><span class="line">│   ├── tcp-echo-services.yaml</span><br><span class="line">│   └── tcp-echo.yaml</span><br><span class="line">└── websockets</span><br><span class="line">    ├── app.yaml</span><br><span class="line">    ├── README.md</span><br><span class="line">    └── route.yaml</span><br></pre></td></tr></table></figure><h2 id="部署bookinfo"><a href="#部署bookinfo" class="headerlink" title="部署bookinfo"></a>部署bookinfo</h2><h3 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h3><ul><li>该应用程序由四个单独的微服务组成<ul><li>productpage：productpage微服务调用details和reviews微服务来填充页面。</li><li>details：details微服务包含图书的详细信息。</li><li>reviews：reviews微服务包含书评，它还调用ratings微服务。</li><li>ratings：ratings微服务包含书的排名信息。</li></ul></li><li>其中，reviews微服务提供了3个版本<ul><li>版本v1不调用ratings服务，因此没有五角星。</li><li>版本v2调用ratings服务，并将每个等级显示为1到5个黑星。</li><li>版本v3调用ratings服务，并将每个等级显示为1到5个红色星号。</li></ul></li><li>服务架构图如下</li></ul><p><img src="https://istio.io/docs/examples/bookinfo/noistio.svg" alt=""></p><ul><li>在部署了Istio之后，服务架构图会变成这样</li></ul><p><img src="https://istio.io/docs/examples/bookinfo/withistio.svg" alt=""></p><h3 id="部署到k8s"><a href="#部署到k8s" class="headerlink" title="部署到k8s"></a>部署到k8s</h3><ol><li>切换到<code>istio</code>的项目目录</li><li>给命名空间<code>default</code>打<code>label</code>开启<code>istio-inject</code>功能【<font color="red">不是必须的</font>】</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure><ol start="3"><li>部署bookinfo</li></ol><blockquote><p>开启了自动inject功能可以直接部署</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span><br></pre></td></tr></table></figure><blockquote><p>没有在第2步开启自动inject功能，可以通过istioctl命令部署</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)</span><br></pre></td></tr></table></figure><ol start="4"><li>确认<code>Pod</code>和<code>Service</code>状态</li></ol><p>查看Pod</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get pod</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-c5b5f496d-vqm55       2/2     Running   0          1m</span><br><span class="line">productpage-v1-c7765c886-g8hkm   2/2     Running   0          1m</span><br><span class="line">ratings-v1-f745cf57b-5fflk       2/2     Running   0          1m</span><br><span class="line">reviews-v1-75b979578c-dhdb8      2/2     Running   0          1m</span><br><span class="line">reviews-v2-597bf96c8f-r8tz9      2/2     Running   0          1m</span><br><span class="line">reviews-v3-54c6c64795-45f5v      2/2     Running   0          1m</span><br></pre></td></tr></table></figure><p>查看Service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get svc</span><br></pre></td></tr></table></figure><blockquote><p>示例代码</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.96.164.180   &lt;none&gt;        9080/TCP   1m</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    3d18h</span><br><span class="line">productpage   ClusterIP   10.96.110.93    &lt;none&gt;        9080/TCP   1m</span><br><span class="line">ratings       ClusterIP   10.96.18.131    &lt;none&gt;        9080/TCP   1m</span><br><span class="line">reviews       ClusterIP   10.96.53.148    &lt;none&gt;        9080/TCP   1m</span><br></pre></td></tr></table></figure><p>5.为了确定bookinfo启动完成，使用curl命令访问bookinfo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default exec -it $(kubectl -n default get pod -l app=ratings -o jsonpath='&#123;.items[0].metadata.name&#125;') -c ratings -- curl productpage:9080/productpage</span><br></pre></td></tr></table></figure><blockquote><p>可以看到有网页内容，网页title为<code>Simple Bookstore App</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br><span class="line">&lt;meta charset="utf-8"&gt;</span><br><span class="line">&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;</span><br><span class="line">&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br><span class="line">....................................................................</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><ol start="6"><li>部署bookinfo-gateway</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">bookinfo-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"*"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"*"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">bookinfo-gateway</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        exact:</span> <span class="string">/productpage</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        prefix:</span> <span class="string">/static</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        exact:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        exact:</span> <span class="string">/logout</span></span><br><span class="line"><span class="attr">    - uri:</span></span><br><span class="line"><span class="attr">        prefix:</span> <span class="string">/api/v1/products</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">9080</span></span><br></pre></td></tr></table></figure><ol start="7"><li>检查gateway CRD</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get gateways.networking.istio.io</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME               AGE</span><br><span class="line">bookinfo-gateway   5s</span><br></pre></td></tr></table></figure><ol start="8"><li>部署DestinationRule</li></ol><ul><li>未开启<code>mutual TLS</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v3</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v3</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2-mysql</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2-mysql</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2-mysql-vm</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2-mysql-vm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><ul><li>开启了<code>mutual TLS</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/destination-rule-all-mtls.yaml</span><br></pre></td></tr></table></figure><blockquote><p>文件内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">  trafficPolicy:</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">ISTIO_MUTUAL</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">  trafficPolicy:</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">ISTIO_MUTUAL</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v3</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v3</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">  trafficPolicy:</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">ISTIO_MUTUAL</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2-mysql</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2-mysql</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2-mysql-vm</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2-mysql-vm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">details</span></span><br><span class="line"><span class="attr">  trafficPolicy:</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">ISTIO_MUTUAL</span></span><br><span class="line"><span class="attr">  subsets:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v2</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h3 id="通过istio-gateway访问bookinfo"><a href="#通过istio-gateway访问bookinfo" class="headerlink" title="通过istio-gateway访问bookinfo"></a>通过istio-gateway访问bookinfo</h3><ol><li>声明环境变量</li></ol><blockquote><p>这里部署Istio时IngressGateway的Service类型为NodePort，所以直接用NodePort访问</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='&#123;.items[0].status.hostIP&#125;')</span><br><span class="line">export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http2")].nodePort&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].nodePort&#125;')</span><br><span class="line">export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT</span><br></pre></td></tr></table></figure><ol start="2"><li>访问bookinfo</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://$&#123;GATEWAY_URL&#125;/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;"</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure><ol start="3"><li><p>通过浏览器访问<code>http://${GATEWAY_URL}/productpage</code></p><p>根据<code>destination-rule-all.yaml</code>的定义，可以通过反复刷新页面访问到<code>reviewers</code>的三个版本，分别是</p></li></ol><ul><li><code>reviewers-v1</code>：没五角星</li><li><code>reviewers-v2</code>：黑五角星</li><li><code>reviewers-v3</code>：红五角星</li></ul><h2 id="部署TCP-echo"><a href="#部署TCP-echo" class="headerlink" title="部署TCP-echo"></a>部署TCP-echo</h2><h3 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h3><ul><li>通过TCP连接访问<code>TCP-echo</code>访问获取echo数据</li></ul><h3 id="部署到k8s-1"><a href="#部署到k8s-1" class="headerlink" title="部署到k8s"></a>部署到k8s</h3><ol><li>切换到<code>istio</code>项目目录</li><li>部署YAML文件</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/tcp-echo/tcp-echo.yaml</span><br></pre></td></tr></table></figure><ol start="3"><li>创建Pod</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -i --rm --restart=Never busybox --image=busybox:1.28 -- /bin/sh</span><br></pre></td></tr></table></figure><ol start="4"><li>测试<code>TCP-echo</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo abcdefg | nc tcp-echo 9000</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello abcdefg</span><br></pre></td></tr></table></figure><ol start="5"><li>清理现场</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f samples/tcp-echo/tcp-echo.yaml</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;istio版本号&lt;code&gt;1.4.2&lt;/code&gt;&lt;/li&gt;&lt;li&gt;k8s集群版本&lt;code&gt;v1.14.8&lt;/code&gt;&lt;/l
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
      <category term="Istio" scheme="https://luanlengli.github.io/categories/Kubernetes/Istio/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="Istio" scheme="https://luanlengli.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>如何使用Azure中国提供的容器镜像代理服务</title>
    <link href="https://luanlengli.github.io/2019/12/16/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Azure%E4%B8%AD%E5%9B%BD%E6%8F%90%E4%BE%9B%E7%9A%84Docker%E9%95%9C%E5%83%8F%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1.html"/>
    <id>https://luanlengli.github.io/2019/12/16/如何使用Azure中国提供的Docker镜像代理服务.html</id>
    <published>2019-12-16T06:12:59.000Z</published>
    <updated>2019-12-16T06:38:59.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>由于Dockerhub、k8s.gcr.io、Quay.io这些常用的容器镜像源都在国外，在国内访问经常不稳定，特别是托管在Google的k8s.gcr.io，对新手安装Kubernetes非常不方便</li><li>Azure中国提供了容器镜像代理服务，速度也算比较文档，这里记录一下配置过程</li><li>项目说明：<a href="https://github.com/Azure/container-service-for-azure-china/blob/master/aks/README.md" target="_blank" rel="noopener">container-service-for-azure-china</a></li></ul><h1 id="配置镜像源"><a href="#配置镜像源" class="headerlink" title="配置镜像源"></a>配置镜像源</h1><h2 id="DockerHub"><a href="#DockerHub" class="headerlink" title="DockerHub"></a>DockerHub</h2><p>以前Docker公司在国内是有专门的镜像服务器的，后来不知道咋的就没了。</p><p>这里使用Azure中国的镜像代理</p><table><thead><tr><th>原镜像地址</th><th>替换为Azure中国的地址</th></tr></thead><tbody><tr><td><code>alpine:3.10</code></td><td><code>dockerhub.azk8s.cn/library/alpine:3.10</code></td></tr><tr><td><code>jenkins/jenkins:2.190.1</code></td><td><code>dockerhub.azk8s.cn/jenkins/jenkins:2.190.1</code></td></tr></tbody></table><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p>编辑<code>/etec/docker/daemon.json</code>在<code>registry-mirrors</code>配置中添加<code>https://dockerhub.azk8s.cn</code>。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    "registry-mirrors": ["https://dockerhub.azk8s.cn"],</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>在<code>FROM</code>镜像的时候，直接使用Azure中国的源。</p><blockquote><p>需要注意的是，Docker代码在split的时候，如果只有<code>xxxx:tag</code>会拉取<code>/library/xxxx:tag</code>。</p><p>使用Azure中国的代理服务器，在处理这样的镜像时，需要自己手动添加一下<code>/library</code>，否则会找不到镜像。</p><p><a href="https://github.com/Azure/container-service-for-azure-china/issues/54" target="_blank" rel="noopener">相关issue</a></p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> dockerhub.azk8s.cn/library/alpine:<span class="number">3.10</span></span><br></pre></td></tr></table></figure><h2 id="gcr-io"><a href="#gcr-io" class="headerlink" title="gcr.io"></a>gcr.io</h2><p>国内用gcr.io比较少，通常都是用来下载Kubernetes的容器镜像。</p><p>可以通过替换镜像地址的方式来进行下载。</p><p>k8s.gcr.io会被重定向到gcr.io/google_containers。</p><table><thead><tr><th>原镜像地址</th><th>替换为Azure中国的地址</th></tr></thead><tbody><tr><td><code>k8s.gcr.io/pause:3.1</code></td><td><code>gcr.azk8s.cn/google_containers/pause:3.1</code></td></tr><tr><td><code>gcr.io/abc/image:1111</code></td><td><code>gcr.azk8s.cn/abc/image:1111</code></td></tr></tbody></table><h2 id="Quay-io"><a href="#Quay-io" class="headerlink" title="Quay.io"></a>Quay.io</h2><p>这里Quay也可以通过替换镜像的方式来下载</p><table><thead><tr><th>原镜像地址</th><th>替换为Azure中国的地址</th></tr></thead><tbody><tr><td><code>quay.io/coreos/flannel:v0.11.0-amd64</code></td><td><code>quay.azk8s.cn/coreos/flannel:v0.11.0-amd64</code></td></tr></tbody></table><h1 id="Azure中国原版项目说明"><a href="#Azure中国原版项目说明" class="headerlink" title="Azure中国原版项目说明"></a>Azure中国原版项目说明</h1><h2 id="Container-Registry-Proxy"><a href="#Container-Registry-Proxy" class="headerlink" title="Container Registry Proxy"></a>Container Registry Proxy</h2><p>Since some well known container registries like <code>docker.io</code>, <code>gcr.io</code> are not accessible or very slow in China, we have set up container registry proxies on Azure China for <strong>public anonymous access</strong>:</p><blockquote><p>The first docker pull of new image will be still slow, and then image would be cached, would be much faster in the next docker pull action.</p></blockquote><table><thead><tr><th>global</th><th>proxy in China</th><th>format</th><th>example</th></tr></thead><tbody><tr><td><a href="https://github.com/Azure/container-service-for-azure-china/blob/master/aks/hub.docker.com" target="_blank" rel="noopener">dockerhub</a> (docker.io)</td><td><a href="http://mirror.azk8s.cn/help/docker-registry-proxy-cache.html" target="_blank" rel="noopener">dockerhub.azk8s.cn</a></td><td><code>dockerhub.azk8s.cn//:</code></td><td><code>dockerhub.azk8s.cn/microsoft/azure-cli:2.0.61</code> <code>dockerhub.azk8s.cn/library/nginx:1.15</code></td></tr><tr><td>gcr.io</td><td><a href="http://mirror.azk8s.cn/help/gcr-proxy-cache.html" target="_blank" rel="noopener">gcr.azk8s.cn</a></td><td><code>gcr.azk8s.cn//:</code></td><td><code>gcr.azk8s.cn/google_containers/hyperkube-amd64:v1.13.5</code></td></tr><tr><td>quay.io</td><td><a href="http://mirror.azk8s.cn/help/quay-proxy-cache.html" target="_blank" rel="noopener">quay.azk8s.cn</a></td><td><code>quay.azk8s.cn//:</code></td><td><code>quay.azk8s.cn/deis/go-dev:v1.10.0</code></td></tr></tbody></table><blockquote><p>Note: <code>k8s.gcr.io</code> would redirect to <code>gcr.io/google-containers</code>, following image urls are identical:</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k8s.gcr.io/pause-amd64:3.1</span><br><span class="line">gcr.io/google_containers/pause-amd64:3.1</span><br></pre></td></tr></table></figure><ul><li><p>Container Registry Proxy Example</p><p>specify <code>defaultBackend.image.repository</code> as <code>gcr.azk8s.cn/google_containers/defaultbackend</code> in <a href="https://github.com/helm/charts/tree/master/stable/nginx-ingress" target="_blank" rel="noopener">nginx-ingress</a> chart since original <code>k8s.gcr.io</code> does not work in Azure China:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/nginx-ingress --set defaultBackend.image.repository=gcr.azk8s.cn/google_containers/defaultbackend --set defaultBackend.image.tag=1.4</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;由于Dockerhub、k8s.gcr.io、Quay.io这些常用的容器镜像源都在国外，在国内访问经常不稳定，特别是托管在Goo
      
    
    </summary>
    
      <category term="Docker" scheme="https://luanlengli.github.io/categories/Docker/"/>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Docker/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="Docker" scheme="https://luanlengli.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>OpenVPN客户端(Windows/Linux/MacOS)连接OpenVPN服务器</title>
    <link href="https://luanlengli.github.io/2019/11/25/OpenVPN%E5%AE%A2%E6%88%B7%E7%AB%AF-Windows-Linux-MacOS-%E8%BF%9E%E6%8E%A5OpenVPN%E6%9C%8D%E5%8A%A1%E5%99%A8.html"/>
    <id>https://luanlengli.github.io/2019/11/25/OpenVPN客户端-Windows-Linux-MacOS-连接OpenVPN服务器.html</id>
    <published>2019-11-25T13:20:02.000Z</published>
    <updated>2020-02-18T03:42:08.098Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>使用社区版的OpenVPN客户端连接社区版OpenVPN服务器</li><li>OpenVPN版本<code>2.4.8</code></li><li>Linux版本<code>CentOS-7.7</code></li><li>Windows版本<code>Windows 10 1903</code></li><li>MacOS版本<code>本人没有MacOS平台，这里简单参考官网的指南</code></li></ul><h1 id="Windows平台"><a href="#Windows平台" class="headerlink" title="Windows平台"></a>Windows平台</h1><h2 id="下载客户端"><a href="#下载客户端" class="headerlink" title="下载客户端"></a>下载客户端</h2><ul><li><a href="https://openvpn.net/community-downloads/" target="_blank" rel="noopener">官方下载地址页面</a></li></ul><h2 id="客户端选择"><a href="#客户端选择" class="headerlink" title="客户端选择"></a>客户端选择</h2><p>官网提供两种Windows的客户端，根据自己的Windows版本安装即可</p><p><a href="https://swupdate.openvpn.org/community/releases/openvpn-install-2.4.8-I602-Win7.exe" target="_blank" rel="noopener">openvpn-install-2.4.8-I602-Win7.exe</a></p><p><a href="https://swupdate.openvpn.org/community/releases/openvpn-install-2.4.8-I602-Win10.exe" target="_blank" rel="noopener">openvpn-install-2.4.8-I602-Win10.exe</a></p><h2 id="安装OpenVPN"><a href="#安装OpenVPN" class="headerlink" title="安装OpenVPN"></a>安装OpenVPN</h2><ul><li>双击下载好的exe文件</li><li>一路下一步直至安装完成</li></ul><h2 id="获取OpenVPN配置文件"><a href="#获取OpenVPN配置文件" class="headerlink" title="获取OpenVPN配置文件"></a>获取OpenVPN配置文件</h2><ul><li><p>OpenVPN的客户端配置文件为<code>*.ovpn</code></p></li><li><p>在使用证书认证的情况下，在<code>ovpn</code>文件同一个目录下面会有</p><ul><li><code>*.crt</code></li><li><code>*.key</code></li><li><code>ca.crt</code></li><li>再开启了<code>tls-auth</code>时还会有<code>ta.key</code>文件</li></ul></li><li>证书文件可以内嵌到<code>ovpn</code>文件中，因此有时候会只有一个<code>ovpn</code>文件</li></ul><h2 id="配置文件使用方式"><a href="#配置文件使用方式" class="headerlink" title="配置文件使用方式"></a>配置文件使用方式</h2><h3 id="直接双击ovpn文件"><a href="#直接双击ovpn文件" class="headerlink" title="直接双击ovpn文件"></a>直接双击ovpn文件</h3><p>Windows版OpenVPN客户端安装完成之后，会自动关联<code>ovpn</code>文件，双击即可打开OpenVPN</p><h3 id="复制到配置目录"><a href="#复制到配置目录" class="headerlink" title="复制到配置目录"></a>复制到配置目录</h3><blockquote><p>OpenVPN默认会从这两个目录找配置文件，可以存在多个不同的ovpn配置</p></blockquote><ul><li><code>C:\Program Files\OpenVPN\config</code></li><li><code>C:\User\用户名\OpenVPN\config</code>（通过双击ovpn的方式会把ovpn拷贝到这个目录）</li></ul><h2 id="连接OpenVPN服务器"><a href="#连接OpenVPN服务器" class="headerlink" title="连接OpenVPN服务器"></a>连接OpenVPN服务器</h2><ul><li>双击桌面的<code>OpenVPN GUI</code>图标</li><li>在任务栏右下角通知栏中找到<code>OpenVPN</code>的图标，右键</li><li>点击<font color="red">连接</font>，在有多个<code>ovpn</code>配置时，可以根据名字选择不同的<code>ovpn</code>配置，然后点击<font color="red">连接</font></li><li>连接过程会出现很多日志，连接成功后，右下角会提示连接成功</li></ul><h2 id="开机自启动"><a href="#开机自启动" class="headerlink" title="开机自启动"></a>开机自启动</h2><ul><li>把 <strong>ovpn</strong> 配置文件放在 <strong>C:\Program Files\OpenVPN\config</strong></li><li>运行 <strong>services.msc</strong></li><li>找到 <strong>OpenVPNService</strong> ，点击 <strong>右键</strong> ，选择 <strong>属性</strong></li><li>把启动类型改为 <strong>自动</strong> ，点击 <strong>启动</strong> ，点击 <strong>确定</strong></li></ul><h1 id="Linux平台"><a href="#Linux平台" class="headerlink" title="Linux平台"></a>Linux平台</h1><blockquote><p>这里以CentOS-7.7为例，YUM源自带了OpenVPN-2.4.8</p></blockquote><h2 id="安装客户端"><a href="#安装客户端" class="headerlink" title="安装客户端"></a>安装客户端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openvpn</span><br></pre></td></tr></table></figure><h2 id="获取配置文件"><a href="#获取配置文件" class="headerlink" title="获取配置文件"></a>获取配置文件</h2><ul><li>CentOS-7.7安装OpenVPN之后系统服务会识别<code>*.conf</code>的文件</li><li>配置文件跟Windows平台只有扩展名的区别，可以直接把Windows平台的<code>ovpn</code>文件改名为<code>conf</code>文件</li></ul><h2 id="复制到配置目录-1"><a href="#复制到配置目录-1" class="headerlink" title="复制到配置目录"></a>复制到配置目录</h2><p>CentOS-7.7安装OpenVPN之后会在<code>/etc/openvpn</code>下创建<code>client</code>和<code>server</code>目录</p><h2 id="启动OpenVPN客户端服务"><a href="#启动OpenVPN客户端服务" class="headerlink" title="启动OpenVPN客户端服务"></a>启动OpenVPN客户端服务</h2><p>以配置文件<code>abc.conf</code>为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start openvpn-client@abc.service</span><br></pre></td></tr></table></figure><h2 id="开机自启动-1"><a href="#开机自启动-1" class="headerlink" title="开机自启动"></a>开机自启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openvpn-client@abc.service</span><br></pre></td></tr></table></figure><h1 id="MacOS平台"><a href="#MacOS平台" class="headerlink" title="MacOS平台"></a>MacOS平台</h1><h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><ul><li>OS X 10.8 Mountain Lion</li><li>OS X 10.9 Mavericks</li><li>OS X 10.10 Yosemite</li><li>OS X 10.11 El Capitan</li><li>macOS 10.12 Sierra</li><li>macOS 10.13 High Sierra</li><li>macOS 10.14 Mojave</li></ul><h2 id="下载客户端-1"><a href="#下载客户端-1" class="headerlink" title="下载客户端"></a>下载客户端</h2><p><a href="https://openvpn.net/vpn-server-resources/connecting-to-access-server-with-macos/" target="_blank" rel="noopener">官网下载页面</a></p><p>里面有几个客户端可以选择</p><ul><li><a href="https://openvpn.net/downloads/openvpn-connect-v2-macos.dmg" target="_blank" rel="noopener">OpenVPN Connect Client for macOS version 2.7.1.100</a></li><li><a href="https://openvpn.net/downloads/openvpn-connect-v3-macos.dmg" target="_blank" rel="noopener">OpenVPN Connect for macOS version 3.1.0 (885) beta</a></li><li><a href="https://tunnelblick.net/downloads.html" target="_blank" rel="noopener">Tunnelblick</a></li></ul><h2 id="安装客户端-1"><a href="#安装客户端-1" class="headerlink" title="安装客户端"></a>安装客户端</h2><blockquote><p>这里用<code>Tunnelblick</code>为例</p></blockquote><ul><li>双击下载好的dmg文件</li><li>一路<font color="red">同意</font>、<font color="red">下一步</font>、<font color="red">安装</font></li></ul><h2 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h2><p><a href="https://mba811.gitbooks.io/web-study/content/vpn/vpn4.html" target="_blank" rel="noopener">参考gitbook上面的教程</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;使用社区版的OpenVPN客户端连接社区版OpenVPN服务器&lt;/li&gt;&lt;li&gt;OpenVPN版本&lt;code&gt;2.4.8&lt;/cod
      
    
    </summary>
    
    
      <category term="Windows" scheme="https://luanlengli.github.io/tags/Windows/"/>
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
      <category term="OpenVPN" scheme="https://luanlengli.github.io/tags/OpenVPN/"/>
    
      <category term="MacOS" scheme="https://luanlengli.github.io/tags/MacOS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7部署OpenVPN实现内网互通</title>
    <link href="https://luanlengli.github.io/2019/11/25/CentOS7%E9%83%A8%E7%BD%B2OpenVPN%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E4%BA%92%E9%80%9A.html"/>
    <id>https://luanlengli.github.io/2019/11/25/CentOS7部署OpenVPN实现内网互通.html</id>
    <published>2019-11-25T01:17:46.000Z</published>
    <updated>2020-02-13T07:25:29.307Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>此法用于多个客户端通过OpenVPN服务器实现内网访问</li><li>OpenVPN服务器操作系统<code>CentOS-7.7</code></li><li>OpenVPN版本<code>2.4.8</code></li><li>easy-rsa版本<code>3.0.6</code></li><li>使用<code>tap</code>模式</li><li>客户端IP地址池<code>10.8.0.0/24</code></li><li>多个客户端直接可以通过OpenVPN实现内网通信</li></ul><h1 id="准备操作"><a href="#准备操作" class="headerlink" title="准备操作"></a>准备操作</h1><h2 id="添加EPEL源"><a href="#添加EPEL源" class="headerlink" title="添加EPEL源"></a>添加EPEL源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br></pre></td></tr></table></figure><h2 id="替换为阿里云的源"><a href="#替换为阿里云的源" class="headerlink" title="替换为阿里云的源"></a>替换为阿里云的源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#baseurl,baseurl,g' \</span><br><span class="line">    -e 's,^metalink,#metalink,g' \</span><br><span class="line">    -e 's,^mirrorlist=,#mirrorlist=,g' \</span><br><span class="line">    -e 's,http://download.fedoraproject.org/pub,https://mirrors.aliyun.com,g' \</span><br><span class="line">    -i /etc/yum.repos.d/epel.repo</span><br></pre></td></tr></table></figure><h2 id="更新软件"><a href="#更新软件" class="headerlink" title="更新软件"></a>更新软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="修改sysctl参数"><a href="#修改sysctl参数" class="headerlink" title="修改sysctl参数"></a>修改sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-net.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径，默认值1</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 conntrack 的上限</span></span><br><span class="line">net.netfilter.nf_conntrack_max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=21644</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP阻塞控制算法BBR，Linux内核版本4.9开始内置BBR算法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FastOpen</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0:关闭 ; 1:作为客户端时使用 ; 2:作为服务器端时使用 ; 3:无论作为客户端还是服务器端都使用</span></span><br><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-centos.conf &lt;&lt;EOF</span><br><span class="line">* - nproc 1048576</span><br><span class="line">* - nofile 1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装OpenVPN软件"><a href="#安装OpenVPN软件" class="headerlink" title="安装OpenVPN软件"></a>安装OpenVPN软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openvpn easy-rsa lrzsz iptables-services</span><br></pre></td></tr></table></figure><h1 id="配置服务器证书"><a href="#配置服务器证书" class="headerlink" title="配置服务器证书"></a>配置服务器证书</h1><h2 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h2><blockquote><p>拷贝easy-rsa的文件到/etc/openvpn下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -r /usr/share/easy-rsa/3.0.6 /etc/openvpn/easy-rsa</span><br><span class="line">cp /usr/share/doc/easy-rsa-3.0.6/vars.example /etc/openvpn/easy-rsa/vars</span><br></pre></td></tr></table></figure><h2 id="修改vars"><a href="#修改vars" class="headerlink" title="修改vars"></a>修改vars</h2><blockquote><p>编辑vars文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/easy-rsa/vars</span><br></pre></td></tr></table></figure><blockquote><p>修改以下几项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_COUNTRY     <span class="string">"US"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_PROVINCE    <span class="string">"California"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_CITY        <span class="string">"San Francisco"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_ORG         <span class="string">"Copyleft Certificate Co"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_EMAIL       <span class="string">"me@example.net"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_OU          <span class="string">"My Organizational Unit"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_KEY_SIZE        4096</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_ALGO            rsa</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CA_EXPIRE       3650</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CERT_EXPIRE     365</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CERT_RENEW      180</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CRL_DAYS        60</span></span><br></pre></td></tr></table></figure><h2 id="初始化PKI和CA"><a href="#初始化PKI和CA" class="headerlink" title="初始化PKI和CA"></a>初始化PKI和CA</h2><h3 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/openvpn/easy-rsa</span><br></pre></td></tr></table></figure><h3 id="创建PKI"><a href="#创建PKI" class="headerlink" title="创建PKI"></a>创建PKI</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa init-pki</span><br></pre></td></tr></table></figure><h3 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa build-ca nopass</span><br></pre></td></tr></table></figure><h2 id="创建服务器证书"><a href="#创建服务器证书" class="headerlink" title="创建服务器证书"></a>创建服务器证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa build-server-full openvpn-server nopass</span><br></pre></td></tr></table></figure><h2 id="创建DH证书"><a href="#创建DH证书" class="headerlink" title="创建DH证书"></a>创建DH证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa gen-dh</span><br></pre></td></tr></table></figure><h2 id="拷贝证书"><a href="#拷贝证书" class="headerlink" title="拷贝证书"></a>拷贝证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/openvpn/pki</span><br><span class="line">cp /etc/openvpn/easy-rsa/pki/ca.crt \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/dh.pem \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/issued/openvpn-server.crt \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/private/openvpn-server.key \</span><br><span class="line">   /etc/openvpn/pki/</span><br><span class="line">ln -sv /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/pki/crl.pem</span><br><span class="line">chown -R root:openvpn /etc/openvpn/pki</span><br></pre></td></tr></table></figure><h2 id="创建ta-key"><a href="#创建ta-key" class="headerlink" title="创建ta.key"></a>创建ta.key</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --genkey --secret /etc/openvpn/pki/ta.key</span><br></pre></td></tr></table></figure><h1 id="配置OpenVPN"><a href="#配置OpenVPN" class="headerlink" title="配置OpenVPN"></a>配置OpenVPN</h1><h2 id="创建日志目录"><a href="#创建日志目录" class="headerlink" title="创建日志目录"></a>创建日志目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/openvpn</span><br><span class="line">chown -R openvpn:openvpn /var/log/openvpn</span><br></pre></td></tr></table></figure><h2 id="创建客户端配置目录"><a href="#创建客户端配置目录" class="headerlink" title="创建客户端配置目录"></a>创建客户端配置目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/openvpn/client/&#123;config,user&#125;</span><br><span class="line">chown -R root:openvpn /etc/openvpn/client/&#123;config,user&#125;</span><br></pre></td></tr></table></figure><h2 id="配置OpenVPN服务器端"><a href="#配置OpenVPN服务器端" class="headerlink" title="配置OpenVPN服务器端"></a>配置OpenVPN服务器端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/server/srv.conf</span><br></pre></td></tr></table></figure><blockquote><p>下面内容按需更改</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 监听地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">local</span> 0.0.0.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">port 51194</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通信协议</span></span><br><span class="line">proto tcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> TUN模式还是TAP模式</span></span><br><span class="line">dev tap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 证书</span></span><br><span class="line">ca         /etc/openvpn/pki/ca.crt</span><br><span class="line">cert       /etc/openvpn/pki/openvpn-server.crt</span><br><span class="line">key        /etc/openvpn/pki/openvpn-server.key</span><br><span class="line">dh         /etc/openvpn/pki/dh.pem</span><br><span class="line">crl-verify /etc/openvpn/pki/crl.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span></span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> TLS rules “client” | “server”</span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote-cert-tls  <span class="string">"client"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TLS认证</span></span><br><span class="line">tls-auth /etc/openvpn/pki/ta.key</span><br><span class="line"><span class="meta">#</span><span class="bash"> TLS最小版本</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tls-version-min <span class="string">"1.2"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新协商数据交换的key，默认3600</span></span><br><span class="line"><span class="meta">#</span><span class="bash">reneg-sec 3600</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在此文件中维护客户端与虚拟IP地址之间的关联记录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果OpenVPN重启，重新连接的客户端可以被分配到先前分配的虚拟IP地址</span></span><br><span class="line">ifconfig-pool-persist /etc/openvpn/ipp.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置client配置文件</span></span><br><span class="line">client-config-dir /etc/openvpn/client/config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 该网段为 open VPN 虚拟网卡网段，不要和内网网段冲突即可。</span></span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置网桥模式，需要在OpenVPN服务添加启动关闭脚本，将tap设备桥接到物理网口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 假定内网地址为192.168.0.0/24，内网网关是192.168.0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 分配192.168.0.200-250给VPN使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server-bridge 192.168.0.1 255.255.255.0 192.168.0.200 192.168.0.250</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 给客户端推送自定义路由</span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"route 192.168.0.0 255.255.255.0"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有客户端的默认网关都将重定向到VPN</span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"redirect-gateway def1 bypass-dhcp"</span>  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 向客户端推送DNS配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"dhcp-option DNS 223.5.5.5"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"dhcp-option DNS 223.6.6.6"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许客户端之间互相访问</span></span><br><span class="line">client-to-client</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制最大客户端数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max-clients 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端连接时运行脚本</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client-connect ovpns.script</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端断开连接时运行脚本</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client-disconnect ovpns.script</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保持连接时间</span></span><br><span class="line">keepalive 20 120</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启vpn压缩</span></span><br><span class="line">comp-lzo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许多人使用同一个证书连接VPN，不建议使用，注释状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash">duplicate-cn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行用户</span></span><br><span class="line">user openvpn</span><br><span class="line"><span class="meta">#</span><span class="bash">运行组</span></span><br><span class="line">group openvpn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 持久化选项可以尽量避免访问那些在重启之后由于用户权限降低而无法访问的某些资源</span></span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示当前的连接状态</span></span><br><span class="line">status      /var/log/openvpn/openvpn-status.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志路径，不指定文件路径时输出到控制台</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">log</span>代表每次启动时清空日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">log</span>        /var/<span class="built_in">log</span>/openvpn/openvpn.log</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">log</span>-append代表追加写入到日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">log</span>-append  /var/<span class="built_in">log</span>/openvpn/openvpn.log</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志级别</span></span><br><span class="line">verb 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略过多的重复信息，相同类别的信息只有前20条会输出到日志文件中</span></span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure><h2 id="启动OpenVPN-server"><a href="#启动OpenVPN-server" class="headerlink" title="启动OpenVPN-server"></a>启动OpenVPN-server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:openvpn /etc/openvpn</span><br><span class="line">systemctl enable openvpn-server@srv.service</span><br><span class="line">systemctl start openvpn-server@srv.service</span><br></pre></td></tr></table></figure><h2 id="添加SNAT访问内网"><a href="#添加SNAT访问内网" class="headerlink" title="添加SNAT访问内网"></a>添加SNAT访问内网</h2><ul><li>让<code>10.8.0.0/24</code>访问<code>192.168.0.0/24</code>的时候做SNAT，源地址改成OpenVPN服务器的内网地址</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -d 192.168.0.0/24 -j SNAT --to-source OPENVPN_SERVER_IP</span><br></pre></td></tr></table></figure><h2 id="定期更新CRL"><a href="#定期更新CRL" class="headerlink" title="定期更新CRL"></a>定期更新CRL</h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><ul><li>OpenVPN的server配置里面添加了<code>crl-verify</code>之后，需要给crl定期更新</li><li>如果crl文件长期不更新，过期之后，OpenVPN会报无法验证证书，导致无法连接OpenVPN</li><li>连接日志如下，提示<code>CRL has expired: CN=client_1</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">openvpn[28570]: TCP connection established with [AF_INET]202.96.128.86:7688</span><br><span class="line">openvpn[28570]: TCPv4_SERVER link local: (not bound)</span><br><span class="line">openvpn[28570]: TCPv4_SERVER link remote: [AF_INET]202.96.128.86:7688</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 TLS: Initial packet from [AF_INET]202.96.128.86:7688, sid=cec51529 1051f9aa</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 WARNING: Failed to stat CRL file, not (re)loading CRL.</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 VERIFY ERROR: depth=0, error=CRL has expired: CN=client_1</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 OpenSSL: error:14089086:SSL routines:ssl3_get_client_certificate:certificate verify failed</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 TLS_ERROR: BIO read tls_read_plaintext error</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 TLS Error: TLS object -&gt; incoming plaintext read error</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 TLS Error: TLS handshake failed</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 Fatal TLS error (check_tls_errors_co), restarting</span><br><span class="line">openvpn[28570]: 202.96.128.86:7688 SIGUSR1[soft,tls-error] received, client-instance restarting</span><br><span class="line">openvpn[28570]: TCP/UDP: Closing socket</span><br></pre></td></tr></table></figure><h3 id="配置systemd-timer"><a href="#配置systemd-timer" class="headerlink" title="配置systemd timer"></a>配置systemd timer</h3><h3 id="定义Service"><a href="#定义Service" class="headerlink" title="定义Service"></a>定义Service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/easyrsa-gen-crl.service</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=easyrsa-gen-crl</span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新生成CRL文件</span></span><br><span class="line">ExecStart=/etc/openvpn/easy-rsa/easyrsa gen-crl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令完成之后重启OpenVPN服务</span></span><br><span class="line">ExecStartPost=/usr/bin/systemctl restart openvpn-server@srv.service</span><br><span class="line">WorkingDirectory=/etc/openvpn/easy-rsa</span><br></pre></td></tr></table></figure><h3 id="定义timer"><a href="#定义timer" class="headerlink" title="定义timer"></a>定义timer</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=easyrsa-gen-crl</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每周一凌晨4点触发easyrsa-gen-crl.service</span></span><br><span class="line">OnCalendar=Mon *-*-* 04:00:00</span><br><span class="line">Persistent=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=timers.target</span><br></pre></td></tr></table></figure><h3 id="启动timer"><a href="#启动timer" class="headerlink" title="启动timer"></a>启动timer</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable easyrsa-gen-crl.timer</span><br><span class="line">systemctl start easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure><h3 id="立刻启动service"><a href="#立刻启动service" class="headerlink" title="立刻启动service"></a>立刻启动service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start easy-rsa-gen-crl.service</span><br></pre></td></tr></table></figure><h3 id="查看Service日志"><a href="#查看Service日志" class="headerlink" title="查看Service日志"></a>查看Service日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -xfu easy-rsa-gen-crl.service</span><br></pre></td></tr></table></figure><h3 id="查看timer状态"><a href="#查看timer状态" class="headerlink" title="查看timer状态"></a>查看timer状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure><h1 id="客户端管理"><a href="#客户端管理" class="headerlink" title="客户端管理"></a>客户端管理</h1><h2 id="客户端配置模板"><a href="#客户端配置模板" class="headerlink" title="客户端配置模板"></a>客户端配置模板</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/templates/ovpn.template</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置为客户端模式</span></span><br><span class="line">client</span><br><span class="line"><span class="meta">#</span><span class="bash"> 与服务器端保持一致</span></span><br><span class="line">proto tcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 与服务器端保持一致</span></span><br><span class="line">dev tap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置服务器端的地址和端口</span></span><br><span class="line">remote vpn-server 51194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">comp-lzo</span><br><span class="line">nice 0</span><br><span class="line">verb 3</span><br><span class="line">mute 10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span></span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止在内存中缓存password</span></span><br><span class="line">auth-nocache</span><br><span class="line"><span class="meta">#</span><span class="bash"> TLS rules “client” | “server”</span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote-cert-tls server</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤从服务器端发过来的路由规则</span></span><br><span class="line"><span class="meta">#</span><span class="bash">pull-filter ignore redirect-gateway</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不从服务器端拉取路由规则</span></span><br><span class="line"><span class="meta">#</span><span class="bash">route-nopull</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 手动指定所有流量走VPN</span></span><br><span class="line"><span class="meta">#</span><span class="bash">redirect-gateway def1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端自定义路由，例如192.168.0.0/24走VPN，192.168.1.0/24不走VPN</span></span><br><span class="line"><span class="meta">#</span><span class="bash">route 192.168.0.0 255.255.255.0 vpn_gateway</span></span><br><span class="line"><span class="meta">#</span><span class="bash">route 192.168.1.0 255.255.255.0 net_gateway</span></span><br></pre></td></tr></table></figure><h2 id="指定客户端推送配置"><a href="#指定客户端推送配置" class="headerlink" title="指定客户端推送配置"></a>指定客户端推送配置</h2><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/templates/ipconfig_push.template</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 给客户端推送固定的IP地址</span></span><br><span class="line">ifconfig-push #IP地址# 255.255.255.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给客户端推送路由</span></span><br><span class="line">iroute 192.168.0.0 255.255.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为客户端开启压缩</span></span><br><span class="line">comp-lzo yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送客户端配置</span></span><br><span class="line">push "comp-lzo yes"</span><br></pre></td></tr></table></figure><h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><blockquote><p>这里的客户端名字指的是证书的<code>Common Name</code>，这里以user1为例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/client/config/user1</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 给客户端推送固定的IP地址10.8.0.100</span></span><br><span class="line">ifconfig-push 10.8.0.100 255.255.255.0</span><br></pre></td></tr></table></figure><h2 id="用户管理脚本"><a href="#用户管理脚本" class="headerlink" title="用户管理脚本"></a>用户管理脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/ovpn_mgmt.sh</span><br><span class="line">chmod +x /usr/local/bin/ovpn_mgmt.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义环境变量</span></span><br><span class="line">export EASY_RSA_DIR="/etc/openvpn/easy-rsa"</span><br><span class="line">export CLIENT_CONFIG_DIR="/etc/openvpn/client/config"</span><br><span class="line">export PKI_DIR="$&#123;EASY_RSA_DIR&#125;/pki"</span><br><span class="line">export TEMPLATES_DIR="/etc/openvpn/templates"</span><br><span class="line">export CLIENT_USER_DIR="/etc/openvpn/client/user"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建ovpn配置</span></span><br><span class="line">generate_ovpn() &#123;</span><br><span class="line">USER_OVPN="$&#123;CLIENT_USER_DIR&#125;/$&#123;EXPIRED&#125;-$&#123;USER&#125;.ovpn"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据证书生成对应的ovpn文件</span></span><br><span class="line">    mkdir -p  $&#123;CLIENT_USER_DIR&#125;/</span><br><span class="line">    cp -f $&#123;TEMPLATES_DIR&#125;/ovpn.template $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;ca&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/ca.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/ca&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;cert&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/issued/$&#123;USER&#125;.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/cert&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;key&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/private/$&#123;USER&#125;.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/key&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;tls-auth&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat /etc/openvpn/pki/ta.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/tls-auth&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    sz --binary $&#123;USER_OVPN&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加客户端IP</span></span><br><span class="line">client_ip_config() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据ip地址生成对应的client-config</span></span><br><span class="line">    sed -e "s,#ipaddress#,$&#123;IPADDRESS&#125;,g" \</span><br><span class="line">        $&#123;TEMPLATES_DIR&#125;/ipconfig_push.template \</span><br><span class="line">        &gt; $&#123;CLIENT_CONFIG_DIR&#125;/$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成客户端证书</span></span><br><span class="line">add_cert() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到easy-rsa目录</span></span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    $&#123;EASY_RSA_DIR&#125;/easyrsa build-client-full $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注销客户端证书</span></span><br><span class="line">revoke_cert() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到easy-rsa目录</span></span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo "yes" | $&#123;EASY_RSA_DIR&#125;/easyrsa revoke $&#123;USER&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;EASY_RSA_DIR&#125;/easyrsa gen-crl</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新客户端证书</span></span><br><span class="line">renew_cert() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到easy-rsa目录</span></span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo "yes" | $&#123;EASY_RSA_DIR&#125;/easyrsa renew $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查证书过期时间</span></span><br><span class="line">check_cert_expired() &#123;</span><br><span class="line">export EXPIRED=$(date --date="$(openssl x509 -enddate -noout -in $&#123;PKI_DIR&#125;/issued/$&#123;USER&#125;.crt |cut -d= -f 2)" --iso-8601)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建用户</span></span><br><span class="line">add_user() &#123;</span><br><span class="line">if [[ -e "$&#123;EASY_RSA_DIR&#125;/pki/reqs/$&#123;USER&#125;.req" ]];then</span><br><span class="line">read -p"此用户已经申请证书，是否重新生成？[y/n]：" ANSWER</span><br><span class="line">case $&#123;ANSWER&#125; in</span><br><span class="line">    y|Y)</span><br><span class="line">        revoke_cert</span><br><span class="line">        check_cert_expired</span><br><span class="line">        client_ip_config</span><br><span class="line">        add_cert</span><br><span class="line">        generate_ovpn</span><br><span class="line">        exit 0</span><br><span class="line">        ;;</span><br><span class="line">n|N)</span><br><span class="line">check_cert_expired</span><br><span class="line">client_ip_config</span><br><span class="line">generate_ovpn</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line">else</span><br><span class="line">add_cert</span><br><span class="line">check_cert_expired</span><br><span class="line">client_ip_config</span><br><span class="line">generate_ovpn</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除用户</span></span><br><span class="line">del_user() &#123;</span><br><span class="line">revoke_cert</span><br><span class="line">rm -rf $&#123;CLIENT_USER_DIR&#125;/*$&#123;USER&#125;.ovpn</span><br><span class="line">rm -rf $&#123;CLIENT_CONFIG_DIR&#125;/$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户旧证过期重新生成证书</span></span><br><span class="line">renew_user() &#123;</span><br><span class="line">if [[ -e "$&#123;EASY_RSA_DIR&#125;/pki/reqs/$&#123;USER&#125;.req" ]];then</span><br><span class="line">        renew_cert</span><br><span class="line">        check_cert_expired</span><br><span class="line">        generate_ovpn</span><br><span class="line">    else</span><br><span class="line">    echo "用户证书不存在！"</span><br><span class="line">    exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">    # 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    # 根据传入的method运行对应函数</span><br><span class="line">    $&#123;METHOD&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取参数</span></span><br><span class="line">while getopts 'm:u:i:r' OPT;do</span><br><span class="line">    case $OPT in</span><br><span class="line">        u)</span><br><span class="line">            USER="$OPTARG"</span><br><span class="line">            echo "USER=$&#123;USER&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        i)</span><br><span class="line">            IPADDRESS="$OPTARG"</span><br><span class="line">            echo "IPADDRESS=$&#123;IPADDRESS&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        m)</span><br><span class="line">            METHOD="$OPTARG"</span><br><span class="line">            echo "METHOD=$&#123;METHOD&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            echo "Usage: $(base \"$0\") -m [add_user|del_user|renew_user] -u USER -i IPADDRESS"</span><br><span class="line">            exit 0</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure><h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/ovpn_mgmt.sh -m add_user -u USERNAME -i 10.8.0.10</span><br></pre></td></tr></table></figure><h2 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/ovpn_mgmt.sh -m del_user -u USERNAME</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;此法用于多个客户端通过OpenVPN服务器实现内网访问&lt;/li&gt;&lt;li&gt;OpenVPN服务器操作系统&lt;code&gt;CentOS-7.
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
      <category term="OpenVPN" scheme="https://luanlengli.github.io/tags/OpenVPN/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群利用RBAC+ServiceAccount管理权限</title>
    <link href="https://luanlengli.github.io/2019/08/17/Kubernetes%E9%9B%86%E7%BE%A4%E5%88%A9%E7%94%A8RBAC+ServiceAccount%E7%AE%A1%E7%90%86%E6%9D%83%E9%99%90.html"/>
    <id>https://luanlengli.github.io/2019/08/17/Kubernetes集群利用RBAC+ServiceAccount管理权限.html</id>
    <published>2019-08-17T08:31:24.000Z</published>
    <updated>2020-02-27T05:01:41.947Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>这里简单记录一下如何通过k8s集群创建clusterrole配合serviceaccount实现权限控制，并且使用kubectl生成kubeconfig文件用于实现人员权限管理。</p><h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><h2 id="创建ClusterRole"><a href="#创建ClusterRole" class="headerlink" title="创建ClusterRole"></a>创建ClusterRole</h2><blockquote><p>这里参考了kube-apiserver初始化时生成的clusterrole.views权限设定</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">aggregationRule:</span></span><br><span class="line"><span class="attr">  clusterRoleSelectors:</span></span><br><span class="line"><span class="attr">  - matchLabels:</span></span><br><span class="line">      <span class="string">rbac.example.com/aggregate-to-monitoring:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">configmaps</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/metrics</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/proxy</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">serviceaccounts</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">services</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">bindings</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">events</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">limitranges</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods/log</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">resourcequotas</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">resourcequotas/status</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">apps</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">controllerrevisions</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">daemonsets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">statefulsets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">statefulsets/scale</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">autoscaling</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">batch</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cronjobs</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">jobs</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">extensions</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">daemonsets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ingresses</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networkpolicies</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">policy</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networking.k8s.io</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networkpolicies</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">metrics.k8s.io</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">monitoring.coreos.com</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertmanagers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">podmonitors</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">prometheuses</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">prometheusrules</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">servicemonitors</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- nonResourceURLs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/metrics</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/log</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/logs</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/healthz</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/healthz/*</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br></pre></td></tr></table></figure><blockquote><p>如果需要有Pod的exec权限可以创建一个ClusterRole</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-exec</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods/exec</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">create</span></span><br></pre></td></tr></table></figure><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><h2 id="创建ClusterRoleBinding"><a href="#创建ClusterRoleBinding" class="headerlink" title="创建ClusterRoleBinding"></a>创建ClusterRoleBinding</h2><blockquote><p>这里创建的ClusterRoleBinding是整个集群级别的</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><h2 id="创建RoleBinding"><a href="#创建RoleBinding" class="headerlink" title="创建RoleBinding"></a>创建RoleBinding</h2><blockquote><p>这里创建的RoleBinding可以具体到某一个namespace</p><p>这里创建一个default命名空间的RoleBinding</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-pod-exec</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-exec</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><h2 id="获取ServiceAccount对应的Secret"><a href="#获取ServiceAccount对应的Secret" class="headerlink" title="获取ServiceAccount对应的Secret"></a>获取ServiceAccount对应的Secret</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET=$(kubectl -n default get serviceaccount cluster-readonly -o go-template='&#123;&#123;range .secrets&#125;&#125;&#123;&#123;.name&#125;&#125;&#123;&#123;end&#125;&#125;')</span><br></pre></td></tr></table></figure><h2 id="定义Kube-APIServer"><a href="#定义Kube-APIServer" class="headerlink" title="定义Kube-APIServer"></a>定义Kube-APIServer</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">API_SERVER="https://192.168.1.100:6443"</span><br></pre></td></tr></table></figure><h2 id="获取集群CA证书"><a href="#获取集群CA证书" class="headerlink" title="获取集群CA证书"></a>获取集群CA证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get secret $&#123;SECRET&#125; -o yaml | awk '/ca.crt:/&#123;print $2&#125;' | base64 -d &gt; ca.crt</span><br></pre></td></tr></table></figure><h2 id="获取ServiceAccount对应的Token"><a href="#获取ServiceAccount对应的Token" class="headerlink" title="获取ServiceAccount对应的Token"></a>获取ServiceAccount对应的Token</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TOKEN=$(kubectl -n default get secret $&#123;SECRET&#125; -o go-template='&#123;&#123;.data.token&#125;&#125;')</span><br></pre></td></tr></table></figure><h2 id="定义kubeconfig文件名"><a href="#定义kubeconfig文件名" class="headerlink" title="定义kubeconfig文件名"></a>定义kubeconfig文件名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBECONFIG="cluster-readonly.kubeconfig"</span><br></pre></td></tr></table></figure><h2 id="创建kubeconfig"><a href="#创建kubeconfig" class="headerlink" title="创建kubeconfig"></a>创建kubeconfig</h2><ul><li>设置kubeconfig集群信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        set-cluster k8s-cluster \</span><br><span class="line">        --server=$&#123;API_SERVER&#125; \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --certificate-authority=./ca.crt</span><br></pre></td></tr></table></figure><ul><li>设置kubeconfig使用用户名+token认证</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        set-credentials cluster-readonly \</span><br><span class="line">        --token=`echo $&#123;TOKEN&#125; | base64 -d` \</span><br><span class="line">        --kubeconfig=$&#123;KUBECONFIG&#125;</span><br></pre></td></tr></table></figure><ul><li>设置kubeconfig的context</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        set-context default \</span><br><span class="line">        --cluster=k8s-cluster \</span><br><span class="line">        --user=cluster-readonly \</span><br><span class="line">        --kubeconfig=$&#123;KUBECONFIG&#125;</span><br></pre></td></tr></table></figure><ul><li>将context设置为kubeconfig默认值</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        use-context default \</span><br><span class="line">        --kubeconfig=$&#123;KUBECONFIG&#125;</span><br></pre></td></tr></table></figure><h1 id="验证权限"><a href="#验证权限" class="headerlink" title="验证权限"></a>验证权限</h1><h2 id="有权限的操作"><a href="#有权限的操作" class="headerlink" title="有权限的操作"></a>有权限的操作</h2><h3 id="获取Pod"><a href="#获取Pod" class="headerlink" title="获取Pod"></a>获取Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get pod --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="获取Pod日志"><a href="#获取Pod日志" class="headerlink" title="获取Pod日志"></a>获取Pod日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get pod --subresource=log --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="获取ingress"><a href="#获取ingress" class="headerlink" title="获取ingress"></a>获取ingress</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get ingress --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yes</span><br></pre></td></tr></table></figure><h2 id="无权限的操作"><a href="#无权限的操作" class="headerlink" title="无权限的操作"></a>无权限的操作</h2><h3 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i create pods --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i delete pods --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="获取Secret"><a href="#获取Secret" class="headerlink" title="获取Secret"></a>获取Secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get secrets -n kube-system</span><br></pre></td></tr></table></figure><h3 id="返回结果-1"><a href="#返回结果-1" class="headerlink" title="返回结果"></a>返回结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no - no RBAC policy matched</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;p&gt;这里简单记录一下如何通过k8s集群创建clusterrole配合serviceaccount实现权限控制，并且使用kubectl生成kube
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
  </entry>
  
  <entry>
    <title>Kubernetes集群使用ECK部署elasticsearch和kibana</title>
    <link href="https://luanlengli.github.io/2019/08/03/Kubernetes%E9%9B%86%E7%BE%A4%E4%BD%BF%E7%94%A8ECK%E9%83%A8%E7%BD%B2elasticsearch%E5%92%8Ckibana.html"/>
    <id>https://luanlengli.github.io/2019/08/03/Kubernetes集群使用ECK部署elasticsearch和kibana.html</id>
    <published>2019-08-03T01:33:50.000Z</published>
    <updated>2019-08-07T03:17:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录操作过程和部署过程</li><li>请考虑再三之后再决定是否上生产环境！</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>Kubernetes集群版本<code>v1.14.4</code></li><li>elastic-operator版本为<code>0.9.0</code></li><li>elasticsearch和kibana版本为<code>7.2.0</code></li><li>elasticsearch和kibana默认提供<font color="red">HTTPS</font>，其中elasticsearch无法关闭HTTPS</li></ul><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-quickstart.html" target="_blank" rel="noopener">Elastic Cloud on Kubernetes Quickstart</a></p><p><a href="https://github.com/elastic/cloud-on-k8s/tree/master/docs/design" target="_blank" rel="noopener">Elastic Cloud on k8s design</a></p><h1 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h1><p><a href="https://github.com/elastic/cloud-on-k8s" target="_blank" rel="noopener">cloud-on-k8s</a></p><h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><h2 id="Kubernetes集群"><a href="#Kubernetes集群" class="headerlink" title="Kubernetes集群"></a>Kubernetes集群</h2><ul><li>kubectl版本<code>v1.11+</code></li><li>kubectl当前content拥有cluster-admin权限</li></ul><h2 id="准备存储"><a href="#准备存储" class="headerlink" title="准备存储"></a>准备存储</h2><ul><li>出于测试目的，本文使用<code>emptyDir</code></li><li>另外还可以使用<code>volumeClaimTemplates</code>作为持久化数据存储</li></ul><h1 id="部署ECK"><a href="#部署ECK" class="headerlink" title="部署ECK"></a>部署ECK</h1><p>部署elastic-operator、CRD资源、RBAC</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://download.elastic.co/downloads/eck/0.9.0/all-in-one.yaml</span><br></pre></td></tr></table></figure><h2 id="检查部署情况"><a href="#检查部署情况" class="headerlink" title="检查部署情况"></a>检查部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n elastic-system get pod</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">elastic-operator-0   1/1     Running   1          50m</span><br></pre></td></tr></table></figure><h2 id="部署elasticsearch"><a href="#部署elasticsearch" class="headerlink" title="部署elasticsearch"></a>部署elasticsearch</h2><h3 id="编辑YAML文件"><a href="#编辑YAML文件" class="headerlink" title="编辑YAML文件"></a>编辑YAML文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">elasticsearch.k8s.elastic.co/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Elasticsearch</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearc-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">7.2</span><span class="number">.0</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.2.0</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    changeBudget:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># groups:</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-a</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-b</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># certificate:</span></span><br><span class="line">      <span class="comment">#   secretName: my-cert</span></span><br><span class="line"><span class="attr">      selfSignedCertificate:</span></span><br><span class="line">        <span class="comment"># subjectAltNames:</span></span><br><span class="line">        <span class="comment"># - ip: 160.46.176.15</span></span><br><span class="line">        <span class="comment"># - dns: hulk.example.com</span></span><br><span class="line"><span class="attr">        disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  nodes:</span></span><br><span class="line">  <span class="comment"># - nodeCount: 10</span></span><br><span class="line">  <span class="comment">#   config:</span></span><br><span class="line">  <span class="comment">#     node.master: false</span></span><br><span class="line">  <span class="comment">#     node.data: true</span></span><br><span class="line">  <span class="comment">#     node.ingest: true</span></span><br><span class="line">  <span class="comment">#     node.ml: true</span></span><br><span class="line">  <span class="comment">#     cluster.remote.connect: false</span></span><br><span class="line"><span class="attr">  - nodeCount:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line">      <span class="string">node.master:</span> <span class="literal">true</span></span><br><span class="line">      <span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line">      <span class="string">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    setVmMaxMapCount:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#    volumeClaimTemplates:</span></span><br><span class="line"><span class="comment">#    - metadata:</span></span><br><span class="line"><span class="comment">#        name: elasticsearch-data</span></span><br><span class="line"><span class="comment">#      spec:</span></span><br><span class="line"><span class="comment">#        accessModes:</span></span><br><span class="line"><span class="comment">#        - ReadWriteOnce</span></span><br><span class="line"><span class="comment">#        storageClassName: cephfs</span></span><br><span class="line"><span class="comment">#        resources:</span></span><br><span class="line"><span class="comment">#          requests:</span></span><br><span class="line"><span class="comment">#            storage: 10Gi</span></span><br><span class="line"><span class="attr">    podTemplate:</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line">        <span class="comment"># affinity:</span></span><br><span class="line">        <span class="comment">#   nodeAffinity:</span></span><br><span class="line">        <span class="comment">#     requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="comment">#       nodeSelectorTerms:</span></span><br><span class="line">        <span class="comment">#       - matchExpressions:</span></span><br><span class="line">        <span class="comment">#         - key: failure-domain.beta.kubernetes.io/zone</span></span><br><span class="line">        <span class="comment">#           operator: In</span></span><br><span class="line">        <span class="comment">#           values:</span></span><br><span class="line">        <span class="comment">#           - abc</span></span><br><span class="line">        <span class="comment"># initContainers:</span></span><br><span class="line">        <span class="comment">#  使用initContainers安装elasticsearch插件</span></span><br><span class="line">        <span class="comment"># - name: install-plugins</span></span><br><span class="line">        <span class="comment">#   command:</span></span><br><span class="line">        <span class="comment">#   - "sh"</span></span><br><span class="line">        <span class="comment">#   - "-c"</span></span><br><span class="line">        <span class="comment">#   - |</span></span><br><span class="line">        <span class="comment">#     bin/elasticsearch-plugin install --batch analysis-icu</span></span><br><span class="line"><span class="attr">        containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line"><span class="attr">            value:</span> <span class="bullet">-Xms2G</span> <span class="bullet">-Xmx2G</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">4</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">4</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">elasticsearch-data</span></span><br><span class="line"><span class="attr">          emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="部署YAML"><a href="#部署YAML" class="headerlink" title="部署YAML"></a>部署YAML</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f elasticsearch.yaml</span><br></pre></td></tr></table></figure><h2 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a>部署kibana</h2><h3 id="编辑YAML文件-1"><a href="#编辑YAML文件-1" class="headerlink" title="编辑YAML文件"></a>编辑YAML文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kibana.k8s.elastic.co/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kibana</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kibana-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">7.2</span><span class="number">.0</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">docker.elastic.co/kibana/kibana:7.2.0</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    changeBudget:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># groups:</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-a</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-b</span></span><br><span class="line"><span class="attr">  nodeCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># certificate:</span></span><br><span class="line">      <span class="comment">#   secretName: my-cert</span></span><br><span class="line"><span class="attr">      selfSignedCertificate:</span></span><br><span class="line">        <span class="comment"># subjectAltNames:</span></span><br><span class="line">        <span class="comment"># - ip: 160.46.176.15</span></span><br><span class="line">        <span class="comment"># - dns: hulk.example.com</span></span><br><span class="line"><span class="attr">        disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  elasticsearchRef:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">elasticsearc-demo</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  podTemplate:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">I18N_LOCALE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">zh-CN</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">2</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br></pre></td></tr></table></figure><h3 id="部署YAML-1"><a href="#部署YAML-1" class="headerlink" title="部署YAML"></a>部署YAML</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kibana.yaml</span><br></pre></td></tr></table></figure><h1 id="验证和访问服务"><a href="#验证和访问服务" class="headerlink" title="验证和访问服务"></a>验证和访问服务</h1><h2 id="查看elasticsearch"><a href="#查看elasticsearch" class="headerlink" title="查看elasticsearch"></a>查看elasticsearch</h2><h3 id="查看Pod"><a href="#查看Pod" class="headerlink" title="查看Pod"></a>查看Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l common.k8s.elastic.co/type=elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">elasticsearc-demo-es-6vpj7k9qxk   1/1     Running   1          38m</span><br><span class="line">elasticsearc-demo-es-x8nzjksw84   1/1     Running   1          38m</span><br></pre></td></tr></table></figure><h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                HEALTH   NODES   VERSION   PHASE         AGE</span><br><span class="line">elasticsearc-demo   green    2       7.2.0     Operational   34m</span><br></pre></td></tr></table></figure><h3 id="查看secret"><a href="#查看secret" class="headerlink" title="查看secret"></a>查看secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -l common.k8s.elastic.co/type=elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NAME                                          TYPE     DATA   AGE</span><br><span class="line">elasticsearc-demo-es-elastic-user             Opaque   1      38m</span><br><span class="line">elasticsearc-demo-es-http-ca-internal         Opaque   2      38m</span><br><span class="line">elasticsearc-demo-es-http-certs-internal      Opaque   2      38m</span><br><span class="line">elasticsearc-demo-es-internal-users           Opaque   3      38m</span><br><span class="line">elasticsearc-demo-es-transport-ca-internal    Opaque   2      38m</span><br><span class="line">elasticsearc-demo-es-transport-certs-public   Opaque   1      38m</span><br><span class="line">elasticsearc-demo-es-xpack-file-realm         Opaque   3      38m</span><br></pre></td></tr></table></figure><h2 id="查看kibana"><a href="#查看kibana" class="headerlink" title="查看kibana"></a>查看kibana</h2><h3 id="查看Pod-1"><a href="#查看Pod-1" class="headerlink" title="查看Pod"></a>查看Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">kibana-demo-kb-77cc75688f-lwqnk   1/1     Running   0          37m</span><br></pre></td></tr></table></figure><h3 id="查看集群状态-1"><a href="#查看集群状态-1" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          HEALTH   NODES   VERSION   AGE</span><br><span class="line">kibana-demo   green    1       7.2.0     35m</span><br></pre></td></tr></table></figure><h3 id="查看secret-1"><a href="#查看secret-1" class="headerlink" title="查看secret"></a>查看secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                                 TYPE     DATA   AGE</span><br><span class="line">kibana-demo-kb-es-ca                 Opaque   1      40m</span><br><span class="line">kibana-demo-kb-http-ca-internal      Opaque   2      37m</span><br><span class="line">kibana-demo-kb-http-certs-internal   Opaque   2      37m</span><br><span class="line">kibana-demo-kibana-user              Opaque   1      40m</span><br></pre></td></tr></table></figure><h2 id="获取用户名密码"><a href="#获取用户名密码" class="headerlink" title="获取用户名密码"></a>获取用户名密码</h2><p>默认用户名是<code>elastic</code></p><p>访问elasticsearch和kibana的密码存放在<code>elasticsearc-demo-es-elastic-user</code>可以通过以下方式获取</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ELASTIC_PASSWORD=$(kubectl get secrets elasticsearc-demo-es-elastic-user -o=jsonpath='&#123;.data.elastic&#125;' | base64 --decode)</span><br><span class="line">echo $ELASTIC_PASSWORD</span><br></pre></td></tr></table></figure><h2 id="访问服务"><a href="#访问服务" class="headerlink" title="访问服务"></a>访问服务</h2><h3 id="获取svc"><a href="#获取svc" class="headerlink" title="获取svc"></a>获取svc</h3><h4 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -l common.k8s.elastic.co/type=elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">elasticsearc-demo-es-http   ClusterIP   10.96.217.252   &lt;none&gt;        9200/TCP   43m</span><br></pre></td></tr></table></figure><h4 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kibana-demo-kb-http   ClusterIP   10.96.102.185   &lt;none&gt;        5601/TCP   44m</span><br></pre></td></tr></table></figure><h3 id="访问elasticsearch"><a href="#访问elasticsearch" class="headerlink" title="访问elasticsearch"></a>访问elasticsearch</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k -u "elastic:$&#123;ELASTIC_PASSWORD&#125;" "http://10.96.217.252:9200"</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"elasticsearc-demo-es-x8nzjksw84"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearc-demo"</span>,</span><br><span class="line">  <span class="attr">"cluster_uuid"</span> : <span class="string">"U8xgFU1NSB6o8qmKYgYyxw"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"7.2.0"</span>,</span><br><span class="line">    <span class="attr">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="attr">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"508c38a"</span>,</span><br><span class="line">    <span class="attr">"build_date"</span> : <span class="string">"2019-06-20T15:54:18.811730Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"8.0.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="访问kibana"><a href="#访问kibana" class="headerlink" title="访问kibana"></a>访问kibana</h3><h4 id="修改svc为NodePort"><a href="#修改svc为NodePort" class="headerlink" title="修改svc为NodePort"></a>修改svc为NodePort</h4><blockquote><p>这种做法比较low，建议走<code>Ingress Controller</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch svc kibana-demo-kb-http -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;'</span><br></pre></td></tr></table></figure><h4 id="获取端口"><a href="#获取端口" class="headerlink" title="获取端口"></a>获取端口</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kibana-demo-kb-http         NodePort    10.96.102.185   &lt;none&gt;        5601:31364/TCP   47m</span><br></pre></td></tr></table></figure><h4 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h4><p><code>https://k8s-master:31364</code></p><h4 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h4><ul><li>用户名：<code>elastic</code></li><li>密码：上面访问elasticsearch时的密码</li></ul><h3 id="创建ingress规则"><a href="#创建ingress规则" class="headerlink" title="创建ingress规则"></a>创建ingress规则</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">"HTTPS"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">elasticsearch.default.cluster.local</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">elasticsearch-demo-es-http</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">9200</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kibana-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">"HTTPS"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">kibana.default.cluster.local</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">kibana-demo-kb-http</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">5601</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;仅记录操作过程和部署过程&lt;/li&gt;&lt;li&gt;请考虑再三之后再决定是否上生产环境！&lt;/li&gt;&lt;li&gt;操作系统使用的&lt;code&gt;Cent
      
    
    </summary>
    
      <category term="Elasticsearch" scheme="https://luanlengli.github.io/categories/Elasticsearch/"/>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Elasticsearch/Kubernetes/"/>
    
    
      <category term="Elasticsearch" scheme="https://luanlengli.github.io/tags/Elasticsearch/"/>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes部署TiDB数据库集群</title>
    <link href="https://luanlengli.github.io/2019/07/29/Kubernetes%E9%83%A8%E7%BD%B2TiDB%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2019/07/29/Kubernetes部署TiDB数据库集群.html</id>
    <published>2019-07-29T06:29:58.000Z</published>
    <updated>2019-08-04T03:47:24.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录操作过程和部署过程</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>虚拟机配置<code>4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘B</code></li><li>Kubernetes集群版本<code>v1.14.4</code></li><li>使用本地PV作为数据存储</li><li>TiDB-Operator版本<code>v1.0.0</code></li><li>TiDB组件版本<code>v3.0.1</code></li></ul><h2 id="服务器拓扑"><a href="#服务器拓扑" class="headerlink" title="服务器拓扑"></a>服务器拓扑</h2><table><thead><tr><th>服务器IP</th><th>部署实例</th></tr></thead><tbody><tr><td>172.16.80.201</td><td>TiKv*1 TiDB*1 PD*1</td></tr><tr><td>172.16.80.202</td><td>TiKv*1 TiDB*1 PD*1</td></tr><tr><td>172.16.80.203</td><td>TiKv*1 TiDB*1 PD*1</td></tr></tbody></table><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h2><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="安装Helm服务端"><a href="#安装Helm服务端" class="headerlink" title="安装Helm服务端"></a>安装Helm服务端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image gcr.azk8s.cn/google_containers/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h3 id="检查部署结果"><a href="#检查部署结果" class="headerlink" title="检查部署结果"></a>检查部署结果</h3><h4 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h4 id="查看Helm版本信息"><a href="#查看Helm版本信息" class="headerlink" title="查看Helm版本信息"></a>查看Helm版本信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h2 id="添加Helm-Repo"><a href="#添加Helm-Repo" class="headerlink" title="添加Helm Repo"></a>添加Helm Repo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add pingcap https://charts.pingcap.org/</span><br></pre></td></tr></table></figure><h2 id="更新helm缓存"><a href="#更新helm缓存" class="headerlink" title="更新helm缓存"></a>更新helm缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure><h2 id="查看TiDB-Operator版本"><a href="#查看TiDB-Operator版本" class="headerlink" title="查看TiDB-Operator版本"></a>查看TiDB-Operator版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search pingcap -l</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME                 CHART VERSIONAPP VERSIONDESCRIPTION                            </span><br><span class="line">pingcap/tidb-backup  v1.0.0                  A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  v1.0.0-rc.1             A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  v1.0.0-beta.3           A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  v1.0.0-beta.2           A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-cluster v1.0.0                  A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster v1.0.0-rc.1             A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster v1.0.0-beta.3           A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster v1.0.0-beta.2           A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-operatorv1.0.0                  tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operatorv1.0.0-rc.1             tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operatorv1.0.0-beta.3           tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operatorv1.0.0-beta.2           tidb-operator Helm chart for Kubernetes</span><br></pre></td></tr></table></figure><h2 id="配置本地PV"><a href="#配置本地PV" class="headerlink" title="配置本地PV"></a>配置本地PV</h2><p>参考【<a href="https://luanlengli.github.io/2019/07/23/Kubernetes创建本地PV.html">Kubernetes创建本地PV</a>】</p><p><font color="red">修改ext4挂载选项</font>为<code>defaults,nodelalloc,noatime</code></p><blockquote><p>示例如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=f8727d20-3ef9-4f83-b865-25943bc342a6 /mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6 ext4 defaults,nodelalloc,noatime 0 2</span><br></pre></td></tr></table></figure><h2 id="创建CRD"><a href="#创建CRD" class="headerlink" title="创建CRD"></a>创建CRD</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/crd.yaml</span><br></pre></td></tr></table></figure><h1 id="部署TiDB-Operator"><a href="#部署TiDB-Operator" class="headerlink" title="部署TiDB-Operator"></a>部署TiDB-Operator</h1><h2 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/TiDB</span><br></pre></td></tr></table></figure><h2 id="下载TiDB-Operator-Chart包"><a href="#下载TiDB-Operator-Chart包" class="headerlink" title="下载TiDB-Operator Chart包"></a>下载TiDB-Operator Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/TiDB</span><br><span class="line">helm fetch pingcap/tidb-operator --version=v1.0.0</span><br></pre></td></tr></table></figure><h2 id="解压Chart包"><a href="#解压Chart包" class="headerlink" title="解压Chart包"></a>解压Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf tidb-operator-v1.0.0.tgz</span><br></pre></td></tr></table></figure><h2 id="编辑values-yaml"><a href="#编辑values-yaml" class="headerlink" title="编辑values.yaml"></a>编辑values.yaml</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default values for tidb-operator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clusterScoped is whether tidb-operator should manage kubernetes cluster wide tidb clusters</span></span><br><span class="line"><span class="comment"># Also see rbac.create and controllerManager.serviceAccount</span></span><br><span class="line"><span class="attr">clusterScoped:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Also see clusterScoped and controllerManager.serviceAccount</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># operatorImage is TiDB Operator image</span></span><br><span class="line"><span class="attr">operatorImage:</span> <span class="string">pingcap/tidb-operator:v1.0.0</span></span><br><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">defaultStorageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line"><span class="attr">controllerManager:</span></span><br><span class="line">  <span class="comment"># With rbac.create=false, the user is responsible for creating this account</span></span><br><span class="line">  <span class="comment"># With rbac.create=true, this service account will be created</span></span><br><span class="line">  <span class="comment"># Also see rbac.create and clusterScoped</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">tidb-controller-manager</span></span><br><span class="line"><span class="attr">  logLevel:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line">  <span class="comment"># autoFailover is whether tidb-operator should auto failover when failure occurs</span></span><br><span class="line"><span class="attr">  autoFailover:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># pd failover period default(5m)</span></span><br><span class="line"><span class="attr">  pdFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line">  <span class="comment"># tikv failover period default(5m)</span></span><br><span class="line"><span class="attr">  tikvFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line">  <span class="comment"># tidb failover period default(5m)</span></span><br><span class="line"><span class="attr">  tidbFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="comment"># With rbac.create=false, the user is responsible for creating this account</span></span><br><span class="line">  <span class="comment"># With rbac.create=true, this service account will be created</span></span><br><span class="line">  <span class="comment"># Also see rbac.create and clusterScoped</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">tidb-scheduler</span></span><br><span class="line"><span class="attr">  logLevel:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  schedulerName:</span> <span class="string">tidb-scheduler</span></span><br><span class="line">  <span class="comment"># features:</span></span><br><span class="line">  <span class="comment"># - StableScheduling=true</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">  kubeSchedulerImageName:</span> <span class="string">gcr.azk8s.cn/google_containers/kube-scheduler</span></span><br><span class="line">  <span class="comment"># This will default to matching your kubernetes version</span></span><br><span class="line">  <span class="comment"># kubeSchedulerImageTag:</span></span><br></pre></td></tr></table></figure><h2 id="部署Operator"><a href="#部署Operator" class="headerlink" title="部署Operator"></a>部署Operator</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install pingcap/tidb-operator \</span><br><span class="line">     --name=tidb-operator \</span><br><span class="line">     --namespace=tidb-admin \</span><br><span class="line">     --version=v1.0.0 \</span><br><span class="line">     -f /home/tidb/tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Operator部署情况"><a href="#查看Operator部署情况" class="headerlink" title="查看Operator部署情况"></a>查看Operator部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb-admin get pod -l app.kubernetes.io/name=tidb-operator</span><br></pre></td></tr></table></figure><h1 id="部署TiDB-Cluster"><a href="#部署TiDB-Cluster" class="headerlink" title="部署TiDB-Cluster"></a>部署TiDB-Cluster</h1><h2 id="创建工作目录-1"><a href="#创建工作目录-1" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/TiDB</span><br></pre></td></tr></table></figure><h2 id="下载Chart包"><a href="#下载Chart包" class="headerlink" title="下载Chart包"></a>下载Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/TiDB</span><br><span class="line">helm fetch pingcap/tidb-cluster --version=v1.0.0</span><br></pre></td></tr></table></figure><h2 id="解压Chart包-1"><a href="#解压Chart包-1" class="headerlink" title="解压Chart包"></a>解压Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf tidb-cluster-v1.0.0.tgz</span><br></pre></td></tr></table></figure><h2 id="编辑values-yaml-1"><a href="#编辑values-yaml-1" class="headerlink" title="编辑values.yaml"></a>编辑values.yaml</h2><p>配置含义请看这里【<a href="https://pingcap.com/docs-cn/v3.0/tidb-in-kubernetes/reference/configuration/tidb-cluster/" target="_blank" rel="noopener">Kubernetes 上的 TiDB 集群配置</a>】</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim tidb-cluster/values.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改后如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default values for tidb-cluster.</span></span><br><span class="line"><span class="comment"># This is a YAML-formatted file.</span></span><br><span class="line"><span class="comment"># Declare variables to be passed into your templates.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Also see monitor.serviceAccount</span></span><br><span class="line"><span class="comment"># If you set rbac.create to false, you need to provide a value for monitor.serviceAccount</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clusterName is the TiDB cluster name, if not specified, the chart release name will be used</span></span><br><span class="line"><span class="comment"># clusterName: demo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add additional TidbCluster labels</span></span><br><span class="line"><span class="comment"># ref: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/</span></span><br><span class="line"><span class="attr">extraLabels:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># schedulerName must be same with charts/tidb-operator/values#scheduler.schedulerName</span></span><br><span class="line"><span class="attr">schedulerName:</span> <span class="string">tidb-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># timezone is the default system timzone for TiDB</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default reclaim policy of a PV</span></span><br><span class="line"><span class="attr">pvReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># services is the service list to expose, default is ClusterIP</span></span><br><span class="line"><span class="comment"># can be ClusterIP | NodePort | LoadBalancer</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">pd</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tidb-operator:v1.0.0</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whether enable ConfigMap Rollout management.</span></span><br><span class="line"><span class="comment"># When enabling, change of ConfigMap will trigger a graceful rolling-update of the component.</span></span><br><span class="line"><span class="comment"># This feature is only available in tidb-operator v1.0 or higher.</span></span><br><span class="line"><span class="comment"># Note: Switch this variable against an existing cluster will cause an rolling-update of each component even</span></span><br><span class="line"><span class="comment"># if the ConfigMap was not changed.</span></span><br><span class="line"><span class="attr">enableConfigMapRollout:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pd:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/pingcap/pd/blob/master/conf/config.toml for the default</span></span><br><span class="line">  <span class="comment"># pd configurations (change to the tags of your pd version), </span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/pd-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your pd) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [log]</span></span><br><span class="line"><span class="string">    level = "info"</span></span><br><span class="line"><span class="string">    [replication]</span></span><br><span class="line"><span class="string">    location-labels = ["region", "zone", "rack", "host"]</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/pd:v3.0.1</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 8000m</span></span><br><span class="line">    <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line">      <span class="comment"># cpu: 4000m</span></span><br><span class="line">      <span class="comment"># memory: 4Gi</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines pd scheduling rules,it's default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment">## The following is typical example of affinity settings:</span></span><br><span class="line">  <span class="comment">## The PodAntiAffinity setting of the example keeps PD pods does not co-locate on a topology node as far as possible to improve the disaster tolerance of PD on Kubernetes.</span></span><br><span class="line">  <span class="comment">## The NodeAffinity setting of the example ensure that the PD pods can only be scheduled to nodes with label:[type="pd"],</span></span><br><span class="line">  <span class="comment"># affinity:</span></span><br><span class="line">  <span class="comment">#   podAntiAffinity:</span></span><br><span class="line">  <span class="comment">#     preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named region</span></span><br><span class="line">  <span class="comment">#     - weight: 10</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "region"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named zone</span></span><br><span class="line">  <span class="comment">#     - weight: 20</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "zone"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named rack</span></span><br><span class="line">  <span class="comment">#     - weight: 40</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "rack"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named kubernetes.io/hostname</span></span><br><span class="line">  <span class="comment">#     - weight: 80</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "kubernetes.io/hostname"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#   nodeAffinity:</span></span><br><span class="line">  <span class="comment">#     requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">  <span class="comment">#       nodeSelectorTerms:</span></span><br><span class="line">  <span class="comment">#       - matchExpressions:</span></span><br><span class="line">  <span class="comment">#         - key: "kind"</span></span><br><span class="line">  <span class="comment">#           operator: In</span></span><br><span class="line">  <span class="comment">#           values:</span></span><br><span class="line">  <span class="comment">#           - "pd"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tikv:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/tikv/tikv/blob/master/etc/config-template.toml for the default</span></span><br><span class="line">  <span class="comment"># tikv configurations (change to the tags of your tikv version),</span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/tikv-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your tikv) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    log-level = "info"</span></span><br><span class="line"><span class="string">    [server]</span></span><br><span class="line"><span class="string">    status-addr = "0.0.0.0:20180"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Here are some parameters you may want to customize (Please configure in the above 'config' section):</span></span><br><span class="line"><span class="string">  # [readpool.storage]</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for high-priority operations.</span></span><br><span class="line"><span class="string">  # # high-concurrency = 4</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for normal-priority operations.</span></span><br><span class="line"><span class="string">  # # normal-concurrency = 4</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for low-priority operations.</span></span><br><span class="line"><span class="string">  # # low-concurrency = 4</span></span><br><span class="line"><span class="string">  # [readpool.coprocessor]</span></span><br><span class="line"><span class="string">  # ## Most read requests from TiDB are sent to the coprocessor of TiKV. high/normal/low-concurrency is</span></span><br><span class="line"><span class="string">  # ## used to set the number of threads of the coprocessor.</span></span><br><span class="line"><span class="string">  # ## If there are many read requests, you can increase these config values (but keep it within the</span></span><br><span class="line"><span class="string">  # ## number of system CPU cores). For example, for a 32-core machine deployed with TiKV, you can even</span></span><br><span class="line"><span class="string">  # ## set these config to 30 in heavy read scenarios.</span></span><br><span class="line"><span class="string">  # ## If CPU_NUM &gt; 8, the default thread pool size for coprocessors is set to CPU_NUM * 0.8.</span></span><br><span class="line"><span class="string">  # # high-concurrency = 8</span></span><br><span class="line"><span class="string">  # # normal-concurrency = 8</span></span><br><span class="line"><span class="string">  # # low-concurrency = 8</span></span><br><span class="line"><span class="string">  # [server]</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for the gRPC server.</span></span><br><span class="line"><span class="string">  # # grpc-concurrency = 4</span></span><br><span class="line"><span class="string">  # [storage]</span></span><br><span class="line"><span class="string">  # ## Scheduler's worker pool size, i.e. the number of write threads.</span></span><br><span class="line"><span class="string">  # ## It should be less than total CPU cores. When there are frequent write operations, set it to a</span></span><br><span class="line"><span class="string">  # ## higher value. More specifically, you can run `top -H -p tikv-pid` to check whether the threads</span></span><br><span class="line"><span class="string">  # ## named `sched-worker-pool` are busy.</span></span><br><span class="line"><span class="string">  # # scheduler-worker-pool-size = 4</span></span><br><span class="line"><span class="string">  #### Below parameters available in TiKV 2.x only</span></span><br><span class="line"><span class="string">  # [rocksdb.defaultcf]</span></span><br><span class="line"><span class="string">  # ## block-cache used to cache uncompressed blocks, big block-cache can speed up read.</span></span><br><span class="line"><span class="string">  # ## in normal cases should tune to 30%-50% tikv.resources.limits.memory</span></span><br><span class="line"><span class="string">  # # block-cache-size = "1GB"</span></span><br><span class="line"><span class="string">  # [rocksdb.writecf]</span></span><br><span class="line"><span class="string">  # ## in normal cases should tune to 10%-30% tikv.resources.limits.memory</span></span><br><span class="line"><span class="string">  # # block-cache-size = "256MB"</span></span><br><span class="line"><span class="string">  #### Below parameters available in TiKV 3.x and above only</span></span><br><span class="line"><span class="string">  # [storage.block-cache]</span></span><br><span class="line"><span class="string">  # ## Size of the shared block cache. Normally it should be tuned to 30%-50% of container's total memory.</span></span><br><span class="line"><span class="string">  # # capacity = "1GB"</span></span><br><span class="line"><span class="string">  # [raftstore]</span></span><br><span class="line"><span class="string">  # ## true (default value) for high reliability, this can prevent data loss when power failure.</span></span><br><span class="line"><span class="string">  # # sync-log = true</span></span><br><span class="line"><span class="string">  # # apply-pool-size = 2</span></span><br><span class="line"><span class="string">  # # store-pool-size = 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tikv:v3.0.1</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 16000m</span></span><br><span class="line">    <span class="comment">#   memory: 32Gi</span></span><br><span class="line">    <span class="comment">#   storage: 300Gi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line">      <span class="comment"># cpu: 12000m</span></span><br><span class="line">      <span class="comment"># memory: 24Gi</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines tikv scheduling rules,affinity default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tidb:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/pingcap/tidb/blob/master/config/config.toml.example for the default</span></span><br><span class="line">  <span class="comment"># tidb configurations(change to the tags of your tidb version),</span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/tidb-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your tidb) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [log]</span></span><br><span class="line"><span class="string">    level = "info"</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># The secret name of root password, you can create secret with following command:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic tidb-secret --from-literal=root=&lt;root-password&gt; --namespace=&lt;namespace&gt;</span></span><br><span class="line">  <span class="comment"># If unset, the root password will be empty and you can set it after connecting</span></span><br><span class="line">  <span class="comment"># passwordSecretName: tidb-secret</span></span><br><span class="line">  <span class="comment"># initSql is the SQL statements executed after the TiDB cluster is bootstrapped.</span></span><br><span class="line">  <span class="comment"># initSql: |-</span></span><br><span class="line">  <span class="comment">#   create database app;</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tidb:v3.0.1</span></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 16000m</span></span><br><span class="line">    <span class="comment">#   memory: 16Gi</span></span><br><span class="line"><span class="attr">    requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 12000m</span></span><br><span class="line">    <span class="comment">#   memory: 12Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines tikv scheduling rules,affinity default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  maxFailoverCount:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">    exposeStatus:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># annotations:</span></span><br><span class="line">      <span class="comment"># cloud.google.com/load-balancer-type: Internal</span></span><br><span class="line"><span class="attr">  separateSlowLog:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  slowLogTailer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:1.26.2</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">20</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">5</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># tidb plugin configuration</span></span><br><span class="line"><span class="attr">  plugin:</span></span><br><span class="line">    <span class="comment"># enable plugin or not</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># the start argument to specify the folder containing</span></span><br><span class="line"><span class="attr">    directory:</span> <span class="string">/plugins</span></span><br><span class="line">    <span class="comment"># the start argument to specify the plugin id (name "-" version) that needs to be loaded, e.g. 'conn_limit-1'.</span></span><br><span class="line"><span class="attr">    list:</span> <span class="string">["whitelist-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysqlClient is used to set password for TiDB</span></span><br><span class="line"><span class="comment"># it must has Python MySQL client installed</span></span><br><span class="line"><span class="attr">mysqlClient:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">tnir/mysqlclient</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">monitor:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Also see rbac.create</span></span><br><span class="line">  <span class="comment"># If you set rbac.create to false, you need to provide a value here.</span></span><br><span class="line">  <span class="comment"># If you set rbac.create to true, you should leave this empty.</span></span><br><span class="line">  <span class="comment"># serviceAccount:</span></span><br><span class="line"><span class="attr">  persistent:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  initializer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-monitor-initializer:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  reloader:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-monitor-reloader:v1.0.0</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  grafana:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">grafana/grafana:6.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 8000m</span></span><br><span class="line">      <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">      requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 4000m</span></span><br><span class="line">      <span class="comment">#   memory: 4Gi</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line">      <span class="comment"># Configure Grafana using environment variables except GF_PATHS_DATA, GF_SECURITY_ADMIN_USER and GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">      <span class="comment"># Ref https://grafana.com/docs/installation/configuration/#using-environment-variables</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ENABLED:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ORG_NAME:</span> <span class="string">"Main Org."</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ORG_ROLE:</span> <span class="string">"Viewer"</span></span><br><span class="line">      <span class="comment"># if grafana is running behind a reverse proxy with subpath http://foo.bar/grafana</span></span><br><span class="line">      <span class="comment"># GF_SERVER_DOMAIN: foo.bar</span></span><br><span class="line">      <span class="comment"># GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s/grafana/"</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  prometheus:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">prom/prometheus:v2.11.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 8000m</span></span><br><span class="line">      <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">      requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 4000m</span></span><br><span class="line">      <span class="comment">#   memory: 4Gi</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">    reserveDays:</span> <span class="number">12</span></span><br><span class="line">    <span class="comment"># alertmanagerURL: ""</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># kind: monitor</span></span><br><span class="line">    <span class="comment"># zone: cn-bj1-01,cn-bj1-02</span></span><br><span class="line">    <span class="comment"># region: cn-bj1</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">binlog:</span></span><br><span class="line"><span class="attr">  pump:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-binlog:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line">    <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">    <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">    <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">    <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">    storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">    syncLog:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># a integer value to control expiry date of the binlog data, indicates for how long (in days) the binlog data would be stored.</span></span><br><span class="line">    <span class="comment"># must bigger than 0</span></span><br><span class="line"><span class="attr">    gc:</span> <span class="number">7</span></span><br><span class="line">    <span class="comment"># number of seconds between heartbeat ticks (in 2 seconds)</span></span><br><span class="line"><span class="attr">    heartbeatInterval:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  drainer:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-binlog:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line">    <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">    <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">    <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">    <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">    storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line">    <span class="comment"># the number of the concurrency of the downstream for synchronization. The bigger the value,</span></span><br><span class="line">    <span class="comment"># the better throughput performance of the concurrency (16 by default)</span></span><br><span class="line"><span class="attr">    workerCount:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># the interval time (in seconds) of detect pumps' status (default 10)</span></span><br><span class="line"><span class="attr">    detectInterval:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># disbale detect causality</span></span><br><span class="line"><span class="attr">    disableDetect:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># disable dispatching sqls that in one same binlog; if set true, work-count and txn-batch would be useless</span></span><br><span class="line"><span class="attr">    disableDispatch:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># # disable sync these schema</span></span><br><span class="line"><span class="attr">    ignoreSchemas:</span> <span class="string">"INFORMATION_SCHEMA,PERFORMANCE_SCHEMA,mysql,test"</span></span><br><span class="line">    <span class="comment"># if drainer donesn't have checkpoint, use initial commitTS to initial checkpoint</span></span><br><span class="line"><span class="attr">    initialCommitTs:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># enable safe mode to make syncer reentrant</span></span><br><span class="line"><span class="attr">    safeMode:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># the number of SQL statements of a transaction that are output to the downstream database (20 by default)</span></span><br><span class="line"><span class="attr">    txnBatch:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># downstream storage, equal to --dest-db-type</span></span><br><span class="line">    <span class="comment"># valid values are "mysql", "pb", "kafka"</span></span><br><span class="line"><span class="attr">    destDBType:</span> <span class="string">pb</span></span><br><span class="line"><span class="attr">    mysql:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment"># host: "127.0.0.1"</span></span><br><span class="line">      <span class="comment"># user: "root"</span></span><br><span class="line">      <span class="comment"># password: ""</span></span><br><span class="line">      <span class="comment"># port: 3306</span></span><br><span class="line">      <span class="comment"># # Time and size limits for flash batch write</span></span><br><span class="line">      <span class="comment"># timeLimit: "30s"</span></span><br><span class="line">      <span class="comment"># sizeLimit: "100000"</span></span><br><span class="line"><span class="attr">    kafka:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment"># only need config one of zookeeper-addrs and kafka-addrs, will get kafka address if zookeeper-addrs is configed.</span></span><br><span class="line">      <span class="comment"># zookeeperAddrs: "127.0.0.1:2181"</span></span><br><span class="line">      <span class="comment"># kafkaAddrs: "127.0.0.1:9092"</span></span><br><span class="line">      <span class="comment"># kafkaVersion: "0.8.2.0"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scheduledBackup:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># https://github.com/pingcap/tidb-cloud-backup</span></span><br><span class="line"><span class="attr">  mydumperImage:</span> <span class="string">pingcap/tidb-cloud-backup:20190610</span></span><br><span class="line"><span class="attr">  mydumperImagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  storage:</span> <span class="number">100</span><span class="string">Gi</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#schedule</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">"0 0 * * *"</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#suspend</span></span><br><span class="line"><span class="attr">  suspend:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#jobs-history-limits</span></span><br><span class="line"><span class="attr">  successfulJobsHistoryLimit:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  failedJobsHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#starting-deadline</span></span><br><span class="line"><span class="attr">  startingDeadlineSeconds:</span> <span class="number">3600</span></span><br><span class="line">  <span class="comment"># https://github.com/maxbube/mydumper/blob/master/docs/mydumper_usage.rst#options</span></span><br><span class="line"><span class="attr">  options:</span> <span class="string">"--verbose=3"</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores user and password used for backup</span></span><br><span class="line">  <span class="comment"># Note: you must give the user enough privilege to do the backup</span></span><br><span class="line">  <span class="comment"># you can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic backup-secret --from-literal=user=root --from-literal=password=&lt;password&gt;</span></span><br><span class="line"><span class="attr">  secretName:</span> <span class="string">backup-secret</span></span><br><span class="line">  <span class="comment"># backup to gcp</span></span><br><span class="line"><span class="attr">  gcp:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores the gcp service account credentials json file</span></span><br><span class="line">  <span class="comment"># The service account must have read/write permission to the above bucket.</span></span><br><span class="line">  <span class="comment"># Read the following document to create the service account and download the credentials file as credentials.json:</span></span><br><span class="line">  <span class="comment"># https://cloud.google.com/docs/authentication/production#obtaining_and_providing_service_account_credentials_manually</span></span><br><span class="line">  <span class="comment"># And then create the secret by: kubectl create secret generic gcp-backup-secret --from-file=./credentials.json</span></span><br><span class="line">  <span class="comment"># secretName: gcp-backup-secret</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># backup to ceph object storage</span></span><br><span class="line"><span class="attr">  ceph:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># endpoint: ""</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores ceph object store access key and secret key</span></span><br><span class="line">  <span class="comment"># You can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic ceph-backup-secret --from-literal=access_key=&lt;access-key&gt; --from-literal=secret_key=&lt;secret-key&gt;</span></span><br><span class="line">  <span class="comment"># secretName: ceph-backup-secret</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># backup to s3</span></span><br><span class="line"><span class="attr">  s3:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># region: ""</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores s3 object store access key and secret key</span></span><br><span class="line">  <span class="comment"># You can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic s3-backup-secret --from-literal=access_key=&lt;access-key&gt; --from-literal=secret_key=&lt;secret-key&gt;</span></span><br><span class="line">  <span class="comment"># secretName: s3-backup-secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metaInstance:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">metaType:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.type &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">metaValue:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><h2 id="部署Cluster"><a href="#部署Cluster" class="headerlink" title="部署Cluster"></a>部署Cluster</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install pingcap/tidb-cluster \</span><br><span class="line">     --name=tidb-cluster \</span><br><span class="line">     --namespace=tidb \</span><br><span class="line">     --version=v1.0.0 \</span><br><span class="line">     -f /home/tidb/tidb-cluster/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Cluster部署情况"><a href="#查看Cluster部署情况" class="headerlink" title="查看Cluster部署情况"></a>查看Cluster部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get pods -l app.kubernetes.io/instance=tidb-cluster</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">tidb-cluster-discovery-84d6cf454c-6c2cl   1/1     Running   0          77m</span><br><span class="line">tidb-cluster-monitor-77cd9d7965-49v8t     3/3     Running   0          77m</span><br><span class="line">tidb-cluster-pd-0                         1/1     Running   0          23m</span><br><span class="line">tidb-cluster-pd-1                         1/1     Running   0          72m</span><br><span class="line">tidb-cluster-pd-2                         1/1     Running   0          72m</span><br><span class="line">tidb-cluster-tidb-0                       2/2     Running   0          2m11s</span><br><span class="line">tidb-cluster-tidb-1                       2/2     Running   0          2m2s</span><br><span class="line">tidb-cluster-tidb-2                       2/2     Running   0          100s</span><br><span class="line">tidb-cluster-tikv-0                       1/1     Running   0          8m56s</span><br><span class="line">tidb-cluster-tikv-1                       1/1     Running   0          8m54s</span><br><span class="line">tidb-cluster-tikv-2                       1/1     Running   0          8m52s</span><br></pre></td></tr></table></figure><h1 id="访问TiDB"><a href="#访问TiDB" class="headerlink" title="访问TiDB"></a>访问TiDB</h1><blockquote><p>TiDB兼容MySQL，因此能直接使用MySQL客户端连接TiDB集群</p><p>这里使用<code>mysql-community-client-5.7.27-1.el7</code>作为客户端程序</p></blockquote><h2 id="获取TiDB-Service信息"><a href="#获取TiDB-Service信息" class="headerlink" title="获取TiDB Service信息"></a>获取TiDB Service信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get svc -l app.kubernetes.io/component=tidb</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">tidb-cluster-tidb        NodePort    10.96.129.51   &lt;none&gt;        4000:30944/TCP,10080:32052/TCP   85m</span><br><span class="line">tidb-cluster-tidb-peer   ClusterIP   None           &lt;none&gt;        10080/TCP                        19m</span><br></pre></td></tr></table></figure><p>从输出示例，可以看到<code>tidb-cluster-tidb</code>是<code>NodePort</code>类型，业务端口<code>4000</code>被映射为节点的<code>30944</code>端口，直接通过此端口即可访问TiDB。</p><h2 id="登录TiDB"><a href="#登录TiDB" class="headerlink" title="登录TiDB"></a>登录TiDB</h2><p>默认集群部署完成后，root用户是无密码的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -P 30944 -h k8s-master</span><br></pre></td></tr></table></figure><h2 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h2><h3 id="查看系统表mysql-tidb"><a href="#查看系统表mysql-tidb" class="headerlink" title="查看系统表mysql.tidb"></a>查看系统表mysql.tidb</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select VARIABLE_NAME,VARIABLE_VALUE from mysql.tidb;</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| VARIABLE_NAME            | VARIABLE_VALUE                                                                                   |</span><br><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| bootstrapped             | True                                                                                             |</span><br><span class="line">| tidb_server_version      | 33                                                                                               |</span><br><span class="line">| system_tz                | Asia/Shanghai                                                                                    |</span><br><span class="line">| tikv_gc_leader_uuid      | 5b16245c9840001                                                                                  |</span><br><span class="line">| tikv_gc_leader_desc      | host:tidb-cluster-tidb-0, pid:1, start at 2019-08-04 01:40:22.757972817 +0800 CST m=+0.859764216 |</span><br><span class="line">| tikv_gc_leader_lease     | 20190804-01:58:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_enable           | true                                                                                             |</span><br><span class="line">| tikv_gc_run_interval     | 10m0s                                                                                            |</span><br><span class="line">| tikv_gc_life_time        | 10m0s                                                                                            |</span><br><span class="line">| tikv_gc_last_run_time    | 20190804-01:48:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_safe_point       | 20190804-01:38:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_auto_concurrency | true                                                                                             |</span><br><span class="line">| tikv_gc_mode             | distributed                                                                                      |</span><br><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="查看系统变量"><a href="#查看系统变量" class="headerlink" title="查看系统变量"></a>查看系统变量</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like '%tidb%';</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">| Variable_name                       | Value                 |</span><br><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">| tidb_optimizer_selectivity_level    | 0                     |</span><br><span class="line">| tidb_slow_log_threshold             | 300                   |</span><br><span class="line">| tidb_distsql_scan_concurrency       | 15                    |</span><br><span class="line">| tidb_check_mb4_value_in_utf8        | 1                     |</span><br><span class="line">| tidb_checksum_table_concurrency     | 4                     |</span><br><span class="line">| tidb_query_log_max_len              | 2048                  |</span><br><span class="line">| tidb_mem_quota_sort                 | 34359738368           |</span><br><span class="line">| tidb_low_resolution_tso             | 0                     |</span><br><span class="line">| tidb_skip_utf8_check                | 0                     |</span><br><span class="line">| tidb_constraint_check_in_place      | 0                     |</span><br><span class="line">| tidb_snapshot                       |                       |</span><br><span class="line">| tidb_current_ts                     | 0                     |</span><br><span class="line">| tidb_opt_write_row_id               | 0                     |</span><br><span class="line">| tidb_opt_join_reorder_threshold     | 0                     |</span><br><span class="line">| tidb_build_stats_concurrency        | 4                     |</span><br><span class="line">| tidb_mem_quota_topn                 | 34359738368           |</span><br><span class="line">| tidb_batch_insert                   | 0                     |</span><br><span class="line">| tidb_config                         |                       |</span><br><span class="line">| tidb_batch_delete                   | 0                     |</span><br><span class="line">| tidb_opt_correlation_exp_factor     | 1                     |</span><br><span class="line">| tidb_auto_analyze_ratio             | 0.5                   |</span><br><span class="line">| tidb_index_serial_scan_concurrency  | 1                     |</span><br><span class="line">| tidb_ddl_error_count_limit          | 512                   |</span><br><span class="line">| tidb_batch_commit                   | 0                     |</span><br><span class="line">| tidb_wait_split_region_timeout      | 300                   |</span><br><span class="line">| tidb_mem_quota_query                | 34359738368           |</span><br><span class="line">| tidb_dml_batch_size                 | 20000                 |</span><br><span class="line">| tidb_mem_quota_mergejoin            | 34359738368           |</span><br><span class="line">| tidb_projection_concurrency         | 4                     |</span><br><span class="line">| tidb_index_join_batch_size          | 25000                 |</span><br><span class="line">| tidb_wait_split_region_finish       | 1                     |</span><br><span class="line">| tidb_back_off_weight                | 2                     |</span><br><span class="line">| tidb_enable_fast_analyze            | 0                     |</span><br><span class="line">| tidb_skip_isolation_level_check     | 0                     |</span><br><span class="line">| tidb_mem_quota_hashjoin             | 34359738368           |</span><br><span class="line">| tidb_hash_join_concurrency          | 5                     |</span><br><span class="line">| tidb_scatter_region                 | 0                     |</span><br><span class="line">| tidb_enable_window_function         | 1                     |</span><br><span class="line">| tidb_max_chunk_size                 | 1024                  |</span><br><span class="line">| tidb_enable_cascades_planner        | 0                     |</span><br><span class="line">| tidb_ddl_reorg_batch_size           | 1024                  |</span><br><span class="line">| tidb_txn_mode                       |                       |</span><br><span class="line">| tidb_opt_correlation_threshold      | 0.9                   |</span><br><span class="line">| tidb_hashagg_final_concurrency      | 4                     |</span><br><span class="line">| tidb_opt_agg_push_down              | 0                     |</span><br><span class="line">| tidb_index_lookup_concurrency       | 4                     |</span><br><span class="line">| tidb_enable_table_partition         | auto                  |</span><br><span class="line">| tidb_auto_analyze_end_time          | 23:59 +0000           |</span><br><span class="line">| tidb_index_lookup_size              | 20000                 |</span><br><span class="line">| tidb_hashagg_partial_concurrency    | 4                     |</span><br><span class="line">| tidb_opt_insubq_to_join_and_agg     | 1                     |</span><br><span class="line">| tidb_ddl_reorg_worker_cnt           | 16                    |</span><br><span class="line">| tidb_mem_quota_indexlookupreader    | 34359738368           |</span><br><span class="line">| tidb_mem_quota_indexlookupjoin      | 34359738368           |</span><br><span class="line">| tidb_mem_quota_nestedloopapply      | 34359738368           |</span><br><span class="line">| tidb_general_log                    | 0                     |</span><br><span class="line">| tidb_force_priority                 | NO_PRIORITY           |</span><br><span class="line">| tidb_enable_streaming               | 0                     |</span><br><span class="line">| tidb_retry_limit                    | 10                    |</span><br><span class="line">| tidb_enable_radix_join              | 0                     |</span><br><span class="line">| tidb_ddl_reorg_priority             | PRIORITY_LOW          |</span><br><span class="line">| tidb_backoff_lock_fast              | 100                   |</span><br><span class="line">| tidb_auto_analyze_start_time        | 00:00 +0000           |</span><br><span class="line">| tidb_init_chunk_size                | 32                    |</span><br><span class="line">| tidb_expensive_query_time_threshold | 60                    |</span><br><span class="line">| tidb_disable_txn_auto_retry         | 1                     |</span><br><span class="line">| tidb_slow_query_file                | /var/log/tidb/slowlog |</span><br><span class="line">| tidb_index_lookup_join_concurrency  | 4                     |</span><br><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">68 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><h1 id="查看监控信息"><a href="#查看监控信息" class="headerlink" title="查看监控信息"></a>查看监控信息</h1><ul><li>TiDB 通过 Prometheus 和 Grafana 监控 TiDB 集群。</li><li>在通过 TiDB Operator 创建新的 TiDB 集群时，对于每个 TiDB 集群，会同时创建、配置一套独立的监控系统，与 TiDB 集群运行在同一 Namespace，包括 Prometheus 和 Grafana 两个组件。</li><li>监控数据默认没有持久化，如果由于某些原因监控容器重启，已有的监控数据会丢失。可以在 <code>values.yaml</code> 中设置 <code>monitor.persistent</code> 为 <code>true</code> 来持久化监控数据。</li></ul><h2 id="获取监控端口"><a href="#获取监控端口" class="headerlink" title="获取监控端口"></a>获取监控端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get svc -l app.kubernetes.io/component=monitor</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">tidb-cluster-grafana            NodePort   10.96.136.52    &lt;none&gt;        3000:30009/TCP   93m</span><br><span class="line">tidb-cluster-monitor-reloader   NodePort   10.96.211.160   &lt;none&gt;        9089:31302/TCP   93m</span><br><span class="line">tidb-cluster-prometheus         NodePort   10.96.75.4      &lt;none&gt;        9090:31666/TCP   93m</span><br></pre></td></tr></table></figure><h2 id="访问监控"><a href="#访问监控" class="headerlink" title="访问监控"></a>访问监控</h2><p>可以看到监控服务都是NodePort类型，直接通过节点端口即可访问监控服务</p><h1 id="更新和升级"><a href="#更新和升级" class="headerlink" title="更新和升级"></a>更新和升级</h1><h2 id="TiDB-Operator"><a href="#TiDB-Operator" class="headerlink" title="TiDB-Operator"></a>TiDB-Operator</h2><p>当新版本 tidb-operator 发布，只要更新 <code>values.yaml</code> 中的 <code>operatorImage</code> 然后执行上述命令就可以。但是安全起见，最好从新版本 <code>tidb-operator</code> chart 中获取新版本 <code>values.yaml</code> 并和旧版本 <code>values.yaml</code> 合并生成新的 <code>values.yaml</code>，然后升级。</p><p>TiDB Operator 是用来管理 TiDB 集群的，也就是说，如果 TiDB 集群已经启动并正常运行，你甚至可以停掉 TiDB Operator，而 TiDB 集群仍然能正常工作，直到你需要维护 TiDB 集群，比如伸缩、升级等等。</p><h3 id="升级TiDB-Operator"><a href="#升级TiDB-Operator" class="headerlink" title="升级TiDB-Operator"></a>升级TiDB-Operator</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-operator pingcap/tidb-operator --version=v1.0.0 -f /home/tidb/tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><h3 id="Kubernetes集群版本升级"><a href="#Kubernetes集群版本升级" class="headerlink" title="Kubernetes集群版本升级"></a>Kubernetes集群版本升级</h3><p>当你的 Kubernetes 集群有版本升级，请确保 <code>kubeSchedulerImageTag</code> 与之匹配。默认情况下，这个值是由 Helm 在安装或者升级过程中生成的，要修改它你需要执行 <code>helm upgrade</code>。</p><h2 id="TiDB-Cluster"><a href="#TiDB-Cluster" class="headerlink" title="TiDB-Cluster"></a>TiDB-Cluster</h2><p>滚动更新 TiDB 集群时，会按 PD、TiKV、TiDB 的顺序，串行删除 Pod，并创建新版本的 Pod，当新版本的 Pod 正常运行后，再处理下一个 Pod。</p><p>滚动升级过程会自动处理 PD、TiKV 的 Leader 迁移与 TiDB 的 DDL Owner 迁移。因此，在多节点的部署拓扑下（最小环境：PD <em>3、TiKV </em>3、TiDB * 2），滚动更新 TiKV、PD 不会影响业务正常运行。</p><p>对于有连接重试功能的客户端，滚动更新 TiDB 同样不会影响业务。</p><p>对于无法进行重试的客户端，滚动更新 TiDB 则会导致连接到被关闭节点的数据库连接失效，造成部分业务请求失败。对于这类业务，推荐在客户端添加重试功能或在低峰期进行 TiDB 的滚动升级操作。</p><p>滚动更新可以用于升级 TiDB 版本，也可以用于更新集群配置。</p><h3 id="更新TiDB-Cluster配置"><a href="#更新TiDB-Cluster配置" class="headerlink" title="更新TiDB-Cluster配置"></a>更新TiDB-Cluster配置</h3><p>默认条件下，修改配置文件不会自动应用到 TiDB 集群中，只有在实例重启时，才会重新加载新的配置文件。</p><p><strong>操作步骤如下</strong></p><ol><li><p>修改集群的 <code>values.yaml</code> 文件，将 <code>enableConfigMapRollout</code> 的值设为 <code>true</code></p></li><li><p>修改集群的 <code>values.yaml</code> 文件中需要调整的集群配置项，例如修改<code>pd.replicas</code>、<code>tidb.replicas</code>、<code>tikv.replicas</code>来进行水平扩容和缩容</p></li><li><p>执行<code>helm upgrade</code>命令升级</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-cluster pingcap/tidb-cluster -f /home/tidb/tidb-cluster/values.yaml --version=v1.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看升级进度</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 'kubectl -n tidb get pod -o wide'</span><br></pre></td></tr></table></figure></li></ol><h3 id="升级-TiDB-Cluster-版本"><a href="#升级-TiDB-Cluster-版本" class="headerlink" title="升级 TiDB-Cluster 版本"></a>升级 TiDB-Cluster 版本</h3><ol><li><p>修改集群的 <code>values.yaml</code> 文件中的 <code>tidb.image</code>、<code>tikv.image</code>、<code>pd.image</code> 的值为新版本镜像；</p></li><li><p>执行 <code>helm upgrade</code> 命令进行升级：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-cluster pingcap/tidb-cluster -f /home/tidb/tidb-cluster/values.yaml --version=v1.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看升级进度</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 'kubectl -n tidb get pod -o wide'</span><br></pre></td></tr></table></figure></li></ol><p><strong>注意：</strong></p><ul><li>将 <code>enableConfigMapRollout</code> 特性从关闭状态打开时，即使没有配置变更，也会触发一次 PD、TiKV、TiDB 的滚动更新。</li><li>目前 PD 的 <code>scheduler</code> 和 <code>replication</code> 配置（<code>values.yaml</code> 中的 <code>maxStoreDownTime</code> 和 <code>maxReplicas</code> 字段）在集群安装完成后无法自动更新，需要通过 <a href="https://pingcap.com/docs-cn/v3.0/reference/tools/pd-control" target="_blank" rel="noopener">pd-ctl</a> 手动更新。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;仅记录操作过程和部署过程&lt;/li&gt;&lt;li&gt;操作系统使用的&lt;code&gt;CentOS-7.6.1810 x86_64&lt;/code&gt;&lt;/
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
      <category term="TiDB" scheme="https://luanlengli.github.io/categories/Kubernetes/TiDB/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="TiDB" scheme="https://luanlengli.github.io/tags/TiDB/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes创建本地PV</title>
    <link href="https://luanlengli.github.io/2019/07/23/Kubernetes%E5%88%9B%E5%BB%BA%E6%9C%AC%E5%9C%B0PV.html"/>
    <id>https://luanlengli.github.io/2019/07/23/Kubernetes创建本地PV.html</id>
    <published>2019-07-23T06:21:37.000Z</published>
    <updated>2019-08-07T05:34:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><ul><li>Kubernetes的持久化存储体系里面，提到最多的是对接外部ceph服务或者NFS服务。</li><li>有时候，Kubernetes集群所在的环境不一定提供对应的外部存储服务，而且为了性能的需求（低延迟、高IOPS等），外部基于网络的存储无法很好的满足需求。</li><li>除此之外想把数据存放到宿主机本地硬盘的做法就只有hostPath或者emptyDir，这种做法还是不够科学。</li><li>在Kubernetes社区里面，对本地持久化存储的呼声非常高，因此在v1.10版本引入了<code>Local Persistent Volume</code>即本地PV，然后v1.14版本正式GA。</li><li>本地PV<font color="red">并不适用于所有的应用</font>，因为本地PV是直接跟节点绑定在一起的，如果Pod需要使用本地PV，在Pod调度过程中，会考虑本地PV的分布情况，然后选中有本地PV的节点作为调度目标节点。因此如果本地PV所在节点宕机，则可能会出现数据丢失的情况，需要应用自己能处理节点掉线数据无法访问的情况。</li></ul><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录操作过程和部署过程</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>虚拟机配置<code>4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘B</code></li><li>Kubernetes集群版本<code>v1.14.4</code></li><li>这里演示两种方式管理本地PV<ul><li>手动管理本地PV</li><li>使用社区提供的<code>local-volume-provisioner</code>来简化本地PV的管理</li></ul></li></ul><h1 id="准备步骤"><a href="#准备步骤" class="headerlink" title="准备步骤"></a>准备步骤</h1><p>参考<a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner/blob/master/docs/operations.md" target="_blank" rel="noopener">社区文档</a></p><h2 id="查看硬盘"><a href="#查看硬盘" class="headerlink" title="查看硬盘"></a>查看硬盘</h2><ul><li>20G本地硬盘<code>/dev/sdb</code></li><li>5G本地硬盘<code>/dev/sdc</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  30G  0 disk </span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  29G  0 part /</span><br><span class="line">sdb      8:16   0  20G  0 disk </span><br><span class="line">sdc      8:32   0   5G  0 disk</span><br></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><blockquote><p>作为provisioner发现本地PV的目录</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mnt/disks</span><br></pre></td></tr></table></figure><h2 id="格式化硬盘"><a href="#格式化硬盘" class="headerlink" title="格式化硬盘"></a>格式化硬盘</h2><blockquote><p>注意，这里是一个本地PV对应一个硬盘</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/sdb</span><br><span class="line">mkfs.ext4 /dev/sdc</span><br></pre></td></tr></table></figure><h2 id="获取硬盘UUID"><a href="#获取硬盘UUID" class="headerlink" title="获取硬盘UUID"></a>获取硬盘UUID</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SDB_UUID=$(blkid -s UUID -o value /dev/sdb)</span><br><span class="line">SDC_UUID=$(blkid -s UUID -o value /dev/sdc)</span><br></pre></td></tr></table></figure><h2 id="创建挂载目录"><a href="#创建挂载目录" class="headerlink" title="创建挂载目录"></a>创建挂载目录</h2><blockquote><p>这里使用硬盘UUID作为挂载目录</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mnt/disks/$SDB_UUID</span><br><span class="line">mkdir -p /mnt/disks/$SDC_UUID</span><br></pre></td></tr></table></figure><h2 id="挂载硬盘"><a href="#挂载硬盘" class="headerlink" title="挂载硬盘"></a>挂载硬盘</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -t ext4 /dev/sdb /mnt/disks/$SDB_UUID</span><br><span class="line">mount -t ext4 /dev/sdc /mnt/disks/$SDC_UUID</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  30G  0 disk </span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  29G  0 part /</span><br><span class="line">sdb      8:16   0  20G  0 disk /mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6</span><br><span class="line">sdc      8:32   0   5G  0 disk /mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26</span><br></pre></td></tr></table></figure><h2 id="写入fstab"><a href="#写入fstab" class="headerlink" title="写入fstab"></a>写入fstab</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo "UUID=$&#123;SDB_UUID&#125; /mnt/disks/$&#123;SDB_UUID&#125; ext4 defaults 0 2" | tee -a /etc/fstab</span><br><span class="line">echo "UUID=$&#123;SDC_UUID&#125; /mnt/disks/$&#123;SDC_UUID&#125; ext4 defaults 0 2" | tee -a /etc/fstab</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/fstab</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Created by anaconda on Tue Jun 18 05:24:00 2019</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Accessible filesystems, by reference, are maintained under <span class="string">'/dev/disk'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) <span class="keyword">for</span> more info</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">UUID=f3ca2ebf-a9fe-4cae-a20f-02ff93f2ba0c /                       xfs     defaults        0 0</span><br><span class="line">UUID=3253298b-04d2-47ca-a383-e30b0b1e2267 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=f8727d20-3ef9-4f83-b865-25943bc342a6 /mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6 ext4 defaults 0 2</span><br><span class="line">UUID=9e0ead5f-ca8e-4018-98ad-960979d9cb26 /mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26 ext4 defaults 0 2</span><br></pre></td></tr></table></figure><h2 id="给节点打标签"><a href="#给节点打标签" class="headerlink" title="给节点打标签"></a>给节点打标签</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node k8s-node1 local-pv=present</span><br></pre></td></tr></table></figure><h2 id="检查一下节点标签"><a href="#检查一下节点标签" class="headerlink" title="检查一下节点标签"></a>检查一下节点标签</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node -l local-pv=present</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-node1   Ready    &lt;none&gt;   102m   v1.14.4</span><br></pre></td></tr></table></figure><h1 id="手动管理本地PV"><a href="#手动管理本地PV" class="headerlink" title="手动管理本地PV"></a>手动管理本地PV</h1><h2 id="创建PV"><a href="#创建PV" class="headerlink" title="创建PV"></a>创建PV</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-node1-localpv-20G-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6</span></span><br><span class="line"><span class="attr">  nodeAffinity:</span></span><br><span class="line"><span class="attr">    required:</span></span><br><span class="line"><span class="attr">      nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">      - matchExpressions:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">          values:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">k8s-node1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-node1-localpv-5G-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26</span></span><br><span class="line"><span class="attr">  nodeAffinity:</span></span><br><span class="line"><span class="attr">    required:</span></span><br><span class="line"><span class="attr">      nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">      - matchExpressions:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">          values:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">k8s-node1</span></span><br></pre></td></tr></table></figure><h2 id="创建StorageClass"><a href="#创建StorageClass" class="headerlink" title="创建StorageClass"></a>创建StorageClass</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">storageclass.kubernetes.io/is-default-class:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/no-provisioner</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><h1 id="使用Provisioner管理本地PV"><a href="#使用Provisioner管理本地PV" class="headerlink" title="使用Provisioner管理本地PV"></a>使用Provisioner管理本地PV</h1><h2 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h2><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="安装Helm服务端"><a href="#安装Helm服务端" class="headerlink" title="安装Helm服务端"></a>安装Helm服务端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image gcr.azk8s.cn/google_containers/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h3 id="检查部署结果"><a href="#检查部署结果" class="headerlink" title="检查部署结果"></a>检查部署结果</h3><h4 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h4 id="查看Helm版本信息"><a href="#查看Helm版本信息" class="headerlink" title="查看Helm版本信息"></a>查看Helm版本信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h2 id="部署local-volume-provisioner"><a href="#部署local-volume-provisioner" class="headerlink" title="部署local-volume-provisioner"></a>部署local-volume-provisioner</h2><h3 id="下载项目代码"><a href="#下载项目代码" class="headerlink" title="下载项目代码"></a>下载项目代码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner.git</span><br></pre></td></tr></table></figure><h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim sig-storage-local-static-provisioner/helm/provisioner/value.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Common options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">common:</span></span><br><span class="line"><span class="attr">  rbac:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  createNamespace:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  useAlphaAPI:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  setPVOwnerRef:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  useJobForCleaning:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  useNodeNameOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  minResyncPeriod:</span> <span class="number">5</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">  configMapName:</span> <span class="string">"local-provisioner-config"</span></span><br><span class="line"><span class="attr">  podSecurityPolicy:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Configure storage classes.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">classes:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  hostDir:</span> <span class="string">/mnt/disks</span></span><br><span class="line"><span class="attr">  mountDir:</span> <span class="string">/mnt/disks</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="attr">  fsType:</span> <span class="string">ext4</span></span><br><span class="line"><span class="attr">  blockCleanerCommand:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"/scripts/fsclean.sh"</span></span><br><span class="line"><span class="attr">  storageClass:</span></span><br><span class="line"><span class="attr">    reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">    isDefaultClass:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Configure DaemonSet for provisioner.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">daemonset:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">"local-volume-provisioner"</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">quay.io/external_storage/local-volume-provisioner:v2.3.2</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">local-storage-admin</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Configure Prometheus monitoring</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">prometheus:</span></span><br><span class="line"><span class="attr">  operator:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="生成YAML文件"><a href="#生成YAML文件" class="headerlink" title="生成YAML文件"></a>生成YAML文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm template sig-storage-local-static-provisioner/helm/provisioner \</span><br><span class="line">             -f sig-storage-local-static-provisioner/helm/provisioner/value.yaml \</span><br><span class="line">             &gt; local-volume-provisioner.generated.yaml</span><br></pre></td></tr></table></figure><h3 id="部署YAML文件"><a href="#部署YAML文件" class="headerlink" title="部署YAML文件"></a>部署YAML文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f local-volume-provisioner.generated.yaml</span><br></pre></td></tr></table></figure><h3 id="查看provisioner"><a href="#查看provisioner" class="headerlink" title="查看provisioner"></a>查看provisioner</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=local-volume-provisioner</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">local-volume-provisioner-cj242   1/1     Running   0          40s</span><br></pre></td></tr></table></figure><h1 id="验证本地PV"><a href="#验证本地PV" class="headerlink" title="验证本地PV"></a>验证本地PV</h1><h2 id="查看PersistentVolume"><a href="#查看PersistentVolume" class="headerlink" title="查看PersistentVolume"></a>查看PersistentVolume</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS    REASON   AGE</span><br><span class="line">local-pv-40a9a025   19Gi       RWO            Retain           Available           local-storage            32s</span><br><span class="line">local-pv-6e9321fd   4911Mi     RWO            Retain           Available           local-storage            32s</span><br></pre></td></tr></table></figure><h2 id="查看StorageClass"><a href="#查看StorageClass" class="headerlink" title="查看StorageClass"></a>查看StorageClass</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sc</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                      PROVISIONER                    AGE</span><br><span class="line">local-storage (default)   kubernetes.io/no-provisioner   8m44s</span><br></pre></td></tr></table></figure><h2 id="部署StatefulSet"><a href="#部署StatefulSet" class="headerlink" title="部署StatefulSet"></a>部署StatefulSet</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim localpv-sts.yaml</span><br></pre></td></tr></table></figure><blockquote><p>内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">local-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">"local-service"</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">local-test</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">local-test</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">test-container</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">k8s.gcr.io/busybox</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"/bin/sh"</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"-c"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"count=0; count_file=\"/usr/test-pod/count\"; test_file=\"/usr/test-pod/test_file\"; if [ -e $count_file ]; then count=$(cat $count_file); fi; echo $((count+1)) &gt; $count_file; while [ 1 ]; do date &gt;&gt; $test_file; echo \"This is $MY_POD_NAME, count=$(cat $count_file)\" &gt;&gt; $test_file; sleep 10; done"</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">local-vol</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/test-pod</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1234</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">  - metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">local-vol</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">"local-storage"</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><h2 id="查看PV"><a href="#查看PV" class="headerlink" title="查看PV"></a>查看PV</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                            STORAGECLASS    REASON   AGE</span><br><span class="line">local-pv-6e9321fd   4911Mi     RWO            Retain           Bound       default/local-vol-local-test-0   local-storage            14m</span><br></pre></td></tr></table></figure><h2 id="查看PVC"><a href="#查看PVC" class="headerlink" title="查看PVC"></a>查看PVC</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pvc</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local-vol-local-test-0   Bound    local-pv-6e9321fd   4911Mi     RWO            local-storage   2m27s</span><br></pre></td></tr></table></figure><h1 id="清理现场"><a href="#清理现场" class="headerlink" title="清理现场"></a>清理现场</h1><h2 id="删除StatefulSet"><a href="#删除StatefulSet" class="headerlink" title="删除StatefulSet"></a>删除StatefulSet</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f localpv-sts.yaml</span><br></pre></td></tr></table></figure><h2 id="删除pvc"><a href="#删除pvc" class="headerlink" title="删除pvc"></a>删除pvc</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pvc local-vol-local-test-0</span><br></pre></td></tr></table></figure><h2 id="删除pv"><a href="#删除pv" class="headerlink" title="删除pv"></a>删除pv</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pv local-pv-6e9321fd</span><br></pre></td></tr></table></figure><h2 id="清理本地目录"><a href="#清理本地目录" class="headerlink" title="清理本地目录"></a>清理本地目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@k8s-node1 "rm -rf /mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26/*"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前情提要&quot;&gt;&lt;a href=&quot;#前情提要&quot; class=&quot;headerlink&quot; title=&quot;前情提要&quot;&gt;&lt;/a&gt;前情提要&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Kubernetes的持久化存储体系里面，提到最多的是对接外部ceph服务或者NFS服务。&lt;/li&gt;&lt;li&gt;有时候
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Windows Server 2019安装Docker</title>
    <link href="https://luanlengli.github.io/2019/07/10/Windows-Server-2019%E5%AE%89%E8%A3%85Docker.html"/>
    <id>https://luanlengli.github.io/2019/07/10/Windows-Server-2019安装Docker.html</id>
    <published>2019-07-10T03:09:36.000Z</published>
    <updated>2019-07-10T13:54:56.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>Windows Server 从2016开始就已经支持Docker容器，这里以最新的2019作为演示，仅供参考</li><li>系统镜像<a href="ed2k://|file|cn_windows_server_2019_x64_dvd_4de40f33.iso|5086887936|7DCDDD6B0C60A0D019B6A93D8F2B6D31|/" target="_blank" rel="noopener">cn_windows_server_2019_x64_dvd_4de40f33.iso</a></li><li>Docker版本<code>18.09.7</code></li><li>参考文档<a href="https://docs.microsoft.com/zh-cn/virtualization/windowscontainers/deploy-containers/deploy-containers-on-server" target="_blank" rel="noopener">部署容器主机</a></li></ul><h1 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h1><blockquote><p>这里为了节省资源，没有选择桌面体验</p><p>可以自己根据需求选择对应的操作系统版本</p></blockquote><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-20-54.png" alt=""></p><h1 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h1><blockquote><p>在powershell或者cmd里面运行命令，打开服务器配置界面</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sconfig.cmd</span><br></pre></td></tr></table></figure><blockquote><p>界面示意图</p></blockquote><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-29-05.png" alt=""></p><h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h2><blockquote><p>可以根据需要修改对应的配置，这里只做以下几项</p></blockquote><ul><li><code>网络设置</code>，配置网络，安装docker需要访问公网<ul><li>配置IP地址</li><li>配置网关</li><li>配置DNS</li></ul></li></ul><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-33-48.png" alt=""></p><ul><li><code>Windows 更新设置</code>，安装docker前需要更新Windows<ul><li>修改为<code>手动更新</code></li><li>选择<code>下载并安装更新</code></li><li>在弹出命令窗口里面选择<code>搜索所有的更新</code></li><li>选择<code>安装所有更新</code></li><li>安装完成之后重启系统</li></ul></li></ul><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-51-55.png" alt=""></p><h2 id="启用Hyper-V和Containers功能"><a href="#启用Hyper-V和Containers功能" class="headerlink" title="启用Hyper-V和Containers功能"></a>启用Hyper-V和Containers功能</h2><blockquote><p>运行管理员权限powershell</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-WindowsFeature -Name Hyper-V,Containers -IncludeAllSubFeature -IncludeManagementTools -Verbose</span><br></pre></td></tr></table></figure><blockquote><p>安装完成之后重启操作系统</p></blockquote><h2 id="配置安装源"><a href="#配置安装源" class="headerlink" title="配置安装源"></a>配置安装源</h2><blockquote><p>运行管理员权限powershell</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name DockerMsftProvider -Repository PSGallery -Verbose</span><br></pre></td></tr></table></figure><h2 id="安装Docker-1"><a href="#安装Docker-1" class="headerlink" title="安装Docker"></a>安装Docker</h2><blockquote><p>运行管理员权限powershell，国内安装可能会因为网络原因失败，可以尝试手动安装</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package -Name docker -ProviderName DockerMsftProvider -Verbose</span><br></pre></td></tr></table></figure><h2 id="手动安装Docker"><a href="#手动安装Docker" class="headerlink" title="手动安装Docker"></a>手动安装Docker</h2><blockquote><p>运行管理员权限powershell</p></blockquote><ul><li>下载docker压缩包</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WebRequest</span> -UseBasicParsing -OutFile C:\docker-<span class="number">18.09</span>.<span class="number">7</span>.zip https://download.docker.com/components/engine/windows-server/<span class="number">18.09</span>/docker-<span class="number">18.09</span>.<span class="number">7</span>.zip</span><br></pre></td></tr></table></figure><ul><li>解压</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Expand-Archive C:\docker-<span class="number">18.09</span>.<span class="number">7</span>.zip -DestinationPath <span class="variable">$Env:ProgramFiles</span> -Force</span><br></pre></td></tr></table></figure><ul><li>删除压缩包</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Remove-Item</span> -Force C:\docker-<span class="number">18.09</span>.<span class="number">7</span>.zip</span><br></pre></td></tr></table></figure><ul><li>为当前会话添加PATH变量</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env:path</span> += <span class="string">";<span class="variable">$env:ProgramFiles</span>\docker"</span></span><br></pre></td></tr></table></figure><ul><li>配置新的PATH变量</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$newPath</span> = <span class="string">"<span class="variable">$env:ProgramFiles</span>\docker;"</span> + [System.Environment]::GetEnvironmentVariable(<span class="string">"PATH"</span>, [System.EnvironmentVariableTarget]::Machine)</span><br></pre></td></tr></table></figure><ul><li>将系统PATH变量替换为新的PATH变量</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[System.Environment]::SetEnvironmentVariable(<span class="string">"PATH"</span>, <span class="variable">$newPath</span>, [System.EnvironmentVariableTarget]::Machine)</span><br></pre></td></tr></table></figure><ul><li>注册为系统服务</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerd --register-service</span><br></pre></td></tr></table></figure><ul><li>设置Docker开机启动</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-Service</span> -Name docker -StartupType Automatic</span><br></pre></td></tr></table></figure><ul><li>启动Docker</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Start-Service</span> docker</span><br></pre></td></tr></table></figure><h1 id="验证Docker"><a href="#验证Docker" class="headerlink" title="验证Docker"></a>验证Docker</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container run hello-world:nanoserver</span><br></pre></td></tr></table></figure><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-20-29-33.png" alt=""></p><h1 id="配置Docker"><a href="#配置Docker" class="headerlink" title="配置Docker"></a>配置Docker</h1><p>在微软的官方网站上是有<a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-docker/configure-docker-daemon" target="_blank" rel="noopener">相关文档</a>的</p><h2 id="配置文件路径"><a href="#配置文件路径" class="headerlink" title="配置文件路径"></a>配置文件路径</h2><p><code>C:\ProgramData\Docker\config\daemon.json</code></p><h2 id="配置文件模板"><a href="#配置文件模板" class="headerlink" title="配置文件模板"></a>配置文件模板</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"dns"</span>: [</span><br><span class="line">        <span class="string">"114.114.114.114"</span>,</span><br><span class="line">        <span class="string">"8.8.8.8"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"storage-opts"</span>: [</span><br><span class="line">        <span class="string">"size=50GB"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"data-root"</span>: <span class="string">"c:\programdata\docker"</span>,</span><br><span class="line">    <span class="attr">"bridge"</span>: <span class="string">"NAT"</span>,</span><br><span class="line">    <span class="attr">"registry-mirrors"</span>: [</span><br><span class="line">        <span class="string">"https://registry.docker-cn.com"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"insecure-registries"</span>: [],</span><br><span class="line">    <span class="attr">"experimental"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="启用Linux容器支持"><a href="#启用Linux容器支持" class="headerlink" title="启用Linux容器支持"></a>启用Linux容器支持</h1><blockquote><p>目前Windows的container只支持Windows程序，运行Linux容器需要使用Hyper-V运行容器</p></blockquote><p>参考文献<a href="https://bcthomas.com/2019/02/getting-started-with-linux-containers-on-windows-server-2019/" target="_blank" rel="noopener">Getting started with Linux Containers on Windows Server 2019</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Windows Server 从2016开始就已经支持Docker容器，这里以最新的2019作为演示，仅供参考&lt;/li&gt;&lt;li&gt;系
      
    
    </summary>
    
      <category term="Docker" scheme="https://luanlengli.github.io/categories/Docker/"/>
    
      <category term="Windows" scheme="https://luanlengli.github.io/categories/Docker/Windows/"/>
    
    
      <category term="Windows" scheme="https://luanlengli.github.io/tags/Windows/"/>
    
      <category term="Docker" scheme="https://luanlengli.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes安装Helm和使用</title>
    <link href="https://luanlengli.github.io/2019/07/05/Kubernetes%E5%AE%89%E8%A3%85Helm%E5%92%8C%E4%BD%BF%E7%94%A8.html"/>
    <id>https://luanlengli.github.io/2019/07/05/Kubernetes安装Helm和使用.html</id>
    <published>2019-07-05T12:31:33.000Z</published>
    <updated>2019-08-05T13:18:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="部署Helm"><a href="#部署Helm" class="headerlink" title="部署Helm"></a>部署Helm</h1><h2 id="获取Helm"><a href="#获取Helm" class="headerlink" title="获取Helm"></a>获取Helm</h2><p><a href="https://github.com/helm/helm" target="_blank" rel="noopener">Github项目地址</a></p><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="通过官方脚本安装"><a href="#通过官方脚本安装" class="headerlink" title="通过官方脚本安装"></a>通过官方脚本安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://git.io/get_helm.sh | bash</span><br></pre></td></tr></table></figure><h2 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装Helm服务端"><a href="#安装Helm服务端" class="headerlink" title="安装Helm服务端"></a>安装Helm服务端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image dockerhub.azk8s.cn/gcrxio/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h2 id="检查部署结果"><a href="#检查部署结果" class="headerlink" title="检查部署结果"></a>检查部署结果</h2><h3 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h3 id="查看Helm版本信息"><a href="#查看Helm版本信息" class="headerlink" title="查看Helm版本信息"></a>查看Helm版本信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h1 id="使用Helm"><a href="#使用Helm" class="headerlink" title="使用Helm"></a>使用Helm</h1><h2 id="命令自动补齐"><a href="#命令自动补齐" class="headerlink" title="命令自动补齐"></a>命令自动补齐</h2><h3 id="临时生效"><a href="#临时生效" class="headerlink" title="临时生效"></a>临时生效</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &lt;$(helm compeltion bash)</span><br></pre></td></tr></table></figure><h3 id="永久生效"><a href="#永久生效" class="headerlink" title="永久生效"></a>永久生效</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm compeltion bash &gt; /etc/bash_completions./helm</span><br><span class="line">source /etc/profile.d/bash_completion.sh</span><br></pre></td></tr></table></figure><h2 id="查看Chart"><a href="#查看Chart" class="headerlink" title="查看Chart"></a>查看Chart</h2><p><a href="https://hub.helm.sh/charts" target="_blank" rel="noopener">https://hub.helm.sh/charts</a></p><h2 id="查看Repo"><a href="#查看Repo" class="headerlink" title="查看Repo"></a>查看Repo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME   URL                                              </span><br><span class="line">local  http://127.0.0.1:8879/charts                     </span><br><span class="line">stable https://kubernetes-charts.storage.googleapis.com/</span><br></pre></td></tr></table></figure><h2 id="添加Repo"><a href="#添加Repo" class="headerlink" title="添加Repo"></a>添加Repo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add pingcap &lt;Chart-URL&gt;</span><br></pre></td></tr></table></figure><h2 id="更新Repo缓存"><a href="#更新Repo缓存" class="headerlink" title="更新Repo缓存"></a>更新Repo缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure><h2 id="查看Repo里的Chart"><a href="#查看Repo里的Chart" class="headerlink" title="查看Repo里的Chart"></a>查看Repo里的Chart</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search &lt;Chart-Name&gt; -l</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm search stable -l</span><br><span class="line">NAME                                 CHART VERSIONAPP VERSION                     DESCRIPTION                                                 </span><br><span class="line">stable/acs-engine-autoscaler         2.2.2        2.1.1                           DEPRECATED Scales worker nodes within agent pools           </span><br><span class="line">stable/acs-engine-autoscaler         2.2.1        2.1.1                           Scales worker nodes within agent pools</span><br></pre></td></tr></table></figure><h2 id="查找Chart"><a href="#查找Chart" class="headerlink" title="查找Chart"></a>查找Chart</h2><blockquote><p>这里以redis作为关键字</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search redis</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                            CHART VERSIONAPP VERSIONDESCRIPTION                                                 </span><br><span class="line">stable/prometheus-redis-exporter3.0.0        1.0.3      Prometheus exporter for Redis metrics                       </span><br><span class="line">stable/redis                    9.0.1        5.0.5      Open source, advanced key-value store. It is often referr...</span><br><span class="line">stable/redis-ha                 3.6.2        5.0.5      Highly available Kubernetes implementation of Redis         </span><br><span class="line">stable/sensu                    0.2.3        0.28       Sensu monitoring framework backed by the Redis transpor</span><br></pre></td></tr></table></figure><h2 id="下载Chart"><a href="#下载Chart" class="headerlink" title="下载Chart"></a>下载Chart</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm fetch stable/redis --version=9.0.1</span><br></pre></td></tr></table></figure><h2 id="查看Chart文件结构"><a href="#查看Chart文件结构" class="headerlink" title="查看Chart文件结构"></a>查看Chart文件结构</h2><h3 id="解压Chart"><a href="#解压Chart" class="headerlink" title="解压Chart"></a>解压Chart</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf redis-9.0.1.tgz</span><br></pre></td></tr></table></figure><h3 id="查看目录结构"><a href="#查看目录结构" class="headerlink" title="查看目录结构"></a>查看目录结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree redis</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── ci</span><br><span class="line">│   ├── default-values.yaml</span><br><span class="line">│   ├── dev-values.yaml</span><br><span class="line">│   ├── extra-flags-values.yaml</span><br><span class="line">│   ├── production-sentinel-values.yaml</span><br><span class="line">│   ├── production-values.yaml</span><br><span class="line">│   ├── redisgraph-module-values.yaml</span><br><span class="line">│   └── redis-lib-values.yaml</span><br><span class="line">├── README.md</span><br><span class="line">├── templates</span><br><span class="line">│   ├── configmap.yaml</span><br><span class="line">│   ├── headless-svc.yaml</span><br><span class="line">│   ├── health-configmap.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── metrics-prometheus.yaml</span><br><span class="line">│   ├── metrics-svc.yaml</span><br><span class="line">│   ├── networkpolicy.yaml</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── redis-master-statefulset.yaml</span><br><span class="line">│   ├── redis-master-svc.yaml</span><br><span class="line">│   ├── redis-rolebinding.yaml</span><br><span class="line">│   ├── redis-role.yaml</span><br><span class="line">│   ├── redis-serviceaccount.yaml</span><br><span class="line">│   ├── redis-slave-statefulset.yaml</span><br><span class="line">│   ├── redis-slave-svc.yaml</span><br><span class="line">│   ├── redis-with-sentinel-svc.yaml</span><br><span class="line">│   └── secret.yaml</span><br><span class="line">├── values-production.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure><h2 id="使用Helm安装Chart"><a href="#使用Helm安装Chart" class="headerlink" title="使用Helm安装Chart"></a>使用Helm安装Chart</h2><p>帮助文档里面是这么描述的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. By chart reference: helm install stable/mariadb</span><br><span class="line">2. By path to a packaged chart: helm install ./nginx-1.2.3.tgz</span><br><span class="line">3. By path to an unpacked chart directory: helm install ./nginx</span><br><span class="line">4. By absolute URL: helm install https://example.com/charts/nginx-1.2.3.tgz</span><br><span class="line">5. By chart reference and repo url: helm install --repo https://example.com/charts/ nginx</span><br></pre></td></tr></table></figure><h3 id="直接安装"><a href="#直接安装" class="headerlink" title="直接安装"></a>直接安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/redis --name=helm-redis --namespace=default --version=9.0.1</span><br></pre></td></tr></table></figure><h3 id="安装时指定变量"><a href="#安装时指定变量" class="headerlink" title="安装时指定变量"></a>安装时指定变量</h3><blockquote><p>具体的变量定义在Chart目录下的<code>values.yaml</code>文件里面有</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/redis \</span><br><span class="line">     --name=helm-redis \</span><br><span class="line">     --namesapce=default \</span><br><span class="line">     --version=9.0.1 \</span><br><span class="line">     --set image.registry=docker.io \</span><br><span class="line">     --set image.repository=bitnami/redis \</span><br><span class="line">     --set image.tag=5.0.5-debian-9-r36</span><br></pre></td></tr></table></figure><h3 id="安装时指定变量文件"><a href="#安装时指定变量文件" class="headerlink" title="安装时指定变量文件"></a>安装时指定变量文件</h3><blockquote><p>按需修改Chart目录下<code>values.yaml</code>文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/redis \</span><br><span class="line">     --name=helm-redis \</span><br><span class="line">     --namesapce=default \</span><br><span class="line">     --version=9.0.1 \</span><br><span class="line">     -f redis/values.yaml</span><br></pre></td></tr></table></figure><h2 id="列出Release"><a href="#列出Release" class="headerlink" title="列出Release"></a>列出Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm list --all</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                UPDATED                     CHART</span><br><span class="line">helm-redis          Mon May  9 16:07:08 2019    redis-9.0.1</span><br></pre></td></tr></table></figure><h2 id="更新Release"><a href="#更新Release" class="headerlink" title="更新Release"></a>更新Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade helm-redis stable/redis -f redis/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Release历史"><a href="#查看Release历史" class="headerlink" title="查看Release历史"></a>查看Release历史</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm <span class="built_in">history</span> helm-redis</span><br><span class="line">REVISION        UPDATED                         STATUS          CHART                   DESCRIPTION</span><br><span class="line">1               Mon Apr 16 10:21:44 2019        SUPERSEDED      stable/redis-9.0.1     Install complete</span><br><span class="line">2               Mon Apr 16 10:43:10 2019        DEPLOYED        stable/redis-9.0.1     Upgrade complete</span><br></pre></td></tr></table></figure><h2 id="回滚Release"><a href="#回滚Release" class="headerlink" title="回滚Release"></a>回滚Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm rollback helm-redis 1</span><br></pre></td></tr></table></figure><h2 id="删除Release"><a href="#删除Release" class="headerlink" title="删除Release"></a>删除Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete helm-redis</span><br></pre></td></tr></table></figure><ul><li>彻底删除</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete --purge helm-redis</span><br></pre></td></tr></table></figure><h2 id="通过模板功能生成YAML文件"><a href="#通过模板功能生成YAML文件" class="headerlink" title="通过模板功能生成YAML文件"></a>通过模板功能生成YAML文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm template stable/redis \</span><br><span class="line">     --name=helm-redis \</span><br><span class="line">     --namesapce=default \</span><br><span class="line">     --version=9.0.1 \</span><br><span class="line">     -f redis/values.yaml &gt; helm_redis_generated.yaml</span><br></pre></td></tr></table></figure><blockquote><p>此方法生成的YAML文件可以通过kubectl命令进行部署</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;部署Helm&quot;&gt;&lt;a href=&quot;#部署Helm&quot; class=&quot;headerlink&quot; title=&quot;部署Helm&quot;&gt;&lt;/a&gt;部署Helm&lt;/h1&gt;&lt;h2 id=&quot;获取Helm&quot;&gt;&lt;a href=&quot;#获取Helm&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>通过Linux capabilities机制让kong监听80和443端口</title>
    <link href="https://luanlengli.github.io/2019/07/05/%E9%80%9A%E8%BF%87Linux%20capabilities%E6%9C%BA%E5%88%B6%E8%AE%A9kong%E7%9B%91%E5%90%AC80%E5%92%8C443%E7%AB%AF%E5%8F%A3.html"/>
    <id>https://luanlengli.github.io/2019/07/05/通过Linux capabilities机制让kong监听80和443端口.html</id>
    <published>2019-07-05T02:09:51.000Z</published>
    <updated>2019-07-05T04:27:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>在做kong容器实验的时候，发现kong数据平面默认监听的端口是8000和8443，非常难受。</p><p>通过容器启动时声明环境变量的方式，将数据平面监听端口改成了80和443，但是启动时提示<code>[nginx: [emerg] bind() to 0.0.0.0:80 failed (13: permission denied)]</code>。</p><p>在<a href="https://luanlengli.github.io/2019/05/29/Kong-API网关搭建部署记录.html">Kong API网关搭建部署记录</a>通过更改配置的方式，可以实现让数据平面监听在80和443，这就有点奇怪了。</p><p>于是乎去看了下kong社区是怎么生成容器镜像的，项目地址在<a href="https://github.com/Kong/docker-kong" target="_blank" rel="noopener">这里</a>。</p><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>以alpine为例，找到项目里面的<code>alpine/Dockerfile</code>文件，内容如下</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.10</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer=<span class="string">"Kong Core Team &lt;team-core@konghq.com&gt;"</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENV KONG_VERSION 1.2.1</span></span><br><span class="line"><span class="bash">ENV KONG_SHA256 067bed966de064f15e548b1afbf859e724a3a5689865edc501db40cf61a7044c</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN adduser -Su 1337 kong \</span></span><br><span class="line"><span class="bash">&amp;&amp; mkdir -p <span class="string">"/usr/local/kong"</span> \</span></span><br><span class="line"><span class="bash">&amp;&amp; apk add --no-cache --virtual .build-deps wget tar ca-certificates \</span></span><br><span class="line"><span class="bash">&amp;&amp; apk add --no-cache libgcc openssl pcre perl tzdata curl libcap su-exec zip \</span></span><br><span class="line"><span class="bash">&amp;&amp; wget -O kong.tar.gz <span class="string">"https://bintray.com/kong/kong-alpine-tar/download_file?file_path=kong-<span class="variable">$KONG_VERSION</span>.apk.tar.gz"</span> \</span></span><br><span class="line"><span class="bash">&amp;&amp; <span class="built_in">echo</span> <span class="string">"<span class="variable">$KONG_SHA256</span> *kong.tar.gz"</span> | sha256sum -c - \</span></span><br><span class="line"><span class="bash">&amp;&amp; tar -xzf kong.tar.gz -C /tmp \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -f kong.tar.gz \</span></span><br><span class="line"><span class="bash">&amp;&amp; cp -R /tmp/usr / \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -rf /tmp/usr \</span></span><br><span class="line"><span class="bash">&amp;&amp; cp -R /tmp/etc / \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -rf /tmp/etc \</span></span><br><span class="line"><span class="bash">&amp;&amp; apk del .build-deps \</span></span><br><span class="line"><span class="bash">&amp;&amp; chown -R kong:0 /usr/<span class="built_in">local</span>/kong \</span></span><br><span class="line"><span class="bash">&amp;&amp; chmod -R g=u /usr/<span class="built_in">local</span>/kong</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">COPY docker-entrypoint.sh /docker-entrypoint.sh</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/docker-entrypoint.sh"</span>]</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">EXPOSE 8000 8443 8001 8444</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">STOPSIGNAL SIGQUIT</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">CMD [<span class="string">"kong"</span>, <span class="string">"docker-start"</span>]</span></span><br></pre></td></tr></table></figure><p>可以看到，Kong容器默认运行指令为<code>/docker-entrypoint.sh kong docker-start</code></p><h2 id="Entrypoint"><a href="#Entrypoint" class="headerlink" title="Entrypoint"></a>Entrypoint</h2><p>那么来看看<code>docker-entrypoint.sh</code>里面做了什么事情吧。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">export KONG_NGINX_DAEMON=off</span><br><span class="line"></span><br><span class="line">has_transparent() &#123;</span><br><span class="line">  echo "$1" | grep -E "[^\s,]+\s+transparent\b" &gt;/dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [[ "$1" == "kong" ]]; then</span><br><span class="line">  PREFIX=$&#123;KONG_PREFIX:=/usr/local/kong&#125;</span><br><span class="line"></span><br><span class="line">  if [[ "$2" == "docker-start" ]]; then</span><br><span class="line">    shift 2</span><br><span class="line">    kong prepare -p "$PREFIX" "$@"</span><br><span class="line">    </span><br><span class="line">    # workaround for https://github.com/moby/moby/issues/31243</span><br><span class="line">    chmod o+w /proc/self/fd/1 || true</span><br><span class="line">    chmod o+w /proc/self/fd/2 || true</span><br><span class="line"></span><br><span class="line">    if [ "$(id -u)" != "0" ]; then</span><br><span class="line">      exec /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    else</span><br><span class="line">      if [ ! -z $&#123;SET_CAP_NET_RAW&#125; ] \</span><br><span class="line">          || has_transparent "$KONG_STREAM_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_PROXY_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_ADMIN_LISTEN";</span><br><span class="line">      then</span><br><span class="line">        setcap cap_net_raw=+ep /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">      fi</span><br><span class="line">      chown -R kong:0 /usr/local/kong</span><br><span class="line">      exec su-exec kong /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exec "$@"</span><br></pre></td></tr></table></figure><p>从脚本里面可以看到做了以下几个事情</p><ul><li>判断参数为<code>docker-start</code>时，执行<code>kong prepare</code></li><li>判断环境变量是否带有<code>transparent</code>，有的话就执行<code>setcap cap_net_raw=+ep</code>，没有就直接结束判断</li><li>修改<code>/usr/local/kong</code>的owner和group</li><li>最终是使用kong用户去启动Nginx进程。</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ # ps -ef</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 kong      0:00 nginx: master process /usr/local/openresty/nginx/sbin/nginx -p /usr/local/kong -c nginx.conf</span><br><span class="line">   32 kong      0:00 nginx: worker process</span><br><span class="line">   33 kong      0:00 nginx: worker process</span><br><span class="line">   34 kong      0:00 nginx: worker process</span><br><span class="line">   35 kong      0:00 nginx: worker process</span><br><span class="line">   36 root      0:00 /bin/sh</span><br><span class="line">   45 root      0:00 ps -ef</span><br></pre></td></tr></table></figure><p>从容器里面可以看到，Nginx进程是以kong用户运行的，自然就没有权限监听小于1024的端口，那么transparent怎么就可以了呢，回到if判断里面执行了<code>setcap cap_net_raw=+ep</code>这样的命令。</p><p>这个<code>cap_net_raw</code>是干什么用的，查了下<a href="https://linux.die.net/man/7/capabilities" target="_blank" rel="noopener">文档</a>，针对此项的说明如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CAP_NET_RAW</span><br><span class="line">    *</span><br><span class="line">    use RAW and PACKET sockets;</span><br><span class="line">    *</span><br><span class="line">    bind to any address for transparent proxying.</span><br></pre></td></tr></table></figure><p>也就是，根据脚本判断到kong需要实现transparent功能时，会给nginx添加CAP_NET_RAW，以实现普通用户也能运行需要trasparent proxying权限的程序。</p><h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>那么问题来了，在Linux capabilities里面，是否有相关的权限可以让程序绑定小于1024的端口呢。</p><p>恩，很好，一下就找到了<strong>CAP_NET_BIND_SERVICE</strong>，说明如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CAP_NET_BIND_SERVICE</span><br><span class="line">    Bind a socket to Internet domain privileged ports (port numbers less than 1024).</span><br></pre></td></tr></table></figure><h1 id="魔改"><a href="#魔改" class="headerlink" title="魔改"></a>魔改</h1><p>接下来就是魔改entrypoint的节奏了，修改如下</p><blockquote><p>在34行给nginx进程添加了<strong>CAP_NET_BIND_SERVICE</strong>权限</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">export KONG_NGINX_DAEMON=off</span><br><span class="line"></span><br><span class="line">has_transparent() &#123;</span><br><span class="line">  echo "$1" | grep -E "[^\s,]+\s+transparent\b" &gt;/dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [[ "$1" == "kong" ]]; then</span><br><span class="line">  PREFIX=$&#123;KONG_PREFIX:=/usr/local/kong&#125;</span><br><span class="line"></span><br><span class="line">  if [[ "$2" == "docker-start" ]]; then</span><br><span class="line">    shift 2</span><br><span class="line">    kong prepare -p "$PREFIX" "$@"</span><br><span class="line">    </span><br><span class="line">    # workaround for https://github.com/moby/moby/issues/31243</span><br><span class="line">    chmod o+w /proc/self/fd/1 || true</span><br><span class="line">    chmod o+w /proc/self/fd/2 || true</span><br><span class="line"></span><br><span class="line">    if [ "$(id -u)" != "0" ]; then</span><br><span class="line">      exec /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    else</span><br><span class="line">      if [ ! -z $&#123;SET_CAP_NET_RAW&#125; ] \</span><br><span class="line">          || has_transparent "$KONG_STREAM_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_PROXY_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_ADMIN_LISTEN";</span><br><span class="line">      then</span><br><span class="line">        setcap cap_net_raw=+ep /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">      fi</span><br><span class="line">      chown -R kong:0 /usr/local/kong</span><br><span class="line">      setcap cap_net_bind_service=+ep /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">      exec su-exec kong /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exec "$@"</span><br></pre></td></tr></table></figure><p>重新构建容器镜像了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t newkong:v1 .</span><br></pre></td></tr></table></figure><h1 id="成果检验"><a href="#成果检验" class="headerlink" title="成果检验"></a>成果检验</h1><h2 id="重新运行容器"><a href="#重新运行容器" class="headerlink" title="重新运行容器"></a>重新运行容器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    -e KONG_DATABASE=off \</span><br><span class="line">    -e KONG_PROXY_LISTEN='0.0.0.0:80, 0.0.0.0:443 ssl' \</span><br><span class="line">    -e KONG_LOG_LEVEL=notice \</span><br><span class="line">    -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    --name kong \</span><br><span class="line">    newkong:v1</span><br></pre></td></tr></table></figure><h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker logs kong</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: using the "epoll" event method</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: openresty/1.13.6.2</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: built by gcc 8.3.0 (Alpine 8.3.0) </span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: OS: Linux 5.1.15-300.fc30.x86_64</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: start worker processes</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: start worker process 33</span><br></pre></td></tr></table></figure><h2 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it kong /bin/sh -c "ps -ef"</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 kong      0:00 nginx: master process /usr/local/openresty/nginx/sbin/ngin</span><br><span class="line">   33 kong      0:00 nginx: worker process</span><br><span class="line">   39 root      0:00 ps -ef</span><br></pre></td></tr></table></figure><h2 id="查看监听"><a href="#查看监听" class="headerlink" title="查看监听"></a>查看监听</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it kong /bin/sh -c "netstat -lp"</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:8444          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:8001          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span><br><span class="line">Active UNIX domain sockets (only servers)</span><br><span class="line">Proto RefCnt Flags       Type       State         I-Node PID/Program name    Path</span><br></pre></td></tr></table></figure><p>可以看到，Nginx已经可以成功监听80和443端口了。欧耶~！</p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>最后琢磨了一下，通过传入启动命令的方式也可以实现kong监听80和443端口。</p><p>感觉绕了弯子……</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    -e KONG_DATABASE=off \</span><br><span class="line">    -e KONG_PROXY_LISTEN='0.0.0.0:80, 0.0.0.0:443 ssl' \</span><br><span class="line">    -e KONG_LOG_LEVEL=notice \</span><br><span class="line">    -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    --name kong \</span><br><span class="line">    kong:1.2 \</span><br><span class="line">    kong start</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前情提要&quot;&gt;&lt;a href=&quot;#前情提要&quot; class=&quot;headerlink&quot; title=&quot;前情提要&quot;&gt;&lt;/a&gt;前情提要&lt;/h1&gt;&lt;p&gt;在做kong容器实验的时候，发现kong数据平面默认监听的端口是8000和8443，非常难受。&lt;/p&gt;&lt;p&gt;通过容器启动时声
      
    
    </summary>
    
      <category term="Kong" scheme="https://luanlengli.github.io/categories/Kong/"/>
    
    
      <category term="Kong" scheme="https://luanlengli.github.io/tags/Kong/"/>
    
  </entry>
  
  <entry>
    <title>Kong Ingress Controller部署</title>
    <link href="https://luanlengli.github.io/2019/07/02/Kong-Ingress-Controller%E9%83%A8%E7%BD%B2.html"/>
    <id>https://luanlengli.github.io/2019/07/02/Kong-Ingress-Controller部署.html</id>
    <published>2019-07-02T03:33:33.000Z</published>
    <updated>2019-07-07T02:18:47.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li><p>如果不知道kong怎么部署，参考<a href="https://luanlengli.github.io/2019/05/29/Kong-API网关搭建部署记录.html">Kong API网关搭建部署记录</a></p></li><li><p>这里简单描述一下怎么修改官方的YAML文件，不保证<code>ctrl+c</code>和<code>ctrl+v</code>可以直接跑起来!</p></li><li><p><a href="https://github.com/Kong/kubernetes-ingress-controller" target="_blank" rel="noopener">Github项目地址</a></p></li><li><p>kong-ingress-controller的版本号是<code>0.5.0</code></p></li><li><p>kong的版本号是<code>1.2</code></p></li></ul><h1 id="Kong-Ingress-Controller介绍"><a href="#Kong-Ingress-Controller介绍" class="headerlink" title="Kong-Ingress-Controller介绍"></a>Kong-Ingress-Controller介绍</h1><p>这里是参考<a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/design.md" target="_blank" rel="noopener">项目文档</a>，简单的翻译一下。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Kong Ingress Controller是一个动态且高度可用的Ingress Controller。</p><p>它使用在Kubernetes集群中创建的Ingress资源来配置Kong。</p><p>此外，它还可以为Kubernetes中运行的服务配置插件，负载平衡和运行状况检查。</p><h2 id="部署方式"><a href="#部署方式" class="headerlink" title="部署方式"></a>部署方式</h2><p>kong的ingress-controller是Go编写的程序，作用机制类似于Adapter，将Kubernetes里面的资源对象转换成Kong的配置规则。</p><p>支持<code>backed with a database</code>模式和<code>backed without a database</code>模式。</p><h3 id="DBless模式"><a href="#DBless模式" class="headerlink" title="DBless模式"></a>DBless模式</h3><p>运行在DBless模式下，Kong ingress controller会作为sidecar容器与Kong容器一起运行在同一个Pod里面，并且会根据从Kubernetes API Server接收到的信息动态配置Kong。</p><p>支持增加kong容器副本数量来实现高可用和负载均衡。</p><p><img src="https://github.com/Kong/kubernetes-ingress-controller/raw/master/docs/images/dbless-deployment.png" alt=""></p><h3 id="后端数据库模式"><a href="#后端数据库模式" class="headerlink" title="后端数据库模式"></a>后端数据库模式</h3><p>运行在基于后端数据库的模式时，ingress controller与kong的控制平面部署在一起，kong的数据平面分开部署。</p><p>在下图可以看明显看到kong的控制平面和数据平面是分开的。</p><p><img src="https://github.com/Kong/kubernetes-ingress-controller/raw/master/docs/images/db-deployment.png" alt=""></p><h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><p>当部署多个kong ingress controller时，多个kong ingress controller之间会选举出leader。同一时间只有leader能配置kong的规则，并且leader失效后会自动选主。</p><h2 id="横向扩展"><a href="#横向扩展" class="headerlink" title="横向扩展"></a>横向扩展</h2><p>如果是基于后端数据库模式，kong的控制平面和数据平面分开部署，可以单独增加kong的数据平面来实现横向扩展。</p><h2 id="规则转换"><a href="#规则转换" class="headerlink" title="规则转换"></a>规则转换</h2><p>下图是Kubernetes资源对象怎么转换成Kong配置规则的过程</p><blockquote><p>PS：这个图感觉怪怪的，这哪里有转换过程，不是Kubernetes的Ingress对象模型吗</p></blockquote><h2 id="CRD资源"><a href="#CRD资源" class="headerlink" title="CRD资源"></a><img src="https://raw.githubusercontent.com/Kong/kubernetes-ingress-controller/master/docs/images/k8s-to-kong.png" alt="">CRD资源</h2><p>Kong ingress controller可以配置以下CRD资源对象，实现对kong更加精细的配置管理，官方文档在<a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/custom-resources.md" target="_blank" rel="noopener">这里</a></p><ul><li>KongIngress</li><li>KongPlugin</li><li>KongConsumer</li><li>KongCredential</li></ul><h1 id="官方YAML模板"><a href="#官方YAML模板" class="headerlink" title="官方YAML模板"></a>官方YAML模板</h1><h2 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h2><p>链接在这里<a href="https://github.com/Kong/kubernetes-ingress-controller/tree/master/deploy/manifests" target="_blank" rel="noopener">YAML模板</a>，下面几个资源对象可以直接套官方</p><ul><li>Namespace</li><li>CustomResourceDefinition</li><li>ServiceAccount</li><li>ClusterRole</li><li>ClusterRoleBinding</li></ul><p>其他的资源对象的定义还是有点不适合生产环境，需要改。</p><h1 id="基于后端数据库模式部署"><a href="#基于后端数据库模式部署" class="headerlink" title="基于后端数据库模式部署"></a>基于后端数据库模式部署</h1><h2 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h2><ul><li><p>Kubernetes集群环境不一定有<code>ELB</code>或者<code>SLB</code>，可以在Ingress节点上部署keepalived+haproxy实现高可用和负载均衡</p></li><li><p>使用外部独立的<code>PostgreSQL</code>，部署方式见<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html">PostgreSQL10安装部署和初始化</a>，数据库用户<code>kong</code>，密码<code>kong</code></p></li><li><code>kong数据平面</code><ul><li>通过<code>nodeSelector</code>加<code>tolerations</code>将Pod调度到Kubernetes指定的Ingress节点</li><li>修改<code>kong数据平面</code>运行参数</li><li>共享宿主机网络栈</li></ul></li></ul><h2 id="PostgreSQL数据库"><a href="#PostgreSQL数据库" class="headerlink" title="PostgreSQL数据库"></a>PostgreSQL数据库</h2><blockquote><p>这里使用Service配合Endpoints，将外部PostgreSQL声明为Kubernetes内部的服务。</p><p>这样Kubernetes内部的Pod可以通过SVC访问外部PostgreSQL。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">pgsql</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5432</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">5432</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="attr">  - addresses:</span></span><br><span class="line"><span class="attr">      - ip:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">      - port:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure><h2 id="Kong-Bootstrap-Job"><a href="#Kong-Bootstrap-Job" class="headerlink" title="Kong Bootstrap Job"></a>Kong Bootstrap Job</h2><ul><li>kong-ingress-migrations</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-migrations</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">kong-migrations</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">wait-for-postgres</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"until nc -zv $KONG_PG_HOST $KONG_PG_PORT -w1; do echo 'waiting for db'; sleep 1; done"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kong-migrations</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong migrations bootstrap"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h2 id="Kong数据平面"><a href="#Kong数据平面" class="headerlink" title="Kong数据平面"></a>Kong数据平面</h2><ul><li>kong-proxy TLS证书</li></ul><blockquote><p>可以通过kubectl命令生成Secret</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kong create secret tls kong-tls-secret --key ./tls.key --cert ./tls.crt</span><br></pre></td></tr></table></figure><ul><li>kong-ingress-proxy.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy-ssl</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kong-ingres-proxy</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line">      <span class="comment"># 共享宿主机网络栈</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 选择节点标签为node-role=kong的节点</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line"><span class="attr">        node-role:</span> <span class="string">kong</span></span><br><span class="line">      <span class="comment"># 容忍node-role=kong的污点</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">          key:</span> <span class="string">"node-role"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Equal"</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line">      <span class="comment"># hack to verify that the DB is up to date or not</span></span><br><span class="line">      <span class="comment"># TODO remove this for Kong &gt;= 0.15.0</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">wait-for-migrations</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong migrations list"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_DAEMON</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'0.0.0.0:80, 0.0.0.0:443 ssl'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CIPHER_SUITE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"modern"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.crt"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT_KEY</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.key"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_MAX_BODY_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_BODY_BUFFER_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"16k"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_UPSTREAM_KEEPALIVE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"60"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_REAL_IP_HEADER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"X-Real-IP"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_DB_UPDATE_FREQUENCY</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5"</span></span><br><span class="line">        <span class="comment">#- name: KONG_MEM_CACHE_SIZE</span></span><br><span class="line">        <span class="comment">#  value: "128m"</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/usr/local/bin/kong</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">start</span></span><br><span class="line">        <span class="comment">#securityContext:</span></span><br><span class="line">        <span class="comment">#  capabilities:</span></span><br><span class="line">        <span class="comment">#    add:</span></span><br><span class="line">        <span class="comment">#    - NET_BIND_SERVICE</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy-ssl</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">8443</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        lifecycle:</span></span><br><span class="line"><span class="attr">          preStop:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong quit"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/opt/tls/</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">          secret:</span></span><br><span class="line"><span class="attr">            secretName:</span> <span class="string">kong-tls-secret</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h2 id="Kong控制平面"><a href="#Kong控制平面" class="headerlink" title="Kong控制平面"></a>Kong控制平面</h2><ul><li>kong-ingress-controller.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-controller</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-admin</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-controller</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="comment"># the returned metrics are related to the kong ingress controller not kong itself</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">"10254"</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">wait-for-migrations</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong migrations list"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">admin-api</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_DAEMON</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"0.0.0.0:8001, 0.0.0.0:8444 ssl"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">kong-admin</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/status</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/status</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">ingress-controller</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/kong-ingress-controller</span></span><br><span class="line">        <span class="comment"># the kong URL points to the kong admin api server</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--kong-url=https://localhost:8444</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--admin-tls-skip-verify</span></span><br><span class="line">        <span class="comment"># Service from were we extract the IP address/es to use in Ingress status</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--publish-service=kong/kong-proxy</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--sync-period=10m0s</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--v=2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">kong-docker-kubernetes-ingress-controller.bintray.io/kong-ingress-controller:0.5.0</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br></pre></td></tr></table></figure><h1 id="基于无数据库模式部署"><a href="#基于无数据库模式部署" class="headerlink" title="基于无数据库模式部署"></a>基于无数据库模式部署</h1><h2 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h2><ul><li>在DBless模式中，每个kong都是独立工作的，由Kong-Ingress-Controller作为sidecar调用kong的config接口来实现配置更新。</li><li>这样就有点像把kong的配置保存在Kubernetes里面，每个kong都是独立配置，不需要依赖外部数据库，避免因为数据库故障影响所有的kong。</li><li>DBless模式有些限制，可以看<a href="https://docs.konghq.com/1.2.x/db-less-and-declarative-config/" target="_blank" rel="noopener">这里</a></li></ul><h2 id="KongIngressDBless"><a href="#KongIngressDBless" class="headerlink" title="KongIngressDBless"></a>KongIngressDBless</h2><ul><li>kong-proxy TLS证书</li></ul><blockquote><p>可以通过kubectl命令生成Secret</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kong create secret tls kong-tls-secret --key ./tls.key --cert ./tls.crt</span><br></pre></td></tr></table></figure><ul><li>kong-ingress-controller-dbless-cm.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">servers.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # Prometheus metrics server</span></span><br><span class="line"><span class="string">    server &#123;</span></span><br><span class="line"><span class="string">        server_name kong_prometheus_exporter;</span></span><br><span class="line"><span class="string">        listen 0.0.0.0:9542; # can be any other port as well</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        access_log off;</span></span><br><span class="line"><span class="string">        location /metrics &#123;</span></span><br><span class="line"><span class="string">            default_type text/plain;</span></span><br><span class="line"><span class="string">            content_by_lua_block &#123;</span></span><br><span class="line"><span class="string">                 local prometheus = require "kong.plugins.prometheus.exporter"</span></span><br><span class="line"><span class="string"></span><span class="attr">                 prometheus:</span><span class="string">collect()</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">location</span> <span class="string">/nginx_status</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">internal;</span></span><br><span class="line">            <span class="string">access_log</span> <span class="string">off;</span></span><br><span class="line">            <span class="string">stub_status;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    <span class="comment"># Health check server</span></span><br><span class="line">    <span class="comment"># TODO how to health check kong in dbless?</span></span><br><span class="line">    <span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">server_name</span> <span class="string">kong_health_check;</span></span><br><span class="line">        <span class="string">listen</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:9001;</span> <span class="comment"># can be any other port as well</span></span><br><span class="line"></span><br><span class="line">        <span class="string">access_log</span> <span class="string">off;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/health</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">return</span> <span class="number">200</span><span class="string">;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>kong-ingress-controller-dbless-ds.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy-ssl</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kong-ingres-proxy</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">"9542"</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line">      <span class="comment"># 共享宿主机网络栈</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 选择节点标签为node-role=kong的节点</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line"><span class="attr">        node-role:</span> <span class="string">kong</span></span><br><span class="line">      <span class="comment"># 容忍node-role=kong的污点</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">          key:</span> <span class="string">"node-role"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Equal"</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_DAEMON</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_HTTP_INCLUDE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/kong/servers.conf"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"127.0.0.1:8444 ssl"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'0.0.0.0:80, 0.0.0.0:443 ssl'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CIPHER_SUITE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"modern"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.crt"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT_KEY</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.key"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_MAX_BODY_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_BODY_BUFFER_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"16k"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_UPSTREAM_KEEPALIVE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"60"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_REAL_IP_HEADER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"X-Real-IP"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_MEM_CACHE_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"128m"</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/usr/local/bin/kong</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">start</span></span><br><span class="line">        <span class="comment">#securityContext:</span></span><br><span class="line">        <span class="comment">#  capabilities:</span></span><br><span class="line">        <span class="comment">#    add:</span></span><br><span class="line">        <span class="comment">#    - NET_BIND_SERVICE</span></span><br><span class="line"><span class="attr">        lifecycle:</span></span><br><span class="line"><span class="attr">          preStop:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong quit"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy-ssl</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">9542</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/kong</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/opt/tls/</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">ingress-controller</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/kong-ingress-controller</span></span><br><span class="line">        <span class="comment"># the kong URL points to the kong admin api server</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--kong-url=https://localhost:8444</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--admin-tls-skip-verify</span></span><br><span class="line">        <span class="comment"># Service from were we extract the IP address/es to use in Ingress status</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--publish-service=kong/kong-proxy</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--sync-period=10m0s</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--v=2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">kong-docker-kubernetes-ingress-controller.bintray.io/kong-ingress-controller:0.5.0</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">        secret:</span></span><br><span class="line"><span class="attr">          secretName:</span> <span class="string">kong-tls-secret</span></span><br></pre></td></tr></table></figure><h1 id="CRD资源-1"><a href="#CRD资源-1" class="headerlink" title="CRD资源"></a>CRD资源</h1><p>关于CRD资源怎么用，在Github上面是有相关的<a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/custom-resources.md" target="_blank" rel="noopener">说明文档</a></p><h2 id="KongPlugin"><a href="#KongPlugin" class="headerlink" title="KongPlugin"></a>KongPlugin</h2><blockquote><p>在kong官方网站是有<a href="https://docs.konghq.com/hub/" target="_blank" rel="noopener">关于Plugin的介绍</a></p></blockquote><h3 id="开启IP黑白名单"><a href="#开启IP黑白名单" class="headerlink" title="开启IP黑白名单"></a>开启IP黑白名单</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ip-restriction</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span>  <span class="comment"># optional</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">ip-restriction</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="comment">#  whitelist:     # 黑名单和白名单只能选一</span></span><br><span class="line"><span class="comment">#  - 8.8.8.8</span></span><br><span class="line"><span class="comment">#  - 8.8.4.4</span></span><br><span class="line"><span class="attr">  blacklist:</span> </span><br><span class="line"><span class="bullet">  -</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">8.8</span><span class="number">.4</span><span class="number">.4</span></span><br></pre></td></tr></table></figure><h3 id="开启prometheus"><a href="#开启prometheus" class="headerlink" title="开启prometheus"></a>开启prometheus</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-prometheus</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">  label:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  status_code:</span> <span class="number">503</span></span><br><span class="line"><span class="attr">  content_type:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  body:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  message:</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><h3 id="开启rate-limiting"><a href="#开启rate-limiting" class="headerlink" title="开启rate-limiting"></a>开启rate-limiting</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">rate-limit</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">rate-limiting</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  second:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  hour:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">  limit_by:</span> <span class="string">ip</span></span><br><span class="line"><span class="attr">  policy:</span> <span class="string">local</span>  <span class="comment">#local,cluster,redis</span></span><br></pre></td></tr></table></figure><h3 id="开启zipkin链路追踪"><a href="#开启zipkin链路追踪" class="headerlink" title="开启zipkin链路追踪"></a>开启zipkin链路追踪</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">echo-http-zipkin-trace</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">zipkin</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  http_endpoint:</span> <span class="string">"http://your.zipkin.collector:9411/api/v2/spans"</span></span><br><span class="line"><span class="attr">  sample_ratio:</span> <span class="number">1</span>  <span class="comment"># 不带tracid的请求的采样比率，1是100%，全部采集</span></span><br></pre></td></tr></table></figure><h3 id="开启Basic-Authentication"><a href="#开启Basic-Authentication" class="headerlink" title="开启Basic Authentication"></a>开启Basic Authentication</h3><blockquote><p>这里认证的时候会查找<code>KongConsumer</code>和<code>KongCredential</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">demo-basic-auth</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">basic-auth</span></span><br></pre></td></tr></table></figure><h3 id="配置Response-Header"><a href="#配置Response-Header" class="headerlink" title="配置Response Header"></a>配置Response Header</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">response-transformer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  label:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">disable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">response-transformer</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  replace:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  append:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  add:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"abc: def"</span></span><br><span class="line"><span class="attr">  remove:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">Last-Modified</span></span><br></pre></td></tr></table></figure><h2 id="KongIngress"><a href="#KongIngress" class="headerlink" title="KongIngress"></a>KongIngress</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongIngress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">configuration-demo</span></span><br><span class="line"><span class="attr">upstream:</span></span><br><span class="line"><span class="attr">  hash_on:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">  hash_fallback:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">  healthchecks:</span></span><br><span class="line"><span class="attr">    active:</span></span><br><span class="line"><span class="attr">      concurrency:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      healthy:</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">200</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">302</span></span><br><span class="line"><span class="attr">        interval:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        successes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      http_path:</span> <span class="string">"/"</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      unhealthy:</span></span><br><span class="line"><span class="attr">        http_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">429</span></span><br><span class="line"><span class="attr">        interval:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        tcp_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        timeouts:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    passive:</span></span><br><span class="line"><span class="attr">      healthy:</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">200</span></span><br><span class="line"><span class="attr">        successes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      unhealthy:</span></span><br><span class="line"><span class="attr">        http_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">429</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">503</span></span><br><span class="line"><span class="attr">        tcp_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        timeouts:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    slots:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line"><span class="attr">  protocol:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">  connect_timeout:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">  retries:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  read_timeout:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">  write_timeout:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line"><span class="attr">  methods:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">GET</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">HEAD</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">POST</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">PUT</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">DELETE</span></span><br><span class="line">  <span class="comment">#- CONNECT</span></span><br><span class="line">  <span class="comment">#- OPTIONS</span></span><br><span class="line">  <span class="comment">#- TRACE</span></span><br><span class="line">  <span class="comment">#- PATCH</span></span><br><span class="line"><span class="attr">  regex_priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  strip_path:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  preserve_host:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  protocols:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">https</span></span><br></pre></td></tr></table></figure><h2 id="KongConsumer"><a href="#KongConsumer" class="headerlink" title="KongConsumer"></a>KongConsumer</h2><blockquote><p>示例</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongConsumer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">consumer-team-x</span></span><br><span class="line"><span class="attr">username:</span> <span class="string">team-X</span></span><br><span class="line"><span class="attr">custom_id:</span> <span class="string">my_team_x</span></span><br></pre></td></tr></table></figure><h2 id="KongCredential"><a href="#KongCredential" class="headerlink" title="KongCredential"></a>KongCredential</h2><blockquote><p>示例</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongCredential</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">credential-team-x</span></span><br><span class="line"><span class="attr">consumerRef:</span> <span class="string">consumer-team-x</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">key-auth</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  key:</span> <span class="number">62</span><span class="string">eb165c070a41d5c1b58d9d3d725ca1</span></span><br></pre></td></tr></table></figure><h1 id="Kubernetes-Ingress配置"><a href="#Kubernetes-Ingress配置" class="headerlink" title="Kubernetes Ingress配置"></a>Kubernetes Ingress配置</h1><blockquote><p>在Ingress里面声明<code>annotations</code>属性，可以调用<code>Kong Ingress Controller</code>定义的<code>CRD资源</code></p><p><a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/annotations.md" target="_blank" rel="noopener">Github文档说明在此</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment"># 这里声明使用kong ingress controller</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"kong"</span></span><br><span class="line">    <span class="comment"># 声明使用kongIngress配置</span></span><br><span class="line">    <span class="string">configuration.konghq.com:</span> <span class="string">"configuration-demo"</span></span><br><span class="line">    <span class="comment"># 声明使用KongPlugin</span></span><br><span class="line">    <span class="string">plugins.konghq.com:</span> <span class="string">"ip-restriction,kong-prometheus,response-transformer"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">    - secretName:</span> <span class="string">example-com-secret</span></span><br><span class="line"><span class="attr">      hosts:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"*.example.com"</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line">    <span class="comment"># host定义域名</span></span><br><span class="line"><span class="attr">    - host:</span> <span class="string">tomcat.example.com</span></span><br><span class="line">      <span class="comment"># 定义HTTP服务</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        paths:</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">            backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">tomcat-service</span></span><br><span class="line">              <span class="comment"># 这里可以写端口号或者端口别名http</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;如果不知道kong怎么部署，参考&lt;a href=&quot;https://luanlengli.github.io/2019/05/
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
      <category term="Kong" scheme="https://luanlengli.github.io/categories/Kubernetes/Kong/"/>
    
    
      <category term="Kong" scheme="https://luanlengli.github.io/tags/Kong/"/>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes deployment模板</title>
    <link href="https://luanlengli.github.io/2019/07/02/Kubernetes-deployment%E6%A8%A1%E6%9D%BF.html"/>
    <id>https://luanlengli.github.io/2019/07/02/Kubernetes-deployment模板.html</id>
    <published>2019-07-02T02:58:36.000Z</published>
    <updated>2019-07-02T03:31:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>官方文档里面的deployment样例比较简单</p><p>实际上deployment的配置选项非常的多</p><p>这里做一下记录</p></blockquote><h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./demo.jar /home/demo.jar</span></span><br></pre></td></tr></table></figure><h1 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义APP环境变量</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 定义配置文件的名称</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">java-app-configmap</span></span><br><span class="line">  <span class="comment"># 定义运行在哪个命名空间</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="comment"># 定义标签，后面可以通过标签选择器筛选</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 定义数据库连接地址和端口</span></span><br><span class="line"><span class="attr">  DB_HOST:</span> <span class="string">"mysql-svc.default.svc.cluster.local"</span></span><br><span class="line"><span class="attr">  DB_PORT:</span> <span class="string">"3306"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="comment"># 定义运行在哪个命名空间</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="comment"># 设置副本数量</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line">      <span class="comment"># 禁止自动挂载kubernetes的ServiceAccount</span></span><br><span class="line">      <span class="comment"># 理解为禁止app通过kubernetes内建的ServiceAccount访问kubernetes集群</span></span><br><span class="line"><span class="attr">      automountServiceAccountToken:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># 从镜像库拉镜像时使用用户名密码认证</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span> <span class="string">[]</span></span><br><span class="line">      <span class="comment"># 定义亲和性，调整调度策略</span></span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line">        <span class="comment"># 容器反亲和性</span></span><br><span class="line"><span class="attr">        podAntiAffinity:</span></span><br><span class="line">          <span class="comment"># preferredDuringSchedulingIgnoredDuringExecution</span></span><br><span class="line">          <span class="comment"># 优先部署在满足条件的节点，如不满足则忽略条件继续调度</span></span><br><span class="line"><span class="attr">          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="comment"># 这里定义亲和规则</span></span><br><span class="line">          <span class="comment"># 调度时会检查候选节点上是否有带有app=java-app的app，权重为100</span></span><br><span class="line">          <span class="comment"># 这里定义的是AntiAffinity，效果为同一个app在同一个节点上是互斥的</span></span><br><span class="line">          <span class="comment"># 实现同一个app不会集中在同一个节点</span></span><br><span class="line">          <span class="comment"># 极端情况下，节点数量不够，无法满足条件时，会忽略prefer规则，按照正常流程调度</span></span><br><span class="line"><span class="attr">          - podAffinityTerm:</span></span><br><span class="line"><span class="attr">              labelSelector:</span></span><br><span class="line"><span class="attr">                matchExpressions:</span></span><br><span class="line"><span class="attr">                - key:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">                  operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                  values:</span></span><br><span class="line"><span class="bullet">                  -</span> <span class="string">java-app</span></span><br><span class="line">              <span class="comment"># 这里是作用域，没啥事不用调</span></span><br><span class="line"><span class="attr">              topologyKey:</span> <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line"><span class="attr">            weight:</span> <span class="number">100</span></span><br><span class="line">      <span class="comment"># 配置Pod挂载的卷和名字</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line">      <span class="comment"># 这里定义Pod可以挂载哪些volume，容器挂载的volume要在这里定义好才可以使用</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line">        <span class="comment"># 定义宿主机文件路径</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line">      <span class="comment"># 容器初始化操作</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line">        <span class="comment"># 用于检测数据库就绪状态</span></span><br><span class="line">        <span class="comment"># 检查条件为数据库服务器端口是否可达</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">wait-for-db</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">busybox:1.28</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          envFrom:</span></span><br><span class="line">          <span class="comment"># 这里从configmap里面获取环境变量</span></span><br><span class="line"><span class="attr">          - configMapRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">java-app-configmap</span></span><br><span class="line">          <span class="comment"># 这里是容器初始化时，通过循环检查数据库是否就绪</span></span><br><span class="line"><span class="attr">          command:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="bullet">          -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">"until nc -zv $(DB_HOST) $(DB_PORT) -w1; do echo 'waiting for db'; sleep 1; done"</span></span><br><span class="line">      <span class="comment"># 启动容器</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line">        <span class="comment"># 业务容器</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">java-app:v1</span></span><br><span class="line">          <span class="comment"># 镜像拉取策略</span></span><br><span class="line">          <span class="comment"># IfNotPresent 如果没有就拉镜像</span></span><br><span class="line">          <span class="comment"># Always 总是拉镜像，即使节点本地有镜像</span></span><br><span class="line">          <span class="comment"># Nerver 不拉镜像</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="comment"># 定义容器资源需求</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line">            <span class="comment"># 资源限制，超过限值会被杀掉</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line">              <span class="comment"># 限制CPU用量</span></span><br><span class="line">              <span class="comment"># 1个核心的CPU等于1000m，这样多个容器是通过CPUShare共享CPU计算资源</span></span><br><span class="line">              <span class="comment"># 如果直接写数字（1、2、3）这样的话，会被认为是将容器独占CPU核心</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="string">"1500m"</span></span><br><span class="line">              <span class="comment"># 限制容器最大内存用量</span></span><br><span class="line">              <span class="comment"># 内存为不可压缩资源，超过限制会因为Out-Of-Memory被杀掉</span></span><br><span class="line">              <span class="comment"># jdk-8u131+以上的版本可以通过强制检查Linux cgroup配置</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="string">"2Gi"</span></span><br><span class="line">            <span class="comment"># Pod调度时会参考这里的资源需求调度</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line">              <span class="comment"># 限制CPU用量</span></span><br><span class="line">              <span class="comment"># 1个核心的CPU等于1000m，这样多个容器是通过CPUShare共享CPU计算资源</span></span><br><span class="line">              <span class="comment"># 如果直接写数字（1、2、3）这样的话，会被认为是将容器独占CPU核心</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="string">"2Gi"</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line">          <span class="comment"># 这里定义JAVA_OPTS来让jvm启动时自动识别容器资源限值，然后计算出匹配的运行参数</span></span><br><span class="line">          <span class="comment"># -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap开启openjdk8的实验特性以正确识别docker资源限值</span></span><br><span class="line">          <span class="comment"># -XX:MaxRAMFraction默认值为4，即Heapsize为内存的25%，这里设置为2，即Heapsize为内存的50%</span></span><br><span class="line">          <span class="comment"># 可以通过-Xmx来指定jvm可使用的最大堆</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">            value:</span> <span class="string">"-Xmx1800m"</span></span><br><span class="line">            <span class="comment"># value: "-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=2"</span></span><br><span class="line">          <span class="comment"># 这里使用kubernetes的downwardAPI获取Pod的信息</span></span><br><span class="line">          <span class="comment"># 对于某些APP需要获取Pod自身信息时可以直接调用环境变量</span></span><br><span class="line">          <span class="comment"># Pod所在宿主机名字</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">NODE_NAME</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="comment"># Pod所在宿主机IP地址</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">NODE_IP</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">          <span class="comment"># Pod名字</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="comment"># PodIP地址</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">POD_IP</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line"><span class="attr">          envFrom:</span></span><br><span class="line">            <span class="comment"># 这里直接从configmap里面获取环境变量</span></span><br><span class="line">            <span class="comment"># 可以在command字段里面使用</span></span><br><span class="line">            <span class="comment"># 具体定义了哪些环境变量，可以在configmap那里看到</span></span><br><span class="line"><span class="attr">            - configMapRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">java-app-configmap</span></span><br><span class="line">          <span class="comment"># 设置容器工作目录</span></span><br><span class="line"><span class="attr">          workingDir:</span> <span class="string">/home</span></span><br><span class="line">          <span class="comment"># 设置容器启动命令和参数</span></span><br><span class="line"><span class="attr">          command:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">/usr/bin/java</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-Djava.security.egd=file:/dev/./urandom</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">            - -Xloggc:</span><span class="string">logs/gc.log</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-jar</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">/home/demo.jar</span></span><br><span class="line">          <span class="comment"># 定义容器端口</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line">            <span class="comment"># 这里定义的端口别名可以在其他地方直接调用</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">http</span></span><br><span class="line">              <span class="comment"># 定义容器运行时监听的端口，需要与Service的targetPort对应</span></span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="comment"># 定义容器存活探针</span></span><br><span class="line"><span class="attr">          livenessProbe:</span></span><br><span class="line">            <span class="comment"># 使用TCP端口探测</span></span><br><span class="line"><span class="attr">            tcpSocket:</span></span><br><span class="line">            <span class="comment"># 定义检查端口，可以写端口别名，也可以写端口号</span></span><br><span class="line"><span class="attr">              port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="comment"># 容器初始化完成后延迟检测，单位秒</span></span><br><span class="line">            <span class="comment"># 防止app启动时间过久导致被k8s判断为fail直接干掉</span></span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">            <span class="comment"># 检测频率</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># 定义容器就绪探针</span></span><br><span class="line"><span class="attr">          readinessProbe:</span></span><br><span class="line">            <span class="comment"># 使用HTTP GET请求</span></span><br><span class="line"><span class="attr">            httpGet:</span></span><br><span class="line"><span class="attr">              path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">              port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              httpHeaders:</span></span><br><span class="line"><span class="attr">              - name:</span> <span class="string">readinessProbe</span></span><br><span class="line"><span class="attr">                value:</span> <span class="string">k8s</span></span><br><span class="line">            <span class="comment"># 容器初始化完成后延迟检测，单位秒</span></span><br><span class="line">            <span class="comment"># 防止app启动时间过久导致被k8s判断为fail直接干掉</span></span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">            <span class="comment"># 检测频率</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># 把定义好的数据卷挂载到容器里面</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">timezone-volume</span></span><br><span class="line">              <span class="comment"># 这里用于配置容器的时区为Asia/Shanghai</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/etc/localtime</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;官方文档里面的deployment样例比较简单&lt;/p&gt;&lt;p&gt;实际上deployment的配置选项非常的多&lt;/p&gt;&lt;p
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu-18.04-Server虚拟机模板制作</title>
    <link href="https://luanlengli.github.io/2019/06/29/Ubuntu-18.04-Server%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A8%A1%E6%9D%BF%E5%88%B6%E4%BD%9C.html"/>
    <id>https://luanlengli.github.io/2019/06/29/Ubuntu-18.04-Server虚拟机模板制作.html</id>
    <published>2019-06-29T04:20:34.000Z</published>
    <updated>2020-02-11T03:17:12.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>Ubuntu 18.04 LTS已经出来一年多了，小版本号已经更新到了18.04.2。</p><p>这里记录一下Ubuntu 18.04虚拟机模板的制作过程</p></blockquote><h1 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h1><blockquote><p>这里使用清华大学的镜像源</p><p>↓↓↓↓↓↓↓↓下载地址↓↓↓↓↓↓↓↓</p><p><a href="https://mirrors.aliyun.com/ubuntu-releases/bionic/ubuntu-18.04.2-live-server-amd64.iso" target="_blank" rel="noopener">ubuntu-18.04.2-live-server-amd64.iso</a></p></blockquote><h1 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h1><ul><li>这里使用VMware Workstation 15 Pro 版本号<code>15.0.2 build-10952284</code></li><li>虚拟机规格<ul><li>客户机操作系统版本<code>Ubuntu 64位</code></li><li>处理器数量<code>2</code></li><li>内存2GB</li><li>硬盘30GB</li><li>网络适配器<code>NAT模式</code></li></ul></li></ul><h1 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h1><ul><li>启动菜单<ul><li>语言选择<code>English</code></li><li>选择<code>Install Ubuntu Server</code>或者<code>Install Ubuntu Server with the HWE kernel</code>都可以，关于HWE kernel的说明，看<a href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack" target="_blank" rel="noopener">这里</a></li></ul></li><li>安装流程<ul><li>语言选择<code>English</code></li><li>键盘Layout和Variant都选择<code>English (US)</code></li><li>安装的类型选择<code>Install Ubuntu</code>即可，另外两个选择<code>Install MAAS bare-metal cloud (region)</code>和<code>Install MAAS bare-metal cloud (region)</code>可以看一下<a href="https://ubuntu.com/download/server/provisioning" target="_blank" rel="noopener">官方说明</a></li><li>网络连接，这里根据需要配置即可</li><li>代理地址设置，没有就直接跳过</li><li>设置镜像地址，默认是<code>http://archive.ubuntu.com/ubuntu</code>，安装完系统之后可以修改，这里看需要配置即可</li><li>配置分区，这里设置<code>/boot</code>分区<code>1GB</code>，<code>/</code>分区剩余空间，无swap分区，由于Ubuntu会自动创建一个1M大小的分区用于BIOS_GRUB，因此，实际上，硬盘分区是有三个的</li><li>设置用户名密码和主机名，这里统一用Ubuntu了，密码这里尽量不要设置的太简单了<ul><li>Your name: <code>ubuntu</code></li><li>Your server’s name: <code>ubuntu</code></li><li>Pick a username: <code>ubuntu</code></li><li>Choose a password:<code>***********</code></li><li>Confirm your password:<code>***********</code></li></ul></li><li>设置SSH，选择<code>Install Openssh Server</code>，<code>Import SSH identity</code>选择<code>No</code></li><li><code>Featured Server Snaps</code>这里可以在安装系统的时候顺带选择额外安装的软件包<ul><li>这个后续安装完系统可以自己操作，所以直接跳过，避免安装时间过长！</li></ul></li><li>接下来就等待系统安装完成，安装完成后选择<code>Reboot Now</code>重启</li></ul></li></ul><h1 id="操作系统启动后初始化设置"><a href="#操作系统启动后初始化设置" class="headerlink" title="操作系统启动后初始化设置"></a>操作系统启动后初始化设置</h1><h2 id="配置ssh证书登录"><a href="#配置ssh证书登录" class="headerlink" title="配置ssh证书登录"></a>配置ssh证书登录</h2><ul><li>通过ssh命令生成密钥对</li><li>将<code>~/.ssh/id_rsa.pub</code>提取出来</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure><h2 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h2><h3 id="fs参数"><a href="#fs参数" class="headerlink" title="fs参数"></a>fs参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-fs.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同一时间异步IO请求数</span></span><br><span class="line">fs.aio-max-nr=1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="vm参数"><a href="#vm参数" class="headerlink" title="vm参数"></a>vm参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-vm.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当内存耗尽时，内核会触发OOM killer根据oom_score杀掉最耗内存的进程</span></span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许overcommit</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义了进程能拥有的最多内存区域，默认65536</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="net参数"><a href="#net参数" class="headerlink" title="net参数"></a>net参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-net.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径，默认值1</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进程间通信发送数据, 默认100</span></span><br><span class="line">net.unix.max_dgram_qlen=512</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 conntrack 的上限</span></span><br><span class="line">net.netfilter.nf_conntrack_max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置连接跟踪表中处于TIME_WAIT状态的超时时间</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_timewait=30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置连接跟踪表中TCP连接超时时间</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established=1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=21644</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收自网卡、但未被内核协议栈处理的报文队列长度</span></span><br><span class="line">net.core.netdev_max_backlog=262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统无内存压力、启动压力模式阈值、最大值，单位为页的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_mem=1541646 2055528 3083292</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核socket接收缓存区字节数min/default/max</span></span><br><span class="line">net.core.rmem=4096 65536 8388608</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核socket发送缓存区字节数min/default/max</span></span><br><span class="line">net.core.wmem=4096 65536 8388608</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启自动调节缓存模式</span></span><br><span class="line">net.ipv4.tcp_moderate_rcvbuf=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP阻塞控制算法BBR，Linux内核版本4.9开始内置BBR算法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用作本地随机TCP端口的范围</span></span><br><span class="line">net.ipv4.ip_local_port_range=1000065000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog=16384</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets=5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定重发 SYN/ACK 的次数</span></span><br><span class="line">net.ipv4.tcp_synack_retries=2</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接中TIME_WAIT sockets的快速回收</span></span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不属于任何进程的tcp socket最大数量. 超过这个数量的socket会被reset, 并告警</span></span><br><span class="line">net.ipv4.tcp_max_orphans=1024</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FIN报文重试次数</span></span><br><span class="line">net.ipv4.tcp_orphan_retries=8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout=15</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接keepalive的持续时间，默认7200</span></span><br><span class="line">net.ipv4.tcp_keepalive_time=600</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP keepalive探测包发送间隔</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl=30</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP keepalive探测包重试次数</span></span><br><span class="line">net.ipv4.tcp_keepalive_probes=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FastOpen</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0:关闭 ; 1:作为客户端时使用 ; 2:作为服务器端时使用 ; 3:无论作为客户端还是服务器端都使用</span></span><br><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制TCP重传次数</span></span><br><span class="line">net.ipv4.tcp_retries1=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP重传次数到达上限时，关闭TCP连接</span></span><br><span class="line">net.ipv4.tcp_retries2=15</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-ubuntu.conf &lt;&lt;EOF</span><br><span class="line">* - nproc 1048576</span><br><span class="line">* - nofile 1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改journal设置"><a href="#修改journal设置" class="headerlink" title="修改journal设置"></a>修改journal设置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#Compress=yes,Compress=yes,' \</span><br><span class="line">    -e 's,^#SystemMaxUse=,SystemMaxUse=5G,' \</span><br><span class="line">    -e 's,^#Seal=yes,Seal=yes,' \</span><br><span class="line">    -e 's,^#RateLimitBurst=1000,RateLimitBurst=5000,' \</span><br><span class="line">    -i /etc/systemd/journald.conf</span><br></pre></td></tr></table></figure><h2 id="修改终端提示符"><a href="#修改终端提示符" class="headerlink" title="修改终端提示符"></a>修改终端提示符</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export PS1="[\t]\[$(tput setaf 1)\][\u@\h:\w]\[$(tput setaf 7)\]\\$ \[$(tput sgr0)\]"</span><br><span class="line">cat &gt;&gt; ~/.bashrc &lt;&lt; EOF</span><br><span class="line">export PS1="[\t]\[\$(tput setaf 1)\][\u@\h:\w]\[\$(tput setaf 7)\]\\\\\$ \[\$(tput sgr0)\]"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改APT源"><a href="#修改APT源" class="headerlink" title="修改APT源"></a>修改APT源</h2><p><code>/etc/apt/sources.list</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 预发布软件源，不建议启用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> deb https://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br></pre></td></tr></table></figure><h2 id="刷新APT缓存"><a href="#刷新APT缓存" class="headerlink" title="刷新APT缓存"></a>刷新APT缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure><h2 id="更新系统软件"><a href="#更新系统软件" class="headerlink" title="更新系统软件"></a>更新系统软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt upgrade</span><br></pre></td></tr></table></figure><h2 id="安装常用软件"><a href="#安装常用软件" class="headerlink" title="安装常用软件"></a>安装常用软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apt install git \</span><br><span class="line">                 tree \</span><br><span class="line">                 software-properties-common \</span><br><span class="line">                 dirmngr \</span><br><span class="line">                 apt-transport-https \</span><br><span class="line">                 jq \</span><br><span class="line">                 socat \</span><br><span class="line">                 tcpdump \</span><br><span class="line">                 vim \</span><br><span class="line">                 ipvsadm \</span><br><span class="line">                 tree \</span><br><span class="line">                 dstat \</span><br><span class="line">                 iotop \</span><br><span class="line">                 htop \</span><br><span class="line">                 atop \</span><br><span class="line">                 socat \</span><br><span class="line">                 ipset \</span><br><span class="line">                 conntrack \</span><br><span class="line">                 netcat \</span><br><span class="line">                 bash-completion \</span><br><span class="line">                 ufw \</span><br><span class="line">                 ca-certificates \</span><br><span class="line">                 curl \</span><br><span class="line">                 gnupg2 \</span><br><span class="line">                 sudo \</span><br><span class="line">                 unzip \</span><br><span class="line">                 uuid \</span><br><span class="line">                 gnupg-agent \</span><br><span class="line">                 sysstat \</span><br><span class="line">                 nethogs \</span><br><span class="line">                 linux-tools-common</span><br></pre></td></tr></table></figure><h2 id="禁用系统服务"><a href="#禁用系统服务" class="headerlink" title="禁用系统服务"></a>禁用系统服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable iscsid.socket \</span><br><span class="line">                  iscsi.service \</span><br><span class="line">                  open-iscsi.service \</span><br><span class="line">                  rsync.service \</span><br><span class="line">                  ufw.service \</span><br><span class="line">                  uuidd.socket</span><br></pre></td></tr></table></figure><h2 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h2><ul><li>Ubuntu 18.04 LTS 使用netplan来管理网络配置，可以使用<code>NetworkManager</code>或者<code>Systemd-networkd</code>的网络守护程序来做为内核的接口。</li><li>如果再通过原来的 <code>ifupdown</code> 工具包继续在 <code>/etc/network/interfaces</code> 文件里配置管理网络接口是无效的。</li><li><p>默认的<code>systemd-resolve</code>会接管<code>/etc/resolv.conf</code>，无法直接修改，并且会监听<code>localhost:53</code>端口，看着非常不爽。修改过程如下</p></li><li><p>网卡配置文件路径<code>/etc/netplan/50-cloud-init.yaml</code>，配置文件的样例在<a href="https://netplan.io/examples" target="_blank" rel="noopener">这里</a></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file is generated from information provided by</span></span><br><span class="line"><span class="comment"># the datasource.  Changes to it will not persist across an instance.</span></span><br><span class="line"><span class="comment"># To disable cloud-init's network configuration capabilities, write a file</span></span><br><span class="line"><span class="comment"># /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:</span></span><br><span class="line"><span class="comment"># network: &#123;config: disabled&#125;</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">    ethernets:</span></span><br><span class="line"><span class="attr">        ens33:</span></span><br><span class="line"><span class="attr">            addresses:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.100</span><span class="string">/24</span></span><br><span class="line"><span class="attr">            dhcp4:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">            gateway4:</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.2</span></span><br><span class="line"><span class="attr">            nameservers:</span></span><br><span class="line"><span class="attr">                addresses:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br><span class="line"><span class="bullet">                -</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="attr">                search:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    renderer:</span> <span class="string">networkd</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><ul><li>使用netplan命令让配置生效</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><blockquote><p>这时候会发现，<code>/etc/resolv.conf</code>里面的nameserver指向127.0.0.53</p><p>并且是软链接到<code>/run/systemd/resolve/stub-resolv.conf</code></p><p>内容如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> This file is managed by man:systemd-resolved(8). Do not edit.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is a dynamic resolv.conf file <span class="keyword">for</span> connecting <span class="built_in">local</span> clients to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> internal DNS stub resolver of systemd-resolved. This file lists all</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> configured search domains.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Run <span class="string">"systemd-resolve --status"</span> to see details about the uplink DNS servers</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> currently <span class="keyword">in</span> use.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Third party programs must not access this file directly, but only through the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> symlink at /etc/resolv.conf. To manage man:resolv.conf(5) <span class="keyword">in</span> a different way,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replace this symlink by a static file or a different symlink.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See man:systemd-resolved.service(8) <span class="keyword">for</span> details about the supported modes of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> operation <span class="keyword">for</span> /etc/resolv.conf.</span></span><br><span class="line"></span><br><span class="line">nameserver 127.0.0.53</span><br><span class="line">options edns0</span><br></pre></td></tr></table></figure><ul><li>修改systemd-resolv的配置文件<code>/etc/systemd/resolved.conf</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">  This file is part of systemd.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  (at your option) any later version.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Entries <span class="keyword">in</span> this file show the compile time defaults.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can change settings by editing this file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Defaults can be restored by simply deleting this file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See resolved.conf(5) <span class="keyword">for</span> details</span></span><br><span class="line"></span><br><span class="line">[Resolve]</span><br><span class="line"><span class="meta">#</span><span class="bash">DNS=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">FallbackDNS=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Domains=</span></span><br><span class="line">LLMNR=no</span><br><span class="line">MulticastDNS=no</span><br><span class="line">DNSSEC=no</span><br><span class="line">Cache=yes</span><br><span class="line">DNSStubListener=no</span><br></pre></td></tr></table></figure><ul><li>重启systemd-resolv服务</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-resolved.service</span><br></pre></td></tr></table></figure><ul><li>修改<code>/etc/resolv.conf</code>软链接指向</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -svf /run/systemd/resolve/resolv.conf /etc/resolv.conf</span><br></pre></td></tr></table></figure><ul><li>现在再看<code>/etc/resolv.conf</code>的内容就舒服了</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> This file is managed by man:systemd-resolved(8). Do not edit.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is a dynamic resolv.conf file <span class="keyword">for</span> connecting <span class="built_in">local</span> clients directly to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> all known uplink DNS servers. This file lists all configured search domains.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Third party programs must not access this file directly, but only through the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> symlink at /etc/resolv.conf. To manage man:resolv.conf(5) <span class="keyword">in</span> a different way,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replace this symlink by a static file or a different symlink.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See man:systemd-resolved.service(8) <span class="keyword">for</span> details about the supported modes of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> operation <span class="keyword">for</span> /etc/resolv.conf.</span></span><br><span class="line"></span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure><h2 id="修改HISTORY参数"><a href="#修改HISTORY参数" class="headerlink" title="修改HISTORY参数"></a>修改HISTORY参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/profile.d/history.sh &lt;&lt;EOF</span><br><span class="line">export HISTSIZE=10000</span><br><span class="line">export HISTFILESIZE=10000</span><br><span class="line">export HISTCONTROL=ignoredups</span><br><span class="line">export HISTTIMEFORMAT="`whoami` %F %T "</span><br><span class="line">export HISTIGNORE="ls:pwd:ll:ls -l:ls -a:ll -a"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><h2 id="配置时间同步"><a href="#配置时间同步" class="headerlink" title="配置时间同步"></a>配置时间同步</h2><ul><li>Ubuntu 18.04 LTS 使用<code>systemd-timesyncd</code>实现跨网络同步系统时钟的守护服务，与NTP的复杂实现相比，这个服务简单的多，它只专注于从远程服务器查询然后同步到本地时钟。</li><li>守护进程运行只需要尽可能小特权，并且会跟网络服务 networkd 挂钩，仅在网络连接可用时才工作。</li><li>配置文件路径<code>/etc/systemd/timesyncd.conf</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#NTP=.*,NTP=cn.pool.ntp.org,' -i /etc/systemd/timesyncd.conf</span><br></pre></td></tr></table></figure><ul><li>重启systemd-timesyncd服务</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-timesyncd.service</span><br></pre></td></tr></table></figure><h2 id="修改LANG默认值"><a href="#修改LANG默认值" class="headerlink" title="修改LANG默认值"></a>修改LANG默认值</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">localectl set-locale LANG=en_US.UTF-8</span><br><span class="line">localectl set-keymap us</span><br><span class="line">localectl set-x11-keymap us</span><br></pre></td></tr></table></figure><h2 id="修改SSH配置"><a href="#修改SSH配置" class="headerlink" title="修改SSH配置"></a>修改SSH配置</h2><blockquote><p>这里禁用root通过密码方式登录，修改默认端口<code>22</code>→<code>2233</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#PermitRootLogin prohibit-password,PermitRootLogin prohibit-password,' \</span><br><span class="line">    -e 's,^#PubkeyAuthentication yes,PubkeyAuthentication yes,' \</span><br><span class="line">    -e 's,^#UseDNS no,UseDNS no,' \</span><br><span class="line">    -e 's,^#Port 22,Port 2233,' \</span><br><span class="line">    -i /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><h1 id="可选操作"><a href="#可选操作" class="headerlink" title="可选操作"></a>可选操作</h1><h2 id="禁用终端欢迎消息广告"><a href="#禁用终端欢迎消息广告" class="headerlink" title="禁用终端欢迎消息广告"></a>禁用终端欢迎消息广告</h2><ul><li>关闭获取Ubuntu新闻</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^ENABLED=1,ENABLED=0,g' -i /etc/default/motd-news</span><br></pre></td></tr></table></figure><ul><li>关闭动态motd不需要的内容</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod -x /etc/update-motd.d/80-livepatch</span><br><span class="line">chmod -x /etc/update-motd.d/10-help-text</span><br></pre></td></tr></table></figure><h2 id="禁用IPV6设置"><a href="#禁用IPV6设置" class="headerlink" title="禁用IPV6设置"></a>禁用IPV6设置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-disable-ipv6.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用ipv6</span></span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6=1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="禁用ICMP"><a href="#禁用ICMP" class="headerlink" title="禁用ICMP"></a>禁用ICMP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-disable-icmp.conf &lt;&lt;EOF</span><br><span class="line">net.ipv4.icmp_echo_ignore_all=1</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="添加vim设置"><a href="#添加vim设置" class="headerlink" title="添加vim设置"></a>添加vim设置</h2><blockquote><p>将vim设置写入<code>~/.vimrc</code>文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/.vimrc &lt;&lt;EOF</span><br><span class="line">" 显示行号</span><br><span class="line">set number</span><br><span class="line">" 高亮光标所在行</span><br><span class="line">set cursorline</span><br><span class="line">" 打开语法显示</span><br><span class="line">syntax on</span><br><span class="line">" 关闭备份</span><br><span class="line">set nobackup</span><br><span class="line">" 没有保存或文件只读时弹出确认</span><br><span class="line">set confirm</span><br><span class="line">" 禁用modeline功能</span><br><span class="line">set nomodeline</span><br><span class="line">" tab缩进</span><br><span class="line">set tabstop=4</span><br><span class="line">set shiftwidth=4</span><br><span class="line">set expandtab</span><br><span class="line">set smarttab</span><br><span class="line">" 默认缩进4个空格大小 </span><br><span class="line">set shiftwidth=4 </span><br><span class="line">" 文件自动检测外部更改</span><br><span class="line">set autoread</span><br><span class="line">" 高亮查找匹配</span><br><span class="line">set hlsearch</span><br><span class="line">" 显示匹配</span><br><span class="line">set showmatch</span><br><span class="line">" 背景色设置为黑色</span><br><span class="line">set background=dark</span><br><span class="line">" 浅色高亮显示当前行</span><br><span class="line">autocmd InsertLeave * se nocul</span><br><span class="line">" 显示输入的命令</span><br><span class="line">set showcmd</span><br><span class="line">" 字符编码</span><br><span class="line">set encoding=utf-8</span><br><span class="line">" 开启终端256色显示</span><br><span class="line">set t_Co=256</span><br><span class="line">" 增量式搜索 </span><br><span class="line">set incsearch</span><br><span class="line">" 设置默认进行大小写不敏感查找</span><br><span class="line">set ignorecase</span><br><span class="line">" 如果有一个大写字母，则切换到大小写敏感查找</span><br><span class="line">set smartcase</span><br><span class="line">" 不产生swap文件</span><br><span class="line">set noswapfile</span><br><span class="line">" 设置备份时的行为为覆盖</span><br><span class="line">set backupcopy=yes</span><br><span class="line">" 关闭提示音</span><br><span class="line">set noerrorbells</span><br><span class="line">" 历史记录</span><br><span class="line">set history=10000</span><br><span class="line">" 显示行尾空格</span><br><span class="line">set listchars=tab:»■,trail:■</span><br><span class="line">" 显示非可见字符</span><br><span class="line">set list</span><br><span class="line">" c文件自动缩进</span><br><span class="line">set cindent</span><br><span class="line">" 文件自动缩进</span><br><span class="line">set autoindent</span><br><span class="line">" 检测文件类型</span><br><span class="line">filetype on</span><br><span class="line">" 智能缩进</span><br><span class="line">set smartindent</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="配置内核模块"><a href="#配置内核模块" class="headerlink" title="配置内核模块"></a>配置内核模块</h2><h3 id="配置lvs模块"><a href="#配置lvs模块" class="headerlink" title="配置lvs模块"></a>配置lvs模块</h3><p><a href="http://zh.linuxvirtualserver.org/node/2903" target="_blank" rel="noopener">LVS的调度算法简介</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF</span><br><span class="line">ip_vs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-最少连接</span></span><br><span class="line">ip_vs_lc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-加权最少连接</span></span><br><span class="line">ip_vs_wlc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-轮询</span></span><br><span class="line">ip_vs_rr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-加权轮询</span></span><br><span class="line">ip_vs_wrr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 源地址散列调度算法</span></span><br><span class="line">ip_vs_sh</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置连接状态跟踪模块"><a href="#配置连接状态跟踪模块" class="headerlink" title="配置连接状态跟踪模块"></a>配置连接状态跟踪模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/nf_conntrack.conf &lt;&lt;EOF</span><br><span class="line">nf_conntrack</span><br><span class="line">nf_conntrack_ipv4</span><br><span class="line"><span class="meta">#</span><span class="bash">nf_conntrack_ipv6</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置kvm模块"><a href="#配置kvm模块" class="headerlink" title="配置kvm模块"></a>配置kvm模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/kvm.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> Intel CPU开启嵌套虚拟化</span></span><br><span class="line">options kvm-intel nested=1</span><br><span class="line">options kvm-intel enable_shadow_vmcs=1</span><br><span class="line">options kvm-intel enable_apicv=1</span><br><span class="line">options kvm-intel ept=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> AMD CPU开启嵌套虚拟化</span></span><br><span class="line"><span class="meta">#</span><span class="bash">options kvm-amd nested=1</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装Docker-CE"><a href="#安装Docker-CE" class="headerlink" title="安装Docker-CE"></a>安装Docker-CE</h2><ul><li>添加GPG KEY</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | apt-key add -</span><br></pre></td></tr></table></figure><ul><li>添加APT源</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add-apt-repository \</span><br><span class="line">   "deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \</span><br><span class="line"><span class="meta">   $</span><span class="bash">(lsb_release -cs) \</span></span><br><span class="line">   stable"</span><br></pre></td></tr></table></figure><ul><li>刷新APT缓存</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure><ul><li>查找Docker-CE版本</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-cache madison docker-ce</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker-ce | 5:18.09.7~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.6~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.5~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.4~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.3~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.2~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.1~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.0~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.3~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.2~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.1~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.0~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.03.1~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br></pre></td></tr></table></figure><ul><li>安装指定版本的Docker-CE</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install docker-ce=5:18.09.7~3-0~ubuntu-bionic  \</span><br><span class="line">            docker-ce-cli=5:18.09.7~3-0~ubuntu-bionic  \</span><br><span class="line">            containerd.io</span><br></pre></td></tr></table></figure><ul><li>查看docker信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure><ul><li>修改docker配置</li></ul><blockquote><p>配置文件路径<code>/etc/docker/daemon.json</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["https://dockerhub.azk8s.cn"],</span><br><span class="line">    "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">    "insecure-registries": [],</span><br><span class="line">    "log-driver": "json-file",</span><br><span class="line">    "log-opts": &#123;</span><br><span class="line">        "max-size": "100m",</span><br><span class="line">        "max-file": "3"</span><br><span class="line">    &#125;,</span><br><span class="line">    "data-root": "/var/lib/docker",</span><br><span class="line">    "storage-driver": "overlay2",</span><br><span class="line">    "max-concurrent-downloads": 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动docker</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;Ubuntu 18.04 LTS已经出来一年多了，小版本号已经更新到了18.04.2。&lt;/p&gt;&lt;p&gt;这里记录一下Ub
      
    
    </summary>
    
      <category term="Linux" scheme="https://luanlengli.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
</feed>
