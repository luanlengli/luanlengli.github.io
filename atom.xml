<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>luanlengli&#39;s Blog</title>
  
  <subtitle>“不知道”的五大理由，不读，不查，不试，理解能力差，满脑子想着怎么利用他人</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://luanlengli.github.io/"/>
  <updated>2019-05-28T06:32:30.696Z</updated>
  <id>https://luanlengli.github.io/</id>
  
  <author>
    <name>乱愣黎</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>PostgreSQL10搭建时间序列数据库TimescaleDB</title>
    <link href="https://luanlengli.github.io/2019/05/25/PostgreSQL10%E6%90%AD%E5%BB%BA%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%BA%93TimescaleDB.html"/>
    <id>https://luanlengli.github.io/2019/05/25/PostgreSQL10搭建时间序列数据库TimescaleDB.html</id>
    <published>2019-05-25T06:05:38.000Z</published>
    <updated>2019-05-28T06:32:30.696Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>这里只记录搭建和简单测试过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能完整跑起来</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>PostgreSQL版本号<code>10.8</code></p><p>TimescaleDB版本号<code>1.3.0</code></p><p>虚拟机配置<code>1CPU 2G内存 20G系统盘</code></p><p><code>postgres</code>用户默认情况下PGDATA变量是<code>/var/lib/pgsql/10/data</code></p><font color="red">这里没有使用数据盘，有需要的可以自行调整！</font></blockquote><h1 id="TimescaleDB简介"><a href="#TimescaleDB简介" class="headerlink" title="TimescaleDB简介"></a>TimescaleDB简介</h1><p><font color="red">这段介绍是来自德哥的Github文档</font><a href="https://github.com/digoal/blog/blob/master/201704/20170409_05.md" target="_blank" rel="noopener">TimescaleDB介绍</a></p><blockquote><p>TimescaleDB是基于PostgreSQL数据库打造的一款时序数据库，插件化的形式，随着PostgreSQL的版本升级而升级。</p></blockquote><h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="https://github.com/digoal/blog/raw/master/201704/20170409_05_pic_001.jpg" alt=""></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h2><p>这个参考<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html">PostgreSQL10安装部署和初始化</a></p><h1 id="TimescaleDB安装"><a href="#TimescaleDB安装" class="headerlink" title="TimescaleDB安装"></a>TimescaleDB安装</h1><blockquote><p>TimescaleDB的YUM包已经被集成到PostgreSQL社区源里面，所以直接装就是了</p></blockquote><h2 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y timescaledb_10</span><br></pre></td></tr></table></figure><h2 id="配置PostgreSQL"><a href="#配置PostgreSQL" class="headerlink" title="配置PostgreSQL"></a>配置PostgreSQL</h2><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><blockquote><p>在<code>$PGDATA/postgresql.conf</code>添加配置</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shared_preload_libraries = 'timescaledb'</span><br></pre></td></tr></table></figure><h2 id="重启PostgreSQL"><a href="#重启PostgreSQL" class="headerlink" title="重启PostgreSQL"></a>重启PostgreSQL</h2><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">pg_ctl restart -D $PGDATA</span><br></pre></td></tr></table></figure><h2 id="验证TimescaleDB功能"><a href="#验证TimescaleDB功能" class="headerlink" title="验证TimescaleDB功能"></a>验证TimescaleDB功能</h2><blockquote><p>登录PostgreSQL</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><blockquote><p>创建名为<code>tutorial</code>的数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">database</span> tutorial;</span><br></pre></td></tr></table></figure><blockquote><p>切换到<code>tutorial</code>数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\c tutorial</span><br></pre></td></tr></table></figure><blockquote><p>加载TimescaleDB的extensions</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> timescaledb <span class="keyword">CASCADE</span>;</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">WARNING:</span><br><span class="line">WELCOME TO</span><br><span class="line"> _____ _                               _     ____________</span><br><span class="line">|_   _(_)                             | |    |  _  \ ___ \</span><br><span class="line">  | |  _ _ __ ___   ___  ___  ___ __ _| | ___| | | | |_/ /</span><br><span class="line">  | | | |  _ ` _ \ / _ \/ __|/ __/ _` | |/ _ \ | | | ___ \</span><br><span class="line">  | | | | | | | | |  __/\__ \ (_| (_| | |  __/ |/ /| |_/ /</span><br><span class="line">  |_| |_|_| |_| |_|\___||___/\___\__,_|_|\___|___/ \____/</span><br><span class="line">               Running version 1.3.0</span><br><span class="line">For more information on TimescaleDB, please visit the following links:</span><br><span class="line"></span><br><span class="line"> 1. Getting started: https://docs.timescale.com/getting-started</span><br><span class="line"> 2. API reference documentation: https://docs.timescale.com/api</span><br><span class="line"> 3. How TimescaleDB is designed: https://docs.timescale.com/introduction/architecture</span><br><span class="line"></span><br><span class="line">Note: TimescaleDB collects anonymous reports to better understand and assist our users.</span><br><span class="line">For more information and how to disable, please see our docs https://docs.timescaledb.com/using-timescaledb/telemetry.</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br></pre></td></tr></table></figure><blockquote><p>创建一个普通SQL标准的表</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> conditions (</span><br><span class="line">  <span class="built_in">time</span>        TIMESTAMPTZ       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  location    <span class="built_in">TEXT</span>              <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  temperature <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>  <span class="literal">NULL</span>,</span><br><span class="line">  humidity    <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>  <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>查看表结构</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># \d conditions</span></span><br><span class="line">                        Table "public.conditions"</span><br><span class="line">   Column    |           Type           | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+--------------------------+-----------+----------+---------</span></span><br><span class="line"> time        | timestamp <span class="keyword">with</span> <span class="built_in">time</span> zone |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> location    | <span class="built_in">text</span>                     |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> temperature | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"> humidity    | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br></pre></td></tr></table></figure><blockquote><p>使用<code>create_hypertable</code>创建<code>hypertable</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> create_hypertable(<span class="string">'conditions'</span>, <span class="string">'time'</span>);</span><br><span class="line">    create_hypertable</span><br><span class="line"><span class="comment">-------------------------</span></span><br><span class="line"> (1,public,conditions,t)</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><blockquote><p>这时再看表结构的时候，会发现不一样了</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># \d conditions</span></span><br><span class="line">                        Table "public.conditions"</span><br><span class="line">   Column    |           Type           | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+--------------------------+-----------+----------+---------</span></span><br><span class="line"> time        | timestamp <span class="keyword">with</span> <span class="built_in">time</span> zone |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> location    | <span class="built_in">text</span>                     |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> temperature | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"> humidity    | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"><span class="keyword">Indexes</span>:</span><br><span class="line">    <span class="string">"conditions_time_idx"</span> btree (<span class="string">"time"</span> <span class="keyword">DESC</span>)</span><br><span class="line"><span class="keyword">Triggers</span>:</span><br><span class="line">    ts_insert_blocker <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> conditions <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> _timescaledb_internal.insert_blocker()</span><br></pre></td></tr></table></figure><blockquote><p>插入数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># INSERT INTO conditions(time, location, temperature, humidity) VALUES (NOW(), 'office', 70.0, 50.0);</span></span><br></pre></td></tr></table></figure><blockquote><p>查询数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># SELECT * FROM conditions ORDER BY time DESC LIMIT 100;</span></span><br><span class="line">             time              | location | temperature | humidity</span><br><span class="line"><span class="comment">-------------------------------+----------+-------------+----------</span></span><br><span class="line"> YYYY-MM-DD HH:mm:SS.354351+08 | office   |          70 |       50</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h1 id="TimescaleDB-Tutorials"><a href="#TimescaleDB-Tutorials" class="headerlink" title="TimescaleDB Tutorials"></a>TimescaleDB Tutorials</h1><blockquote><p>这里使用TimescaleDB官方的测试样例</p><p>地址在<a href="https://docs.timescale.com/v1.3/tutorials" target="_blank" rel="noopener">这里</a></p></blockquote><h2 id="纽约TAXI数据透视分析"><a href="#纽约TAXI数据透视分析" class="headerlink" title="纽约TAXI数据透视分析"></a>纽约TAXI数据透视分析</h2><h3 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h3><blockquote><p>这里直接下载的同时解压压缩包</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://timescaledata.blob.core.windows.net/datasets/nyc_data.tar.gz | tar xz</span><br></pre></td></tr></table></figure><blockquote><p>解压出来有三个文件</p></blockquote><ul><li><code>nyc_data_contagg.sql</code></li><li><code>nyc_data.sql</code></li><li><code>nyc_data_rides.csv</code></li></ul><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nyc_data;</span><br><span class="line">\c nyc_data</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> timescaledb <span class="keyword">CASCADE</span>;</span><br></pre></td></tr></table></figure><h4 id="创建表结构"><a href="#创建表结构" class="headerlink" title="创建表结构"></a>创建表结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -d nyc_data -h localhost &lt; nyc_data.sql</span><br></pre></td></tr></table></figure><h4 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -d nyc_data -h localhost -c "\COPY rides FROM nyc_data_rides.csv CSV"</span><br></pre></td></tr></table></figure><h4 id="查看表"><a href="#查看表" class="headerlink" title="查看表"></a>查看表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \dt</span></span><br><span class="line">             List of relations</span><br><span class="line"> Schema |     Name      | Type  |  Owner</span><br><span class="line"><span class="comment">--------+---------------+-------+----------</span></span><br><span class="line"> public | payment_types | table | postgres</span><br><span class="line"> public | rates         | table | postgres</span><br><span class="line"> public | rides         | table | postgres</span><br><span class="line">(3 rows)</span><br></pre></td></tr></table></figure><h4 id="查看表结构"><a href="#查看表结构" class="headerlink" title="查看表结构"></a>查看表结构</h4><ul><li>payments</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \d payment_types</span></span><br><span class="line">              Table "public.payment_types"</span><br><span class="line">    Column    |  Type   | Collation | Nullable | Default</span><br><span class="line"><span class="comment">--------------+---------+-----------+----------+---------</span></span><br><span class="line"> payment_type | integer |           |          |</span><br><span class="line"> description  | text    |           |          |</span><br></pre></td></tr></table></figure><ul><li>rates</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \d rates</span></span><br><span class="line">                  Table "public.rates"</span><br><span class="line">   Column    |  Type   | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+---------+-----------+----------+---------</span></span><br><span class="line"> rate_code   | integer |           |          |</span><br><span class="line"> description | text    |           |          |</span><br></pre></td></tr></table></figure><ul><li>rides</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># \d+ rides;</span></span><br><span class="line">                                                     Table "public.rides"</span><br><span class="line">        Column         |            Type             | Collation | Nullable | Default | Storage  | Stats target | Description</span><br><span class="line"><span class="comment">-----------------------+-----------------------------+-----------+----------+---------+----------+--------------+-------------</span></span><br><span class="line"> vendor_id             | text                        |           |          |         | extended |              |</span><br><span class="line"> pickup_datetime       | timestamp without time zone |           | not null |         | plain    |              |</span><br><span class="line"> dropoff_datetime      | timestamp without time zone |           | not null |         | plain    |              |</span><br><span class="line"> passenger_count       | numeric                     |           |          |         | main     |              |</span><br><span class="line"> trip_distance         | numeric                     |           |          |         | main     |              |</span><br><span class="line"> pickup_longitude      | numeric                     |           |          |         | main     |              |</span><br><span class="line"> pickup_latitude       | numeric                     |           |          |         | main     |              |</span><br><span class="line"> rate_code             | integer                     |           |          |         | plain    |              |</span><br><span class="line"> dropoff_longitude     | numeric                     |           |          |         | main     |              |</span><br><span class="line"> dropoff_latitude      | numeric                     |           |          |         | main     |              |</span><br><span class="line"> payment_type          | integer                     |           |          |         | plain    |              |</span><br><span class="line"> fare_amount           | numeric                     |           |          |         | main     |              |</span><br><span class="line"> extra                 | numeric                     |           |          |         | main     |              |</span><br><span class="line"> mta_tax               | numeric                     |           |          |         | main     |              |</span><br><span class="line"> tip_amount            | numeric                     |           |          |         | main     |              |</span><br><span class="line"> tolls_amount          | numeric                     |           |          |         | main     |              |</span><br><span class="line"> improvement_surcharge | numeric                     |           |          |         | main     |              |</span><br><span class="line"> total_amount          | numeric                     |           |          |         | main     |              |</span><br><span class="line">Indexes:</span><br><span class="line">    "rides_passenger_count_pickup_datetime_idx" btree (passenger_count, pickup_datetime DESC)</span><br><span class="line">    "rides_pickup_datetime_vendor_id_idx" btree (pickup_datetime DESC, vendor_id)</span><br><span class="line">    "rides_rate_code_pickup_datetime_idx" btree (rate_code, pickup_datetime DESC)</span><br><span class="line">    "rides_vendor_id_pickup_datetime_idx" btree (vendor_id, pickup_datetime DESC)</span><br><span class="line">Triggers:</span><br><span class="line">    ts_insert_blocker BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> rides <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> _timescaledb_internal.insert_blocker()</span><br><span class="line"><span class="keyword">Child</span> <span class="keyword">tables</span>: _timescaledb_internal._hyper_2_10_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_11_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_12_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_1_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_2_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_3_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_4_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_5_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_6_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_7_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_8_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_9_chunk</span><br></pre></td></tr></table></figure><h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><h4 id="普通查询"><a href="#普通查询" class="headerlink" title="普通查询"></a>普通查询</h4><blockquote><p>1月1日至1月10日，同车超过两人，每天平均计费是多少</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT date_trunc('day', pickup_datetime) as day, avg(fare_amount)</span></span><br><span class="line">nyc_data-<span class="comment"># FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># WHERE passenger_count &gt; 1 AND (pickup_datetime &gt;= '2016-01-01' AND pickup_datetime &lt;= '2016-01-10')</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY day ORDER BY day;</span></span><br><span class="line">         day         |         avg</span><br><span class="line"><span class="comment">---------------------+---------------------</span></span><br><span class="line"> 2016-01-01 00:00:00 | 13.3990821679715529</span><br><span class="line"> 2016-01-02 00:00:00 | 13.0224687415181399</span><br><span class="line"> 2016-01-03 00:00:00 | 13.5382068607068607</span><br><span class="line"> 2016-01-04 00:00:00 | 12.9618895561740149</span><br><span class="line"> 2016-01-05 00:00:00 | 12.6614611935518309</span><br><span class="line"> 2016-01-06 00:00:00 | 12.5775245695086098</span><br><span class="line"> 2016-01-07 00:00:00 | 12.5868802584437019</span><br><span class="line"> 2016-01-08 00:00:00 | 12.4288630909742120</span><br><span class="line"> 2016-01-09 00:00:00 | 11.8049625897430078</span><br><span class="line"> 2016-01-10 00:00:00 | 27.2500000000000000</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure><blockquote><p>查询每天交易了多少笔，只显示头五个记录</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT date_trunc('day', pickup_datetime) as day, COUNT(*) FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY day ORDER BY day</span></span><br><span class="line">nyc_data-<span class="comment"># LIMIT 5;</span></span><br><span class="line">         day         | count</span><br><span class="line"><span class="comment">---------------------+--------</span></span><br><span class="line"> 2016-01-01 00:00:00 | 345037</span><br><span class="line"> 2016-01-02 00:00:00 | 312831</span><br><span class="line"> 2016-01-03 00:00:00 | 302878</span><br><span class="line"> 2016-01-04 00:00:00 | 316171</span><br><span class="line"> 2016-01-05 00:00:00 | 343251</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure><h4 id="使用TimescaleDB内置函数"><a href="#使用TimescaleDB内置函数" class="headerlink" title="使用TimescaleDB内置函数"></a>使用TimescaleDB内置函数</h4><blockquote><p>每5分钟间隔为一个BUCKET，输出每个间隔产生了多少笔订单</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT time_bucket('5 minute', pickup_datetime) as five_min, count(*)  </span></span><br><span class="line">nyc_data=<span class="comment"># FROM rides  </span></span><br><span class="line">nyc_data=<span class="comment"># WHERE pickup_datetime &lt; '2016-01-01 02:00'  </span></span><br><span class="line">nyc_data=<span class="comment"># GROUP BY five_min ORDER BY five_min; </span></span><br><span class="line"></span><br><span class="line">      five_min       | count</span><br><span class="line"><span class="comment">---------------------+-------</span></span><br><span class="line"> 2016-01-01 00:00:00 |   703</span><br><span class="line"> 2016-01-01 00:05:00 |  1482</span><br><span class="line"> 2016-01-01 00:10:00 |  1959</span><br><span class="line"> 2016-01-01 00:15:00 |  2200</span><br><span class="line"> 2016-01-01 00:20:00 |  2285</span><br><span class="line"> 2016-01-01 00:25:00 |  2291</span><br><span class="line"> 2016-01-01 00:30:00 |  2349</span><br><span class="line"> 2016-01-01 00:35:00 |  2328</span><br><span class="line"> 2016-01-01 00:40:00 |  2440</span><br><span class="line"> 2016-01-01 00:45:00 |  2372</span><br><span class="line"> 2016-01-01 00:50:00 |  2388</span><br><span class="line"> 2016-01-01 00:55:00 |  2473</span><br><span class="line"> 2016-01-01 01:00:00 |  2395</span><br><span class="line"> 2016-01-01 01:05:00 |  2510</span><br><span class="line"> 2016-01-01 01:10:00 |  2412</span><br><span class="line"> 2016-01-01 01:15:00 |  2482</span><br><span class="line"> 2016-01-01 01:20:00 |  2428</span><br><span class="line"> 2016-01-01 01:25:00 |  2433</span><br><span class="line"> 2016-01-01 01:30:00 |  2337</span><br><span class="line"> 2016-01-01 01:35:00 |  2366</span><br><span class="line"> 2016-01-01 01:40:00 |  2325</span><br><span class="line"> 2016-01-01 01:45:00 |  2257</span><br><span class="line"> 2016-01-01 01:50:00 |  2316</span><br><span class="line"> 2016-01-01 01:55:00 |  2250</span><br><span class="line">(24 rows)</span><br></pre></td></tr></table></figure><blockquote><p>每个城市的TAXI交易量</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT rates.description, COUNT(vendor_id) as num_trips FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># JOIN rates on rides.rate_code = rates.rate_code</span></span><br><span class="line">nyc_data-<span class="comment"># WHERE pickup_datetime &lt; '2016-01-08'</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY rates.description ORDER BY rates.description;</span></span><br><span class="line">      description      | num_trips</span><br><span class="line"><span class="comment">-----------------------+-----------</span></span><br><span class="line"> group ride            |        17</span><br><span class="line"> JFK                   |     54832</span><br><span class="line"> Nassau or Westchester |       967</span><br><span class="line"> negotiated fare       |      7193</span><br><span class="line"> Newark                |      4126</span><br><span class="line"> standard rate         |   2266401</span><br><span class="line">(6 rows)</span><br></pre></td></tr></table></figure><h4 id="查看select执行计划"><a href="#查看select执行计划" class="headerlink" title="查看select执行计划"></a>查看select执行计划</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># EXPLAIN SELECT * FROM rides;</span></span><br><span class="line">                                    QUERY PLAN</span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"> Append  (cost=0.00..282354.03 rows=5963403 width=258)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_1_chunk  (cost=0.00..23485.78 rows=781178 width=113)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_2_chunk  (cost=0.00..36322.06 rows=1187506 width=115)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_3_chunk  (cost=0.00..32909.67 rows=1075467 width=116)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_4_chunk  (cost=0.00..15601.72 rows=518772 width=112)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_5_chunk  (cost=0.00..20396.28 rows=281328 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_6_chunk  (cost=0.00..41670.68 rows=574768 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_7_chunk  (cost=0.00..20921.76 rows=288576 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_8_chunk  (cost=0.00..42966.40 rows=592640 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_9_chunk  (cost=0.00..15160.04 rows=209104 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_10_chunk  (cost=0.00..32896.44 rows=453744 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_11_chunk  (cost=0.00..11.60 rows=160 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_12_chunk  (cost=0.00..11.60 rows=160 width=472)</span><br><span class="line">(13 rows)</span><br></pre></td></tr></table></figure><h3 id="TimescaleDB-PostGIS实现时间-空间数据库"><a href="#TimescaleDB-PostGIS实现时间-空间数据库" class="headerlink" title="TimescaleDB+PostGIS实现时间+空间数据库"></a>TimescaleDB+PostGIS实现时间+空间数据库</h3><h4 id="安装PostGIS"><a href="#安装PostGIS" class="headerlink" title="安装PostGIS"></a>安装PostGIS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgis25_10</span><br></pre></td></tr></table></figure><h4 id="加载PostGIS"><a href="#加载PostGIS" class="headerlink" title="加载PostGIS"></a>加载PostGIS</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># create extension postgis;</span></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br></pre></td></tr></table></figure><h4 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># ALTER TABLE rides ADD COLUMN pickup_geom geometry(POINT,2163);</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span></span><br><span class="line">postgres=<span class="comment"># ALTER TABLE rides ADD COLUMN dropoff_geom geometry(POINT,2163);</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span></span><br><span class="line">postgres=<span class="comment"># UPDATE rides SET pickup_geom = ST_Transform(ST_SetSRID(ST_MakePoint(pickup_longitude,pickup_latitude),4326),2163);</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">10906860</span></span><br><span class="line">postgres=<span class="comment"># UPDATE rides SET dropoff_geom = ST_Transform(ST_SetSRID(ST_MakePoint(dropoff_longitude,dropoff_latitude),4326),2163);</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">10906860</span></span><br></pre></td></tr></table></figure><h4 id="查询数据-1"><a href="#查询数据-1" class="headerlink" title="查询数据"></a>查询数据</h4><blockquote><p>查询在(lat, long) (40.7589,-73.9851)附近400米范围内，每30分钟有多少辆的士被乘坐</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># SELECT time_bucket('30 minutes', pickup_datetime) AS thirty_min, COUNT(*) AS near_times_sq</span></span><br><span class="line">postgres-<span class="comment">#   FROM rides</span></span><br><span class="line">postgres-<span class="comment">#   WHERE ST_Distance(pickup_geom, ST_Transform(ST_SetSRID(ST_MakePoint(-73.9851,40.7589),4326),2163)) &lt; 400</span></span><br><span class="line">postgres-<span class="comment">#     AND pickup_datetime &lt; '2016-01-01 14:00'</span></span><br><span class="line">postgres-<span class="comment">#   GROUP BY thirty_min ORDER BY thirty_min;</span></span><br><span class="line">     thirty_min      | near_times_sq</span><br><span class="line"><span class="comment">---------------------+---------------</span></span><br><span class="line"> 2016-01-01 00:00:00 |            74</span><br><span class="line"> 2016-01-01 00:30:00 |           102</span><br><span class="line"> 2016-01-01 01:00:00 |           120</span><br><span class="line"> 2016-01-01 01:30:00 |            98</span><br><span class="line"> 2016-01-01 02:00:00 |           112</span><br><span class="line"> 2016-01-01 02:30:00 |           109</span><br><span class="line"> 2016-01-01 03:00:00 |           163</span><br><span class="line"> 2016-01-01 03:30:00 |           181</span><br><span class="line"> 2016-01-01 04:00:00 |           214</span><br><span class="line"> 2016-01-01 04:30:00 |           185</span><br><span class="line"> 2016-01-01 05:00:00 |           158</span><br><span class="line"> 2016-01-01 05:30:00 |           113</span><br><span class="line"> 2016-01-01 06:00:00 |           102</span><br><span class="line"> 2016-01-01 06:30:00 |            91</span><br><span class="line"> 2016-01-01 07:00:00 |            88</span><br><span class="line"> 2016-01-01 07:30:00 |            58</span><br><span class="line"> 2016-01-01 08:00:00 |            72</span><br><span class="line"> 2016-01-01 08:30:00 |            94</span><br><span class="line"> 2016-01-01 09:00:00 |           115</span><br><span class="line"> 2016-01-01 09:30:00 |           118</span><br><span class="line"> 2016-01-01 10:00:00 |           135</span><br><span class="line"> 2016-01-01 10:30:00 |           160</span><br><span class="line"> 2016-01-01 11:00:00 |           212</span><br><span class="line"> 2016-01-01 11:30:00 |           229</span><br><span class="line"> 2016-01-01 12:00:00 |           244</span><br><span class="line"> 2016-01-01 12:30:00 |           230</span><br><span class="line"> 2016-01-01 13:00:00 |           235</span><br><span class="line"> 2016-01-01 13:30:00 |           238</span><br><span class="line">(28 rows)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里只记录搭建和简单测试过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10流复制配合PGPool-II实现数据库HA主备切换</title>
    <link href="https://luanlengli.github.io/2019/05/24/PostgreSQL10%E6%B5%81%E5%A4%8D%E5%88%B6-PGPool-II%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93HA%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2.html"/>
    <id>https://luanlengli.github.io/2019/05/24/PostgreSQL10流复制-PGPool-II实现数据库HA主备切换.html</id>
    <published>2019-05-24T03:01:59.000Z</published>
    <updated>2019-05-27T03:23:00.007Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>这里只记录搭建和简单测试过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能完整跑起来</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>PostgreSQL版本号<code>10.8</code></p><p>PGPool版本号<code>4.0.5</code></p><p>虚拟机配置<code>1CPU 2G内存 20G系统盘</code></p><p><code>postgres</code>用户默认情况下PGDATA变量是<code>/var/lib/pgsql/10/data</code></p><p>这里没有使用数据盘，有需要的可以自行调整！</p><p>由watchdog通过ARP协议提供的VIP切换来保证服务可用性，这里不涉及负载均衡！</p><font color="red">注意！在某些公有云环境不一定支持基于ARP协议做VIP</font></blockquote><h1 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h1><p><img src="https://fatdragon.me/sites/default/files/watchdog_master_slave.png" alt="PGPool内部如何管理后端PostgreSQL数据库"></p><p><img src="/2019/05/24/./PostgreSQL10流复制-PGPool-II实现数据库HA主备切换\客户端通过PGPool访问PostgreSQL数据库.png" alt="客户端通过PGPool访问PostgreSQL数据库"></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="主机清单"><a href="#主机清单" class="headerlink" title="主机清单"></a>主机清单</h2><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th><th>监听端口</th></tr></thead><tbody><tr><td>vip</td><td>172.16.80.200</td><td>vip</td><td></td></tr><tr><td>pg1</td><td>172.16.80.201</td><td>master</td><td>5432</td></tr><tr><td>pg2</td><td>172.16.80.202</td><td>slave</td><td>5432</td></tr></tbody></table><h2 id="准备基于stream的主从集群"><a href="#准备基于stream的主从集群" class="headerlink" title="准备基于stream的主从集群"></a>准备基于stream的主从集群</h2><p>这里可以看这个链接<a href="https://luanlengli.github.io/2019/05/21/PostgreSQL10%E5%9F%BA%E4%BA%8Estream%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4.html">PostgreSQL10基于stream复制搭建主从集群</a></p><h2 id="修改hosts文件"><a href="#修改hosts文件" class="headerlink" title="修改hosts文件"></a>修改hosts文件</h2><blockquote><p>把每个服务器的主机IP地址做静态解析</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.80.200 vip</span><br><span class="line">172.16.80.201 pg1</span><br><span class="line">172.16.80.202 pg2</span><br></pre></td></tr></table></figure><h2 id="配置系统命令权限"><a href="#配置系统命令权限" class="headerlink" title="配置系统命令权限"></a>配置系统命令权限</h2><blockquote><p>切换脚本需要使用root权限运行</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+s /usr/sbin/ip /usr/sbin/arping</span><br></pre></td></tr></table></figure><h2 id="配置SSH密钥"><a href="#配置SSH密钥" class="headerlink" title="配置SSH密钥"></a>配置SSH密钥</h2><ul><li>修改postgres用户的密码</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd postgres</span><br></pre></td></tr></table></figure><ul><li>切换到postgres用户</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><ul><li>生成SSH密钥</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ecdsa -b 521 -N '' -f ~/.ssh/id_ecdsa</span><br></pre></td></tr></table></figure><ul><li>配置SSH免密登录</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id pg1</span><br><span class="line">ssh-copy-id pg2</span><br></pre></td></tr></table></figure><h1 id="PGPool"><a href="#PGPool" class="headerlink" title="PGPool"></a>PGPool</h1><h2 id="创建PGPool健康检查用户"><a href="#创建PGPool健康检查用户" class="headerlink" title="创建PGPool健康检查用户"></a>创建PGPool健康检查用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create user pgpool_check with password 'pgpool_password';</span><br><span class="line">grant all privileges on database postgres to pgpool_check;</span><br></pre></td></tr></table></figure><h2 id="安装PGPool"><a href="#安装PGPool" class="headerlink" title="安装PGPool"></a>安装PGPool</h2><blockquote><p>PGPool在PostgreSQL社区提供的YUM源里面有，直接装就是了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pgpool-II-10-4.0.5-1.rhel7 pgpool-II-10-extensions-4.0.5-1.rhel7</span><br></pre></td></tr></table></figure><blockquote><p>PGPool也提供了WebUI方便管理，按需安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pgpoolAdmin</span><br></pre></td></tr></table></figure><h2 id="配置PGPool"><a href="#配置PGPool" class="headerlink" title="配置PGPool"></a>配置PGPool</h2><blockquote><p>配置文件的目录在<code>/etc/pgpool-II-10</code></p></blockquote><h3 id="配置pcp-conf"><a href="#配置pcp-conf" class="headerlink" title="配置pcp.conf"></a>配置pcp.conf</h3><blockquote><p><code>pcp.conf</code>是配置<code>pgpool-II</code>自己的用户名和密码</p></blockquote><ul><li>使用pg_md5命令加密密码</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_md5 pgpool_password</span><br></pre></td></tr></table></figure><ul><li>输出示例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4aa0cb9673e84b06d4c8a848c80eb5d0</span><br></pre></td></tr></table></figure><ul><li>添加到<code>pcp.conf</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres:4aa0cb9673e84b06d4c8a848c80eb5d0</span><br></pre></td></tr></table></figure><h3 id="配置pool-hba-conf"><a href="#配置pool-hba-conf" class="headerlink" title="配置pool_hba.conf"></a>配置pool_hba.conf</h3><blockquote><p><code>pool_hba.conf</code>跟PostgreSQL里面的<code>pg_hba.conf</code>作用一样，可以拷贝<code>pg_hba.conf</code>的内容过来</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认配置数据库主机以socket、127.0.0.1、::1的方式连接数据库可以跳过认证阶段直接登录数据库</span></span><br><span class="line">local   all             all                                     trust</span><br><span class="line">host    all             all             127.0.0.1/32            trust</span><br><span class="line">host    all             all             ::1/128                 trust</span><br><span class="line">host    all             all             172.16.80.0/24          md5</span><br></pre></td></tr></table></figure><h3 id="配置pgpool-conf"><a href="#配置pgpool-conf" class="headerlink" title="配置pgpool.conf"></a>配置pgpool.conf</h3><blockquote><p><code>pgpool.conf</code>可以参考<code>/etc/pgpool-II-10/pgpool.conf.sample</code>的配置</p><p>需要注意的几个点！</p></blockquote><h4 id="master节点"><a href="#master节点" class="headerlink" title="master节点"></a>master节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pgPool-II configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONNECTIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">listen_addresses = '*'</span><br><span class="line">port = 9999</span><br><span class="line">socket_dir = '/tmp'</span><br><span class="line">listen_backlog_multiplier = 2</span><br><span class="line">serialize_accept = off</span><br><span class="line">pcp_listen_addresses = '*'</span><br><span class="line">pcp_port = 9898</span><br><span class="line">pcp_socket_dir = '/tmp'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Backend Connection Settings -</span></span><br><span class="line">backend_hostname0 = 'pg1'</span><br><span class="line">backend_port0 = 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> load_balance_mode为off时不生效</span></span><br><span class="line">backend_weight0 = 1</span><br><span class="line">backend_data_directory0 = '/var/lib/pgsql/10/data'</span><br><span class="line">backend_flag0 = 'ALLOW_TO_FAILOVER'</span><br><span class="line">backend_hostname1 = 'pg2'</span><br><span class="line">backend_port1 = 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> load_balance_mode为off时不生效</span></span><br><span class="line">backend_weight1 = 1</span><br><span class="line">backend_data_directory1 = '/var/lib/pgsql/10/data'</span><br><span class="line">backend_flag1 = 'ALLOW_TO_FAILOVER'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Authentication -</span></span><br><span class="line">enable_pool_hba = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义pool_hba.conf读取password文件</span></span><br><span class="line">pool_passwd = 'pool_passwd'</span><br><span class="line">authentication_timeout = 30</span><br><span class="line">allow_clear_text_frontend_auth = off</span><br><span class="line"><span class="meta">#</span><span class="bash"> - SSL Connections -</span></span><br><span class="line">ssl = off</span><br><span class="line">ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'</span><br><span class="line">ssl_prefer_server_ciphers = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> POOLS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Concurrent session and pool size -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> num_init_children * max_pool的值为PGPool可以接收多少客户端并发连接，计算方式</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (max_pool * num_init_children) &lt; (max_connections - superuser_reserved_connections)</span></span><br><span class="line">num_init_children = 32</span><br><span class="line">max_pool = 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Life time -</span></span><br><span class="line">child_life_time = 600</span><br><span class="line">child_max_connections = 0</span><br><span class="line">connection_life_time = 0</span><br><span class="line">client_idle_limit = 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LOGS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Where to <span class="built_in">log</span> -</span></span><br><span class="line">log_destination = 'stderr'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - What to <span class="built_in">log</span> -</span></span><br><span class="line">log_line_prefix = '%t PID=%p: '</span><br><span class="line">log_connections = on</span><br><span class="line">log_hostname = on</span><br><span class="line">log_statement = on</span><br><span class="line">log_per_node_statement = on</span><br><span class="line">log_client_messages = on</span><br><span class="line">log_standby_delay = 'none'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Syslog specific -</span></span><br><span class="line">syslog_facility = 'LOCAL0'</span><br><span class="line">syslog_ident = 'pgpool'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Debug -</span></span><br><span class="line">log_error_verbosity = verbose</span><br><span class="line"><span class="meta">#</span><span class="bash">client_min_messages = notice</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_messages = warning</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FILE LOCATIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">pid_file_name = '/var/run/pgpool-II-10/pgpool.pid'</span><br><span class="line">logdir = '/var/log/pgpool-II-10'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONNECTION POOLING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">connection_cache = on</span><br><span class="line">reset_query_list = 'ABORT; DISCARD ALL'</span><br><span class="line"><span class="meta">#</span><span class="bash">reset_query_list = <span class="string">'ABORT; RESET ALL; SET SESSION AUTHORIZATION DEFAULT'</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> REPLICATION MODE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">replication_mode = off</span><br><span class="line">replicate_select = off</span><br><span class="line">insert_lock = on</span><br><span class="line">lobj_lock_table = ''</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Degenerate handling -</span></span><br><span class="line">replication_stop_on_mismatch = off</span><br><span class="line">failover_if_affected_tuples_mismatch = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LOAD BALANCING MODE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">load_balance_mode = off</span><br><span class="line">ignore_leading_white_space = on</span><br><span class="line">white_function_list = ''</span><br><span class="line">black_function_list = 'currval,lastval,nextval,setval'</span><br><span class="line">black_query_pattern_list = ''</span><br><span class="line">database_redirect_preference_list = ''</span><br><span class="line">app_name_redirect_preference_list = ''</span><br><span class="line">allow_sql_comments = off</span><br><span class="line">disable_load_balance_on_write = 'transaction'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER/SLAVE MODE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">master_slave_mode = on</span><br><span class="line">master_slave_sub_mode = 'stream'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Streaming -</span></span><br><span class="line">sr_check_period = 3</span><br><span class="line">sr_check_user = 'repluser'</span><br><span class="line">sr_check_password = 'repluser_password'</span><br><span class="line">sr_check_database = 'postgres'</span><br><span class="line">delay_threshold = 'always'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Special commands -</span></span><br><span class="line">follow_master_command = ''</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> HEALTH CHECK GLOBAL PARAMETERS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">health_check_period = 10</span><br><span class="line">health_check_timeout = 3</span><br><span class="line">health_check_user = 'pgpool_check'</span><br><span class="line">health_check_password = 'pgpool_password'</span><br><span class="line">health_check_database = 'postgres'</span><br><span class="line">health_check_max_retries = 3</span><br><span class="line">health_check_retry_delay = 1</span><br><span class="line">connect_timeout = 3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> HEALTH CHECK PER NODE PARAMETERS (OPTIONAL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_period0 = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_timeout0 = 20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_user0 = <span class="string">'nobody'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_password0 = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_database0 = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_max_retries0 = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_retry_delay0 = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">connect_timeout0 = 10000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FAILOVER AND FAILBACK</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">failover_command = '/etc/pgpool-II-10/failover_stream.sh -d %d -h %h -p %p -D %D -M %M -m %m -H %H -P %P -r %r -R %R &gt; /var/lib/pgsql/10/data/log/failover.log'</span><br><span class="line">failback_command = ''</span><br><span class="line">failover_on_backend_error = on</span><br><span class="line">detach_false_primary = off</span><br><span class="line">search_primary_node_timeout = 60</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ONLINE RECOVERY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">recovery_user = 'nobody'</span><br><span class="line">recovery_password = ''</span><br><span class="line">recovery_1st_stage_command = ''</span><br><span class="line">recovery_2nd_stage_command = ''</span><br><span class="line">recovery_timeout = 90</span><br><span class="line">client_idle_limit_in_recovery = 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WATCHDOG</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Enabling -</span></span><br><span class="line">use_watchdog = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> -Connection to up stream servers -</span></span><br><span class="line">trusted_servers = ''</span><br><span class="line">ping_path = '/bin'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Watchdog communication Settings -</span></span><br><span class="line">wd_hostname = 'pg1'</span><br><span class="line">wd_port = 9000</span><br><span class="line">wd_priority = 1</span><br><span class="line">wd_authkey = 'pgpool_watchdog'</span><br><span class="line">wd_ipc_socket_dir = '/tmp'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Virtual IP control Setting -</span></span><br><span class="line">delegate_IP = '172.16.80.200'</span><br><span class="line">if_cmd_path = '/usr/sbin'</span><br><span class="line">if_up_cmd = 'ip addr add $_IP_$/24 dev ens33 label ens33:0'</span><br><span class="line">if_down_cmd = 'ip addr del $_IP_$/24 dev ens33'</span><br><span class="line">arping_path = '/usr/sbin'</span><br><span class="line">arping_cmd = 'arping -U $_IP_$ -w 1'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Behaivor on escalation Setting -</span></span><br><span class="line">clear_memqcache_on_escalation = on</span><br><span class="line">wd_escalation_command = ''</span><br><span class="line">wd_de_escalation_command = ''</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Watchdog consensus settings <span class="keyword">for</span> failover -</span></span><br><span class="line">failover_when_quorum_exists = on</span><br><span class="line">failover_require_consensus = on</span><br><span class="line">allow_multiple_failover_requests_from_node = off</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Lifecheck Setting -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -- common --</span></span><br><span class="line">wd_monitoring_interfaces_list = 'ens33'</span><br><span class="line">wd_lifecheck_method = 'heartbeat'</span><br><span class="line">wd_interval = 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> -- heartbeat mode --</span></span><br><span class="line">wd_heartbeat_port = 9694</span><br><span class="line">wd_heartbeat_keepalive = 2</span><br><span class="line">wd_heartbeat_deadtime = 30</span><br><span class="line">heartbeat_destination0 = 'pg2'</span><br><span class="line">heartbeat_destination_port0 = 9694</span><br><span class="line">heartbeat_device0 = 'ens33'</span><br><span class="line"><span class="meta">#</span><span class="bash"> -- query mode --</span></span><br><span class="line">wd_life_point = 3</span><br><span class="line">wd_lifecheck_query = 'SELECT 1'</span><br><span class="line">wd_lifecheck_dbname = 'template1'</span><br><span class="line">wd_lifecheck_user = 'nobody'</span><br><span class="line">wd_lifecheck_password = ''</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other pgpool Connection Settings -</span></span><br><span class="line">other_pgpool_hostname0 = 'pg2'</span><br><span class="line">other_pgpool_port0 = 9999</span><br><span class="line">other_wd_port0 = 9000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> OTHERS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">relcache_expire = 0</span><br><span class="line">relcache_size = 256</span><br><span class="line">check_temp_table = on</span><br><span class="line">check_unlogged_table = on</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IN MEMORY QUERY MEMORY CACHE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">memory_cache_enabled = off</span><br><span class="line">memqcache_method = 'shmem'</span><br><span class="line">memqcache_memcached_host = 'localhost'</span><br><span class="line">memqcache_memcached_port = 11211</span><br><span class="line">memqcache_total_size = 67108864</span><br><span class="line">memqcache_max_num_cache = 1000000</span><br><span class="line">memqcache_expire = 0</span><br><span class="line">memqcache_auto_cache_invalidation = on</span><br><span class="line">memqcache_maxcache = 409600</span><br><span class="line">memqcache_cache_block_size = 1048576</span><br><span class="line">memqcache_oiddir = '/var/log/pgpool/oiddir'</span><br><span class="line">white_memqcache_table_list = ''</span><br><span class="line">black_memqcache_table_list = ''</span><br></pre></td></tr></table></figure><h4 id="slave节点"><a href="#slave节点" class="headerlink" title="slave节点"></a>slave节点</h4><blockquote><p>可以照抄master节点的配置</p><p>注意以下几个地方要做对应变更</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wd_hostname = 'pg2'</span><br><span class="line">heartbeat_destination0 = 'pg1'</span><br><span class="line">other_pgpool_hostname0 = 'pg1'</span><br></pre></td></tr></table></figure><h3 id="生成pool-passwd文件"><a href="#生成pool-passwd文件" class="headerlink" title="生成pool_passwd文件"></a>生成pool_passwd文件</h3><blockquote><p>在<code>/etc/pgpool-II-10/pool_passwd</code>添加连接到后端PostgreSQL数据库的用户密码</p><p>会提示输入密码，这里的密码请填写PostgreSQL数据库用户对应的密码</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pg_md5 -p -m -u postgres pool_passwd</span><br><span class="line">pg_md5 -p -m -u appuser pool_passwd</span><br></pre></td></tr></table></figure><blockquote><p>修改权限</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+r /etc/pgpool-II-10/pool_passwd</span><br></pre></td></tr></table></figure><h3 id="创建切换脚本"><a href="#创建切换脚本" class="headerlink" title="创建切换脚本"></a>创建切换脚本</h3><p><code>/etc/pgpool-II-10/failover_stream.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -ex</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取参数</span></span><br><span class="line">while getopts 'd:D:h:H:m:M:p:P:r:R:' OPT; do</span><br><span class="line">    case $OPT in</span><br><span class="line">        d)</span><br><span class="line">            NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        D)</span><br><span class="line">            DATABASE_CLUSTER_PATH="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        h)</span><br><span class="line">            HOSTNAME="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        H)</span><br><span class="line">            NEW_MASTER_HOSTNAME="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        m)</span><br><span class="line">            NEW_MASTER_NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        M)</span><br><span class="line">            OLD_MASTER_NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        p)</span><br><span class="line">            PORT_NUM="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        P)</span><br><span class="line">            OLD_PRIMARY_NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        r)</span><br><span class="line">            NEW_MASTER_PORT_NUM="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        R)</span><br><span class="line">            NEW_MASTER_DATABASE_CLUSTER_PATH="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            echo "Usage: `basename $0` -d NODE_ID -D DATABASE_CLUSTER_PATH -h HOSTNAME -H NEW_MASTER_NODE_HOSTNAME -m NEW_MASTER_NODE_ID -M OLD_MASTER_NODE_ID -p PORT_NUM -P OLD_PRIMARY_NODE_ID -r NEW_MASTER_PORT_NUM -R NEW_MASTER_DATABASE_PATH"</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 大型变量打印现场</span></span><br><span class="line">echo "HOSTNAME: $&#123;HOSTNAME&#125;"</span><br><span class="line">echo "NODE_ID: $&#123;NODE_ID&#125;"</span><br><span class="line">echo "PORT_NUM: $&#123;PORT_NUM&#125;"</span><br><span class="line">echo "DATABASE_CLUSTER_PATH: $&#123;DATABASE_CLUSTER_PATH&#125;"</span><br><span class="line">echo "OLD_MASTER_NODE_ID: $&#123;OLD_MASTER_NODE_ID&#125;"</span><br><span class="line">echo "OLD_PRIMARY_NODE_ID: $&#123;OLD_PRIMARY_NODE_ID&#125;"</span><br><span class="line">echo "NEW_MASTER_HOSTNAME: $&#123;NEW_MASTER_HOSTNAME&#125;"</span><br><span class="line">echo "NEW_MASTER_NODE_ID: $&#123;NEW_MASTER_NODE_ID&#125;"</span><br><span class="line">echo "NEW_MASTER_PORT_NUM: $&#123;NEW_MASTER_PORT_NUM&#125;"</span><br><span class="line">echo "NEW_MASTER_DATABASE_CLUSTER_PATH: $&#123;NEW_MASTER_DATABASE_CLUSTER_PATH&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义PostgreSQL家目录，默认是/usr/pgsql-10</span></span><br><span class="line">PGHOME='/usr/pgsql-10'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义PGDATA，默认是/var/lib/pgsql/10/data，这里使用pgpool.conf定义的backend_data_directory</span></span><br><span class="line">PGDATA=$&#123;NEW_MASTER_DATABASE_CLUSTER_PATH&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拼凑字符串命令</span></span><br><span class="line">TRIGGER_COMMAND="$PGHOME/bin/pg_ctl promote -D $PGDATA"</span><br><span class="line"><span class="meta">#</span><span class="bash"> pg_ctl promote的功能是让备份服务器退出恢复进程并且转为读写模式</span></span><br><span class="line">/usr/bin/ssh -T $&#123;NEW_MASTER_HOSTNAME&#125; $&#123;TRIGGER_COMMAND&#125;</span><br><span class="line">exit 0;</span><br></pre></td></tr></table></figure><blockquote><p>增加执行权限</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+rx /etc/pgpool-II-10/failover_stream.sh</span><br></pre></td></tr></table></figure><h2 id="启动PGPool"><a href="#启动PGPool" class="headerlink" title="启动PGPool"></a>启动PGPool</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable pgpool-II-10.service</span><br><span class="line">systemctl start pgpool-II-10.service</span><br></pre></td></tr></table></figure><h1 id="验证PGPool"><a href="#验证PGPool" class="headerlink" title="验证PGPool"></a>验证PGPool</h1><ul><li>使用psql连接PGPool</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h vip -p 9999</span><br></pre></td></tr></table></figure><ul><li>查看PGPool节点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># show pool_nodes;</span></span><br><span class="line"> node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line"><span class="comment">---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+---------------------</span></span><br><span class="line"> 0       | pg1      | 5432 | up     | 0.500000  | primary | 2          | true              | 0                 | 2019-05-26 20:40:44</span><br><span class="line"> 1       | pg2      | 5432 | up     | 0.500000  | standby | 0          | false             | 0                 | 2019-05-26 20:40:44</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><h2 id="PGPool节点重启"><a href="#PGPool节点重启" class="headerlink" title="PGPool节点重启"></a>PGPool节点重启</h2><ul><li>查看watchdog的VIP所在主机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip address</span><br></pre></td></tr></table></figure><ul><li>重启前查看PGPool节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line">-[ RECORD 1 ]------+--------------------</span><br><span class="line">node_id            | 0</span><br><span class="line">hostname           | pg1</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | primary</span><br><span class="line">select_cnt         | 7</span><br><span class="line">load_balance_node  | true</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:40:44</span><br><span class="line">-[ RECORD 2 ]------+--------------------</span><br><span class="line">node_id            | 1</span><br><span class="line">hostname           | pg2</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | standby</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | false</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:40:44</span><br></pre></td></tr></table></figure><ul><li>登录VIP所在主机直接重启</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><ul><li>再次查看节点信息</li></ul><blockquote><p>可以看到VIP所在主机重启之后</p><p>SQL连接会提示连接不可用</p><p>在watchdog的作用下，VIP会自动切换到另一个PGPool节点</p><p>SQL连接再次重新连接成功！</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line">server closed the connection unexpectedly</span><br><span class="line">This probably means the server terminated abnormally</span><br><span class="line">before or while processing the request.</span><br><span class="line">The connection to the server was lost. Attempting reset: Succeeded.</span><br><span class="line">postgres=# show pool_nodes;</span><br><span class="line">-[ RECORD 1 ]------+--------------------</span><br><span class="line">node_id            | 0</span><br><span class="line">hostname           | pg1</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | primary</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | true</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:48</span><br><span class="line">-[ RECORD 2 ]------+--------------------</span><br><span class="line">node_id            | 1</span><br><span class="line">hostname           | pg2</span><br><span class="line">port               | 5432</span><br><span class="line">status             | down</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | standby</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | false</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:42</span><br></pre></td></tr></table></figure><h2 id="PGPool进程被杀"><a href="#PGPool进程被杀" class="headerlink" title="PGPool进程被杀"></a>PGPool进程被杀</h2><ul><li>查看watchdog的VIP所在主机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip address</span><br></pre></td></tr></table></figure><ul><li>查看PGPool节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">postgres=# \x</span><br><span class="line">Expanded display is on.</span><br><span class="line">postgres=# show pool_nodes;</span><br><span class="line">-[ RECORD 1 ]------+--------------------</span><br><span class="line">node_id            | 0</span><br><span class="line">hostname           | pg1</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | primary</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | true</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:48</span><br><span class="line">-[ RECORD 2 ]------+--------------------</span><br><span class="line">node_id            | 1</span><br><span class="line">hostname           | pg2</span><br><span class="line">port               | 5432</span><br><span class="line">status             | down</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | standby</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | false</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:42</span><br></pre></td></tr></table></figure><ul><li>找PGPool的进程</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep pgpool</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">postgres  12641      1  0 20:39 ?        00:00:00 /usr/pgpool-10/bin/pgpool -f /etc/pgpool-II-10/pgpool.conf -n -D</span><br></pre></td></tr></table></figure><ul><li>杀PGPool进程</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 12641</span><br></pre></td></tr></table></figure><ul><li>PGPool进程日志</li></ul><blockquote><p>可以看到PGPool的watchdog几乎立刻就反应过来了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">May 26 20:53:14 pg2 pgpool[9607]: LOG:  watchdog node state changed from [STANDBY] to [JOINING]</span><br><span class="line">May 26 20:53:14 pg2 pgpool[9607]: LOCATION:  watchdog.c:6360</span><br><span class="line">May 26 20:53:18 pg2 pgpool[9607]: LOG:  watchdog node state changed from [JOINING] to [INITIALIZING]</span><br><span class="line">May 26 20:53:18 pg2 pgpool[9607]: LOCATION:  watchdog.c:6360</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOG:  I am the only alive node in the watchdog cluster</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: HINT:  skipping stand for coordinator state</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOCATION:  watchdog.c:5231</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOG:  watchdog node state changed from [INITIALIZING] to [MASTER]</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOCATION:  watchdog.c:6360</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOG:  I am announcing my self as master/coordinator watchdog node</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOCATION:  watchdog.c:5420</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  I am the cluster leader node</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: DETAIL:  our declare coordinator message is accepted by all nodes</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:5454</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  setting the local node "pg2:9999 Linux pg2" as watchdog cluster master</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:7087</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  I am the cluster leader node. Starting escalation process</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:5473</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  escalation process started with PID:10118</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:6000</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  new IPC connection received</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:3147</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  watchdog: escalation started</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  wd_escalation.c:93</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOG:  successfully acquired the delegate IP:"172.16.80.200"</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: DETAIL:  'if_up_cmd' returned with success</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOCATION:  wd_if.c:169</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOG:  watchdog escalation process with pid: 10118 exit with SUCCESS.</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOCATION:  watchdog.c:2976</span><br></pre></td></tr></table></figure><h2 id="模拟master节点宕机"><a href="#模拟master节点宕机" class="headerlink" title="模拟master节点宕机"></a>模拟master节点宕机</h2><ul><li>查看节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line"> node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line">---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+---------------------</span><br><span class="line"> 0       | pg1      | 5432 | up     | 0.500000  | primary | 0          | true              | 0                 | 2019-05-26 20:58:11</span><br><span class="line"> 1       | pg2      | 5432 | up     | 0.500000  | standby | 0          | false             | 0                 | 2019-05-26 20:59:22</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><ul><li>master节点直接关机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now</span><br></pre></td></tr></table></figure><ul><li>查看PGPool日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  new IPC connection received</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:3147</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  watchdog received the failover command from local pgpool-II on IPC interface</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2570</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  watchdog is processing the failover command [DEGENERATE_BACKEND_REQUEST] received from local pgpool-II on IPC interface</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2491</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  we have got the consensus to perform the failover</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: DETAIL:  1 node(s) voted in the favor</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2363</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  Pgpool-II parent process has received failover request</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:1594</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  new IPC connection received</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:3147</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  received the failover indication from Pgpool-II on IPC interface</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2716</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  watchdog is informed of failover start by the main process</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2784</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  starting degeneration. shutdown host pg1(5432)</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:1873</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  Restart all children</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:2023</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  execute command: /etc/pgpool-II-10/failover_stream.sh 0 pg1 5432 /var/lib/pgsql/10/data 0 1 pg2 0 5432 /var/lib/pgsql/10/data &gt; /var/lib/pgsql/10/data/log/failover.log</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:3070</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + getopts d:D:h:H:m:M:p:P:r:R: OPT</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'HOSTNAME: pg2'</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'PORT_NUM: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'DATABASE_CLUSTER_PATH: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'OLD_MASTER_NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'OLD_PRIMARY_NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_HOSTNAME: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_PORT_NUM: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_DATABASE_CLUSTER_PATH: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + PGHOME=/usr/pgsql-10</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + PGDATA=</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + TRIGGER_COMMAND='/usr/pgsql-10/bin/pg_ctl promote -D '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + /usr/bin/ssh -T /usr/pgsql-10/bin/pg_ctl promote -D</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10871 USER=postgres DB=postgres: WARNING:  failover/failback is in progress</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10871 USER=postgres DB=postgres: DETAIL:  executing failover or failback on backend</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10871 USER=postgres DB=postgres: HINT:  In a moment you should be able to reconnect to the database</span><br></pre></td></tr></table></figure><ul><li>查看PGPool节点</li></ul><blockquote><p>可以看到PGPool帮我们自动将standby节点切换为primary</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line"> node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line">---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+---------------------</span><br><span class="line"> 0       | pg1      | 5432 | down   | 0.500000  | standby | 0          | false             | 0                 | 2019-05-26 21:09:59</span><br><span class="line"> 1       | pg2      | 5432 | up     | 0.500000  | primary | 0          | true              | 0                 | 2019-05-26 21:12:56</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><ul><li><p>启动master节点</p></li><li><p>在master登录到自己的PostgreSQL</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><ul><li>查看<code>pg_is_in_recovery()</code></li></ul><blockquote><p>发现master节点上面的PostgreSQL状态为<code>f</code>，没有自动转换为pg2的从库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> f</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><ul><li>手动处理一下</li></ul><blockquote><p>切换用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cd $PGDATA</span><br></pre></td></tr></table></figure><blockquote><p>创建<code>recovery.conf</code>文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定timeline为latest，保证主从数据差异尽可能小</span></span><br><span class="line">recovery_target_timeline = 'latest'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此选项会让PostgreSQL一直处于数据恢复状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不断去请求primary_conninfo定义的主节点的WAL日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 并将这些WAL日志恢复到本地数据库中</span></span><br><span class="line">standby_mode = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义主库的连接方式</span></span><br><span class="line">primary_conninfo = 'host=pg2 port=5432 user=repluser password=repluser_password'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个文件是用于触发停止流复制的操作！不需要手动创建</span></span><br><span class="line">trigger_file = '/var/lib/pgsql/10/data/pg.trigger'</span><br></pre></td></tr></table></figure><blockquote><p>重启PostgreSQL</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_ctl restart</span><br></pre></td></tr></table></figure><blockquote><p>登录数据库查看状态，可以看到状态变成了<code>t</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><blockquote><p>手动加入PGPool集群</p><p>这里输入之前<code>pcp.conf</code>定义的用户密码</p></blockquote><ul><li>参数解析如下<ul><li><code>-h</code>这里指定pcp的IP地址，这里用VIP</li><li><code>-p</code>这里指定pcp的端口，默认是9898</li><li><code>-U</code>这里指定登录pcp的用户，在<code>/etc/pgpool-II-10/pcp.conf</code>里面定义的</li><li><code>-n</code>这里指定节点ID，可以在<code>show pool_nodes</code>里面查到节点对应的ID号</li><li><code>-d</code>输出debug日志</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pcp_attach_node -U postgres -h vip -p 9898 -n 0 -d</span><br><span class="line">Password: </span><br><span class="line">DEBUG: recv: tos="m", len=8</span><br><span class="line">DEBUG: recv: tos="r", len=21</span><br><span class="line">DEBUG: send: tos="C", len=6</span><br><span class="line">DEBUG: recv: tos="c", len=20</span><br><span class="line">pcp_attach_node -- Command Successful</span><br><span class="line">DEBUG: send: tos="X", len=4</span><br></pre></td></tr></table></figure><blockquote><p>查看PGPool节点状态，可以看到pg1状态是waiting，过一阵之后就变成up了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line"> node_id | hostname | port | status  | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line">---------+----------+------+---------+-----------+---------+------------+-------------------+-------------------+---------------------</span><br><span class="line"> 0       | pg1      | 5432 | up      | 0.500000  | standby | 0          | false             | 4200              | 2019-05-26 21:19:05</span><br><span class="line"> 1       | pg2      | 5432 | up      | 0.500000  | primary | 0          | true              | 0                 | 2019-05-26 21:12:56</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><h1 id="维护操作"><a href="#维护操作" class="headerlink" title="维护操作"></a>维护操作</h1><h2 id="PGPool节点down"><a href="#PGPool节点down" class="headerlink" title="PGPool节点down"></a>PGPool节点down</h2><ul><li>检查PostgreSQL是否正常启动</li><li>查看<code>$PGDATA</code>目录是否有<code>recovery.conf</code>或者<code>recovery.done</code>，一般情况下，只存在一个文件<ul><li>其中<code>recovery.done</code>会让数据库启动时以主库形式启动</li><li><code>recovery.conf</code>会让数据库作为从库启动</li><li>在发生主从切换的时候，<code>recovery.conf</code>会被重命名为<code>recovery.done</code></li></ul></li><li>如确认当前down节点是要作为从库启动，则重命名<code>recovery.done</code>为<code>recovery.conf</code>，然后重启数据库<ul><li>需要确认一下是否能从新的主库同步数据</li></ul></li></ul><h2 id="PGPool节点waiting"><a href="#PGPool节点waiting" class="headerlink" title="PGPool节点waiting"></a>PGPool节点waiting</h2><ul><li>节点还在做主从同步</li><li>PGPool还在创建子进程用于连接此节点，子进程数量多，耗时会相应变长</li><li>如果登录很久都是waiting，可以尝试重启一下PGPool的服务</li></ul><h2 id="PGPool重新添加节点"><a href="#PGPool重新添加节点" class="headerlink" title="PGPool重新添加节点"></a>PGPool重新添加节点</h2><blockquote><p>确保主从数据库都已正常，但是节点状态还是down，就需要手工添加到集群中了</p></blockquote><ul><li>使用<code>pcp_attach_node</code>命令，输入<code>pcp.conf</code>定义的密码之后即可将节点重新加入PGPool</li><li>参数解析如下<ul><li><code>-h</code>这里指定pcp的IP地址，这里用VIP</li><li><code>-p</code>这里指定pcp的端口，默认是9898</li><li><code>-U</code>这里指定登录pcp的用户，在<code>/etc/pgpool-II-10/pcp.conf</code>里面定义的</li><li><code>-n</code>这里指定节点ID，可以在<code>show pool_nodes</code>里面查到节点对应的ID号</li><li><code>-d</code>输出debug日志</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pcp_attach_node -h vip -p 9898 -U postgres -n NODE_ID -d</span><br><span class="line">Password:</span><br><span class="line">DEBUG: recv: tos="m", len=8</span><br><span class="line">DEBUG: recv: tos="r", len=21</span><br><span class="line">DEBUG: send: tos="C", len=6</span><br><span class="line">DEBUG: recv: tos="c", len=20</span><br><span class="line">pcp_attach_node -- Command Successful</span><br><span class="line">DEBUG: send: tos="X", len=4</span><br></pre></td></tr></table></figure><blockquote></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里只记录搭建和简单测试过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10基于stream复制搭建主从集群</title>
    <link href="https://luanlengli.github.io/2019/05/21/PostgreSQL10%E5%9F%BA%E4%BA%8Estream%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2019/05/21/PostgreSQL10基于stream复制搭建主从集群.html</id>
    <published>2019-05-21T03:00:47.000Z</published>
    <updated>2019-05-26T12:17:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>这里只记录搭建和简单测试过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能完整跑起来</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>PostgreSQL版本号<code>10.8</code></p><p>虚拟机配置<code>1CPU 2G内存 20G系统盘</code></p><p><code>postgres</code>用户默认情况下PGDATA变量是<code>/var/lib/pgsql/10/data</code></p><font color="red">这里没有使用数据盘，有需要的可以自行调整！</font></blockquote><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="主机清单"><a href="#主机清单" class="headerlink" title="主机清单"></a>主机清单</h2><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th><th>监听端口</th></tr></thead><tbody><tr><td>pg1</td><td>172.16.80.201</td><td>master</td><td>5432</td></tr><tr><td>pg2</td><td>172.16.80.202</td><td>slave</td><td>5432</td></tr></tbody></table><h2 id="配置-etc-hosts"><a href="#配置-etc-hosts" class="headerlink" title="配置/etc/hosts"></a>配置/etc/hosts</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.201 pg1</span><br><span class="line">172.16.80.202 pg2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h2><p>参照此链接在两个节点上面安装好PostgreSQL，但是先不初始化数据库！！！！</p><p><a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96.html">PostgreSQL10安装部署和初始化</a></p><h1 id="基于stream主从复制配置"><a href="#基于stream主从复制配置" class="headerlink" title="基于stream主从复制配置"></a>基于stream主从复制配置</h1><h2 id="master节点"><a href="#master节点" class="headerlink" title="master节点"></a>master节点</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><blockquote><font color="red">如果是有业务在跑，已经有数据了就不要做这一步操作！直接从</font><strong>创建复制用户</strong><font color="red">那一步开始</font></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/pgsql-10/bin/postgresql-10-setup initdb</span><br></pre></td></tr></table></figure><h3 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now postgres-10.service</span><br></pre></td></tr></table></figure><h3 id="登录数据库"><a href="#登录数据库" class="headerlink" title="登录数据库"></a>登录数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><h3 id="创建复制用户"><a href="#创建复制用户" class="headerlink" title="创建复制用户"></a>创建复制用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER repluser REPLICATION LOGIN CONNECTION LIMIT 2 ENCRYPTED PASSWORD 'repluser_password';</span><br></pre></td></tr></table></figure><h3 id="创建-pgpass文件"><a href="#创建-pgpass文件" class="headerlink" title="创建.pgpass文件"></a>创建.pgpass文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cat &gt; ~/.pgpass &lt;&lt;EOF</span><br><span class="line">pg2:5432:replication:repluser:repluser_password</span><br><span class="line">EOF</span><br><span class="line">chmod 0600 ~/.pgpass</span><br></pre></td></tr></table></figure><h3 id="编辑pg-hba-conf"><a href="#编辑pg-hba-conf" class="headerlink" title="编辑pg_hba.conf"></a>编辑pg_hba.conf</h3><blockquote><p>增加配置如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host    replication     repluser        172.16.80.0/24          md5</span><br></pre></td></tr></table></figure><h3 id="编辑postgres-conf"><a href="#编辑postgres-conf" class="headerlink" title="编辑postgres.conf"></a>编辑postgres.conf</h3><blockquote><p>增加配置参数如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wal_level = replica</span><br><span class="line"><span class="meta">#</span><span class="bash"> 有多少个slave节点，max_wal_senders就设置为多少</span></span><br><span class="line">max_wal_senders = 1</span><br><span class="line">wal_keep_segments = 32</span><br></pre></td></tr></table></figure><h3 id="重启数据库"><a href="#重启数据库" class="headerlink" title="重启数据库"></a>重启数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">/usr/pgsql-10/bin/pg_ctl restart -D $PGDATA</span><br></pre></td></tr></table></figure><h2 id="slave节点"><a href="#slave节点" class="headerlink" title="slave节点"></a>slave节点</h2><h3 id="创建-pgpass文件-1"><a href="#创建-pgpass文件-1" class="headerlink" title="创建.pgpass文件"></a>创建.pgpass文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cat &gt; ~/.pgpass &lt;&lt;EOF</span><br><span class="line">pg1:5432:replication:repluser:repluser_password</span><br><span class="line">EOF</span><br><span class="line">chmod 0600 ~/.pgpass</span><br></pre></td></tr></table></figure><h3 id="pg-basebackup生成备库文件"><a href="#pg-basebackup生成备库文件" class="headerlink" title="pg_basebackup生成备库文件"></a>pg_basebackup生成备库文件</h3><blockquote><p>把master节点的数据以物理备份的方式，保存到slave节点。</p><p>备份过程不影响其他客户端访问。</p><p>备份出来的内容是整个数据库的所有数据，包括配置文件！</p></blockquote><ul><li><code>-D</code>指定PostgreSQL数据目录</li><li><code>-Fp</code>指定输出格式为plain，这里是缩写，相当于<code>--format=plain</code></li><li><code>-Xs</code>指定传输WAL日志的方法为<code>stream</code>，这里是缩写，相当于<code>--wal-method=stream</code></li><li><code>-h</code>指定PostgreSQL master节点</li><li><code>-p</code>指定端口</li><li><code>-U</code>指定用户</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">pg_basebackup -D $PGDATA -Fp -Xs -v -P -h pg1 -p 5432 -U repluser</span><br></pre></td></tr></table></figure><h3 id="配置recovery-conf"><a href="#配置recovery-conf" class="headerlink" title="配置recovery.conf"></a>配置recovery.conf</h3><blockquote><p>从master节点拷贝过来的数据文件是没有<code>recovery.conf</code>的</p><p>需要手动创建</p><p>好在PostgreSQL安装的时候是有这个配置文件的模板</p><p>里面都是注释</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cp /usr/pgsql-10/share/recovery.conf.sample $PGDATA/recovery.conf</span><br></pre></td></tr></table></figure><p>修改之后，内容如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定timeline为latest，保证主从数据差异尽可能小</span></span><br><span class="line">recovery_target_timeline = 'latest'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此选项会让PostgreSQL一直处于数据恢复状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不断去请求primary_conninfo定义的主节点的WAL日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 并将这些WAL日志恢复到本地数据库中</span></span><br><span class="line">standby_mode = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义主库的连接方式</span></span><br><span class="line">primary_conninfo = 'host=pg1 port=5432 user=repluser password=repluser_password'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个文件是用于触发停止流复制的操作！不需要手动创建</span></span><br><span class="line">trigger_file = '/var/lib/pgsql/10/data/pg.trigger'</span><br></pre></td></tr></table></figure><h3 id="启动备库"><a href="#启动备库" class="headerlink" title="启动备库"></a>启动备库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now postgresql-10.service</span><br></pre></td></tr></table></figure><h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><h2 id="master节点-1"><a href="#master节点-1" class="headerlink" title="master节点"></a>master节点</h2><h3 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep postgres</span><br></pre></td></tr></table></figure><blockquote><p>查看是否有<code>postgres: wal sender process</code></p></blockquote><h3 id="查看recovery状态"><a href="#查看recovery状态" class="headerlink" title="查看recovery状态"></a>查看recovery状态</h3><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h pg1</span><br></pre></td></tr></table></figure><blockquote><p>输入sql语句，主库返回<code>f</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> f</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h3 id="查看主备同步状态"><a href="#查看主备同步状态" class="headerlink" title="查看主备同步状态"></a>查看主备同步状态</h3><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h pg1</span><br></pre></td></tr></table></figure><blockquote><p>修改一下输出格式，将每列数据以键值对的方式显示，类似于MySQL的<code>\G</code></p><p>这里是输入一次，当前会话有效，想取消就再输入一次</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x</span><br></pre></td></tr></table></figure><blockquote><p>查看同步状态</p><p>这里可以看到sync_state是async，即异步流复制</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select * from pg_stat_replication;</span></span><br><span class="line">-[ RECORD 1 ]<span class="comment">----+-----------------------------</span></span><br><span class="line">pid              | 10178</span><br><span class="line">usesysid         | 16384</span><br><span class="line">usename          | repl</span><br><span class="line">application_name | walreceiver</span><br><span class="line">client_addr      | 172.16.80.202</span><br><span class="line">client_hostname  | </span><br><span class="line">client_port      | 41220</span><br><span class="line">backend_start    | YYYY-MM-DD HH:mm:ss.78404+08</span><br><span class="line">backend_xmin     | </span><br><span class="line">state            | streaming</span><br><span class="line">sent_lsn         | 0/7000060</span><br><span class="line">write_lsn        | 0/7000060</span><br><span class="line">flush_lsn        | 0/7000060</span><br><span class="line">replay_lsn       | 0/7000060</span><br><span class="line">write_lag        | </span><br><span class="line">flush_lag        | </span><br><span class="line">replay_lag       | </span><br><span class="line">sync_priority    | 0</span><br><span class="line">sync_state       | async</span><br></pre></td></tr></table></figure><h2 id="slave节点-1"><a href="#slave节点-1" class="headerlink" title="slave节点"></a>slave节点</h2><h3 id="查看进程-1"><a href="#查看进程-1" class="headerlink" title="查看进程"></a>查看进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep postgres</span><br></pre></td></tr></table></figure><blockquote><p>查看是否有<code>postgres: wal receiver process</code></p></blockquote><h3 id="查看recovery状态-1"><a href="#查看recovery状态-1" class="headerlink" title="查看recovery状态"></a>查看recovery状态</h3><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h pg2</span><br></pre></td></tr></table></figure><blockquote><p>输入sql语句，从库返回<code>t</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里只记录搭建和简单测试过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10安装部署和初始化</title>
    <link href="https://luanlengli.github.io/2019/05/20/PostgreSQL10%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96.html"/>
    <id>https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html</id>
    <published>2019-05-20T03:03:26.000Z</published>
    <updated>2019-05-28T06:25:08.963Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录安装部署和初始化过程</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>PostgreSQL版本号为<code>10.8</code></li><li>虚拟机配置<code>1CPU 2G内存 20G系统盘 30G数据盘</code></li><li><font color="red">【根据自己的环境灵活调整，生产环境请务必提供独立数据盘！】</font></li></ul><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld.service</span><br></pre></td></tr></table></figure><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -e 's,^SELINUX=.*,SELINUX=disabled,' -i /etc/selinux/config</span><br></pre></td></tr></table></figure><h2 id="sysctl参数"><a href="#sysctl参数" class="headerlink" title="sysctl参数"></a>sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-pgsql.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示最大限度使用物理内存，物理内存用满再用swap</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度，默认值128</span></span><br><span class="line">net.core.somaxconn=4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=‭1048576‬</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个共享内存段的最大值，这里设置为物理内存大小的一半</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算方式 2048 / 2 * 1024 * 1024 = 1073741824</span></span><br><span class="line">kernel.shmmax=1073741824</span><br><span class="line"><span class="meta">#</span><span class="bash"> kernel.sem对应四个值分别为SEMMSL、SEMMNS、SEMOPM、SEMMNI</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMMSL 每个信号集的最大信号数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMMNS 用于控制整个 Linux 系统中信号（而不是信号集）的最大数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMOPM 内核参数用于控制每个 semop 系统调用可以执行的信号操作的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMMNI 内核参数用于控制整个 Linux 系统中信号集的最大数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里套用Oracle 11gR2的最小要求值</span></span><br><span class="line">kernel.sem = 250 32000 100 128</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据接收窗口（字节）</span></span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据发送窗口（字节）</span></span><br><span class="line">net.core.wmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据接收窗口大小（字节）</span></span><br><span class="line">net.core.rmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据发送窗口大小（字节）</span></span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置主动发起连接时，端口范围，默认值32768-60000</span></span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统pagecache脏页达到系统内存dirty_ratio的百分比值时，会阻塞新的写请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 直到内存脏页落盘</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为30</span></span><br><span class="line">vm.dirty_ratio = 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="limits参数"><a href="#limits参数" class="headerlink" title="limits参数"></a>limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-pgsql.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 655360</span><br><span class="line">* soft nproc 655360</span><br><span class="line">* hard nproc 655360</span><br><span class="line">* soft stack unlimited</span><br><span class="line">* hard stack unlimited</span><br><span class="line">* soft   memlock    250000000</span><br><span class="line">* hard   memlock    250000000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="准备数据盘"><a href="#准备数据盘" class="headerlink" title="准备数据盘"></a>准备数据盘</h2><h3 id="确认数据盘"><a href="#确认数据盘" class="headerlink" title="确认数据盘"></a>确认数据盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lsblk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  20G  0 disk</span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  19G  0 part /</span><br><span class="line">sdb      8:16   0  30G  0 disk</span><br></pre></td></tr></table></figure><h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>使用<code>fdisk /dev/sdb</code>格式化硬盘，默认已做4K对齐</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/sdb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain in memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write command.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0xa5fd5a2b.</span><br><span class="line"></span><br><span class="line">Command (m for help): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 32.2 GB, 32212254720 bytes, 62914560 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0xa5fd5a2b</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line"></span><br><span class="line">Command (m for help): n</span><br><span class="line">Partition type:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (1-4, default 1): 1</span><br><span class="line">First sector (2048-62914559, default 2048):</span><br><span class="line">Using default value 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-62914559, default 62914559):</span><br><span class="line">Using default value 62914559</span><br><span class="line">Partition 1 of type Linux and of size 30 GiB is set</span><br><span class="line"></span><br><span class="line">Command (m for help): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 32.2 GB, 32212254720 bytes, 62914560 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0xa5fd5a2b</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sdb1            2048    62914559    31456256   83  Linux</span><br><span class="line"></span><br><span class="line">Command (m for help): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lsblk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  20G  0 disk</span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  19G  0 part /</span><br><span class="line">sdb      8:16   0  30G  0 disk</span><br><span class="line">└─sdb1   8:17   0  30G  0 part</span><br></pre></td></tr></table></figure><h3 id="格式化分区"><a href="#格式化分区" class="headerlink" title="格式化分区"></a>格式化分区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs -f -b size=4096 /dev/sdb1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">meta-data=/dev/sdb1              isize=512    agcount=4, agsize=1966016 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0, sparse=0</span><br><span class="line">data     =                       bsize=4096   blocks=7864064, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line">log      =internal log           bsize=4096   blocks=3839, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure><h3 id="创建数据目录"><a href="#创建数据目录" class="headerlink" title="创建数据目录"></a>创建数据目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data</span><br></pre></td></tr></table></figure><h3 id="挂载数据盘"><a href="#挂载数据盘" class="headerlink" title="挂载数据盘"></a>挂载数据盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t xfs -o nolargeio,noatime,nodiratime /dev/sdb1 /data</span><br></pre></td></tr></table></figure><h3 id="修改-etc-fstab"><a href="#修改-etc-fstab" class="headerlink" title="修改/etc/fstab"></a>修改/etc/fstab</h3><p>追加一行记录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1 /data xfs nolargeio,noatime,nodiratime 0 0</span><br></pre></td></tr></table></figure><h1 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h1><h2 id="准备YUM源"><a href="#准备YUM源" class="headerlink" title="准备YUM源"></a>准备YUM源</h2><p><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">社区配置YUM源的文档</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br></pre></td></tr></table></figure><blockquote><p>由于默认的源服务器地址在国外，修改为国内镜像地址可以改善下载速度</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br></pre></td></tr></table></figure><blockquote><p>默认源服务器地址是PostgreSQL社区的服务器，这里替换成清华大学的镜像源地址</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,download.postgresql.org/pub,mirrors4.tuna.tsinghua.edu.cn/postgresql,g' -i /etc/yum.repos.d/pgdg-redhat-all.repo</span><br></pre></td></tr></table></figure><h2 id="安装PostgreSQL10"><a href="#安装PostgreSQL10" class="headerlink" title="安装PostgreSQL10"></a>安装PostgreSQL10</h2><blockquote><font color="red">必装</font></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgresql10 postgresql10-server</span><br></pre></td></tr></table></figure><blockquote><p>选装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgresql10-contrib postgresql10-test</span><br></pre></td></tr></table></figure><blockquote><p>PostgreSQL也有基于WebUI的图形管理工具<code>pgAdmin</code>，具体怎么用，自己看<a href="https://www.pgadmin.org/docs/pgadmin4/4.x/" target="_blank" rel="noopener">文档</a></p><p>windows版的看<a href="https://www.pgadmin.org/download/pgadmin-4-windows/" target="_blank" rel="noopener">这里</a></p><p>容器化部署看<a href="https://www.pgadmin.org/docs/pgadmin4/4.x/container_deployment.html" target="_blank" rel="noopener">这里</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pgadmin4</span><br></pre></td></tr></table></figure><h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><ul><li>使用默认数据目录</li></ul><blockquote><p>默认数据目录在<code>/var/lib/pgsql/10/data</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/pgsql-10/bin/postgresql-10-setup initdb</span><br></pre></td></tr></table></figure><ul><li>使用自定义数据目录</li></ul><blockquote><p>这里自定义数据目录为<code>/data</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改数据目录权限</span></span><br><span class="line">chown -R postgres:postgres /data</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改服务启动脚本的数据目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务脚本默认的Environment=PGDATA=/var/lib/pgsql/10/data</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不改这个会导致服务启动失败</span></span><br><span class="line">sed -e 's,^Environment=PGDATA=.*,Environment=PGDATA=/data,' -i /usr/lib/systemd/system/postgresql-10.service</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到postgres用户</span></span><br><span class="line">su - postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改默认PGDATA环境变量</span></span><br><span class="line">sed -e 's,^PGDATA.*,PGDATA=/data,' -i ~/.bash_profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用变量</span></span><br><span class="line">source ~/.bash_profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化数据库</span></span><br><span class="line">/usr/pgsql-10/bin/initdb --encoding=UTF-8  \</span><br><span class="line">                         --local=en_US.UTF8 \</span><br><span class="line">                         --username=postgres \</span><br><span class="line">                         --pwprompt \</span><br><span class="line">                         --pgdata=$PGDATA \</span><br><span class="line">                         --data-checksums</span><br></pre></td></tr></table></figure><h2 id="启动PostgreSQL"><a href="#启动PostgreSQL" class="headerlink" title="启动PostgreSQL"></a>启动PostgreSQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable postgresql-10.service</span><br><span class="line">systemctl start postgresql-10.service</span><br></pre></td></tr></table></figure><h2 id="验证数据库"><a href="#验证数据库" class="headerlink" title="验证数据库"></a>验证数据库</h2><h3 id="查看数据库进程"><a href="#查看数据库进程" class="headerlink" title="查看数据库进程"></a>查看数据库进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">postgres  13558      1  0 13:25 ?        00:00:00 /usr/pgsql-10/bin/postmaster -D /data</span><br><span class="line">postgres  13560  13558  0 13:25 ?        00:00:00 postgres: logger process</span><br><span class="line">postgres  13562  13558  0 13:25 ?        00:00:00 postgres: checkpointer process</span><br><span class="line">postgres  13563  13558  0 13:25 ?        00:00:00 postgres: writer process</span><br><span class="line">postgres  13564  13558  0 13:25 ?        00:00:00 postgres: wal writer process</span><br><span class="line">postgres  13565  13558  0 13:25 ?        00:00:00 postgres: autovacuum launcher process</span><br><span class="line">postgres  13566  13558  0 13:25 ?        00:00:00 postgres: stats collector process</span><br><span class="line">postgres  13567  13558  0 13:25 ?        00:00:00 postgres: bgworker: logical replication launcher</span><br></pre></td></tr></table></figure><h3 id="查看数据库监听端口"><a href="#查看数据库监听端口" class="headerlink" title="查看数据库监听端口"></a>查看数据库监听端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netstat -antupl | grep 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      13558/postmaster</span><br><span class="line">tcp6       0      0 ::1:5432                :::*                    LISTEN      13558/postmaster</span><br></pre></td></tr></table></figure><h3 id="切换用户"><a href="#切换用户" class="headerlink" title="切换用户"></a>切换用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><h3 id="登录数据库"><a href="#登录数据库" class="headerlink" title="登录数据库"></a>登录数据库</h3><blockquote><p>在postgres用户下可以直接免密码登录到数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># \conninfo</span></span><br><span class="line">You are connected to database "postgres" as user "postgres" via socket in "/var/run/postgresql" at port "5432".</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># \l</span></span><br><span class="line">                                 List of databases</span><br><span class="line">   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges</span><br><span class="line"><span class="comment">-----------+----------+----------+------------+------------+-----------------------</span></span><br><span class="line"> postgres  | postgres | UTF8     | zh_CN.UTF8 | zh_CN.UTF8 |</span><br><span class="line"> template0 | postgres | UTF8     | zh_CN.UTF8 | zh_CN.UTF8 | =c/postgres          +</span><br><span class="line">           |          |          |            |            | postgres=CTc/postgres</span><br><span class="line"> template1 | postgres | UTF8     | zh_CN.UTF8 | zh_CN.UTF8 | =c/postgres          +</span><br><span class="line">           |          |          |            |            | postgres=CTc/postgres</span><br><span class="line">(3 rows)</span><br></pre></td></tr></table></figure><h1 id="配置PostgreSQL数据库"><a href="#配置PostgreSQL数据库" class="headerlink" title="配置PostgreSQL数据库"></a>配置PostgreSQL数据库</h1><h2 id="配置文件路径"><a href="#配置文件路径" class="headerlink" title="配置文件路径"></a>配置文件路径</h2><p>配置文件是放在数据目录，懒得记路径可以这么做</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">cd $PGDATA</span><br><span class="line">ls</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">base              pg_dynshmem    pg_notify     pg_stat_tmp  pg_wal                postmaster.pid</span><br><span class="line">current_logfiles  pg_hba.conf    pg_replslot   pg_subtrans  pg_xact</span><br><span class="line">global            pg_ident.conf  pg_serial     pg_tblspc    postgresql.auto.conf</span><br><span class="line">log               pg_logical     pg_snapshots  pg_twophase  postgresql.conf</span><br><span class="line">pg_commit_ts      pg_multixact   pg_stat       PG_VERSION   postmaster.opts</span><br></pre></td></tr></table></figure><h2 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h2><h3 id="postgresql-conf"><a href="#postgresql-conf" class="headerlink" title="postgresql.conf"></a>postgresql.conf</h3><blockquote><p>数据库服务的配置文件</p><p>默认配置文件条目非常多，可以根据注释来配置对应选项</p><p>也可以查看<a href="https://github.com/postgres/postgres/blob/REL_10_8/src/backend/utils/misc/postgresql.conf.sample" target="_blank" rel="noopener">在线版本</a></p><p>这里简单做一下配置</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PostgreSQL configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file consists of lines of the form:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   name = value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (The <span class="string">"="</span> is optional.)  Whitespace may be used.  Comments are introduced with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"#"</span> anywhere on a line.  The complete list of parameter names and allowed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> values can be found <span class="keyword">in</span> the PostgreSQL documentation.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The commented-out settings shown <span class="keyword">in</span> this file represent the default values.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Re-commenting a setting is NOT sufficient to revert it to the default value;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you need to reload the server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file is <span class="built_in">read</span> on server startup and when the server receives a SIGHUP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> signal.  If you edit the file on a running system, you have to SIGHUP the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server <span class="keyword">for</span> the changes to take effect, run <span class="string">"pg_ctl reload"</span>, or execute</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"SELECT pg_reload_conf()"</span>.  Some parameters, <span class="built_in">which</span> are marked below,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> require a server shutdown and restart to take effect.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Any parameter can also be given as a <span class="built_in">command</span>-line option to the server, e.g.,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"postgres -c log_connections=on"</span>.  Some parameters can be changed at run time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with the <span class="string">"SET"</span> SQL <span class="built_in">command</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Memory units:  kB = kilobytes        Time units:  ms  = milliseconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                MB = megabytes                     s   = seconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                GB = gigabytes                     min = minutes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                TB = terabytes                     h   = hours</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                                                   d   = days</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FILE LOCATIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">data_directory = <span class="string">'ConfigDir'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">hba_file = <span class="string">'ConfigDir/pg_hba.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ident_file = <span class="string">'ConfigDir/pg_ident.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">external_pid_file = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONNECTIONS AND AUTHENTICATION</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Connection Settings -</span></span><br><span class="line">listen_addresses = '*'</span><br><span class="line">port = 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> max_connections默认是100</span></span><br><span class="line">max_connections = 500</span><br><span class="line">superuser_reserved_connections = 3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - TCP settings -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为0，即使用系统默认值</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_idle = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_interval = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_count = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_user_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Authentication -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 认证超时时间，默认1min</span></span><br><span class="line">authentication_timeout = 30s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码加密算法，默认md5</span></span><br><span class="line">password_encryption = md5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GSSAPI using Kerberos</span></span><br><span class="line"><span class="meta">#</span><span class="bash">krb_server_keyfile = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">krb_caseins_users = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - SSL -</span></span><br><span class="line">ssl = off</span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ca_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_cert_file = <span class="string">'server.crt'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_crl_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_key_file = <span class="string">'server.key'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ciphers = <span class="string">'HIGH:MEDIUM:+3DES:!aNULL'</span> <span class="comment"># allowed SSL ciphers</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_prefer_server_ciphers = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ecdh_curve = <span class="string">'prime256v1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_min_protocol_version = <span class="string">'TLSv1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_max_protocol_version = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_dh_params_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_passphrase_command = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_passphrase_command_supports_reload = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RESOURCE USAGE (except WAL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Memory -</span></span><br><span class="line">shared_buffers = 128MB</span><br><span class="line"><span class="meta">#</span><span class="bash">huge_pages = try</span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_buffers = 8MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_prepared_transactions = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">work_mem = 4MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maintenance_work_mem = 64MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_work_mem = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_stack_depth = 2MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">shared_memory_type = mmap</span></span><br><span class="line">dynamic_shared_memory_type = posix</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Disk -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_file_limit = -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Kernel Resources -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_files_per_process = 1000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">shared_preload_libraries = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Cost-Based Vacuum Delay -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_delay = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_hit = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_miss = 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_dirty = 20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_limit = 200</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Background Writer -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_delay = 200ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_lru_maxpages = 100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_lru_multiplier = 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_flush_after = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Asynchronous Behavior -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">effective_io_concurrency = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_worker_processes = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_maintenance_workers = 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_workers_per_gather = 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_leader_participation = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_workers = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">old_snapshot_threshold = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">backend_flush_after = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WRITE AHEAD LOG</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Settings -</span></span><br><span class="line">wal_level = replica</span><br><span class="line">fsync = on</span><br><span class="line">synchronous_commit = on</span><br><span class="line">wal_sync_method = fdatasync</span><br><span class="line"><span class="meta">#</span><span class="bash">full_page_writes = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_compression = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如需要用pg_rewind修复WAL的timeline, 需要打开wal_log_hints</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 但是开启它会导致写wal变多, 请斟酌</span></span><br><span class="line">wal_log_hints = off</span><br><span class="line"><span class="meta">#</span><span class="bash">wal_init_zero = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_recycle = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_buffers = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_writer_delay = 200ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_writer_flush_after = 1MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">commit_delay = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">commit_siblings = 5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Checkpoints -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_timeout = 5min</span></span><br><span class="line">max_wal_size = 1GB</span><br><span class="line">min_wal_size = 80MB</span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_completion_target = 0.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_flush_after = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_warning = 30s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Archiving -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_mode = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_command = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> REPLICATION</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Sending Server(s) -</span></span><br><span class="line">max_wal_senders = 10</span><br><span class="line">wal_keep_segments = 32</span><br><span class="line">wal_sender_timeout = 60s</span><br><span class="line"><span class="meta">#</span><span class="bash">max_replication_slots = 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">track_commit_timestamp = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Master Server -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">synchronous_standby_names = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_defer_cleanup_age = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Standby Servers -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hot_standby = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_standby_archive_delay = 30s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_standby_streaming_delay = 30s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_receiver_status_interval = 10s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hot_standby_feedback = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_receiver_timeout = 60ss</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_retrieve_retry_interval = 5s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Subscribers -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_logical_replication_workers = 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_sync_workers_per_subscription = 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> QUERY TUNING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Planner Method Configuration -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_bitmapscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_hashagg = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_hashjoin = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_indexscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_indexonlyscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_material = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_mergejoin = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_nestloop = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_seqscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_sort = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_tidscan = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Planner Cost Constants -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">seq_page_cost = 1.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">random_page_cost = 4.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_tuple_cost = 0.01</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_index_tuple_cost = 0.005</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_operator_cost = 0.0025</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_tuple_cost = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_setup_cost = 1000.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">min_parallel_table_scan_size = 8MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">min_parallel_index_scan_size = 512kB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">effective_cache_size = 4GB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Genetic Query Optimizer -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_threshold = 12</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_effort = 5</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_pool_size = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_generations = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_selection_bias = 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_seed = 0.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Planner Options -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_statistics_target = 100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">constraint_exclusion = partition</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cursor_tuple_fraction = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">from_collapse_limit = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">join_collapse_limit = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">force_parallel_mode = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ERROR REPORTING AND LOGGING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Where to Log -</span></span><br><span class="line">log_destination = 'stderr'</span><br><span class="line">logging_collector = on</span><br><span class="line">log_directory = 'log'</span><br><span class="line">log_filename = 'postgresql-%Y%m%d.log'</span><br><span class="line"><span class="meta">#</span><span class="bash">log_file_mode = 0600</span></span><br><span class="line">log_truncate_on_rotation = off</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line">log_rotation_size = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> These are relevant when logging to syslog:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_facility = <span class="string">'LOCAL0'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_ident = <span class="string">'postgres'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_sequence_numbers = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_split_messages = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - When to Log -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_messages = warning </span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_error_statement = error</span></span><br><span class="line">log_min_duration_statement = 0 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - What to Log -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_parse = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_rewritten = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_plan = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_pretty_print = on</span></span><br><span class="line">log_checkpoints = on </span><br><span class="line">log_connections = on </span><br><span class="line">log_disconnections = on </span><br><span class="line">log_duration = on </span><br><span class="line">log_error_verbosity = verbose</span><br><span class="line"><span class="meta">#</span><span class="bash">log_hostname = off</span></span><br><span class="line">log_line_prefix = '%m [%p]: user=%u,db=%d '</span><br><span class="line">log_lock_waits = on</span><br><span class="line"><span class="meta">#</span><span class="bash">log_statement = <span class="string">'none'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_replication_commands = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_temp_files = -1</span></span><br><span class="line">log_timezone = 'PRC'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Process Title -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cluster_name = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">update_process_title = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RUNTIME STATISTICS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Query/Index Statistics Collector -</span></span><br><span class="line">track_activities = on</span><br><span class="line">track_counts = on</span><br><span class="line">track_io_timing = on</span><br><span class="line">track_functions = none</span><br><span class="line">track_activity_query_size = 1024</span><br><span class="line">stats_temp_directory = 'pg_stat_tmp'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Statistics Monitoring -</span></span><br><span class="line">log_parser_stats = on</span><br><span class="line">log_planner_stats = on</span><br><span class="line">log_executor_stats = on</span><br><span class="line">log_statement_stats = on</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AUTOVACUUM PARAMETERS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_autovacuum_min_duration = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_max_workers = 3</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_naptime = 1min</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_threshold = 50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_analyze_threshold = 50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_scale_factor = 0.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_analyze_scale_factor = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_freeze_max_age = 200000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_multixact_freeze_max_age = 400000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_cost_delay = 20ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_cost_limit = -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CLIENT CONNECTION DEFAULTS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Statement Behavior -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_min_messages = notice</span></span><br><span class="line"><span class="meta">#</span><span class="bash">search_path = <span class="string">'"$user", public'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_tablespace = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_tablespaces = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">check_function_bodies = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_isolation = <span class="string">'read committed'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_read_only = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_deferrable = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">session_replication_role = <span class="string">'origin'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">statement_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lock_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">idle_in_transaction_session_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_freeze_min_age = 50000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_freeze_table_age = 150000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_multixact_freeze_min_age = 5000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_multixact_freeze_table_age = 150000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bytea_output = <span class="string">'hex'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">xmlbinary = <span class="string">'base64'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">xmloption = <span class="string">'content'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">gin_fuzzy_search_limit = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gin_pending_list_limit = 4MB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Locale and Formatting -</span></span><br><span class="line">datestyle = 'iso, ymd'</span><br><span class="line"><span class="meta">#</span><span class="bash">intervalstyle = <span class="string">'postgres'</span></span></span><br><span class="line">timezone = 'PRC'</span><br><span class="line"><span class="meta">#</span><span class="bash">timezone_abbreviations = <span class="string">'Default'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">extra_float_digits = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_encoding = sql_ascii</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> These settings are initialized by initdb, but they can be changed.</span></span><br><span class="line">lc_messages = 'en_US.UTF-8'# locale for system error message strings</span><br><span class="line">lc_monetary = 'en_US.UTF-8'# locale for monetary formatting</span><br><span class="line">lc_numeric = 'en_US.UTF-8'# locale for number formatting</span><br><span class="line">lc_time = 'en_US.UTF-8'# locale for time formatting</span><br><span class="line"><span class="meta">#</span><span class="bash"> default configuration <span class="keyword">for</span> text search</span></span><br><span class="line">default_text_search_config = 'pg_catalog.english'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Defaults -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dynamic_library_path = <span class="string">'$libdir'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_preload_libraries = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">session_preload_libraries = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LOCK MANAGEMENT</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">deadlock_timeout = 1s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_locks_per_transaction = 64</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_transaction = 64</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_relation = -2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_page = 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> VERSION/PLATFORM COMPATIBILITY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Previous PostgreSQL Versions -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">array_nulls = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">backslash_quote = safe_encoding</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_with_oids = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">escape_string_warning = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lo_compat_privileges = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">operator_precedence_warning = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">quote_all_identifiers = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">standard_conforming_strings = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">synchronize_seqscans = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Platforms and Clients -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">transform_null_equals = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ERROR HANDLING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">exit_on_error = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">restart_after_crash = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">data_sync_retry = off</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG FILE INCLUDES</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">include_dir = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">include_if_exists = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">include = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CUSTOMIZED OPTIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Add settings <span class="keyword">for</span> extensions here</span></span><br></pre></td></tr></table></figure><h3 id="pg-hba-conf"><a href="#pg-hba-conf" class="headerlink" title="pg_hba.conf"></a>pg_hba.conf</h3><blockquote><p>基于主机认证的配置文件</p><p>默认的配置文件好多注释，看着不方便</p><p>简化之后如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认配置数据库主机以socket、127.0.0.1、::1的方式连接数据库可以跳过认证阶段直接登录数据库</span></span><br><span class="line">local   all             all                                     trust</span><br><span class="line">host    all             all             127.0.0.1/32            trust</span><br><span class="line">host    all             all             ::1/128                 trust</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置app_user可以基于用户名密码+MD5加密算法从0.0.0.0/0访问数据库服务，并且是能访问所有databases</span></span><br><span class="line">host    all             all             0.0.0.0/0               md5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置app_user可以基于用户名密码+MD5加密算法从*.exmpale.com访问数据库服务，只能访问app_db1和app_db2</span></span><br><span class="line">host    app_db1,app_db2 app_user        .exmpale.com            md5</span><br></pre></td></tr></table></figure><p>pg_hba.conf的配置选项非常多，更详细的资料可以查看配置文件自带的注释或者查看pgsql中文社区PostgreSQL10的中文版手册，<a href="http://www.postgres.cn/docs/10/auth-pg-hba-conf.html" target="_blank" rel="noopener">链接在这</a></p><h2 id="激活数据库配置"><a href="#激活数据库配置" class="headerlink" title="激活数据库配置"></a>激活数据库配置</h2><ul><li>注释里没提及<code>change requires restart</code>，可以通过reload的方式加载配置</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">/usr/pgsql-10/bin/pg_ctl reload -D $PGDATA</span><br></pre></td></tr></table></figure><ul><li>注释里明确列明了<code>change requires restart</code>，只能restart的方式重启数据库才能生效</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">/usr/pgsql-10/bin/pg_ctl restart -D $PGDATA</span><br></pre></td></tr></table></figure><h1 id="PostgreSQL日志"><a href="#PostgreSQL日志" class="headerlink" title="PostgreSQL日志"></a>PostgreSQL日志</h1><h2 id="日志路径"><a href="#日志路径" class="headerlink" title="日志路径"></a>日志路径</h2><h3 id="默认路径"><a href="#默认路径" class="headerlink" title="默认路径"></a>默认路径</h3><p>在数据目录的log目录里面，<code>%PGDATA/log</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%a.log'</span><br></pre></td></tr></table></figure><p>其中<code>%a</code>是指星期几的缩写作为标识，例如<code>postgresql-Mon.log</code>、<code>postgresql-Tue.log</code></p><h3 id="自定义文件名"><a href="#自定义文件名" class="headerlink" title="自定义文件名"></a>自定义文件名</h3><p>postgresql.conf里面的参数控制日志的文件名</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%Y%m%d.log'</span><br></pre></td></tr></table></figure><h2 id="日志轮转"><a href="#日志轮转" class="headerlink" title="日志轮转"></a>日志轮转</h2><p>在<code>postgresql.conf</code>可以定义这些参数</p><ul><li>每天生成一个日志文件</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%Y%m%d.log'</span><br><span class="line">log_truncate_on_rotation = off</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line">log_rotation_size = 0</span><br></pre></td></tr></table></figure><ul><li>每天一个日志文件，只保留7天日志，循环覆盖之前的日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%a.log'</span><br><span class="line">log_truncate_on_rotation = on</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line">log_rotation_size = 0</span><br></pre></td></tr></table></figure><h1 id="增加PATH变量"><a href="#增加PATH变量" class="headerlink" title="增加PATH变量"></a>增加PATH变量</h1><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><blockquote><p>修改<code>~/.bash_profile</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PGHOME='/usr/pgsql-10'</span><br><span class="line">export PATH=$&#123;PGHOME&#125;/bin:$&#123;PATH&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;仅记录安装部署和初始化过程&lt;/li&gt;&lt;li&gt;操作系统使用的&lt;code&gt;CentOS-7.6.1810 x86_64&lt;/code&gt;&lt;
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus搭建简单的监控告警系统</title>
    <link href="https://luanlengli.github.io/2019/05/01/Prometheus%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E7%B3%BB%E7%BB%9F.html"/>
    <id>https://luanlengli.github.io/2019/05/01/Prometheus搭建简单的监控告警系统.html</id>
    <published>2019-05-01T02:26:45.000Z</published>
    <updated>2019-05-21T07:16:12.347Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>使用的操作系统为CentOS 7.6.1810，其他系统请自己根据差异做对应调整</p><p>仅用于记录部署过程</p><p>告警通知对接了邮件和钉钉机器人</p></blockquote><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote><p>在监控告警系统主机上安装prometheus、alertmanager和grafana</p><p>被监控的主机安装各种各样的exporter，每个exporter只监控自身的服务状态</p></blockquote><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus配置目录</span></span><br><span class="line">mkdir -p /etc/prometheus /etc/prometheus/rules.d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus用户</span></span><br><span class="line">useradd prometheus</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改属主属组</span></span><br><span class="line">chown -R prometheus:prometheus /etc/prometheus</span><br></pre></td></tr></table></figure><h2 id="软件包"><a href="#软件包" class="headerlink" title="软件包"></a>软件包</h2><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><p><a href="https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz" target="_blank" rel="noopener">prometheus-v2.9.2</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz | tar xz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir -p /var/lib/prometheus</span><br><span class="line">chwon -R prometheus:prometheus /var/lib/prometheus</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件到对应位置</span></span><br><span class="line">cd prometheus-2.9.2.linux-amd64</span><br><span class="line">chown -R prometheus:prometheus prometheus promtool console_libraries consoles prometheus.yml</span><br><span class="line">mv prometheus promtool /usr/local/bin/</span><br><span class="line">mv console_libraries consoles prometheus.yml /etc/prometheus/</span><br></pre></td></tr></table></figure><h3 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h3><p><a href="https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz" target="_blank" rel="noopener">alertmanager-v0.17.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz | tar xz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir -p /var/lib/prometheus</span><br><span class="line">chwon -R prometheus:prometheus /var/lib/prometheus</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">cd alertmanager-0.17.0.linux-amd64</span><br><span class="line">chown -R prometheus:prometheus alertmanager alertmanager.yml amtool</span><br><span class="line">mv alertmanager amtool /usr/local/bin/</span><br><span class="line">mv alertmanager.yml /etc/prometheus</span><br></pre></td></tr></table></figure><h3 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h3><p><a href="https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz" target="_blank" rel="noopener">node_exporter-v0.18.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd node_exporter-0.18.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus node_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv node_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter"><a href="#mysqld-exporter" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p><a href="https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz" target="_blank" rel="noopener">mysqld_exporter-v0.11.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd mysqld_exporter-0.11.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus mysqld_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv mysqld_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter"><a href="#postgresql-exporter" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/wrouesnel/postgres_exporter/releases/download/v0.4.7/postgres_exporter_v0.4.7_linux-amd64.tar.gz | tar xz</span><br><span class="line">cd postgres_exporter_v0.4.7_linux-amd64</span><br><span class="line">chown prometheus:prometheus postgres_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv postgres_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p><a href="https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz" target="_blank" rel="noopener">blackbox_exporter-v0.14.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd blackbox_exporter-0.14.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus blackbox_exporter blackbox.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv blackbox_exporter /usr/local/bin/</span><br><span class="line">mv blackbox.yml /etc/prometheus/</span><br></pre></td></tr></table></figure><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><p><a href="https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm" target="_blank" rel="noopener">grafana-v6.1.6</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line">wget https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm</span><br><span class="line">yum localinstall grafana-6.1.6-1.x86_64.rpm</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><p>/etc/prometheus/prometheus.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line"><span class="attr">  - static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span></span><br><span class="line"><span class="attr">      - localhost:</span><span class="number">9093</span></span><br><span class="line"><span class="attr">    scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules.d/*.rules</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9090</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9100</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">mysqld-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9104</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">postgresql-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9187</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/host-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">host-status-rule</span></span><br><span class="line"><span class="attr">    rules:</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemSpaceUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">(node_filesystem_avail_bytes&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;)</span> <span class="string">)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 85</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统空间使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统空间使用率超过 85% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemInodeUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">(node_filesystem_files_free&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_files&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;)</span> <span class="string">)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统inode使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统inode使用率超过 80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemReadOnly</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">node_filesystem_readonly&#123;job="node-exporter",device!~'rootfs'&#125;</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统只读状态"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统只读状态"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeMemoryUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(node_memory_MemTotal</span> <span class="bullet">-</span> <span class="string">(node_memory_MemFree+node_memory_Buffers+node_memory_Cached</span> <span class="string">))</span> <span class="string">/</span> <span class="string">node_memory_MemTotal</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 内存使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 内存使用率过高超过80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeCPUUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode='idle',job="node-exporter"&#125;[1m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">))</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: CPU使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: CPU使用率超过80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/mysql-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">MySQLStatsAlert</span></span><br><span class="line"><span class="attr">    rules:</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">MySQL</span> <span class="string">is</span> <span class="string">down</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> MySQL is down"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"MySQL database is down. This requires immediate action!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">open</span> <span class="string">files</span> <span class="string">high</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_innodb_num_open_files</span> <span class="string">&gt; (mysql_global_variables_open_files_limit) * 0.75</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> open files high"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Open files is high. Please consider increasing open_files_limit."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Read</span> <span class="string">buffer</span> <span class="string">size</span> <span class="string">is</span> <span class="string">bigger</span> <span class="string">than</span> <span class="string">max.</span> <span class="string">allowed</span> <span class="string">packet</span> <span class="string">size</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_read_buffer_size</span> <span class="string">&gt; mysql_global_variables_slave_max_allowed_packet </span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Read buffer size is bigger than max. allowed packet size"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Read buffer size (read_buffer_size) is bigger than max. allowed packet size (max_allowed_packet).This can break your replication."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Sort</span> <span class="string">buffer</span> <span class="string">possibly</span> <span class="string">missconfigured</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_sort_buffer_size</span> <span class="string">&lt;256*1024</span> <span class="string">or</span> <span class="string">mysql_global_variables_read_buffer_size</span> <span class="string">&gt; 4*1024*1024 </span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Sort buffer possibly missconfigured"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Sort buffer size is either too big or too small. A good value for sort_buffer_size is between 256k and 4M."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Thread</span> <span class="string">stack</span> <span class="string">size</span> <span class="string">is</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_thread_stack</span> <span class="string">&lt;196608</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Thread stack size is too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Thread stack size is too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Used</span> <span class="string">more</span> <span class="string">than</span> <span class="number">80</span><span class="string">%</span> <span class="string">of</span> <span class="string">max</span> <span class="string">connections</span> <span class="string">limited</span> </span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_max_used_connections</span> <span class="string">&gt; mysql_global_variables_max_connections * 0.8</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Used more than 80% of max connections limited"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Used more than 80% of max connections limited"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Force</span> <span class="string">Recovery</span> <span class="string">is</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_force_recovery</span> <span class="string">!=</span> <span class="number">0</span> </span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Force Recovery is enabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Force Recovery is enabled. This mode should be used for data recovery purposes only. It prohibits writing to the data."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Log</span> <span class="string">File</span> <span class="string">size</span> <span class="string">is</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_log_file_size</span> <span class="string">&lt;</span> <span class="number">16777216</span> </span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Log File size is too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"The InnoDB Log File size is possibly too small. Choosing a small InnoDB Log File size can have significant performance impacts."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Flush</span> <span class="string">Log</span> <span class="string">at</span> <span class="string">Transaction</span> <span class="string">Commit</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_flush_log_at_trx_commit</span> <span class="string">!=</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Flush Log at Transaction Commit"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Flush Log at Transaction Commit is set to a values != 1. This can lead to a loss of commited transactions in case of a power failure."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Table</span> <span class="string">definition</span> <span class="string">cache</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_open_table_definitions</span> <span class="string">&gt; mysql_global_variables_table_definition_cache</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Table definition cache too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Your Table Definition Cache is possibly too small. If it is much too small this can have significant performance impacts!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Table</span> <span class="string">open</span> <span class="string">cache</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_open_tables</span> <span class="string">&gt;mysql_global_variables_table_open_cache</span> <span class="string">*</span> <span class="number">99</span><span class="string">/100</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Table open cache too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Your Table Open Cache is possibly too small (old name Table Cache). If it is much too small this can have significant performance impacts!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Thread</span> <span class="string">stack</span> <span class="string">size</span> <span class="string">is</span> <span class="string">possibly</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_thread_stack</span> <span class="string">&lt;</span> <span class="number">262144</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Thread stack size is possibly too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Thread stack size is possibly too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Plugin</span> <span class="string">is</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_ignore_builtin_innodb</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Plugin is enabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Plugin is enabled"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binary</span> <span class="string">Log</span> <span class="string">is</span> <span class="string">disabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_log_bin</span> <span class="string">!=</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binary Log is disabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binary Log is disabled. This prohibits you to do Point in Time Recovery (PiTR)."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binlog</span> <span class="string">Cache</span> <span class="string">size</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_binlog_cache_size</span> <span class="string">&lt;</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binlog Cache size too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binlog Cache size is possibly to small. A value of 1 Mbyte or higher is OK."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binlog</span> <span class="string">Transaction</span> <span class="string">Cache</span> <span class="string">size</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_binlog_cache_size</span>  <span class="string">&lt;</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binlog Transaction Cache size too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binlog Transaction Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK."</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/postgresql-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">PostgreSQL-Status-Alert</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">########## EXPORTER RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGExporterScrapeError</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">pg_exporter_last_scrape_error</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Postgres Exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> (instance: <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>) is encountering scrape errors processing queries. Error count: ( <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> )'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">NodeExporterScrapeError</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_textfile_scrape_error</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span> </span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Node Exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> (instance: <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>) is encountering scrape errors processing custom metrics.  Error count: ( <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> )'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## POSTGRESQL RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIsUp</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">pg_up</span> <span class="string">&lt;</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'postgres_exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is unable to communicate with the configured database'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whether a system switches from primary to replica or vice versa must be configured per named job.</span></span><br><span class="line"><span class="comment"># No way to tell what value a system is supposed to be without a rule expression for that specific system</span></span><br><span class="line"><span class="comment"># 2 to 1 means it changed from primary to replica. 1 to 2 means it changed from replica to primary</span></span><br><span class="line"><span class="comment"># Set this alert for each system that you want to monitor a recovery status change</span></span><br><span class="line"><span class="comment"># Below is an example for a target job called "Replica" and watches for the value to change above 1 which means it's no longer a replica</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGRecoveryStatusSwitch_Replica </span></span><br><span class="line"><span class="comment">#    expr: ccp_is_in_recovery_status&#123;job="Replica"&#125; &gt; 1 </span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      summary: '&#123;&#123; $labels.job &#125;&#125; has changed from replica to primary'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Absence alerts must be configured per named job, otherwise there's no way to know which job is down</span></span><br><span class="line"><span class="comment"># Below is an example for a target job called "Prod"</span></span><br><span class="line"><span class="comment">#  - alert: PGConnectionAbsent</span></span><br><span class="line"><span class="comment">#    expr: absent(ccp_connection_stats_max_connections&#123;job="Prod"&#125;)</span></span><br><span class="line"><span class="comment">#    for: 10s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      description: 'Connection metric is absent from target (Prod). Check that postgres_exporter can connect to PostgreSQL.'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIdleTxn</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_idle_in_txn_time</span> <span class="string">&gt; 300</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one session idle in transaction for over 5 minutes.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance idle transactions'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIdleTxn</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_idle_in_txn_time</span> <span class="string">&gt; 900</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one session idle in transaction for over 15 minutes.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance idle transactions'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGQueryTime</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_query_time</span> <span class="string">&gt; 43200</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span> </span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one query running for over 12 hours.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Max Query Runtime'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGQueryTime</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_query_time</span> <span class="string">&gt; 86400 </span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one query running for over 1 day.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Max Query Runtime'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGConnPerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="number">100</span> <span class="string">*</span> <span class="string">(ccp_connection_stats_total</span> <span class="string">/</span> <span class="string">ccp_connection_stats_max_connections)</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is using 75% or more of available connections (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance connections'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGConnPerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="number">100</span> <span class="string">*</span> <span class="string">(ccp_connection_stats_total</span> <span class="string">/</span> <span class="string">ccp_connection_stats_max_connections)</span> <span class="string">&gt; 90 </span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is using 90% or more of available connections (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance connections'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGDBSize</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_database_size</span> <span class="string">&gt; 1.073741824e+11</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> over 100GB in size: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> bytes'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance size warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGDBSize</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_database_size</span> <span class="string">&gt; 2.68435456e+11</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> over 250GB in size: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> bytes'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance size critical'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationByteLag</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_status_byte_lag</span> <span class="string">&gt; 5.24288e+07</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one replica lagging over 50MB behind.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance replica lag warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationByteLag</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_status_byte_lag</span> <span class="string">&gt; 1.048576e+08</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one replica lagging over 100MB behind.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance replica lag warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationSlotsInactive</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_slots_active</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has one or more inactive replication slots'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance inactive replication slot'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGXIDWraparound</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_wraparound</span> <span class="string">&gt; 50</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 50% towards transaction id wraparound.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> transaction id wraparound imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGXIDWraparound</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_wraparound</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 75% towards transaction id wraparound.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance transaction id wraparound imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGEmergencyVacuum</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_emergency_autovac</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 75% towards emergency autovacuum processes beginning'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance emergency vacuum imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGEmergencyVacuum</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_emergency_autovac</span> <span class="string">&gt; 90</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 90% towards emergency autovacuum processes beginning'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance emergency vacuum imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGArchiveCommandStatus</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_archive_command_status_seconds_since_last_fail</span> <span class="string">&gt; 300</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">        severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has a recent failing archive command'</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">'Seconds since the last recorded failure of the archive_command'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGSequenceExhaustion</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_sequence_exhaustion_count</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">        severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">'Count of sequences on instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at over 75% usage: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>. Run following query to see full sequence status: SELECT * FROM monitor.sequence_status() WHERE percent &gt;= 75'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## SYSTEM RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">ExporterDown</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">avg_over_time(up[5m])</span> <span class="string">&lt;</span> <span class="number">0.9</span> </span><br><span class="line"><span class="attr">    for:</span> <span class="number">10</span><span class="string">s</span> </span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Metrics exporter service for <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> running on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has been down at least 50% of the time for the last 5 minutes. Service may be flapping or down.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Prometheus Exporter Service Down'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskUsagePerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="number">100</span> <span class="string">*</span> <span class="string">sum(node_filesystem_avail_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;)</span> <span class="string">BY</span> <span class="string">(job,device))</span> <span class="string">&gt; 70</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Disk usage on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskUsagePerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="number">100</span> <span class="string">*</span> <span class="string">sum(node_filesystem_avail_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;)</span> <span class="string">BY</span> <span class="string">(job,device))</span> <span class="string">&gt; 85</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Disk usage on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskFillPredict</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">predict_linear(node_filesystem_free_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;[1h],</span> <span class="number">4</span> <span class="string">*</span> <span class="number">3600</span><span class="string">)</span> <span class="string">&lt;</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'(EXPERIMENTAL) Disk <span class="template-variable">&#123;&#123; $labels.device &#125;&#125;</span> on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is predicted to fill in 4 hrs based on current usage'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SystemLoad5m</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_load5</span> <span class="string">&gt; 5</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'System load for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is high (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SystemLoad5m</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_load5</span> <span class="string">&gt; 10</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'System load for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is high (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">MemoryAvailable</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_Available_bytes)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes)</span> <span class="string">&lt;</span> <span class="number">25</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Memory available for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">MemoryAvailable</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_MemAvailable_bytes)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes)</span> <span class="string">&lt;</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Memory available for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SwapUsage</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_SwapFree_bytes</span> <span class="string">/</span> <span class="string">node_memory_SwapTotal_bytes)))</span> <span class="string">&gt; 60</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Swap usage for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SwapUsage</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_SwapFree_byte</span> <span class="string">/</span> <span class="string">node_memory_SwapTotal_bytes)))</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Swap usage for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## PGBACKREST RULES ##########</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Uncomment and customize one or more of these rules to monitor your pgbackrest backups. </span></span><br><span class="line"><span class="comment"># Full backups are considered the equivalent of both differentials and incrementals since both are based on the last full</span></span><br><span class="line"><span class="comment">#   And differentials are considered incrementals since incrementals will be based off the last diff if one exists</span></span><br><span class="line"><span class="comment">#   This avoid false alerts, for example when you don't run diff/incr backups on the days that you run a full</span></span><br><span class="line"><span class="comment"># Stanza should also be set if different intervals are expected for each stanza. </span></span><br><span class="line"><span class="comment">#   Otherwise rule will be applied to all stanzas returned on target system if not set.</span></span><br><span class="line"><span class="comment"># Otherwise, all backups returned by the pgbackrest info command run from where the database exists will be checked</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Relevant metric names are: </span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_full_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_incr_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_diff_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastCompletedFull_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_full_backup_time_since_completion_seconds&#123;stanza="main"&#125; &gt; 604800</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Full backup for stanza [main] on system &#123;&#123; $labels.job &#125;&#125; has not completed in the last week.'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastCompletedIncr_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_incr_backup_time_since_completion_seconds&#123;stanza="main"&#125; &gt; 86400</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Incremental backup for stanza [main] on system &#123;&#123; $labels.job &#125;&#125; has not completed in the last 24 hours.'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Runtime monitoring is handled with a single metric:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_runtime_backup_runtime_seconds</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Runtime monitoring should have the "backup_type" label set. </span></span><br><span class="line"><span class="comment">#   Otherwise the rule will apply to the last run of all backup types returned (full, diff, incr)</span></span><br><span class="line"><span class="comment"># Stanza should also be set if runtimes per stanza have different expected times</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastRuntimeFull_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_runtime_backup_runtime_seconds&#123;backup_type="full", stanza="main"&#125; &gt; 14400</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Expected runtime of full backup for stanza [main] has exceeded 4 hours'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastRuntimeDiff_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_runtime_backup_runtime_seconds&#123;backup_type="diff", stanza="main"&#125; &gt; 3600</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Expected runtime of diff backup for stanza [main] has exceeded 1 hour'</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## If the pgbackrest command fails to run, the metric disappears from the exporter output and the alert never fires. </span></span><br><span class="line"><span class="comment">## An absence alert must be configured explicitly for each target (job) that backups are being monitored.</span></span><br><span class="line"><span class="comment">## Checking for absence of just the full backup type should be sufficient (no need for diff/incr).</span></span><br><span class="line"><span class="comment">## Note that while the backrest check command failing will likely also cause a scrape error alert, the addition of this </span></span><br><span class="line"><span class="comment">## check gives a clearer answer as to what is causing it and that something is wrong with the backups.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackrestAbsentFull_Prod</span></span><br><span class="line"><span class="comment">#    expr: absent(ccp_backrest_last_full_backup_time_since_completion_seconds&#123;job="Prod"&#125;)</span></span><br><span class="line"><span class="comment">#    for: 10s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      description: 'Backup Full status missing for Prod. Check that pgbackrest info command is working on target system.'</span></span><br></pre></td></tr></table></figure><h3 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h3><p>/etc/prometheus/alertmanager.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  resolve_timeout:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">  http_config:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  smtp_from:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">  smtp_hello:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  smtp_smarthost:</span> <span class="string">smtp.example.com:465</span></span><br><span class="line"><span class="attr">  smtp_auth_username:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">  smtp_auth_password:</span> <span class="string">'这里写密码'</span></span><br><span class="line"><span class="attr">  smtp_require_tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  pagerduty_url:</span> <span class="attr">https://events.pagerduty.com/v2/enqueue</span></span><br><span class="line"><span class="attr">  hipchat_api_url:</span> <span class="attr">https://api.hipchat.com/</span></span><br><span class="line"><span class="attr">  opsgenie_api_url:</span> <span class="attr">https://api.opsgenie.com/</span></span><br><span class="line"><span class="attr">  wechat_api_url:</span> <span class="attr">https://qyapi.weixin.qq.com/cgi-bin/</span></span><br><span class="line"><span class="attr">  victorops_api_url:</span> <span class="attr">https://alert.victorops.com/integrations/generic/20131114/alert/</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="comment"># 这里配置默认路由到'default-receiver'</span></span><br><span class="line"><span class="attr">  receiver:</span> <span class="string">default-receiver</span></span><br><span class="line"><span class="attr">  group_by:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertname</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cluster</span></span><br><span class="line"><span class="attr">  group_wait:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  group_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  repeat_interval:</span> <span class="number">1</span><span class="string">h</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line"><span class="attr">- source_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">  target_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">  equal:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertname</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">dev</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">instance</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">default-receiver</span></span><br><span class="line"><span class="attr">  email_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    to:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    from:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    hello:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    smarthost:</span> <span class="string">smtp.example.com:465</span></span><br><span class="line"><span class="attr">    auth_username:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    auth_password:</span> <span class="string">'这里写密码'</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="attr">      From:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">      Subject:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "email.default.subject" . &#125;&#125;</span>'</span></span><br><span class="line"><span class="attr">      To:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    html:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "email.default.html" . &#125;&#125;</span>'</span></span><br><span class="line"><span class="attr">    require_tls:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 配置钉钉机器人</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">http://localhost:8060/dingtalk/webhook001/send</span></span><br><span class="line"><span class="comment"># 配置钉钉机器人</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">dingtalk002</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">http://localhost:8060/dingtalk/webhook002/send</span></span><br><span class="line"><span class="attr">templates:</span> <span class="string">[]</span></span><br></pre></td></tr></table></figure><p>配置dingtalk webhook程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 这里偷懒用docker跑钉钉的webhook</span></span><br><span class="line">docker run -d \</span><br><span class="line">           --restart=always \</span><br><span class="line">           --name prometheus-webhook-dingtalk \</span><br><span class="line">           -p 8060:8060 \</span><br><span class="line">           -v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro \</span><br><span class="line">           timonwong/prometheus-webhook-dingtalk \</span><br><span class="line">           --ding.profile="webhook001=https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx" \</span><br><span class="line">           --ding.profile="webhook002=https://oapi.dingtalk.com/robot/send?access_token=yyyyyyyyyyy"</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter-1"><a href="#blackbox-exporter-1" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p>/etc/prometheus/backbox_exporter.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">没空搞，占个位</span></span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter-1"><a href="#mysqld-exporter-1" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p>需要创建用于监控的数据库用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'prometheus'</span>@<span class="string">'127.0.0.1'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'prometheus_password'</span> <span class="keyword">WITH</span> MAX_USER_CONNECTIONS <span class="number">3</span>;</span><br><span class="line"><span class="keyword">GRANT</span> PROCESS, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span>, <span class="keyword">SELECT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'prometheus'</span>@<span class="string">'127.0.0.1'</span>;</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter-1"><a href="#postgresql-exporter-1" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><p>根据需求决定是否使用superuser作为postgresql_exporter的数据库用户</p><p>如果要创建专用用户可以参照下面的方式创建用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建postgresql_exporter专用用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> postgres_exporter <span class="keyword">PASSWORD</span> <span class="string">'password'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> postgres_exporter <span class="keyword">SET</span> SEARCH_PATH <span class="keyword">TO</span> postgres_exporter,pg_catalog;</span><br><span class="line"><span class="comment"># 创建schema</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SCHEMA</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 授权schema</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">USAGE</span> <span class="keyword">ON</span> <span class="keyword">SCHEMA</span> postgres_exporter <span class="keyword">TO</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 创建函数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_pg_stat_activity() <span class="keyword">RETURNS</span> SETOF pg_stat_activity <span class="keyword">AS</span></span><br><span class="line">$$ <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_catalog.pg_stat_activity; $$</span><br><span class="line">LANGUAGE sql</span><br><span class="line">VOLATILE</span><br><span class="line">SECURITY DEFINER;</span><br><span class="line"><span class="comment"># 创建视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> postgres_exporter.pg_stat_activity</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">from</span> get_pg_stat_activity();</span><br><span class="line"><span class="comment"># 视图授权</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> postgres_exporter.pg_stat_activity <span class="keyword">TO</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 创建函数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_pg_stat_replication() <span class="keyword">RETURNS</span> SETOF pg_stat_replication <span class="keyword">AS</span></span><br><span class="line">$$ <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_catalog.pg_stat_replication; $$</span><br><span class="line">LANGUAGE sql</span><br><span class="line">VOLATILE</span><br><span class="line">SECURITY DEFINER;</span><br><span class="line"><span class="comment"># 创建视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> postgres_exporter.pg_stat_replication</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> get_pg_stat_replication();</span><br><span class="line"><span class="comment"># 视图授权</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> postgres_exporter.pg_stat_replication <span class="keyword">TO</span> postgres_exporter;</span><br></pre></td></tr></table></figure><h3 id="grafana-1"><a href="#grafana-1" class="headerlink" title="grafana"></a>grafana</h3><blockquote><font color="red">偷懒警告！</font><p>这里定义管理员用户密码，还有secret_key，记得自己改，别瞎抄作业！</p><p>生产环境不要用默认密码，不然有你哭的时候</p><p>[security]<br>admin_user = admin<br>admin_password = admin<br>secret_key = SW2YcwTIb9zpOOhoPsMm</p></blockquote><p>/etc/grafana/grafana.ini</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">app_mode</span> = production</span><br><span class="line"><span class="section">[paths]</span></span><br><span class="line"><span class="attr">data</span> = /var/lib/grafana</span><br><span class="line"><span class="attr">temp_data_lifetime</span> = <span class="number">24</span>h</span><br><span class="line"><span class="attr">logs</span> = /var/log/grafana</span><br><span class="line"><span class="attr">plugins</span> = /var/lib/grafana/plugins</span><br><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="attr">protocol</span> = http</span><br><span class="line"><span class="attr">http_port</span> = <span class="number">3000</span></span><br><span class="line"><span class="attr">domain</span> = gkht</span><br><span class="line"><span class="attr">root_url</span> = http://localhost:<span class="number">3000</span></span><br><span class="line"><span class="attr">enable_gzip</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">log_queries</span> =</span><br><span class="line"><span class="section">[remote_cache]</span></span><br><span class="line"><span class="section">[session]</span></span><br><span class="line"><span class="attr">provider</span> = file</span><br><span class="line"><span class="section">[dataproxy]</span></span><br><span class="line"><span class="section">[analytics]</span></span><br><span class="line"><span class="attr">reporting_enabled</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">check_for_updates</span> = <span class="literal">false</span></span><br><span class="line"><span class="section">[security]</span></span><br><span class="line"><span class="attr">admin_user</span> = admin</span><br><span class="line"><span class="attr">admin_password</span> = admin</span><br><span class="line"><span class="attr">secret_key</span> = SW2YcwTIb9zpOOhoPsMm</span><br><span class="line"><span class="section">[snapshots]</span></span><br><span class="line"><span class="section">[dashboards]</span></span><br><span class="line"><span class="attr">versions_to_keep</span> = <span class="number">10</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">default_theme</span> = dark</span><br><span class="line"><span class="section">[auth]</span></span><br><span class="line"><span class="section">[auth.anonymous]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">org_role</span> = Viewer</span><br><span class="line"><span class="section">[auth.github]</span></span><br><span class="line"><span class="section">[auth.google]</span></span><br><span class="line"><span class="section">[auth.generic_oauth]</span></span><br><span class="line"><span class="section">[auth.grafana_com]</span></span><br><span class="line"><span class="section">[auth.proxy]</span></span><br><span class="line"><span class="section">[auth.basic]</span></span><br><span class="line"><span class="section">[auth.ldap]</span></span><br><span class="line"><span class="section">[smtp]</span></span><br><span class="line"><span class="section">[emails]</span></span><br><span class="line"><span class="section">[log]</span></span><br><span class="line"><span class="attr">mode</span> = console file</span><br><span class="line"><span class="attr">level</span> = info</span><br><span class="line"><span class="section">[log.console]</span></span><br><span class="line"><span class="section">[log.file]</span></span><br><span class="line"><span class="attr">log_rotate</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">daily_rotate</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">max_days</span> = <span class="number">7</span></span><br><span class="line"><span class="section">[log.syslog]</span></span><br><span class="line"><span class="section">[alerting]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">execute_alerts</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[explore]</span></span><br><span class="line"><span class="section">[metrics]</span></span><br><span class="line"><span class="attr">enabled</span>           = <span class="literal">true</span></span><br><span class="line"><span class="attr">interval_seconds</span>  = <span class="number">10</span></span><br><span class="line"><span class="section">[metrics.graphite]</span></span><br><span class="line"><span class="section">[tracing.jaeger]</span></span><br><span class="line"><span class="section">[grafana_com]</span></span><br><span class="line"><span class="attr">url</span> = https://grafana.com</span><br><span class="line"><span class="section">[external_image_storage]</span></span><br><span class="line"><span class="section">[external_image_storage.s3]</span></span><br><span class="line"><span class="section">[external_image_storage.webdav]</span></span><br><span class="line"><span class="section">[external_image_storage.gcs]</span></span><br><span class="line"><span class="section">[external_image_storage.azure_blob]</span></span><br><span class="line"><span class="section">[external_image_storage.local]</span></span><br><span class="line"><span class="section">[rendering]</span></span><br><span class="line"><span class="section">[enterprise]</span></span><br><span class="line"><span class="section">[panels]</span></span><br></pre></td></tr></table></figure><h2 id="systemd服务"><a href="#systemd服务" class="headerlink" title="systemd服务"></a>systemd服务</h2><h3 id="prometheus-service"><a href="#prometheus-service" class="headerlink" title="prometheus.service"></a>prometheus.service</h3><p>/usr/lib/systemd/system/prometheus.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=prometheus</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/prometheus \</span><br><span class="line">          --config.file=/etc/prometheus/prometheus.yml \</span><br><span class="line">          --storage.tsdb.path=/var/lib/prometheus \</span><br><span class="line">          --storage.tsdb.retention.time=15d \</span><br><span class="line">          --storage.tsdb.retention.size=40GB \</span><br><span class="line">          --web.console.templates=/etc/prometheus/consoles \</span><br><span class="line">          --web.console.libraries=/etc/prometheus/console_libraries</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="alertmanager-servicce"><a href="#alertmanager-servicce" class="headerlink" title="alertmanager.servicce"></a>alertmanager.servicce</h3><p>/usr/lib/systemd/system/alertmanager.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=alertmanager</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/alertmanager \</span><br><span class="line">          --config.file=/etc/prometheus/alertmanager.yml \</span><br><span class="line">          --storage.path=/var/lib/alertmanager \</span><br><span class="line">          --data.retention=120h</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="node-exporter-service"><a href="#node-exporter-service" class="headerlink" title="node_exporter.service"></a>node_exporter.service</h3><p>/usr/lib/systemd/system/node_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter-service"><a href="#blackbox-exporter-service" class="headerlink" title="blackbox_exporter.service"></a>blackbox_exporter.service</h3><p>/usr/lib/systemd/system/balckbox_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=blackbox_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/blackbox_exporter \</span><br><span class="line">          --config.file=/etc/prometheus/blackbox.yml \</span><br><span class="line">          --web.listen-address=:9115 \</span><br><span class="line">          --log.level=info          </span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter-service"><a href="#mysqld-exporter-service" class="headerlink" title="mysqld_exporter.service"></a>mysqld_exporter.service</h3><p>/usr/lib/systemd/system/mysqld_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=mysqld_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">Environment='DATA_SOURCE_NAME=prometheus:prometheus_password@tcp(127.0.0.1:3306)'</span><br><span class="line">ExecStart=/usr/local/bin/mysqld_exporter \</span><br><span class="line">          --collect.engine_innodb_status \</span><br><span class="line">          --collect.info_schema.innodb_metrics \</span><br><span class="line">          --collect.info_schema.userstats \</span><br><span class="line">          --collect.perf_schema.eventsstatements \</span><br><span class="line">          --collect.perf_schema.indexiowaits \</span><br><span class="line">          --collect.perf_schema.tableiowaits \</span><br><span class="line">          --collect.slave_status \</span><br><span class="line">          --log.level=info \</span><br><span class="line">          --web.listen-address=:9104 \</span><br><span class="line">          --web.telemetry-path=/metrics</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter-service"><a href="#postgresql-exporter-service" class="headerlink" title="postgresql_exporter.service"></a>postgresql_exporter.service</h3><p>/usr/lib/systemd/system/postgresql_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=postgresql_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">Environment=DATA_SOURCE_NAME=postgresql://postgres_exporter:password@localhost:5432/postgres?sslmode=disable</span><br><span class="line">ExecStart=/usr/local/bin/postgresql_exporter \</span><br><span class="line">          --web.listen-address=:9187 \</span><br><span class="line">          --web.telemetry-path=/metrics \</span><br><span class="line">          --log.level=info \</span><br><span class="line">          --log.format=logger:stderr</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>修改了systemd脚本之后需要reload一下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><h3 id="prometheus-1"><a href="#prometheus-1" class="headerlink" title="prometheus"></a>prometheus</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now prometheus.service</span><br></pre></td></tr></table></figure><h3 id="alertmanager-1"><a href="#alertmanager-1" class="headerlink" title="alertmanager"></a>alertmanager</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now alertmanager.service</span><br></pre></td></tr></table></figure><h3 id="node-exporter-1"><a href="#node-exporter-1" class="headerlink" title="node_exporter"></a>node_exporter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now node_exporter.service</span><br></pre></td></tr></table></figure><h3 id="grafana-2"><a href="#grafana-2" class="headerlink" title="grafana"></a>grafana</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now grafana.service</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><blockquote><p>其他服务同理，择需启动对应的服务即可</p></blockquote><h2 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h2><h3 id="prometheus-2"><a href="#prometheus-2" class="headerlink" title="prometheus"></a>prometheus</h3><p>浏览器访问<code>http://prometheus_server_ip:9090</code></p><h3 id="alertmanager-2"><a href="#alertmanager-2" class="headerlink" title="alertmanager"></a>alertmanager</h3><p>浏览器访问<code>http://prometheus_server_ip:9093</code></p><h3 id="node-exporter-2"><a href="#node-exporter-2" class="headerlink" title="node_exporter"></a>node_exporter</h3><p>浏览器访问<code>http://prometheus_server_ip:9100</code></p><h3 id="grafana-3"><a href="#grafana-3" class="headerlink" title="grafana"></a>grafana</h3><p>浏览器访问<code>http://prometheus_server_ip:3000</code></p><p>默认用户密码<code>admin</code>/<code>admin</code>，初次登录需要改密码</p><h1 id="配置grafana监控面板"><a href="#配置grafana监控面板" class="headerlink" title="配置grafana监控面板"></a>配置grafana监控面板</h1><p><a href="https://grafana.com/dashboards" target="_blank" rel="noopener">这里</a>很多作业可以抄，这里简单列举几个我用到的面板</p><blockquote><p>抄作业之前，先看看人家的说明！</p></blockquote><h2 id="node-exporter面板"><a href="#node-exporter面板" class="headerlink" title="node_exporter面板"></a>node_exporter面板</h2><p><a href="https://grafana.com/dashboards/8919" target="_blank" rel="noopener">1 Node Exporter 0.16–0.18 for Prometheus 监控展示看板</a></p><p><img src="http://img.starsl.cn/image.jpg" alt=""></p><h2 id="mysqld-exporter面板"><a href="#mysqld-exporter面板" class="headerlink" title="mysqld_exporter面板"></a>mysqld_exporter面板</h2><p><a href="https://github.com/percona/grafana-dashboards" target="_blank" rel="noopener">Percona出品的dashboard</a></p><p><img src="https://raw.githubusercontent.com/percona/grafana-dashboards/master/assets/sample2.png" alt=""></p><p><a href="https://grafana.com/dashboards/7362" target="_blank" rel="noopener">第三方人员提供的dashboard</a></p><p><img src="https://grafana.com/api/dashboards/7362/images/4691/image" alt=""></p><h2 id="postgresql-exporter面板"><a href="#postgresql-exporter面板" class="headerlink" title="postgresql_exporter面板"></a>postgresql_exporter面板</h2><p><a href="https://grafana.com/dashboards/455" target="_blank" rel="noopener">Postgres Overview</a></p><p><img src="https://grafana.com/api/dashboards/455/images/350/image" alt=""></p><h2 id="kong面板"><a href="#kong面板" class="headerlink" title="kong面板"></a>kong面板</h2><p><a href="https://grafana.com/dashboards/7424" target="_blank" rel="noopener">kong官方提供的dashboard</a></p><p><img src="https://grafana.com/api/dashboards/7424/images/5837/image" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;使用的操作系统为CentOS 7.6.1810，其他系统请自己根据差异做对应调整&lt;/p&gt;&lt;p&gt;仅用于记录部署过程&lt;/
      
    
    </summary>
    
    
      <category term="Prometheus" scheme="https://luanlengli.github.io/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>Shell处理xml文件的简单方法</title>
    <link href="https://luanlengli.github.io/2019/04/09/Shell%E5%A4%84%E7%90%86xml%E6%96%87%E4%BB%B6%E7%9A%84%E7%AE%80%E5%8D%95%E6%96%B9%E6%B3%95.html"/>
    <id>https://luanlengli.github.io/2019/04/09/Shell处理xml文件的简单方法.html</id>
    <published>2019-04-09T01:51:59.000Z</published>
    <updated>2019-04-09T10:25:55.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>工作中遇到需要使用shell命令编辑xml文件，以shell自带的命令去处理非常的不方便，于是乎找了一下处理xml的命令行工具。在此记录一下处理过程</p><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ul><li>操作系统<code>CentOS-7.x</code></li><li>软件包<code>libxml2</code>、<code>xml2</code>、<code>xmlstarlet</code></li></ul><h1 id="操作样例"><a href="#操作样例" class="headerlink" title="操作样例"></a>操作样例</h1><ul><li>准备一个xml文件，这里以<code>Apache maven</code>的<code>settings.xml</code>为例</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment">or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment">distributed with this work for additional information</span></span><br><span class="line"><span class="comment">regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment">to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment">"License"); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment">with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing,</span></span><br><span class="line"><span class="comment">software distributed under the License is distributed on an</span></span><br><span class="line"><span class="comment">"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span></span><br><span class="line"><span class="comment">KIND, either express or implied.  See the License for the</span></span><br><span class="line"><span class="comment">specific language governing permissions and limitations</span></span><br><span class="line"><span class="comment">under the License.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> | This is the configuration file for Maven. It can be specified at two levels:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |  1. User Level. This settings.xml file provides configuration for a single user,</span></span><br><span class="line"><span class="comment"> |                 and is normally provided in $&#123;user.home&#125;/.m2/settings.xml.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 <span class="doctag">NOTE:</span> This location can be overridden with the CLI option:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 -s /path/to/user/settings.xml</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |  2. Global Level. This settings.xml file provides configuration for all Maven</span></span><br><span class="line"><span class="comment"> |                 users on a machine (assuming they're all using the same Maven</span></span><br><span class="line"><span class="comment"> |                 installation). It's normally provided in</span></span><br><span class="line"><span class="comment"> |                 $&#123;maven.conf&#125;/settings.xml.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 <span class="doctag">NOTE:</span> This location can be overridden with the CLI option:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 -gs /path/to/global/settings.xml</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> | The sections in this sample file are intended to give you a running start at</span></span><br><span class="line"><span class="comment"> | getting the most out of your Maven installation. Where appropriate, the default</span></span><br><span class="line"><span class="comment"> | values (values used when the setting is not specified) are provided.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- localRepository</span></span><br><span class="line"><span class="comment">   | The path to the local repository maven will use to store artifacts.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: $&#123;user.home&#125;/.m2/repository</span></span><br><span class="line"><span class="comment">  &lt;localRepository&gt;/path/to/local/repo&lt;/localRepository&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- interactiveMode</span></span><br><span class="line"><span class="comment">   | This will determine whether maven prompts you when it needs input. If set to false,</span></span><br><span class="line"><span class="comment">   | maven will use a sensible default value, perhaps based on some other setting, for</span></span><br><span class="line"><span class="comment">   | the parameter in question.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: true</span></span><br><span class="line"><span class="comment">  &lt;interactiveMode&gt;true&lt;/interactiveMode&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- offline</span></span><br><span class="line"><span class="comment">   | Determines whether maven should attempt to connect to the network when executing a build.</span></span><br><span class="line"><span class="comment">   | This will have an effect on artifact downloads, artifact deployment, and others.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: false</span></span><br><span class="line"><span class="comment">  &lt;offline&gt;false&lt;/offline&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- pluginGroups</span></span><br><span class="line"><span class="comment">   | This is a list of additional group identifiers that will be searched when resolving plugins by their prefix, i.e.</span></span><br><span class="line"><span class="comment">   | when invoking a command line like "mvn prefix:goal". Maven will automatically add the group identifiers</span></span><br><span class="line"><span class="comment">   | "org.apache.maven.plugins" and "org.codehaus.mojo" if these are not already contained in the list.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- pluginGroup</span></span><br><span class="line"><span class="comment">     | Specifies a further group identifier to use for plugin lookup.</span></span><br><span class="line"><span class="comment">    &lt;pluginGroup&gt;com.your.plugins&lt;/pluginGroup&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- proxies</span></span><br><span class="line"><span class="comment">   | This is a list of proxies which can be used on this machine to connect to the network.</span></span><br><span class="line"><span class="comment">   | Unless otherwise specified (by system property or command-line switch), the first proxy</span></span><br><span class="line"><span class="comment">   | specification in this list marked as active will be used.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">proxies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- proxy</span></span><br><span class="line"><span class="comment">     | Specification for one proxy, to be used in connecting to the network.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;proxy&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;optional&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;active&gt;true&lt;/active&gt;</span></span><br><span class="line"><span class="comment">      &lt;protocol&gt;http&lt;/protocol&gt;</span></span><br><span class="line"><span class="comment">      &lt;username&gt;proxyuser&lt;/username&gt;</span></span><br><span class="line"><span class="comment">      &lt;password&gt;proxypass&lt;/password&gt;</span></span><br><span class="line"><span class="comment">      &lt;host&gt;proxy.host.net&lt;/host&gt;</span></span><br><span class="line"><span class="comment">      &lt;port&gt;80&lt;/port&gt;</span></span><br><span class="line"><span class="comment">      &lt;nonProxyHosts&gt;local.net|some.host.com&lt;/nonProxyHosts&gt;</span></span><br><span class="line"><span class="comment">    &lt;/proxy&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">proxies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- servers</span></span><br><span class="line"><span class="comment">   | This is a list of authentication profiles, keyed by the server-id used within the system.</span></span><br><span class="line"><span class="comment">   | Authentication profiles can be used whenever maven must make a connection to a remote server.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- server</span></span><br><span class="line"><span class="comment">     | Specifies the authentication information to use when connecting to a particular server, identified by</span></span><br><span class="line"><span class="comment">     | a unique name within the system (referred to by the 'id' attribute below).</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | <span class="doctag">NOTE:</span> You should either specify username/password OR privateKey/passphrase, since these pairings are</span></span><br><span class="line"><span class="comment">     |       used together.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;server&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;deploymentRepo&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;username&gt;repouser&lt;/username&gt;</span></span><br><span class="line"><span class="comment">      &lt;password&gt;repopwd&lt;/password&gt;</span></span><br><span class="line"><span class="comment">    &lt;/server&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Another sample, using keys to authenticate.</span></span><br><span class="line"><span class="comment">    &lt;server&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;siteServer&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;privateKey&gt;/path/to/private/key&lt;/privateKey&gt;</span></span><br><span class="line"><span class="comment">      &lt;passphrase&gt;optional; leave empty if not used.&lt;/passphrase&gt;</span></span><br><span class="line"><span class="comment">    &lt;/server&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- mirrors</span></span><br><span class="line"><span class="comment">   | This is a list of mirrors to be used in downloading artifacts from remote repositories.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | It works like this: a POM may declare a repository to use in resolving certain artifacts.</span></span><br><span class="line"><span class="comment">   | However, this repository may have problems with heavy traffic at times, so people have mirrored</span></span><br><span class="line"><span class="comment">   | it to several places.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | That repository definition will have a unique id, so we can create a mirror reference for that</span></span><br><span class="line"><span class="comment">   | repository, to be used as an alternate download site. The mirror site will be the preferred</span></span><br><span class="line"><span class="comment">   | server for that repository.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mirror</span></span><br><span class="line"><span class="comment">     | Specifies a repository mirror site to use instead of a given repository. The repository that</span></span><br><span class="line"><span class="comment">     | this mirror serves has an ID that matches the mirrorOf element of this mirror. IDs are used</span></span><br><span class="line"><span class="comment">     | for inheritance and direct lookup purposes, and must be unique across the set of mirrors.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;mirror&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;mirrorId&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;mirrorOf&gt;repositoryId&lt;/mirrorOf&gt;</span></span><br><span class="line"><span class="comment">      &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;</span></span><br><span class="line"><span class="comment">      &lt;url&gt;http://my.repository.com/repo/path&lt;/url&gt;</span></span><br><span class="line"><span class="comment">    &lt;/mirror&gt;</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- profiles</span></span><br><span class="line"><span class="comment">   | This is a list of profiles which can be activated in a variety of ways, and which can modify</span></span><br><span class="line"><span class="comment">   | the build process. Profiles provided in the settings.xml are intended to provide local machine-</span></span><br><span class="line"><span class="comment">   | specific paths and repository locations which allow the build to work in the local environment.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | For example, if you have an integration testing plugin - like cactus - that needs to know where</span></span><br><span class="line"><span class="comment">   | your Tomcat instance is installed, you can provide a variable here such that the variable is</span></span><br><span class="line"><span class="comment">   | dereferenced during the build process to configure the cactus plugin.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | As noted above, profiles can be activated in a variety of ways. One way - the activeProfiles</span></span><br><span class="line"><span class="comment">   | section of this document (settings.xml) - will be discussed later. Another way essentially</span></span><br><span class="line"><span class="comment">   | relies on the detection of a system property, either matching a particular value for the property,</span></span><br><span class="line"><span class="comment">   | or merely testing its existence. Profiles can also be activated by JDK version prefix, where a</span></span><br><span class="line"><span class="comment">   | value of '1.4' might activate a profile when the build is executed on a JDK version of '1.4.2_07'.</span></span><br><span class="line"><span class="comment">   | Finally, the list of active profiles can be specified directly from the command line.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | <span class="doctag">NOTE:</span> For profiles defined in the settings.xml, you are restricted to specifying only artifact</span></span><br><span class="line"><span class="comment">   |       repositories, plugin repositories, and free-form properties to be used as configuration</span></span><br><span class="line"><span class="comment">   |       variables for plugins in the POM.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- profile</span></span><br><span class="line"><span class="comment">     | Specifies a set of introductions to the build process, to be activated using one or more of the</span></span><br><span class="line"><span class="comment">     | mechanisms described above. For inheritance purposes, and to activate profiles via &lt;activatedProfiles/&gt;</span></span><br><span class="line"><span class="comment">     | or the command line, profiles have to have an ID that is unique.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | An encouraged best practice for profile identification is to use a consistent naming convention</span></span><br><span class="line"><span class="comment">     | for profiles, such as 'env-dev', 'env-test', 'env-production', 'user-jdcasey', 'user-brett', etc.</span></span><br><span class="line"><span class="comment">     | This will make it more intuitive to understand what the set of introduced profiles is attempting</span></span><br><span class="line"><span class="comment">     | to accomplish, particularly when you only have a list of profile id's for debug.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | This profile example uses the JDK version to trigger activation, and provides a JDK-specific repo.</span></span><br><span class="line"><span class="comment">    &lt;profile&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;jdk-1.4&lt;/id&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;activation&gt;</span></span><br><span class="line"><span class="comment">        &lt;jdk&gt;1.4&lt;/jdk&gt;</span></span><br><span class="line"><span class="comment">      &lt;/activation&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;repositories&gt;</span></span><br><span class="line"><span class="comment">        &lt;repository&gt;</span></span><br><span class="line"><span class="comment">          &lt;id&gt;jdk14&lt;/id&gt;</span></span><br><span class="line"><span class="comment">          &lt;name&gt;Repository for JDK 1.4 builds&lt;/name&gt;</span></span><br><span class="line"><span class="comment">          &lt;url&gt;http://www.myhost.com/maven/jdk14&lt;/url&gt;</span></span><br><span class="line"><span class="comment">          &lt;layout&gt;default&lt;/layout&gt;</span></span><br><span class="line"><span class="comment">          &lt;snapshotPolicy&gt;always&lt;/snapshotPolicy&gt;</span></span><br><span class="line"><span class="comment">        &lt;/repository&gt;</span></span><br><span class="line"><span class="comment">      &lt;/repositories&gt;</span></span><br><span class="line"><span class="comment">    &lt;/profile&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">     | Here is another profile, activated by the system property 'target-env' with a value of 'dev',</span></span><br><span class="line"><span class="comment">     | which provides a specific path to the Tomcat instance. To use this, your plugin configuration</span></span><br><span class="line"><span class="comment">     | might hypothetically look like:</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | ...</span></span><br><span class="line"><span class="comment">     | &lt;plugin&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;groupId&gt;org.myco.myplugins&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;artifactId&gt;myplugin&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     |   &lt;configuration&gt;</span></span><br><span class="line"><span class="comment">     |     &lt;tomcatLocation&gt;$&#123;tomcatPath&#125;&lt;/tomcatLocation&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;/configuration&gt;</span></span><br><span class="line"><span class="comment">     | &lt;/plugin&gt;</span></span><br><span class="line"><span class="comment">     | ...</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | <span class="doctag">NOTE:</span> If you just wanted to inject this configuration whenever someone set 'target-env' to</span></span><br><span class="line"><span class="comment">     |       anything, you could just leave off the &lt;value/&gt; inside the activation-property.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;profile&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;env-dev&lt;/id&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;activation&gt;</span></span><br><span class="line"><span class="comment">        &lt;property&gt;</span></span><br><span class="line"><span class="comment">          &lt;name&gt;target-env&lt;/name&gt;</span></span><br><span class="line"><span class="comment">          &lt;value&gt;dev&lt;/value&gt;</span></span><br><span class="line"><span class="comment">        &lt;/property&gt;</span></span><br><span class="line"><span class="comment">      &lt;/activation&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;properties&gt;</span></span><br><span class="line"><span class="comment">        &lt;tomcatPath&gt;/path/to/tomcat/instance&lt;/tomcatPath&gt;</span></span><br><span class="line"><span class="comment">      &lt;/properties&gt;</span></span><br><span class="line"><span class="comment">    &lt;/profile&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- activeProfiles</span></span><br><span class="line"><span class="comment">   | List of profiles that are active for all builds.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">  &lt;activeProfiles&gt;</span></span><br><span class="line"><span class="comment">    &lt;activeProfile&gt;alwaysActiveProfile&lt;/activeProfile&gt;</span></span><br><span class="line"><span class="comment">    &lt;activeProfile&gt;anotherAlwaysActiveProfile&lt;/activeProfile&gt;</span></span><br><span class="line"><span class="comment">  &lt;/activeProfiles&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在国内使用maven都需要在<code>settings.xml</code>里面配置国内的mirrors，以加速maven下载依赖包的过程。</li></ul><blockquote><p>这里以阿里云的为例，需要在settings.xml文件里面添加如下内容</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span>  </span><br><span class="line">    ...   </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>          </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h1><h2 id="处理settings-xml"><a href="#处理settings-xml" class="headerlink" title="处理settings.xml"></a>处理settings.xml</h2><ul><li>将settings.xml处理成容易处理的字符串</li><li>清理注释</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xmlstarlet ed -d <span class="string">'//comment()'</span> settings.xml | grep -v mirrors | xml2</span><br><span class="line"><span class="comment"># 输出实例</span></span><br><span class="line">/settings/@xmlns=http://maven.apache.org/SETTINGS/1.0.0</span><br><span class="line">/settings/@xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance</span><br><span class="line">/settings/@xsi:schemaLocation=http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><br><span class="line">/settings/pluginGroups</span><br><span class="line">/settings/proxies</span><br><span class="line">/settings/servers</span><br><span class="line">/settings/profiles</span><br></pre></td></tr></table></figure><h2 id="处理mirror配置"><a href="#处理mirror配置" class="headerlink" title="处理mirror配置"></a>处理mirror配置</h2><ul><li>同样使用xml2处理xml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; aliyun_mirror.xml &lt;&lt;EOF</span><br><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;mirrors&gt;</span><br><span class="line">        &lt;mirror&gt;  </span><br><span class="line">          &lt;id&gt;alimaven&lt;/id&gt;  </span><br><span class="line">          &lt;name&gt;aliyun maven&lt;/name&gt;  </span><br><span class="line">          &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;  </span><br><span class="line">          &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;          </span><br><span class="line">        &lt;/mirror&gt;</span><br><span class="line">    &lt;/mirrors&gt;</span><br><span class="line">&lt;/settings&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">xml2 &lt; aliyun_mirror.xml</span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">settings/mirrors/mirror/id=alimaven</span><br><span class="line">settings/mirrors/mirror/name=aliyun maven</span><br><span class="line">settings/mirrors/mirror/url=http://maven.aliyun.com/nexus/content/groups/public/</span><br><span class="line">settings/mirrors/mirror/mirrorOf=central</span><br></pre></td></tr></table></figure><h2 id="合并配置"><a href="#合并配置" class="headerlink" title="合并配置"></a>合并配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Settings=$(xmlstarlet ed -d <span class="string">'//comment()'</span> settings.xml | grep -v mirrors | xml2)</span><br><span class="line">AliyunMirror=$(xml2 &lt; aliyun_mirror.xml)</span><br><span class="line"><span class="built_in">printf</span> <span class="string">"<span class="variable">$Settings</span>\n<span class="variable">$AliyunMirror</span>"</span></span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">/settings/@xmlns=http://maven.apache.org/SETTINGS/1.0.0</span><br><span class="line">/settings/@xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance</span><br><span class="line">/settings/@xsi:schemaLocation=http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><br><span class="line">/settings/pluginGroups</span><br><span class="line">/settings/proxies</span><br><span class="line">/settings/servers</span><br><span class="line">/settings/profiles/settings/mirrors/mirror/id=alimaven</span><br><span class="line">/settings/mirrors/mirror/name=aliyun maven</span><br><span class="line">/settings/mirrors/mirror/url=http://maven.aliyun.com/nexus/content/groups/public/</span><br><span class="line">/settings/mirrors/mirror/mirrorOf=central</span><br></pre></td></tr></table></figure><h2 id="将字符串转换成xml格式文件"><a href="#将字符串转换成xml格式文件" class="headerlink" title="将字符串转换成xml格式文件"></a>将字符串转换成xml格式文件</h2><ul><li>这里将输出结果打印在终端，可以直接重定向到settings.xml文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">"<span class="variable">$Settings</span>\n<span class="variable">$AliyunMirror</span>"</span> | 2xml | xmllint --format -</span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span><br><span class="line">&lt;settings xmlns=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> xsi:schemaLocation=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"</span>&gt;</span><br><span class="line">  &lt;pluginGroups/&gt;</span><br><span class="line">  &lt;proxies/&gt;</span><br><span class="line">  &lt;servers/&gt;</span><br><span class="line">  &lt;profiles/&gt;</span><br><span class="line">  &lt;mirrors&gt;</span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;alimaven&lt;/id&gt;</span><br><span class="line">      &lt;name&gt;aliyun maven&lt;/name&gt;</span><br><span class="line">      &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">      &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line">  &lt;/mirrors&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;p&gt;工作中遇到需要使用shell命令编辑xml文件，以shell自带的命令去处理非常的不方便，于是乎找了一下处理xml的命令行工具。在此记录一下
      
    
    </summary>
    
    
      <category term="shell" scheme="https://luanlengli.github.io/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>git pull免密码配置</title>
    <link href="https://luanlengli.github.io/2019/04/07/git-pull%E5%85%8D%E5%AF%86%E7%A0%81%E9%85%8D%E7%BD%AE.html"/>
    <id>https://luanlengli.github.io/2019/04/07/git-pull免密码配置.html</id>
    <published>2019-04-07T14:25:00.000Z</published>
    <updated>2019-04-07T14:29:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>git 拉取代码的时候，如果不使用密钥的方式时，会要求输入用户密码，非常繁琐</li><li>为此需要配置免账号密码登录</li></ul><h1 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h1><ul><li>切换到用户家目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure><ul><li>运行git命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.helper store</span><br></pre></td></tr></table></figure><ul><li>此命令会在用户家目录生成一个<code>.gitconfig</code>，内容如下</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[credential]</span><br><span class="line">helper = store</span><br></pre></td></tr></table></figure><ul><li>再次运行<code>git pull</code>还是会提示输入用户密码，命令会在用户家目录生成<code>.git-credentials</code>文件，里面会保存刚才输入的用户密码。</li><li>后续操作git的时候就不会要求输入用户密码了</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;git 拉取代码的时候，如果不使用密钥的方式时，会要求输入用户密码，非常繁琐&lt;/li&gt;&lt;li&gt;为此需要配置免账号密码登录&lt;/li&gt;
      
    
    </summary>
    
    
      <category term="git" scheme="https://luanlengli.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>阿里云RDS数据库MySQL5.7实例主从搭建过程</title>
    <link href="https://luanlengli.github.io/2019/04/06/%E9%98%BF%E9%87%8C%E4%BA%91RDS%E6%95%B0%E6%8D%AE%E5%BA%93MySQL5-7%E5%AE%9E%E4%BE%8B%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B.html"/>
    <id>https://luanlengli.github.io/2019/04/06/阿里云RDS数据库MySQL5-7实例主从搭建过程.html</id>
    <published>2019-04-06T03:16:33.000Z</published>
    <updated>2019-04-25T15:26:30.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>工作中遇到需要搭建阿里云RDS数据库MySQL5.7实例主从集群，在此记录搭建过程</li><li>主库<ul><li>阿里云RDS数据库MySQL5.7实例</li></ul></li><li>从库<ul><li>本地服务器MySQL5.7，通过公网访问阿里云RDS实例</li></ul></li></ul><h1 id="阿里云RDS实例准备操作"><a href="#阿里云RDS实例准备操作" class="headerlink" title="阿里云RDS实例准备操作"></a>阿里云RDS实例准备操作</h1><ul><li>登录阿里云管理控制台</li><li>选择【云数据库RDS版】</li><li>切换到【云数据库RDS版】界面，左上角选择【数据中心】，在【实例列表】中找到主库，点击右侧的【管理】</li><li>在【基本信息】可以看到主库的【外网地址】和端口<ul><li>外网地址示例：<code>rm-xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com</code></li><li>端口：<code>3306</code></li></ul></li><li>切换到【账号管理】，点击【创建账号】<ul><li>用户名：<code>repuser</code></li><li>密码：<code>repuserpassword</code></li><li>账号类型：<code>普通帐号</code></li><li>授权数据库：<code>选择需要同步的数据库</code>，选择完毕后，权限统一设置为【只读】</li></ul></li><li>登录阿里云RDS实例，查看主库信息<ul><li><code>show variables like &#39;%binlog_format%&#39;;</code></li><li><code>show variables like &#39;server_id&#39;;</code></li></ul></li></ul><h1 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h1><ul><li>安装MySQL5.7，这里网上很多教程，自行解决</li><li>修改从库<code>my.cnf</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># 这里的server-id要跟RDS主库查询到的server-id不一样</span></span><br><span class="line">server-id                =  3306              </span><br><span class="line">log_bin                  =  /data/mysql-data</span><br><span class="line">expire_logs_days         =  7</span><br><span class="line">max_binlog_size          =  100M</span><br><span class="line">replicate-ignore-db      =  ccccc                  <span class="comment">#不想同步的数据库</span></span><br><span class="line">replicate-ignore-db      =  ddddd                  <span class="comment">#不想同步的数据库</span></span><br><span class="line"><span class="comment"># 启动GTID </span></span><br><span class="line">gtid_mode                =  on</span><br><span class="line">enforce_gtid_consistency =  on</span><br><span class="line">binlog_format            =  row                    <span class="comment">#设置 binlog 为 row</span></span><br><span class="line"><span class="built_in">log</span>-slave-updates        =  1</span><br></pre></td></tr></table></figure><ul><li>在从库上对阿里云RDS实例做一次dump备份</li></ul><blockquote><p>假设我们要同步的是aaa和bbb两个库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u'repuser' \</span><br><span class="line">          -h'rm-xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com' \</span><br><span class="line">          -P 3306 \</span><br><span class="line">          -p'repuserpassword' \</span><br><span class="line">          --set-gtid-purged=ON \</span><br><span class="line">          --master-data=2 \</span><br><span class="line">          --single-transaction \</span><br><span class="line">          --databases aaa bbb &gt; aliyun_rds_dump.sql</span><br></pre></td></tr></table></figure><ul><li>从库导入dump备份</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u<span class="string">'root'</span> \</span><br><span class="line">      -p \</span><br><span class="line">      -P3306 \</span><br><span class="line">      &lt; aliyun_rds_dump.sql</span><br></pre></td></tr></table></figure><ul><li>设置从库</li></ul><blockquote><p>启用基于GTID的主从同步</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host = &apos;xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com&apos;,</span><br><span class="line">                        master_port = 3306, </span><br><span class="line">                        master_user = &apos;repuser&apos;, </span><br><span class="line">                        master_password=&apos;repuserpassword&apos;, </span><br><span class="line">                        master_connect_retry=10,</span><br><span class="line">                        master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure><ul><li>检查主从同步状态</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G</span><br><span class="line">mysql&gt; show processlist \G</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;工作中遇到需要搭建阿里云RDS数据库MySQL5.7实例主从集群，在此记录搭建过程&lt;/li&gt;&lt;li&gt;主库&lt;ul&gt;&lt;li&gt;阿里云RD
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL常用SQL语句</title>
    <link href="https://luanlengli.github.io/2019/03/29/MySQL%E5%B8%B8%E7%94%A8SQL%E8%AF%AD%E5%8F%A5.html"/>
    <id>https://luanlengli.github.io/2019/03/29/MySQL常用SQL语句.html</id>
    <published>2019-03-29T01:54:19.000Z</published>
    <updated>2019-04-16T13:32:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="查看所有数据库大小"><a href="#查看所有数据库大小" class="headerlink" title="查看所有数据库大小"></a>查看所有数据库大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                                 <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(table_rows)                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>))  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.tables</span><br><span class="line"><span class="keyword">GROUP</span>  <span class="keyword">BY</span> table_schema</span><br><span class="line"><span class="keyword">ORDER</span>  <span class="keyword">BY</span> <span class="keyword">Sum</span>(data_length) <span class="keyword">DESC</span>,</span><br><span class="line">          <span class="keyword">Sum</span>(index_length) <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h1 id="查看数据库各表大小"><a href="#查看数据库各表大小" class="headerlink" title="查看数据库各表大小"></a>查看数据库各表大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                            <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       table_name                              <span class="keyword">AS</span> <span class="string">'表名'</span>,</span><br><span class="line">       table_rows                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.TABLES</span><br><span class="line"><span class="keyword">ORDER</span>  <span class="keyword">BY</span> data_length <span class="keyword">DESC</span>,</span><br><span class="line">          index_length <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h1 id="查看指定数据库大小"><a href="#查看指定数据库大小" class="headerlink" title="查看指定数据库大小"></a>查看指定数据库大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                                 <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(table_rows)                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>))  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.tables</span><br><span class="line"><span class="keyword">WHERE</span>  table_schema = <span class="string">'mysql'</span>;</span><br></pre></td></tr></table></figure><h1 id="查看指定数据库各表大小"><a href="#查看指定数据库各表大小" class="headerlink" title="查看指定数据库各表大小"></a>查看指定数据库各表大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                            <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       table_name                              <span class="keyword">AS</span> <span class="string">'表名'</span>,</span><br><span class="line">       table_rows                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.TABLES</span><br><span class="line"><span class="keyword">WHERE</span>  table_schema = <span class="string">'mysql'</span></span><br><span class="line"><span class="keyword">ORDER</span>  <span class="keyword">BY</span> data_length <span class="keyword">DESC</span>,</span><br><span class="line">          index_length <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h1 id="建库时指定字符集和排序规则"><a href="#建库时指定字符集和排序规则" class="headerlink" title="建库时指定字符集和排序规则"></a>建库时指定字符集和排序规则</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE DB_NAME </span><br><span class="line">  CHARACTER SET utf8mb4 </span><br><span class="line">  COLLATE utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;查看所有数据库大小&quot;&gt;&lt;a href=&quot;#查看所有数据库大小&quot; class=&quot;headerlink&quot; title=&quot;查看所有数据库大小&quot;&gt;&lt;/a&gt;查看所有数据库大小&lt;/h1&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td 
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-学习笔记</title>
    <link href="https://luanlengli.github.io/2019/02/22/Elasticsearch-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://luanlengli.github.io/2019/02/22/Elasticsearch-学习笔记.html</id>
    <published>2019-02-22T15:28:10.000Z</published>
    <updated>2019-03-03T14:13:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="cat-APIs"><a href="#cat-APIs" class="headerlink" title="_cat APIs"></a>_cat APIs</h1><p>通过访问elasticsearch集群的<code>/_cat</code>可以获取很多有用的信息。</p><p>使用<code>curl -X GET &quot;http://elasticsearch:9200/_cat&quot;</code>可以单独列出所有可用的命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">"http://elasticsearch-1:9200/_cat/"</span></span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;<span class="built_in">alias</span>&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure><h2 id="获取-cat-API帮助"><a href="#获取-cat-API帮助" class="headerlink" title="获取_cat API帮助"></a>获取_cat API帮助</h2><ul><li>可以在<code>/_cat/COMMAND</code>后面加上参数help，获取对应的帮助信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/allocation?help"</span></span><br><span class="line">shards       | s              | number of shards on node      </span><br><span class="line">disk.indices | di,diskIndices | disk used by ES indices       </span><br><span class="line">disk.used    | du,diskUsed    | disk used (total, not just ES)</span><br><span class="line">disk.avail   | da,diskAvail   | disk available                </span><br><span class="line">disk.total   | dt,diskTotal   | total capacity of all volumes </span><br><span class="line">disk.percent | dp,diskPercent | percent disk used             </span><br><span class="line">host         | h              | host of node                  </span><br><span class="line">ip           |                | ip of node                    </span><br><span class="line">node         | n              | name of node</span><br></pre></td></tr></table></figure><h2 id="获取当前master信息"><a href="#获取当前master信息" class="headerlink" title="获取当前master信息"></a>获取当前master信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/master?v"</span></span><br><span class="line">id                     host          ip            node</span><br><span class="line">JLyKyWH_QnSiXXuRNCj_3g 172.16.80.201 172.16.80.201 elasticsearch-1</span><br></pre></td></tr></table></figure><h2 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/nodes?format=json&amp;pretty"</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ip"</span> : <span class="string">"172.16.80.201"</span>,</span><br><span class="line">    <span class="string">"heap.percent"</span> : <span class="string">"7"</span>,</span><br><span class="line">    <span class="string">"ram.percent"</span> : <span class="string">"85"</span>,</span><br><span class="line">    <span class="string">"cpu"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"load_1m"</span> : <span class="string">"0.00"</span>,</span><br><span class="line">    <span class="string">"load_5m"</span> : <span class="string">"0.08"</span>,</span><br><span class="line">    <span class="string">"load_15m"</span> : <span class="string">"0.20"</span>,</span><br><span class="line">    <span class="string">"node.role"</span> : <span class="string">"mdi"</span>,</span><br><span class="line">    <span class="string">"master"</span> : <span class="string">"*"</span>,</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="获取索引信息"><a href="#获取索引信息" class="headerlink" title="获取索引信息"></a>获取索引信息</h2><ul><li>以json格式返回结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET -H <span class="string">"Accept: application/json"</span> <span class="string">"http://elasticsearch-1:9200/_cat/indices?format=json&amp;pretty"</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">".kibana"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"V_t2TnJKQ9WV8E1C_uzIfA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"6"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"37.3kb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"37.3kb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"bank"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"3OEfeSwsTyKyC2zKHbuzJQ"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"1000"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"640.8kb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"640.8kb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.18"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"h8m1NlTIQS6Z49mHACYokA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4631"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"27mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"27mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"shakespeare"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"xwoP7Pc3Q3ySZ47MosHrFA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"111396"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"29mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"29mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.20"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"ewX3DcZHScOK4Mi6lF6Hqg"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4750"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"30.3mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"30.3mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.19"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"siQA71vbSYOgE3a8M7HDhg"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4624"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"29.3mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"29.3mb"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>以yaml格式返回结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/indices?format=yaml&amp;pretty"</span></span><br><span class="line">---</span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">".kibana"</span></span><br><span class="line">  uuid: <span class="string">"V_t2TnJKQ9WV8E1C_uzIfA"</span></span><br><span class="line">  pri: <span class="string">"1"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"6"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"37.3kb"</span></span><br><span class="line">  pri.store.size: <span class="string">"37.3kb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"bank"</span></span><br><span class="line">  uuid: <span class="string">"3OEfeSwsTyKyC2zKHbuzJQ"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"1000"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"640.8kb"</span></span><br><span class="line">  pri.store.size: <span class="string">"640.8kb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.18"</span></span><br><span class="line">  uuid: <span class="string">"h8m1NlTIQS6Z49mHACYokA"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4631"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"27mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"27mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"shakespeare"</span></span><br><span class="line">  uuid: <span class="string">"xwoP7Pc3Q3ySZ47MosHrFA"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"111396"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"29mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"29mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.20"</span></span><br><span class="line">  uuid: <span class="string">"ewX3DcZHScOK4Mi6lF6Hqg"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4750"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"30.3mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"30.3mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.19"</span></span><br><span class="line">  uuid: <span class="string">"siQA71vbSYOgE3a8M7HDhg"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4624"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"29.3mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"29.3mb"</span></span><br></pre></td></tr></table></figure><h1 id="cluster-APIs"><a href="#cluster-APIs" class="headerlink" title="_cluster APIs"></a>_cluster APIs</h1><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster.html" target="_blank" rel="noopener">这里</a></p><h2 id="Cluster-Health"><a href="#Cluster-Health" class="headerlink" title="Cluster Health"></a>Cluster Health</h2><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html" target="_blank" rel="noopener">这里</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/health?format=yaml&amp;pretty"</span></span><br><span class="line">---</span><br><span class="line">cluster_name: <span class="string">"elasticsearch"</span></span><br><span class="line">status: <span class="string">"yellow"</span></span><br><span class="line">timed_out: <span class="literal">false</span></span><br><span class="line">number_of_nodes: 1</span><br><span class="line">number_of_data_nodes: 1</span><br><span class="line">active_primary_shards: 26</span><br><span class="line">active_shards: 26</span><br><span class="line">relocating_shards: 0</span><br><span class="line">initializing_shards: 0</span><br><span class="line">unassigned_shards: 26</span><br><span class="line">delayed_unassigned_shards: 0</span><br><span class="line">number_of_pending_tasks: 0</span><br><span class="line">number_of_in_flight_fetch: 0</span><br><span class="line">task_max_waiting_in_queue_millis: 0</span><br><span class="line">active_shards_percent_as_number: 50.0</span><br></pre></td></tr></table></figure><h2 id="Cluster-State"><a href="#Cluster-State" class="headerlink" title="Cluster State"></a>Cluster State</h2><p>显示集群状态，官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state.html" target="_blank" rel="noopener">这里</a></p><h3 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/version?"</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"version"</span> : 16,</span><br><span class="line">  <span class="string">"state_uuid"</span> : <span class="string">"w0Bp1nGfRdCGxhA5zD1BBw"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看master节点"><a href="#查看master节点" class="headerlink" title="查看master节点"></a>查看master节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/master_node?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"master_node"</span> : <span class="string">"JLyKyWH_QnSiXXuRNCj_3g"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/nodes?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"nodes"</span> : &#123;</span><br><span class="line">    <span class="string">"JLyKyWH_QnSiXXuRNCj_3g"</span> : &#123;</span><br><span class="line">      <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span>,</span><br><span class="line">      <span class="string">"ephemeral_id"</span> : <span class="string">"qdnVkiizToCVPhmDieH3Mg"</span>,</span><br><span class="line">      <span class="string">"transport_address"</span> : <span class="string">"172.16.80.201:9300"</span>,</span><br><span class="line">      <span class="string">"attributes"</span> : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Cluster-States"><a href="#Cluster-States" class="headerlink" title="Cluster States"></a>Cluster States</h2><p>显示集群统计信息，官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-stats.html" target="_blank" rel="noopener">这里</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/stats?format=json&amp;pretty"</span></span><br></pre></td></tr></table></figure><h2 id="Cluster-Update-Settings"><a href="#Cluster-Update-Settings" class="headerlink" title="Cluster Update Settings"></a>Cluster Update Settings</h2><p>用于更新集群设置，可以永久persistent和临时transient设置某些参数</p><ul><li>新启动的集群是没有配置的信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/settings?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"persistent"</span> : &#123; &#125;,</span><br><span class="line">  <span class="string">"transient"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>临时修改集群recovery最大速度</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT \</span><br><span class="line">     -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">     <span class="string">"http://elasticsearch-1:9200/_cluster/settings?format=json&amp;pretty"</span> \</span><br><span class="line">     -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "persistent" : &#123;</span></span><br><span class="line"><span class="string">        "indices.recovery.max_bytes_per_sec" : "50mb"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="Node-Stats"><a href="#Node-Stats" class="headerlink" title="Node Stats"></a>Node Stats</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_nodes/stats?format=json&amp;pretty"</span></span><br></pre></td></tr></table></figure><h2 id="Node-Info"><a href="#Node-Info" class="headerlink" title="Node Info"></a>Node Info</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不带过滤参数，默认显示所有节点信息</span></span><br><span class="line">GET /_nodes</span><br><span class="line"><span class="comment"># 获取所有节点信息</span></span><br><span class="line">GET /_nodes/_all</span><br><span class="line"><span class="comment"># 获取当前节点信息</span></span><br><span class="line">GET /_nodes/_local</span><br><span class="line"><span class="comment"># 获取master节点信息</span></span><br><span class="line">GET /_nodes/_master</span><br><span class="line"><span class="comment"># 以主机名作为条件过滤节点，或者使用通配符匹配节点</span></span><br><span class="line">GET /_nodes/node_name_goes_here</span><br><span class="line">GET /_nodes/node_name_goes_*</span><br><span class="line"><span class="comment"># 可以使用IP地址加通配符过滤节点</span></span><br><span class="line">GET /_nodes/10.0.0.3,10.0.0.4</span><br><span class="line">GET /_nodes/10.0.0.*</span><br><span class="line"><span class="comment"># 以role作为过滤条件</span></span><br><span class="line">GET /_nodes/_all,master:<span class="literal">false</span></span><br><span class="line">GET /_nodes/data:<span class="literal">true</span>,ingest:<span class="literal">true</span></span><br><span class="line">GET /_nodes/coordinating_only:<span class="literal">true</span></span><br><span class="line"><span class="comment"># 根据elasticsearch.yml文件定义的node.attr.rack属性过滤节点，例如`node.attr.rack: 2`</span></span><br><span class="line">GET /_nodes/rack:2</span><br><span class="line">GET /_nodes/ra*:2</span><br><span class="line">GET /_nodes/ra*:2*</span><br></pre></td></tr></table></figure><h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/5.6/index.html" target="_blank" rel="noopener">这里</a></p><p>二进制文件<code>elasticsearch/bin/elasticsearch-plugin</code></p><h2 id="查看默认可用的插件"><a href="#查看默认可用的插件" class="headerlink" title="查看默认可用的插件"></a>查看默认可用的插件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-plugin install --<span class="built_in">help</span></span><br><span class="line">Install a plugin</span><br><span class="line"></span><br><span class="line">The following official plugins may be installed by name:</span><br><span class="line">  analysis-icu</span><br><span class="line">  analysis-kuromoji</span><br><span class="line">  analysis-phonetic</span><br><span class="line">  analysis-smartcn</span><br><span class="line">  analysis-stempel</span><br><span class="line">  analysis-ukrainian</span><br><span class="line">  discovery-azure-classic</span><br><span class="line">  discovery-ec2</span><br><span class="line">  discovery-file</span><br><span class="line">  discovery-gce</span><br><span class="line">  ingest-attachment</span><br><span class="line">  ingest-geoip</span><br><span class="line">  ingest-user-agent</span><br><span class="line">  lang-javascript</span><br><span class="line">  lang-python</span><br><span class="line">  mapper-attachments</span><br><span class="line">  mapper-murmur3</span><br><span class="line">  mapper-size</span><br><span class="line">  repository-azure</span><br><span class="line">  repository-gcs</span><br><span class="line">  repository-hdfs</span><br><span class="line">  repository-s3</span><br><span class="line">  store-smb</span><br><span class="line">  x-pack</span><br></pre></td></tr></table></figure><h1 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h1><h2 id="新增索引"><a href="#新增索引" class="headerlink" title="新增索引"></a>新增索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://elasticsearch-1:9200/twitter"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "settings" : &#123;</span></span><br><span class="line"><span class="string">        "index" : &#123;</span></span><br><span class="line"><span class="string">            "number_of_shards" : 3, </span></span><br><span class="line"><span class="string">            "number_of_replicas" : 2 </span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure><h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE <span class="string">"http://elasticsearch-1:9200/twitter"</span></span><br></pre></td></tr></table></figure><h2 id="获取索引"><a href="#获取索引" class="headerlink" title="获取索引"></a>获取索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">"http://elasticsearch-1:9200/twitter"</span></span><br></pre></td></tr></table></figure><h2 id="更新索引"><a href="#更新索引" class="headerlink" title="更新索引"></a>更新索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://elasticsearch-1:9200/twitter/_settings"</span> \</span><br><span class="line">     -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">     -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "index" : &#123;</span></span><br><span class="line"><span class="string">        "number_of_replicas" : 2</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure><h2 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class1/1?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Jing",</span></span><br><span class="line"><span class="string">  "last_name": "Guo",</span></span><br><span class="line"><span class="string">  "gender": "Male",</span></span><br><span class="line"><span class="string">  "age": 25,</span></span><br><span class="line"><span class="string">  "courses": "Xiang Long Shi Ba Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Rong",</span></span><br><span class="line"><span class="string">  "last_name": "Huang",</span></span><br><span class="line"><span class="string">  "gender": "Female",</span></span><br><span class="line"><span class="string">  "age": 23,</span></span><br><span class="line"><span class="string">  "courses": "Luo Ying Shen Jian Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class2/1?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Guo",</span></span><br><span class="line"><span class="string">  "last_name": "Yang",</span></span><br><span class="line"><span class="string">  "gender": "Male",</span></span><br><span class="line"><span class="string">  "age": 2,</span></span><br><span class="line"><span class="string">  "courses": "An Ran Xiao Hun Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="获取文档"><a href="#获取文档" class="headerlink" title="获取文档"></a>获取文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/class1/1?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"students"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"class1"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 3,</span><br><span class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"_source"</span> : &#123;</span><br><span class="line">    <span class="string">"first_name"</span> : <span class="string">"Jing"</span>,</span><br><span class="line">    <span class="string">"last_name"</span> : <span class="string">"Guo"</span>,</span><br><span class="line">    <span class="string">"gender"</span> : <span class="string">"Male"</span>,</span><br><span class="line">    <span class="string">"age"</span> : 25,</span><br><span class="line">    <span class="string">"courses"</span> : <span class="string">"Xiang Long Shi Ba Zhang"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"students"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"class1"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 1,</span><br><span class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"_source"</span> : &#123;</span><br><span class="line">    <span class="string">"first_name"</span> : <span class="string">"Rong"</span>,</span><br><span class="line">    <span class="string">"last_name"</span> : <span class="string">"Huang"</span>,</span><br><span class="line">    <span class="string">"gender"</span> : <span class="string">"Female"</span>,</span><br><span class="line">    <span class="string">"age"</span> : 23,</span><br><span class="line">    <span class="string">"courses"</span> : <span class="string">"Luo Ying Shen Jian Zhang"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><ul><li>直接PUT覆盖</li><li>使用<code>_update</code>API</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">"http://elasticsearch-1:9200/students/class1/2/_update?pretty"</span> \</span><br><span class="line">     -H <span class="string">"Accept: application/json"</span> \</span><br><span class="line">     -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "doc" : &#123;</span></span><br><span class="line"><span class="string">    "age" : 22</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span></span><br></pre></td></tr></table></figure><h1 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h1><h2 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="查询操作阶段"><a href="#查询操作阶段" class="headerlink" title="查询操作阶段"></a>查询操作阶段</h2><ul><li>分散阶段</li><li>合并阶段</li></ul><h2 id="查询方式"><a href="#查询方式" class="headerlink" title="查询方式"></a>查询方式</h2><ul><li>通过Restful API查询，查询参数见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-uri-request.html" target="_blank" rel="noopener">官方文档</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span></span><br></pre></td></tr></table></figure><ul><li>通过发送REST request body查询，查询参数见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-request-body.html" target="_blank" rel="noopener">官方文档</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配所有</span></span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配年龄</span></span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query":&#123;</span></span><br><span class="line"><span class="string">    "bool":&#123;</span></span><br><span class="line"><span class="string">      "must":[</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          "range":&#123;</span></span><br><span class="line"><span class="string">            "age":&#123;</span></span><br><span class="line"><span class="string">              "gt":"21",</span></span><br><span class="line"><span class="string">              "lt":"24"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="多索引、多类型查询"><a href="#多索引、多类型查询" class="headerlink" title="多索引、多类型查询"></a>多索引、多类型查询</h2><ul><li><code>_search</code>：所有索引</li><li><code>/INDEX_NAME/_search</code>：单索引</li><li><code>/INDEX1,INDEX2/_search</code>：多索引</li><li><code>/students/class1/_search</code>：单类型搜索</li><li><code>/students/class1,class2/_search</code>：多类型搜索</li></ul><h1 id="Mapping和Analysis"><a href="#Mapping和Analysis" class="headerlink" title="Mapping和Analysis"></a>Mapping和Analysis</h1><ul><li>Elasticsearch对每个文档，会取得所有域的所有值，生成一个名为<code>“_all”</code>的域</li><li>执行查询的时候，如果未指定<code>query_string</code>，则在<code>“_all”</code>域上执行查询操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在_all域搜索</span></span><br><span class="line">curl /_search?q=<span class="string">"Keyword"</span></span><br><span class="line"><span class="comment"># 在指定的FIELD_NAME这个域搜索</span></span><br><span class="line">curl /_search?q=FIELD_NAME:<span class="string">"Keyword"</span></span><br></pre></td></tr></table></figure><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/mapping-types.html" target="_blank" rel="noopener">官方文档</a></p><ul><li>array</li><li>binary</li><li>range</li><li>boolean</li><li>date</li><li>geo-point</li><li>geo-shape</li><li>IP</li><li>keyword</li><li>nested</li><li>numeric</li><li>object</li><li>text</li><li>token count</li><li>percolatro</li><li>join</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;cat-APIs&quot;&gt;&lt;a href=&quot;#cat-APIs&quot; class=&quot;headerlink&quot; title=&quot;_cat APIs&quot;&gt;&lt;/a&gt;_cat APIs&lt;/h1&gt;&lt;p&gt;通过访问elasticsearch集群的&lt;code&gt;/_cat&lt;/code&gt;可以获取很多
      
    
    </summary>
    
    
      <category term="elasticsearch" scheme="https://luanlengli.github.io/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-5.6.x安装配置</title>
    <link href="https://luanlengli.github.io/2019/02/21/Elasticsearch-5-6-x%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE.html"/>
    <id>https://luanlengli.github.io/2019/02/21/Elasticsearch-5-6-x安装配置.html</id>
    <published>2019-02-21T09:57:55.000Z</published>
    <updated>2019-05-21T03:15:10.572Z</updated>
    
    <content type="html"><![CDATA[<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><h2 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS-7"></a>CentOS-7</h2><p>准备两台服务器，做elasticsearch集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="hosts静态解析"><a href="#hosts静态解析" class="headerlink" title="hosts静态解析"></a>hosts静态解析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.201 elasticsearch-1</span><br><span class="line">172.16.80.202 elasticsearch-2</span><br></pre></td></tr></table></figure><h2 id="Oracle-JDK-8u201"><a href="#Oracle-JDK-8u201" class="headerlink" title="Oracle JDK-8u201"></a>Oracle JDK-8u201</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换工作目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="comment"># 下载JDK并解压</span></span><br><span class="line">wget --no-check-certificate \</span><br><span class="line">     -O - \</span><br><span class="line">     -c \</span><br><span class="line">     --header <span class="string">"Cookie: oraclelicense=accept-securebackup-cookie"</span> <span class="string">"https://download.oracle.com/otn-pub/java/jdk/8u201-b09/42970487e3af4f5aa5bca3f542482c60/jdk-8u201-linux-x64.tar.gz"</span> \</span><br><span class="line">     | tar xz </span><br><span class="line"><span class="comment"># 创建软链接</span></span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/jdk1.8.0_201 /usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">cat &gt; /etc/profile.d/java.sh &lt;&lt;EOF</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span> </span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/java.sh</span><br></pre></td></tr></table></figure><h2 id="创建elasticsearch用户"><a href="#创建elasticsearch用户" class="headerlink" title="创建elasticsearch用户"></a>创建elasticsearch用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd esuser</span><br></pre></td></tr></table></figure><h2 id="修改limits"><a href="#修改limits" class="headerlink" title="修改limits"></a>修改limits</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/esuser.conf &lt;&lt;EOF</span><br><span class="line">esuser  -  nofile  262144</span><br><span class="line">esuser  -  memlock unlimited</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br><span class="line">cat &gt; /etc/sysctl.d/elasticsearch.conf &lt;&lt;EOF</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"><span class="comment"># 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="安装elasticsearch"><a href="#安装elasticsearch" class="headerlink" title="安装elasticsearch"></a>安装elasticsearch</h1><h2 id="下载elasticsearch"><a href="#下载elasticsearch" class="headerlink" title="下载elasticsearch"></a>下载elasticsearch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.15.tar.gz</span><br><span class="line">tar xzf elasticsearch-5.6.15.tar.gz</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/elasticsearch-5.6.15 /usr/<span class="built_in">local</span>/elasticsearch</span><br><span class="line">chown -R esuser:esuser /usr/<span class="built_in">local</span>/elasticsearch /usr/<span class="built_in">local</span>/elasticsearch-5.6.15</span><br></pre></td></tr></table></figure><h2 id="配置elasticsearch"><a href="#配置elasticsearch" class="headerlink" title="配置elasticsearch"></a>配置elasticsearch</h2><ul><li>修改<code>config/elasticsearch.yml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义节点名字</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">elasticsearch-1</span></span><br><span class="line"><span class="comment"># 定义数据目录</span></span><br><span class="line"><span class="string">path.data:</span> <span class="string">/home/esuser/data</span></span><br><span class="line"><span class="comment"># 定义日志目录</span></span><br><span class="line"><span class="string">path.logs:</span> <span class="string">/home/esuser/logs</span></span><br><span class="line"><span class="comment"># 定义节点为master</span></span><br><span class="line"><span class="string">node.master</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 定义节点为data</span></span><br><span class="line"><span class="string">node.data</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 启动时锁定内存，避免内存被系统swap</span></span><br><span class="line"><span class="comment"># 看情况开启，默认是关闭的</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment"># 定义监听端口</span></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment"># 定义服务端口</span></span><br><span class="line"><span class="string">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment"># 定义单播主机</span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">elasticsearch-1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">elasticsearch-2</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure><ul><li>修改<code>config/jvm.options</code></li></ul><blockquote><p>这里只需要修改<code>-Xms</code>和<code>-Xmx</code>，默认是2g，最大不超过32g，两个选项的值保持一致</p></blockquote><ul><li>设置elasticsearch系统变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /home/esuser/elasticsearch &lt;&lt;EOF</span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>添加PATH</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/profile.d/elasticsearch.sh &lt;&lt;EOF</span><br><span class="line"><span class="built_in">export</span> ES_HOME=<span class="string">"/usr/local/elasticsearch"</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$ES_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><ul><li>创建systemd服务脚本</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=ElasticSearch Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/home/esuser/elasticsearch</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/elasticsearch/bin/elasticsearch</span><br><span class="line">PIDFile=/usr/<span class="built_in">local</span>/elasticsearch/run/elasticsearch.pid</span><br><span class="line">User=esuser</span><br><span class="line">LimitNOFILE=262144</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure><h1 id="启动elasticsearch"><a href="#启动elasticsearch" class="headerlink" title="启动elasticsearch"></a>启动elasticsearch</h1><ul><li>通过systemd命令启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now elasticsearch</span><br></pre></td></tr></table></figure><ul><li>命令行启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c <span class="string">"/usr/local/elasticsearch/bin/elasticsearch -d"</span> esuser</span><br></pre></td></tr></table></figure><ul><li>访问elasticsearch</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9200/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"JN0WSrAZQo2qWCaZrbDGjg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"5.6.15"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"fe7575a"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2019-02-13T16:21:45.880Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"6.6.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="安装elasticsearch-head"><a href="#安装elasticsearch-head" class="headerlink" title="安装elasticsearch-head"></a>安装elasticsearch-head</h1><ul><li>直接用容器启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=host --restart=always -d --name elasticsearch-head mobz/elasticsearch-head:5-alpine</span><br></pre></td></tr></table></figure><ul><li>访问elasticsearch-head</li></ul><p><code>curl -I http://127.0.0.1:9100</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a&gt;系统环境&lt;/h1&gt;&lt;h2 id=&quot;CentOS-7&quot;&gt;&lt;a href=&quot;#CentOS-7&quot; class=&quot;headerlink&quot; title=&quot;C
      
    
    </summary>
    
    
      <category term="Elasticsearch" scheme="https://luanlengli.github.io/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>MySQL5.7学习笔记</title>
    <link href="https://luanlengli.github.io/2019/02/15/MySQL5-7%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://luanlengli.github.io/2019/02/15/MySQL5-7学习笔记.html</id>
    <published>2019-02-15T10:33:01.000Z</published>
    <updated>2019-03-29T05:10:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="本文基于MySQL-5-7记录"><a href="#本文基于MySQL-5-7记录" class="headerlink" title="本文基于MySQL 5.7记录"></a>本文基于MySQL 5.7记录</h1><h1 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h1><h2 id="1、二进制安装"><a href="#1、二进制安装" class="headerlink" title="1、二进制安装"></a>1、二进制安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建mysql相关的组和用户</span></span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载二进制包</span></span><br><span class="line">cd /usr/local/</span><br><span class="line">wget --no-check-certificate https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar xvzf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将目录移动到/usr/<span class="built_in">local</span>/mysql</span></span><br><span class="line">ln -s mysql-5.7.24-linux-glibc2.12-x86_64 /usr/local/mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据库数据目录</span></span><br><span class="line">mkdir -p /path/to/mysql_data_dir</span><br><span class="line">chown -R mysql:mysql /path/to/mysql_data_dir</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用叶金荣的配置生成工具创建my.cnf文件放在/etc/my.cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://imysql.com/my-cnf-wizard.html</span></span><br><span class="line">chmod a+r /etc/my.cnf</span><br><span class="line">chown mysql:mysql /etc/my.cnf</span><br><span class="line">/usr/local/mysql/bin/mysqld --defaults-file=/etc/my.cnf --initialize --user=mysql --basedir=/usr/local/mysql/ --datadir=/mysql_data</span><br><span class="line">/usr/local/mysql/bin/mysql_ssl_rsa_setup --datadir=/mysql_data</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看error.log文件里面的root密码</span></span><br><span class="line">grep password error.log | awk '&#123;print$NF&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动MySQL</span></span><br><span class="line">mysqld_safe --user=mysql &amp;</span><br></pre></td></tr></table></figure><h2 id="2、rpm-deb软件源安装"><a href="#2、rpm-deb软件源安装" class="headerlink" title="2、rpm/deb软件源安装"></a>2、rpm/deb软件源安装</h2><p>以CentOS7为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取MySQL软件源</span></span><br><span class="line">yum install -y https://dev.mysql.com/get/mysql57-community-release-el7-1.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新YUM缓存</span></span><br><span class="line">yum makecache</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装MySQL5.7</span></span><br><span class="line">yum install mysql-community-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动MySQL</span></span><br><span class="line">systemctl start mysqld.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取ROOT密码</span></span><br><span class="line">grep 'temporary password' /var/log/mysqld.log</span><br></pre></td></tr></table></figure><h2 id="3、源码安装"><a href="#3、源码安装" class="headerlink" title="3、源码安装"></a>3、源码安装</h2><p>以CentOS7为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装编译环境</span></span><br><span class="line">yum -y install make gcc-c++ cmake bison-devel ncurses-devel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载MySQL源代码</span></span><br><span class="line">wget --no-check-certificate https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.24.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建MySQL相关的组和用户</span></span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建MySQL相关文件夹</span></span><br><span class="line">mkdir -p /app/mysql</span><br><span class="line">mkdir -p /app/data</span><br><span class="line">mkdir -p /app/etc</span><br><span class="line">mkdir -p /app/log</span><br><span class="line">chown -R mysql:mysql /app</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压源代码</span></span><br><span class="line">tar xvzf mysql-boost-5.7.24.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建cmake编译目录</span></span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用CMake生成makefile</span></span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/app/mysql/ \</span><br><span class="line">-DMYSQL_USER=mysql \</span><br><span class="line">-DMYSQL_TCP_PORT=3306 \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/app/data/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DEXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_READLINE=1 \</span><br><span class="line">-DWITH_SYSTEMD=1 \</span><br><span class="line">-DWITH_BOOST=/root/mysql-5.7.24/boost/boost_1_59_0/ \</span><br><span class="line">/root/mysql-5.7.24/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译安装</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用叶金荣MySQL配置生成工具生成my.cnf放在/app/etc/my.cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://imysql.com/my-cnf-wizard.html</span></span><br><span class="line">chown mysql:mysql /app/etc/my.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化MySQL数据库</span></span><br><span class="line">mysqld --initialize --defaults-file=/app/etc/my.cnf --user=mysql --basedir=/app/mysql/ --datadir=/app/data/</span><br><span class="line">mysql_ssl_rsa_setup --datadir=/app/data/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动MySQL数据库</span></span><br><span class="line">mysqld_safe --defaults-file=/app/etc/my.cnf --user=mysql &amp; </span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取MySQL ROOT密码</span></span><br><span class="line">grep password error.log | awk '&#123;print$NF&#125;'</span><br></pre></td></tr></table></figure><h2 id="4、安装后设定"><a href="#4、安装后设定" class="headerlink" title="4、安装后设定"></a>4、安装后设定</h2><h3 id="4-1、安全设置"><a href="#4-1、安全设置" class="headerlink" title="4.1、安全设置"></a>4.1、安全设置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure><h3 id="4-2、建议设置"><a href="#4-2、建议设置" class="headerlink" title="4.2、建议设置"></a>4.2、建议设置</h3><p>关闭主机名反向解析，在配置文件的[mysqld]里面添加skip_name_resolve = 1</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">...</span><br><span class="line">skip_name_resolve = 1</span><br></pre></td></tr></table></figure><h2 id="5、数据库连接"><a href="#5、数据库连接" class="headerlink" title="5、数据库连接"></a>5、数据库连接</h2><h3 id="5-1、mysql命令行客户端"><a href="#5-1、mysql命令行客户端" class="headerlink" title="5.1、mysql命令行客户端"></a>5.1、mysql命令行客户端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -ppassword -h127.0.0.1 -P3306 -D db1</span><br></pre></td></tr></table></figure><h3 id="5-2、MySQL-Benchmark图形客户端"><a href="#5-2、MySQL-Benchmark图形客户端" class="headerlink" title="5.2、MySQL Benchmark图形客户端"></a>5.2、MySQL Benchmark图形客户端</h3><p><a href="https://dev.mysql.com/downloads/workbench/" target="_blank" rel="noopener">官方网站下载页面</a></p><h2 id="6、获取MySQL编译的参数"><a href="#6、获取MySQL编译的参数" class="headerlink" title="6、获取MySQL编译的参数"></a>6、获取MySQL编译的参数</h2><p>在MySQL目录的docs/INFO_BIN</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 例如安装目录为/usr/<span class="built_in">local</span>/mysql</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MySQL官方YUM源安装的路径为/usr/share/doc/packages/MySQL-server</span></span><br><span class="line">cat /usr/local/bin/mysql/docs/INFO_BIN</span><br><span class="line">===== Information about the build process: =====</span><br><span class="line">Build was run at 2018-10-04 08:26:03 on host 'vitro45'</span><br><span class="line"></span><br><span class="line">Build was done on  Linux-3.8.13-16.2.1.el6uek.x86_64 using x86_64</span><br><span class="line">Build was done using cmake 2.8.12 </span><br><span class="line"></span><br><span class="line">===== Compiler flags used (from the 'sql/' subdirectory): =====</span><br><span class="line"><span class="meta">#</span><span class="bash"> compile C with /usr/bin/cc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> compile CXX with /usr/bin/c++</span></span><br><span class="line">C_FLAGS =  -fPIC -Wall -Wextra -Wformat-security -Wvla -Wwrite-strings -Wdeclaration-after-statement -O3 -g -fabi-version=2 -fno-omit-frame-pointer -fno-strict-aliasing -DDBUG_OFF -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/rapidjson/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/export -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/zlib -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/release/zlib -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/conn_handler -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/auth -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/regex -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/taocrypt/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/lz4 -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include/boost_1_59_0/patches -isystem /usr/global/share/boost_1_59_0    -DHAVE_YASSL -DYASSL_PREFIX -DHAVE_OPENSSL -DMULTI_THREADED</span><br><span class="line">C_DEFINES = -DHAVE_CONFIG_H -DHAVE_LIBEVENT1 -DHAVE_REPLICATION -DMYSQL_SERVER -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE</span><br><span class="line">CXX_FLAGS =  -fPIC -Wall -Wextra -Wformat-security -Wvla -Woverloaded-virtual -Wno-unused-parameter -O3 -g -fabi-version=2 -fno-omit-frame-pointer -fno-strict-aliasing -DDBUG_OFF -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/rapidjson/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/export -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/zlib -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/release/zlib -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/conn_handler -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/auth -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/regex -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/taocrypt/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/lz4 -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include/boost_1_59_0/patches -isystem /usr/global/share/boost_1_59_0    -DHAVE_YASSL -DYASSL_PREFIX -DHAVE_OPENSSL -DMULTI_THREADED</span><br><span class="line">CXX_DEFINES = -DHAVE_CONFIG_H -DHAVE_LIBEVENT1 -DHAVE_REPLICATION -DMYSQL_SERVER -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE</span><br><span class="line"></span><br><span class="line">Pointer size: 8</span><br><span class="line"></span><br><span class="line">===== Feature flags used: =====</span><br><span class="line">-- Cache values</span><br><span class="line">BOOST_INCLUDE_DIR:PATH=/usr/global/share/boost_1_59_0</span><br><span class="line">BUILD_TESTING:BOOL=ON</span><br><span class="line">BUNDLE_MECAB:BOOL=ON</span><br><span class="line">CMAKE_BACKWARDS_COMPATIBILITY:STRING=2.4</span><br><span class="line">CMAKE_BUILD_TYPE:STRING=RelWithDebInfo</span><br><span class="line">CMAKE_INSTALL_PREFIX:PATH=/usr/local/mysql</span><br><span class="line">COMMUNITY_BUILD:BOOL=ON</span><br><span class="line">CTAGS_EXECUTABLE:FILEPATH=/usr/bin/ctags</span><br><span class="line">DEB_CHANGELOG_TIMESTAMP:STRING=Thu, 04 Oct 2018 08:14:16 +0200</span><br><span class="line">DEB_CODENAME:STRING=n/a</span><br><span class="line">DOWNLOAD_BOOST:BOOL=OFF</span><br><span class="line">DOWNLOAD_BOOST_TIMEOUT:STRING=600</span><br><span class="line">ENABLED_PROFILING:BOOL=ON</span><br><span class="line">ENABLE_DOWNLOADS:BOOL=OFF</span><br><span class="line">ENABLE_GCOV:BOOL=OFF</span><br><span class="line">ENABLE_GPROF:BOOL=OFF</span><br><span class="line">ENABLE_MEMCACHED_SASL:BOOL=OFF</span><br><span class="line">ENABLE_MEMCACHED_SASL_PWDB:BOOL=OFF</span><br><span class="line">EXECUTABLE_OUTPUT_PATH:PATH=</span><br><span class="line">FEATURE_SET:STRING=community</span><br><span class="line">INSTALL_LAYOUT:STRING=STANDALONE</span><br><span class="line">INSTALL_PKGCONFIGDIR:PATH=</span><br><span class="line">LIBRARY_OUTPUT_PATH:PATH=</span><br><span class="line">LOCAL_BOOST_DIR:FILEPATH=/usr/global/share/boost_1_59_0</span><br><span class="line">LOCAL_BOOST_ZIP:FILEPATH=/usr/global/share/boost_1_59_0.tar.gz</span><br><span class="line">LOCAL_GMOCK_ZIP:FILEPATH=/usr/global/share/googletest-release-1.8.0.zip</span><br><span class="line">MECAB_INCLUDE_DIR:PATH=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit/include</span><br><span class="line">MECAB_LIBRARY:FILEPATH=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit/lib/libmecab.a</span><br><span class="line">MERGE_UNITTESTS:BOOL=ON</span><br><span class="line">MUTEXTYPE:STRING=event</span><br><span class="line">MYSQL_DATADIR:PATH=/usr/local/mysql/data</span><br><span class="line">MYSQL_KEYRINGDIR:PATH=/usr/local/mysql/keyring</span><br><span class="line">MYSQL_MAINTAINER_MODE:BOOL=OFF</span><br><span class="line">OPTIMIZER_TRACE:BOOL=ON</span><br><span class="line">REPRODUCIBLE_BUILD:BOOL=OFF</span><br><span class="line">RPC_INCLUDE_DIR:PATH=/usr/include</span><br><span class="line">SASL_SYSTEM_LIBRARY:FILEPATH=/usr/lib64/libsasl2.so</span><br><span class="line">TMPDIR:PATH=P_tmpdir</span><br><span class="line">WITH_ARCHIVE_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_ASAN:BOOL=OFF</span><br><span class="line">WITH_ASAN_SCOPE:BOOL=OFF</span><br><span class="line">WITH_BLACKHOLE_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_BOOST:PATH=/usr/global/share</span><br><span class="line">WITH_CLIENT_PROTOCOL_TRACING:BOOL=ON</span><br><span class="line">WITH_DEBUG:BOOL=OFF</span><br><span class="line">WITH_DEFAULT_COMPILER_OPTIONS:BOOL=ON</span><br><span class="line">WITH_DEFAULT_FEATURE_SET:BOOL=ON</span><br><span class="line">WITH_EDITLINE:STRING=bundled</span><br><span class="line">WITH_EMBEDDED_SERVER:BOOL=ON</span><br><span class="line">WITH_EMBEDDED_SHARED_LIBRARY:BOOL=OFF</span><br><span class="line">WITH_EXTRA_CHARSETS:STRING=all</span><br><span class="line">WITH_FEDERATED_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_INNODB_EXTRA_DEBUG:BOOL=OFF</span><br><span class="line">WITH_INNODB_MEMCACHED:BOOL=1</span><br><span class="line">WITH_LIBEVENT:STRING=bundled</span><br><span class="line">WITH_LIBWRAP:BOOL=OFF</span><br><span class="line">WITH_LZ4:STRING=bundled</span><br><span class="line">WITH_MECAB:STRING=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit</span><br><span class="line">WITH_MECAB_PATH:PATH=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit</span><br><span class="line">WITH_MSAN:BOOL=OFF</span><br><span class="line">WITH_NGRAM_PARSER:BOOL=ON</span><br><span class="line">WITH_NUMA:BOOL=ON</span><br><span class="line">WITH_PARTITION_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_PIC:BOOL=ON</span><br><span class="line">WITH_RAPID:BOOL=ON</span><br><span class="line">WITH_SASL:STRING=system</span><br><span class="line">WITH_SSL:STRING=bundled</span><br><span class="line">WITH_SYSTEMD:BOOL=OFF</span><br><span class="line">WITH_TEST_TRACE_PLUGIN:BOOL=OFF</span><br><span class="line">WITH_UBSAN:BOOL=OFF</span><br><span class="line">WITH_UNIT_TESTS:BOOL=ON</span><br><span class="line">WITH_VALGRIND:BOOL=OFF</span><br><span class="line">WITH_ZLIB:STRING=bundled</span><br><span class="line">XPLUGIN_LOG_PROTOBUF:STRING=1</span><br><span class="line"></span><br><span class="line">===== EOF =====</span><br></pre></td></tr></table></figure><h1 id="二、配置数据库"><a href="#二、配置数据库" class="headerlink" title="二、配置数据库"></a>二、配置数据库</h1><h2 id="1、配置文件路径"><a href="#1、配置文件路径" class="headerlink" title="1、配置文件路径"></a>1、配置文件路径</h2><p>文件优先级，同一个参数以最后一个为准，启动时可指定–default-file=/path/to/my.cnf</p><ul><li>/etc/my.cnf</li><li>/etc/mysql/my.cnf</li><li>$MYSQL_HOME/my.cnf</li><li>–default-extra-file=/path/to/*.cnf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port    = 3306</span><br><span class="line">socket    = /data/mysql/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=&quot;\u@mysqldb \R:\m:\s [\d]&gt; &quot;</span><br><span class="line">no-auto-rehash</span><br><span class="line">[mysqld]</span><br><span class="line">user    = mysql</span><br><span class="line">port    = 3306</span><br><span class="line">basedir    = /usr/local/mysql</span><br><span class="line">datadir    = /data/mysql/</span><br><span class="line">socket    = /data/mysql/mysql.sock</span><br><span class="line">pid-file = mysqldb.pid</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">open_files_limit    = 65535</span><br><span class="line">back_log = 1024</span><br><span class="line">max_connections = 512</span><br><span class="line">max_connect_errors = 1000000</span><br><span class="line">table_open_cache = 1024</span><br><span class="line">table_definition_cache = 1024</span><br><span class="line">table_open_cache_instances = 64</span><br><span class="line">thread_stack = 512K</span><br><span class="line">external-locking = FALSE</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">sort_buffer_size = 16M</span><br><span class="line">join_buffer_size = 16M</span><br><span class="line">thread_cache_size = 768</span><br><span class="line">interactive_timeout = 600</span><br><span class="line">wait_timeout = 600</span><br><span class="line">tmp_table_size = 96M</span><br><span class="line">max_heap_table_size = 96M</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /data/mysql/slow.log</span><br><span class="line">log-error = /data/mysql/error.log</span><br><span class="line">long_query_time = 0.1</span><br><span class="line">log_queries_not_using_indexes =1</span><br><span class="line">log_throttle_queries_not_using_indexes = 60</span><br><span class="line">min_examined_row_limit = 100</span><br><span class="line">log_slow_admin_statements = 1</span><br><span class="line">log_slow_slave_statements = 1</span><br><span class="line">server-id = 3306</span><br><span class="line">log-bin = /data/mysql/mybinlog</span><br><span class="line">sync_binlog = 1</span><br><span class="line">binlog_cache_size = 4M</span><br><span class="line">max_binlog_cache_size = 2G</span><br><span class="line">max_binlog_size = 1G</span><br><span class="line">expire_logs_days = 7</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line">slave-rows-search-algorithms = &apos;INDEX_SCAN,HASH_SCAN&apos;</span><br><span class="line">binlog_format = row</span><br><span class="line">binlog_checksum = 1</span><br><span class="line">relay_log_recovery = 1</span><br><span class="line">relay-log-purge = 1</span><br><span class="line">key_buffer_size = 32M</span><br><span class="line">read_buffer_size = 8M</span><br><span class="line">read_rnd_buffer_size = 16M</span><br><span class="line">bulk_insert_buffer_size = 64M</span><br><span class="line">myisam_sort_buffer_size = 128M</span><br><span class="line">myisam_max_sort_file_size = 10G</span><br><span class="line">myisam_repair_threads = 1</span><br><span class="line">lock_wait_timeout = 3600</span><br><span class="line">explicit_defaults_for_timestamp = 1</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_sync_spin_loops = 100</span><br><span class="line">innodb_spin_wait_delay = 30</span><br><span class="line">transaction_isolation = REPEATABLE-READ</span><br><span class="line">#innodb_additional_mem_pool_size = 16M</span><br><span class="line">innodb_buffer_pool_size = 45875M</span><br><span class="line">innodb_buffer_pool_instances = 4</span><br><span class="line">innodb_buffer_pool_load_at_startup = 1</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown = 1</span><br><span class="line">innodb_data_file_path = ibdata1:1G:autoextend</span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">innodb_log_buffer_size = 32M</span><br><span class="line">innodb_log_file_size = 2G</span><br><span class="line">innodb_log_files_in_group = 2</span><br><span class="line">innodb_max_undo_log_size = 2G</span><br><span class="line">innodb_undo_directory = undolog</span><br><span class="line">innodb_undo_tablespaces = 8</span><br><span class="line"># 根据您的服务器IOPS能力适当调整</span><br><span class="line"># 一般配普通SSD盘的话，可以调整到 10000 - 20000</span><br><span class="line"># 配置高端PCIe SSD卡的话，则可以调整的更高，比如 50000 - 80000</span><br><span class="line">innodb_io_capacity = 4000</span><br><span class="line">innodb_io_capacity_max = 8000</span><br><span class="line">innodb_flush_neighbors = 0</span><br><span class="line">innodb_write_io_threads = 8</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_purge_threads = 4</span><br><span class="line">innodb_page_cleaners = 4</span><br><span class="line">innodb_open_files = 65535</span><br><span class="line">innodb_max_dirty_pages_pct = 50</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_lru_scan_depth = 4000</span><br><span class="line">innodb_checksum_algorithm = crc32</span><br><span class="line">innodb_lock_wait_timeout = 10</span><br><span class="line">innodb_rollback_on_timeout = 1</span><br><span class="line">innodb_print_all_deadlocks = 1</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_online_alter_log_max_size = 2G</span><br><span class="line">internal_tmp_disk_storage_engine = InnoDB</span><br><span class="line">innodb_stats_on_metadata = 0</span><br><span class="line"># some var for MySQL 8</span><br><span class="line">log_error_verbosity = 3</span><br><span class="line">innodb_print_ddl_logs = 1</span><br><span class="line">binlog_expire_logs_seconds = 604800</span><br><span class="line">#innodb_dedicated_server = 0</span><br><span class="line">innodb_status_file = 1</span><br><span class="line"># 注意: 开启 innodb_status_output &amp; innodb_status_output_locks 后, 可能会导致log-error文件增长较快</span><br><span class="line">innodb_status_output = 0</span><br><span class="line">innodb_status_output_locks = 0</span><br><span class="line">#performance_schema</span><br><span class="line">performance_schema = 1</span><br><span class="line">performance_schema_instrument = &apos;%=on&apos;</span><br><span class="line">#innodb monitor</span><br><span class="line">innodb_monitor_enable=&quot;module_innodb&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_server&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_dml&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_ddl&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_trx&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_os&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_purge&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_log&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_lock&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_buffer&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_index&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_ibuf_system&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_buffer_page&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_adaptive_hash&quot;</span><br><span class="line">[mysqld_safe]</span><br><span class="line">[mysqld_multi]</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">[server]</span><br></pre></td></tr></table></figure></li></ul><h2 id="2、数据库变量"><a href="#2、数据库变量" class="headerlink" title="2、数据库变量"></a>2、数据库变量</h2><h3 id="2-1、查看数据库全局变量"><a href="#2-1、查看数据库全局变量" class="headerlink" title="2.1、查看数据库全局变量"></a>2.1、查看数据库全局变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables;</span><br></pre></td></tr></table></figure><h3 id="2-2、查看数据库会话变量"><a href="#2-2、查看数据库会话变量" class="headerlink" title="2.2、查看数据库会话变量"></a>2.2、查看数据库会话变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show session variables;</span><br></pre></td></tr></table></figure><h3 id="3、开启MySQL-SSL功能"><a href="#3、开启MySQL-SSL功能" class="headerlink" title="3、开启MySQL SSL功能"></a>3、开启MySQL SSL功能</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用MySQL自带工具生成证书</span></span><br><span class="line">mysql_ssl_rsa_setup --datadir=MYSQL_DATA_DIR</span><br><span class="line"><span class="meta">#</span><span class="bash"> 证书默认存放data-dir</span></span><br><span class="line">ll /mysql_data/*pem</span><br><span class="line">-rw------- 1 root root 1675 Oct 30 13:43 /mysql_data/ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1107 Oct 30 13:43 /mysql_data/ca.pem</span><br><span class="line">-rw-r--r-- 1 root root 1107 Oct 30 13:43 /mysql_data/client-cert.pem</span><br><span class="line">-rw------- 1 root root 1679 Oct 30 13:43 /mysql_data/client-key.pem</span><br><span class="line">-rw------- 1 root root 1675 Oct 30 13:43 /mysql_data/private_key.pem</span><br><span class="line">-rw-r--r-- 1 root root  451 Oct 30 13:43 /mysql_data/public_key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1107 Oct 30 13:43 /mysql_data/server-cert.pem</span><br><span class="line">-rw------- 1 root root 1675 Oct 30 13:43 /mysql_data/server-key.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件指明SSL证书路径</span></span><br><span class="line">[mysqld]</span><br><span class="line">ssl-ca=/mysql_data/ca.pem</span><br><span class="line">ssl-cert=/mysql_data/server-cert.pem</span><br><span class="line">ssl-key=/mysql_data/server-key.pem</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 查看数据库SSL变量</span><br><span class="line">mysql&gt; show global variables like &apos;%ssl%&apos;;</span><br><span class="line">+---------------+-----------------------------+</span><br><span class="line">| Variable_name | Value                       |</span><br><span class="line">+---------------+-----------------------------+</span><br><span class="line">| have_openssl  | DISABLED                    |</span><br><span class="line">| have_ssl      | DISABLED                    |</span><br><span class="line">| ssl_ca        | /mysql_data/ca.pem          |</span><br><span class="line">| ssl_capath    |                             |</span><br><span class="line">| ssl_cert      | /mysql_data/server-cert.pem |</span><br><span class="line">| ssl_cipher    |                             |</span><br><span class="line">| ssl_crl       |                             |</span><br><span class="line">| ssl_crlpath   |                             |</span><br><span class="line">| ssl_key       | /mysql_data/server-key.pem  |</span><br><span class="line">+---------------+-----------------------------+</span><br><span class="line"># 强制用户使用SSL登录</span><br><span class="line">mysql&gt; alter user &apos;username&apos;@&apos;host&apos; require ssl;</span><br><span class="line"># 创建用户时要求使用SSL登录</span><br><span class="line">mysql&gt; grant all privileges on dbname.tablename to &apos;username&apos;@&apos;host&apos; identified by &apos;password&apos; require ssl;</span><br><span class="line"># 取消强制用户使用SSL登录</span><br><span class="line">mysql&gt; alter user &apos;username&apos;@&apos;host&apos; require none;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用SSL证书登录数据库</span></span><br><span class="line">mysql -uUSERNAME -pPASSWORD -hHOSTNAME \</span><br><span class="line">--ssl-ca=ca.pem \</span><br><span class="line">--ssl-cert=client-cert.pem \</span><br><span class="line">--ssl-key=client-key.pem</span><br></pre></td></tr></table></figure><h1 id="三、事务隔离"><a href="#三、事务隔离" class="headerlink" title="三、事务隔离"></a>三、事务隔离</h1><p>一组原子性SQL操作，或者是独立的工作单元。</p><h2 id="1、ACID"><a href="#1、ACID" class="headerlink" title="1、ACID"></a>1、ACID</h2><h3 id="1-1、Atomicity原子性"><a href="#1-1、Atomicity原子性" class="headerlink" title="1.1、Atomicity原子性"></a>1.1、Atomicity原子性</h3><p>整个事务中的所有操作要么全部执行成功，要么失败后完全回滚。</p><h3 id="1-2、Consistency一致性"><a href="#1-2、Consistency一致性" class="headerlink" title="1.2、Consistency一致性"></a>1.2、Consistency一致性</h3><p>数据库总是从一个一致性状态转换到另一个一致性状态。</p><h3 id="1-3、Isolation隔离性"><a href="#1-3、Isolation隔离性" class="headerlink" title="1.3、Isolation隔离性"></a>1.3、Isolation隔离性</h3><p>一个事务的操作在提交之前，不能被其他会话所见。</p><p>可分为多个隔离级别</p><h3 id="1-4、Durability永久性"><a href="#1-4、Durability永久性" class="headerlink" title="1.4、Durability永久性"></a>1.4、Durability永久性</h3><p>事务一旦提交，操作结果将永久保存到数据库中。</p><h2 id="2、锁机制"><a href="#2、锁机制" class="headerlink" title="2、锁机制"></a>2、锁机制</h2><h3 id="2-1、写锁"><a href="#2-1、写锁" class="headerlink" title="2.1、写锁"></a>2.1、写锁</h3><p>其他事务不能读取，也不能写。</p><h3 id="2-2、读锁"><a href="#2-2、读锁" class="headerlink" title="2.2、读锁"></a>2.2、读锁</h3><p>其他事务可以读，但不能写。</p><h2 id="3、脏读"><a href="#3、脏读" class="headerlink" title="3、脏读"></a>3、脏读</h2><p>脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。</p><h2 id="4、不可重复读"><a href="#4、不可重复读" class="headerlink" title="4、不可重复读"></a>4、不可重复读</h2><p>是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。</p><h2 id="5、幻读"><a href="#5、幻读" class="headerlink" title="5、幻读"></a>5、幻读</h2><p>指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。</p><h2 id="6、事务隔离级别"><a href="#6、事务隔离级别" class="headerlink" title="6、事务隔离级别"></a>6、事务隔离级别</h2><p>默认是REPEATEABLE READ 可重复读</p><h3 id="6-1、READ-UNCOMMITED读未提交"><a href="#6-1、READ-UNCOMMITED读未提交" class="headerlink" title="6.1、READ UNCOMMITED读未提交"></a>6.1、READ UNCOMMITED读未提交</h3><p>事务间完全不隔离，会产生脏读，可以读取未提交的记录。</p><h3 id="6-2、READ-COMMITED读已提交"><a href="#6-2、READ-COMMITED读已提交" class="headerlink" title="6.2、READ COMMITED读已提交"></a>6.2、READ COMMITED读已提交</h3><p>仅能读取到已提交的记录，不会脏读，会不可重复读，会幻读。</p><h3 id="6-3、REPEATABLE-READ可重复读"><a href="#6-3、REPEATABLE-READ可重复读" class="headerlink" title="6.3、REPEATABLE READ可重复读"></a>6.3、REPEATABLE READ可重复读</h3><p>每次读取的结果集都相同，而不管其他事务有没有提交，但是无法阻止其他事务插入数据，因此可能导致幻读。</p><h3 id="6-4、SERIALIZABILE可串行化"><a href="#6-4、SERIALIZABILE可串行化" class="headerlink" title="6.4、SERIALIZABILE可串行化"></a>6.4、SERIALIZABILE可串行化</h3><p>最严格的锁，在事务完成前，其他事务无法对数据对象进行写操作。并行性能最差。</p><h1 id="四、数据库日志"><a href="#四、数据库日志" class="headerlink" title="四、数据库日志"></a>四、数据库日志</h1><h2 id="1、查询日志-query-log"><a href="#1、查询日志-query-log" class="headerlink" title="1、查询日志 query log"></a>1、查询日志 query log</h2><p>记录查询操作，产生额外IO消耗，一般不打开。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%general%&apos;;</span><br><span class="line">+------------------+---------------------------+</span><br><span class="line">| Variable_name    | Value                     |</span><br><span class="line">+------------------+---------------------------+</span><br><span class="line">| general_log      | OFF                       |</span><br><span class="line">| general_log_file | /var/log/hostname.log     |</span><br><span class="line">+------------------+---------------------------+</span><br><span class="line">mysql&gt; show global variables like &apos;log_output&apos;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_output    | FILE  |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure><h2 id="2、慢查询日志-slow-query-log"><a href="#2、慢查询日志-slow-query-log" class="headerlink" title="2、慢查询日志 slow query log"></a>2、慢查询日志 slow query log</h2><p>执行时长超过指定时长的查询操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;long_query_time&apos;;</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| Variable_name   | Value    |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| long_query_time | 0.100000 |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">&gt; show global variables like &apos;%slow%&apos;;</span><br><span class="line">+---------------------------+-------------------------+</span><br><span class="line">| Variable_name             | Value                   |</span><br><span class="line">+---------------------------+-------------------------+</span><br><span class="line">| log_slow_admin_statements | ON                      |</span><br><span class="line">| log_slow_slave_statements | ON                      |</span><br><span class="line">| slow_launch_time          | 2                       |</span><br><span class="line">| slow_query_log            | ON                      |</span><br><span class="line">| slow_query_log_file       | /var/log/mysql/slow.log |</span><br><span class="line">+---------------------------+-------------------------+</span><br></pre></td></tr></table></figure><h2 id="3、错误日志-error-log"><a href="#3、错误日志-error-log" class="headerlink" title="3、错误日志 error log"></a>3、错误日志 error log</h2><p>记录MySQL启动关闭过程输出的日志</p><p>记录MySQL运行过程中产生的错误日志</p><p>记录event scheduler运行event时产生的日志</p><p>记录主从复制架构中从服务器上启动从服务器线程时产生的日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; show global variables like &apos;%error%&apos;;</span><br><span class="line">+---------------------+--------------------------+</span><br><span class="line">| Variable_name       | Value                    |</span><br><span class="line">+---------------------+--------------------------+</span><br><span class="line">| binlog_error_action | ABORT_SERVER             |</span><br><span class="line">| log_error           | /var/log/mysql/error.log |</span><br><span class="line">| log_error_verbosity | 3                        |</span><br><span class="line">| max_connect_errors  | 1000000                  |</span><br><span class="line">| max_error_count     | 64                       |</span><br><span class="line">| slave_skip_errors   | OFF                      |</span><br><span class="line">+---------------------+--------------------------+</span><br></pre></td></tr></table></figure><h2 id="4、二进制日志-binary-log"><a href="#4、二进制日志-binary-log" class="headerlink" title="4、二进制日志 binary log"></a>4、二进制日志 binary log</h2><h3 id="4-1、介绍"><a href="#4-1、介绍" class="headerlink" title="4.1、介绍"></a>4.1、介绍</h3><p>记录对mysql数据更新或潜在发生更新的SQL语句，并以”事务”的形式保存在磁盘中。</p><p>用于通过“重放”日志生成数据副本。</p><h3 id="4-2、日志记录内容"><a href="#4-2、日志记录内容" class="headerlink" title="4.2、日志记录内容"></a>4.2、日志记录内容</h3><p>基于“语句”记录：statement</p><p>基于“行”记录：row</p><p>混合模式：mixed，由数据库自动判定</p><h3 id="4-3、日志文件构成"><a href="#4-3、日志文件构成" class="headerlink" title="4.3、日志文件构成"></a>4.3、日志文件构成</h3><p>日志文件：mysql-bin，二进制格式</p><p>索引文件：mysql-bin.index，文本格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show global variables like &apos;%bin%&apos;;</span><br><span class="line">+--------------------------------------------+----------------------------+</span><br><span class="line">| Variable_name                              | Value                      |</span><br><span class="line">+--------------------------------------------+----------------------------+</span><br><span class="line">| binlog_cache_size                          | 4194304                    |</span><br><span class="line">| binlog_checksum                            | CRC32                      |</span><br><span class="line">| binlog_direct_non_transactional_updates    | OFF                        |</span><br><span class="line">| binlog_error_action                        | ABORT_SERVER               |</span><br><span class="line">| binlog_format                              | ROW                        |</span><br><span class="line">| binlog_group_commit_sync_delay             | 0                          |</span><br><span class="line">| binlog_group_commit_sync_no_delay_count    | 0                          |</span><br><span class="line">| binlog_gtid_simple_recovery                | ON                         |</span><br><span class="line">| binlog_max_flush_queue_time                | 0                          |</span><br><span class="line">| binlog_order_commits                       | ON                         |</span><br><span class="line">| binlog_row_image                           | FULL                       |</span><br><span class="line">| binlog_rows_query_log_events               | OFF                        |</span><br><span class="line">| binlog_stmt_cache_size                     | 32768                      |</span><br><span class="line">| binlog_transaction_dependency_history_size | 25000                      |</span><br><span class="line">| binlog_transaction_dependency_tracking     | COMMIT_ORDER               |</span><br><span class="line">| innodb_api_enable_binlog                   | OFF                        |</span><br><span class="line">| innodb_locks_unsafe_for_binlog             | OFF                        |</span><br><span class="line">| log_bin                                    | ON                         |</span><br><span class="line">| log_bin_basename                           | /mysql_data/mybinlog       |</span><br><span class="line">| log_bin_index                              | /mysql_data/mybinlog.index |</span><br><span class="line">| log_bin_trust_function_creators            | OFF                        |</span><br><span class="line">| log_bin_use_v1_row_events                  | OFF                        |</span><br><span class="line">| log_statements_unsafe_for_binlog           | ON                         |</span><br><span class="line">| max_binlog_cache_size                      | 2147483648                 |</span><br><span class="line">| max_binlog_size                            | 1073741824                 |</span><br><span class="line">| max_binlog_stmt_cache_size                 | 18446744073709547520       |</span><br><span class="line">| sync_binlog                                | 1                          |</span><br><span class="line">+--------------------------------------------+----------------------------+</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show binary logs;</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| mybinlog.000001 |       177 |</span><br><span class="line">| mybinlog.000002 |     11841 |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">mysql &gt; show master status;</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File            | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                         |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mybinlog.000002 |    11841 |              |                  | 2c719e09-d6a4-11e8-b4f9-560000590d55:1-31 |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">mysql &gt; show binlog events in &apos;mybinlog.000002&apos; from 4 limit 1;</span><br><span class="line">+-----------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+-----------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mybinlog.000002 |   4 | Format_desc |      3306 |         123 | Server ver: 5.7.24-log, Binlog ver: 4 |</span><br><span class="line">+-----------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="4-4、mysqlbinlog工具读取二进制日志"><a href="#4-4、mysqlbinlog工具读取二进制日志" class="headerlink" title="4.4、mysqlbinlog工具读取二进制日志"></a>4.4、mysqlbinlog工具读取二进制日志</h3><p>基于时间点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -uroot -pxvnCv3Yz -hlocalhost -P3306 --start-datetime='2018-10-23 00:00:00' --stop-datetime='2018-10-24 13:00:00' -d myblog /mysql_data/mybinlog.000002</span><br></pre></td></tr></table></figure><p>基于position</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -uroot -pxvnCv3Yz -hlocalhost -P3306 --start-position=10613 --stop-position=11684 -d myblog /mysql_data/mybinlog.000002</span><br></pre></td></tr></table></figure><h3 id="4-5、二进制日志事件的格式"><a href="#4-5、二进制日志事件的格式" class="headerlink" title="4.5、二进制日志事件的格式"></a>4.5、二进制日志事件的格式</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># at 11305</span></span><br><span class="line"><span class="comment">#181024 11:38:30 server id 3306  end_log_pos 11684 CRC32 0xf0b28827     Query    thread_id=32    exec</span></span><br><span class="line">_time=0    error_code=0</span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">TIMESTAMP</span>=<span class="number">1540352310</span><span class="comment">/*!*/</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote_record_memory`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`vote_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`group_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`index_user_id`</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4</span><br><span class="line"><span class="comment">/*!*/</span>;</span><br></pre></td></tr></table></figure><p>事件发生的日期和时间： 181024 11:38:30</p><p>事件发生的服务器标识： server id 3306</p><p>事件结束位置： end_log_pos 11684</p><p>事件类型： Query</p><p>事件发生时所在服务器执行此事件的线程ID： thread_id=32</p><p>语句的时间戳与写入二进制文件的时间差： exec_time=0</p><p>错误代码： error_code=0</p><p>事件内容</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="built_in">TIMESTAMP</span>=<span class="number">1540352310</span><span class="comment">/*!*/</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote_record_memory`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`vote_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`group_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`index_user_id`</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4</span><br><span class="line"><span class="comment">/*!*/</span>;</span><br></pre></td></tr></table></figure><p>GTID：Global Transaction ID；全局事务ID</p><h2 id="5、中继日志-relay-log"><a href="#5、中继日志-relay-log" class="headerlink" title="5、中继日志 relay log"></a>5、中继日志 relay log</h2><p>主从复制架构中，从服务器将主服务器的二进制日志事件拷贝到自己的中继日志。</p><h2 id="6、事务日志-transaction-log"><a href="#6、事务日志-transaction-log" class="headerlink" title="6、事务日志 transaction log"></a>6、事务日志 transaction log</h2><p>由数据库引擎自行管理。</p><p>当有更新操作时，存储引擎只将数据在内存中的copy修改成更新后的值，但并不将数据的更新刷新的硬盘，只是将更新操作的行为记录到硬盘上的事务日志中。因为事务日志的记录是采用文件追加的方式，因此写日志的操作是磁盘上一小块区域内的顺序I/O，而不像随机I/O需要在磁盘的多个地方移动磁头。</p><p>因此事务日志的记录是非常快的。</p><p>事务日志由多个日志文件组组成，循环使用日志文件。</p><p>事务日志的大小需要根据实际情况设定。</p><h3 id="6-1、重做日志redo-log"><a href="#6-1、重做日志redo-log" class="headerlink" title="6.1、重做日志redo log"></a>6.1、重做日志redo log</h3><p>用于记录修改后的数据，顺序记录，可以根据这个文件的记录内容重新恢复数据。</p><h3 id="6-2、回滚日志undo-log"><a href="#6-2、回滚日志undo-log" class="headerlink" title="6.2、回滚日志undo log"></a>6.2、回滚日志undo log</h3><p>用于存放被修改前的数据，回滚操作，实现事务一致性。</p><h1 id="五、备份还原"><a href="#五、备份还原" class="headerlink" title="五、备份还原"></a>五、备份还原</h1><h2 id="1、为什么要备份"><a href="#1、为什么要备份" class="headerlink" title="1、为什么要备份"></a>1、为什么要备份</h2><ul><li>灾难备份</li><li>硬件故障</li><li>软件故障</li><li>自然灾害</li><li>黑客攻击</li><li>人为操作</li><li>业务测试</li></ul><h2 id="2、注意事项"><a href="#2、注意事项" class="headerlink" title="2、注意事项"></a>2、注意事项</h2><ul><li>能容忍丢失多少数据</li><li>备份操作持锁时长</li><li>备份负载</li><li>恢复数据的时长</li><li>需要恢复哪些数据</li><li>备份的有效性</li><li>备份恢复测试和演练</li><li>生产数据和备份数据分开存放</li></ul><h2 id="3、备份类型"><a href="#3、备份类型" class="headerlink" title="3、备份类型"></a>3、备份类型</h2><ul><li>热备：备份过程数据库可读可写</li><li>温备：备份过程数据库可读不可写</li><li>冷备：备份过程数据库不可读不可写</li><li>全量备份：完整数据集</li><li>增量备份：仅备份最近一次全备或者增备以来变化的数据</li><li>差异备份：仅备份最近一次全备以来变化的数据</li><li>物理备份：块级别备份，备份数据文件</li><li>逻辑备份：从数据库导出数据，与存储引擎无关，可用于数据迁移<h2 id="4、备份内容"><a href="#4、备份内容" class="headerlink" title="4、备份内容"></a>4、备份内容</h2></li><li>数据</li><li>二进制日志、InnoDB事务日志</li><li>配置文件</li><li>代码（存储过程、存储函数、触发器、事件调度器）<h2 id="5、逻辑备份工具"><a href="#5、逻辑备份工具" class="headerlink" title="5、逻辑备份工具"></a>5、逻辑备份工具</h2>Schema和数据存储在一个巨大的单个SQL语句文件<h3 id="5-1、mysqldump"><a href="#5-1、mysqldump" class="headerlink" title="5.1、mysqldump"></a>5.1、mysqldump</h3></li></ul><p><strong>MyISAM</strong>：备份库添加只读锁，直至备份完成</p><blockquote><p>默认导出所有数据库的所有表<br>锁定方法（对InnoDB有效实现温备）：<br>–lock-all-tables 锁定所有库的所有表<br>–log-tables 对于每个单独的数据库，在启动备份前锁定其所有表<br><strong>InnoDB</strong>：支持热备、温备<br>–single-transaction 设置本次会话隔离级别为Repeatable Read，确保本次会话不会看到其他会话提交的数据，保证数据一致性</p></blockquote><p>命令说明<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 备份指定数据库或者数据库中的表</span></span><br><span class="line">mysqldump [options] db_name [table_name]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份多个数据库</span></span><br><span class="line">mysqldump [options] --database db1 [db2, db3]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份所有数据库</span></span><br><span class="line">mysqldump [options] --all-databases</span><br></pre></td></tr></table></figure><p></p><p>命令示例<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 备份数据库db1，导出为db1.sql</span></span><br><span class="line">mysqldump -uroot -ppassword -h127.0.0.1 -P3306 db1 &gt; db1.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份数据库db1的table1表，导出为table1.sql</span></span><br><span class="line">mysqldump -uroot -ppassword -h127.0.0.1 -P3306 db1 table1 &gt; table1.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份数据库db1的table1和table2表，导出为table1_table2.sql</span></span><br><span class="line">mysqldump -uroot -ppassword -h127.0.0.1 -P3306 db1 table1 table2 &gt; table1_table2.sql</span><br></pre></td></tr></table></figure><p></p><h2 id="6、物理备份"><a href="#6、物理备份" class="headerlink" title="6、物理备份"></a>6、物理备份</h2><h3 id="6-1、xtrabackup"><a href="#6-1、xtrabackup" class="headerlink" title="6.1、xtrabackup"></a>6.1、xtrabackup</h3><p>适用于InnoDB和XtraDB，一般使用innobackupex（xtrabackup的命令简化版）</p><p><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="noopener">官方网站下载地址</a></p><p>安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载xtrabackup二进制包</span></span><br><span class="line">wget --no-check-certificate https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/tarball/percona-xtrabackup-2.4.12-Linux-x86_64.libgcrypt11.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压二进制包</span></span><br><span class="line">tar xvzf percona-xtrabackup-2.4.12-Linux-x86_64.libgcrypt11.tar.gz.tar.gz</span><br><span class="line">mv percona-xtrabackup-2.4.12-Linux-x86_64 /usr/local/</span><br><span class="line">ln -sv /usr/local/percona-xtrabackup-2.4.12-Linux-x86_64 /usr/local/xtrabackup</span><br></pre></td></tr></table></figure><p>命令说明</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 全量备份整个数据库（包括配置文件、二进制日志、重做日志、回滚日志、数据文件）</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --user=root --password=password --port=3306 BACKUP_DIR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 增量备份整个数据库</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --user=root --password=password --host=localhost --port=3306  --incremental --incremental-basedir=/backup_dir/YYYY-MM-DD_HH-mm-ss/ /mysql_backup/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将增量备份的redo <span class="built_in">log</span>合并到全量备份</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --apply-log --redo-only FULL_BACKUP_DIR</span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --apply-log --redo-only FULL_BACKUP_DIR --incremental-dir=/INCREMENTAL_BACKUP_DIR/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复全量备份</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --copy-back FULL_BACKUP_DIR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从全量备份中“导出”表</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要在配置中启用innodb_file_per_table=1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此命令会为每一个InnoDB表创建一个.exp结尾的文件仅包含数据，不包含表结构</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --apply-log --export FULL_BACKUP_DIR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从全量备份中“导入”表</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create table table_name (...) engine=InnoDB;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> alter table db_name.table_name discard tablespaces;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将“导出”表的table_name.ibd和table_name文件拷贝到服务器数据目录，使用以下命令“导入”</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> alter table db_name.table_name import tablespaces;</span></span><br></pre></td></tr></table></figure><h3 id="6-2、其他备份工具"><a href="#6-2、其他备份工具" class="headerlink" title="6.2、其他备份工具"></a>6.2、其他备份工具</h3><ul><li><p>LVM快照</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 锁定所有表</span><br><span class="line">mysql &gt; flush tables with read lock;</span><br><span class="line"># 记录二进制日志文件和事件位置</span><br><span class="line">mysql &gt; flush logs;</span><br><span class="line">mysql -e &apos;show master status&apos; &gt; /path/to/file</span><br><span class="line"># 创建快照</span><br><span class="line">lvcreate -L # -s -p r -n NAME /dev/vg_name/lv_name</span><br><span class="line"># 释放锁</span><br><span class="line">mysql &gt; unlock tables;</span><br><span class="line"># 挂载快照卷，执行数据备份</span><br><span class="line"># 备份完成删除快照卷</span><br></pre></td></tr></table></figure></li></ul><h1 id="六、主从复制"><a href="#六、主从复制" class="headerlink" title="六、主从复制"></a>六、主从复制</h1><h2 id="1、主节点"><a href="#1、主节点" class="headerlink" title="1、主节点"></a>1、主节点</h2><blockquote><p>dump thread：为每个Slave的IO Thread 启动一个dump线程，向其发送binary log events</p></blockquote><h2 id="2、从节点"><a href="#2、从节点" class="headerlink" title="2、从节点"></a>2、从节点</h2><blockquote><p>IO Thread：从Master请求binary log events，并保存到中继日志</p><p>SQL Thread：从中继日志读取日志事件，在本地完成重放</p></blockquote><h2 id="3、特点"><a href="#3、特点" class="headerlink" title="3、特点"></a>3、特点</h2><ul><li>Mater和Slave之间是异步复制</li><li>主从数据不一致的情况比较常见</li></ul><h2 id="4、复制架构"><a href="#4、复制架构" class="headerlink" title="4、复制架构"></a>4、复制架构</h2><h3 id="4-1、主从复制"><a href="#4-1、主从复制" class="headerlink" title="4.1、主从复制"></a>4.1、主从复制</h3><h4 id="4-1-1、主节点配置过程"><a href="#4-1-1、主节点配置过程" class="headerlink" title="4.1.1、主节点配置过程"></a>4.1.1、主节点配置过程</h4><p>启动二进制日志</p><p>为当前节点设置全局唯一的ID号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin = master-binlog</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">server-id = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_flush_logs_at_trx_commit = 1</span><br><span class="line">sync_master_info = 1</span><br></pre></td></tr></table></figure><p>创建有复制权限的用户账号</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave,replication client on *.* to 'repuser'@'%' identified by 'password';</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h4 id="4-1-2、从节点配置过程"><a href="#4-1-2、从节点配置过程" class="headerlink" title="4.1.2、从节点配置过程"></a>4.1.2、从节点配置过程</h4><p>启动中继日志</p><p>为当前节点设置全局唯一的ID号</p><p>设置为只读状态（不影响主从复制）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip_slave_start = 1</span><br><span class="line">relay-log = relay-log</span><br><span class="line">relay-log = relay-log.index</span><br><span class="line">server-id = 2</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">read_only = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">sync_relay_log_info = 1</span><br></pre></td></tr></table></figure><p>使用有复制权限的用户账号连接到主服务器，并启动复制线程</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host='master-node',master_user='repuser',master_password='password',master_port=3306,master_log_file='mater-log.003',master_log_pos=1111,master_connect_retry=10;</span><br><span class="line">mysql&gt; start slave [io_thread|sql_thread];</span><br></pre></td></tr></table></figure><p>查看从状态信息</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure><h4 id="4-1-3、复制架构中应该注意的问题"><a href="#4-1-3、复制架构中应该注意的问题" class="headerlink" title="4.1.3、复制架构中应该注意的问题"></a>4.1.3、复制架构中应该注意的问题</h4><p>限制从服务器只读</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 确保my.cnf配置以下选项</span></span><br><span class="line">[mysqld]</span><br><span class="line">read_only = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> read_only对拥有super权限用户无效</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 阻止所有用户，不影响主从复制</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush tables with <span class="built_in">read</span> lock;</span></span><br></pre></td></tr></table></figure><p>保证主从复制事务安全</p><p>主节点配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次事务提交都写入binlog</span></span><br><span class="line">sync_binlog = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果启用了InnoDB，需要启用以下配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次事务提交时，<span class="built_in">log</span> buffer 会被写入到日志文件并刷写到磁盘。</span></span><br><span class="line">innodb_flush_logs_at_trx_commit = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次事务提交都写入master.info，这样在崩溃的时候，最多丢失一个事务，但是会造成大量的磁盘IO</span></span><br><span class="line">sync_master_info = 1</span><br></pre></td></tr></table></figure><p>从节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 手动启动slave</span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> slave的IO线程每次接受到master发送过来的binlog日志都要写入到系统缓冲去，然后刷入relay <span class="built_in">log</span>中继日志里面，这样在崩溃的时候，最多丢失一个事务，但是会造成大量的磁盘IO</span></span><br><span class="line">sync_relay_log = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> slave的IO线程每次接受到master发送过来的binlog日志都要写入到系统缓冲去，然后刷入relay-log.info中继日志里面，这样在崩溃的时候，最多丢失一个事务，但是会造成大量的磁盘IO</span></span><br><span class="line">sync_relay_log_info = 1</span><br></pre></td></tr></table></figure><h3 id="4-2、主主复制"><a href="#4-2、主主复制" class="headerlink" title="4.2、主主复制"></a>4.2、主主复制</h3><h4 id="4-2-1、注意事项"><a href="#4-2-1、注意事项" class="headerlink" title="4.2.1、注意事项"></a>4.2.1、注意事项</h4><p>互为主从</p><p>容易数据不一致，慎用</p><p>自动增长ID</p><p>A节点使用奇数ID</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">auto_increment_offset = 1</span><br><span class="line">auto_increment_increment = 2</span><br></pre></td></tr></table></figure><p>B节点使用偶数ID</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">auto_increment_increment = 2</span><br></pre></td></tr></table></figure><h4 id="4-2-2、配置步骤"><a href="#4-2-2、配置步骤" class="headerlink" title="4.2.2、配置步骤"></a>4.2.2、配置步骤</h4><p>使用唯一的server_id</p><p>启动bin_log和relay_log</p><p>创建拥有复制权限的用户</p><p>定义自动增长ID字段数值范围为奇偶</p><p>均把对方指定为主节点，启动复制线程</p><h3 id="4-3、半同步复制"><a href="#4-3、半同步复制" class="headerlink" title="4.3、半同步复制"></a>4.3、半同步复制</h3><p>跟主从复制类似</p><p>主节点会等待一个从节点写入完成再返回客户端写入成功</p><p>通过semisync插件提供半同步复制功能</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 二进制安装包</span></span><br><span class="line">/usr/local/mysql/lib/plugin/semisync_master.so</span><br><span class="line">/usr/local/mysql/lib/plugin/semisync_slave.so</span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm安装包</span></span><br><span class="line">/usr/lib64/mysql/plugin/semisync_master.so</span><br><span class="line">/usr/lib64/mysql/plugin/semisync_slave.so</span><br></pre></td></tr></table></figure><h4 id="4-3-1、主节点"><a href="#4-3-1、主节点" class="headerlink" title="4.3.1、主节点"></a>4.3.1、主节点</h4><p>启动二进制日志</p><p>为当前节点设置全局唯一的ID号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin = master-binlog</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">server-id = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_flush_logs_at_trx_commit = 1</span><br><span class="line">sync_master_info = 1</span><br></pre></td></tr></table></figure><p>创建有复制权限的用户账号</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave,replication client on *.* to 'repuser'@'%' identified by 'password';</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h4 id="4-3-2、从节点配置过程"><a href="#4-3-2、从节点配置过程" class="headerlink" title="4.3.2、从节点配置过程"></a>4.3.2、从节点配置过程</h4><p>启动中继日志</p><p>为当前节点设置全局唯一的ID号</p><p>设置为只读状态（不影响主从复制）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip_slave_start = 1</span><br><span class="line">relay-log = relay-log</span><br><span class="line">relay-log = relay-log.index</span><br><span class="line">server-id = 2</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">read_only = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">sync_relay_log_info = 1</span><br></pre></td></tr></table></figure><p>使用有复制权限的用户账号连接到主服务器，并启动复制线程</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host='master-node',master_user='repuser',master_password='password',master_port=3306,master_log_file='mater-log.003',master_log_pos=1111,master_connect_retry=10;</span><br><span class="line">mysql&gt; start slave ;</span><br></pre></td></tr></table></figure><p>查看从状态信息</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure><h4 id="4-3-3、启动semicsync插件"><a href="#4-3-3、启动semicsync插件" class="headerlink" title="4.3.3、启动semicsync插件"></a>4.3.3、启动semicsync插件</h4><p>主节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 安装半同步复制master插件</span><br><span class="line">mysql&gt; install plugin rpl_semi_sync_master soname &apos;semisync_master.so&apos;;</span><br><span class="line">mysql&gt; show plugins;</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library            | License |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| rpl_semi_sync_master       | ACTIVE   | REPLICATION        | semisync_master.so | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">mysql&gt; &gt; show global variables like &apos;%semi%&apos;;</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| Variable_name                             | Value      |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| rpl_semi_sync_master_enabled              | OFF        |</span><br><span class="line">| rpl_semi_sync_master_timeout              | 10000      |</span><br><span class="line">| rpl_semi_sync_master_trace_level          | 32         |</span><br><span class="line">| rpl_semi_sync_master_wait_for_slave_count | 1          |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave        | ON         |</span><br><span class="line">| rpl_semi_sync_master_wait_point           | AFTER_SYNC |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line"># 启动半同步复制master节点</span><br><span class="line">mysql&gt; set global variables rpl_semi_sync_master_enable = 1</span><br><span class="line">mysql&gt; show status like &apos;%semi_sync_%&apos;;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 0     |</span><br><span class="line">| Rpl_semi_sync_slave_status                 | OFF   |</span><br><span class="line">+--------------------------------------------+-------+</span><br></pre></td></tr></table></figure><p>从节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 停止从节点复制线程</span><br><span class="line">mysql&gt; stop slave;</span><br><span class="line"># 安装半同步复制Slave插件</span><br><span class="line">mysql&gt; install plugin rpl_semi_sync_master soname &apos;semisync_slave.so&apos;;</span><br><span class="line">mysql&gt; &gt; show plugins;</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library            | License |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| rpl_semi_sync_slave        | ACTIVE   | REPLICATION        | semisync_slave.so  | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">mysql&gt; &gt; show global variables like &apos;%semi%&apos;;</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| Variable_name                             | Value      |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| rpl_semi_sync_slave_enabled               | OFF        |</span><br><span class="line">| rpl_semi_sync_slave_trace_level           | 32         |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line"># 启动半同步复制Slave插件</span><br><span class="line">mysql&gt; set global variables rpl_semi_sync_slave_enabled=1;</span><br><span class="line">mysql&gt; show status like &apos;%semi_sync_%&apos;;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_slave_status                 | ON    |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line"># 开启从节点复制线程</span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure><h2 id="5、复制过滤"><a href="#5、复制过滤" class="headerlink" title="5、复制过滤"></a>5、复制过滤</h2><h3 id="5-1、主服务器"><a href="#5-1、主服务器" class="headerlink" title="5.1、主服务器"></a>5.1、主服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库记录到binlog</span></span><br><span class="line">binlog_do_db = db1</span><br><span class="line">binlog_do_db = db2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略数据库</span></span><br><span class="line">binlog_ignore_db = db1,db2</span><br></pre></td></tr></table></figure><h3 id="5-2、从服务器"><a href="#5-2、从服务器" class="headerlink" title="5.2、从服务器"></a>5.2、从服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制数据库</span></span><br><span class="line">replicate_do_db = db1,db2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略复制数据库</span></span><br><span class="line">replicate_ignore_db = db1,db2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制表</span></span><br><span class="line">replicate_do_table = db.table1,db.table2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略复制表</span></span><br><span class="line">replicate_ingore_table = db.table1,db.table2</span><br></pre></td></tr></table></figure><h2 id="6、监控维护"><a href="#6、监控维护" class="headerlink" title="6、监控维护"></a>6、监控维护</h2><h3 id="6-1、相关文件"><a href="#6-1、相关文件" class="headerlink" title="6.1、相关文件"></a>6.1、相关文件</h3><h5 id="6-1-1、master-info"><a href="#6-1-1、master-info" class="headerlink" title="6.1.1、master.info"></a>6.1.1、master.info</h5><p>保存Slave连接至master时的相关信息，例如账号密码、服务器地址、Position等</p><h5 id="6-1-2、relay-log-info"><a href="#6-1-2、relay-log-info" class="headerlink" title="6.1.2、relay-log.info"></a>6.1.2、relay-log.info</h5><p>保存当前Slave节点已经复制的当前二进制日志与本地relay-log日志的对应项</p><h3 id="6-2、清理日志"><a href="#6-2、清理日志" class="headerlink" title="6.2、清理日志"></a>6.2、清理日志</h3><h3 id="6-3、复制监控"><a href="#6-3、复制监控" class="headerlink" title="6.3、复制监控"></a>6.3、复制监控</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">mysql&gt; show binlog events;</span><br><span class="line">mysql&gt; show binary logs;</span><br><span class="line">mysql&gt; show slave status;</span><br><span class="line">mysql&gt; show processlist;</span><br></pre></td></tr></table></figure><h3 id="6-4、从服务器是否落后于主服务器"><a href="#6-4、从服务器是否落后于主服务器" class="headerlink" title="6.4、从服务器是否落后于主服务器"></a>6.4、从服务器是否落后于主服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G;</span><br><span class="line">Seconds_Behind_Master: 0</span><br></pre></td></tr></table></figure><h3 id="6-5、确定主从数据是否一致"><a href="#6-5、确定主从数据是否一致" class="headerlink" title="6.5、确定主从数据是否一致"></a>6.5、确定主从数据是否一致</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖包</span></span><br><span class="line">yum install perl-Time-HiRes -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载二进制包</span></span><br><span class="line">wget https://www.percona.com/downloads/percona-toolkit/3.0.12/binary/tarball/percona-toolkit-3.0.12_x86_64.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar xzf percona-toolkit-3.0.12_x86_64.tar.gz</span><br><span class="line">mv percona-toolkit-3.0.12 /usr/local/</span><br><span class="line">ln -sv /usr/local/percona-toolkit-3.0.12 /usr/local/percona-toolkit</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行工具检查</span></span><br><span class="line">pt-table-checksum</span><br></pre></td></tr></table></figure><h3 id="6-6、数据不一致如何处理"><a href="#6-6、数据不一致如何处理" class="headerlink" title="6.6、数据不一致如何处理"></a>6.6、数据不一致如何处理</h3><p>重新同步</p><h1 id="七、MHA（Master-High-Availability）"><a href="#七、MHA（Master-High-Availability）" class="headerlink" title="七、MHA（Master High Availability）"></a>七、MHA（Master High Availability）</h1><h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>MHA(Master High Availability)目前在MySQL高可用方面是一个相对成熟的解决方案，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。MySQL故障切换过程中，MHA能做到在0～30秒之内自动完成数据库的故障切换操作，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p><p>该软件由两部分组成：MHA Manager(管理节点)和MHA Node(数据节点)。MHA Mananger可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点中，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p><p>在MHA自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据不丢失，但这这并不总是可行的。例如，如果主服务器硬件故障或无法通过ssh访问，MHA没法保存二进制日志，只进行故障转移而丢失了最新的数据。使用MySQL 5.5的半同步复制，可以大大降低数据丢失的风险。MHA可以与半同步复制结合起来。如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性。</p><h2 id="2、MHA组件"><a href="#2、MHA组件" class="headerlink" title="2、MHA组件"></a>2、MHA组件</h2><p>Manager节点</p><ul><li>masterha_check_ssh：MHA依赖的SSH环境检测工具</li><li>masterha_check_repl：MySQL复制环境检测工具</li><li>masterha_manager：MHA服务主程序</li><li>masterha_check_status：MHA运行状态探测工具</li><li>masterha_master_monitor：MySQL master节点监测工具</li><li>masterha_master_switch：master节点切换工具</li><li>masterha_conf_host：添加删除配置的节点</li><li>masterha_stop：关闭MHA服务</li></ul><p>Node节点</p><ul><li>save_binary_logs：保存复制master的binlog</li><li>apply_diff_relay_logs：识别差异的中继日志事件并应用到其他slave</li><li>filter_mysqlbinlog：去除不必要的rollback事件（已弃用）</li><li>purge_relay_logs：清除中继日志（不阻塞SQL线程）</li></ul><p>自定义扩展</p><ul><li>secondary_check_script：通过多条网络路由检查master可用性</li><li>master_ip_failover_script：更新Application使用的master IP地址</li><li>shutdown_script：关闭master节点</li><li>report_script：发送报告</li><li>init_conf_load_script：加载初始化配置参数</li><li>master_ip_online_chage_script：更新master节点IP地址</li></ul><h2 id="3、准备MHA环境"><a href="#3、准备MHA环境" class="headerlink" title="3、准备MHA环境"></a>3、准备MHA环境</h2><h3 id="3-1、MHA对MySQL复制环境有特殊要求"><a href="#3-1、MHA对MySQL复制环境有特殊要求" class="headerlink" title="3.1、MHA对MySQL复制环境有特殊要求"></a>3.1、MHA对MySQL复制环境有特殊要求</h3><ul><li>各节点开启二进制日志和中继日志</li><li>从节点需要配置read-only，关闭relay_log_purge</li></ul><h3 id="3-2、服务器角色分配"><a href="#3-2、服务器角色分配" class="headerlink" title="3.2、服务器角色分配"></a>3.2、服务器角色分配</h3><ul><li>manager：MHA Manager</li><li>db1：master节点</li><li>db2：slave节点</li><li>db3：slave节点</li></ul><h3 id="3-3、环境准备"><a href="#3-3、环境准备" class="headerlink" title="3.3、环境准备"></a>3.3、环境准备</h3><p>各节点启用epel源</p><p>各节点/etc/hosts文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">10.0.0.10 manager</span><br><span class="line">10.0.0.11 db1</span><br><span class="line">10.0.0.12 db2</span><br><span class="line">10.0.0.13 db3</span><br></pre></td></tr></table></figure><p>初始master节点配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> server_id必须唯一</span></span><br><span class="line">server_id=1</span><br><span class="line">relay-log=relay-log</span><br><span class="line">log-bin=master-bin</span><br></pre></td></tr></table></figure><p>初始Slave节点配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> server_id必须唯一</span></span><br><span class="line">server_id=2</span><br><span class="line">relay-log=relay-log</span><br><span class="line">log-bin=master-bin</span><br><span class="line">relay_log_purge=0</span><br><span class="line">read_only=1</span><br></pre></td></tr></table></figure><p>配置主从复制</p><p>db1配置为master节点</p><p>db2、db3以db1为master节点，开启slave线程</p><p>所有数据库节点创建MHA所需的管理用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all privileges on *.* to &apos;mhauser&apos;@&apos;%&apos; identified by &apos;password&apos;;</span><br></pre></td></tr></table></figure><p>配置manager、db1、db2、db3免密码SSH连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在manager节点上配置证书，分发到其他节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面以root用户为例</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">cat /root/.ssh/id_rsa &gt; /root/.ssh/authorized_keys</span><br><span class="line">chmod 0600 /root/.ssh/authorized_keys</span><br><span class="line">for i in db1 db2 db3;</span><br><span class="line">do</span><br><span class="line">scp -p .ssh/id_rcs .ssh/authorized_keys $i:/root/.ssh/</span><br><span class="line">done</span><br><span class="line">for i in manager db1 db2 db3;</span><br><span class="line">do</span><br><span class="line">ssh $i date</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="3-4、安装MHA"><a href="#3-4、安装MHA" class="headerlink" title="3.4、安装MHA"></a>3.4、安装MHA</h3><h4 id="3-4-1、node节点安装"><a href="#3-4-1、node节点安装" class="headerlink" title="3.4.1、node节点安装"></a>3.4.1、node节点安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖包</span></span><br><span class="line">yum install perl perl-DBD-MySQL -y</span><br><span class="line">wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br><span class="line">yum localinstall mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="3-4-2、manager节点安装配置"><a href="#3-4-2、manager节点安装配置" class="headerlink" title="3.4.2、manager节点安装配置"></a>3.4.2、manager节点安装配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装perl相关软件包</span></span><br><span class="line">yum install perl perl-DBD-MySQL -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载安装mha4mysql-manager软件包</span></span><br><span class="line">wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span><br><span class="line">yum localinstall mha4mysql-manager-0.58-0.el7.centos.noarch.rpm -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑MHA配置文件/etc/mha_app1.conf</span></span><br><span class="line">cat &gt; /etc/mha_app1.conf &lt;&lt;EOF</span><br><span class="line">[server default]</span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql创建给MHA使用的账号密码</span></span><br><span class="line">user=root</span><br><span class="line">password=supersecure</span><br><span class="line"><span class="meta">#</span><span class="bash"> manager工作目录</span></span><br><span class="line">manager_workdir=/data/masterha/app1</span><br><span class="line"><span class="meta">#</span><span class="bash"> manager日志路径</span></span><br><span class="line">manager_log=/data/masterha/app1/manager.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> MySQL工作目录</span></span><br><span class="line">remote_workdir=/data/masterha/app1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh使用的用户</span></span><br><span class="line">ssh_user=root</span><br><span class="line">repl_user=repluser</span><br><span class="line">repl_password=password</span><br><span class="line">ping_interval=1</span><br><span class="line">[server1]</span><br><span class="line">hostname=db1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh_port=22222</span></span><br><span class="line">candidate_master=1</span><br><span class="line">[server2]</span><br><span class="line">hostname=db2</span><br><span class="line">candidate_master=1</span><br><span class="line">[server3]</span><br><span class="line">hostname=db3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止节点切换成master节点可以配置no_master=1</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-4-3、manager节点检测配置和启动"><a href="#3-4-3、manager节点检测配置和启动" class="headerlink" title="3.4.3、manager节点检测配置和启动"></a>3.4.3、manager节点检测配置和启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 检查各节点ssh互信通信配置</span></span><br><span class="line">masterha_check_ssh --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查受管MySQL复制集群配置</span></span><br><span class="line">masterha_check_repl --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动mha4mysql-manager</span></span><br><span class="line">masterha_manager --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查mha4mysql-manager状态</span></span><br><span class="line">masterha_check_status --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭mha4mysql-manager服务</span></span><br><span class="line">masterha_stop --conf=/etc/mha_app1.conf</span><br></pre></td></tr></table></figure><h4 id="3-4-4、MHA注意点"><a href="#3-4-4、MHA注意点" class="headerlink" title="3.4.4、MHA注意点"></a>3.4.4、MHA注意点</h4><ul><li>keepalived提供VIP和master切换的对应脚本</li><li>masterha_manager启动参数<ul><li>–remove_dead_master_conf，当发生主从切换后，老的主库的IP将会从配置文件中移除</li><li>–ignore_last_failover，MHA切换时会产生app1.failover.complete文件，两次切换时间少于8小时会切换失败，使用该参数能忽略</li></ul></li></ul><h1 id="八、复制的问题和解决"><a href="#八、复制的问题和解决" class="headerlink" title="八、复制的问题和解决"></a>八、复制的问题和解决</h1><h2 id="1、数据损坏和丢失"><a href="#1、数据损坏和丢失" class="headerlink" title="1、数据损坏和丢失"></a>1、数据损坏和丢失</h2><ul><li>Master<ul><li>MHA + 半同步复制</li></ul></li><li>Slave<ul><li>重新复制</li></ul></li></ul><h2 id="2、混合使用存储引擎"><a href="#2、混合使用存储引擎" class="headerlink" title="2、混合使用存储引擎"></a>2、混合使用存储引擎</h2><ul><li>MyISAM不支持事务</li><li>InnoDB支持事务</li></ul><h2 id="3、server-id不唯一"><a href="#3、server-id不唯一" class="headerlink" title="3、server_id不唯一"></a>3、server_id不唯一</h2><ul><li>重新复制</li></ul><h2 id="4、复制延迟"><a href="#4、复制延迟" class="headerlink" title="4、复制延迟"></a>4、复制延迟</h2><ul><li>需要额外的监控工具辅助</li></ul><h1 id="九、Percona-XtraDB-Cluster"><a href="#九、Percona-XtraDB-Cluster" class="headerlink" title="九、Percona XtraDB Cluster"></a>九、Percona XtraDB Cluster</h1><h2 id="1、介绍-1"><a href="#1、介绍-1" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>项目地址： <a href="http://www.percona.com/doc/percona-xtradb-cluster/intro.html" target="_blank" rel="noopener">http://www.percona.com/doc/percona-xtradb-cluster/intro.html</a></p><p>Percona XtraDB Cluster是MySQL高可用性和可扩展性的解决方案.</p><p>Percona XtraDB Cluster提供的特性有：</p><ul><li><p>同步复制，事务要么在所有节点提交或不提交。</p></li><li><p>多主复制，可以在任意节点进行写操作。</p></li><li><p>在从服务器上并行应用事件，真正意义上的并行复制。</p></li><li><p>节点自动配置。</p></li><li><p>数据一致性，不再是异步复制。</p></li></ul><p>Percona XtraDB Cluster完全兼容MySQL和Percona Server，表现在：</p><ul><li><p>数据的兼容性</p></li><li><p>应用程序的兼容性：无需更改应用程序</p></li></ul><h2 id="2、特点"><a href="#2、特点" class="headerlink" title="2、特点"></a>2、特点</h2><ul><li>当执行一个查询时，在本地节点上执行。因为所有数据都在本地，无需远程访问。</li><li>无需集中管理。可以在任何时间点失去任何节点，但是集群将照常工作。</li><li>良好的读负载扩展，任意节点都可以查询。</li><li>加入新节点，开销大。需要复制完整的数据。</li><li>不能有效的解决写缩放问题，所有的写操作都将发生在所有节点上。</li><li>有多少个节点就有多少重复的数据。</li></ul><h2 id="3、局限性"><a href="#3、局限性" class="headerlink" title="3、局限性"></a>3、局限性</h2><ul><li>目前的复制仅仅支持InnoDB存储引擎。任何写入其他引擎的表，包括mysql.*表将不会复制。但是DDL语句会被复制的，因此创建用户将会被复制，但是insert into mysql.user…将不会被复制的。</li><li>DELETE操作不支持没有主键的表。没有主键的表在不同的节点顺序将不同，如果执行SELECT…LIMIT… 将出现不同的结果集。</li><li>在多主环境下LOCK/UNLOCK TABLES不支持。以及锁函数GET_LOCK(), RELEASE_LOCK()..</li><li>查询日志不能保存在表中。如果开启查询日志，只能保存到文件中。</li><li>允许最大的事务大小由wsrep_max_ws_rows和wsrep_max_ws_size定义。任何大型操作将被拒绝。如大型的LOAD DATA操作。</li><li>由于集群是乐观的并发控制，事务commit可能在该阶段中止。如果有两个事务向在集群中不同的节点向同一行写入并提交，失败的节点将中止。对于集群级别的中止，集群返回死锁错误代码(Error: 1213 SQLSTATE: 40001 (ER_LOCK_DEADLOCK)).</li><li>XA事务不支持，由于在提交上可能回滚。</li><li>整个集群的写入吞吐量是由最弱的节点限制，如果有一个节点变得缓慢，那么整个集群将是缓慢的。为了稳定的高性能要求，所有的节点应使用统一的硬件。</li><li>集群节点建议最少3个。2个也可以运行，但是官方不推荐这么做，因为3个节点是为了预防脑裂。</li><li>如果DDL语句有问题将破坏集群。建议使用pt-online-schema-change操作DDL。</li></ul><h2 id="4、安装galera-cluster"><a href="#4、安装galera-cluster" class="headerlink" title="4、安装galera-cluster"></a>4、安装galera-cluster</h2><h3 id="4-1、软件包"><a href="#4-1、软件包" class="headerlink" title="4.1、软件包"></a>4.1、软件包</h3><p><a href="https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/" target="_blank" rel="noopener">官网下载地址</a></p><p><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/index.html" target="_blank" rel="noopener">官方文档地址</a></p><h3 id="4-2、准备工作"><a href="#4-2、准备工作" class="headerlink" title="4.2、准备工作"></a>4.2、准备工作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/hosts</span><br><span class="line">10.0.0.11 db1</span><br><span class="line">10.0.0.12 db2</span><br><span class="line">10.0.0.13 db3</span><br></pre></td></tr></table></figure><p>节点一</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">[root@db1 ~]# mkdir -p /usr/local/pxc</span><br><span class="line">[root@db1 ~]# mkdir -p /data/pxc/mysql3306/&#123;data,tmp,logs&#125;</span><br><span class="line"> </span><br><span class="line">[root@db1 ~]# vi /etc/my.cnf</span><br><span class="line"> [client]</span><br><span class="line">port    = 3306</span><br><span class="line">socket  = /data/pxc/mysql3306/tmp/mysql.sock</span><br><span class="line"><span class="meta">#</span><span class="bash"> The MySQL server</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########Basic##################</span></span></span><br><span class="line">explicit_defaults_for_timestamp=true</span><br><span class="line"></span><br><span class="line">port        = 3306  </span><br><span class="line">user        = mysql   </span><br><span class="line">basedir         = /usr/local/pxc</span><br><span class="line">datadir         = /data/pxc/mysql3306/data   </span><br><span class="line">tmpdir          = /data/pxc/mysql3306/tmp   </span><br><span class="line">pid-file        = /data/pxc/mysql3306/tmp/mysql.pid    </span><br><span class="line">socket            = /data/pxc/mysql3306/tmp/mysql.sock   </span><br><span class="line"><span class="meta">#</span><span class="bash">skip-grant-tables  </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">character <span class="built_in">set</span></span></span><br><span class="line">character_set_server = utf8</span><br><span class="line"></span><br><span class="line">open_files_limit = 65535</span><br><span class="line">back_log = 500</span><br><span class="line"><span class="meta">#</span><span class="bash">event_scheduler = ON</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lower_case_table_names=1</span></span><br><span class="line">skip-external-locking</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">default-storage-engine = InnoDB</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">timeout</span></span><br><span class="line">wait_timeout=1000</span><br><span class="line">interactive_timeout=1000</span><br><span class="line">connect_timeout = 20</span><br><span class="line"></span><br><span class="line">server-id       = 11  #ip最后一位</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">plugin</span></span><br><span class="line">plugin-load="semisync_master.so;semisync_slave.so"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########error log#############</span></span></span><br><span class="line">log-error = /data/pxc/mysql3306/logs/error.log  </span><br><span class="line">log-warnings = 2  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########general log#############</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">general_log=1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">general_log_file=/data/pxc/mysql3306/logs/mysql.log </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########slow log#############</span></span></span><br><span class="line">slow_query_log = 1</span><br><span class="line">long_query_time=1</span><br><span class="line">slow_query_log_file = /data/pxc/mysql3306/logs/mysql.slow   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############ for replication###################</span></span></span><br><span class="line">log-bin     = /data/pxc/mysql3306/logs/mysql-bin   </span><br><span class="line">binlog_format = row</span><br><span class="line">max_binlog_size = 50M</span><br><span class="line">binlog_cache_size = 2M</span><br><span class="line">max_binlog_cache_size = 2M</span><br><span class="line">expire-logs-days = 7</span><br><span class="line">slave-net-timeout=30</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line">log-slave-updates = 1   </span><br><span class="line">skip-slave-start = 1</span><br><span class="line"><span class="meta">#</span><span class="bash">super_read_only =1    </span></span><br><span class="line"><span class="meta">#</span><span class="bash">GTID</span></span><br><span class="line">gtid-mode = on</span><br><span class="line">binlog_gtid_simple_recovery=1</span><br><span class="line">enforce_gtid_consistency=1</span><br><span class="line"><span class="meta">#</span><span class="bash">relay <span class="built_in">log</span></span></span><br><span class="line">relay-log = /data/pxc/mysql3306/logs/mysql-relay  </span><br><span class="line">relay-log-index=/data/pxc/mysql3306/logs/relay-bin.index</span><br><span class="line">max-relay-log-size = 500M</span><br><span class="line"><span class="meta">#</span><span class="bash">replication crash safe</span></span><br><span class="line">sync_master_info = 1</span><br><span class="line">sync_relay_log_info = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">relay_log_recovery = 1</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">######per_thread_buffers#####################</span></span></span><br><span class="line">max_connections=1100</span><br><span class="line">max_user_connections=1000</span><br><span class="line">max_connect_errors=10000</span><br><span class="line"><span class="meta">#</span><span class="bash">myisam_recover</span></span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line"><span class="meta">#</span><span class="bash">table_cache = 3096</span></span><br><span class="line">table_open_cache = 6144</span><br><span class="line">table_definition_cache = 4096</span><br><span class="line">read_buffer_size = 1M</span><br><span class="line">join_buffer_size = 128K</span><br><span class="line">read_rnd_buffer_size = 1M</span><br><span class="line"><span class="meta">#</span><span class="bash">myisam</span></span><br><span class="line">sort_buffer_size = 128K</span><br><span class="line">myisam_max_sort_file_size = 1G</span><br><span class="line">myisam_repair_threads = 1</span><br><span class="line">myisam_sort_buffer_size = 32M</span><br><span class="line">tmp_table_size = 32M</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">query_cache_type=0</span><br><span class="line">query_cache_size = 0</span><br><span class="line">bulk_insert_buffer_size = 32M</span><br><span class="line">thread_cache_size = 64</span><br><span class="line"><span class="meta">#</span><span class="bash">thread_concurrency = 32</span></span><br><span class="line">thread_stack = 192K</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##############InnoDB###########################</span></span></span><br><span class="line">innodb_data_home_dir = /data/pxc/mysql3306/data      </span><br><span class="line">innodb_log_group_home_dir = /data/pxc/mysql3306/logs    </span><br><span class="line">innodb_data_file_path = ibdata1:10M:autoextend</span><br><span class="line">innodb_buffer_pool_size = 512M  #根据内存大小设置</span><br><span class="line">innodb_buffer_pool_instances    = 8</span><br><span class="line"><span class="meta">#</span><span class="bash">innodb_additional_mem_pool_size = 16M</span></span><br><span class="line">innodb_log_file_size = 50M</span><br><span class="line">innodb_log_buffer_size = 16M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_lock_wait_timeout = 10</span><br><span class="line">innodb_sync_spin_loops = 40</span><br><span class="line">innodb_max_dirty_pages_pct = 80</span><br><span class="line">innodb_support_xa = 1</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_thread_sleep_delay = 500</span><br><span class="line">innodb_concurrency_tickets = 1000</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_read_io_threads = 16</span><br><span class="line">innodb_write_io_threads = 16</span><br><span class="line">innodb_io_capacity = 800  </span><br><span class="line">innodb_flush_neighbors = 1</span><br><span class="line">innodb_file_format = Barracuda</span><br><span class="line">innodb_purge_threads=4   </span><br><span class="line">innodb_purge_batch_size = 32</span><br><span class="line">innodb_old_blocks_pct=75</span><br><span class="line">innodb_change_buffering=all</span><br><span class="line">innodb_stats_on_metadata=OFF</span><br><span class="line">innodb_print_all_deadlocks = 1</span><br><span class="line">performance_schema=0  </span><br><span class="line">transaction_isolation = READ-COMMITTED</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############ PXC #####################                                                 </span></span></span><br><span class="line">innodb_autoinc_lock_mode=2                                                       </span><br><span class="line">wsrep_cluster_name=pxc-dongzheng                                                 </span><br><span class="line">wsrep_provider=/usr/local/pxc/lib/libgalera_smm.so                             </span><br><span class="line">wsrep_cluster_address=gcomm://10.0.0.11,10.0.0.12,10.0.13     </span><br><span class="line">wsrep_node_address=10.0.0.11    # 本机IP地址                                          </span><br><span class="line">wsrep_slave_threads=2                                                            </span><br><span class="line">wsrep_sst_auth=sst:sky                                                     </span><br><span class="line">wsrep_sst_method=xtrabackup-v2                                                   </span><br><span class="line">wsrep_provider_options="debug=1"</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 128M</span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">max_allowed_packet = 128M</span><br><span class="line">prompt                         = '(product)\u@\h:\p [\d]&gt; '</span><br><span class="line">default_character_set          = utf8</span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">sort_buffer_size = 512k</span><br><span class="line">read_buffer = 2M</span><br><span class="line">write_buffer = 2M</span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="meta">#</span><span class="bash">malloc-lib= /usr/<span class="built_in">local</span>/mysql/lib/mysql/libjemalloc.so</span></span><br></pre></td></tr></table></figure><p>节点二、节点三修改my.cnf里面的对应值就行</p><ul><li><p>wsrep_node_address =</p></li><li><p>server-id =</p></li></ul><h3 id="4-3、启动集群"><a href="#4-3、启动集群" class="headerlink" title="4.3、启动集群"></a>4.3、启动集群</h3><p>先初始化节点一，将节点一加入集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动集群</span></span><br><span class="line">mysqld --defaults-file=/etc/my.cnf --initialize-insecure</span><br><span class="line">mysqld --defaults-file=/etc/my.cnf --wsrep-new-cluster &amp;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建账号</span><br><span class="line">mysql&gt; GRANT PROCESS, RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO &apos;sst&apos;@&apos;localhost&apos;IDENTIFIED BY &apos;sky&apos;;FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>节点二、节点三加入集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --defaults-file=/etc/my.cnf &amp;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;本文基于MySQL-5-7记录&quot;&gt;&lt;a href=&quot;#本文基于MySQL-5-7记录&quot; class=&quot;headerlink&quot; title=&quot;本文基于MySQL 5.7记录&quot;&gt;&lt;/a&gt;本文基于MySQL 5.7记录&lt;/h1&gt;&lt;h1 id=&quot;一、安装&quot;&gt;&lt;a href
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
      <category term="Database" scheme="https://luanlengli.github.io/tags/Database/"/>
    
  </entry>
  
  <entry>
    <title>Linux运维常见面试题</title>
    <link href="https://luanlengli.github.io/2019/02/14/Linux%E8%BF%90%E7%BB%B4%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98.html"/>
    <id>https://luanlengli.github.io/2019/02/14/Linux运维常见面试题.html</id>
    <published>2019-02-14T02:07:19.000Z</published>
    <updated>2019-02-15T02:36:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="LINUX系统软件安装和卸载的常见方法"><a href="#LINUX系统软件安装和卸载的常见方法" class="headerlink" title="LINUX系统软件安装和卸载的常见方法"></a><strong>LINUX系统软件安装和卸载的常见方法</strong></h2><ul><li><p>RHEL/CentOS系列</p><ul><li><p><code>rpm -e &quot;软件包名字&quot;</code></p></li><li><p><code>yum remove &quot;软件包名字&quot;</code>，此操作会卸载相关的依赖</p></li></ul></li><li><p>Debian/Ubuntu系列</p><ul><li><code>apt-get remove &quot;软件包名字&quot;</code>，不删除依赖，保留配置文件</li><li><code>apt-get autoremove &quot;软件包名字&quot;</code>，删除依赖，保留配置文件</li><li><code>apt-get purge &quot;软件包名字&quot;</code>，不删除依赖，删除配置文件</li></ul></li><li><p>源代码安装的，可以使用<code>make uninstall</code>，或者直接删掉软件目录</p></li></ul><h2 id="修改LINUX的主机名"><a href="#修改LINUX的主机名" class="headerlink" title="修改LINUX的主机名"></a><strong>修改LINUX的主机名</strong></h2><ul><li>RHEL/CentOS系列<ul><li><code>hostnamectl set-hostname &quot;主机名&quot;</code></li><li>修改<code>/etc/sysconfig/network</code>里面的<code>HOSTNAME</code></li></ul></li><li>Debian/Ubuntu系列<ul><li>修改<code>/etc/hosts</code>和<code>/etc/hostname</code>的主机名，然后运行<code>/etc/init.d/hostname.sh start</code></li></ul></li><li>临时有效<ul><li><code>hostname &quot;主机名&quot;</code></li></ul></li></ul><h2 id="自动切割压缩备份日志脚本"><a href="#自动切割压缩备份日志脚本" class="headerlink" title="自动切割压缩备份日志脚本"></a><strong>自动切割压缩备份日志脚本</strong></h2><ul><li>每天凌晨5点执行，带日期后缀</li><li>以Nginx日志为例</li><li>切割打包压缩前一天的日志之后，将压缩包上传到FTP服务器<code>192.168.1.2</code>账号<code>aaa</code>密码<code>bbb</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">LOG_PATH=<span class="string">'/path/to/nginx_log/'</span></span><br><span class="line">DATE=`date +%F`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让Nginx切割日志</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `ls | grep *<span class="built_in">log</span>`;<span class="keyword">do</span></span><br><span class="line">    mv <span class="variable">$&#123;file&#125;</span> <span class="variable">$&#123;file&#125;</span>.<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">nginx -s reopen</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包文件</span></span><br><span class="line">tar nginx_log_<span class="variable">$&#123;DATE&#125;</span>.tar.gz `ls *<span class="variable">$&#123;DATE&#125;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理日志文件</span></span><br><span class="line">rm -rf *<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line">ftp -n &lt;&lt;- EOF</span><br><span class="line">open 192.168.1.2</span><br><span class="line">user aaa bbb</span><br><span class="line">put nginx_log_<span class="variable">$&#123;DATE&#125;</span>.tar.gz</span><br><span class="line"><span class="built_in">bye</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除过期文件</span></span><br><span class="line">find <span class="variable">$&#123;LOG_PATH&#125;</span> -<span class="built_in">type</span> f -mtime +60 -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 5 * * * /bin/bash /path/to/logrotate.sh</span><br></pre></td></tr></table></figure><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a><strong>iptables</strong></h2><p><strong>允许来自127.0.0.1端口1234访问114.114.114.114端口80</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 127.0.0.1 --sport 1234 -d 114.114.114.114 --dport 80 -j ACCPET</span><br></pre></td></tr></table></figure><p><strong>禁用从lo进入的流量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j REJECT</span><br></pre></td></tr></table></figure><p><strong>允许外部访问22端口</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCPET</span><br></pre></td></tr></table></figure><p><strong>在postrouting链上，把源地址192.168.2.0/24的数据包源地址修改为192.168.1.2</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.2.0/24 -j SNAT --to-source 192.168.1.2</span><br></pre></td></tr></table></figure><p><strong>删除INPUT链上第八条规则</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -Ln --line-numbers</span><br><span class="line">iptables -D INPUT 8</span><br></pre></td></tr></table></figure><p><strong>eth0的数据包转发到eth1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT</span><br></pre></td></tr></table></figure><p><strong>iptables匹配参数</strong></p><ul><li><code>-A</code>：在chain里追加规则</li><li><code>-D</code>：删除chain里的规则</li><li><code>-I</code>：将规则插入到chain</li><li><code>-t</code>：指定表</li><li><code>-s</code>：匹配源地址</li><li><code>-d</code>：匹配目的地址</li><li><code>-p</code>：协议匹配</li><li><code>-i</code>：入口匹配</li><li><code>-o</code>：出口匹配</li><li><code>--sport</code>：源端口匹配</li><li><code>--dport</code>：出口端口匹配</li><li><code>-j</code>：数据包处理动作</li><li><code>!</code>：取反</li></ul><h2 id="iptables基本概念"><a href="#iptables基本概念" class="headerlink" title="iptables基本概念"></a>iptables基本概念</h2><h3 id="table"><a href="#table" class="headerlink" title="table"></a>table</h3><ul><li><code>raw</code> 用于配置数据包，<code>raw</code> 中的数据包不会被系统跟踪</li><li><code>filter</code> 是用于存放所有与防火墙相关操作的默认表</li><li><code>nat</code> 用于 网络地址转换（例如：端口转发）</li><li><code>mangle</code> 用于对特定数据包的修改</li><li><code>security</code> 用于 强制访问控制网络规则（例如： SELinux）</li></ul><h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                             XXX     Network    XXX</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                                       +</span><br><span class="line">                                       |</span><br><span class="line">                                       v</span><br><span class="line"> +-------------+              +------------------+</span><br><span class="line"> |table: filter| &lt;---+        | table: nat       |</span><br><span class="line"> |chain: INPUT |     |        | chain: PREROUTING|</span><br><span class="line"> +-----+-------+     |        +--------+---------+</span><br><span class="line">       |             |                 |</span><br><span class="line">       v             |                 v</span><br><span class="line"> [<span class="built_in">local</span> process]     |           ****************          +--------------+</span><br><span class="line">       |             +---------+ Routing decision +------&gt; |table: filter |</span><br><span class="line">       v                         ****************          |chain: FORWARD|</span><br><span class="line">****************                                           +------+-------+</span><br><span class="line">Routing decision                                                  |</span><br><span class="line">****************                                                  |</span><br><span class="line">       |                                                          |</span><br><span class="line">       v                        ****************                  |</span><br><span class="line">+-------------+       +------&gt;  Routing decision  &lt;---------------+</span><br><span class="line">|table: nat   |       |         ****************</span><br><span class="line">|chain: OUTPUT|       |               +</span><br><span class="line">+-----+-------+       |               |</span><br><span class="line">      |               |               v</span><br><span class="line">      v               |      +-------------------+</span><br><span class="line">+--------------+      |      | table: nat        |</span><br><span class="line">|table: filter | +----+      | chain: POSTROUTING|</span><br><span class="line">|chain: OUTPUT |             +--------+----------+</span><br><span class="line">+--------------+                      |</span><br><span class="line">                                      v</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                             XXX    Network     XXX</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure><h2 id="统计TCP连接状态"><a href="#统计TCP连接状态" class="headerlink" title="统计TCP连接状态"></a>统计TCP连接状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an|awk <span class="string">'/tcp/ &#123;print $6&#125;'</span>|sort|uniq -c</span><br></pre></td></tr></table></figure><h2 id="列出每个IP的TCP连接数"><a href="#列出每个IP的TCP连接数" class="headerlink" title="列出每个IP的TCP连接数"></a><strong>列出每个IP的TCP连接数</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -n | awk <span class="string">'/^tcp/ &#123;print $5&#125;'</span> | awk -F: <span class="string">'&#123;print $1&#125;'</span> | sort | uniq -c | sort -rn</span><br></pre></td></tr></table></figure><h2 id="生成随机字符串"><a href="#生成随机字符串" class="headerlink" title="生成随机字符串"></a><strong>生成随机字符串</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 20</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/urandom bs=128 count=1 2&gt;/dev/null | base64 | tr -d <span class="string">"=+/[:space:]"</span> | dd bs=32 count=1 2&gt;/dev/null</span><br></pre></td></tr></table></figure><h2 id="描述tcp三次握手的过程"><a href="#描述tcp三次握手的过程" class="headerlink" title="描述tcp三次握手的过程"></a><strong>描述tcp三次握手的过程</strong></h2><p>第一次握手：建立连接时，客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；</p><p>第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器 进入SYN_RECV状态；</p><p>第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入 ESTABLISHED状态，完成三次握手。</p><h2 id="内核参数的含义"><a href="#内核参数的含义" class="headerlink" title="内核参数的含义"></a><strong>内核参数的含义</strong></h2><ul><li><code>net.ipv4.tcp_tw_recycle=1</code><ul><li>启用此功能可以加快TIME-WAIT状态的TCP连接回收</li><li>内核会记录最后一个报文的时间戳，如果新的TCP报文时间戳小于最后一个报文的时间戳，则会drop包，导致无法建立TCP连接</li></ul></li><li><code>net.ipv4.tcp_tw_reuse=1</code><ul><li>允许将处于TIME-WAIT状态的socket用于新的TCP连接</li></ul></li><li><code>net.ipv4.tcp_timestamps=1</code><ul><li>发送TCP时间戳</li></ul></li><li><code>vm.swappiness=0</code><ul><li>最大限度使用物理内存，物理内存耗尽才启用swap</li></ul></li></ul><h2 id="Linux开机启动顺序"><a href="#Linux开机启动顺序" class="headerlink" title="Linux开机启动顺序"></a><strong>Linux开机启动顺序</strong></h2><p>以<code>BIOS-based</code>和<code>RHEL/CentOS-7</code>为例</p><ul><li>硬件加电</li><li>加载BIOS</li><li>硬件自检</li><li>BIOS按照启动顺序读取存储设备的MBR</li><li>根据MBR找到并加载bootloader</li><li>bootloader从<code>/boot</code>目录加载<code>vmlinuz</code>内核镜像，提取<code>initramfs</code>的内容并存放在<code>tmpfs</code>中</li><li>操作系统内核从<code>initramfs</code>中加载必要的驱动和挂载根文件系统，启动<code>systemd</code>作为第一个系统进程</li><li>systemd读取配置文件，读取<code>default-target</code>文件，引导至<code>default-target</code>定义的状态<ul><li>初始化网络</li><li>设置主机名</li><li>基于内核参数初始化硬件设备</li><li>加载文件系统</li><li>启动systemd服务</li></ul></li><li>启动完成</li></ul><h2 id="ps-aux中VSZ和RSS的含义"><a href="#ps-aux中VSZ和RSS的含义" class="headerlink" title="ps aux中VSZ和RSS的含义"></a>ps aux中VSZ和RSS的含义</h2><ul><li>VSZ：虚拟内存集，代表进程占用的虚拟内存空间</li><li>RSS：物理内存集，代表进程实际占用的物理内存空间</li></ul><h2 id="top命令中字段的含义"><a href="#top命令中字段的含义" class="headerlink" title="top命令中字段的含义"></a>top命令中字段的含义</h2><ul><li>PID：进程ID</li><li>USER：进程所有者的用户名</li><li>PR：进程优先级</li><li>NI：nice值，数值越小，优先级越高</li><li>VIRT：虚拟内存集，代表进程占用的虚拟内存空间</li><li>RES：物理内存集，代表进程实际占用的物理内存空间</li><li>SHR：共享内存大小</li><li>S：进程状态</li><li>%CPU：CPU时间占比</li><li>%MEM：物理内存占比</li><li>TIME+：进程使用的CPU时间总量</li><li>COMMAND：进程命令</li></ul><h2 id="load-average含义"><a href="#load-average含义" class="headerlink" title="load average含义"></a>load average含义</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load average: 0.00, 0.00, 0.00</span><br></pre></td></tr></table></figure><ul><li>分别代表1分钟内、5分钟内、15分钟内系统的平均负载</li><li>系统负载指的是运行队列的长度，即等待CPU的平均进程数</li><li>因此<code>load average的值=CPU核数</code>是最理想的状态</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;LINUX系统软件安装和卸载的常见方法&quot;&gt;&lt;a href=&quot;#LINUX系统软件安装和卸载的常见方法&quot; class=&quot;headerlink&quot; title=&quot;LINUX系统软件安装和卸载的常见方法&quot;&gt;&lt;/a&gt;&lt;strong&gt;LINUX系统软件安装和卸载的常见方法&lt;/
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>kubectl命令的用法</title>
    <link href="https://luanlengli.github.io/2019/02/12/kubectl%E5%91%BD%E4%BB%A4%E7%9A%84%E7%94%A8%E6%B3%95.html"/>
    <id>https://luanlengli.github.io/2019/02/12/kubectl命令的用法.html</id>
    <published>2019-02-12T07:10:40.000Z</published>
    <updated>2019-03-25T07:10:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h1 id="命令介绍"><a href="#命令介绍" class="headerlink" title="命令介绍"></a>命令介绍</h1><h2 id="获取帮助"><a href="#获取帮助" class="headerlink" title="获取帮助"></a>获取帮助</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --help</span><br></pre></td></tr></table></figure><h2 id="查看集群信息"><a href="#查看集群信息" class="headerlink" title="查看集群信息"></a>查看集群信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info</span><br></pre></td></tr></table></figure><h2 id="指定kubeconfig"><a href="#指定kubeconfig" class="headerlink" title="指定kubeconfig"></a>指定kubeconfig</h2><p>默认是当前用户家目录下的<code>~/.kube/config</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --config /path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="kubeconfig上下文配置"><a href="#kubeconfig上下文配置" class="headerlink" title="kubeconfig上下文配置"></a>kubeconfig上下文配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看kubeconfig信息</span></span><br><span class="line">kubectl config view</span><br><span class="line"><span class="comment"># 合并多个kubeconfig文件并查看合并后的kubeconfig信息</span></span><br><span class="line">KUBECONFIG=~/.kube/config:~/.kube/kubconfig2 kubectl config view</span><br><span class="line"><span class="comment"># 显示当前上下文</span></span><br><span class="line">kubectl config current-context</span><br><span class="line"><span class="comment"># 设置默认上下文为cluster-name</span></span><br><span class="line">kubectl config use-context cluster-name</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="指定命名空间"><a href="#指定命名空间" class="headerlink" title="指定命名空间"></a>指定命名空间</h2><p>默认命名空间是<code>default</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --namespace kube-system</span><br><span class="line">kubectl -n kube-system</span><br></pre></td></tr></table></figure><h2 id="指定所有命名空间"><a href="#指定所有命名空间" class="headerlink" title="指定所有命名空间"></a>指定所有命名空间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --all-namespaces</span><br></pre></td></tr></table></figure><h2 id="指定输出格式"><a href="#指定输出格式" class="headerlink" title="指定输出格式"></a>指定输出格式</h2><p>默认不带任何输出参数时，是以较短结果输出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">kubectl get pod --output=wide</span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">kubectl get pod -o json</span><br><span class="line">kubectl get pod -o yaml</span><br></pre></td></tr></table></figure><h2 id="输出结果排序"><a href="#输出结果排序" class="headerlink" title="输出结果排序"></a>输出结果排序</h2><p>默认是以Pod名字排序</p><p>可以通过指定<code>--sort-by</code>来做排序</p><p>例如让Pod以宿主机名称排序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system -o wide --sort-by="&#123;.spec.nodeName&#125;"</span><br><span class="line"></span><br><span class="line">输出样例</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-scheduler-k8s-master              1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-k8s-master                        1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-k8s-master              1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-k8s-master     1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-mqcft            1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-lhxv5                       1/1     Running   1          6d21h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-86c58d9df4-wpk5p               1/1     Running   2          6d21h   10.244.1.10     k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">metrics-server-74845f6646-jqzcm        1/1     Running   2          6d21h   10.244.1.11     k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-xhd96            1/1     Running   2          6d22h   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-28tw2                       1/1     Running   1          6d21h   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-86c58d9df4-mbbxm               1/1     Running   2          6d21h   10.244.2.11     k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-t77hm                       1/1     Running   1          6d21h   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-57df4db6b-gk67k   1/1     Running   2          6d21h   10.244.2.13     k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-2rhs4            1/1     Running   2          6d22h   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">tiller-deploy-5b4c9697bf-q5dh6         1/1     Running   2          6d21h   10.244.2.12     k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="测试yaml文件，实际不生效"><a href="#测试yaml文件，实际不生效" class="headerlink" title="测试yaml文件，实际不生效"></a>测试yaml文件，实际不生效</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f demo.yaml --dry-run</span><br></pre></td></tr></table></figure><h2 id="生成模板文件"><a href="#生成模板文件" class="headerlink" title="生成模板文件"></a>生成模板文件</h2><p>yaml文件内容字段比较多，很难一下子想到所需的字段，可以通过kubectl命令来生成对应的模板</p><p>下面以deployment为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get deployment coredns -o yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: "1"</span><br><span class="line">  creationTimestamp: "2019-03-18T03:46:22Z"</span><br><span class="line">  generation: 1</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: "8560"</span><br><span class="line">  selfLink: /apis/extensions/v1beta1/namespaces/kube-system/deployments/coredns</span><br><span class="line">  uid: 65e22088-4930-11e9-93e0-00505634ce7c</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 2</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - -conf</span><br><span class="line">        - /etc/coredns/Corefile</span><br><span class="line">        image: k8s.gcr.io/coredns:1.2.6</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        name: coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 170Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          procMount: Default</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/coredns</span><br><span class="line">          name: config-volume</span><br><span class="line">          readOnly: true</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">      securityContext: &#123;&#125;</span><br><span class="line">      serviceAccount: coredns</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: CriticalAddonsOnly</span><br><span class="line">        operator: Exists</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/master</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - key: Corefile</span><br><span class="line">            path: Corefile</span><br><span class="line">          name: coredns</span><br><span class="line">        name: config-volume</span><br><span class="line">status:</span><br><span class="line">  availableReplicas: 2</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: "2019-03-18T03:46:37Z"</span><br><span class="line">    lastUpdateTime: "2019-03-18T03:51:36Z"</span><br><span class="line">    message: ReplicaSet "coredns-86c58d9df4" has successfully progressed.</span><br><span class="line">    reason: NewReplicaSetAvailable</span><br><span class="line">    status: "True"</span><br><span class="line">    type: Progressing</span><br><span class="line">  - lastTransitionTime: "2019-03-18T05:13:16Z"</span><br><span class="line">    lastUpdateTime: "2019-03-18T05:13:16Z"</span><br><span class="line">    message: Deployment has minimum availability.</span><br><span class="line">    reason: MinimumReplicasAvailable</span><br><span class="line">    status: "True"</span><br><span class="line">    type: Available</span><br><span class="line">  observedGeneration: 1</span><br><span class="line">  readyReplicas: 2</span><br><span class="line">  replicas: 2</span><br><span class="line">  updatedReplicas: 2</span><br></pre></td></tr></table></figure><h2 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a>创建资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除指定yaml定义的资源</span></span><br><span class="line">kubectl apply -f /path/to/yaml</span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">kubectl delete pod busybox</span><br><span class="line"><span class="comment"># 删除带k8s-app: busybox标签的pod</span></span><br><span class="line">kubectl delete pod -l k8s-app=busybox</span><br><span class="line"><span class="comment"># 删除所有pod</span></span><br><span class="line">kubectl delete pod --all</span><br></pre></td></tr></table></figure><h2 id="编辑资源"><a href="#编辑资源" class="headerlink" title="编辑资源"></a>编辑资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑名为CoreDNS的configmaps</span></span><br><span class="line">kubectl edit -n kube-system configmaps coredns</span><br><span class="line"><span class="comment"># 设置kube的编辑器</span></span><br><span class="line">KUBE_EDITOR=<span class="string">"nano"</span> kubectl edit configmaps coredns</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;h1 id=&quot;命令介绍&quot;&gt;&lt;a href=&quot;#命令介绍&quot; class=&quot;headerlink&quot; title=&quot;命令介绍&quot;&gt;&lt;/a&gt;命令介绍&lt;/h
      
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://luanlengli.github.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>如何生成kubeconfig文件</title>
    <link href="https://luanlengli.github.io/2019/02/12/%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90kubeconfig%E6%96%87%E4%BB%B6.html"/>
    <id>https://luanlengli.github.io/2019/02/12/如何生成kubeconfig文件.html</id>
    <published>2019-02-12T06:56:58.000Z</published>
    <updated>2019-05-20T08:35:52.737Z</updated>
    
    <content type="html"><![CDATA[<h2 id="修改cluster"><a href="#修改cluster" class="headerlink" title="修改cluster"></a>修改cluster</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-cluster CLUSTER_NAME \</span><br><span class="line">--certificate-authority=/path/to/ca \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=KUBE_APISERVER \</span><br><span class="line">--kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="修改user"><a href="#修改user" class="headerlink" title="修改user"></a>修改user</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials USERNAME \</span><br><span class="line">--client-certificate=/path/to/cert \</span><br><span class="line">--client-key=/path/to/key \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="修改context"><a href="#修改context" class="headerlink" title="修改context"></a>修改context</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context CONTEXT \</span><br><span class="line">--cluster=CLUSTER_NAME \</span><br><span class="line">--user=USERNAME \</span><br><span class="line">--kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="设置默认context"><a href="#设置默认context" class="headerlink" title="设置默认context"></a>设置默认context</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context CONTEXT --kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;修改cluster&quot;&gt;&lt;a href=&quot;#修改cluster&quot; class=&quot;headerlink&quot; title=&quot;修改cluster&quot;&gt;&lt;/a&gt;修改cluster&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td
      
    
    </summary>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes TLS Bootstrap与节点证书签发</title>
    <link href="https://luanlengli.github.io/2019/02/04/kubernetes-TLS-Bootstrap%E4%B8%8E%E8%8A%82%E7%82%B9%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%8F%91.html"/>
    <id>https://luanlengli.github.io/2019/02/04/kubernetes-TLS-Bootstrap与节点证书签发.html</id>
    <published>2019-02-04T05:03:18.000Z</published>
    <updated>2019-05-27T05:53:13.401Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Bootstrap初始化流程"><a href="#Bootstrap初始化流程" class="headerlink" title="Bootstrap初始化流程"></a>Bootstrap初始化流程</h1><blockquote><p>参考<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/" target="_blank" rel="noopener">官方文档</a></p></blockquote><ol><li>kubelet启动</li><li>kubelet发现没有<code>kubeconfig</code>文件</li><li>kubelet查找<code>bootstrap-kubeconfig</code>文件</li><li>kubelet读取<code>bootstrap-kubeconfig</code>文件，获取kube-apiserver的URL和最低权限的<code>token</code></li><li>kubelet具备了创建和检索CSR请求的受限<code>token</code></li><li>kubelet使用此<code>token</code>作为凭证与kube-apiserver通信</li><li>kubelet使用<code>bootstrap-kubeconfig</code>的CA证书为自己创建CSR（nodeclient）</li><li>CSR可以通过两种方式获得批准，批准之后下发证书（kubelet-client.crt）<ol><li>配置kube-controller-manager自动批准CSR</li><li>配置外部流程去通过kubernetes API或者kubectl去批准CSR</li></ol></li><li>kubelet使用密钥和证书创建kubeconfig文件</li><li>kubelet开始正常启动流程</li><li>可选：<ol><li>当证书接近到期时，kubelet会自动请求续订证书</li><li>证书的续订自动签发，可以参考CSR批准证书的过程</li></ol></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Bootstrap初始化流程&quot;&gt;&lt;a href=&quot;#Bootstrap初始化流程&quot; class=&quot;headerlink&quot; title=&quot;Bootstrap初始化流程&quot;&gt;&lt;/a&gt;Bootstrap初始化流程&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;参考&lt;a href=
      
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://luanlengli.github.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>以DaemonSet的方式运行kube-proxy</title>
    <link href="https://luanlengli.github.io/2019/01/08/%E4%BB%A5DaemonSet%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8Ckube-proxy.html"/>
    <id>https://luanlengli.github.io/2019/01/08/以DaemonSet的方式运行kube-proxy.html</id>
    <published>2019-01-08T02:23:31.000Z</published>
    <updated>2019-05-20T15:30:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>通常来说，二进制部署kubernetes集群的时候，一般都是把kube-proxy作为系统守护进程启动，例如注册成为systemd服务。</p><p>用过kubeadm的同学都知道，kubeadm是以DaemonSet的方式部署kube-proxy，将kube-proxy托管到kubernetes集群管理。</p><p>这样可以很方便的通过修改kube-proxy的configmap来统一管控集群的kube-proxy配置。</p><h1 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h1><h2 id="创建yaml文件"><a href="#创建yaml文件" class="headerlink" title="创建yaml文件"></a>创建yaml文件</h2><p>kube-proxy-daemonset.yaml</p><ul><li>根据情况替换<code>KUBE_APISERVER</code>和<code>KUBE_VERSION</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:kube-proxy</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:node-proxier</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">config.conf:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">    bindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    clientConnection:</span></span><br><span class="line"><span class="attr">      acceptContentTypes:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      burst:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      contentType:</span> <span class="string">application/vnd.kubernetes.protobuf</span></span><br><span class="line"><span class="attr">      kubeconfig:</span> <span class="string">/var/lib/kube-proxy/kubeconfig.conf</span></span><br><span class="line"><span class="attr">      qps:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment"># 集群中pod的CIDR范围，从这个范围以外发送到服务集群IP的流量将被伪装，从POD发送到外部LoadBalanceIP的流量将被定向到各自的集群IP</span></span><br><span class="line"><span class="attr">    clusterCIDR:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">    configSyncPeriod:</span> <span class="number">15</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">    conntrack:</span></span><br><span class="line">      <span class="comment"># 每个核心最大能跟踪的NAT连接数，默认32768</span></span><br><span class="line"><span class="attr">      maxPerCore:</span> <span class="number">32768</span></span><br><span class="line"><span class="attr">      min:</span> <span class="number">131072</span></span><br><span class="line"><span class="attr">      tcpCloseWaitTimeout:</span> <span class="number">1</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">      tcpEstablishedTimeout:</span> <span class="number">24</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">    enableProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10256</span></span><br><span class="line"><span class="attr">    hostnameOverride:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    iptables:</span></span><br><span class="line">      <span class="comment"># SNAT所有通过服务集群ip发送的通信</span></span><br><span class="line"><span class="attr">      masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      masqueradeBit:</span> <span class="number">14</span></span><br><span class="line"><span class="attr">      minSyncPeriod:</span> <span class="number">0</span><span class="string">s</span></span><br><span class="line"><span class="attr">      syncPeriod:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">    ipvs:</span></span><br><span class="line"><span class="attr">      minSyncPeriod:</span> <span class="number">0</span><span class="string">s</span></span><br><span class="line">      <span class="comment"># ipvs调度类型，默认是rr</span></span><br><span class="line"><span class="attr">      scheduler:</span> <span class="string">rr</span></span><br><span class="line"><span class="attr">      syncPeriod:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">    metricsBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10249</span></span><br><span class="line">    <span class="comment"># 使用ipvs模式</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">ipvs</span></span><br><span class="line"><span class="attr">    featureGates:</span></span><br><span class="line"><span class="attr">      SupportIPVSProxyMode:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    oomScoreAdj:</span> <span class="bullet">-999</span></span><br><span class="line"><span class="attr">    portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resourceContainer:</span> <span class="string">/kube-proxy</span></span><br><span class="line"><span class="attr">    udpIdleTimeout:</span> <span class="number">250</span><span class="string">ms</span></span><br><span class="line">  <span class="string">kubeconfig.conf:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">    clusters:</span></span><br><span class="line"><span class="attr">    - cluster:</span></span><br><span class="line"><span class="attr">        certificate-authority:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="attr">        server:</span> <span class="string">&#123;&#123;KUBE_APISERVER&#125;&#125;</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    contexts:</span></span><br><span class="line"><span class="attr">    - context:</span></span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">        user:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    users:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      user:</span></span><br><span class="line"><span class="attr">        tokenFile:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/usr/local/bin/kube-proxy</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--config=/var/lib/kube-proxy/config.conf</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">k8s.gcr.io/kube-proxy-amd64:&#123;&#123;KUBE_VERSION&#125;&#125;</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">        terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">host-time</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/var/lib/kube-proxy</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">lib-modules</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">beta.kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/disk-pressure</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/memory-pressure</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/unschedulable</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/network-unavailable</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - configMap:</span></span><br><span class="line"><span class="attr">          defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">FileOrCreate</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">lib-modules</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">host-time</span></span><br><span class="line"><span class="attr">  templateGeneration:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br></pre></td></tr></table></figure><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-proxy-daemonset.yaml</span><br></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;p&gt;通常来说，二进制部署kubernetes集群的时候，一般都是把kube-proxy作为系统守护进程启动，例如注册成为systemd服务。&lt;/
      
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://luanlengli.github.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>RHEL/CentOS升级OpenSSL和OpenSSH</title>
    <link href="https://luanlengli.github.io/2019/01/07/RHEL-CentOS%E5%8D%87%E7%BA%A7OpenSSL%E5%92%8COpenSSH.html"/>
    <id>https://luanlengli.github.io/2019/01/07/RHEL-CentOS升级OpenSSL和OpenSSH.html</id>
    <published>2019-01-07T15:01:46.000Z</published>
    <updated>2019-02-11T14:39:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><ul><li>本文以<code>openssl-1.0.2p</code>和<code>openssh-7.9p1</code>为例</li><li>先编译安装新版本的OpenSSL，然后基于新版本的OpenSSL编译安装OpenSSH</li><li>RHEL/CentOS-6.x和7.x的操作类似</li></ul></blockquote><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a><font color="red">注意事项</font></h1><blockquote><ul><li>请不要盲目复制粘贴</li><li>考虑好每一步的后果，做好备份</li><li>先拿测试服务器做白老鼠测试，通过之后再通过自动化部署的方式升级</li></ul></blockquote><h1 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h1><h2 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h2><p><a href="https://www.openssl.org/source/" target="_blank" rel="noopener">官网地址</a></p><h2 id="OpenSSH"><a href="#OpenSSH" class="headerlink" title="OpenSSH"></a>OpenSSH</h2><p><a href="https://www.openssh.com/portable.html" target="_blank" rel="noopener">官网地址</a></p><h1 id="检查当前版本"><a href="#检查当前版本" class="headerlink" title="检查当前版本"></a>检查当前版本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查openssl版本</span></span><br><span class="line">openssl version</span><br><span class="line"><span class="comment"># 检查ssh版本</span></span><br><span class="line">ssh -V</span><br><span class="line"><span class="comment"># 检查openssh-server版本</span></span><br><span class="line">sshd --version</span><br></pre></td></tr></table></figure><h1 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc make zlib-devel pam-devel libedit-devel krb5-devel</span><br></pre></td></tr></table></figure><h1 id="安装OpenSSL"><a href="#安装OpenSSL" class="headerlink" title="安装OpenSSL"></a>安装OpenSSL</h1><h2 id="解压源代码"><a href="#解压源代码" class="headerlink" title="解压源代码"></a>解压源代码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf openssl-1.0.2p.tar.gz</span><br></pre></td></tr></table></figure><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>编译选项参照CentOS-7.x软件包的<a href="https://git.centos.org/blob/rpms!!openssl/653b37a36fcfa8d53d73e34d10ac70e7aaafba1c/SPECS!openssl.spec" target="_blank" rel="noopener">选项</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> openssl-1.0.2p.tar.gz</span><br><span class="line">./config --prefix=/usr/<span class="built_in">local</span>/openssl-1.0.2p \</span><br><span class="line">         no-asm 386 \</span><br><span class="line">         zlib \</span><br><span class="line">         <span class="built_in">enable</span>-camellia \</span><br><span class="line">         <span class="built_in">enable</span>-seed \</span><br><span class="line">         <span class="built_in">enable</span>-tlsext \</span><br><span class="line">         <span class="built_in">enable</span>-rfc3779 \</span><br><span class="line">         <span class="built_in">enable</span>-cms \</span><br><span class="line">         <span class="built_in">enable</span>-md2 \</span><br><span class="line">         no-mdc2 \</span><br><span class="line">         no-rc5 \</span><br><span class="line">         no-ec2m \</span><br><span class="line">         no-gost \</span><br><span class="line">         no-srp \</span><br><span class="line">         --with-krb5-flavor=MIT \</span><br><span class="line">         shared</span><br><span class="line">make depend &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="备份旧版本的openssl"><a href="#备份旧版本的openssl" class="headerlink" title="备份旧版本的openssl"></a>备份旧版本的openssl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/bin/openssl /usr/bin/openssl.`date +%Y%m%d`bak</span><br><span class="line">mv /usr/include/openssl /usr/include/openssl.`date +%Y%m%d`bak</span><br><span class="line">mv /usr/lib64/openssl/engines /usr/lib64/openssl/engines.`date +%Y%m%d`bak</span><br></pre></td></tr></table></figure><h2 id="创建软链接到新版本openssl"><a href="#创建软链接到新版本openssl" class="headerlink" title="创建软链接到新版本openssl"></a>创建软链接到新版本openssl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -sv /usr/<span class="built_in">local</span>/openssl-1.0.2p/bin/openssl /usr/bin/openssl</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/openssl-1.0.2p/include/openssl /usr/include/openssl</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/openssl-1.0.2p/lib/engines/ /usr/lib64/openssl/engines</span><br></pre></td></tr></table></figure><h2 id="创建新版本的链接库"><a href="#创建新版本的链接库" class="headerlink" title="创建新版本的链接库"></a>创建新版本的链接库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/ld.so.conf.d/openssl-1.0.2p.conf &lt;&lt;EOF</span><br><span class="line"><span class="comment"># OpenSSL 1.0.2p</span></span><br><span class="line">/usr/<span class="built_in">local</span>/openssl-1.0.2p/lib</span><br><span class="line">EOF</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><h2 id="检查openssl版本"><a href="#检查openssl版本" class="headerlink" title="检查openssl版本"></a>检查openssl版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl version</span><br></pre></td></tr></table></figure><h1 id="安装OpenSSH"><a href="#安装OpenSSH" class="headerlink" title="安装OpenSSH"></a>安装OpenSSH</h1><h2 id="解压源代码-1"><a href="#解压源代码-1" class="headerlink" title="解压源代码"></a>解压源代码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf openssh-7.9p1.tar.gz</span><br></pre></td></tr></table></figure><h2 id="使用新版OpenSSL编译安装OpenSSH"><a href="#使用新版OpenSSL编译安装OpenSSH" class="headerlink" title="使用新版OpenSSL编译安装OpenSSH"></a>使用新版OpenSSL编译安装OpenSSH</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> openssh-7.9p1</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/openssh-7.9p1 \</span><br><span class="line">            --with-ssl-dir=/usr/<span class="built_in">local</span>/openssl-1.0.2p \</span><br><span class="line">            --with-md5-passwords \</span><br><span class="line">            --with-mantype=man \</span><br><span class="line">            --<span class="built_in">disable</span>-strip \</span><br><span class="line">            --with-smartcard \</span><br><span class="line">            --with-pam \</span><br><span class="line">            --with-kerberos5</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="备份替换OpenSSH"><a href="#备份替换OpenSSH" class="headerlink" title="备份替换OpenSSH"></a>备份替换OpenSSH</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> binary <span class="keyword">in</span> `ls /usr/<span class="built_in">local</span>/openssh-7.9p1/bin/`;<span class="keyword">do</span></span><br><span class="line">    mv /usr/bin/<span class="variable">$&#123;binary&#125;</span> /usr/bin/<span class="variable">$&#123;binary&#125;</span>.`date +%Y%m%d`bak</span><br><span class="line">    ln -sv /usr/<span class="built_in">local</span>/openssh-7.9p1/bin/<span class="variable">$&#123;binary&#125;</span> /usr/bin/<span class="variable">$&#123;binary&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">exec</span> <span class="keyword">in</span> `ls /usr/<span class="built_in">local</span>/openssh-7.9p1/libexec/`;<span class="keyword">do</span></span><br><span class="line">    mv /usr/libexec/openssh/<span class="variable">$&#123;exec&#125;</span> /usr/libexec/openssh/<span class="variable">$&#123;exec&#125;</span>.`date +%Y%m%d`bak</span><br><span class="line">    ln -sv /usr/<span class="built_in">local</span>/openssh-7.9p1/libexec/<span class="variable">$&#123;exec&#125;</span> /usr/libexec/openssh/<span class="variable">$&#123;exec&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sbinary <span class="keyword">in</span> `ls /usr/<span class="built_in">local</span>/openssh-7.9p1/sbin/`;<span class="keyword">do</span></span><br><span class="line">    mv /usr/sbin/<span class="variable">$&#123;sbinary&#125;</span> /usr/sbin/<span class="variable">$&#123;sbinary&#125;</span>.`date +%Y%m%d`bak</span><br><span class="line">    ln -sv /usr/<span class="built_in">local</span>/openssh-7.9p1/sbin/<span class="variable">$&#123;sbinary&#125;</span> /usr/sbin/<span class="variable">$&#123;sbinary&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="链接配置目录到新版本的OpenSSH"><a href="#链接配置目录到新版本的OpenSSH" class="headerlink" title="链接配置目录到新版本的OpenSSH"></a>链接配置目录到新版本的OpenSSH</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/<span class="built_in">local</span>/openssh-7.9p1/etc /usr/<span class="built_in">local</span>/openssh-7.9p1/etc.bak</span><br><span class="line">ln -sv /etc/ssh /usr/<span class="built_in">local</span>/openssh-7.9p1/etc</span><br><span class="line">find /etc/ssh/ -name <span class="string">'*key'</span> -<span class="built_in">exec</span> chmod 0400 &#123;&#125; \;</span><br></pre></td></tr></table></figure><h2 id="检查SSH配置"><a href="#检查SSH配置" class="headerlink" title="检查SSH配置"></a>检查SSH配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshd -t -f /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><h2 id="重启SSH服务"><a href="#重启SSH服务" class="headerlink" title="重启SSH服务"></a>重启SSH服务</h2><blockquote><ul><li>RHEL/CentOS-6.x</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></table></figure><blockquote><ul><li>RHEL/CentOS-7.x</li></ul></blockquote><p>修改<code>/usr/lib/systemd/system/sshd.service</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/sshd.service</span><br><span class="line">...</span><br><span class="line">Type=simple</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>重启sshd服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><h2 id="检查OpenSSH版本"><a href="#检查OpenSSH版本" class="headerlink" title="检查OpenSSH版本"></a>检查OpenSSH版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -V</span><br><span class="line">sshd --version</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;本文以&lt;code&gt;openssl-1.0.2p&lt;/code&gt;和&lt;code&gt;openssh-7.9p1&lt;/c
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>etcd学习笔记</title>
    <link href="https://luanlengli.github.io/2018/12/22/etcd%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://luanlengli.github.io/2018/12/22/etcd学习笔记.html</id>
    <published>2018-12-22T08:49:18.000Z</published>
    <updated>2019-02-14T06:31:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>kubernetes底层数据存放在etcd中，这里记录一下学习的笔记。</p><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><ul><li>Etcd 是 CoreOS 推出的分布式一致性键值存储，用于共享配置和服务发现</li><li>Etcd 支持集群模式部署，从而实现自身高可用</li><li>本文以<code>CentOS-7.6</code>和<code>etcd-v3.3.10</code>为例</li></ul></blockquote><h1 id="etcd安装"><a href="#etcd安装" class="headerlink" title="etcd安装"></a>etcd安装</h1><h2 id="二进制文件安装"><a href="#二进制文件安装" class="headerlink" title="二进制文件安装"></a>二进制文件安装</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载并解压</span></span><br><span class="line">wget -q -O - https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz | tar xz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看解压后的文件</span></span><br><span class="line">ls etcd-v3.3.10-linux-amd64</span><br><span class="line">Documentation  etcd  etcdctl  README-etcdctl.md  README.md  READMEv2-etcdctl.md</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将二进制执行文件移动到/usr/<span class="built_in">local</span>/bin/</span></span><br><span class="line">mv etcd-v3.3.10-linux-amd64/etcd etcd-v3.3.10-linux-amd64/etcdctl /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r etcd</span><br><span class="line">useradd -r -g etcd -s /bin/false etcd</span><br></pre></td></tr></table></figure><h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/etcd /etc/etcd/</span><br></pre></td></tr></table></figure><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>创建配置文件etcd.config.yaml，内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'default'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/default.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="attr">http://localhost:2380</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="attr">http://localhost:2380</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">[stderr]</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h4 id="创建服务文件"><a href="#创建服务文件" class="headerlink" title="创建服务文件"></a>创建服务文件</h4><p>使用systemd托管etcd的服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd key-value store</span><br><span class="line">Documentation=https://github.com/etcd-io/etcd</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=etcd</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file /etc/etcd/etcd.config.yaml</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="运行etcd"><a href="#运行etcd" class="headerlink" title="运行etcd"></a>运行etcd</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R etcd:etcd /var/lib/etcd /etc/etcd</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd.service</span><br></pre></td></tr></table></figure><h3 id="验证etcd服务"><a href="#验证etcd服务" class="headerlink" title="验证etcd服务"></a>验证etcd服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl cluster-health</span><br><span class="line">member 8e9e05c52164694d is healthy: got healthy result from http://localhost:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure><h1 id="etcd集群部署"><a href="#etcd集群部署" class="headerlink" title="etcd集群部署"></a>etcd集群部署</h1><h2 id="构建集群的方式"><a href="#构建集群的方式" class="headerlink" title="构建集群的方式"></a>构建集群的方式</h2><h3 id="静态发现"><a href="#静态发现" class="headerlink" title="静态发现"></a>静态发现</h3><p>预先已知 Etcd 集群中有哪些节点，在启动时直接指定好 Etcd 的各个 node 节点地址</p><h3 id="动态发现"><a href="#动态发现" class="headerlink" title="动态发现"></a>动态发现</h3><p>通过已有的 Etcd 集群作为数据交互点，然后在扩展新的集群时实现通过已有集群进行服务发现的机制</p><h3 id="DNS动态发现"><a href="#DNS动态发现" class="headerlink" title="DNS动态发现"></a>DNS动态发现</h3><p>通过 DNS 查询方式获取其他节点地址信息</p><h2 id="节点信息"><a href="#节点信息" class="headerlink" title="节点信息"></a>节点信息</h2><font color="red">这里只提供静态发现部署etcd集群的流程</font><table><thead><tr><th style="text-align:center">IP地址</th><th style="text-align:center">主机名</th><th style="text-align:center">CPU</th><th style="text-align:center">内存</th></tr></thead><tbody><tr><td style="text-align:center">172.16.80.201</td><td style="text-align:center">etcd1</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.202</td><td style="text-align:center">etcd2</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.203</td><td style="text-align:center">etcd3</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr></tbody></table><h2 id="静态发现部署etcd集群"><a href="#静态发现部署etcd集群" class="headerlink" title="静态发现部署etcd集群"></a>静态发现部署etcd集群</h2><h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><h4 id="etcd1"><a href="#etcd1" class="headerlink" title="etcd1"></a>etcd1</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'etcd1'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/etcd1.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">'http://172.16.80.201:2380'</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">'http://172.16.80.201:2379,http://127.0.0.1:2379'</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">'http://172.16.80.201:2380'</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">'http://172.16.80.201:2379'</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">'etcd1=http://172.16.80.201:2380,etcd2=http://172.16.80.202:2380,etcd3=http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">['stderr']</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h4 id="etcd2"><a href="#etcd2" class="headerlink" title="etcd2"></a>etcd2</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'etcd2'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/etcd2.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">'http://172.16.80.202:2380'</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">'http://172.16.80.202:2379,http://127.0.0.1:2379'</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">'http://172.16.80.202:2380'</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">'http://172.16.80.202:2379'</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">'etcd1=http://172.16.80.201:2380,etcd2=http://172.16.80.202:2380,etcd3=http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">[stderr]</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h4 id="etcd3"><a href="#etcd3" class="headerlink" title="etcd3"></a>etcd3</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'etcd3'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/etcd3.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">'http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">'http://172.16.80.203:2379,http://127.0.0.1:2379'</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">'http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">'http://172.16.80.203:2379'</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">'etcd1=http://172.16.80.201:2380,etcd2=http://172.16.80.202:2380,etcd3=http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">[stderr]</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h3 id="启动etcd集群"><a href="#启动etcd集群" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for NODE in 172.16.80.201 172.16.80.202 172.16.80.203;do</span><br><span class="line">ssh $NODE systemctl enable etcd</span><br><span class="line">ssh $NODE systemctl start etcd &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="检查etcd集群"><a href="#检查etcd集群" class="headerlink" title="检查etcd集群"></a>检查etcd集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=2</span><br><span class="line">etcdctl --endpoints 'http://172.16.80.201:2379,http://172.16.80.202:2379,http://172.16.80.202:2379' cluster-health</span><br><span class="line">member 222fd3b0bb4a5931 is healthy: got healthy result from http://172.16.80.203:2379</span><br><span class="line">member 8349ef180b115a83 is healthy: got healthy result from http://172.16.80.201:2379</span><br><span class="line">member f525d2d797a7c465 is healthy: got healthy result from http://172.16.80.202:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints='http://172.16.80.201:2379,http://172.16.80.202:2379,http://172.16.80.202:2379' endpoint health</span><br><span class="line">http://172.16.80.201:2379 is healthy: successfully committed proposal: took = 2.879402ms</span><br><span class="line">http://172.16.80.203:2379 is healthy: successfully committed proposal: took = 6.708566ms</span><br><span class="line">http://172.16.80.202:2379 is healthy: successfully committed proposal: took = 7.187607ms</span><br></pre></td></tr></table></figure><h1 id="SSL-TLS加密"><a href="#SSL-TLS加密" class="headerlink" title="SSL/TLS加密"></a>SSL/TLS加密</h1><blockquote><ul><li>此段翻译自<a href="https://coreos.com/etcd/docs/latest/op-guide/security.html" target="_blank" rel="noopener">官方文档</a></li></ul></blockquote><p>etcd支持自动TLS、客户端证书身份认证、客户端到服务器端以及对等集群的加密通信</p><h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><p>为方便起见，这里使用<code>CFSSL</code>工具生成证书</p><h3 id="下载CFSSL"><a href="#下载CFSSL" class="headerlink" title="下载CFSSL"></a>下载CFSSL</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">curl -s -L -o ~/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">curl -s -L -o ~/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x ~/bin/&#123;cfssl,cfssljson&#125;</span><br><span class="line">export PATH=$PATH:~/bin</span><br></pre></td></tr></table></figure><h3 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/cfssl</span><br><span class="line">cd ~/cfssl</span><br></pre></td></tr></table></figure><h3 id="创建默认配置文件"><a href="#创建默认配置文件" class="headerlink" title="创建默认配置文件"></a>创建默认配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults config &gt; ca-config.json</span><br><span class="line">cfssl print-defaults csr &gt; ca-csr.json</span><br></pre></td></tr></table></figure><h3 id="证书类型介绍"><a href="#证书类型介绍" class="headerlink" title="证书类型介绍"></a>证书类型介绍</h3><ul><li><strong>客户端证书</strong>用于服务器验证客户端身份</li><li><strong>服务器端证书</strong>用于客户端验证服务器端身份</li><li><strong>对等证书</strong>由etcd集群成员使用，同时使用<strong>客户端认证</strong>和<strong>服务器端认证</strong></li></ul><h3 id="配置CA"><a href="#配置CA" class="headerlink" title="配置CA"></a>配置CA</h3><p>修改<code>ca-config.json</code></p><p><strong>说明</strong></p><ul><li><code>expiry</code>定义过期时间，这里的43800h为5年</li><li><code>usages</code>字段定义用途<ul><li><code>signing</code>代表可以用于签发其他证书</li><li><code>key encipherment</code>代表将密钥加密</li><li><code>server auth</code></li><li><code>client auth</code></li></ul></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"signing"</span>: &#123;</span><br><span class="line">        <span class="attr">"default"</span>: &#123;</span><br><span class="line">            <span class="attr">"expiry"</span>: <span class="string">"43800h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"profiles"</span>: &#123;</span><br><span class="line">            <span class="attr">"server"</span>: &#123;</span><br><span class="line">                <span class="attr">"expiry"</span>: <span class="string">"43800h"</span>,</span><br><span class="line">                <span class="attr">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"client"</span>: &#123;</span><br><span class="line">                <span class="attr">"expiry"</span>: <span class="string">"43800h"</span>,</span><br><span class="line">                <span class="attr">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"peer"</span>: &#123;</span><br><span class="line">                <span class="attr">"expiry"</span>: <span class="string">"43800h"</span>,</span><br><span class="line">                <span class="attr">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置证书请求"><a href="#配置证书请求" class="headerlink" title="配置证书请求"></a>配置证书请求</h3><p>修改<code>ca-csr.json</code>，可以根据自己的需求修改对应字段</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"CN"</span>: <span class="string">"My own CA"</span>,</span><br><span class="line">    <span class="attr">"key"</span>: &#123;</span><br><span class="line">        <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"C"</span>: <span class="string">"US"</span>,</span><br><span class="line">            <span class="attr">"L"</span>: <span class="string">"CA"</span>,</span><br><span class="line">            <span class="attr">"O"</span>: <span class="string">"My Company Name"</span>,</span><br><span class="line">            <span class="attr">"ST"</span>: <span class="string">"San Francisco"</span>,</span><br><span class="line">            <span class="attr">"OU"</span>: <span class="string">"Org Unit 1"</span>,</span><br><span class="line">            <span class="attr">"OU"</span>: <span class="string">"Org Unit 2"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="生成CA证书"><a href="#生成CA证书" class="headerlink" title="生成CA证书"></a>生成CA证书</h3><p>运行以下命令生成CA证书</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ca-key.pem</span><br><span class="line">ca.csr</span><br><span class="line">ca.pem</span><br></pre></td></tr></table></figure><ul><li>ca-key.pem为CA的私钥，请妥善保管</li><li>csr文件为证书请求文件，可以删除</li></ul><h3 id="生成服务器端证书"><a href="#生成服务器端证书" class="headerlink" title="生成服务器端证书"></a>生成服务器端证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; server.json</span><br></pre></td></tr></table></figure><p>修改<code>server.json</code>的<strong>CN</strong>和<strong>hosts</strong>字段，<code>names</code>字段按需修改</p><p><strong>说明</strong></p><ul><li><strong>hosts</strong>字段为列表，服务器端需要将自己作为客户端访问集群，可以使用<code>hostname</code>或者<code>IP地址</code>的形式定义hosts</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"CN"</span>: <span class="string">"example.net"</span>,</span><br><span class="line">    <span class="attr">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"192.168.1.1"</span>,</span><br><span class="line">        <span class="string">"ext.example.com"</span>,</span><br><span class="line">        <span class="string">"coreos1.local"</span>,</span><br><span class="line">        <span class="string">"coreos1"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"key"</span>: &#123;</span><br><span class="line">        <span class="attr">"algo"</span>: <span class="string">"ecdsa"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">256</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"C"</span>: <span class="string">"US"</span>,</span><br><span class="line">            <span class="attr">"L"</span>: <span class="string">"CA"</span>,</span><br><span class="line">            <span class="attr">"ST"</span>: <span class="string">"San Francisco"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建服务器端证书和私钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server server.json | cfssljson -bare server</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server-key.pem</span><br><span class="line">server.csr</span><br><span class="line">server.pem</span><br></pre></td></tr></table></figure><h3 id="生成客户端证书"><a href="#生成客户端证书" class="headerlink" title="生成客户端证书"></a>生成客户端证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; client.json</span><br></pre></td></tr></table></figure><p>修改<code>client.json</code>，客户端证书不需要hosts字段，只需要CN字段设置为<code>client</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    "CN": "client",</span><br><span class="line">    "hosts": [""],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>创建客户端证书和私钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client.json | cfssljson -bare client</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">client-key.pem</span><br><span class="line">client.csr</span><br><span class="line">client.pem</span><br></pre></td></tr></table></figure><h3 id="生成对等证书"><a href="#生成对等证书" class="headerlink" title="生成对等证书"></a>生成对等证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; member1.json</span><br></pre></td></tr></table></figure><p>修改<code>member1.json</code>的<strong>CN</strong>字段和<strong>hosts</strong>字段</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    "CN": "member1",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "192.168.122.101",</span><br><span class="line">        "ext.example.com",</span><br><span class="line">        "member1.local",</span><br><span class="line">        <span class="string">"member1"</span></span><br><span class="line">    ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>创建<code>member1</code>的证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer member1.json | cfssljson -bare member1</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">member1-key.pem</span><br><span class="line">member1.csr</span><br><span class="line">member1.pem</span><br></pre></td></tr></table></figure><p>对于多个member需要重复此操作，用于生成相对应的对等证书</p><h3 id="验证证书"><a href="#验证证书" class="headerlink" title="验证证书"></a>验证证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in ca.pem -text -noout</span><br><span class="line">openssl x509 -in server.pem -text -noout</span><br><span class="line">openssl x509 -in client.pem -text -noout</span><br><span class="line">openssl x509 -in member1.pem -text -noout</span><br></pre></td></tr></table></figure><h2 id="示例1、客户端使用HTTPS传输数据给服务器端"><a href="#示例1、客户端使用HTTPS传输数据给服务器端" class="headerlink" title="示例1、客户端使用HTTPS传输数据给服务器端"></a>示例1、客户端使用HTTPS传输数据给服务器端</h2><p>准备CA证书<code>ca.pem</code>，密钥对<code>server.pem</code> <code>server-key.pem</code></p><h3 id="启动服务器端"><a href="#启动服务器端" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><p>启动参数如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra0 \</span><br><span class="line">--data-dir /var/lib/etcd/infra0 \</span><br><span class="line">--cert-file=/path/to/server.pem \</span><br><span class="line">--key-file=/path/to/server-key.pem \</span><br><span class="line">--advertise-client-urls=https://127.0.0.1:2379 \</span><br><span class="line">--listen-client-urls=https://127.0.0.1:2379</span><br></pre></td></tr></table></figure><h3 id="客户端使用HTTPS访问服务器端"><a href="#客户端使用HTTPS访问服务器端" class="headerlink" title="客户端使用HTTPS访问服务器端"></a>客户端使用HTTPS访问服务器端</h3><p>使用<code>curl</code>加载CA证书测试HTTPS连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /path/to/ca.pem \</span><br><span class="line">https://127.0.0.1:2379/v2/keys/foo \</span><br><span class="line">-X PUT \</span><br><span class="line">-d value=bar \</span><br><span class="line">-v</span><br></pre></td></tr></table></figure><h2 id="示例2、客户端使用客户端证书作为身份验证访问服务器端"><a href="#示例2、客户端使用客户端证书作为身份验证访问服务器端" class="headerlink" title="示例2、客户端使用客户端证书作为身份验证访问服务器端"></a>示例2、客户端使用客户端证书作为身份验证访问服务器端</h2><p>在示例1的基础上，需要客户端证书<code>client.pem</code>和<code>client-key.pem</code></p><h3 id="启动服务器端-1"><a href="#启动服务器端-1" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><p>启动参数如下，这里比示例1多了<code>client-cert-auth</code>和<code>truested-ca-file</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra0 \</span><br><span class="line">--data-dir /var/lib/etcd/infra0 \</span><br><span class="line">--cert-file=/path/to/server.pem \</span><br><span class="line">--key-file=/path/to/server-key.pem \</span><br><span class="line">--advertise-client-urls=https://127.0.0.1:2379 \</span><br><span class="line">--listen-client-urls=https://127.0.0.1:2379 \</span><br><span class="line">--client-cert-auth \</span><br><span class="line">--trusted-ca-file=/path/to/ca.crt</span><br></pre></td></tr></table></figure><p>重复示例1的访问</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /path/to/ca.crt https://127.0.0.1:2379/v2/keys/foo -XPUT -d value=bar -v</span><br></pre></td></tr></table></figure><p>此命令结果会提示被服务器端拒绝</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">routines:SSL3_READ_BYTES:sslv3 alert bad certificate</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>使用客户端证书访问服务器端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /path/to/ca.pem \</span><br><span class="line">--cert /path/to/client.pem \</span><br><span class="line">--key /path/to/client-key.pem \</span><br><span class="line">-L https://127.0.0.1:2379/v2/keys/foo \</span><br><span class="line">-X PUT \</span><br><span class="line">-d value=bar \</span><br><span class="line">-v</span><br></pre></td></tr></table></figure><p>命令结果包含以下信息</p><ul><li>身份认证成功</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">SSLv3, TLS handshake, CERT verify (15):</span><br><span class="line">...</span><br><span class="line">TLS handshake, Finished (20)</span><br></pre></td></tr></table></figure><h2 id="示例3、在集群中传输安全和客户端证书"><a href="#示例3、在集群中传输安全和客户端证书" class="headerlink" title="示例3、在集群中传输安全和客户端证书"></a>示例3、在集群中传输安全和客户端证书</h2><p>这里需要为每个member配备对应的member证书，操作步骤见生成证书部分</p><p>假设有2个member，这两个member都已生成对应的证书(<code>member1.pem</code>、<code>member1-key.pem</code>、<code>member2.pem</code>、<code>member2-key.pem</code>)</p><p>etcd 成员将组成一个集群，集群中成员之间的所有通信将使用客户端证书进行加密和验证。</p><p>etcd的输出将显示其连接的地址使用HTTPS。</p><h3 id="启动服务器端-2"><a href="#启动服务器端-2" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><p>从<a href="https://discovery.etcd.io/new获取discovery_url作为启动集群的发现服务" target="_blank" rel="noopener">https://discovery.etcd.io/new获取discovery_url作为启动集群的发现服务</a></p><p>发现服务可以在内网环境搭建，详见<a href="https://github.com/coreos/discovery.etcd.io" target="_blank" rel="noopener">github地址</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISCOVERY_URL=$(curl https://discovery.etcd.io/new)</span><br></pre></td></tr></table></figure><h4 id="member1"><a href="#member1" class="headerlink" title="member1"></a>member1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra1 \</span><br><span class="line">--data-dir /var/lib/etcd/infra1 \</span><br><span class="line">--peer-client-cert-auth \</span><br><span class="line">--peer-trusted-ca-file=/path/to/ca.pem \</span><br><span class="line">--peer-cert-file=/path/to/member1.pem \</span><br><span class="line">--peer-key-file=/path/to/member1-key.pem \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h4 id="member2"><a href="#member2" class="headerlink" title="member2"></a>member2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra2 \</span><br><span class="line">--data-dir /var/lib/etcd/infra2 \</span><br><span class="line">--peer-client-cert-auth \</span><br><span class="line">--peer-trusted-ca-file=/path/to/ca.pem \</span><br><span class="line">--peer-cert-file=/path/to/member2.pem \</span><br><span class="line">--peer-key-file=/path/to/member2-key.pem \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h2 id="示例4、自动自签名"><a href="#示例4、自动自签名" class="headerlink" title="示例4、自动自签名"></a>示例4、自动自签名</h2><p>对于只需要加密传输数据而不需要身份验证的场景，etcd支持使用自动生成的自签名证书加密传输数据</p><h3 id="启动服务器端-3"><a href="#启动服务器端-3" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISCOVERY_URL=$(curl https://discovery.etcd.io/new)</span><br></pre></td></tr></table></figure><h4 id="member1-1"><a href="#member1-1" class="headerlink" title="member1"></a>member1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra1 \</span><br><span class="line">--data-dir /var/lib/etcd/infra1 \</span><br><span class="line">--auto-tls \</span><br><span class="line">--peer-auto-tls \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h4 id="member2-1"><a href="#member2-1" class="headerlink" title="member2"></a>member2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra2 \</span><br><span class="line">--data-dir /var/lib/etcd/infra2 \</span><br><span class="line">--auto-tls \</span><br><span class="line">--peer-auto-tls \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>由于自签名证书不会进行身份认证，因此curl会返回错误，因此需要添加<code>-k</code>参数禁用证书链检查</p><h1 id="etcd维护操作"><a href="#etcd维护操作" class="headerlink" title="etcd维护操作"></a>etcd维护操作</h1><h2 id="请求最大字节数"><a href="#请求最大字节数" class="headerlink" title="请求最大字节数"></a>请求最大字节数</h2><p><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/dev-guide/limit.md" target="_blank" rel="noopener">官网文档说明</a></p><p><code>max-request-bytes</code>限制请求的大小，默认值是<code>1572864</code>，即1.5M。在某些场景可能会出现请求过大导致无法写入的情况，可以调大到<code>10485760</code>即10M。</p><h2 id="快照条目数量调整"><a href="#快照条目数量调整" class="headerlink" title="快照条目数量调整"></a>快照条目数量调整</h2><p><code>--snapshot-count</code>：指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘。从v3.2开始，<code>--snapshot-count</code>的默认值已从10000更改为100000。</p><blockquote><p><strong>注意</strong></p><p>此参数具体数值可以通过根据实际情况调整</p><p>过低会带来频繁的IO压力，影响集群可用性和写入吞吐量。</p><p>过高则导致内存占用过高以及会让etcd的GC变慢</p></blockquote><h2 id="历史数据压缩（针对v3的API）"><a href="#历史数据压缩（针对v3的API）" class="headerlink" title="历史数据压缩（针对v3的API）"></a>历史数据压缩（针对v3的API）</h2><p>由于etcd保存了key的历史记录，因此能通过MVCC机制获取多版本的数据，需要定期压缩历史记录避免性能下降和空间耗尽。</p><p>到达上限阈值时，集群将处于只读和只能删除key的状态，无法写操作。</p><p>历史数据压缩只是针对数据的历史版本进行清理，清理之后只能读取到清理点之后的历史版本</p><h3 id="手动压缩"><a href="#手动压缩" class="headerlink" title="手动压缩"></a>手动压缩</h3><p>清理revision为3之前的历史数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl compact 3</span><br></pre></td></tr></table></figure><p>清理之后，访问revision3之前的数据会提示不存在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl get KEY_NAME --rev=2</span><br><span class="line">Error:  etcdserver: mvcc: required revision has been compacted</span><br></pre></td></tr></table></figure><h3 id="自动压缩"><a href="#自动压缩" class="headerlink" title="自动压缩"></a>自动压缩</h3><p>启动参数中添加<code>--auto-compaction-retention=1</code>即为每小时压缩一次</p><h2 id="碎片整理-针对v3的API"><a href="#碎片整理-针对v3的API" class="headerlink" title="碎片整理(针对v3的API)"></a>碎片整理(针对v3的API)</h2><p>在数据压缩操作之后，旧的revision被压缩，会产生内部碎片，这些内部碎片可以被etcd使用，但是仍消耗磁盘空间。</p><p>碎片整理就是将这部分空间释放出来。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl defrag</span><br></pre></td></tr></table></figure><h2 id="空间配额"><a href="#空间配额" class="headerlink" title="空间配额"></a>空间配额</h2><p>etcd通过<code>--quota-backend-bytes</code>参数来限制etcd数据库的大小，以字节为单位。</p><p>默认是<code>2147483648</code>即2GB，最大值为<code>8589934592</code>即8GB。</p><p>容量限制见<a href="https://coreos.com/etcd/docs/latest/dev-guide/limit.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="数据备份-针对v3的API"><a href="#数据备份-针对v3的API" class="headerlink" title="数据备份(针对v3的API)"></a>数据备份(针对v3的API)</h2><h3 id="快照备份"><a href="#快照备份" class="headerlink" title="快照备份"></a>快照备份</h3><p>通过快照etcd集群可以作备份数据的用途。</p><p>可以通过快照备份的数据，将etcd集群恢复到快照的时间点。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl snapshot save /path/to/snapshot.db</span><br></pre></td></tr></table></figure><p>检查快照状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcd --write-out=table snapshot status /path/to/snapshot.db</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">| dd97719a |    24276 |       1113 |     3.0 MB |</span><br><span class="line">+----------+----------+------------+------------+</span><br></pre></td></tr></table></figure><h3 id="基于快照的定期备份脚本"><a href="#基于快照的定期备份脚本" class="headerlink" title="基于快照的定期备份脚本"></a>基于快照的定期备份脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">TIME=$(date +%Y%m%d)</span><br><span class="line">HOUR=$(date +%H)</span><br><span class="line">BACKUP_DIR="/data/etcd_backup/$&#123;TIME&#125;"</span><br><span class="line">mkdir -p $BACKUP_DIR</span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">/usr/local/bin/etcdctl --cacert=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">                       --cert=/etc/etcd/ssl/etcd-client.pem \</span><br><span class="line">                       --key=/etc/etcd/ssl/etcd-client-key.pem \</span><br><span class="line">                       --endpoints=https://member1:2379,https://member2:2379,https://member3:2379 \</span><br><span class="line">                       snapshot save $BACKUP_DIR/snapshot-$&#123;HOUR&#125;.db</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清理2天前的etcd备份</span></span><br><span class="line">find /data/etcd_backup -type d -mtime +2 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><h2 id="etcd镜像集群-针对v3的API"><a href="#etcd镜像集群-针对v3的API" class="headerlink" title="etcd镜像集群(针对v3的API)"></a>etcd镜像集群(针对v3的API)</h2><p>通过mirror-maker实时做镜像的方式同步数据，如果出现主机房服务挂了可以通过切换域名的形式切换到灾备机房；这个过程中数据是可以保持一致的。</p><p>提前部署好两套etcd集群之后，可以在主集群上面运行以下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl make-mirror --no-dest-prefix=true http://mirror1:2379,http://mirror2:2379,http://mirror3:2379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">488</span><br><span class="line">546</span><br><span class="line">604</span><br><span class="line">662</span><br><span class="line">720</span><br><span class="line">778</span><br><span class="line">836</span><br><span class="line">894</span><br><span class="line">950</span><br><span class="line">1009</span><br><span class="line">1067</span><br><span class="line">1125</span><br><span class="line">1183</span><br><span class="line">1241</span><br></pre></td></tr></table></figure><blockquote><p>make-mirror的输出为30s一次，程序为前台运行，可以通过nohup &gt;/path/to/log 2&gt;&amp;1 &amp;的方式扔到后台运行</p></blockquote><h1 id="etcd监控"><a href="#etcd监控" class="headerlink" title="etcd监控"></a>etcd监控</h1><h2 id="debug-endpoint"><a href="#debug-endpoint" class="headerlink" title="debug endpoint"></a>debug endpoint</h2><p>启动参数中添加<code>--debug</code>即可打开debug模式，etcd会在<code>http://x.x.x.x:2379/debug</code>路径下输出debug信息。</p><p>由于debug信息很多，会导致性能下降。</p><p><code>/debug/pprof</code>为go语言runtime的endpoint，可以用于分析CPU、heap、mutex和goroutine利用率。</p><p>这里示例为使用go命令获取etcd最耗时的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go tool pprof http://127.0.0.1:2379/debug/pprof/profile</span></span><br><span class="line">Fetching profile over HTTP from http://127.0.0.1:2379/debug/pprof/profile</span><br><span class="line">Saved profile in /root/pprof/pprof.etcd-3.2.24.samples.cpu.001.pb.gz</span><br><span class="line">File: etcd-3.2.24</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Feb 10, 2019 at 9:57pm (CST)</span><br><span class="line">Duration: 30s, Total samples = 60ms (  0.2%)</span><br><span class="line">Entering interactive mode (type "help" for commands, "o" for options)</span><br><span class="line">(pprof) </span><br><span class="line">(pprof) </span><br><span class="line">(pprof) top10</span><br><span class="line">Showing nodes accounting for 60ms, 100% of 60ms total</span><br><span class="line">Showing top 10 nodes out of 25</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">      60ms   100%   100%       60ms   100%  runtime.futex</span><br><span class="line">         0     0%   100%       10ms 16.67%  github.com/coreos/etcd/cmd/vendor/github.com/coreos/etcd/etcdserver.(*raftNode).start.func1</span><br><span class="line">         0     0%   100%       10ms 16.67%  github.com/coreos/etcd/cmd/vendor/github.com/coreos/etcd/etcdserver.(*raftNode).tick</span><br><span class="line">         0     0%   100%       10ms 16.67%  github.com/coreos/etcd/cmd/vendor/github.com/coreos/etcd/raft.(*node).Tick</span><br><span class="line">         0     0%   100%       20ms 33.33%  runtime.chansend</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscall</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscallfast</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscallfast.func1</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscallfast_pidle</span><br><span class="line">         0     0%   100%       60ms   100%  runtime.futexwakeup</span><br><span class="line">(pprof) exit</span><br></pre></td></tr></table></figure><h2 id="metrics-endpoint"><a href="#metrics-endpoint" class="headerlink" title="metrics endpoint"></a>metrics endpoint</h2><p>每个etcd节点都会在<code>/metrics</code>路径下输出监控信息，监控软件可以通过此路径获取指标信息</p><p>具体的metrics信息可以参看<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/metrics.md" target="_blank" rel="noopener">官方文档</a></p><ul><li><code>--listen-metrics-urls</code>定义metrics的location。</li><li><code>--metrics</code>可以定义<code>basic</code>和<code>extensive</code></li></ul><p>这里通过<code>curl</code>命令来获取metrics信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:2379/metrics</span><br></pre></td></tr></table></figure><h2 id="health-check"><a href="#health-check" class="headerlink" title="health check"></a>health check</h2><p>这里通过<code>curl</code>命令来获取health信息，返回结果为json</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:2379/health</span><br></pre></td></tr></table></figure><p>返回结果如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"health"</span>: <span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="对接Prometheus"><a href="#对接Prometheus" class="headerlink" title="对接Prometheus"></a>对接Prometheus</h2><h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">etcd-cluster-monitoring</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">['10.240.0.32:2379','10.240.0.33:2379','10.240.0.34:2379']</span></span><br></pre></td></tr></table></figure><h4 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">etcd-cluster-monitoring</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">['10.240.0.32:2379','10.240.0.33:2379','10.240.0.34:2379']</span></span><br><span class="line"><span class="attr">    scheme:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    tls_config:</span></span><br><span class="line">    <span class="comment"># CA certificate to validate API server certificate with.</span></span><br><span class="line"><span class="attr">      ca_file:</span> <span class="string">/path/to/etcd-ca.pem</span></span><br><span class="line"><span class="attr">      cert_file:</span> <span class="string">/path/to/etcd-cert.pem</span></span><br><span class="line"><span class="attr">      key_file:</span> <span class="string">/path/to/etcd-key.pem</span></span><br><span class="line">      <span class="comment"># insecure_skip_verify: true | false</span></span><br></pre></td></tr></table></figure><h3 id="监控告警"><a href="#监控告警" class="headerlink" title="监控告警"></a>监控告警</h3><p>使用Alertmanager进行监控告警</p><p><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/etcd3_alert.rules" target="_blank" rel="noopener">Prometheus 1.x 范例</a></p><p><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/etcd3_alert.rules.yml" target="_blank" rel="noopener">Prometheus 2.x 范例</a></p><h3 id="监控指标展示"><a href="#监控指标展示" class="headerlink" title="监控指标展示"></a>监控指标展示</h3><p>使用Grafana读取Prometheus的数据展示监控数据，<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/grafana.json" target="_blank" rel="noopener">Dashboard模板</a></p><p><img src="https://github.com/etcd-io/etcd/raw/master/Documentation/op-guide/etcd-sample-grafana.png" alt="img"></p><h1 id="etcd故障处理"><a href="#etcd故障处理" class="headerlink" title="etcd故障处理"></a>etcd故障处理</h1><h2 id="leader节点故障"><a href="#leader节点故障" class="headerlink" title="leader节点故障"></a>leader节点故障</h2><blockquote><ul><li>leader节点故障，etcd集群会自动选举出新的leader。</li><li>故障检测模型是基于超时的，因此选举新的leader节点不会在旧的leader节点故障之后立刻发生。</li><li>选举leader期间，集群不会处理写入操作。选举期间的写入请求会进入队列等待处理，直至选出新的leader节点。</li><li>已经发送给故障leader但尚未提交的数据可能会丢失。这是因为新的leader节点有权对旧leader节点的数据进行修改</li><li>客户端会发现一些写入请求可能会超时，没有提交的数据会丢失。</li></ul></blockquote><h2 id="follower节点故障"><a href="#follower节点故障" class="headerlink" title="follower节点故障"></a>follower节点故障</h2><blockquote><ul><li>follower故障节点数量少于集群节点的一半时，etcd集群是可以正常工作的。<ul><li>例如3个节点故障了1个，5个节点故障了2个</li></ul></li><li>follower节点故障后，客户端的etcd库应该自动连接到etcd集群的其他成员。</li></ul></blockquote><h2 id="超过半数节点故障"><a href="#超过半数节点故障" class="headerlink" title="超过半数节点故障"></a>超过半数节点故障</h2><blockquote><ul><li>由于Raft算法的原理所限，超过半数的集群节点故障会导致etcd集群进入不可写入的状态。</li><li>只要正常工作的节点超过集群节点的一半，那么etcd集群会自动选举leader节点并且自动恢复到健康状态</li><li>如果无法修复多数节点，那么就需要走灾难恢复的操作流程</li></ul></blockquote><h2 id="网络分区"><a href="#网络分区" class="headerlink" title="网络分区"></a>网络分区</h2><blockquote><ul><li>由于网络故障，导致etcd集群被切分成两个或者更多的部分。</li><li>那么占有多数节点的一方会成为可用集群，少数节点的一方不可写入。</li><li>如果对等切分了集群，那么每个部分都不可用。</li><li>这是因为Raft一致性算法保证了etcd是不存在<strong>脑裂</strong>现象。</li><li>只要网络分区的故障解除，少数节点的一方会自动从多数节点一方识别出leader节点，然后恢复状态。</li></ul></blockquote><h2 id="集群启动失败"><a href="#集群启动失败" class="headerlink" title="集群启动失败"></a>集群启动失败</h2><p>只有超过半数成员启动完成之后，集群的bootstrap才会成功。</p><p>Raft一致性算法保证了集群节点的数据一致性和稳定性，因此对于节点的恢复，更多的是恢复etcd节点服务，然后恢复数据</p><h3 id="新的集群"><a href="#新的集群" class="headerlink" title="新的集群"></a>新的集群</h3><p>可以删除所有成员的数据目录，然后重新走创建集群的步骤</p><h3 id="已有集群"><a href="#已有集群" class="headerlink" title="已有集群"></a>已有集群</h3><p>这个就要看无法启动的节点是数据文件损坏，还是其他原因导致的。</p><p>这里以数据文件损坏为例。</p><ul><li>寻找正常的节点，使用<code>etcdctl snapshot save</code>命令保存出快照文件</li><li>将故障节点的数据目录清空，使用<code>etcdctl snapshot restore</code>命令将数据恢复到数据目录</li><li>使用<code>etcdctl member list</code>确认故障节点的信息</li><li>使用<code>etcdctl member remove</code>删除故障节点</li><li>使用<code>etcdctl member add MEMBER_NAME --peer-urls=http://member:2379</code>重新添加成员</li><li>修改etcd启动参数<code>--initial-cluster-state=existing</code>启动故障节点的etcd服务</li></ul><h1 id="etcd灾难恢复"><a href="#etcd灾难恢复" class="headerlink" title="etcd灾难恢复"></a>etcd灾难恢复</h1><p>这里的灾难恢复，只能恢复v2或者v3的数据，不能同时恢复v2和v3。</p><p>两套API是相互隔离的。</p><h2 id="针对v3的API"><a href="#针对v3的API" class="headerlink" title="针对v3的API"></a>针对v3的API</h2><p>etcd v3的API提供了快照和恢复功能，可以在不损失快照点数据的情况下重建集群</p><h3 id="快照备份数据"><a href="#快照备份数据" class="headerlink" title="快照备份数据"></a>快照备份数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --endpoints http://member1:2379,http://member2:2379,http://member3:2379 snapshot save /path/to/snapshot.db</span><br></pre></td></tr></table></figure><h3 id="恢复集群"><a href="#恢复集群" class="headerlink" title="恢复集群"></a>恢复集群</h3><blockquote><ul><li>恢复etcd集群，只需要快照文件<code>db</code>即可。</li><li>使用<code>etcdctl snapshot restore</code>命令还原数据时会自动创建新的etcd数据目录。</li><li>恢复过程会覆盖快照文件里面的一些metadata（特别是member id和cluster id），该member会失去之前的id。覆盖metadata可以防止新成员无意中加入现有集群。</li><li>从快照中恢复集群，必须以新集群启动。</li><li>恢复时可以选择验证快照完整性hash。<ul><li>使用<code>etcdctl snapshot save</code>生成的快照，则具有完整性hash</li><li>如果是直接从数据目录拷贝数据快照，则没有完整性hash，需要使用<code>--skip-hash-check</code>跳过检查</li></ul></li></ul></blockquote><h4 id="恢复节点数据"><a href="#恢复节点数据" class="headerlink" title="恢复节点数据"></a>恢复节点数据</h4><blockquote><ul><li>这里假定原有的集群节点为member1、member2、member3</li></ul></blockquote><p>在member1、member2、member3上分别恢复快照数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ETCDCTL_API=3 etcdctl snapshot restore snapshot.db \</span></span><br><span class="line">  --name member1 \</span><br><span class="line">  --initial-cluster member1=http://member1:2380,member2=http://member2:2380,member3=http://member3:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-advertise-peer-urls http://member1:2380</span><br><span class="line"><span class="meta">$</span><span class="bash"> ETCDCTL_API=3 etcdctl snapshot restore snapshot.db \</span></span><br><span class="line">  --name member2 \</span><br><span class="line">  --initial-cluster member1=http://member1:2380,member2=http://member2:2380,member3=http://member3:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-advertise-peer-urls http://member2:2380</span><br><span class="line"><span class="meta">$</span><span class="bash"> ETCDCTL_API=3 etcdctl snapshot restore snapshot.db \</span></span><br><span class="line">  --name member3 \</span><br><span class="line">  --initial-cluster member1=http://member1:2380,member2=http://member2:2380,member3=http://member3:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-advertise-peer-urls http://member3:2380</span><br></pre></td></tr></table></figure><h4 id="启动etcd集群-1"><a href="#启动etcd集群-1" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h4><p>在member1、member2、member3上分别启动集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> etcd \</span></span><br><span class="line">  --name member1 \</span><br><span class="line">  --listen-client-urls http://member1:2379 \</span><br><span class="line">  --advertise-client-urls http://member1:2379 \</span><br><span class="line">  --listen-peer-urls http://member1:2380 &amp;</span><br><span class="line"><span class="meta">$</span><span class="bash"> etcd \</span></span><br><span class="line">  --name member2 \</span><br><span class="line">  --listen-client-urls http://member2:2379 \</span><br><span class="line">  --advertise-client-urls http://member2:2379 \</span><br><span class="line">  --listen-peer-urls http://member2:2380 &amp;</span><br><span class="line"><span class="meta">$</span><span class="bash"> etcd \</span></span><br><span class="line">  --name member3 \</span><br><span class="line">  --listen-client-urls http://member3:2379 \</span><br><span class="line">  --advertise-client-urls http://member3:2379 \</span><br><span class="line">  --listen-peer-urls http://member3:2380 &amp;</span><br></pre></td></tr></table></figure><h2 id="针对v2的API"><a href="#针对v2的API" class="headerlink" title="针对v2的API"></a>针对v2的API</h2><h3 id="备份数据"><a href="#备份数据" class="headerlink" title="备份数据"></a>备份数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3</span><br><span class="line">etcdctl backup \</span><br><span class="line">        --data-dir /path/to/data-dir \</span><br><span class="line">        --wal-dir /path/to/wal_dir \</span><br><span class="line">        --backup-dir /path/to/backup_data_dir \</span><br><span class="line">        --backup-wal-dir /path/to/backup_wal_dir</span><br></pre></td></tr></table></figure><h3 id="清理数据目录"><a href="#清理数据目录" class="headerlink" title="清理数据目录"></a>清理数据目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /path/to/data-dir</span><br><span class="line">rm -rf /path/to/wal-dir</span><br></pre></td></tr></table></figure><h3 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /path/to/backup_data_dir /path/to/data-dir</span><br><span class="line">mv /path/to/backup_wal_dir /path/to/wal_dir</span><br></pre></td></tr></table></figure><h3 id="启动etcd集群-2"><a href="#启动etcd集群-2" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h3><p>启动参数需要添加<code>--force-new-cluster</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcd --data-dir /path/to/data-dir \</span><br><span class="line">     --wal-dir /path/to/wal_dir \</span><br><span class="line">     --force-new-cluster</span><br></pre></td></tr></table></figure><h1 id="etcd版本升级"><a href="#etcd版本升级" class="headerlink" title="etcd版本升级"></a>etcd版本升级</h1><p>这里可以参考<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/upgrades/upgrading-etcd.md" target="_blank" rel="noopener">etcd的升级文档</a></p><h1 id="etcd的FAQ"><a href="#etcd的FAQ" class="headerlink" title="etcd的FAQ"></a>etcd的FAQ</h1><p>摘自<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/faq.md" target="_blank" rel="noopener">Frequently Asked Questions (FAQ)</a></p><h2 id="客户端是否需要向etcd集群的leader节点发送请求"><a href="#客户端是否需要向etcd集群的leader节点发送请求" class="headerlink" title="客户端是否需要向etcd集群的leader节点发送请求"></a>客户端是否需要向etcd集群的leader节点发送请求</h2><blockquote><ul><li>leader节点负责处理所有需要集群共识的请求（例如写请求）。</li><li>客户端不需要知道哪个节点是leader，follower节点会将所有需要集群共识的请求转发给leader节点。</li><li>所有节点都可以处理不需要集群共识的请求（例如序列化读取）。</li></ul></blockquote><h2 id="listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别"><a href="#listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别" class="headerlink" title="listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别"></a>listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别</h2><blockquote><ul><li><code>listen-client-urls</code>和<code>listen-peer-urls</code>指定etcd服务端用于接收传入连接的本地地址，要监听所有地址，请指定0.0.0.0作为监听地址。</li><li><code>advertise-client-urls</code> 和<code>initial-advertise-peer-urls</code>指定etcd的客户端及集群其他成员访问etcd服务的地址，此地址必须要被外部访问，因此不能设置127.0.0.1或者0.0.0.0等地址。</li></ul></blockquote><h2 id="为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl-member-list中列出的advertise-peer-urls"><a href="#为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl-member-list中列出的advertise-peer-urls" class="headerlink" title="为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl member list中列出的advertise peer urls"></a>为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl member list中列出的advertise peer urls</h2><blockquote><ul><li>每个member的advertise-peer-urls来自初始化集群时的<code>initial-advertise-peer-urls</code>参数</li><li>在member启动完成后修改listen-peer-urls或者initial-advertise-peer-urls参数不会影响现有的advertise-peer-urls，因为修改此参数需要通过集群仲裁以避免出现脑裂</li><li>修改<code>advertise-peer-url</code>请使用<code>etcd member update</code>命令操作</li></ul></blockquote><h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><blockquote><ul><li>etcd会将数据写入磁盘，因此高性能的磁盘会更好，推荐使用SSD</li><li>默认存储配额为2GB，最大值为8GB</li><li>为了避免使用swap或者内存不足，服务器内存至少要超过存储配额</li></ul></blockquote><h2 id="为什么etcd需要奇数个集群成员"><a href="#为什么etcd需要奇数个集群成员" class="headerlink" title="为什么etcd需要奇数个集群成员"></a>为什么etcd需要奇数个集群成员</h2><blockquote><ul><li>etcd集群需要通过大多数节点仲裁才能将集群状态更新到一致</li><li>仲裁为(n/2)+1</li><li>双数个集群成员并不比奇数个节点容错性强</li></ul></blockquote><h2 id="集群容错性列表"><a href="#集群容错性列表" class="headerlink" title="集群容错性列表"></a>集群容错性列表</h2><table><thead><tr><th>Cluster Size</th><th>Majority</th><th>Failure Tolerance</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>0</td></tr><tr><td>2</td><td>2</td><td>0</td></tr><tr><td>3</td><td>2</td><td>1</td></tr><tr><td>4</td><td>3</td><td>1</td></tr><tr><td>5</td><td>3</td><td>2</td></tr><tr><td>6</td><td>4</td><td>2</td></tr><tr><td>7</td><td>4</td><td>3</td></tr><tr><td>8</td><td>5</td><td>3</td></tr><tr><td>9</td><td>5</td><td>4</td></tr></tbody></table><h2 id="集群最大节点数量"><a href="#集群最大节点数量" class="headerlink" title="集群最大节点数量"></a>集群最大节点数量</h2><blockquote><ul><li>理论上没有硬性限制，一般不超过7个节点</li><li>建议5个节点，5个节点可以容忍2个节点故障下线，在大多数情况下已经足够</li><li>更多的节点可以提供更好的可用性，但是写入性能会有影响</li></ul></blockquote><h2 id="部署跨数据中心的etcd集群是否合适"><a href="#部署跨数据中心的etcd集群是否合适" class="headerlink" title="部署跨数据中心的etcd集群是否合适"></a>部署跨数据中心的etcd集群是否合适</h2><blockquote><ul><li>跨数据中心的etcd集群可以提高可用性</li><li>数据中心之间的网络延迟可能会影响节点的election</li><li>默认的etcd配置可能会因为网络延迟频繁选举或者心跳超时，需要调整对应的<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md" target="_blank" rel="noopener">参数</a></li></ul></blockquote><h2 id="为什么etcd会因为磁盘IO延迟而重新选举"><a href="#为什么etcd会因为磁盘IO延迟而重新选举" class="headerlink" title="为什么etcd会因为磁盘IO延迟而重新选举"></a>为什么etcd会因为磁盘IO延迟而重新选举</h2><blockquote><ul><li>这是故意设计的</li><li>磁盘IO延迟是leader节点存活指标的一部分</li><li>磁盘IO延迟很高导致选举超时，即使leader节点在选举间隔内能处理网络信息（例如发送心跳），但它实际上是不可用的，因为它无法及时提交新的提议</li><li>如果经常出现因磁盘IO延迟而重新选举，请关注一下磁盘或者修改etcd时间<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md" target="_blank" rel="noopener">参数</a></li></ul></blockquote><h1 id="etcd性能压测"><a href="#etcd性能压测" class="headerlink" title="etcd性能压测"></a>etcd性能压测</h1><p>这里参考<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/performance.md" target="_blank" rel="noopener">官方文档</a></p><h2 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h2><blockquote><ul><li>延迟<ul><li>完成操作所需的时间</li></ul></li><li>吞吐量<ul><li>一段时间内完成的总操作数量</li></ul></li></ul></blockquote><p>通常情况下，平均延迟会随着吞吐量的增加而增加。</p><p>etcd使用Raft一致性算法完成成员之间的数据同步并达成集群共识。</p><p>集群的共识性能，尤其是提交延迟，主要受到两个方面限制。</p><blockquote><ul><li>网络IO延迟</li><li>磁盘IO延迟</li></ul></blockquote><h3 id="提交延迟的构成"><a href="#提交延迟的构成" class="headerlink" title="提交延迟的构成"></a>提交延迟的构成</h3><blockquote><ul><li>成员之间的网络往返时间RTT<ul><li>同一个数据中心内部的RTT是ms级别</li><li>跨数据中心的RTT就需要考虑物理限制和网络质量</li></ul></li><li><code>fdatasync</code>数据落盘时间<ul><li>机械硬盘<code>fdatasync</code>延迟通常在10ms左右</li><li>固态硬盘则低于1ms</li></ul></li></ul></blockquote><h3 id="其他延迟构成"><a href="#其他延迟构成" class="headerlink" title="其他延迟构成"></a>其他延迟构成</h3><blockquote><ul><li>序列化etcd请求需要通过etcd后端boltdb的MVVC机制来完成，通常会在10ms完成。</li><li>etcd定期将最近提交的请求快照，然后跟磁盘上的快照合并，这个操作过程会导致延迟出现峰值。</li><li>正在进行的数据压缩也会影响到延迟，所以要跟业务错开</li></ul></blockquote><h2 id="benchmark跑分"><a href="#benchmark跑分" class="headerlink" title="benchmark跑分"></a>benchmark跑分</h2><p>etcd自带的<a href="https://github.com/coreos/etcd/tree/master/tools/benchmark" target="_blank" rel="noopener">benchmark</a>命令行工具可以用来测试etcd性能</p><h3 id="写入请求"><a href="#写入请求" class="headerlink" title="写入请求"></a>写入请求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假定 HOST_1 是 leader, 写入请求发到 leader</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span> \</span><br><span class="line">          --conns=1 \</span><br><span class="line">          --clients=1 \</span><br><span class="line">          put --key-size=8 \</span><br><span class="line">          --sequential-keys \</span><br><span class="line">          --total=10000 \</span><br><span class="line">          --val-size=256</span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          put --key-size=8 \</span><br><span class="line">          --sequential-keys \</span><br><span class="line">          --total=100000 \</span><br><span class="line">          --val-size=256</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 写入发到所有成员</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          put --key-size=8 \</span><br><span class="line">          --sequential-keys \</span><br><span class="line">          --total=100000 \</span><br><span class="line">          --val-size=256</span><br></pre></td></tr></table></figure><h3 id="序列化读取"><a href="#序列化读取" class="headerlink" title="序列化读取"></a>序列化读取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Single connection read requests</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=1 \</span><br><span class="line">          --clients=1 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=l \</span><br><span class="line">          --total=10000</span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=1 \</span><br><span class="line">          --clients=1 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=s \</span><br><span class="line">          --total=10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Many concurrent read requests</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=l \</span><br><span class="line">          --total=100000</span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=s \</span><br><span class="line">          --total=100000</span><br></pre></td></tr></table></figure><h1 id="etcd性能调优"><a href="#etcd性能调优" class="headerlink" title="etcd性能调优"></a>etcd性能调优</h1><p>参考<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md" target="_blank" rel="noopener">官方文档</a></p><p>etcd默认配置是基于同一个数据中心，网络延迟较低的情况。</p><p>对于网络延迟较高，那么就需要优化心跳间隔和选举超时时间</p><h2 id="时间参数（time-parameter）"><a href="#时间参数（time-parameter）" class="headerlink" title="时间参数（time parameter）"></a>时间参数（time parameter）</h2><p>延迟不止有网络延迟，还可能受到节点磁盘IO影响。</p><p>每一次超时设置应该包括请求发出到响应成功的时间。</p><h3 id="心跳间隔（heartbeat-interval）"><a href="#心跳间隔（heartbeat-interval）" class="headerlink" title="心跳间隔（heartbeat interval）"></a>心跳间隔（heartbeat interval）</h3><p>leader节点通知各follower节点自己的存活信息。</p><p>最佳实践是通过ping命令获取RTT最大值，然后设置为RTT的0.5~1.5倍。</p><p>默认是100ms。</p><h3 id="选举超时（election-timeout）"><a href="#选举超时（election-timeout）" class="headerlink" title="选举超时（election timeout）"></a>选举超时（election timeout）</h3><p>follower节点在多久之后没收到leader节点的心跳信息，就开始选举新leader节点。</p><p>默认是1000ms。选举超时应该设置为至少是RTT的10倍，以避免网络出现波动导致重新选举。</p><h2 id="快照（snapshot）"><a href="#快照（snapshot）" class="headerlink" title="快照（snapshot）"></a>快照（snapshot）</h2><p>etcd会将所有变更的key追加写入到wal日志文件中。</p><p>一行记录一个key的变更，因此日志会不断增长。</p><p>为避免日志过大，etcd会定期做快照。</p><p>快照操作会保存当前系统状态并移除旧的日志。</p><p><code>snapshot-count</code>参数控制快照的频率，默认是10000，即每10000次变更会触发一次快照操作。</p><p>如果内存使用率高并且磁盘使用率高，可以尝试调低这个参数。</p><h2 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h2><p>etcd集群对磁盘IO延迟非常的敏感。</p><p>etcd需要存储变更日志、快照等操作，可能会导致磁盘IO出现很高的<code>fsync</code>延迟。</p><p>磁盘IO延迟高会导致leader节点心跳信息超时、请求超时、重新选举等。</p><blockquote><ul><li>etcd所使用的磁盘与系统盘分开</li><li>data目录和wal目录分别挂载不同的磁盘</li><li>有条件推荐使用SSD固态硬盘</li><li>使用<code>ionice</code>调高etcd进程的IO优先级（这个针对etcd数据目录在系统盘的情况）</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ionice -c2 -n0 -p `pgrep etcd`</span><br></pre></td></tr></table></figure><h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>如果leader节点接收来自客户端的大量请求，无法及时处理follower的请求，那么follower节点处理的请求也会因此出现延迟。</p><p>具体表现为follower会提示sending buffer is full。</p><p>可以通过调高leader的网络优先级或者通过流量管控机制来提高对follower的请求响应。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;kubernetes底层数据存放在etcd中，这里记录一下学习的笔记。&lt;/p&gt;&lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;Etcd 是 Core
      
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://luanlengli.github.io/tags/kubernetes/"/>
    
      <category term="etcd" scheme="https://luanlengli.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7使用社区YUM源安装Mariadb Galera集群</title>
    <link href="https://luanlengli.github.io/2018/12/11/CentOS7%E4%BD%BF%E7%94%A8%E7%A4%BE%E5%8C%BAYUM%E6%BA%90%E5%AE%89%E8%A3%85Mariadb-Galera%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2018/12/11/CentOS7使用社区YUM源安装Mariadb-Galera集群.html</id>
    <published>2018-12-10T16:07:07.000Z</published>
    <updated>2019-05-28T06:36:23.421Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote><ul><li>本文以MariaDB官方文档为基础，记录操作步骤</li></ul></blockquote><h1 id="安装Mariadb数据库前的准备工作"><a href="#安装Mariadb数据库前的准备工作" class="headerlink" title="安装Mariadb数据库前的准备工作"></a>安装Mariadb数据库前的准备工作</h1><h2 id="准备虚拟机三台"><a href="#准备虚拟机三台" class="headerlink" title="准备虚拟机三台"></a>准备虚拟机三台</h2><table><thead><tr><th style="text-align:center">IP地址</th><th style="text-align:center">主机名</th><th style="text-align:center">CPU</th><th style="text-align:center">内存</th></tr></thead><tbody><tr><td style="text-align:center">172.16.10.101</td><td style="text-align:center">db1</td><td style="text-align:center">2</td><td style="text-align:center">3G</td></tr><tr><td style="text-align:center">172.16.10.102</td><td style="text-align:center">db2</td><td style="text-align:center">2</td><td style="text-align:center">3G</td></tr><tr><td style="text-align:center">172.16.10.103</td><td style="text-align:center">db3</td><td style="text-align:center">2</td><td style="text-align:center">3G</td></tr></tbody></table><h2 id="添加Mariadb官方YUM源，下面以Mariadb-10-1为例"><a href="#添加Mariadb官方YUM源，下面以Mariadb-10-1为例" class="headerlink" title="添加Mariadb官方YUM源，下面以Mariadb 10.1为例"></a>添加Mariadb官方YUM源，下面以Mariadb 10.1为例</h2><p><a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=neusoft&amp;distro=CentOS&amp;distro_release=centos7-amd64--centos7&amp;version=10.1" target="_blank" rel="noopener">官方YUM源编辑器</a></p><p>使用以下命令快速添加YUM源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/yum.repos.d/mariadb.repo &lt;&lt;-'EOF'</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.1/centos7-amd64</span><br><span class="line">gpgkey=https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1 </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="刷新YUM缓存"><a href="#刷新YUM缓存" class="headerlink" title="刷新YUM缓存"></a>刷新YUM缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h2 id="查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字"><a href="#查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字" class="headerlink" title="查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字"></a>查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list MariaDB* galera</span><br></pre></td></tr></table></figure><h2 id="关闭firewalld防火墙"><a href="#关闭firewalld防火墙" class="headerlink" title="关闭firewalld防火墙"></a>关闭firewalld防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld --now</span><br></pre></td></tr></table></figure><h2 id="设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）"><a href="#设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）" class="headerlink" title="设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）"></a>设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname db1</span><br><span class="line">hostnamectl set-hostname db2</span><br><span class="line">hostnamectl set-hostname db3</span><br></pre></td></tr></table></figure><h2 id="编辑-etc-hosts文件"><a href="#编辑-etc-hosts文件" class="headerlink" title="编辑/etc/hosts文件"></a>编辑/etc/hosts文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/hosts &lt;&lt;EOF</span><br><span class="line">172.16.10.101 db1</span><br><span class="line">172.16.10.102 db2</span><br><span class="line">172.16.10.103 db3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 </span><br><span class="line"></span><br><span class="line">sed -i 's,^SELINUX=enforcing,SELINUX=disabled,g' /etc/selinux/config</span><br></pre></td></tr></table></figure><h1 id="部署MariaDB-Galera集群"><a href="#部署MariaDB-Galera集群" class="headerlink" title="部署MariaDB Galera集群"></a>部署MariaDB Galera集群</h1><h2 id="安装相关软件包"><a href="#安装相关软件包" class="headerlink" title="安装相关软件包"></a>安装相关软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install MariaDB-server MariaDB-client MariaDB-client</span><br></pre></td></tr></table></figure><h2 id="启用xtrabackup-v2功能"><a href="#启用xtrabackup-v2功能" class="headerlink" title="启用xtrabackup-v2功能"></a>启用xtrabackup-v2功能</h2><blockquote><ul><li>需要额外安装percona提供的软件包</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.10/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.10-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><h2 id="启动MariaDB数据库"><a href="#启动MariaDB数据库" class="headerlink" title="启动MariaDB数据库"></a>启动MariaDB数据库</h2><blockquote><ul><li>在db1上启动MariaDB数据库，设置galera集群同步账号,进行安全初始化</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb.service</span><br><span class="line">mysql -uroot -e "grant all privileges on *.* to 'sst'@'localhost' identified by 'password';" </span><br><span class="line">mysql_secure_installation  </span><br><span class="line">systemctl stop mariadb.service</span><br></pre></td></tr></table></figure><h2 id="编辑MariaDB配置文件"><a href="#编辑MariaDB配置文件" class="headerlink" title="编辑MariaDB配置文件"></a>编辑MariaDB配置文件</h2><blockquote><ul><li>在三个节点上编辑MariaDB配置文件，以开启galera集群功能</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/my.cnf.d/galera.cnf</span><br><span class="line">[server]</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听哪个地址，这里每个节点填对应的ip地址</span></span><br><span class="line">bind-address=172.16.10.101 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听哪个端口</span></span><br><span class="line">port = 3306 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认字符编码集</span></span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">init-connect = SET NAMES utf8</span><br><span class="line">character-set-server = utf8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置日志路径</span></span><br><span class="line">log-error = /var/log/mariadb/mariadb.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置binlog</span></span><br><span class="line">log-bin = mysql-bin</span><br><span class="line">binlog_format=ROW</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认数据目录</span></span><br><span class="line">datadir = /var/lib/mysql/ </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认存储引擎</span></span><br><span class="line">default-storage-engine=innodb</span><br><span class="line">innodb_autoinc_lock_mode=2 </span><br><span class="line">[galera]</span><br><span class="line">wsrep_on=ON</span><br><span class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</span><br><span class="line"><span class="meta">#</span><span class="bash"> galera集群名字</span></span><br><span class="line">wsrep_cluster_name="galera_cluster" </span><br><span class="line"><span class="meta">#</span><span class="bash"> 本节点的主机名，这里每个节点填对应的ip地址</span></span><br><span class="line">wsrep_node_name="db1" </span><br><span class="line">wsrep_cluster_address = "gcomm://172.16.10.101:4567,172.16.10.102:4567,172.16.10.103:4567"</span><br><span class="line">wsrep_provider_options = "gmcast.listen_addr=tcp://172.16.10.101:4567;ist.recv_addr=172.16.10.101:4568" </span><br><span class="line">wsrep_node_address="172.16.10.101:4567" </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置galera集群同步的方法和用户名密码</span></span><br><span class="line">wsrep_sst_auth=sst:password</span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line">max_connections = 10000 </span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">tmp_table_size = 64M</span><br><span class="line">innodb_buffer_pool_size = 128M</span><br><span class="line">[embedded]</span><br><span class="line">[mariadb]</span><br><span class="line">[mariadb-10.1]</span><br></pre></td></tr></table></figure><h1 id="启动galera集群"><a href="#启动galera集群" class="headerlink" title="启动galera集群"></a>启动galera集群</h1><h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><blockquote><ul><li>在db1上运行galera_new_cluster命令</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">galera_new_cluster</span><br></pre></td></tr></table></figure><h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><blockquote><ul><li>在db1上查看集群状态</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysql -uroot -p -e <span class="string">"show status like 'wsrep_cluster_size';"</span></span></span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_size       | 1                                    |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="监控MariaDB日志"><a href="#监控MariaDB日志" class="headerlink" title="监控MariaDB日志"></a>监控MariaDB日志</h2><blockquote><ul><li>监控db1上的MariaDB日志</li><li>在启动其他节点的时候，能看到其他节点加入到galera集群</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/mariadb/mariadb.log</span><br></pre></td></tr></table></figure><h2 id="启动其他节点数据库"><a href="#启动其他节点数据库" class="headerlink" title="启动其他节点数据库"></a>启动其他节点数据库</h2><blockquote><ul><li>在db2和db3上运行MariaDB数据库</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure><h2 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h2><blockquote><ul><li>在db1上检查集群状态</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "show status like 'wsrep_cluster_size';"</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_size       | 3                                    |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><h1 id="验证MariaDB-galera集群的同步功能是否正常"><a href="#验证MariaDB-galera集群的同步功能是否正常" class="headerlink" title="验证MariaDB galera集群的同步功能是否正常"></a>验证MariaDB galera集群的同步功能是否正常</h1><h2 id="在db1上创建用户、数据库"><a href="#在db1上创建用户、数据库" class="headerlink" title="在db1上创建用户、数据库"></a>在db1上创建用户、数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "user add testuser;"</span><br><span class="line">mysql -uroot -p -e "create database testdb;"</span><br><span class="line">mysql -uroot -p -e "grant all privileges on testdb.* to 'testuser'@'localhost' identified by 'password';"</span><br></pre></td></tr></table></figure><h2 id="在db2上检查用户、数据库是否存在"><a href="#在db2上检查用户、数据库是否存在" class="headerlink" title="在db2上检查用户、数据库是否存在"></a>在db2上检查用户、数据库是否存在</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "select user,host from mysql.user;"</span><br><span class="line">mysql -uroot -p -e "show databases;"</span><br></pre></td></tr></table></figure><h2 id="在db3上删除用户和数据库"><a href="#在db3上删除用户和数据库" class="headerlink" title="在db3上删除用户和数据库"></a>在db3上删除用户和数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "delete user 'testuser'"</span><br><span class="line">mysql -uroot -p -e "drop database testdb"</span><br></pre></td></tr></table></figure><h2 id="在db1上检查用户和数据库是否还在"><a href="#在db1上检查用户和数据库是否还在" class="headerlink" title="在db1上检查用户和数据库是否还在"></a>在db1上检查用户和数据库是否还在</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "select user,host from mysql.user;"</span><br><span class="line">mysql -uroot -p -e "show databases;"</span><br></pre></td></tr></table></figure><h1 id="至此，MariaDB-galera集群已经部署完成"><a href="#至此，MariaDB-galera集群已经部署完成" class="headerlink" title="至此，MariaDB galera集群已经部署完成"></a>至此，MariaDB galera集群已经部署完成</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;本文以MariaDB官方文档为基础，记录操作步骤&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;&lt;h1 id
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
</feed>
