<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>luanlengli&#39;s Blog</title>
  
  <subtitle>“不知道”的五大理由，不读，不查，不试，理解能力差，满脑子想着怎么利用他人</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://luanlengli.github.io/"/>
  <updated>2019-11-25T13:04:26.706Z</updated>
  <id>https://luanlengli.github.io/</id>
  
  <author>
    <name>乱愣黎</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CentOS7部署OpenVPN实现内网互通</title>
    <link href="https://luanlengli.github.io/2019/11/25/CentOS7%E9%83%A8%E7%BD%B2OpenVPN%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E4%BA%92%E9%80%9A.html"/>
    <id>https://luanlengli.github.io/2019/11/25/CentOS7部署OpenVPN实现内网互通.html</id>
    <published>2019-11-25T01:17:46.000Z</published>
    <updated>2019-11-25T13:04:26.706Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>此法用于多个客户端通过OpenVPN服务器实现内网访问</li><li>OpenVPN服务器操作系统<code>CentOS-7.7</code></li><li>OpenVPN版本<code>2.4.8</code></li><li>easy-rsa版本<code>3.0.6</code></li><li>使用<code>tap</code>模式</li><li>客户端IP地址池<code>10.8.0.0/24</code></li><li>多个客户端直接可以通过OpenVPN实现内网通信</li></ul><h1 id="准备操作"><a href="#准备操作" class="headerlink" title="准备操作"></a>准备操作</h1><h2 id="添加EPEL源"><a href="#添加EPEL源" class="headerlink" title="添加EPEL源"></a>添加EPEL源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br></pre></td></tr></table></figure><h2 id="替换为阿里云的源"><a href="#替换为阿里云的源" class="headerlink" title="替换为阿里云的源"></a>替换为阿里云的源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#baseurl,baseurl,g' \</span><br><span class="line">    -e 's,^metalink,#metalink,g' \</span><br><span class="line">    -e 's,^mirrorlist=,#mirrorlist=,g' \</span><br><span class="line">    -e 's,http://download.fedoraproject.org/pub,https://mirrors.aliyun.com,g' \</span><br><span class="line">    -i /etc/yum.repos.d/epel.repo</span><br></pre></td></tr></table></figure><h2 id="更新软件"><a href="#更新软件" class="headerlink" title="更新软件"></a>更新软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="修改sysctl参数"><a href="#修改sysctl参数" class="headerlink" title="修改sysctl参数"></a>修改sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-net.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径，默认值1</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 conntrack 的上限</span></span><br><span class="line">net.netfilter.nf_conntrack_max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=21644</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP阻塞控制算法BBR，Linux内核版本4.9开始内置BBR算法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FastOpen</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0:关闭 ; 1:作为客户端时使用 ; 2:作为服务器端时使用 ; 3:无论作为客户端还是服务器端都使用</span></span><br><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-centos.conf &lt;&lt;EOF</span><br><span class="line">* - nproc 1048576</span><br><span class="line">* - nofile 1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装OpenVPN软件"><a href="#安装OpenVPN软件" class="headerlink" title="安装OpenVPN软件"></a>安装OpenVPN软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openvpn easy-rsa lrzsz iptables-services</span><br></pre></td></tr></table></figure><h1 id="配置服务器证书"><a href="#配置服务器证书" class="headerlink" title="配置服务器证书"></a>配置服务器证书</h1><h2 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h2><blockquote><p>拷贝easy-rsa的文件到/etc/openvpn下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -r /usr/share/easy-rsa/3.0.6 /etc/openvpn/easy-rsa</span><br><span class="line">cp /usr/share/doc/easy-rsa-3.0.6/vars.example /etc/openvpn/easy-rsa/vars</span><br></pre></td></tr></table></figure><h2 id="修改vars"><a href="#修改vars" class="headerlink" title="修改vars"></a>修改vars</h2><blockquote><p>编辑vars文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/easy-rsa/vars</span><br></pre></td></tr></table></figure><blockquote><p>修改以下几项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_COUNTRY     <span class="string">"US"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_PROVINCE    <span class="string">"California"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_CITY        <span class="string">"San Francisco"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_ORG         <span class="string">"Copyleft Certificate Co"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_EMAIL       <span class="string">"me@example.net"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_REQ_OU          <span class="string">"My Organizational Unit"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_KEY_SIZE        4096</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_ALGO            rsa</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CA_EXPIRE       3650</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CERT_EXPIRE     365</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CERT_RENEW      180</span></span><br><span class="line"><span class="meta">#</span><span class="bash">set_var EASYRSA_CRL_DAYS        60</span></span><br></pre></td></tr></table></figure><h2 id="初始化PKI和CA"><a href="#初始化PKI和CA" class="headerlink" title="初始化PKI和CA"></a>初始化PKI和CA</h2><h3 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/openvpn/easy-rsa</span><br></pre></td></tr></table></figure><h3 id="创建PKI"><a href="#创建PKI" class="headerlink" title="创建PKI"></a>创建PKI</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa init-pki</span><br></pre></td></tr></table></figure><h3 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa build-ca nopass</span><br></pre></td></tr></table></figure><h2 id="创建服务器证书"><a href="#创建服务器证书" class="headerlink" title="创建服务器证书"></a>创建服务器证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa build-server-full openvpn-server nopass</span><br></pre></td></tr></table></figure><h2 id="创建DH证书"><a href="#创建DH证书" class="headerlink" title="创建DH证书"></a>创建DH证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa gen-dh</span><br></pre></td></tr></table></figure><h2 id="拷贝证书"><a href="#拷贝证书" class="headerlink" title="拷贝证书"></a>拷贝证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/openvpn/pki</span><br><span class="line">cp /etc/openvpn/easy-rsa/pki/ca.crt \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/dh.pem \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/issued/openvpn-server.crt \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/private/openvpn-server.key \</span><br><span class="line">   /etc/openvpn/pki/</span><br><span class="line">chown -R root:openvpn /etc/openvpn/pki</span><br></pre></td></tr></table></figure><h2 id="创建ta-key"><a href="#创建ta-key" class="headerlink" title="创建ta.key"></a>创建ta.key</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --genkey --secret /etc/openvpn/pki/ta.key</span><br></pre></td></tr></table></figure><h1 id="配置OpenVPN"><a href="#配置OpenVPN" class="headerlink" title="配置OpenVPN"></a>配置OpenVPN</h1><h2 id="创建日志目录"><a href="#创建日志目录" class="headerlink" title="创建日志目录"></a>创建日志目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/openvpn</span><br><span class="line">chown -R openvpn:openvpn /var/log/openvpn</span><br></pre></td></tr></table></figure><h2 id="创建客户端配置目录"><a href="#创建客户端配置目录" class="headerlink" title="创建客户端配置目录"></a>创建客户端配置目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/openvpn/client/&#123;config,user&#125;</span><br><span class="line">chown -R root:openvpn /etc/openvpn/client/&#123;config,user&#125;</span><br></pre></td></tr></table></figure><h2 id="配置OpenVPN服务器端"><a href="#配置OpenVPN服务器端" class="headerlink" title="配置OpenVPN服务器端"></a>配置OpenVPN服务器端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/server/srv.conf</span><br></pre></td></tr></table></figure><blockquote><p>下面内容按需更改</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">port 51194</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通信协议</span></span><br><span class="line">proto tcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> TUN模式还是TAP模式</span></span><br><span class="line">dev tap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 证书位置</span></span><br><span class="line">ca       /etc/openvpn/pki/ca.crt</span><br><span class="line">cert     /etc/openvpn/pki/openvpn-server.crt</span><br><span class="line">key      /etc/openvpn/pki/openvpn-server.key</span><br><span class="line">dh       /etc/openvpn/pki/dh.pem</span><br><span class="line">tls-auth /etc/openvpn/pki/ta.key</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在此文件中维护客户端与虚拟IP地址之间的关联记录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果OpenVPN重启，重新连接的客户端可以被分配到先前分配的虚拟IP地址</span></span><br><span class="line">ifconfig-pool-persist /etc/openvpn/ipp.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置client配置文件</span></span><br><span class="line">client-config-dir /etc/openvpn/client/config</span><br><span class="line"><span class="meta">#</span><span class="bash"> 该网段为 open VPN 虚拟网卡网段，不要和内网网段冲突即可。</span></span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给客户端推送自定义路由</span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"route 192.168.0.0 255.255.255.0"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有客户端的默认网关都将重定向到VPN</span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"redirect-gateway def1 bypass-dhcp"</span>  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置DNS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"dhcp-option DNS 223.5.5.5"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">push <span class="string">"dhcp-option DNS 223.6.6.6"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许客户端之间互通</span></span><br><span class="line">client-to-client</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保持连接时间</span></span><br><span class="line">keepalive 20 120</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启vpn压缩</span></span><br><span class="line">comp-lzo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许多人使用同一个证书连接VPN，不建议使用，注释状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash">duplicate-cn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行用户</span></span><br><span class="line">user openvpn</span><br><span class="line"><span class="meta">#</span><span class="bash">运行组</span></span><br><span class="line">group openvpn</span><br><span class="line"><span class="meta">#</span><span class="bash"> 持久化选项可以尽量避免访问那些在重启之后由于用户权限降低而无法访问的某些资源</span></span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示当前的连接状态</span></span><br><span class="line">status      /var/log/openvpn/openvpn-status.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志路径，不指定文件路径时输出到控制台</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">log</span>-append  /var/<span class="built_in">log</span>/openvpn/openvpn.log</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志级别</span></span><br><span class="line">verb 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略过多的重复信息，相同类别的信息只有前20条会输出到日志文件中</span></span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure><h2 id="启动OpenVPN-server"><a href="#启动OpenVPN-server" class="headerlink" title="启动OpenVPN-server"></a>启动OpenVPN-server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:openvpn /etc/openvpn</span><br><span class="line">systemctl enable openvpn-server@srv.service</span><br><span class="line">systemctl start openvpn-server@srv.service</span><br></pre></td></tr></table></figure><h2 id="添加SNAT访问内网"><a href="#添加SNAT访问内网" class="headerlink" title="添加SNAT访问内网"></a>添加SNAT访问内网</h2><ul><li>让<code>10.8.0.0/24</code>访问<code>192.168.0.0/24</code>的时候做SNAT，源地址改成OpenVPN服务器的内网地址</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -d 192.168.0.0/24 -j SNAT --to-source OPENVPN_SERVER_IP</span><br></pre></td></tr></table></figure><h1 id="客户端管理"><a href="#客户端管理" class="headerlink" title="客户端管理"></a>客户端管理</h1><h2 id="客户端配置模板"><a href="#客户端配置模板" class="headerlink" title="客户端配置模板"></a>客户端配置模板</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/templates/ovpn.template</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置为客户端模式</span></span><br><span class="line">client</span><br><span class="line"><span class="meta">#</span><span class="bash"> 与服务器端保持一致</span></span><br><span class="line">proto tcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 与服务器端保持一致</span></span><br><span class="line">dev tap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置服务器端的地址和端口</span></span><br><span class="line">remote vpn-server 51194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">comp-lzo</span><br><span class="line">nice 0</span><br><span class="line">verb 3</span><br><span class="line">mute 10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端自定义路由，例如192.168.0.0/24走VPN</span></span><br><span class="line"><span class="meta">#</span><span class="bash">route 192.168.0.0 255.255.255.0 vpn_gateway</span></span><br></pre></td></tr></table></figure><h2 id="客户端推送固定IP"><a href="#客户端推送固定IP" class="headerlink" title="客户端推送固定IP"></a>客户端推送固定IP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/templates/ipconfig_push.template</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig-push #ipaddress# 255.255.255.0</span><br></pre></td></tr></table></figure><h2 id="用户管理脚本"><a href="#用户管理脚本" class="headerlink" title="用户管理脚本"></a>用户管理脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/ovpn_mgmt.sh</span><br><span class="line">chmod +x /usr/local/bin/ovpn_mgmt.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义环境变量</span></span><br><span class="line">export EASY_RSA_DIR="/etc/openvpn/easy-rsa"</span><br><span class="line">export CLIENT_CONFIG_DIR="/etc/openvpn/client/config"</span><br><span class="line">export PKI_DIR="$&#123;EASY_RSA_DIR&#125;/pki"</span><br><span class="line">export TEMPLATES_DIR="/etc/openvpn/templates"</span><br><span class="line">export CLIENT_USER_DIR="/etc/openvpn/client/user"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建ovpn配置</span></span><br><span class="line">generate_ovpn() &#123;</span><br><span class="line">USER_OVPN="$&#123;CLIENT_USER_DIR&#125;/$&#123;EXPIRED&#125;-$&#123;USER&#125;.ovpn"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据证书生成对应的ovpn文件</span></span><br><span class="line">    mkdir -p  $&#123;CLIENT_USER_DIR&#125;/</span><br><span class="line">    cp -f $&#123;TEMPLATES_DIR&#125;/ovpn.template $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;ca&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/ca.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/ca&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;cert&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/issued/$&#123;USER&#125;.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/cert&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;key&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/private/$&#123;USER&#125;.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/key&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;tls-auth&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat /etc/openvpn/pki/ta.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo "&lt;/tls-auth&gt;" &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    sz --binary $&#123;USER_OVPN&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加客户端IP</span></span><br><span class="line">client_ip_config() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据ip地址生成对应的client-config</span></span><br><span class="line">    sed -e "s,#ipaddress#,$&#123;IPADDRESS&#125;,g" \</span><br><span class="line">        $&#123;TEMPLATES_DIR&#125;/ipconfig_push.template \</span><br><span class="line">        &gt; $&#123;CLIENT_CONFIG_DIR&#125;/$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成客户端证书</span></span><br><span class="line">add_cert() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到easy-rsa目录</span></span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    $&#123;EASY_RSA_DIR&#125;/easyrsa build-client-full $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注销客户端证书</span></span><br><span class="line">revoke_cert() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到easy-rsa目录</span></span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo "yes" | $&#123;EASY_RSA_DIR&#125;/easyrsa revoke $&#123;USER&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;EASY_RSA_DIR&#125;/easyrsa gen-crl</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新客户端证书</span></span><br><span class="line">renew_cert() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到easy-rsa目录</span></span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo "yes" | $&#123;EASY_RSA_DIR&#125;/easyrsa renew $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查证书过期时间</span></span><br><span class="line">check_cert_expired() &#123;</span><br><span class="line">export EXPIRED=$(date --date="$(openssl x509 -enddate -noout -in $&#123;PKI_DIR&#125;/issued/$&#123;USER&#125;.crt |cut -d= -f 2)" --iso-8601)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建用户</span></span><br><span class="line">add_user() &#123;</span><br><span class="line">if [[ -e "$&#123;EASY_RSA_DIR&#125;/pki/reqs/$&#123;USER&#125;.req" ]];then</span><br><span class="line">read -p"此用户已经申请证书，是否重新生成？[y/n]：" ANSWER</span><br><span class="line">case $&#123;ANSWER&#125; in</span><br><span class="line">    y|Y)</span><br><span class="line">        revoke_cert</span><br><span class="line">        check_cert_expired</span><br><span class="line">        client_ip_config</span><br><span class="line">        add_cert</span><br><span class="line">        generate_ovpn</span><br><span class="line">        exit 0</span><br><span class="line">        ;;</span><br><span class="line">n|N)</span><br><span class="line">check_cert_expired</span><br><span class="line">client_ip_config</span><br><span class="line">generate_ovpn</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line">else</span><br><span class="line">add_cert</span><br><span class="line">check_cert_expired</span><br><span class="line">client_ip_config</span><br><span class="line">generate_ovpn</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除用户</span></span><br><span class="line">del_user() &#123;</span><br><span class="line">revoke_cert</span><br><span class="line">rm -rf $&#123;CLIENT_USER_DIR&#125;/*$&#123;USER&#125;.ovpn</span><br><span class="line">rm -rf $&#123;CLIENT_CONFIG_DIR&#125;/$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户旧证过期重新生成证书</span></span><br><span class="line">renew_user() &#123;</span><br><span class="line">if [[ -e "$&#123;EASY_RSA_DIR&#125;/pki/reqs/$&#123;USER&#125;.req" ]];then</span><br><span class="line">        renew_cert</span><br><span class="line">        check_cert_expired</span><br><span class="line">        generate_ovpn</span><br><span class="line">    else</span><br><span class="line">    echo "用户证书不存在！"</span><br><span class="line">    exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">    # 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    # 根据传入的method运行对应函数</span><br><span class="line">    $&#123;METHOD&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取参数</span></span><br><span class="line">while getopts 'm:u:i:r' OPT;do</span><br><span class="line">    case $OPT in</span><br><span class="line">        u)</span><br><span class="line">            USER="$OPTARG"</span><br><span class="line">            echo "USER=$&#123;USER&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        i)</span><br><span class="line">            IPADDRESS="$OPTARG"</span><br><span class="line">            echo "IPADDRESS=$&#123;IPADDRESS&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        m)</span><br><span class="line">            METHOD="$OPTARG"</span><br><span class="line">            echo "METHOD=$&#123;METHOD&#125;"</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            echo "Usage: $(base \"$0\") -m [add_user|del_user|renew_user] -u USER -i IPADDRESS"</span><br><span class="line">            exit 0</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure><h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/ovpn_mgmt.sh -m add_user -u USERNAME -i 10.8.0.10</span><br></pre></td></tr></table></figure><h2 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/ovpn_mgmt.sh -m del_user -u USERNAME</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;此法用于多个客户端通过OpenVPN服务器实现内网访问&lt;/li&gt;&lt;li&gt;OpenVPN服务器操作系统&lt;code&gt;CentOS-7.
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
      <category term="OpenVPN" scheme="https://luanlengli.github.io/tags/OpenVPN/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群利用RBAC+ServiceAccount管理权限</title>
    <link href="https://luanlengli.github.io/2019/08/17/Kubernetes%E9%9B%86%E7%BE%A4%E5%88%A9%E7%94%A8RBAC+ServiceAccount%E7%AE%A1%E7%90%86%E6%9D%83%E9%99%90.html"/>
    <id>https://luanlengli.github.io/2019/08/17/Kubernetes集群利用RBAC+ServiceAccount管理权限.html</id>
    <published>2019-08-17T08:31:24.000Z</published>
    <updated>2019-09-09T08:41:28.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>这里简单记录一下如何通过k8s集群创建clusterrole配合serviceaccount实现权限控制，并且使用kubectl生成kubeconfig文件用于实现人员权限管理。</p><h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><h2 id="创建ClusterRole"><a href="#创建ClusterRole" class="headerlink" title="创建ClusterRole"></a>创建ClusterRole</h2><blockquote><p>这里参考了kube-apiserver初始化时生成的clusterrole.views权限设定</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">aggregationRule:</span></span><br><span class="line"><span class="attr">  clusterRoleSelectors:</span></span><br><span class="line"><span class="attr">  - matchLabels:</span></span><br><span class="line">      <span class="string">rbac.example.com/aggregate-to-monitoring:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">configmaps</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/metrics</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/proxy</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">serviceaccounts</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">services</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">bindings</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">events</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">limitranges</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods/log</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers/status</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">resourcequotas</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">resourcequotas/status</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">apps</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">controllerrevisions</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">daemonsets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">statefulsets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">statefulsets/scale</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">autoscaling</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">batch</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cronjobs</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">jobs</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">extensions</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">daemonsets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ingresses</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networkpolicies</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicasets/scale</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">policy</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networking.k8s.io</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">networkpolicies</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">metrics.k8s.io</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">monitoring.coreos.com</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertmanagers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">podmonitors</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">prometheuses</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">prometheusrules</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">servicemonitors</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- nonResourceURLs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/metrics</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/log</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/logs</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/healthz</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/healthz/*</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br></pre></td></tr></table></figure><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><h2 id="绑定ClusterRole"><a href="#绑定ClusterRole" class="headerlink" title="绑定ClusterRole"></a>绑定ClusterRole</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-readonly</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><h2 id="获取ServiceAccount对应的Secret"><a href="#获取ServiceAccount对应的Secret" class="headerlink" title="获取ServiceAccount对应的Secret"></a>获取ServiceAccount对应的Secret</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET=$(kubectl -n default get serviceaccount cluster-readonly -o go-template='&#123;&#123;range .secrets&#125;&#125;&#123;&#123;.name&#125;&#125;&#123;&#123;end&#125;&#125;')</span><br></pre></td></tr></table></figure><h2 id="定义Kube-APIServer"><a href="#定义Kube-APIServer" class="headerlink" title="定义Kube-APIServer"></a>定义Kube-APIServer</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">API_SERVER="https://192.168.1.100:6443"</span><br></pre></td></tr></table></figure><h2 id="获取集群CA证书"><a href="#获取集群CA证书" class="headerlink" title="获取集群CA证书"></a>获取集群CA证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default get secret $&#123;SECRET&#125; -o yaml | awk '/ca.crt:/&#123;print $2&#125;' | base64 -d &gt; ca.crt</span><br></pre></td></tr></table></figure><h2 id="获取ServiceAccount对应的Token"><a href="#获取ServiceAccount对应的Token" class="headerlink" title="获取ServiceAccount对应的Token"></a>获取ServiceAccount对应的Token</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TOKEN=$(kubectl -n default get secret $&#123;SECRET&#125; -o go-template='&#123;&#123;.data.token&#125;&#125;')</span><br></pre></td></tr></table></figure><h2 id="定义kubeconfig文件名"><a href="#定义kubeconfig文件名" class="headerlink" title="定义kubeconfig文件名"></a>定义kubeconfig文件名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBECONFIG="cluster-readonly.kubeconfig"</span><br></pre></td></tr></table></figure><h2 id="创建kubeconfig"><a href="#创建kubeconfig" class="headerlink" title="创建kubeconfig"></a>创建kubeconfig</h2><ul><li>设置kubeconfig集群信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        set-cluster k8s-cluster \</span><br><span class="line">        --server=$&#123;API_SERVER&#125; \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --certificate-authority=./ca.crt</span><br></pre></td></tr></table></figure><ul><li>设置kubeconfig使用用户名+token认证</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        set-credentials cluster-readonly \</span><br><span class="line">        --token=`echo $&#123;TOKEN&#125; | base64 -d` \</span><br><span class="line">        --kubeconfig=$&#123;KUBECONFIG&#125;</span><br></pre></td></tr></table></figure><ul><li>设置kubeconfig的context</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        set-context default \</span><br><span class="line">        --cluster=k8s-cluster \</span><br><span class="line">        --user=cluster-readonly \</span><br><span class="line">        --kubeconfig=$&#123;KUBECONFIG&#125;</span><br></pre></td></tr></table></figure><ul><li>将context设置为kubeconfig默认值</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config \</span><br><span class="line">        use-context default \</span><br><span class="line">        --kubeconfig=$&#123;KUBECONFIG&#125;</span><br></pre></td></tr></table></figure><h1 id="验证权限"><a href="#验证权限" class="headerlink" title="验证权限"></a>验证权限</h1><h2 id="有权限的操作"><a href="#有权限的操作" class="headerlink" title="有权限的操作"></a>有权限的操作</h2><h3 id="获取Pod"><a href="#获取Pod" class="headerlink" title="获取Pod"></a>获取Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get pod --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="获取Pod日志"><a href="#获取Pod日志" class="headerlink" title="获取Pod日志"></a>获取Pod日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get pod--subresource=log --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="获取ingress"><a href="#获取ingress" class="headerlink" title="获取ingress"></a>获取ingress</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get ingress --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yes</span><br></pre></td></tr></table></figure><h2 id="无权限的操作"><a href="#无权限的操作" class="headerlink" title="无权限的操作"></a>无权限的操作</h2><h3 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i create pods --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i delete pods --all-namespaces</span><br></pre></td></tr></table></figure><h3 id="获取Secret"><a href="#获取Secret" class="headerlink" title="获取Secret"></a>获取Secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=$&#123;KUBECONFIG&#125; auth can-i get secrets -n kube-system</span><br></pre></td></tr></table></figure><h3 id="返回结果-1"><a href="#返回结果-1" class="headerlink" title="返回结果"></a>返回结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no - no RBAC policy matched</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;p&gt;这里简单记录一下如何通过k8s集群创建clusterrole配合serviceaccount实现权限控制，并且使用kubectl生成kube
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
  </entry>
  
  <entry>
    <title>Kubernetes集群使用ECK部署elasticsearch和kibana</title>
    <link href="https://luanlengli.github.io/2019/08/03/Kubernetes%E9%9B%86%E7%BE%A4%E4%BD%BF%E7%94%A8ECK%E9%83%A8%E7%BD%B2elasticsearch%E5%92%8Ckibana.html"/>
    <id>https://luanlengli.github.io/2019/08/03/Kubernetes集群使用ECK部署elasticsearch和kibana.html</id>
    <published>2019-08-03T01:33:50.000Z</published>
    <updated>2019-08-07T03:17:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录操作过程和部署过程</li><li>请考虑再三之后再决定是否上生产环境！</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>Kubernetes集群版本<code>v1.14.4</code></li><li>elastic-operator版本为<code>0.9.0</code></li><li>elasticsearch和kibana版本为<code>7.2.0</code></li><li>elasticsearch和kibana默认提供<font color="red">HTTPS</font>，其中elasticsearch无法关闭HTTPS</li></ul><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-quickstart.html" target="_blank" rel="noopener">Elastic Cloud on Kubernetes Quickstart</a></p><p><a href="https://github.com/elastic/cloud-on-k8s/tree/master/docs/design" target="_blank" rel="noopener">Elastic Cloud on k8s design</a></p><h1 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h1><p><a href="https://github.com/elastic/cloud-on-k8s" target="_blank" rel="noopener">cloud-on-k8s</a></p><h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><h2 id="Kubernetes集群"><a href="#Kubernetes集群" class="headerlink" title="Kubernetes集群"></a>Kubernetes集群</h2><ul><li>kubectl版本<code>v1.11+</code></li><li>kubectl当前content拥有cluster-admin权限</li></ul><h2 id="准备存储"><a href="#准备存储" class="headerlink" title="准备存储"></a>准备存储</h2><ul><li>出于测试目的，本文使用<code>emptyDir</code></li><li>另外还可以使用<code>volumeClaimTemplates</code>作为持久化数据存储</li></ul><h1 id="部署ECK"><a href="#部署ECK" class="headerlink" title="部署ECK"></a>部署ECK</h1><p>部署elastic-operator、CRD资源、RBAC</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://download.elastic.co/downloads/eck/0.9.0/all-in-one.yaml</span><br></pre></td></tr></table></figure><h2 id="检查部署情况"><a href="#检查部署情况" class="headerlink" title="检查部署情况"></a>检查部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n elastic-system get pod</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">elastic-operator-0   1/1     Running   1          50m</span><br></pre></td></tr></table></figure><h2 id="部署elasticsearch"><a href="#部署elasticsearch" class="headerlink" title="部署elasticsearch"></a>部署elasticsearch</h2><h3 id="编辑YAML文件"><a href="#编辑YAML文件" class="headerlink" title="编辑YAML文件"></a>编辑YAML文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">elasticsearch.k8s.elastic.co/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Elasticsearch</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearc-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">7.2</span><span class="number">.0</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.2.0</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    changeBudget:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># groups:</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-a</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-b</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># certificate:</span></span><br><span class="line">      <span class="comment">#   secretName: my-cert</span></span><br><span class="line"><span class="attr">      selfSignedCertificate:</span></span><br><span class="line">        <span class="comment"># subjectAltNames:</span></span><br><span class="line">        <span class="comment"># - ip: 160.46.176.15</span></span><br><span class="line">        <span class="comment"># - dns: hulk.example.com</span></span><br><span class="line"><span class="attr">        disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  nodes:</span></span><br><span class="line">  <span class="comment"># - nodeCount: 10</span></span><br><span class="line">  <span class="comment">#   config:</span></span><br><span class="line">  <span class="comment">#     node.master: false</span></span><br><span class="line">  <span class="comment">#     node.data: true</span></span><br><span class="line">  <span class="comment">#     node.ingest: true</span></span><br><span class="line">  <span class="comment">#     node.ml: true</span></span><br><span class="line">  <span class="comment">#     cluster.remote.connect: false</span></span><br><span class="line"><span class="attr">  - nodeCount:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line">      <span class="string">node.master:</span> <span class="literal">true</span></span><br><span class="line">      <span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line">      <span class="string">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    setVmMaxMapCount:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#    volumeClaimTemplates:</span></span><br><span class="line"><span class="comment">#    - metadata:</span></span><br><span class="line"><span class="comment">#        name: elasticsearch-data</span></span><br><span class="line"><span class="comment">#      spec:</span></span><br><span class="line"><span class="comment">#        accessModes:</span></span><br><span class="line"><span class="comment">#        - ReadWriteOnce</span></span><br><span class="line"><span class="comment">#        storageClassName: cephfs</span></span><br><span class="line"><span class="comment">#        resources:</span></span><br><span class="line"><span class="comment">#          requests:</span></span><br><span class="line"><span class="comment">#            storage: 10Gi</span></span><br><span class="line"><span class="attr">    podTemplate:</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line">        <span class="comment"># affinity:</span></span><br><span class="line">        <span class="comment">#   nodeAffinity:</span></span><br><span class="line">        <span class="comment">#     requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="comment">#       nodeSelectorTerms:</span></span><br><span class="line">        <span class="comment">#       - matchExpressions:</span></span><br><span class="line">        <span class="comment">#         - key: failure-domain.beta.kubernetes.io/zone</span></span><br><span class="line">        <span class="comment">#           operator: In</span></span><br><span class="line">        <span class="comment">#           values:</span></span><br><span class="line">        <span class="comment">#           - abc</span></span><br><span class="line">        <span class="comment"># initContainers:</span></span><br><span class="line">        <span class="comment">#  使用initContainers安装elasticsearch插件</span></span><br><span class="line">        <span class="comment"># - name: install-plugins</span></span><br><span class="line">        <span class="comment">#   command:</span></span><br><span class="line">        <span class="comment">#   - "sh"</span></span><br><span class="line">        <span class="comment">#   - "-c"</span></span><br><span class="line">        <span class="comment">#   - |</span></span><br><span class="line">        <span class="comment">#     bin/elasticsearch-plugin install --batch analysis-icu</span></span><br><span class="line"><span class="attr">        containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line"><span class="attr">            value:</span> <span class="bullet">-Xms2G</span> <span class="bullet">-Xmx2G</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">4</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">4</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">elasticsearch-data</span></span><br><span class="line"><span class="attr">          emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="部署YAML"><a href="#部署YAML" class="headerlink" title="部署YAML"></a>部署YAML</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f elasticsearch.yaml</span><br></pre></td></tr></table></figure><h2 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a>部署kibana</h2><h3 id="编辑YAML文件-1"><a href="#编辑YAML文件-1" class="headerlink" title="编辑YAML文件"></a>编辑YAML文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kibana.k8s.elastic.co/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kibana</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kibana-demo</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">7.2</span><span class="number">.0</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">docker.elastic.co/kibana/kibana:7.2.0</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    changeBudget:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># groups:</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-a</span></span><br><span class="line">    <span class="comment"># - selector:</span></span><br><span class="line">    <span class="comment">#     matchLabels:</span></span><br><span class="line">    <span class="comment">#       nodesGroup: group-b</span></span><br><span class="line"><span class="attr">  nodeCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line">      <span class="comment"># certificate:</span></span><br><span class="line">      <span class="comment">#   secretName: my-cert</span></span><br><span class="line"><span class="attr">      selfSignedCertificate:</span></span><br><span class="line">        <span class="comment"># subjectAltNames:</span></span><br><span class="line">        <span class="comment"># - ip: 160.46.176.15</span></span><br><span class="line">        <span class="comment"># - dns: hulk.example.com</span></span><br><span class="line"><span class="attr">        disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  elasticsearchRef:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">elasticsearc-demo</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  podTemplate:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">I18N_LOCALE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">zh-CN</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">2</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br></pre></td></tr></table></figure><h3 id="部署YAML-1"><a href="#部署YAML-1" class="headerlink" title="部署YAML"></a>部署YAML</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kibana.yaml</span><br></pre></td></tr></table></figure><h1 id="验证和访问服务"><a href="#验证和访问服务" class="headerlink" title="验证和访问服务"></a>验证和访问服务</h1><h2 id="查看elasticsearch"><a href="#查看elasticsearch" class="headerlink" title="查看elasticsearch"></a>查看elasticsearch</h2><h3 id="查看Pod"><a href="#查看Pod" class="headerlink" title="查看Pod"></a>查看Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l common.k8s.elastic.co/type=elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">elasticsearc-demo-es-6vpj7k9qxk   1/1     Running   1          38m</span><br><span class="line">elasticsearc-demo-es-x8nzjksw84   1/1     Running   1          38m</span><br></pre></td></tr></table></figure><h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                HEALTH   NODES   VERSION   PHASE         AGE</span><br><span class="line">elasticsearc-demo   green    2       7.2.0     Operational   34m</span><br></pre></td></tr></table></figure><h3 id="查看secret"><a href="#查看secret" class="headerlink" title="查看secret"></a>查看secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -l common.k8s.elastic.co/type=elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NAME                                          TYPE     DATA   AGE</span><br><span class="line">elasticsearc-demo-es-elastic-user             Opaque   1      38m</span><br><span class="line">elasticsearc-demo-es-http-ca-internal         Opaque   2      38m</span><br><span class="line">elasticsearc-demo-es-http-certs-internal      Opaque   2      38m</span><br><span class="line">elasticsearc-demo-es-internal-users           Opaque   3      38m</span><br><span class="line">elasticsearc-demo-es-transport-ca-internal    Opaque   2      38m</span><br><span class="line">elasticsearc-demo-es-transport-certs-public   Opaque   1      38m</span><br><span class="line">elasticsearc-demo-es-xpack-file-realm         Opaque   3      38m</span><br></pre></td></tr></table></figure><h2 id="查看kibana"><a href="#查看kibana" class="headerlink" title="查看kibana"></a>查看kibana</h2><h3 id="查看Pod-1"><a href="#查看Pod-1" class="headerlink" title="查看Pod"></a>查看Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">kibana-demo-kb-77cc75688f-lwqnk   1/1     Running   0          37m</span><br></pre></td></tr></table></figure><h3 id="查看集群状态-1"><a href="#查看集群状态-1" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          HEALTH   NODES   VERSION   AGE</span><br><span class="line">kibana-demo   green    1       7.2.0     35m</span><br></pre></td></tr></table></figure><h3 id="查看secret-1"><a href="#查看secret-1" class="headerlink" title="查看secret"></a>查看secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                                 TYPE     DATA   AGE</span><br><span class="line">kibana-demo-kb-es-ca                 Opaque   1      40m</span><br><span class="line">kibana-demo-kb-http-ca-internal      Opaque   2      37m</span><br><span class="line">kibana-demo-kb-http-certs-internal   Opaque   2      37m</span><br><span class="line">kibana-demo-kibana-user              Opaque   1      40m</span><br></pre></td></tr></table></figure><h2 id="获取用户名密码"><a href="#获取用户名密码" class="headerlink" title="获取用户名密码"></a>获取用户名密码</h2><p>默认用户名是<code>elastic</code></p><p>访问elasticsearch和kibana的密码存放在<code>elasticsearc-demo-es-elastic-user</code>可以通过以下方式获取</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ELASTIC_PASSWORD=$(kubectl get secrets elasticsearc-demo-es-elastic-user -o=jsonpath='&#123;.data.elastic&#125;' | base64 --decode)</span><br><span class="line">echo $ELASTIC_PASSWORD</span><br></pre></td></tr></table></figure><h2 id="访问服务"><a href="#访问服务" class="headerlink" title="访问服务"></a>访问服务</h2><h3 id="获取svc"><a href="#获取svc" class="headerlink" title="获取svc"></a>获取svc</h3><h4 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -l common.k8s.elastic.co/type=elasticsearch</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">elasticsearc-demo-es-http   ClusterIP   10.96.217.252   &lt;none&gt;        9200/TCP   43m</span><br></pre></td></tr></table></figure><h4 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kibana-demo-kb-http   ClusterIP   10.96.102.185   &lt;none&gt;        5601/TCP   44m</span><br></pre></td></tr></table></figure><h3 id="访问elasticsearch"><a href="#访问elasticsearch" class="headerlink" title="访问elasticsearch"></a>访问elasticsearch</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k -u "elastic:$&#123;ELASTIC_PASSWORD&#125;" "http://10.96.217.252:9200"</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"elasticsearc-demo-es-x8nzjksw84"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearc-demo"</span>,</span><br><span class="line">  <span class="attr">"cluster_uuid"</span> : <span class="string">"U8xgFU1NSB6o8qmKYgYyxw"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"7.2.0"</span>,</span><br><span class="line">    <span class="attr">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="attr">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"508c38a"</span>,</span><br><span class="line">    <span class="attr">"build_date"</span> : <span class="string">"2019-06-20T15:54:18.811730Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"8.0.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="访问kibana"><a href="#访问kibana" class="headerlink" title="访问kibana"></a>访问kibana</h3><h4 id="修改svc为NodePort"><a href="#修改svc为NodePort" class="headerlink" title="修改svc为NodePort"></a>修改svc为NodePort</h4><blockquote><p>这种做法比较low，建议走<code>Ingress Controller</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch svc kibana-demo-kb-http -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;'</span><br></pre></td></tr></table></figure><h4 id="获取端口"><a href="#获取端口" class="headerlink" title="获取端口"></a>获取端口</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -l common.k8s.elastic.co/type=kibana</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kibana-demo-kb-http         NodePort    10.96.102.185   &lt;none&gt;        5601:31364/TCP   47m</span><br></pre></td></tr></table></figure><h4 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h4><p><code>https://k8s-master:31364</code></p><h4 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h4><ul><li>用户名：<code>elastic</code></li><li>密码：上面访问elasticsearch时的密码</li></ul><h3 id="创建ingress规则"><a href="#创建ingress规则" class="headerlink" title="创建ingress规则"></a>创建ingress规则</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">"HTTPS"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">elasticsearch.default.cluster.local</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">elasticsearch-demo-es-http</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">9200</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kibana-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">"HTTPS"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">kibana.default.cluster.local</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">kibana-demo-kb-http</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">5601</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;仅记录操作过程和部署过程&lt;/li&gt;&lt;li&gt;请考虑再三之后再决定是否上生产环境！&lt;/li&gt;&lt;li&gt;操作系统使用的&lt;code&gt;Cent
      
    
    </summary>
    
      <category term="Elasticsearch" scheme="https://luanlengli.github.io/categories/Elasticsearch/"/>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Elasticsearch/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="Elasticsearch" scheme="https://luanlengli.github.io/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes部署TiDB数据库集群</title>
    <link href="https://luanlengli.github.io/2019/07/29/Kubernetes%E9%83%A8%E7%BD%B2TiDB%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2019/07/29/Kubernetes部署TiDB数据库集群.html</id>
    <published>2019-07-29T06:29:58.000Z</published>
    <updated>2019-08-04T03:47:24.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录操作过程和部署过程</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>虚拟机配置<code>4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘B</code></li><li>Kubernetes集群版本<code>v1.14.4</code></li><li>使用本地PV作为数据存储</li><li>TiDB-Operator版本<code>v1.0.0</code></li><li>TiDB组件版本<code>v3.0.1</code></li></ul><h2 id="服务器拓扑"><a href="#服务器拓扑" class="headerlink" title="服务器拓扑"></a>服务器拓扑</h2><table><thead><tr><th>服务器IP</th><th>部署实例</th></tr></thead><tbody><tr><td>172.16.80.201</td><td>TiKv*1 TiDB*1 PD*1</td></tr><tr><td>172.16.80.202</td><td>TiKv*1 TiDB*1 PD*1</td></tr><tr><td>172.16.80.203</td><td>TiKv*1 TiDB*1 PD*1</td></tr></tbody></table><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h2><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="安装Helm服务端"><a href="#安装Helm服务端" class="headerlink" title="安装Helm服务端"></a>安装Helm服务端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image gcr.azk8s.cn/google_containers/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h3 id="检查部署结果"><a href="#检查部署结果" class="headerlink" title="检查部署结果"></a>检查部署结果</h3><h4 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h4 id="查看Helm版本信息"><a href="#查看Helm版本信息" class="headerlink" title="查看Helm版本信息"></a>查看Helm版本信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h2 id="添加Helm-Repo"><a href="#添加Helm-Repo" class="headerlink" title="添加Helm Repo"></a>添加Helm Repo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add pingcap https://charts.pingcap.org/</span><br></pre></td></tr></table></figure><h2 id="更新helm缓存"><a href="#更新helm缓存" class="headerlink" title="更新helm缓存"></a>更新helm缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure><h2 id="查看TiDB-Operator版本"><a href="#查看TiDB-Operator版本" class="headerlink" title="查看TiDB-Operator版本"></a>查看TiDB-Operator版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search pingcap -l</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME                 CHART VERSIONAPP VERSIONDESCRIPTION                            </span><br><span class="line">pingcap/tidb-backup  v1.0.0                  A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  v1.0.0-rc.1             A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  v1.0.0-beta.3           A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  v1.0.0-beta.2           A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-cluster v1.0.0                  A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster v1.0.0-rc.1             A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster v1.0.0-beta.3           A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster v1.0.0-beta.2           A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-operatorv1.0.0                  tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operatorv1.0.0-rc.1             tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operatorv1.0.0-beta.3           tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operatorv1.0.0-beta.2           tidb-operator Helm chart for Kubernetes</span><br></pre></td></tr></table></figure><h2 id="配置本地PV"><a href="#配置本地PV" class="headerlink" title="配置本地PV"></a>配置本地PV</h2><p>参考【<a href="https://luanlengli.github.io/2019/07/23/Kubernetes创建本地PV.html">Kubernetes创建本地PV</a>】</p><p><font color="red">修改ext4挂载选项</font>为<code>defaults,nodelalloc,noatime</code></p><blockquote><p>示例如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=f8727d20-3ef9-4f83-b865-25943bc342a6 /mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6 ext4 defaults,nodelalloc,noatime 0 2</span><br></pre></td></tr></table></figure><h2 id="创建CRD"><a href="#创建CRD" class="headerlink" title="创建CRD"></a>创建CRD</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/crd.yaml</span><br></pre></td></tr></table></figure><h1 id="部署TiDB-Operator"><a href="#部署TiDB-Operator" class="headerlink" title="部署TiDB-Operator"></a>部署TiDB-Operator</h1><h2 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/TiDB</span><br></pre></td></tr></table></figure><h2 id="下载TiDB-Operator-Chart包"><a href="#下载TiDB-Operator-Chart包" class="headerlink" title="下载TiDB-Operator Chart包"></a>下载TiDB-Operator Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/TiDB</span><br><span class="line">helm fetch pingcap/tidb-operator --version=v1.0.0</span><br></pre></td></tr></table></figure><h2 id="解压Chart包"><a href="#解压Chart包" class="headerlink" title="解压Chart包"></a>解压Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf tidb-operator-v1.0.0.tgz</span><br></pre></td></tr></table></figure><h2 id="编辑values-yaml"><a href="#编辑values-yaml" class="headerlink" title="编辑values.yaml"></a>编辑values.yaml</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default values for tidb-operator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clusterScoped is whether tidb-operator should manage kubernetes cluster wide tidb clusters</span></span><br><span class="line"><span class="comment"># Also see rbac.create and controllerManager.serviceAccount</span></span><br><span class="line"><span class="attr">clusterScoped:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Also see clusterScoped and controllerManager.serviceAccount</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># operatorImage is TiDB Operator image</span></span><br><span class="line"><span class="attr">operatorImage:</span> <span class="string">pingcap/tidb-operator:v1.0.0</span></span><br><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">defaultStorageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line"><span class="attr">controllerManager:</span></span><br><span class="line">  <span class="comment"># With rbac.create=false, the user is responsible for creating this account</span></span><br><span class="line">  <span class="comment"># With rbac.create=true, this service account will be created</span></span><br><span class="line">  <span class="comment"># Also see rbac.create and clusterScoped</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">tidb-controller-manager</span></span><br><span class="line"><span class="attr">  logLevel:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line">  <span class="comment"># autoFailover is whether tidb-operator should auto failover when failure occurs</span></span><br><span class="line"><span class="attr">  autoFailover:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># pd failover period default(5m)</span></span><br><span class="line"><span class="attr">  pdFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line">  <span class="comment"># tikv failover period default(5m)</span></span><br><span class="line"><span class="attr">  tikvFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line">  <span class="comment"># tidb failover period default(5m)</span></span><br><span class="line"><span class="attr">  tidbFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="comment"># With rbac.create=false, the user is responsible for creating this account</span></span><br><span class="line">  <span class="comment"># With rbac.create=true, this service account will be created</span></span><br><span class="line">  <span class="comment"># Also see rbac.create and clusterScoped</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">tidb-scheduler</span></span><br><span class="line"><span class="attr">  logLevel:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  schedulerName:</span> <span class="string">tidb-scheduler</span></span><br><span class="line">  <span class="comment"># features:</span></span><br><span class="line">  <span class="comment"># - StableScheduling=true</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">  kubeSchedulerImageName:</span> <span class="string">gcr.azk8s.cn/google_containers/kube-scheduler</span></span><br><span class="line">  <span class="comment"># This will default to matching your kubernetes version</span></span><br><span class="line">  <span class="comment"># kubeSchedulerImageTag:</span></span><br></pre></td></tr></table></figure><h2 id="部署Operator"><a href="#部署Operator" class="headerlink" title="部署Operator"></a>部署Operator</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install pingcap/tidb-operator \</span><br><span class="line">     --name=tidb-operator \</span><br><span class="line">     --namespace=tidb-admin \</span><br><span class="line">     --version=v1.0.0 \</span><br><span class="line">     -f /home/tidb/tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Operator部署情况"><a href="#查看Operator部署情况" class="headerlink" title="查看Operator部署情况"></a>查看Operator部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb-admin get pod -l app.kubernetes.io/name=tidb-operator</span><br></pre></td></tr></table></figure><h1 id="部署TiDB-Cluster"><a href="#部署TiDB-Cluster" class="headerlink" title="部署TiDB-Cluster"></a>部署TiDB-Cluster</h1><h2 id="创建工作目录-1"><a href="#创建工作目录-1" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/TiDB</span><br></pre></td></tr></table></figure><h2 id="下载Chart包"><a href="#下载Chart包" class="headerlink" title="下载Chart包"></a>下载Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/TiDB</span><br><span class="line">helm fetch pingcap/tidb-cluster --version=v1.0.0</span><br></pre></td></tr></table></figure><h2 id="解压Chart包-1"><a href="#解压Chart包-1" class="headerlink" title="解压Chart包"></a>解压Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf tidb-cluster-v1.0.0.tgz</span><br></pre></td></tr></table></figure><h2 id="编辑values-yaml-1"><a href="#编辑values-yaml-1" class="headerlink" title="编辑values.yaml"></a>编辑values.yaml</h2><p>配置含义请看这里【<a href="https://pingcap.com/docs-cn/v3.0/tidb-in-kubernetes/reference/configuration/tidb-cluster/" target="_blank" rel="noopener">Kubernetes 上的 TiDB 集群配置</a>】</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim tidb-cluster/values.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改后如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default values for tidb-cluster.</span></span><br><span class="line"><span class="comment"># This is a YAML-formatted file.</span></span><br><span class="line"><span class="comment"># Declare variables to be passed into your templates.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Also see monitor.serviceAccount</span></span><br><span class="line"><span class="comment"># If you set rbac.create to false, you need to provide a value for monitor.serviceAccount</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clusterName is the TiDB cluster name, if not specified, the chart release name will be used</span></span><br><span class="line"><span class="comment"># clusterName: demo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add additional TidbCluster labels</span></span><br><span class="line"><span class="comment"># ref: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/</span></span><br><span class="line"><span class="attr">extraLabels:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># schedulerName must be same with charts/tidb-operator/values#scheduler.schedulerName</span></span><br><span class="line"><span class="attr">schedulerName:</span> <span class="string">tidb-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># timezone is the default system timzone for TiDB</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default reclaim policy of a PV</span></span><br><span class="line"><span class="attr">pvReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># services is the service list to expose, default is ClusterIP</span></span><br><span class="line"><span class="comment"># can be ClusterIP | NodePort | LoadBalancer</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">pd</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tidb-operator:v1.0.0</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whether enable ConfigMap Rollout management.</span></span><br><span class="line"><span class="comment"># When enabling, change of ConfigMap will trigger a graceful rolling-update of the component.</span></span><br><span class="line"><span class="comment"># This feature is only available in tidb-operator v1.0 or higher.</span></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> Switch this variable against an existing cluster will cause an rolling-update of each component even</span></span><br><span class="line"><span class="comment"># if the ConfigMap was not changed.</span></span><br><span class="line"><span class="attr">enableConfigMapRollout:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pd:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/pingcap/pd/blob/master/conf/config.toml for the default</span></span><br><span class="line">  <span class="comment"># pd configurations (change to the tags of your pd version), </span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/pd-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your pd) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [log]</span></span><br><span class="line"><span class="string">    level = "info"</span></span><br><span class="line"><span class="string">    [replication]</span></span><br><span class="line"><span class="string">    location-labels = ["region", "zone", "rack", "host"]</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/pd:v3.0.1</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 8000m</span></span><br><span class="line">    <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line">      <span class="comment"># cpu: 4000m</span></span><br><span class="line">      <span class="comment"># memory: 4Gi</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines pd scheduling rules,it's default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment">## The following is typical example of affinity settings:</span></span><br><span class="line">  <span class="comment">## The PodAntiAffinity setting of the example keeps PD pods does not co-locate on a topology node as far as possible to improve the disaster tolerance of PD on Kubernetes.</span></span><br><span class="line">  <span class="comment">## The NodeAffinity setting of the example ensure that the PD pods can only be scheduled to nodes with label:[type="pd"],</span></span><br><span class="line">  <span class="comment"># affinity:</span></span><br><span class="line">  <span class="comment">#   podAntiAffinity:</span></span><br><span class="line">  <span class="comment">#     preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named region</span></span><br><span class="line">  <span class="comment">#     - weight: 10</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "region"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named zone</span></span><br><span class="line">  <span class="comment">#     - weight: 20</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "zone"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named rack</span></span><br><span class="line">  <span class="comment">#     - weight: 40</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "rack"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named kubernetes.io/hostname</span></span><br><span class="line">  <span class="comment">#     - weight: 80</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "kubernetes.io/hostname"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#   nodeAffinity:</span></span><br><span class="line">  <span class="comment">#     requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">  <span class="comment">#       nodeSelectorTerms:</span></span><br><span class="line">  <span class="comment">#       - matchExpressions:</span></span><br><span class="line">  <span class="comment">#         - key: "kind"</span></span><br><span class="line">  <span class="comment">#           operator: In</span></span><br><span class="line">  <span class="comment">#           values:</span></span><br><span class="line">  <span class="comment">#           - "pd"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tikv:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/tikv/tikv/blob/master/etc/config-template.toml for the default</span></span><br><span class="line">  <span class="comment"># tikv configurations (change to the tags of your tikv version),</span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/tikv-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your tikv) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    log-level = "info"</span></span><br><span class="line"><span class="string">    [server]</span></span><br><span class="line"><span class="string">    status-addr = "0.0.0.0:20180"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Here are some parameters you may want to customize (Please configure in the above 'config' section):</span></span><br><span class="line"><span class="string">  # [readpool.storage]</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for high-priority operations.</span></span><br><span class="line"><span class="string">  # # high-concurrency = 4</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for normal-priority operations.</span></span><br><span class="line"><span class="string">  # # normal-concurrency = 4</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for low-priority operations.</span></span><br><span class="line"><span class="string">  # # low-concurrency = 4</span></span><br><span class="line"><span class="string">  # [readpool.coprocessor]</span></span><br><span class="line"><span class="string">  # ## Most read requests from TiDB are sent to the coprocessor of TiKV. high/normal/low-concurrency is</span></span><br><span class="line"><span class="string">  # ## used to set the number of threads of the coprocessor.</span></span><br><span class="line"><span class="string">  # ## If there are many read requests, you can increase these config values (but keep it within the</span></span><br><span class="line"><span class="string">  # ## number of system CPU cores). For example, for a 32-core machine deployed with TiKV, you can even</span></span><br><span class="line"><span class="string">  # ## set these config to 30 in heavy read scenarios.</span></span><br><span class="line"><span class="string">  # ## If CPU_NUM &gt; 8, the default thread pool size for coprocessors is set to CPU_NUM * 0.8.</span></span><br><span class="line"><span class="string">  # # high-concurrency = 8</span></span><br><span class="line"><span class="string">  # # normal-concurrency = 8</span></span><br><span class="line"><span class="string">  # # low-concurrency = 8</span></span><br><span class="line"><span class="string">  # [server]</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for the gRPC server.</span></span><br><span class="line"><span class="string">  # # grpc-concurrency = 4</span></span><br><span class="line"><span class="string">  # [storage]</span></span><br><span class="line"><span class="string">  # ## Scheduler's worker pool size, i.e. the number of write threads.</span></span><br><span class="line"><span class="string">  # ## It should be less than total CPU cores. When there are frequent write operations, set it to a</span></span><br><span class="line"><span class="string">  # ## higher value. More specifically, you can run `top -H -p tikv-pid` to check whether the threads</span></span><br><span class="line"><span class="string">  # ## named `sched-worker-pool` are busy.</span></span><br><span class="line"><span class="string">  # # scheduler-worker-pool-size = 4</span></span><br><span class="line"><span class="string">  #### Below parameters available in TiKV 2.x only</span></span><br><span class="line"><span class="string">  # [rocksdb.defaultcf]</span></span><br><span class="line"><span class="string">  # ## block-cache used to cache uncompressed blocks, big block-cache can speed up read.</span></span><br><span class="line"><span class="string">  # ## in normal cases should tune to 30%-50% tikv.resources.limits.memory</span></span><br><span class="line"><span class="string">  # # block-cache-size = "1GB"</span></span><br><span class="line"><span class="string">  # [rocksdb.writecf]</span></span><br><span class="line"><span class="string">  # ## in normal cases should tune to 10%-30% tikv.resources.limits.memory</span></span><br><span class="line"><span class="string">  # # block-cache-size = "256MB"</span></span><br><span class="line"><span class="string">  #### Below parameters available in TiKV 3.x and above only</span></span><br><span class="line"><span class="string">  # [storage.block-cache]</span></span><br><span class="line"><span class="string">  # ## Size of the shared block cache. Normally it should be tuned to 30%-50% of container's total memory.</span></span><br><span class="line"><span class="string">  # # capacity = "1GB"</span></span><br><span class="line"><span class="string">  # [raftstore]</span></span><br><span class="line"><span class="string">  # ## true (default value) for high reliability, this can prevent data loss when power failure.</span></span><br><span class="line"><span class="string">  # # sync-log = true</span></span><br><span class="line"><span class="string">  # # apply-pool-size = 2</span></span><br><span class="line"><span class="string">  # # store-pool-size = 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tikv:v3.0.1</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 16000m</span></span><br><span class="line">    <span class="comment">#   memory: 32Gi</span></span><br><span class="line">    <span class="comment">#   storage: 300Gi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line">      <span class="comment"># cpu: 12000m</span></span><br><span class="line">      <span class="comment"># memory: 24Gi</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines tikv scheduling rules,affinity default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tidb:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/pingcap/tidb/blob/master/config/config.toml.example for the default</span></span><br><span class="line">  <span class="comment"># tidb configurations(change to the tags of your tidb version),</span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/tidb-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your tidb) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [log]</span></span><br><span class="line"><span class="string">    level = "info"</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># The secret name of root password, you can create secret with following command:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic tidb-secret --from-literal=root=&lt;root-password&gt; --namespace=&lt;namespace&gt;</span></span><br><span class="line">  <span class="comment"># If unset, the root password will be empty and you can set it after connecting</span></span><br><span class="line">  <span class="comment"># passwordSecretName: tidb-secret</span></span><br><span class="line">  <span class="comment"># initSql is the SQL statements executed after the TiDB cluster is bootstrapped.</span></span><br><span class="line">  <span class="comment"># initSql: |-</span></span><br><span class="line">  <span class="comment">#   create database app;</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tidb:v3.0.1</span></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 16000m</span></span><br><span class="line">    <span class="comment">#   memory: 16Gi</span></span><br><span class="line"><span class="attr">    requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 12000m</span></span><br><span class="line">    <span class="comment">#   memory: 12Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines tikv scheduling rules,affinity default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  maxFailoverCount:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">    exposeStatus:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># annotations:</span></span><br><span class="line">      <span class="comment"># cloud.google.com/load-balancer-type: Internal</span></span><br><span class="line"><span class="attr">  separateSlowLog:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  slowLogTailer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:1.26.2</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">20</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">5</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># tidb plugin configuration</span></span><br><span class="line"><span class="attr">  plugin:</span></span><br><span class="line">    <span class="comment"># enable plugin or not</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># the start argument to specify the folder containing</span></span><br><span class="line"><span class="attr">    directory:</span> <span class="string">/plugins</span></span><br><span class="line">    <span class="comment"># the start argument to specify the plugin id (name "-" version) that needs to be loaded, e.g. 'conn_limit-1'.</span></span><br><span class="line"><span class="attr">    list:</span> <span class="string">["whitelist-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysqlClient is used to set password for TiDB</span></span><br><span class="line"><span class="comment"># it must has Python MySQL client installed</span></span><br><span class="line"><span class="attr">mysqlClient:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">tnir/mysqlclient</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">monitor:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Also see rbac.create</span></span><br><span class="line">  <span class="comment"># If you set rbac.create to false, you need to provide a value here.</span></span><br><span class="line">  <span class="comment"># If you set rbac.create to true, you should leave this empty.</span></span><br><span class="line">  <span class="comment"># serviceAccount:</span></span><br><span class="line"><span class="attr">  persistent:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  initializer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-monitor-initializer:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  reloader:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-monitor-reloader:v1.0.0</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  grafana:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">grafana/grafana:6.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 8000m</span></span><br><span class="line">      <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">      requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 4000m</span></span><br><span class="line">      <span class="comment">#   memory: 4Gi</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line">      <span class="comment"># Configure Grafana using environment variables except GF_PATHS_DATA, GF_SECURITY_ADMIN_USER and GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">      <span class="comment"># Ref https://grafana.com/docs/installation/configuration/#using-environment-variables</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ENABLED:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ORG_NAME:</span> <span class="string">"Main Org."</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ORG_ROLE:</span> <span class="string">"Viewer"</span></span><br><span class="line">      <span class="comment"># if grafana is running behind a reverse proxy with subpath http://foo.bar/grafana</span></span><br><span class="line">      <span class="comment"># GF_SERVER_DOMAIN: foo.bar</span></span><br><span class="line">      <span class="comment"># GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s/grafana/"</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  prometheus:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">prom/prometheus:v2.11.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 8000m</span></span><br><span class="line">      <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">      requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 4000m</span></span><br><span class="line">      <span class="comment">#   memory: 4Gi</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">    reserveDays:</span> <span class="number">12</span></span><br><span class="line">    <span class="comment"># alertmanagerURL: ""</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># kind: monitor</span></span><br><span class="line">    <span class="comment"># zone: cn-bj1-01,cn-bj1-02</span></span><br><span class="line">    <span class="comment"># region: cn-bj1</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">binlog:</span></span><br><span class="line"><span class="attr">  pump:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-binlog:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line">    <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">    <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">    <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">    <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">    storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">    syncLog:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># a integer value to control expiry date of the binlog data, indicates for how long (in days) the binlog data would be stored.</span></span><br><span class="line">    <span class="comment"># must bigger than 0</span></span><br><span class="line"><span class="attr">    gc:</span> <span class="number">7</span></span><br><span class="line">    <span class="comment"># number of seconds between heartbeat ticks (in 2 seconds)</span></span><br><span class="line"><span class="attr">    heartbeatInterval:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  drainer:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-binlog:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line">    <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">    <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">    <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">    <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">    storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line">    <span class="comment"># the number of the concurrency of the downstream for synchronization. The bigger the value,</span></span><br><span class="line">    <span class="comment"># the better throughput performance of the concurrency (16 by default)</span></span><br><span class="line"><span class="attr">    workerCount:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># the interval time (in seconds) of detect pumps' status (default 10)</span></span><br><span class="line"><span class="attr">    detectInterval:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># disbale detect causality</span></span><br><span class="line"><span class="attr">    disableDetect:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># disable dispatching sqls that in one same binlog; if set true, work-count and txn-batch would be useless</span></span><br><span class="line"><span class="attr">    disableDispatch:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># # disable sync these schema</span></span><br><span class="line"><span class="attr">    ignoreSchemas:</span> <span class="string">"INFORMATION_SCHEMA,PERFORMANCE_SCHEMA,mysql,test"</span></span><br><span class="line">    <span class="comment"># if drainer donesn't have checkpoint, use initial commitTS to initial checkpoint</span></span><br><span class="line"><span class="attr">    initialCommitTs:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># enable safe mode to make syncer reentrant</span></span><br><span class="line"><span class="attr">    safeMode:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># the number of SQL statements of a transaction that are output to the downstream database (20 by default)</span></span><br><span class="line"><span class="attr">    txnBatch:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># downstream storage, equal to --dest-db-type</span></span><br><span class="line">    <span class="comment"># valid values are "mysql", "pb", "kafka"</span></span><br><span class="line"><span class="attr">    destDBType:</span> <span class="string">pb</span></span><br><span class="line"><span class="attr">    mysql:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment"># host: "127.0.0.1"</span></span><br><span class="line">      <span class="comment"># user: "root"</span></span><br><span class="line">      <span class="comment"># password: ""</span></span><br><span class="line">      <span class="comment"># port: 3306</span></span><br><span class="line">      <span class="comment"># # Time and size limits for flash batch write</span></span><br><span class="line">      <span class="comment"># timeLimit: "30s"</span></span><br><span class="line">      <span class="comment"># sizeLimit: "100000"</span></span><br><span class="line"><span class="attr">    kafka:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment"># only need config one of zookeeper-addrs and kafka-addrs, will get kafka address if zookeeper-addrs is configed.</span></span><br><span class="line">      <span class="comment"># zookeeperAddrs: "127.0.0.1:2181"</span></span><br><span class="line">      <span class="comment"># kafkaAddrs: "127.0.0.1:9092"</span></span><br><span class="line">      <span class="comment"># kafkaVersion: "0.8.2.0"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scheduledBackup:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># https://github.com/pingcap/tidb-cloud-backup</span></span><br><span class="line"><span class="attr">  mydumperImage:</span> <span class="string">pingcap/tidb-cloud-backup:20190610</span></span><br><span class="line"><span class="attr">  mydumperImagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  storage:</span> <span class="number">100</span><span class="string">Gi</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#schedule</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">"0 0 * * *"</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#suspend</span></span><br><span class="line"><span class="attr">  suspend:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#jobs-history-limits</span></span><br><span class="line"><span class="attr">  successfulJobsHistoryLimit:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  failedJobsHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#starting-deadline</span></span><br><span class="line"><span class="attr">  startingDeadlineSeconds:</span> <span class="number">3600</span></span><br><span class="line">  <span class="comment"># https://github.com/maxbube/mydumper/blob/master/docs/mydumper_usage.rst#options</span></span><br><span class="line"><span class="attr">  options:</span> <span class="string">"--verbose=3"</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores user and password used for backup</span></span><br><span class="line">  <span class="comment"># <span class="doctag">Note:</span> you must give the user enough privilege to do the backup</span></span><br><span class="line">  <span class="comment"># you can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic backup-secret --from-literal=user=root --from-literal=password=&lt;password&gt;</span></span><br><span class="line"><span class="attr">  secretName:</span> <span class="string">backup-secret</span></span><br><span class="line">  <span class="comment"># backup to gcp</span></span><br><span class="line"><span class="attr">  gcp:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores the gcp service account credentials json file</span></span><br><span class="line">  <span class="comment"># The service account must have read/write permission to the above bucket.</span></span><br><span class="line">  <span class="comment"># Read the following document to create the service account and download the credentials file as credentials.json:</span></span><br><span class="line">  <span class="comment"># https://cloud.google.com/docs/authentication/production#obtaining_and_providing_service_account_credentials_manually</span></span><br><span class="line">  <span class="comment"># And then create the secret by: kubectl create secret generic gcp-backup-secret --from-file=./credentials.json</span></span><br><span class="line">  <span class="comment"># secretName: gcp-backup-secret</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># backup to ceph object storage</span></span><br><span class="line"><span class="attr">  ceph:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># endpoint: ""</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores ceph object store access key and secret key</span></span><br><span class="line">  <span class="comment"># You can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic ceph-backup-secret --from-literal=access_key=&lt;access-key&gt; --from-literal=secret_key=&lt;secret-key&gt;</span></span><br><span class="line">  <span class="comment"># secretName: ceph-backup-secret</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># backup to s3</span></span><br><span class="line"><span class="attr">  s3:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># region: ""</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores s3 object store access key and secret key</span></span><br><span class="line">  <span class="comment"># You can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic s3-backup-secret --from-literal=access_key=&lt;access-key&gt; --from-literal=secret_key=&lt;secret-key&gt;</span></span><br><span class="line">  <span class="comment"># secretName: s3-backup-secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metaInstance:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">metaType:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.type &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">metaValue:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><h2 id="部署Cluster"><a href="#部署Cluster" class="headerlink" title="部署Cluster"></a>部署Cluster</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install pingcap/tidb-cluster \</span><br><span class="line">     --name=tidb-cluster \</span><br><span class="line">     --namespace=tidb \</span><br><span class="line">     --version=v1.0.0 \</span><br><span class="line">     -f /home/tidb/tidb-cluster/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Cluster部署情况"><a href="#查看Cluster部署情况" class="headerlink" title="查看Cluster部署情况"></a>查看Cluster部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get pods -l app.kubernetes.io/instance=tidb-cluster</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">tidb-cluster-discovery-84d6cf454c-6c2cl   1/1     Running   0          77m</span><br><span class="line">tidb-cluster-monitor-77cd9d7965-49v8t     3/3     Running   0          77m</span><br><span class="line">tidb-cluster-pd-0                         1/1     Running   0          23m</span><br><span class="line">tidb-cluster-pd-1                         1/1     Running   0          72m</span><br><span class="line">tidb-cluster-pd-2                         1/1     Running   0          72m</span><br><span class="line">tidb-cluster-tidb-0                       2/2     Running   0          2m11s</span><br><span class="line">tidb-cluster-tidb-1                       2/2     Running   0          2m2s</span><br><span class="line">tidb-cluster-tidb-2                       2/2     Running   0          100s</span><br><span class="line">tidb-cluster-tikv-0                       1/1     Running   0          8m56s</span><br><span class="line">tidb-cluster-tikv-1                       1/1     Running   0          8m54s</span><br><span class="line">tidb-cluster-tikv-2                       1/1     Running   0          8m52s</span><br></pre></td></tr></table></figure><h1 id="访问TiDB"><a href="#访问TiDB" class="headerlink" title="访问TiDB"></a>访问TiDB</h1><blockquote><p>TiDB兼容MySQL，因此能直接使用MySQL客户端连接TiDB集群</p><p>这里使用<code>mysql-community-client-5.7.27-1.el7</code>作为客户端程序</p></blockquote><h2 id="获取TiDB-Service信息"><a href="#获取TiDB-Service信息" class="headerlink" title="获取TiDB Service信息"></a>获取TiDB Service信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get svc -l app.kubernetes.io/component=tidb</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">tidb-cluster-tidb        NodePort    10.96.129.51   &lt;none&gt;        4000:30944/TCP,10080:32052/TCP   85m</span><br><span class="line">tidb-cluster-tidb-peer   ClusterIP   None           &lt;none&gt;        10080/TCP                        19m</span><br></pre></td></tr></table></figure><p>从输出示例，可以看到<code>tidb-cluster-tidb</code>是<code>NodePort</code>类型，业务端口<code>4000</code>被映射为节点的<code>30944</code>端口，直接通过此端口即可访问TiDB。</p><h2 id="登录TiDB"><a href="#登录TiDB" class="headerlink" title="登录TiDB"></a>登录TiDB</h2><p>默认集群部署完成后，root用户是无密码的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -P 30944 -h k8s-master</span><br></pre></td></tr></table></figure><h2 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h2><h3 id="查看系统表mysql-tidb"><a href="#查看系统表mysql-tidb" class="headerlink" title="查看系统表mysql.tidb"></a>查看系统表mysql.tidb</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select VARIABLE_NAME,VARIABLE_VALUE from mysql.tidb;</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| VARIABLE_NAME            | VARIABLE_VALUE                                                                                   |</span><br><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| bootstrapped             | True                                                                                             |</span><br><span class="line">| tidb_server_version      | 33                                                                                               |</span><br><span class="line">| system_tz                | Asia/Shanghai                                                                                    |</span><br><span class="line">| tikv_gc_leader_uuid      | 5b16245c9840001                                                                                  |</span><br><span class="line">| tikv_gc_leader_desc      | host:tidb-cluster-tidb-0, pid:1, start at 2019-08-04 01:40:22.757972817 +0800 CST m=+0.859764216 |</span><br><span class="line">| tikv_gc_leader_lease     | 20190804-01:58:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_enable           | true                                                                                             |</span><br><span class="line">| tikv_gc_run_interval     | 10m0s                                                                                            |</span><br><span class="line">| tikv_gc_life_time        | 10m0s                                                                                            |</span><br><span class="line">| tikv_gc_last_run_time    | 20190804-01:48:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_safe_point       | 20190804-01:38:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_auto_concurrency | true                                                                                             |</span><br><span class="line">| tikv_gc_mode             | distributed                                                                                      |</span><br><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="查看系统变量"><a href="#查看系统变量" class="headerlink" title="查看系统变量"></a>查看系统变量</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like '%tidb%';</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">| Variable_name                       | Value                 |</span><br><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">| tidb_optimizer_selectivity_level    | 0                     |</span><br><span class="line">| tidb_slow_log_threshold             | 300                   |</span><br><span class="line">| tidb_distsql_scan_concurrency       | 15                    |</span><br><span class="line">| tidb_check_mb4_value_in_utf8        | 1                     |</span><br><span class="line">| tidb_checksum_table_concurrency     | 4                     |</span><br><span class="line">| tidb_query_log_max_len              | 2048                  |</span><br><span class="line">| tidb_mem_quota_sort                 | 34359738368           |</span><br><span class="line">| tidb_low_resolution_tso             | 0                     |</span><br><span class="line">| tidb_skip_utf8_check                | 0                     |</span><br><span class="line">| tidb_constraint_check_in_place      | 0                     |</span><br><span class="line">| tidb_snapshot                       |                       |</span><br><span class="line">| tidb_current_ts                     | 0                     |</span><br><span class="line">| tidb_opt_write_row_id               | 0                     |</span><br><span class="line">| tidb_opt_join_reorder_threshold     | 0                     |</span><br><span class="line">| tidb_build_stats_concurrency        | 4                     |</span><br><span class="line">| tidb_mem_quota_topn                 | 34359738368           |</span><br><span class="line">| tidb_batch_insert                   | 0                     |</span><br><span class="line">| tidb_config                         |                       |</span><br><span class="line">| tidb_batch_delete                   | 0                     |</span><br><span class="line">| tidb_opt_correlation_exp_factor     | 1                     |</span><br><span class="line">| tidb_auto_analyze_ratio             | 0.5                   |</span><br><span class="line">| tidb_index_serial_scan_concurrency  | 1                     |</span><br><span class="line">| tidb_ddl_error_count_limit          | 512                   |</span><br><span class="line">| tidb_batch_commit                   | 0                     |</span><br><span class="line">| tidb_wait_split_region_timeout      | 300                   |</span><br><span class="line">| tidb_mem_quota_query                | 34359738368           |</span><br><span class="line">| tidb_dml_batch_size                 | 20000                 |</span><br><span class="line">| tidb_mem_quota_mergejoin            | 34359738368           |</span><br><span class="line">| tidb_projection_concurrency         | 4                     |</span><br><span class="line">| tidb_index_join_batch_size          | 25000                 |</span><br><span class="line">| tidb_wait_split_region_finish       | 1                     |</span><br><span class="line">| tidb_back_off_weight                | 2                     |</span><br><span class="line">| tidb_enable_fast_analyze            | 0                     |</span><br><span class="line">| tidb_skip_isolation_level_check     | 0                     |</span><br><span class="line">| tidb_mem_quota_hashjoin             | 34359738368           |</span><br><span class="line">| tidb_hash_join_concurrency          | 5                     |</span><br><span class="line">| tidb_scatter_region                 | 0                     |</span><br><span class="line">| tidb_enable_window_function         | 1                     |</span><br><span class="line">| tidb_max_chunk_size                 | 1024                  |</span><br><span class="line">| tidb_enable_cascades_planner        | 0                     |</span><br><span class="line">| tidb_ddl_reorg_batch_size           | 1024                  |</span><br><span class="line">| tidb_txn_mode                       |                       |</span><br><span class="line">| tidb_opt_correlation_threshold      | 0.9                   |</span><br><span class="line">| tidb_hashagg_final_concurrency      | 4                     |</span><br><span class="line">| tidb_opt_agg_push_down              | 0                     |</span><br><span class="line">| tidb_index_lookup_concurrency       | 4                     |</span><br><span class="line">| tidb_enable_table_partition         | auto                  |</span><br><span class="line">| tidb_auto_analyze_end_time          | 23:59 +0000           |</span><br><span class="line">| tidb_index_lookup_size              | 20000                 |</span><br><span class="line">| tidb_hashagg_partial_concurrency    | 4                     |</span><br><span class="line">| tidb_opt_insubq_to_join_and_agg     | 1                     |</span><br><span class="line">| tidb_ddl_reorg_worker_cnt           | 16                    |</span><br><span class="line">| tidb_mem_quota_indexlookupreader    | 34359738368           |</span><br><span class="line">| tidb_mem_quota_indexlookupjoin      | 34359738368           |</span><br><span class="line">| tidb_mem_quota_nestedloopapply      | 34359738368           |</span><br><span class="line">| tidb_general_log                    | 0                     |</span><br><span class="line">| tidb_force_priority                 | NO_PRIORITY           |</span><br><span class="line">| tidb_enable_streaming               | 0                     |</span><br><span class="line">| tidb_retry_limit                    | 10                    |</span><br><span class="line">| tidb_enable_radix_join              | 0                     |</span><br><span class="line">| tidb_ddl_reorg_priority             | PRIORITY_LOW          |</span><br><span class="line">| tidb_backoff_lock_fast              | 100                   |</span><br><span class="line">| tidb_auto_analyze_start_time        | 00:00 +0000           |</span><br><span class="line">| tidb_init_chunk_size                | 32                    |</span><br><span class="line">| tidb_expensive_query_time_threshold | 60                    |</span><br><span class="line">| tidb_disable_txn_auto_retry         | 1                     |</span><br><span class="line">| tidb_slow_query_file                | /var/log/tidb/slowlog |</span><br><span class="line">| tidb_index_lookup_join_concurrency  | 4                     |</span><br><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">68 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><h1 id="查看监控信息"><a href="#查看监控信息" class="headerlink" title="查看监控信息"></a>查看监控信息</h1><ul><li>TiDB 通过 Prometheus 和 Grafana 监控 TiDB 集群。</li><li>在通过 TiDB Operator 创建新的 TiDB 集群时，对于每个 TiDB 集群，会同时创建、配置一套独立的监控系统，与 TiDB 集群运行在同一 Namespace，包括 Prometheus 和 Grafana 两个组件。</li><li>监控数据默认没有持久化，如果由于某些原因监控容器重启，已有的监控数据会丢失。可以在 <code>values.yaml</code> 中设置 <code>monitor.persistent</code> 为 <code>true</code> 来持久化监控数据。</li></ul><h2 id="获取监控端口"><a href="#获取监控端口" class="headerlink" title="获取监控端口"></a>获取监控端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get svc -l app.kubernetes.io/component=monitor</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">tidb-cluster-grafana            NodePort   10.96.136.52    &lt;none&gt;        3000:30009/TCP   93m</span><br><span class="line">tidb-cluster-monitor-reloader   NodePort   10.96.211.160   &lt;none&gt;        9089:31302/TCP   93m</span><br><span class="line">tidb-cluster-prometheus         NodePort   10.96.75.4      &lt;none&gt;        9090:31666/TCP   93m</span><br></pre></td></tr></table></figure><h2 id="访问监控"><a href="#访问监控" class="headerlink" title="访问监控"></a>访问监控</h2><p>可以看到监控服务都是NodePort类型，直接通过节点端口即可访问监控服务</p><h1 id="更新和升级"><a href="#更新和升级" class="headerlink" title="更新和升级"></a>更新和升级</h1><h2 id="TiDB-Operator"><a href="#TiDB-Operator" class="headerlink" title="TiDB-Operator"></a>TiDB-Operator</h2><p>当新版本 tidb-operator 发布，只要更新 <code>values.yaml</code> 中的 <code>operatorImage</code> 然后执行上述命令就可以。但是安全起见，最好从新版本 <code>tidb-operator</code> chart 中获取新版本 <code>values.yaml</code> 并和旧版本 <code>values.yaml</code> 合并生成新的 <code>values.yaml</code>，然后升级。</p><p>TiDB Operator 是用来管理 TiDB 集群的，也就是说，如果 TiDB 集群已经启动并正常运行，你甚至可以停掉 TiDB Operator，而 TiDB 集群仍然能正常工作，直到你需要维护 TiDB 集群，比如伸缩、升级等等。</p><h3 id="升级TiDB-Operator"><a href="#升级TiDB-Operator" class="headerlink" title="升级TiDB-Operator"></a>升级TiDB-Operator</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-operator pingcap/tidb-operator --version=v1.0.0 -f /home/tidb/tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><h3 id="Kubernetes集群版本升级"><a href="#Kubernetes集群版本升级" class="headerlink" title="Kubernetes集群版本升级"></a>Kubernetes集群版本升级</h3><p>当你的 Kubernetes 集群有版本升级，请确保 <code>kubeSchedulerImageTag</code> 与之匹配。默认情况下，这个值是由 Helm 在安装或者升级过程中生成的，要修改它你需要执行 <code>helm upgrade</code>。</p><h2 id="TiDB-Cluster"><a href="#TiDB-Cluster" class="headerlink" title="TiDB-Cluster"></a>TiDB-Cluster</h2><p>滚动更新 TiDB 集群时，会按 PD、TiKV、TiDB 的顺序，串行删除 Pod，并创建新版本的 Pod，当新版本的 Pod 正常运行后，再处理下一个 Pod。</p><p>滚动升级过程会自动处理 PD、TiKV 的 Leader 迁移与 TiDB 的 DDL Owner 迁移。因此，在多节点的部署拓扑下（最小环境：PD <em>3、TiKV </em>3、TiDB * 2），滚动更新 TiKV、PD 不会影响业务正常运行。</p><p>对于有连接重试功能的客户端，滚动更新 TiDB 同样不会影响业务。</p><p>对于无法进行重试的客户端，滚动更新 TiDB 则会导致连接到被关闭节点的数据库连接失效，造成部分业务请求失败。对于这类业务，推荐在客户端添加重试功能或在低峰期进行 TiDB 的滚动升级操作。</p><p>滚动更新可以用于升级 TiDB 版本，也可以用于更新集群配置。</p><h3 id="更新TiDB-Cluster配置"><a href="#更新TiDB-Cluster配置" class="headerlink" title="更新TiDB-Cluster配置"></a>更新TiDB-Cluster配置</h3><p>默认条件下，修改配置文件不会自动应用到 TiDB 集群中，只有在实例重启时，才会重新加载新的配置文件。</p><p><strong>操作步骤如下</strong></p><ol><li><p>修改集群的 <code>values.yaml</code> 文件，将 <code>enableConfigMapRollout</code> 的值设为 <code>true</code></p></li><li><p>修改集群的 <code>values.yaml</code> 文件中需要调整的集群配置项，例如修改<code>pd.replicas</code>、<code>tidb.replicas</code>、<code>tikv.replicas</code>来进行水平扩容和缩容</p></li><li><p>执行<code>helm upgrade</code>命令升级</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-cluster pingcap/tidb-cluster -f /home/tidb/tidb-cluster/values.yaml --version=v1.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看升级进度</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 'kubectl -n tidb get pod -o wide'</span><br></pre></td></tr></table></figure></li></ol><h3 id="升级-TiDB-Cluster-版本"><a href="#升级-TiDB-Cluster-版本" class="headerlink" title="升级 TiDB-Cluster 版本"></a>升级 TiDB-Cluster 版本</h3><ol><li><p>修改集群的 <code>values.yaml</code> 文件中的 <code>tidb.image</code>、<code>tikv.image</code>、<code>pd.image</code> 的值为新版本镜像；</p></li><li><p>执行 <code>helm upgrade</code> 命令进行升级：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-cluster pingcap/tidb-cluster -f /home/tidb/tidb-cluster/values.yaml --version=v1.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看升级进度</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 'kubectl -n tidb get pod -o wide'</span><br></pre></td></tr></table></figure></li></ol><p><strong>注意：</strong></p><ul><li>将 <code>enableConfigMapRollout</code> 特性从关闭状态打开时，即使没有配置变更，也会触发一次 PD、TiKV、TiDB 的滚动更新。</li><li>目前 PD 的 <code>scheduler</code> 和 <code>replication</code> 配置（<code>values.yaml</code> 中的 <code>maxStoreDownTime</code> 和 <code>maxReplicas</code> 字段）在集群安装完成后无法自动更新，需要通过 <a href="https://pingcap.com/docs-cn/v3.0/reference/tools/pd-control" target="_blank" rel="noopener">pd-ctl</a> 手动更新。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;仅记录操作过程和部署过程&lt;/li&gt;&lt;li&gt;操作系统使用的&lt;code&gt;CentOS-7.6.1810 x86_64&lt;/code&gt;&lt;/
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
      <category term="TiDB" scheme="https://luanlengli.github.io/categories/Kubernetes/TiDB/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="TiDB" scheme="https://luanlengli.github.io/tags/TiDB/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes创建本地PV</title>
    <link href="https://luanlengli.github.io/2019/07/23/Kubernetes%E5%88%9B%E5%BB%BA%E6%9C%AC%E5%9C%B0PV.html"/>
    <id>https://luanlengli.github.io/2019/07/23/Kubernetes创建本地PV.html</id>
    <published>2019-07-23T06:21:37.000Z</published>
    <updated>2019-08-07T05:34:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><ul><li>Kubernetes的持久化存储体系里面，提到最多的是对接外部ceph服务或者NFS服务。</li><li>有时候，Kubernetes集群所在的环境不一定提供对应的外部存储服务，而且为了性能的需求（低延迟、高IOPS等），外部基于网络的存储无法很好的满足需求。</li><li>除此之外想把数据存放到宿主机本地硬盘的做法就只有hostPath或者emptyDir，这种做法还是不够科学。</li><li>在Kubernetes社区里面，对本地持久化存储的呼声非常高，因此在v1.10版本引入了<code>Local Persistent Volume</code>即本地PV，然后v1.14版本正式GA。</li><li>本地PV<font color="red">并不适用于所有的应用</font>，因为本地PV是直接跟节点绑定在一起的，如果Pod需要使用本地PV，在Pod调度过程中，会考虑本地PV的分布情况，然后选中有本地PV的节点作为调度目标节点。因此如果本地PV所在节点宕机，则可能会出现数据丢失的情况，需要应用自己能处理节点掉线数据无法访问的情况。</li></ul><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录操作过程和部署过程</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>虚拟机配置<code>4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘B</code></li><li>Kubernetes集群版本<code>v1.14.4</code></li><li>这里演示两种方式管理本地PV<ul><li>手动管理本地PV</li><li>使用社区提供的<code>local-volume-provisioner</code>来简化本地PV的管理</li></ul></li></ul><h1 id="准备步骤"><a href="#准备步骤" class="headerlink" title="准备步骤"></a>准备步骤</h1><p>参考<a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner/blob/master/docs/operations.md" target="_blank" rel="noopener">社区文档</a></p><h2 id="查看硬盘"><a href="#查看硬盘" class="headerlink" title="查看硬盘"></a>查看硬盘</h2><ul><li>20G本地硬盘<code>/dev/sdb</code></li><li>5G本地硬盘<code>/dev/sdc</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  30G  0 disk </span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  29G  0 part /</span><br><span class="line">sdb      8:16   0  20G  0 disk </span><br><span class="line">sdc      8:32   0   5G  0 disk</span><br></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><blockquote><p>作为provisioner发现本地PV的目录</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mnt/disks</span><br></pre></td></tr></table></figure><h2 id="格式化硬盘"><a href="#格式化硬盘" class="headerlink" title="格式化硬盘"></a>格式化硬盘</h2><blockquote><p>注意，这里是一个本地PV对应一个硬盘</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/sdb</span><br><span class="line">mkfs.ext4 /dev/sdc</span><br></pre></td></tr></table></figure><h2 id="获取硬盘UUID"><a href="#获取硬盘UUID" class="headerlink" title="获取硬盘UUID"></a>获取硬盘UUID</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SDB_UUID=$(blkid -s UUID -o value /dev/sdb)</span><br><span class="line">SDC_UUID=$(blkid -s UUID -o value /dev/sdc)</span><br></pre></td></tr></table></figure><h2 id="创建挂载目录"><a href="#创建挂载目录" class="headerlink" title="创建挂载目录"></a>创建挂载目录</h2><blockquote><p>这里使用硬盘UUID作为挂载目录</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mnt/disks/$SDB_UUID</span><br><span class="line">mkdir -p /mnt/disks/$SDC_UUID</span><br></pre></td></tr></table></figure><h2 id="挂载硬盘"><a href="#挂载硬盘" class="headerlink" title="挂载硬盘"></a>挂载硬盘</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -t ext4 /dev/sdb /mnt/disks/$SDB_UUID</span><br><span class="line">mount -t ext4 /dev/sdc /mnt/disks/$SDC_UUID</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  30G  0 disk </span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  29G  0 part /</span><br><span class="line">sdb      8:16   0  20G  0 disk /mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6</span><br><span class="line">sdc      8:32   0   5G  0 disk /mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26</span><br></pre></td></tr></table></figure><h2 id="写入fstab"><a href="#写入fstab" class="headerlink" title="写入fstab"></a>写入fstab</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo "UUID=$&#123;SDB_UUID&#125; /mnt/disks/$&#123;SDB_UUID&#125; ext4 defaults 0 2" | tee -a /etc/fstab</span><br><span class="line">echo "UUID=$&#123;SDC_UUID&#125; /mnt/disks/$&#123;SDC_UUID&#125; ext4 defaults 0 2" | tee -a /etc/fstab</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/fstab</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Created by anaconda on Tue Jun 18 05:24:00 2019</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Accessible filesystems, by reference, are maintained under <span class="string">'/dev/disk'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) <span class="keyword">for</span> more info</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">UUID=f3ca2ebf-a9fe-4cae-a20f-02ff93f2ba0c /                       xfs     defaults        0 0</span><br><span class="line">UUID=3253298b-04d2-47ca-a383-e30b0b1e2267 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=f8727d20-3ef9-4f83-b865-25943bc342a6 /mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6 ext4 defaults 0 2</span><br><span class="line">UUID=9e0ead5f-ca8e-4018-98ad-960979d9cb26 /mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26 ext4 defaults 0 2</span><br></pre></td></tr></table></figure><h2 id="给节点打标签"><a href="#给节点打标签" class="headerlink" title="给节点打标签"></a>给节点打标签</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node k8s-node1 local-pv=present</span><br></pre></td></tr></table></figure><h2 id="检查一下节点标签"><a href="#检查一下节点标签" class="headerlink" title="检查一下节点标签"></a>检查一下节点标签</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node -l local-pv=present</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-node1   Ready    &lt;none&gt;   102m   v1.14.4</span><br></pre></td></tr></table></figure><h1 id="手动管理本地PV"><a href="#手动管理本地PV" class="headerlink" title="手动管理本地PV"></a>手动管理本地PV</h1><h2 id="创建PV"><a href="#创建PV" class="headerlink" title="创建PV"></a>创建PV</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-node1-localpv-20G-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6</span></span><br><span class="line"><span class="attr">  nodeAffinity:</span></span><br><span class="line"><span class="attr">    required:</span></span><br><span class="line"><span class="attr">      nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">      - matchExpressions:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">          values:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">k8s-node1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-node1-localpv-5G-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26</span></span><br><span class="line"><span class="attr">  nodeAffinity:</span></span><br><span class="line"><span class="attr">    required:</span></span><br><span class="line"><span class="attr">      nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">      - matchExpressions:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">          values:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">k8s-node1</span></span><br></pre></td></tr></table></figure><h2 id="创建StorageClass"><a href="#创建StorageClass" class="headerlink" title="创建StorageClass"></a>创建StorageClass</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">storageclass.kubernetes.io/is-default-class:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/no-provisioner</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><h1 id="使用Provisioner管理本地PV"><a href="#使用Provisioner管理本地PV" class="headerlink" title="使用Provisioner管理本地PV"></a>使用Provisioner管理本地PV</h1><h2 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h2><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="安装Helm服务端"><a href="#安装Helm服务端" class="headerlink" title="安装Helm服务端"></a>安装Helm服务端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image gcr.azk8s.cn/google_containers/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h3 id="检查部署结果"><a href="#检查部署结果" class="headerlink" title="检查部署结果"></a>检查部署结果</h3><h4 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h4 id="查看Helm版本信息"><a href="#查看Helm版本信息" class="headerlink" title="查看Helm版本信息"></a>查看Helm版本信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h2 id="部署local-volume-provisioner"><a href="#部署local-volume-provisioner" class="headerlink" title="部署local-volume-provisioner"></a>部署local-volume-provisioner</h2><h3 id="下载项目代码"><a href="#下载项目代码" class="headerlink" title="下载项目代码"></a>下载项目代码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner.git</span><br></pre></td></tr></table></figure><h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim sig-storage-local-static-provisioner/helm/provisioner/value.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Common options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">common:</span></span><br><span class="line"><span class="attr">  rbac:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  createNamespace:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  useAlphaAPI:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  setPVOwnerRef:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  useJobForCleaning:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  useNodeNameOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  minResyncPeriod:</span> <span class="number">5</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">  configMapName:</span> <span class="string">"local-provisioner-config"</span></span><br><span class="line"><span class="attr">  podSecurityPolicy:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Configure storage classes.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">classes:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  hostDir:</span> <span class="string">/mnt/disks</span></span><br><span class="line"><span class="attr">  mountDir:</span> <span class="string">/mnt/disks</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="attr">  fsType:</span> <span class="string">ext4</span></span><br><span class="line"><span class="attr">  blockCleanerCommand:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"/scripts/fsclean.sh"</span></span><br><span class="line"><span class="attr">  storageClass:</span></span><br><span class="line"><span class="attr">    reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">    isDefaultClass:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Configure DaemonSet for provisioner.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">daemonset:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">"local-volume-provisioner"</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">quay.io/external_storage/local-volume-provisioner:v2.3.2</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">local-storage-admin</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Configure Prometheus monitoring</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">prometheus:</span></span><br><span class="line"><span class="attr">  operator:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="生成YAML文件"><a href="#生成YAML文件" class="headerlink" title="生成YAML文件"></a>生成YAML文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm template sig-storage-local-static-provisioner/helm/provisioner \</span><br><span class="line">             -f sig-storage-local-static-provisioner/helm/provisioner/value.yaml \</span><br><span class="line">             &gt; local-volume-provisioner.generated.yaml</span><br></pre></td></tr></table></figure><h3 id="部署YAML文件"><a href="#部署YAML文件" class="headerlink" title="部署YAML文件"></a>部署YAML文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f local-volume-provisioner.generated.yaml</span><br></pre></td></tr></table></figure><h3 id="查看provisioner"><a href="#查看provisioner" class="headerlink" title="查看provisioner"></a>查看provisioner</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=local-volume-provisioner</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">local-volume-provisioner-cj242   1/1     Running   0          40s</span><br></pre></td></tr></table></figure><h1 id="验证本地PV"><a href="#验证本地PV" class="headerlink" title="验证本地PV"></a>验证本地PV</h1><h2 id="查看PersistentVolume"><a href="#查看PersistentVolume" class="headerlink" title="查看PersistentVolume"></a>查看PersistentVolume</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS    REASON   AGE</span><br><span class="line">local-pv-40a9a025   19Gi       RWO            Retain           Available           local-storage            32s</span><br><span class="line">local-pv-6e9321fd   4911Mi     RWO            Retain           Available           local-storage            32s</span><br></pre></td></tr></table></figure><h2 id="查看StorageClass"><a href="#查看StorageClass" class="headerlink" title="查看StorageClass"></a>查看StorageClass</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sc</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                      PROVISIONER                    AGE</span><br><span class="line">local-storage (default)   kubernetes.io/no-provisioner   8m44s</span><br></pre></td></tr></table></figure><h2 id="部署StatefulSet"><a href="#部署StatefulSet" class="headerlink" title="部署StatefulSet"></a>部署StatefulSet</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim localpv-sts.yaml</span><br></pre></td></tr></table></figure><blockquote><p>内容如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">local-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">"local-service"</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">local-test</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">local-test</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">test-container</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">k8s.gcr.io/busybox</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"/bin/sh"</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"-c"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"count=0; count_file=\"/usr/test-pod/count\"; test_file=\"/usr/test-pod/test_file\"; if [ -e $count_file ]; then count=$(cat $count_file); fi; echo $((count+1)) &gt; $count_file; while [ 1 ]; do date &gt;&gt; $test_file; echo \"This is $MY_POD_NAME, count=$(cat $count_file)\" &gt;&gt; $test_file; sleep 10; done"</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">local-vol</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/test-pod</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1234</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">  - metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">local-vol</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">"local-storage"</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><h2 id="查看PV"><a href="#查看PV" class="headerlink" title="查看PV"></a>查看PV</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                            STORAGECLASS    REASON   AGE</span><br><span class="line">local-pv-6e9321fd   4911Mi     RWO            Retain           Bound       default/local-vol-local-test-0   local-storage            14m</span><br></pre></td></tr></table></figure><h2 id="查看PVC"><a href="#查看PVC" class="headerlink" title="查看PVC"></a>查看PVC</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pvc</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local-vol-local-test-0   Bound    local-pv-6e9321fd   4911Mi     RWO            local-storage   2m27s</span><br></pre></td></tr></table></figure><h1 id="清理现场"><a href="#清理现场" class="headerlink" title="清理现场"></a>清理现场</h1><h2 id="删除StatefulSet"><a href="#删除StatefulSet" class="headerlink" title="删除StatefulSet"></a>删除StatefulSet</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f localpv-sts.yaml</span><br></pre></td></tr></table></figure><h2 id="删除pvc"><a href="#删除pvc" class="headerlink" title="删除pvc"></a>删除pvc</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pvc local-vol-local-test-0</span><br></pre></td></tr></table></figure><h2 id="删除pv"><a href="#删除pv" class="headerlink" title="删除pv"></a>删除pv</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pv local-pv-6e9321fd</span><br></pre></td></tr></table></figure><h2 id="清理本地目录"><a href="#清理本地目录" class="headerlink" title="清理本地目录"></a>清理本地目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@k8s-node1 "rm -rf /mnt/disks/9e0ead5f-ca8e-4018-98ad-960979d9cb26/*"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前情提要&quot;&gt;&lt;a href=&quot;#前情提要&quot; class=&quot;headerlink&quot; title=&quot;前情提要&quot;&gt;&lt;/a&gt;前情提要&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Kubernetes的持久化存储体系里面，提到最多的是对接外部ceph服务或者NFS服务。&lt;/li&gt;&lt;li&gt;有时候
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Windows Server 2019安装Docker</title>
    <link href="https://luanlengli.github.io/2019/07/10/Windows-Server-2019%E5%AE%89%E8%A3%85Docker.html"/>
    <id>https://luanlengli.github.io/2019/07/10/Windows-Server-2019安装Docker.html</id>
    <published>2019-07-10T03:09:36.000Z</published>
    <updated>2019-07-10T13:54:56.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>Windows Server 从2016开始就已经支持Docker容器，这里以最新的2019作为演示，仅供参考</li><li>系统镜像<a href="ed2k://|file|cn_windows_server_2019_x64_dvd_4de40f33.iso|5086887936|7DCDDD6B0C60A0D019B6A93D8F2B6D31|/" target="_blank" rel="noopener">cn_windows_server_2019_x64_dvd_4de40f33.iso</a></li><li>Docker版本<code>18.09.7</code></li><li>参考文档<a href="https://docs.microsoft.com/zh-cn/virtualization/windowscontainers/deploy-containers/deploy-containers-on-server" target="_blank" rel="noopener">部署容器主机</a></li></ul><h1 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h1><blockquote><p>这里为了节省资源，没有选择桌面体验</p><p>可以自己根据需求选择对应的操作系统版本</p></blockquote><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-20-54.png" alt=""></p><h1 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h1><blockquote><p>在powershell或者cmd里面运行命令，打开服务器配置界面</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sconfig.cmd</span><br></pre></td></tr></table></figure><blockquote><p>界面示意图</p></blockquote><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-29-05.png" alt=""></p><h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h2><blockquote><p>可以根据需要修改对应的配置，这里只做以下几项</p></blockquote><ul><li><code>网络设置</code>，配置网络，安装docker需要访问公网<ul><li>配置IP地址</li><li>配置网关</li><li>配置DNS</li></ul></li></ul><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-33-48.png" alt=""></p><ul><li><code>Windows 更新设置</code>，安装docker前需要更新Windows<ul><li>修改为<code>手动更新</code></li><li>选择<code>下载并安装更新</code></li><li>在弹出命令窗口里面选择<code>搜索所有的更新</code></li><li>选择<code>安装所有更新</code></li><li>安装完成之后重启系统</li></ul></li></ul><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-19-51-55.png" alt=""></p><h2 id="启用Hyper-V和Containers功能"><a href="#启用Hyper-V和Containers功能" class="headerlink" title="启用Hyper-V和Containers功能"></a>启用Hyper-V和Containers功能</h2><blockquote><p>运行管理员权限powershell</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-WindowsFeature -Name Hyper-V,Containers -IncludeAllSubFeature -IncludeManagementTools -Verbose</span><br></pre></td></tr></table></figure><blockquote><p>安装完成之后重启操作系统</p></blockquote><h2 id="配置安装源"><a href="#配置安装源" class="headerlink" title="配置安装源"></a>配置安装源</h2><blockquote><p>运行管理员权限powershell</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name DockerMsftProvider -Repository PSGallery -Verbose</span><br></pre></td></tr></table></figure><h2 id="安装Docker-1"><a href="#安装Docker-1" class="headerlink" title="安装Docker"></a>安装Docker</h2><blockquote><p>运行管理员权限powershell，国内安装可能会因为网络原因失败，可以尝试手动安装</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package -Name docker -ProviderName DockerMsftProvider -Verbose</span><br></pre></td></tr></table></figure><h2 id="手动安装Docker"><a href="#手动安装Docker" class="headerlink" title="手动安装Docker"></a>手动安装Docker</h2><blockquote><p>运行管理员权限powershell</p></blockquote><ul><li>下载docker压缩包</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WebRequest</span> -UseBasicParsing -OutFile C:\docker-<span class="number">18.09</span>.<span class="number">7</span>.zip https://download.docker.com/components/engine/windows-server/<span class="number">18.09</span>/docker-<span class="number">18.09</span>.<span class="number">7</span>.zip</span><br></pre></td></tr></table></figure><ul><li>解压</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Expand-Archive C:\docker-<span class="number">18.09</span>.<span class="number">7</span>.zip -DestinationPath <span class="variable">$Env:ProgramFiles</span> -Force</span><br></pre></td></tr></table></figure><ul><li>删除压缩包</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Remove-Item</span> -Force C:\docker-<span class="number">18.09</span>.<span class="number">7</span>.zip</span><br></pre></td></tr></table></figure><ul><li>为当前会话添加PATH变量</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env:path</span> += <span class="string">";<span class="variable">$env:ProgramFiles</span>\docker"</span></span><br></pre></td></tr></table></figure><ul><li>配置新的PATH变量</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$newPath</span> = <span class="string">"<span class="variable">$env:ProgramFiles</span>\docker;"</span> + [System.Environment]::GetEnvironmentVariable(<span class="string">"PATH"</span>, [System.EnvironmentVariableTarget]::Machine)</span><br></pre></td></tr></table></figure><ul><li>将系统PATH变量替换为新的PATH变量</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[System.Environment]::SetEnvironmentVariable(<span class="string">"PATH"</span>, <span class="variable">$newPath</span>, [System.EnvironmentVariableTarget]::Machine)</span><br></pre></td></tr></table></figure><ul><li>注册为系统服务</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerd --register-service</span><br></pre></td></tr></table></figure><ul><li>设置Docker开机启动</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-Service</span> -Name docker -StartupType Automatic</span><br></pre></td></tr></table></figure><ul><li>启动Docker</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Start-Service</span> docker</span><br></pre></td></tr></table></figure><h1 id="验证Docker"><a href="#验证Docker" class="headerlink" title="验证Docker"></a>验证Docker</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container run hello-world:nanoserver</span><br></pre></td></tr></table></figure><p><img src="/2019/07/10/./Windows-Server-2019安装Docker\Windows-Server-2019-2019-07-10-20-29-33.png" alt=""></p><h1 id="配置Docker"><a href="#配置Docker" class="headerlink" title="配置Docker"></a>配置Docker</h1><p>在微软的官方网站上是有<a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-docker/configure-docker-daemon" target="_blank" rel="noopener">相关文档</a>的</p><h2 id="配置文件路径"><a href="#配置文件路径" class="headerlink" title="配置文件路径"></a>配置文件路径</h2><p><code>C:\ProgramData\Docker\config\daemon.json</code></p><h2 id="配置文件模板"><a href="#配置文件模板" class="headerlink" title="配置文件模板"></a>配置文件模板</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"dns"</span>: [</span><br><span class="line">        <span class="string">"114.114.114.114"</span>,</span><br><span class="line">        <span class="string">"8.8.8.8"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"storage-opts"</span>: [</span><br><span class="line">        <span class="string">"size=50GB"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"data-root"</span>: <span class="string">"c:\programdata\docker"</span>,</span><br><span class="line">    <span class="attr">"bridge"</span>: <span class="string">"NAT"</span>,</span><br><span class="line">    <span class="attr">"registry-mirrors"</span>: [</span><br><span class="line">        <span class="string">"https://registry.docker-cn.com"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"insecure-registries"</span>: [],</span><br><span class="line">    <span class="attr">"experimental"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="启用Linux容器支持"><a href="#启用Linux容器支持" class="headerlink" title="启用Linux容器支持"></a>启用Linux容器支持</h1><blockquote><p>目前Windows的container只支持Windows程序，运行Linux容器需要使用Hyper-V运行容器</p></blockquote><p>参考文献<a href="https://bcthomas.com/2019/02/getting-started-with-linux-containers-on-windows-server-2019/" target="_blank" rel="noopener">Getting started with Linux Containers on Windows Server 2019</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Windows Server 从2016开始就已经支持Docker容器，这里以最新的2019作为演示，仅供参考&lt;/li&gt;&lt;li&gt;系
      
    
    </summary>
    
      <category term="Docker" scheme="https://luanlengli.github.io/categories/Docker/"/>
    
      <category term="Windows" scheme="https://luanlengli.github.io/categories/Docker/Windows/"/>
    
    
      <category term="Docker" scheme="https://luanlengli.github.io/tags/Docker/"/>
    
      <category term="Windows" scheme="https://luanlengli.github.io/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes安装Helm和使用</title>
    <link href="https://luanlengli.github.io/2019/07/05/Kubernetes%E5%AE%89%E8%A3%85Helm%E5%92%8C%E4%BD%BF%E7%94%A8.html"/>
    <id>https://luanlengli.github.io/2019/07/05/Kubernetes安装Helm和使用.html</id>
    <published>2019-07-05T12:31:33.000Z</published>
    <updated>2019-08-05T13:18:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="部署Helm"><a href="#部署Helm" class="headerlink" title="部署Helm"></a>部署Helm</h1><h2 id="获取Helm"><a href="#获取Helm" class="headerlink" title="获取Helm"></a>获取Helm</h2><p><a href="https://github.com/helm/helm" target="_blank" rel="noopener">Github项目地址</a></p><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="通过官方脚本安装"><a href="#通过官方脚本安装" class="headerlink" title="通过官方脚本安装"></a>通过官方脚本安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://git.io/get_helm.sh | bash</span><br></pre></td></tr></table></figure><h2 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装Helm服务端"><a href="#安装Helm服务端" class="headerlink" title="安装Helm服务端"></a>安装Helm服务端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image dockerhub.azk8s.cn/gcrxio/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h2 id="检查部署结果"><a href="#检查部署结果" class="headerlink" title="检查部署结果"></a>检查部署结果</h2><h3 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h3 id="查看Helm版本信息"><a href="#查看Helm版本信息" class="headerlink" title="查看Helm版本信息"></a>查看Helm版本信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h1 id="使用Helm"><a href="#使用Helm" class="headerlink" title="使用Helm"></a>使用Helm</h1><h2 id="命令自动补齐"><a href="#命令自动补齐" class="headerlink" title="命令自动补齐"></a>命令自动补齐</h2><h3 id="临时生效"><a href="#临时生效" class="headerlink" title="临时生效"></a>临时生效</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &lt;$(helm compeltion bash)</span><br></pre></td></tr></table></figure><h3 id="永久生效"><a href="#永久生效" class="headerlink" title="永久生效"></a>永久生效</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm compeltion bash &gt; /etc/bash_completions./helm</span><br><span class="line">source /etc/profile.d/bash_completion.sh</span><br></pre></td></tr></table></figure><h2 id="查看Chart"><a href="#查看Chart" class="headerlink" title="查看Chart"></a>查看Chart</h2><p><a href="https://hub.helm.sh/charts" target="_blank" rel="noopener">https://hub.helm.sh/charts</a></p><h2 id="查看Repo"><a href="#查看Repo" class="headerlink" title="查看Repo"></a>查看Repo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME   URL                                              </span><br><span class="line">local  http://127.0.0.1:8879/charts                     </span><br><span class="line">stable https://kubernetes-charts.storage.googleapis.com/</span><br></pre></td></tr></table></figure><h2 id="添加Repo"><a href="#添加Repo" class="headerlink" title="添加Repo"></a>添加Repo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add pingcap &lt;Chart-URL&gt;</span><br></pre></td></tr></table></figure><h2 id="更新Repo缓存"><a href="#更新Repo缓存" class="headerlink" title="更新Repo缓存"></a>更新Repo缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure><h2 id="查看Repo里的Chart"><a href="#查看Repo里的Chart" class="headerlink" title="查看Repo里的Chart"></a>查看Repo里的Chart</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search &lt;Chart-Name&gt; -l</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm search stable -l</span><br><span class="line">NAME                                 CHART VERSIONAPP VERSION                     DESCRIPTION                                                 </span><br><span class="line">stable/acs-engine-autoscaler         2.2.2        2.1.1                           DEPRECATED Scales worker nodes within agent pools           </span><br><span class="line">stable/acs-engine-autoscaler         2.2.1        2.1.1                           Scales worker nodes within agent pools</span><br></pre></td></tr></table></figure><h2 id="查找Chart"><a href="#查找Chart" class="headerlink" title="查找Chart"></a>查找Chart</h2><blockquote><p>这里以redis作为关键字</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search redis</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                            CHART VERSIONAPP VERSIONDESCRIPTION                                                 </span><br><span class="line">stable/prometheus-redis-exporter3.0.0        1.0.3      Prometheus exporter for Redis metrics                       </span><br><span class="line">stable/redis                    9.0.1        5.0.5      Open source, advanced key-value store. It is often referr...</span><br><span class="line">stable/redis-ha                 3.6.2        5.0.5      Highly available Kubernetes implementation of Redis         </span><br><span class="line">stable/sensu                    0.2.3        0.28       Sensu monitoring framework backed by the Redis transpor</span><br></pre></td></tr></table></figure><h2 id="下载Chart"><a href="#下载Chart" class="headerlink" title="下载Chart"></a>下载Chart</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm fetch stable/redis --version=9.0.1</span><br></pre></td></tr></table></figure><h2 id="查看Chart文件结构"><a href="#查看Chart文件结构" class="headerlink" title="查看Chart文件结构"></a>查看Chart文件结构</h2><h3 id="解压Chart"><a href="#解压Chart" class="headerlink" title="解压Chart"></a>解压Chart</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf redis-9.0.1.tgz</span><br></pre></td></tr></table></figure><h3 id="查看目录结构"><a href="#查看目录结构" class="headerlink" title="查看目录结构"></a>查看目录结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree redis</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── ci</span><br><span class="line">│   ├── default-values.yaml</span><br><span class="line">│   ├── dev-values.yaml</span><br><span class="line">│   ├── extra-flags-values.yaml</span><br><span class="line">│   ├── production-sentinel-values.yaml</span><br><span class="line">│   ├── production-values.yaml</span><br><span class="line">│   ├── redisgraph-module-values.yaml</span><br><span class="line">│   └── redis-lib-values.yaml</span><br><span class="line">├── README.md</span><br><span class="line">├── templates</span><br><span class="line">│   ├── configmap.yaml</span><br><span class="line">│   ├── headless-svc.yaml</span><br><span class="line">│   ├── health-configmap.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── metrics-prometheus.yaml</span><br><span class="line">│   ├── metrics-svc.yaml</span><br><span class="line">│   ├── networkpolicy.yaml</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── redis-master-statefulset.yaml</span><br><span class="line">│   ├── redis-master-svc.yaml</span><br><span class="line">│   ├── redis-rolebinding.yaml</span><br><span class="line">│   ├── redis-role.yaml</span><br><span class="line">│   ├── redis-serviceaccount.yaml</span><br><span class="line">│   ├── redis-slave-statefulset.yaml</span><br><span class="line">│   ├── redis-slave-svc.yaml</span><br><span class="line">│   ├── redis-with-sentinel-svc.yaml</span><br><span class="line">│   └── secret.yaml</span><br><span class="line">├── values-production.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure><h2 id="使用Helm安装Chart"><a href="#使用Helm安装Chart" class="headerlink" title="使用Helm安装Chart"></a>使用Helm安装Chart</h2><p>帮助文档里面是这么描述的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. By chart reference: helm install stable/mariadb</span><br><span class="line">2. By path to a packaged chart: helm install ./nginx-1.2.3.tgz</span><br><span class="line">3. By path to an unpacked chart directory: helm install ./nginx</span><br><span class="line">4. By absolute URL: helm install https://example.com/charts/nginx-1.2.3.tgz</span><br><span class="line">5. By chart reference and repo url: helm install --repo https://example.com/charts/ nginx</span><br></pre></td></tr></table></figure><h3 id="直接安装"><a href="#直接安装" class="headerlink" title="直接安装"></a>直接安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/redis --name=helm-redis --namespace=default --version=9.0.1</span><br></pre></td></tr></table></figure><h3 id="安装时指定变量"><a href="#安装时指定变量" class="headerlink" title="安装时指定变量"></a>安装时指定变量</h3><blockquote><p>具体的变量定义在Chart目录下的<code>values.yaml</code>文件里面有</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/redis \</span><br><span class="line">     --name=helm-redis \</span><br><span class="line">     --namesapce=default \</span><br><span class="line">     --version=9.0.1 \</span><br><span class="line">     --set image.registry=docker.io \</span><br><span class="line">     --set image.repository=bitnami/redis \</span><br><span class="line">     --set image.tag=5.0.5-debian-9-r36</span><br></pre></td></tr></table></figure><h3 id="安装时指定变量文件"><a href="#安装时指定变量文件" class="headerlink" title="安装时指定变量文件"></a>安装时指定变量文件</h3><blockquote><p>按需修改Chart目录下<code>values.yaml</code>文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/redis \</span><br><span class="line">     --name=helm-redis \</span><br><span class="line">     --namesapce=default \</span><br><span class="line">     --version=9.0.1 \</span><br><span class="line">     -f redis/values.yaml</span><br></pre></td></tr></table></figure><h2 id="列出Release"><a href="#列出Release" class="headerlink" title="列出Release"></a>列出Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm list --all</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                UPDATED                     CHART</span><br><span class="line">helm-redis          Mon May  9 16:07:08 2019    redis-9.0.1</span><br></pre></td></tr></table></figure><h2 id="更新Release"><a href="#更新Release" class="headerlink" title="更新Release"></a>更新Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade helm-redis stable/redis -f redis/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Release历史"><a href="#查看Release历史" class="headerlink" title="查看Release历史"></a>查看Release历史</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm <span class="built_in">history</span> helm-redis</span><br><span class="line">REVISION        UPDATED                         STATUS          CHART                   DESCRIPTION</span><br><span class="line">1               Mon Apr 16 10:21:44 2019        SUPERSEDED      stable/redis-9.0.1     Install complete</span><br><span class="line">2               Mon Apr 16 10:43:10 2019        DEPLOYED        stable/redis-9.0.1     Upgrade complete</span><br></pre></td></tr></table></figure><h2 id="回滚Release"><a href="#回滚Release" class="headerlink" title="回滚Release"></a>回滚Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm rollback helm-redis 1</span><br></pre></td></tr></table></figure><h2 id="删除Release"><a href="#删除Release" class="headerlink" title="删除Release"></a>删除Release</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete helm-redis</span><br></pre></td></tr></table></figure><ul><li>彻底删除</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm delete --purge helm-redis</span><br></pre></td></tr></table></figure><h2 id="通过模板功能生成YAML文件"><a href="#通过模板功能生成YAML文件" class="headerlink" title="通过模板功能生成YAML文件"></a>通过模板功能生成YAML文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm template stable/redis \</span><br><span class="line">     --name=helm-redis \</span><br><span class="line">     --namesapce=default \</span><br><span class="line">     --version=9.0.1 \</span><br><span class="line">     -f redis/values.yaml &gt; helm_redis_generated.yaml</span><br></pre></td></tr></table></figure><blockquote><p>此方法生成的YAML文件可以通过kubectl命令进行部署</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;部署Helm&quot;&gt;&lt;a href=&quot;#部署Helm&quot; class=&quot;headerlink&quot; title=&quot;部署Helm&quot;&gt;&lt;/a&gt;部署Helm&lt;/h1&gt;&lt;h2 id=&quot;获取Helm&quot;&gt;&lt;a href=&quot;#获取Helm&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>通过Linux capabilities机制让kong监听80和443端口</title>
    <link href="https://luanlengli.github.io/2019/07/05/%E9%80%9A%E8%BF%87Linux%20capabilities%E6%9C%BA%E5%88%B6%E8%AE%A9kong%E7%9B%91%E5%90%AC80%E5%92%8C443%E7%AB%AF%E5%8F%A3.html"/>
    <id>https://luanlengli.github.io/2019/07/05/通过Linux capabilities机制让kong监听80和443端口.html</id>
    <published>2019-07-05T02:09:51.000Z</published>
    <updated>2019-07-05T04:27:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>在做kong容器实验的时候，发现kong数据平面默认监听的端口是8000和8443，非常难受。</p><p>通过容器启动时声明环境变量的方式，将数据平面监听端口改成了80和443，但是启动时提示<code>[nginx: [emerg] bind() to 0.0.0.0:80 failed (13: permission denied)]</code>。</p><p>在<a href="https://luanlengli.github.io/2019/05/29/Kong-API网关搭建部署记录.html">Kong API网关搭建部署记录</a>通过更改配置的方式，可以实现让数据平面监听在80和443，这就有点奇怪了。</p><p>于是乎去看了下kong社区是怎么生成容器镜像的，项目地址在<a href="https://github.com/Kong/docker-kong" target="_blank" rel="noopener">这里</a>。</p><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>以alpine为例，找到项目里面的<code>alpine/Dockerfile</code>文件，内容如下</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.10</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer=<span class="string">"Kong Core Team &lt;team-core@konghq.com&gt;"</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENV KONG_VERSION 1.2.1</span></span><br><span class="line"><span class="bash">ENV KONG_SHA256 067bed966de064f15e548b1afbf859e724a3a5689865edc501db40cf61a7044c</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN adduser -Su 1337 kong \</span></span><br><span class="line"><span class="bash">&amp;&amp; mkdir -p <span class="string">"/usr/local/kong"</span> \</span></span><br><span class="line"><span class="bash">&amp;&amp; apk add --no-cache --virtual .build-deps wget tar ca-certificates \</span></span><br><span class="line"><span class="bash">&amp;&amp; apk add --no-cache libgcc openssl pcre perl tzdata curl libcap su-exec zip \</span></span><br><span class="line"><span class="bash">&amp;&amp; wget -O kong.tar.gz <span class="string">"https://bintray.com/kong/kong-alpine-tar/download_file?file_path=kong-<span class="variable">$KONG_VERSION</span>.apk.tar.gz"</span> \</span></span><br><span class="line"><span class="bash">&amp;&amp; <span class="built_in">echo</span> <span class="string">"<span class="variable">$KONG_SHA256</span> *kong.tar.gz"</span> | sha256sum -c - \</span></span><br><span class="line"><span class="bash">&amp;&amp; tar -xzf kong.tar.gz -C /tmp \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -f kong.tar.gz \</span></span><br><span class="line"><span class="bash">&amp;&amp; cp -R /tmp/usr / \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -rf /tmp/usr \</span></span><br><span class="line"><span class="bash">&amp;&amp; cp -R /tmp/etc / \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -rf /tmp/etc \</span></span><br><span class="line"><span class="bash">&amp;&amp; apk del .build-deps \</span></span><br><span class="line"><span class="bash">&amp;&amp; chown -R kong:0 /usr/<span class="built_in">local</span>/kong \</span></span><br><span class="line"><span class="bash">&amp;&amp; chmod -R g=u /usr/<span class="built_in">local</span>/kong</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">COPY docker-entrypoint.sh /docker-entrypoint.sh</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/docker-entrypoint.sh"</span>]</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">EXPOSE 8000 8443 8001 8444</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">STOPSIGNAL SIGQUIT</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">CMD [<span class="string">"kong"</span>, <span class="string">"docker-start"</span>]</span></span><br></pre></td></tr></table></figure><p>可以看到，Kong容器默认运行指令为<code>/docker-entrypoint.sh kong docker-start</code></p><h2 id="Entrypoint"><a href="#Entrypoint" class="headerlink" title="Entrypoint"></a>Entrypoint</h2><p>那么来看看<code>docker-entrypoint.sh</code>里面做了什么事情吧。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">export KONG_NGINX_DAEMON=off</span><br><span class="line"></span><br><span class="line">has_transparent() &#123;</span><br><span class="line">  echo "$1" | grep -E "[^\s,]+\s+transparent\b" &gt;/dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [[ "$1" == "kong" ]]; then</span><br><span class="line">  PREFIX=$&#123;KONG_PREFIX:=/usr/local/kong&#125;</span><br><span class="line"></span><br><span class="line">  if [[ "$2" == "docker-start" ]]; then</span><br><span class="line">    shift 2</span><br><span class="line">    kong prepare -p "$PREFIX" "$@"</span><br><span class="line">    </span><br><span class="line">    # workaround for https://github.com/moby/moby/issues/31243</span><br><span class="line">    chmod o+w /proc/self/fd/1 || true</span><br><span class="line">    chmod o+w /proc/self/fd/2 || true</span><br><span class="line"></span><br><span class="line">    if [ "$(id -u)" != "0" ]; then</span><br><span class="line">      exec /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    else</span><br><span class="line">      if [ ! -z $&#123;SET_CAP_NET_RAW&#125; ] \</span><br><span class="line">          || has_transparent "$KONG_STREAM_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_PROXY_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_ADMIN_LISTEN";</span><br><span class="line">      then</span><br><span class="line">        setcap cap_net_raw=+ep /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">      fi</span><br><span class="line">      chown -R kong:0 /usr/local/kong</span><br><span class="line">      exec su-exec kong /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exec "$@"</span><br></pre></td></tr></table></figure><p>从脚本里面可以看到做了以下几个事情</p><ul><li>判断参数为<code>docker-start</code>时，执行<code>kong prepare</code></li><li>判断环境变量是否带有<code>transparent</code>，有的话就执行<code>setcap cap_net_raw=+ep</code>，没有就直接结束判断</li><li>修改<code>/usr/local/kong</code>的owner和group</li><li>最终是使用kong用户去启动Nginx进程。</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ # ps -ef</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 kong      0:00 nginx: master process /usr/local/openresty/nginx/sbin/nginx -p /usr/local/kong -c nginx.conf</span><br><span class="line">   32 kong      0:00 nginx: worker process</span><br><span class="line">   33 kong      0:00 nginx: worker process</span><br><span class="line">   34 kong      0:00 nginx: worker process</span><br><span class="line">   35 kong      0:00 nginx: worker process</span><br><span class="line">   36 root      0:00 /bin/sh</span><br><span class="line">   45 root      0:00 ps -ef</span><br></pre></td></tr></table></figure><p>从容器里面可以看到，Nginx进程是以kong用户运行的，自然就没有权限监听小于1024的端口，那么transparent怎么就可以了呢，回到if判断里面执行了<code>setcap cap_net_raw=+ep</code>这样的命令。</p><p>这个<code>cap_net_raw</code>是干什么用的，查了下<a href="https://linux.die.net/man/7/capabilities" target="_blank" rel="noopener">文档</a>，针对此项的说明如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CAP_NET_RAW</span><br><span class="line">    *</span><br><span class="line">    use RAW and PACKET sockets;</span><br><span class="line">    *</span><br><span class="line">    bind to any address for transparent proxying.</span><br></pre></td></tr></table></figure><p>也就是，根据脚本判断到kong需要实现transparent功能时，会给nginx添加CAP_NET_RAW，以实现普通用户也能运行需要trasparent proxying权限的程序。</p><h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>那么问题来了，在Linux capabilities里面，是否有相关的权限可以让程序绑定小于1024的端口呢。</p><p>恩，很好，一下就找到了<strong>CAP_NET_BIND_SERVICE</strong>，说明如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CAP_NET_BIND_SERVICE</span><br><span class="line">    Bind a socket to Internet domain privileged ports (port numbers less than 1024).</span><br></pre></td></tr></table></figure><h1 id="魔改"><a href="#魔改" class="headerlink" title="魔改"></a>魔改</h1><p>接下来就是魔改entrypoint的节奏了，修改如下</p><blockquote><p>在34行给nginx进程添加了<strong>CAP_NET_BIND_SERVICE</strong>权限</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">export KONG_NGINX_DAEMON=off</span><br><span class="line"></span><br><span class="line">has_transparent() &#123;</span><br><span class="line">  echo "$1" | grep -E "[^\s,]+\s+transparent\b" &gt;/dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [[ "$1" == "kong" ]]; then</span><br><span class="line">  PREFIX=$&#123;KONG_PREFIX:=/usr/local/kong&#125;</span><br><span class="line"></span><br><span class="line">  if [[ "$2" == "docker-start" ]]; then</span><br><span class="line">    shift 2</span><br><span class="line">    kong prepare -p "$PREFIX" "$@"</span><br><span class="line">    </span><br><span class="line">    # workaround for https://github.com/moby/moby/issues/31243</span><br><span class="line">    chmod o+w /proc/self/fd/1 || true</span><br><span class="line">    chmod o+w /proc/self/fd/2 || true</span><br><span class="line"></span><br><span class="line">    if [ "$(id -u)" != "0" ]; then</span><br><span class="line">      exec /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    else</span><br><span class="line">      if [ ! -z $&#123;SET_CAP_NET_RAW&#125; ] \</span><br><span class="line">          || has_transparent "$KONG_STREAM_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_PROXY_LISTEN" \</span><br><span class="line">          || has_transparent "$KONG_ADMIN_LISTEN";</span><br><span class="line">      then</span><br><span class="line">        setcap cap_net_raw=+ep /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">      fi</span><br><span class="line">      chown -R kong:0 /usr/local/kong</span><br><span class="line">      setcap cap_net_bind_service=+ep /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">      exec su-exec kong /usr/local/openresty/nginx/sbin/nginx \</span><br><span class="line">        -p "$PREFIX" \</span><br><span class="line">        -c nginx.conf</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exec "$@"</span><br></pre></td></tr></table></figure><p>重新构建容器镜像了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t newkong:v1 .</span><br></pre></td></tr></table></figure><h1 id="成果检验"><a href="#成果检验" class="headerlink" title="成果检验"></a>成果检验</h1><h2 id="重新运行容器"><a href="#重新运行容器" class="headerlink" title="重新运行容器"></a>重新运行容器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    -e KONG_DATABASE=off \</span><br><span class="line">    -e KONG_PROXY_LISTEN='0.0.0.0:80, 0.0.0.0:443 ssl' \</span><br><span class="line">    -e KONG_LOG_LEVEL=notice \</span><br><span class="line">    -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    --name kong \</span><br><span class="line">    newkong:v1</span><br></pre></td></tr></table></figure><h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker logs kong</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: using the "epoll" event method</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: openresty/1.13.6.2</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: built by gcc 8.3.0 (Alpine 8.3.0) </span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: OS: Linux 5.1.15-300.fc30.x86_64</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: start worker processes</span><br><span class="line">2019/07/05 03:35:41 [notice] 1#0: start worker process 33</span><br></pre></td></tr></table></figure><h2 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it kong /bin/sh -c "ps -ef"</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 kong      0:00 nginx: master process /usr/local/openresty/nginx/sbin/ngin</span><br><span class="line">   33 kong      0:00 nginx: worker process</span><br><span class="line">   39 root      0:00 ps -ef</span><br></pre></td></tr></table></figure><h2 id="查看监听"><a href="#查看监听" class="headerlink" title="查看监听"></a>查看监听</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it kong /bin/sh -c "netstat -lp"</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:8444          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:8001          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span><br><span class="line">Active UNIX domain sockets (only servers)</span><br><span class="line">Proto RefCnt Flags       Type       State         I-Node PID/Program name    Path</span><br></pre></td></tr></table></figure><p>可以看到，Nginx已经可以成功监听80和443端口了。欧耶~！</p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>最后琢磨了一下，通过传入启动命令的方式也可以实现kong监听80和443端口。</p><p>感觉绕了弯子……</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    -e KONG_DATABASE=off \</span><br><span class="line">    -e KONG_PROXY_LISTEN='0.0.0.0:80, 0.0.0.0:443 ssl' \</span><br><span class="line">    -e KONG_LOG_LEVEL=notice \</span><br><span class="line">    -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \</span><br><span class="line">    -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \</span><br><span class="line">    --name kong \</span><br><span class="line">    kong:1.2 \</span><br><span class="line">    kong start</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前情提要&quot;&gt;&lt;a href=&quot;#前情提要&quot; class=&quot;headerlink&quot; title=&quot;前情提要&quot;&gt;&lt;/a&gt;前情提要&lt;/h1&gt;&lt;p&gt;在做kong容器实验的时候，发现kong数据平面默认监听的端口是8000和8443，非常难受。&lt;/p&gt;&lt;p&gt;通过容器启动时声
      
    
    </summary>
    
      <category term="Kong" scheme="https://luanlengli.github.io/categories/Kong/"/>
    
    
      <category term="Kong" scheme="https://luanlengli.github.io/tags/Kong/"/>
    
  </entry>
  
  <entry>
    <title>Kong Ingress Controller部署</title>
    <link href="https://luanlengli.github.io/2019/07/02/Kong-Ingress-Controller%E9%83%A8%E7%BD%B2.html"/>
    <id>https://luanlengli.github.io/2019/07/02/Kong-Ingress-Controller部署.html</id>
    <published>2019-07-02T03:33:33.000Z</published>
    <updated>2019-07-07T02:18:47.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li><p>如果不知道kong怎么部署，参考<a href="https://luanlengli.github.io/2019/05/29/Kong-API网关搭建部署记录.html">Kong API网关搭建部署记录</a></p></li><li><p>这里简单描述一下怎么修改官方的YAML文件，不保证<code>ctrl+c</code>和<code>ctrl+v</code>可以直接跑起来!</p></li><li><p><a href="https://github.com/Kong/kubernetes-ingress-controller" target="_blank" rel="noopener">Github项目地址</a></p></li><li><p>kong-ingress-controller的版本号是<code>0.5.0</code></p></li><li><p>kong的版本号是<code>1.2</code></p></li></ul><h1 id="Kong-Ingress-Controller介绍"><a href="#Kong-Ingress-Controller介绍" class="headerlink" title="Kong-Ingress-Controller介绍"></a>Kong-Ingress-Controller介绍</h1><p>这里是参考<a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/design.md" target="_blank" rel="noopener">项目文档</a>，简单的翻译一下。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Kong Ingress Controller是一个动态且高度可用的Ingress Controller。</p><p>它使用在Kubernetes集群中创建的Ingress资源来配置Kong。</p><p>此外，它还可以为Kubernetes中运行的服务配置插件，负载平衡和运行状况检查。</p><h2 id="部署方式"><a href="#部署方式" class="headerlink" title="部署方式"></a>部署方式</h2><p>kong的ingress-controller是Go编写的程序，作用机制类似于Adapter，将Kubernetes里面的资源对象转换成Kong的配置规则。</p><p>支持<code>backed with a database</code>模式和<code>backed without a database</code>模式。</p><h3 id="DBless模式"><a href="#DBless模式" class="headerlink" title="DBless模式"></a>DBless模式</h3><p>运行在DBless模式下，Kong ingress controller会作为sidecar容器与Kong容器一起运行在同一个Pod里面，并且会根据从Kubernetes API Server接收到的信息动态配置Kong。</p><p>支持增加kong容器副本数量来实现高可用和负载均衡。</p><p><img src="https://github.com/Kong/kubernetes-ingress-controller/raw/master/docs/images/dbless-deployment.png" alt=""></p><h3 id="后端数据库模式"><a href="#后端数据库模式" class="headerlink" title="后端数据库模式"></a>后端数据库模式</h3><p>运行在基于后端数据库的模式时，ingress controller与kong的控制平面部署在一起，kong的数据平面分开部署。</p><p>在下图可以看明显看到kong的控制平面和数据平面是分开的。</p><p><img src="https://github.com/Kong/kubernetes-ingress-controller/raw/master/docs/images/db-deployment.png" alt=""></p><h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><p>当部署多个kong ingress controller时，多个kong ingress controller之间会选举出leader。同一时间只有leader能配置kong的规则，并且leader失效后会自动选主。</p><h2 id="横向扩展"><a href="#横向扩展" class="headerlink" title="横向扩展"></a>横向扩展</h2><p>如果是基于后端数据库模式，kong的控制平面和数据平面分开部署，可以单独增加kong的数据平面来实现横向扩展。</p><h2 id="规则转换"><a href="#规则转换" class="headerlink" title="规则转换"></a>规则转换</h2><p>下图是Kubernetes资源对象怎么转换成Kong配置规则的过程</p><blockquote><p>PS：这个图感觉怪怪的，这哪里有转换过程，不是Kubernetes的Ingress对象模型吗</p></blockquote><h2 id="CRD资源"><a href="#CRD资源" class="headerlink" title="CRD资源"></a><img src="https://raw.githubusercontent.com/Kong/kubernetes-ingress-controller/master/docs/images/k8s-to-kong.png" alt="">CRD资源</h2><p>Kong ingress controller可以配置以下CRD资源对象，实现对kong更加精细的配置管理，官方文档在<a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/custom-resources.md" target="_blank" rel="noopener">这里</a></p><ul><li>KongIngress</li><li>KongPlugin</li><li>KongConsumer</li><li>KongCredential</li></ul><h1 id="官方YAML模板"><a href="#官方YAML模板" class="headerlink" title="官方YAML模板"></a>官方YAML模板</h1><h2 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h2><p>链接在这里<a href="https://github.com/Kong/kubernetes-ingress-controller/tree/master/deploy/manifests" target="_blank" rel="noopener">YAML模板</a>，下面几个资源对象可以直接套官方</p><ul><li>Namespace</li><li>CustomResourceDefinition</li><li>ServiceAccount</li><li>ClusterRole</li><li>ClusterRoleBinding</li></ul><p>其他的资源对象的定义还是有点不适合生产环境，需要改。</p><h1 id="基于后端数据库模式部署"><a href="#基于后端数据库模式部署" class="headerlink" title="基于后端数据库模式部署"></a>基于后端数据库模式部署</h1><h2 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h2><ul><li><p>Kubernetes集群环境不一定有<code>ELB</code>或者<code>SLB</code>，可以在Ingress节点上部署keepalived+haproxy实现高可用和负载均衡</p></li><li><p>使用外部独立的<code>PostgreSQL</code>，部署方式见<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html">PostgreSQL10安装部署和初始化</a>，数据库用户<code>kong</code>，密码<code>kong</code></p></li><li><code>kong数据平面</code><ul><li>通过<code>nodeSelector</code>加<code>tolerations</code>将Pod调度到Kubernetes指定的Ingress节点</li><li>修改<code>kong数据平面</code>运行参数</li><li>共享宿主机网络栈</li></ul></li></ul><h2 id="PostgreSQL数据库"><a href="#PostgreSQL数据库" class="headerlink" title="PostgreSQL数据库"></a>PostgreSQL数据库</h2><blockquote><p>这里使用Service配合Endpoints，将外部PostgreSQL声明为Kubernetes内部的服务。</p><p>这样Kubernetes内部的Pod可以通过SVC访问外部PostgreSQL。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">pgsql</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5432</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">5432</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="attr">  - addresses:</span></span><br><span class="line"><span class="attr">      - ip:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">      - port:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure><h2 id="Kong-Bootstrap-Job"><a href="#Kong-Bootstrap-Job" class="headerlink" title="Kong Bootstrap Job"></a>Kong Bootstrap Job</h2><ul><li>kong-ingress-migrations</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-migrations</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">kong-migrations</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">wait-for-postgres</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"until nc -zv $KONG_PG_HOST $KONG_PG_PORT -w1; do echo 'waiting for db'; sleep 1; done"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kong-migrations</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong migrations bootstrap"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h2 id="Kong数据平面"><a href="#Kong数据平面" class="headerlink" title="Kong数据平面"></a>Kong数据平面</h2><ul><li>kong-proxy TLS证书</li></ul><blockquote><p>可以通过kubectl命令生成Secret</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kong create secret tls kong-tls-secret --key ./tls.key --cert ./tls.crt</span><br></pre></td></tr></table></figure><ul><li>kong-ingress-proxy.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy-ssl</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kong-ingres-proxy</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line">      <span class="comment"># 共享宿主机网络栈</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 选择节点标签为node-role=kong的节点</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line"><span class="attr">        node-role:</span> <span class="string">kong</span></span><br><span class="line">      <span class="comment"># 容忍node-role=kong的污点</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">          key:</span> <span class="string">"node-role"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Equal"</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line">      <span class="comment"># hack to verify that the DB is up to date or not</span></span><br><span class="line">      <span class="comment"># TODO remove this for Kong &gt;= 0.15.0</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">wait-for-migrations</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong migrations list"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_DAEMON</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'0.0.0.0:80, 0.0.0.0:443 ssl'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CIPHER_SUITE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"modern"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.crt"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT_KEY</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.key"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_MAX_BODY_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_BODY_BUFFER_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"16k"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_UPSTREAM_KEEPALIVE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"60"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_REAL_IP_HEADER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"X-Real-IP"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_DB_UPDATE_FREQUENCY</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5"</span></span><br><span class="line">        <span class="comment">#- name: KONG_MEM_CACHE_SIZE</span></span><br><span class="line">        <span class="comment">#  value: "128m"</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/usr/local/bin/kong</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">start</span></span><br><span class="line">        <span class="comment">#securityContext:</span></span><br><span class="line">        <span class="comment">#  capabilities:</span></span><br><span class="line">        <span class="comment">#    add:</span></span><br><span class="line">        <span class="comment">#    - NET_BIND_SERVICE</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy-ssl</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">8443</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        lifecycle:</span></span><br><span class="line"><span class="attr">          preStop:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong quit"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/opt/tls/</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">          secret:</span></span><br><span class="line"><span class="attr">            secretName:</span> <span class="string">kong-tls-secret</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h2 id="Kong控制平面"><a href="#Kong控制平面" class="headerlink" title="Kong控制平面"></a>Kong控制平面</h2><ul><li>kong-ingress-controller.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-controller</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-admin</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-controller</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="comment"># the returned metrics are related to the kong ingress controller not kong itself</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">"10254"</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">ingress-kong</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">wait-for-migrations</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong migrations list"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">admin-api</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_DAEMON</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgres.kong.svc.cluster.local"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PG_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"0.0.0.0:8001, 0.0.0.0:8444 ssl"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'off'</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">kong-admin</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/status</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/status</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">ingress-controller</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/kong-ingress-controller</span></span><br><span class="line">        <span class="comment"># the kong URL points to the kong admin api server</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--kong-url=https://localhost:8444</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--admin-tls-skip-verify</span></span><br><span class="line">        <span class="comment"># Service from were we extract the IP address/es to use in Ingress status</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--publish-service=kong/kong-proxy</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--sync-period=10m0s</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--v=2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">kong-docker-kubernetes-ingress-controller.bintray.io/kong-ingress-controller:0.5.0</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">            readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br></pre></td></tr></table></figure><h1 id="基于无数据库模式部署"><a href="#基于无数据库模式部署" class="headerlink" title="基于无数据库模式部署"></a>基于无数据库模式部署</h1><h2 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h2><ul><li>在DBless模式中，每个kong都是独立工作的，由Kong-Ingress-Controller作为sidecar调用kong的config接口来实现配置更新。</li><li>这样就有点像把kong的配置保存在Kubernetes里面，每个kong都是独立配置，不需要依赖外部数据库，避免因为数据库故障影响所有的kong。</li><li>DBless模式有些限制，可以看<a href="https://docs.konghq.com/1.2.x/db-less-and-declarative-config/" target="_blank" rel="noopener">这里</a></li></ul><h2 id="KongIngressDBless"><a href="#KongIngressDBless" class="headerlink" title="KongIngressDBless"></a>KongIngressDBless</h2><ul><li>kong-proxy TLS证书</li></ul><blockquote><p>可以通过kubectl命令生成Secret</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kong create secret tls kong-tls-secret --key ./tls.key --cert ./tls.crt</span><br></pre></td></tr></table></figure><ul><li>kong-ingress-controller-dbless-cm.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">servers.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # Prometheus metrics server</span></span><br><span class="line"><span class="string">    server &#123;</span></span><br><span class="line"><span class="string">        server_name kong_prometheus_exporter;</span></span><br><span class="line"><span class="string">        listen 0.0.0.0:9542; # can be any other port as well</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        access_log off;</span></span><br><span class="line"><span class="string">        location /metrics &#123;</span></span><br><span class="line"><span class="string">            default_type text/plain;</span></span><br><span class="line"><span class="string">            content_by_lua_block &#123;</span></span><br><span class="line"><span class="string">                 local prometheus = require "kong.plugins.prometheus.exporter"</span></span><br><span class="line"><span class="string"></span><span class="attr">                 prometheus:</span><span class="string">collect()</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">location</span> <span class="string">/nginx_status</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">internal;</span></span><br><span class="line">            <span class="string">access_log</span> <span class="string">off;</span></span><br><span class="line">            <span class="string">stub_status;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    <span class="comment"># Health check server</span></span><br><span class="line">    <span class="comment"># TODO how to health check kong in dbless?</span></span><br><span class="line">    <span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">server_name</span> <span class="string">kong_health_check;</span></span><br><span class="line">        <span class="string">listen</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:9001;</span> <span class="comment"># can be any other port as well</span></span><br><span class="line"></span><br><span class="line">        <span class="string">access_log</span> <span class="string">off;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/health</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">return</span> <span class="number">200</span><span class="string">;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>kong-ingress-controller-dbless-ds.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kong-proxy-ssl</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kong-ingres-proxy</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kong-ingress-proxy</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">"9542"</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line">      <span class="comment"># 共享宿主机网络栈</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 选择节点标签为node-role=kong的节点</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line"><span class="attr">        node-role:</span> <span class="string">kong</span></span><br><span class="line">      <span class="comment"># 容忍node-role=kong的污点</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">          key:</span> <span class="string">"node-role"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Equal"</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"kong"</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kong-serviceaccount</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kong:1.2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_DAEMON</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"off"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_NGINX_HTTP_INCLUDE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/kong/servers.conf"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ACCESS_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stdout"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_ERROR_LOG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/dev/stderr"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_ADMIN_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"127.0.0.1:8444 ssl"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_PROXY_LISTEN</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">'0.0.0.0:80, 0.0.0.0:443 ssl'</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CIPHER_SUITE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"modern"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.crt"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_SSL_CERT_KEY</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"/opt/tls/tls.key"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_MAX_BODY_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_CLIENT_BODY_BUFFER_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"16k"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_UPSTREAM_KEEPALIVE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"60"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_REAL_IP_HEADER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"X-Real-IP"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KONG_MEM_CACHE_SIZE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"128m"</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/usr/local/bin/kong</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">start</span></span><br><span class="line">        <span class="comment">#securityContext:</span></span><br><span class="line">        <span class="comment">#  capabilities:</span></span><br><span class="line">        <span class="comment">#    add:</span></span><br><span class="line">        <span class="comment">#    - NET_BIND_SERVICE</span></span><br><span class="line"><span class="attr">        lifecycle:</span></span><br><span class="line"><span class="attr">          preStop:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"kong quit"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">proxy-ssl</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">9542</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/kong</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/opt/tls/</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">ingress-controller</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/kong-ingress-controller</span></span><br><span class="line">        <span class="comment"># the kong URL points to the kong admin api server</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--kong-url=https://localhost:8444</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--admin-tls-skip-verify</span></span><br><span class="line">        <span class="comment"># Service from were we extract the IP address/es to use in Ingress status</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--publish-service=kong/kong-proxy</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--sync-period=10m0s</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--v=2</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">kong-docker-kubernetes-ingress-controller.bintray.io/kong-ingress-controller:0.5.0</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">10254</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kong-server-blocks</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">timezone-volume</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">tls-volume</span></span><br><span class="line"><span class="attr">        secret:</span></span><br><span class="line"><span class="attr">          secretName:</span> <span class="string">kong-tls-secret</span></span><br></pre></td></tr></table></figure><h1 id="CRD资源-1"><a href="#CRD资源-1" class="headerlink" title="CRD资源"></a>CRD资源</h1><p>关于CRD资源怎么用，在Github上面是有相关的<a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/custom-resources.md" target="_blank" rel="noopener">说明文档</a></p><h2 id="KongPlugin"><a href="#KongPlugin" class="headerlink" title="KongPlugin"></a>KongPlugin</h2><blockquote><p>在kong官方网站是有<a href="https://docs.konghq.com/hub/" target="_blank" rel="noopener">关于Plugin的介绍</a></p></blockquote><h3 id="开启IP黑白名单"><a href="#开启IP黑白名单" class="headerlink" title="开启IP黑白名单"></a>开启IP黑白名单</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ip-restriction</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span>  <span class="comment"># optional</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">ip-restriction</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="comment">#  whitelist:     # 黑名单和白名单只能选一</span></span><br><span class="line"><span class="comment">#  - 8.8.8.8</span></span><br><span class="line"><span class="comment">#  - 8.8.4.4</span></span><br><span class="line"><span class="attr">  blacklist:</span> </span><br><span class="line"><span class="bullet">  -</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">8.8</span><span class="number">.4</span><span class="number">.4</span></span><br></pre></td></tr></table></figure><h3 id="开启prometheus"><a href="#开启prometheus" class="headerlink" title="开启prometheus"></a>开启prometheus</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kong-prometheus</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">  label:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  status_code:</span> <span class="number">503</span></span><br><span class="line"><span class="attr">  content_type:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  body:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  message:</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><h3 id="开启rate-limiting"><a href="#开启rate-limiting" class="headerlink" title="开启rate-limiting"></a>开启rate-limiting</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">rate-limit</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">rate-limiting</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  second:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  hour:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">  limit_by:</span> <span class="string">ip</span></span><br><span class="line"><span class="attr">  policy:</span> <span class="string">local</span>  <span class="comment">#local,cluster,redis</span></span><br></pre></td></tr></table></figure><h3 id="开启zipkin链路追踪"><a href="#开启zipkin链路追踪" class="headerlink" title="开启zipkin链路追踪"></a>开启zipkin链路追踪</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">echo-http-zipkin-trace</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">zipkin</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  http_endpoint:</span> <span class="string">"http://your.zipkin.collector:9411/api/v2/spans"</span></span><br><span class="line"><span class="attr">  sample_ratio:</span> <span class="number">1</span>  <span class="comment"># 不带tracid的请求的采样比率，1是100%，全部采集</span></span><br></pre></td></tr></table></figure><h3 id="开启Basic-Authentication"><a href="#开启Basic-Authentication" class="headerlink" title="开启Basic Authentication"></a>开启Basic Authentication</h3><blockquote><p>这里认证的时候会查找<code>KongConsumer</code>和<code>KongCredential</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">demo-basic-auth</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">basic-auth</span></span><br></pre></td></tr></table></figure><h3 id="配置Response-Header"><a href="#配置Response-Header" class="headerlink" title="配置Response Header"></a>配置Response Header</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongPlugin</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">response-transformer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  label:</span></span><br><span class="line"><span class="attr">    global:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">disable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">plugin:</span> <span class="string">response-transformer</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  replace:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  append:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  add:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"abc: def"</span></span><br><span class="line"><span class="attr">  remove:</span></span><br><span class="line"><span class="attr">    json:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">Last-Modified</span></span><br></pre></td></tr></table></figure><h2 id="KongIngress"><a href="#KongIngress" class="headerlink" title="KongIngress"></a>KongIngress</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongIngress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">configuration-demo</span></span><br><span class="line"><span class="attr">upstream:</span></span><br><span class="line"><span class="attr">  hash_on:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">  hash_fallback:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">  healthchecks:</span></span><br><span class="line"><span class="attr">    active:</span></span><br><span class="line"><span class="attr">      concurrency:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      healthy:</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">200</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">302</span></span><br><span class="line"><span class="attr">        interval:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        successes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      http_path:</span> <span class="string">"/"</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      unhealthy:</span></span><br><span class="line"><span class="attr">        http_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">429</span></span><br><span class="line"><span class="attr">        interval:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        tcp_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        timeouts:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    passive:</span></span><br><span class="line"><span class="attr">      healthy:</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">200</span></span><br><span class="line"><span class="attr">        successes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      unhealthy:</span></span><br><span class="line"><span class="attr">        http_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        http_statuses:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">429</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">503</span></span><br><span class="line"><span class="attr">        tcp_failures:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        timeouts:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    slots:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line"><span class="attr">  protocol:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">  connect_timeout:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">  retries:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  read_timeout:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">  write_timeout:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line"><span class="attr">  methods:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">GET</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">HEAD</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">POST</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">PUT</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">DELETE</span></span><br><span class="line">  <span class="comment">#- CONNECT</span></span><br><span class="line">  <span class="comment">#- OPTIONS</span></span><br><span class="line">  <span class="comment">#- TRACE</span></span><br><span class="line">  <span class="comment">#- PATCH</span></span><br><span class="line"><span class="attr">  regex_priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  strip_path:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  preserve_host:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  protocols:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">https</span></span><br></pre></td></tr></table></figure><h2 id="KongConsumer"><a href="#KongConsumer" class="headerlink" title="KongConsumer"></a>KongConsumer</h2><blockquote><p>示例</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongConsumer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">consumer-team-x</span></span><br><span class="line"><span class="attr">username:</span> <span class="string">team-X</span></span><br><span class="line"><span class="attr">custom_id:</span> <span class="string">my_team_x</span></span><br></pre></td></tr></table></figure><h2 id="KongCredential"><a href="#KongCredential" class="headerlink" title="KongCredential"></a>KongCredential</h2><blockquote><p>示例</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">configuration.konghq.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KongCredential</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">credential-team-x</span></span><br><span class="line"><span class="attr">consumerRef:</span> <span class="string">consumer-team-x</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">key-auth</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"><span class="attr">  key:</span> <span class="number">62</span><span class="string">eb165c070a41d5c1b58d9d3d725ca1</span></span><br></pre></td></tr></table></figure><h1 id="Kubernetes-Ingress配置"><a href="#Kubernetes-Ingress配置" class="headerlink" title="Kubernetes Ingress配置"></a>Kubernetes Ingress配置</h1><blockquote><p>在Ingress里面声明<code>annotations</code>属性，可以调用<code>Kong Ingress Controller</code>定义的<code>CRD资源</code></p><p><a href="https://github.com/Kong/kubernetes-ingress-controller/blob/master/docs/annotations.md" target="_blank" rel="noopener">Github文档说明在此</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment"># 这里声明使用kong ingress controller</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"kong"</span></span><br><span class="line">    <span class="comment"># 声明使用kongIngress配置</span></span><br><span class="line">    <span class="string">configuration.konghq.com:</span> <span class="string">"configuration-demo"</span></span><br><span class="line">    <span class="comment"># 声明使用KongPlugin</span></span><br><span class="line">    <span class="string">plugins.konghq.com:</span> <span class="string">"ip-restriction,kong-prometheus,response-transformer"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">    - secretName:</span> <span class="string">example-com-secret</span></span><br><span class="line"><span class="attr">      hosts:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"*.example.com"</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line">    <span class="comment"># host定义域名</span></span><br><span class="line"><span class="attr">    - host:</span> <span class="string">tomcat.example.com</span></span><br><span class="line">      <span class="comment"># 定义HTTP服务</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        paths:</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">            backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">tomcat-service</span></span><br><span class="line">              <span class="comment"># 这里可以写端口号或者端口别名http</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;如果不知道kong怎么部署，参考&lt;a href=&quot;https://luanlengli.github.io/2019/05/
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
      <category term="Kong" scheme="https://luanlengli.github.io/categories/Kubernetes/Kong/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="Kong" scheme="https://luanlengli.github.io/tags/Kong/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes deployment模板</title>
    <link href="https://luanlengli.github.io/2019/07/02/Kubernetes-deployment%E6%A8%A1%E6%9D%BF.html"/>
    <id>https://luanlengli.github.io/2019/07/02/Kubernetes-deployment模板.html</id>
    <published>2019-07-02T02:58:36.000Z</published>
    <updated>2019-07-02T03:31:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>官方文档里面的deployment样例比较简单</p><p>实际上deployment的配置选项非常的多</p><p>这里做一下记录</p></blockquote><h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./demo.jar /home/demo.jar</span></span><br></pre></td></tr></table></figure><h1 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义APP环境变量</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 定义配置文件的名称</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">java-app-configmap</span></span><br><span class="line">  <span class="comment"># 定义运行在哪个命名空间</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="comment"># 定义标签，后面可以通过标签选择器筛选</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 定义数据库连接地址和端口</span></span><br><span class="line"><span class="attr">  DB_HOST:</span> <span class="string">"mysql-svc.default.svc.cluster.local"</span></span><br><span class="line"><span class="attr">  DB_PORT:</span> <span class="string">"3306"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="comment"># 定义运行在哪个命名空间</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="comment"># 设置副本数量</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line">      <span class="comment"># 禁止自动挂载kubernetes的ServiceAccount</span></span><br><span class="line">      <span class="comment"># 理解为禁止app通过kubernetes内建的ServiceAccount访问kubernetes集群</span></span><br><span class="line"><span class="attr">      automountServiceAccountToken:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># 从镜像库拉镜像时使用用户名密码认证</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span> <span class="string">[]</span></span><br><span class="line">      <span class="comment"># 定义亲和性，调整调度策略</span></span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line">        <span class="comment"># 容器反亲和性</span></span><br><span class="line"><span class="attr">        podAntiAffinity:</span></span><br><span class="line">          <span class="comment"># preferredDuringSchedulingIgnoredDuringExecution</span></span><br><span class="line">          <span class="comment"># 优先部署在满足条件的节点，如不满足则忽略条件继续调度</span></span><br><span class="line"><span class="attr">          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="comment"># 这里定义亲和规则</span></span><br><span class="line">          <span class="comment"># 调度时会检查候选节点上是否有带有app=java-app的app，权重为100</span></span><br><span class="line">          <span class="comment"># 这里定义的是AntiAffinity，效果为同一个app在同一个节点上是互斥的</span></span><br><span class="line">          <span class="comment"># 实现同一个app不会集中在同一个节点</span></span><br><span class="line">          <span class="comment"># 极端情况下，节点数量不够，无法满足条件时，会忽略prefer规则，按照正常流程调度</span></span><br><span class="line"><span class="attr">          - podAffinityTerm:</span></span><br><span class="line"><span class="attr">              labelSelector:</span></span><br><span class="line"><span class="attr">                matchExpressions:</span></span><br><span class="line"><span class="attr">                - key:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">                  operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                  values:</span></span><br><span class="line"><span class="bullet">                  -</span> <span class="string">java-app</span></span><br><span class="line">              <span class="comment"># 这里是作用域，没啥事不用调</span></span><br><span class="line"><span class="attr">              topologyKey:</span> <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line"><span class="attr">            weight:</span> <span class="number">100</span></span><br><span class="line">      <span class="comment"># 配置Pod挂载的卷和名字</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line">      <span class="comment"># 这里定义Pod可以挂载哪些volume，容器挂载的volume要在这里定义好才可以使用</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone-volume</span></span><br><span class="line">        <span class="comment"># 定义宿主机文件路径</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line">      <span class="comment"># 容器初始化操作</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line">        <span class="comment"># 用于检测数据库就绪状态</span></span><br><span class="line">        <span class="comment"># 检查条件为数据库服务器端口是否可达</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">wait-for-db</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">busybox:1.28</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          envFrom:</span></span><br><span class="line">          <span class="comment"># 这里从configmap里面获取环境变量</span></span><br><span class="line"><span class="attr">          - configMapRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">java-app-configmap</span></span><br><span class="line">          <span class="comment"># 这里是容器初始化时，通过循环检查数据库是否就绪</span></span><br><span class="line"><span class="attr">          command:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="bullet">          -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">"until nc -zv $(DB_HOST) $(DB_PORT) -w1; do echo 'waiting for db'; sleep 1; done"</span></span><br><span class="line">      <span class="comment"># 启动容器</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line">        <span class="comment"># 业务容器</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">java-app:v1</span></span><br><span class="line">          <span class="comment"># 镜像拉取策略</span></span><br><span class="line">          <span class="comment"># IfNotPresent 如果没有就拉镜像</span></span><br><span class="line">          <span class="comment"># Always 总是拉镜像，即使节点本地有镜像</span></span><br><span class="line">          <span class="comment"># Nerver 不拉镜像</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="comment"># 定义容器资源需求</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line">            <span class="comment"># 资源限制，超过限值会被杀掉</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line">              <span class="comment"># 限制CPU用量</span></span><br><span class="line">              <span class="comment"># 1个核心的CPU等于1000m，这样多个容器是通过CPUShare共享CPU计算资源</span></span><br><span class="line">              <span class="comment"># 如果直接写数字（1、2、3）这样的话，会被认为是将容器独占CPU核心</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="string">"1500m"</span></span><br><span class="line">              <span class="comment"># 限制容器最大内存用量</span></span><br><span class="line">              <span class="comment"># 内存为不可压缩资源，超过限制会因为Out-Of-Memory被杀掉</span></span><br><span class="line">              <span class="comment"># jdk-8u131+以上的版本可以通过强制检查Linux cgroup配置</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="string">"2Gi"</span></span><br><span class="line">            <span class="comment"># Pod调度时会参考这里的资源需求调度</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line">              <span class="comment"># 限制CPU用量</span></span><br><span class="line">              <span class="comment"># 1个核心的CPU等于1000m，这样多个容器是通过CPUShare共享CPU计算资源</span></span><br><span class="line">              <span class="comment"># 如果直接写数字（1、2、3）这样的话，会被认为是将容器独占CPU核心</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="string">"100m"</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="string">"2Gi"</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line">          <span class="comment"># 这里定义JAVA_OPTS来让jvm启动时自动识别容器资源限值，然后计算出匹配的运行参数</span></span><br><span class="line">          <span class="comment"># -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap开启openjdk8的实验特性以正确识别docker资源限值</span></span><br><span class="line">          <span class="comment"># -XX:MaxRAMFraction默认值为4，即Heapsize为内存的25%，这里设置为2，即Heapsize为内存的50%</span></span><br><span class="line">          <span class="comment"># 可以通过-Xmx来指定jvm可使用的最大堆</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">            value:</span> <span class="string">"-Xmx1800m"</span></span><br><span class="line">            <span class="comment"># value: "-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=2"</span></span><br><span class="line">          <span class="comment"># 这里使用kubernetes的downwardAPI获取Pod的信息</span></span><br><span class="line">          <span class="comment"># 对于某些APP需要获取Pod自身信息时可以直接调用环境变量</span></span><br><span class="line">          <span class="comment"># Pod所在宿主机名字</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">NODE_NAME</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="comment"># Pod所在宿主机IP地址</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">NODE_IP</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">          <span class="comment"># Pod名字</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">POD_NAME</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="comment"># PodIP地址</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">POD_IP</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              fieldRef:</span></span><br><span class="line"><span class="attr">                fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line"><span class="attr">          envFrom:</span></span><br><span class="line">            <span class="comment"># 这里直接从configmap里面获取环境变量</span></span><br><span class="line">            <span class="comment"># 可以在command字段里面使用</span></span><br><span class="line">            <span class="comment"># 具体定义了哪些环境变量，可以在configmap那里看到</span></span><br><span class="line"><span class="attr">            - configMapRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">java-app-configmap</span></span><br><span class="line">          <span class="comment"># 设置容器工作目录</span></span><br><span class="line"><span class="attr">          workingDir:</span> <span class="string">/home</span></span><br><span class="line">          <span class="comment"># 设置容器启动命令和参数</span></span><br><span class="line"><span class="attr">          command:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">/usr/bin/java</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-Djava.security.egd=file:/dev/./urandom</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">            - -Xloggc:</span><span class="string">logs/gc.log</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-jar</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">/home/demo.jar</span></span><br><span class="line">          <span class="comment"># 定义容器端口</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line">            <span class="comment"># 这里定义的端口别名可以在其他地方直接调用</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">http</span></span><br><span class="line">              <span class="comment"># 定义容器运行时监听的端口，需要与Service的targetPort对应</span></span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="comment"># 定义容器存活探针</span></span><br><span class="line"><span class="attr">          livenessProbe:</span></span><br><span class="line">            <span class="comment"># 使用TCP端口探测</span></span><br><span class="line"><span class="attr">            tcpSocket:</span></span><br><span class="line">            <span class="comment"># 定义检查端口，可以写端口别名，也可以写端口号</span></span><br><span class="line"><span class="attr">              port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="comment"># 容器初始化完成后延迟检测，单位秒</span></span><br><span class="line">            <span class="comment"># 防止app启动时间过久导致被k8s判断为fail直接干掉</span></span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">            <span class="comment"># 检测频率</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># 定义容器就绪探针</span></span><br><span class="line"><span class="attr">          readinessProbe:</span></span><br><span class="line">            <span class="comment"># 使用HTTP GET请求</span></span><br><span class="line"><span class="attr">            httpGet:</span></span><br><span class="line"><span class="attr">              path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">              port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              httpHeaders:</span></span><br><span class="line"><span class="attr">              - name:</span> <span class="string">readinessProbe</span></span><br><span class="line"><span class="attr">                value:</span> <span class="string">k8s</span></span><br><span class="line">            <span class="comment"># 容器初始化完成后延迟检测，单位秒</span></span><br><span class="line">            <span class="comment"># 防止app启动时间过久导致被k8s判断为fail直接干掉</span></span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">            <span class="comment"># 检测频率</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># 把定义好的数据卷挂载到容器里面</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">timezone-volume</span></span><br><span class="line">              <span class="comment"># 这里用于配置容器的时区为Asia/Shanghai</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/etc/localtime</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;官方文档里面的deployment样例比较简单&lt;/p&gt;&lt;p&gt;实际上deployment的配置选项非常的多&lt;/p&gt;&lt;p
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu-18.04-Server虚拟机模板制作</title>
    <link href="https://luanlengli.github.io/2019/06/29/Ubuntu-18.04-Server%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A8%A1%E6%9D%BF%E5%88%B6%E4%BD%9C.html"/>
    <id>https://luanlengli.github.io/2019/06/29/Ubuntu-18.04-Server虚拟机模板制作.html</id>
    <published>2019-06-29T04:20:34.000Z</published>
    <updated>2019-11-21T09:00:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>Ubuntu 18.04 LTS已经出来一年多了，小版本号已经更新到了18.04.2。</p><p>这里记录一下Ubuntu 18.04虚拟机模板的制作过程</p></blockquote><h1 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h1><blockquote><p>这里使用清华大学的镜像源</p><p>↓↓↓↓↓↓↓↓下载地址↓↓↓↓↓↓↓↓</p><p><a href="https://mirrors.aliyun.com/ubuntu-releases/bionic/ubuntu-18.04.2-live-server-amd64.iso" target="_blank" rel="noopener">ubuntu-18.04.2-live-server-amd64.iso</a></p></blockquote><h1 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h1><ul><li>这里使用VMware Workstation 15 Pro 版本号<code>15.0.2 build-10952284</code></li><li>虚拟机规格<ul><li>客户机操作系统版本<code>Ubuntu 64位</code></li><li>处理器数量<code>2</code></li><li>内存2GB</li><li>硬盘30GB</li><li>网络适配器<code>NAT模式</code></li></ul></li></ul><h1 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h1><ul><li>启动菜单<ul><li>语言选择<code>English</code></li><li>选择<code>Install Ubuntu Server</code>或者<code>Install Ubuntu Server with the HWE kernel</code>都可以，关于HWE kernel的说明，看<a href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack" target="_blank" rel="noopener">这里</a></li></ul></li><li>安装流程<ul><li>语言选择<code>English</code></li><li>键盘Layout和Variant都选择<code>English (US)</code></li><li>安装的类型选择<code>Install Ubuntu</code>即可，另外两个选择<code>Install MAAS bare-metal cloud (region)</code>和<code>Install MAAS bare-metal cloud (region)</code>可以看一下<a href="https://ubuntu.com/download/server/provisioning" target="_blank" rel="noopener">官方说明</a></li><li>网络连接，这里根据需要配置即可</li><li>代理地址设置，没有就直接跳过</li><li>设置镜像地址，默认是<code>http://archive.ubuntu.com/ubuntu</code>，安装完系统之后可以修改，这里看需要配置即可</li><li>配置分区，这里设置<code>/boot</code>分区<code>1GB</code>，<code>/</code>分区剩余空间，无swap分区，由于Ubuntu会自动创建一个1M大小的分区用于BIOS_GRUB，因此，实际上，硬盘分区是有三个的</li><li>设置用户名密码和主机名，这里统一用Ubuntu了，密码这里尽量不要设置的太简单了<ul><li>Your name: <code>ubuntu</code></li><li>Your server’s name: <code>ubuntu</code></li><li>Pick a username: <code>ubuntu</code></li><li>Choose a password:<code>***********</code></li><li>Confirm your password:<code>***********</code></li></ul></li><li>设置SSH，选择<code>Install Openssh Server</code>，<code>Import SSH identity</code>选择<code>No</code></li><li><code>Featured Server Snaps</code>这里可以在安装系统的时候顺带选择额外安装的软件包<ul><li>这个后续安装完系统可以自己操作，所以直接跳过，避免安装时间过长！</li></ul></li><li>接下来就等待系统安装完成，安装完成后选择<code>Reboot Now</code>重启</li></ul></li></ul><h1 id="操作系统启动后初始化设置"><a href="#操作系统启动后初始化设置" class="headerlink" title="操作系统启动后初始化设置"></a>操作系统启动后初始化设置</h1><h2 id="配置ssh证书登录"><a href="#配置ssh证书登录" class="headerlink" title="配置ssh证书登录"></a>配置ssh证书登录</h2><ul><li>通过ssh命令生成密钥对</li><li>将<code>~/.ssh/id_rsa.pub</code>提取出来</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure><h2 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h2><h3 id="fs参数"><a href="#fs参数" class="headerlink" title="fs参数"></a>fs参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-fs.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同一时间异步IO请求数</span></span><br><span class="line">fs.aio-max-nr=1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="vm参数"><a href="#vm参数" class="headerlink" title="vm参数"></a>vm参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-vm.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当内存耗尽时，内核会触发OOM killer根据oom_score杀掉最耗内存的进程</span></span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许overcommit</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义了进程能拥有的最多内存区域，默认65536</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="net参数"><a href="#net参数" class="headerlink" title="net参数"></a>net参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-net.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径，默认值1</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进程间通信发送数据, 默认100</span></span><br><span class="line">net.unix.max_dgram_qlen=512</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 conntrack 的上限</span></span><br><span class="line">net.netfilter.nf_conntrack_max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置连接跟踪表中处于TIME_WAIT状态的超时时间</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_timewait=30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置连接跟踪表中TCP连接超时时间</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established=1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=21644</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收自网卡、但未被内核协议栈处理的报文队列长度</span></span><br><span class="line">net.core.netdev_max_backlog=262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统无内存压力、启动压力模式阈值、最大值，单位为页的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_mem=1541646 2055528 3083292</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核socket接收缓存区字节数min/default/max</span></span><br><span class="line">net.core.rmem=4096 65536 8388608</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核socket发送缓存区字节数min/default/max</span></span><br><span class="line">net.core.wmem=4096 65536 8388608</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启自动调节缓存模式</span></span><br><span class="line">net.ipv4.tcp_moderate_rcvbuf=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP阻塞控制算法BBR，Linux内核版本4.9开始内置BBR算法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="meta">#</span><span class="bash">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用作本地随机TCP端口的范围</span></span><br><span class="line">net.ipv4.ip_local_port_range=1000065000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog=16384</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets=5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定重发 SYN/ACK 的次数</span></span><br><span class="line">net.ipv4.tcp_synack_retries=2</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接中TIME_WAIT sockets的快速回收</span></span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不属于任何进程的tcp socket最大数量. 超过这个数量的socket会被reset, 并告警</span></span><br><span class="line">net.ipv4.tcp_max_orphans=1024</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FIN报文重试次数</span></span><br><span class="line">net.ipv4.tcp_orphan_retries=8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout=15</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP连接keepalive的持续时间，默认7200</span></span><br><span class="line">net.ipv4.tcp_keepalive_time=600</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP keepalive探测包发送间隔</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl=30</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP keepalive探测包重试次数</span></span><br><span class="line">net.ipv4.tcp_keepalive_probes=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP FastOpen</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0:关闭 ; 1:作为客户端时使用 ; 2:作为服务器端时使用 ; 3:无论作为客户端还是服务器端都使用</span></span><br><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制TCP重传次数</span></span><br><span class="line">net.ipv4.tcp_retries1=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP重传次数到达上限时，关闭TCP连接</span></span><br><span class="line">net.ipv4.tcp_retries2=15</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cat &gt; /etc/security/limits.d/99-ubuntu.conf &lt;&lt;EOF</span><br><span class="line">* - nproc 1048576</span><br><span class="line">* - nofile 1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改journal设置"><a href="#修改journal设置" class="headerlink" title="修改journal设置"></a>修改journal设置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -e 's,^#Compress=yes,Compress=yes,' \</span><br><span class="line">    -e 's,^#SystemMaxUse=,SystemMaxUse=5G,' \</span><br><span class="line">    -e 's,^#Seal=yes,Seal=yes,' \</span><br><span class="line">    -e 's,^#RateLimitBurst=1000,RateLimitBurst=5000,' \</span><br><span class="line">    -i /etc/systemd/journald.conf</span><br></pre></td></tr></table></figure><h2 id="修改终端提示符"><a href="#修改终端提示符" class="headerlink" title="修改终端提示符"></a>修改终端提示符</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export PS1='[\t]\[\033[1;31m\]&lt;\u@\h:\w&gt;\[\033[0m\]\$ '</span><br><span class="line">cat &gt;&gt; ~/.bashrc &lt;&lt; EOF</span><br><span class="line">export PS1='[\t]\[\033[1;31m\]&lt;\u@\h:\w&gt;\[\033[0m\]\\$ '</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改APT源"><a href="#修改APT源" class="headerlink" title="修改APT源"></a>修改APT源</h2><p><code>/etc/apt/sources.list</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 预发布软件源，不建议启用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> deb https://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> deb-src https://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span></span><br></pre></td></tr></table></figure><h2 id="刷新APT缓存"><a href="#刷新APT缓存" class="headerlink" title="刷新APT缓存"></a>刷新APT缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><h2 id="更新系统软件"><a href="#更新系统软件" class="headerlink" title="更新系统软件"></a>更新系统软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt upgrade</span><br></pre></td></tr></table></figure><h2 id="安装常用软件"><a href="#安装常用软件" class="headerlink" title="安装常用软件"></a>安装常用软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git \</span><br><span class="line">                 tree \</span><br><span class="line">                 software-properties-common \</span><br><span class="line">                 dirmngr \</span><br><span class="line">                 apt-transport-https \</span><br><span class="line">                 jq \</span><br><span class="line">                 socat \</span><br><span class="line">                 tcpdump \</span><br><span class="line">                 vim \</span><br><span class="line">                 ipvsadm \</span><br><span class="line">                 tree \</span><br><span class="line">                 dstat \</span><br><span class="line">                 iotop \</span><br><span class="line">                 htop \</span><br><span class="line">                 atop \</span><br><span class="line">                 socat \</span><br><span class="line">                 ipset \</span><br><span class="line">                 conntrack \</span><br><span class="line">                 netcat \</span><br><span class="line">                 bash-completion \</span><br><span class="line">                 ufw \</span><br><span class="line">                 ca-certificates \</span><br><span class="line">                 curl \</span><br><span class="line">                 gnupg2 \</span><br><span class="line">                 sudo \</span><br><span class="line">                 unzip \</span><br><span class="line">                 uuid \</span><br><span class="line">                 gnupg-agent \</span><br><span class="line">                 sysstat \</span><br><span class="line">                 nethogs \</span><br><span class="line">                 linux-tools-common</span><br></pre></td></tr></table></figure><h2 id="禁用系统服务"><a href="#禁用系统服务" class="headerlink" title="禁用系统服务"></a>禁用系统服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable iscsid.socket \</span><br><span class="line">                  iscsi.service \</span><br><span class="line">                  open-iscsi.service \</span><br><span class="line">                  rsync.service \</span><br><span class="line">                  ufw.service \</span><br><span class="line">                  uuidd.socket</span><br></pre></td></tr></table></figure><h2 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h2><ul><li>Ubuntu 18.04 LTS 使用netplan来管理网络配置，可以使用<code>NetworkManager</code>或者<code>Systemd-networkd</code>的网络守护程序来做为内核的接口。</li><li>如果再通过原来的 <code>ifupdown</code> 工具包继续在 <code>/etc/network/interfaces</code> 文件里配置管理网络接口是无效的。</li><li><p>默认的<code>systemd-resolve</code>会接管<code>/etc/resolv.conf</code>，无法直接修改，并且会监听<code>localhost:53</code>端口，看着非常不爽。修改过程如下</p></li><li><p>网卡配置文件路径<code>/etc/netplan/50-cloud-init.yaml</code>，配置文件的样例在<a href="https://netplan.io/examples" target="_blank" rel="noopener">这里</a></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file is generated from information provided by</span></span><br><span class="line"><span class="comment"># the datasource.  Changes to it will not persist across an instance.</span></span><br><span class="line"><span class="comment"># To disable cloud-init's network configuration capabilities, write a file</span></span><br><span class="line"><span class="comment"># /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:</span></span><br><span class="line"><span class="comment"># network: &#123;config: disabled&#125;</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">    ethernets:</span></span><br><span class="line"><span class="attr">        ens33:</span></span><br><span class="line"><span class="attr">            addresses:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.100</span><span class="string">/24</span></span><br><span class="line"><span class="attr">            dhcp4:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">            gateway4:</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.2</span></span><br><span class="line"><span class="attr">            nameservers:</span></span><br><span class="line"><span class="attr">                addresses:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br><span class="line"><span class="bullet">                -</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="attr">                search:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    renderer:</span> <span class="string">networkd</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><ul><li>使用netplan命令让配置生效</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><blockquote><p>这时候会发现，<code>/etc/resolv.conf</code>里面的nameserver指向127.0.0.53</p><p>并且是软链接到<code>/run/systemd/resolve/stub-resolv.conf</code></p><p>内容如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> This file is managed by man:systemd-resolved(8). Do not edit.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is a dynamic resolv.conf file <span class="keyword">for</span> connecting <span class="built_in">local</span> clients to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> internal DNS stub resolver of systemd-resolved. This file lists all</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> configured search domains.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Run <span class="string">"systemd-resolve --status"</span> to see details about the uplink DNS servers</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> currently <span class="keyword">in</span> use.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Third party programs must not access this file directly, but only through the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> symlink at /etc/resolv.conf. To manage man:resolv.conf(5) <span class="keyword">in</span> a different way,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replace this symlink by a static file or a different symlink.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See man:systemd-resolved.service(8) <span class="keyword">for</span> details about the supported modes of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> operation <span class="keyword">for</span> /etc/resolv.conf.</span></span><br><span class="line"></span><br><span class="line">nameserver 127.0.0.53</span><br><span class="line">options edns0</span><br></pre></td></tr></table></figure><ul><li>修改systemd-resolv的配置文件<code>/etc/systemd/resolv.conf</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">  This file is part of systemd.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  (at your option) any later version.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Entries <span class="keyword">in</span> this file show the compile time defaults.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can change settings by editing this file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Defaults can be restored by simply deleting this file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See resolved.conf(5) <span class="keyword">for</span> details</span></span><br><span class="line"></span><br><span class="line">[Resolve]</span><br><span class="line"><span class="meta">#</span><span class="bash">DNS=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">FallbackDNS=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Domains=</span></span><br><span class="line">LLMNR=no</span><br><span class="line">MulticastDNS=no</span><br><span class="line">DNSSEC=no</span><br><span class="line">Cache=yes</span><br><span class="line">DNSStubListener=no</span><br></pre></td></tr></table></figure><ul><li>重启systemd-resolv服务</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-resolved.service</span><br></pre></td></tr></table></figure><ul><li>修改<code>/etc/resolv.conf</code>软链接指向</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -svf /run/systemd/resolve/resolv.conf /etc/resolv.conf</span><br></pre></td></tr></table></figure><ul><li>现在再看<code>/etc/resolv.conf</code>的内容就舒服了</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> This file is managed by man:systemd-resolved(8). Do not edit.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is a dynamic resolv.conf file <span class="keyword">for</span> connecting <span class="built_in">local</span> clients directly to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> all known uplink DNS servers. This file lists all configured search domains.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Third party programs must not access this file directly, but only through the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> symlink at /etc/resolv.conf. To manage man:resolv.conf(5) <span class="keyword">in</span> a different way,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replace this symlink by a static file or a different symlink.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See man:systemd-resolved.service(8) <span class="keyword">for</span> details about the supported modes of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> operation <span class="keyword">for</span> /etc/resolv.conf.</span></span><br><span class="line"></span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure><h2 id="修改HISTORY参数"><a href="#修改HISTORY参数" class="headerlink" title="修改HISTORY参数"></a>修改HISTORY参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/profile.d/history.sh &lt;&lt;EOF</span><br><span class="line">export HISTSIZE=10000</span><br><span class="line">export HISTFILESIZE=10000</span><br><span class="line">export HISTCONTROL=ignoredups</span><br><span class="line">export HISTTIMEFORMAT="`whoami` %F %T "</span><br><span class="line">export HISTIGNORE="ls:pwd:ll:ls -l:ls -a:ll -a"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><h2 id="配置时间同步"><a href="#配置时间同步" class="headerlink" title="配置时间同步"></a>配置时间同步</h2><ul><li>Ubuntu 18.04 LTS 使用<code>systemd-timesyncd</code>实现跨网络同步系统时钟的守护服务，与NTP的复杂实现相比，这个服务简单的多，它只专注于从远程服务器查询然后同步到本地时钟。</li><li>守护进程运行只需要尽可能小特权，并且会跟网络服务 networkd 挂钩，仅在网络连接可用时才工作。</li><li>配置文件路径<code>/etc/systemd/timesyncd.conf</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#NTP=.*,NTP=cn.pool.ntp.org,' -i /etc/systemd/timesyncd.conf</span><br></pre></td></tr></table></figure><ul><li>重启systemd-timesyncd服务</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-timesyncd.service</span><br></pre></td></tr></table></figure><h2 id="修改LANG默认值"><a href="#修改LANG默认值" class="headerlink" title="修改LANG默认值"></a>修改LANG默认值</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">localectl set-locale LANG=en_US.UTF-8</span><br><span class="line">localectl set-keymap us</span><br><span class="line">localectl set-x11-keymap us</span><br></pre></td></tr></table></figure><h2 id="修改SSH配置"><a href="#修改SSH配置" class="headerlink" title="修改SSH配置"></a>修改SSH配置</h2><blockquote><p>这里禁用root通过密码方式登录，修改默认端口<code>22</code>→<code>2233</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#PermitRootLogin prohibit-password,PermitRootLogin prohibit-password,' \</span><br><span class="line">    -e 's,^#PubkeyAuthentication yes,PubkeyAuthentication yes,' \</span><br><span class="line">    -e 's,^#UseDNS no,UseDNS no,' \</span><br><span class="line">    -e 's,^#Port 22,Port 2233,' \</span><br><span class="line">    -i /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><h1 id="可选操作"><a href="#可选操作" class="headerlink" title="可选操作"></a>可选操作</h1><h2 id="禁用终端欢迎消息广告"><a href="#禁用终端欢迎消息广告" class="headerlink" title="禁用终端欢迎消息广告"></a>禁用终端欢迎消息广告</h2><ul><li>关闭获取Ubuntu新闻</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^ENABLED=1,ENABLED=0,g' -i /etc/default/motd-news</span><br></pre></td></tr></table></figure><ul><li>关闭动态motd不需要的内容</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod -x /etc/update-motd.d/80-livepatch</span><br><span class="line">chmod -x /etc/update-motd.d/10-help-text</span><br></pre></td></tr></table></figure><h2 id="禁用IPV6设置"><a href="#禁用IPV6设置" class="headerlink" title="禁用IPV6设置"></a>禁用IPV6设置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-disable-ipv6.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用ipv6</span></span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6=1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="禁用ICMP"><a href="#禁用ICMP" class="headerlink" title="禁用ICMP"></a>禁用ICMP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-disable-icmp.conf &lt;&lt;EOF</span><br><span class="line">net.ipv4.icmp_echo_ignore_all=1</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="添加vim设置"><a href="#添加vim设置" class="headerlink" title="添加vim设置"></a>添加vim设置</h2><blockquote><p>将vim设置写入<code>~/.vimrc</code>文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/.vimrc &lt;&lt;EOF</span><br><span class="line">" 显示行号</span><br><span class="line">set number</span><br><span class="line">" 高亮光标所在行</span><br><span class="line">set cursorline</span><br><span class="line">" 打开语法显示</span><br><span class="line">syntax on</span><br><span class="line">" 关闭备份</span><br><span class="line">set nobackup</span><br><span class="line">" 没有保存或文件只读时弹出确认</span><br><span class="line">set confirm</span><br><span class="line">" 禁用modeline功能</span><br><span class="line">set nomodeline</span><br><span class="line">" tab缩进</span><br><span class="line">set tabstop=4</span><br><span class="line">set shiftwidth=4</span><br><span class="line">set expandtab</span><br><span class="line">set smarttab</span><br><span class="line">" 默认缩进4个空格大小 </span><br><span class="line">set shiftwidth=4 </span><br><span class="line">" 文件自动检测外部更改</span><br><span class="line">set autoread</span><br><span class="line">" 高亮查找匹配</span><br><span class="line">set hlsearch</span><br><span class="line">" 显示匹配</span><br><span class="line">set showmatch</span><br><span class="line">" 背景色设置为黑色</span><br><span class="line">set background=dark</span><br><span class="line">" 浅色高亮显示当前行</span><br><span class="line">autocmd InsertLeave * se nocul</span><br><span class="line">" 显示输入的命令</span><br><span class="line">set showcmd</span><br><span class="line">" 字符编码</span><br><span class="line">set encoding=utf-8</span><br><span class="line">" 开启终端256色显示</span><br><span class="line">set t_Co=256</span><br><span class="line">" 增量式搜索 </span><br><span class="line">set incsearch</span><br><span class="line">" 设置默认进行大小写不敏感查找</span><br><span class="line">set ignorecase</span><br><span class="line">" 如果有一个大写字母，则切换到大小写敏感查找</span><br><span class="line">set smartcase</span><br><span class="line">" 不产生swap文件</span><br><span class="line">set noswapfile</span><br><span class="line">" 关闭提示音</span><br><span class="line">set noerrorbells</span><br><span class="line">" 历史记录</span><br><span class="line">set history=10000</span><br><span class="line">" 显示行尾空格</span><br><span class="line">set listchars=tab:»■,trail:■</span><br><span class="line">" 显示非可见字符</span><br><span class="line">set list</span><br><span class="line">" c文件自动缩进</span><br><span class="line">set cindent</span><br><span class="line">" 文件自动缩进</span><br><span class="line">set autoindent</span><br><span class="line">" 检测文件类型</span><br><span class="line">filetype on</span><br><span class="line">" 智能缩进</span><br><span class="line">set smartindent</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="配置内核模块"><a href="#配置内核模块" class="headerlink" title="配置内核模块"></a>配置内核模块</h2><h3 id="配置lvs模块"><a href="#配置lvs模块" class="headerlink" title="配置lvs模块"></a>配置lvs模块</h3><p><a href="http://zh.linuxvirtualserver.org/node/2903" target="_blank" rel="noopener">LVS的调度算法简介</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF</span><br><span class="line">ip_vs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-最少连接</span></span><br><span class="line">ip_vs_lc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-加权最少连接</span></span><br><span class="line">ip_vs_wlc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-轮询</span></span><br><span class="line">ip_vs_rr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 负载均衡调度算法-加权轮询</span></span><br><span class="line">ip_vs_wrr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 源地址散列调度算法</span></span><br><span class="line">ip_vs_sh</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置连接状态跟踪模块"><a href="#配置连接状态跟踪模块" class="headerlink" title="配置连接状态跟踪模块"></a>配置连接状态跟踪模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/nf_conntrack.conf &lt;&lt;EOF</span><br><span class="line">nf_conntrack</span><br><span class="line">nf_conntrack_ipv4</span><br><span class="line"><span class="meta">#</span><span class="bash">nf_conntrack_ipv6</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置kvm模块"><a href="#配置kvm模块" class="headerlink" title="配置kvm模块"></a>配置kvm模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/kvm.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> Intel CPU开启嵌套虚拟化</span></span><br><span class="line">options kvm-intel nested=1</span><br><span class="line">options kvm-intel enable_shadow_vmcs=1</span><br><span class="line">options kvm-intel enable_apicv=1</span><br><span class="line">options kvm-intel ept=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> AMD CPU开启嵌套虚拟化</span></span><br><span class="line"><span class="meta">#</span><span class="bash">options kvm-amd nested=1</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装Docker-CE"><a href="#安装Docker-CE" class="headerlink" title="安装Docker-CE"></a>安装Docker-CE</h2><ul><li>添加GPG KEY</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | apt-key add -</span><br></pre></td></tr></table></figure><ul><li>添加APT源</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add-apt-repository \</span><br><span class="line">   "deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \</span><br><span class="line"><span class="meta">   $</span><span class="bash">(lsb_release -cs) \</span></span><br><span class="line">   stable"</span><br></pre></td></tr></table></figure><ul><li>刷新APT缓存</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure><ul><li>查找Docker-CE版本</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-cache madison docker-ce</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker-ce | 5:18.09.7~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.6~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.5~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.4~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.3~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.2~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.1~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 5:18.09.0~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.3~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.2~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.1~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.06.0~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line">docker-ce | 18.03.1~ce~3-0~ubuntu | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br></pre></td></tr></table></figure><ul><li>安装指定版本的Docker-CE</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install docker-ce=5:18.09.7~3-0~ubuntu-bionic  \</span><br><span class="line">            docker-ce-cli=5:18.09.7~3-0~ubuntu-bionic  \</span><br><span class="line">            containerd.io</span><br></pre></td></tr></table></figure><ul><li>查看docker信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure><ul><li>修改docker配置</li></ul><blockquote><p>配置文件路径<code>/etc/docker/daemon.json</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["https://dockerhub.azk8s.cn"],</span><br><span class="line">    "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">    "insecure-registries": [],</span><br><span class="line">    "log-driver": "json-file",</span><br><span class="line">    "log-opts": &#123;</span><br><span class="line">        "max-size": "100m",</span><br><span class="line">        "max-file": "3"</span><br><span class="line">    &#125;,</span><br><span class="line">    "data-root": "/var/lib/docker",</span><br><span class="line">    "storage-driver": "overlay2",</span><br><span class="line">    "max-concurrent-downloads": 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动docker</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;Ubuntu 18.04 LTS已经出来一年多了，小版本号已经更新到了18.04.2。&lt;/p&gt;&lt;p&gt;这里记录一下Ub
      
    
    </summary>
    
      <category term="Linux" scheme="https://luanlengli.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes部署metrics-server监控集群性能</title>
    <link href="https://luanlengli.github.io/2019/06/25/Kubernetes%E7%9B%91%E6%8E%A7%E7%BB%84%E4%BB%B6metrics-server%E9%83%A8%E7%BD%B2.html"/>
    <id>https://luanlengli.github.io/2019/06/25/Kubernetes监控组件metrics-server部署.html</id>
    <published>2019-06-25T12:32:18.000Z</published>
    <updated>2019-08-05T13:33:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li><a href="https://github.com/kubernetes-incubator/metrics-server" target="_blank" rel="noopener">Metrics Server</a><br>是实现了 Metrics API 的元件,其目标是取代 Heapster 作位 Pod 与 Node 提供资源的 Usage metrics,该元件会从每个 Kubernetes 节点上的 Kubelet 所公开的 Summary API 中收集 Metrics</li><li>Horizontal Pod Autoscaler（HPA）控制器用于实现基于CPU使用率进行自动Pod伸缩的功能。</li><li>HPA控制器基于Master的kube-controller-manager服务启动参数–horizontal-pod-autoscaler-sync-period定义是时长（默认30秒）,周期性监控目标Pod的CPU使用率,并在满足条件时对ReplicationController或deployment中的Pod副本数进行调整,以符合用户定义的平均Pod CPU使用率。</li><li>在新版本的kubernetes中 Pod CPU使用率不在来源于heapster,而是来自于metrics-server</li><li>官网原话是 The –horizontal-pod-autoscaler-use-rest-clients is true or unset. Setting this to false switches to Heapster-based autoscaling, which is deprecated.</li></ul><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="kube-apiserver运行参数"><a href="#kube-apiserver运行参数" class="headerlink" title="kube-apiserver运行参数"></a>kube-apiserver运行参数</h2><blockquote><p>metric-server是扩展的apiserver，依赖于kube-aggregator，因此需要在apiserver中开启相关参数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem</span><br><span class="line">--requestheader-allowed-names=aggregator</span><br><span class="line">--requestheader-group-headers=X-Remote-Group</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">--requestheader-username-headers=X-Remote-User</span><br></pre></td></tr></table></figure><h2 id="metrics-server版本兼容"><a href="#metrics-server版本兼容" class="headerlink" title="metrics-server版本兼容"></a>metrics-server版本兼容</h2><table><thead><tr><th>Metrics Server</th><th>Metrics API group/version</th><th>Supported Kubernetes version</th></tr></thead><tbody><tr><td>0.3.x</td><td><code>metrics.k8s.io/v1beta1</code></td><td>1.8+</td></tr><tr><td>0.2.x</td><td><code>metrics.k8s.io/v1beta1</code></td><td>1.8+</td></tr><tr><td>0.1.x</td><td><code>metrics/v1alpha1</code></td><td>1.7</td></tr></tbody></table><h1 id="metrics-server部署"><a href="#metrics-server部署" class="headerlink" title="metrics-server部署"></a>metrics-server部署</h1><h2 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/k8s/</span><br></pre></td></tr></table></figure><h2 id="下载项目代码"><a href="#下载项目代码" class="headerlink" title="下载项目代码"></a>下载项目代码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://github.com/kubernetes-incubator/metrics-server/archive/v0.3.1.tar.gz | tar xz --directory=/home/k8s/</span><br></pre></td></tr></table></figure><h2 id="修改deployment"><a href="#修改deployment" class="headerlink" title="修改deployment"></a>修改deployment</h2><p>文件路径<code>/home/k8s/metrics-server-v0.3.1/deploy/1.8+/metrics-server-deployment.yaml</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">- name: metrics-server</span><br><span class="line">  image: gcrxio/metrics-server-amd64:v0.3.1</span><br><span class="line">  command:</span><br><span class="line">  - /metrics-server</span><br><span class="line">  - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS</span><br><span class="line">  - --kubelet-insecure-tls</span><br><span class="line">  - --requestheader-extra-headers-prefix=x-remote-extra-</span><br><span class="line">  - --requestheader-group-headers=x-remote-group</span><br><span class="line">  - --requestheader-username-headers=x-remote-user</span><br><span class="line">  - -v=2</span><br></pre></td></tr></table></figure><h2 id="部署metrics-server"><a href="#部署metrics-server" class="headerlink" title="部署metrics-server"></a>部署metrics-server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /home/k8s/metrics-server-v0.3.1/deploy/1.8+/</span><br></pre></td></tr></table></figure><h2 id="查看pod状态"><a href="#查看pod状态" class="headerlink" title="查看pod状态"></a>查看pod状态</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=metrics-server</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/metrics-server-86bd9d7667-5hbn6   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h1 id="验证metrics"><a href="#验证metrics" class="headerlink" title="验证metrics"></a>验证metrics</h1><blockquote><p>完成后,等待一段时间(约 30s - 1m)收集 Metrics</p></blockquote><ul><li>请求metrics api的结果</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get --raw /apis/metrics.k8s.io/v1beta1</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "kind": "APIResourceList",</span><br><span class="line">  "apiVersion": "v1",</span><br><span class="line">  "groupVersion": "metrics.k8s.io/v1beta1",</span><br><span class="line">  "resources": [</span><br><span class="line">    &#123;</span><br><span class="line">      "name": "nodes",</span><br><span class="line">      "singularName": "",</span><br><span class="line">      "namespaced": false,</span><br><span class="line">      "kind": "NodeMetrics",</span><br><span class="line">      "verbs": [</span><br><span class="line">        "get",</span><br><span class="line">        "list"</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "name": "pods",</span><br><span class="line">      "singularName": "",</span><br><span class="line">      "namespaced": true,</span><br><span class="line">      "kind": "PodMetrics",</span><br><span class="line">      "verbs": [</span><br><span class="line">        "get",</span><br><span class="line">        "list"</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>获取节点性能数据</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl top node</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-m1   695m         17%    914Mi           11%       </span><br><span class="line">k8s-m2   360m         9%     553Mi           7%        </span><br><span class="line">k8s-m3   492m         12%    533Mi           6%        </span><br><span class="line">k8s-n1   144m         3%     311Mi           3%        </span><br><span class="line">k8s-n2   149m         3%     321Mi           4%</span><br></pre></td></tr></table></figure><ul><li>获取Pod性能数据</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system top pod</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NAME                                    CPU(cores)   MEMORY(bytes)   </span><br><span class="line">coredns-56c964478c-g7q8n                14m          14Mi            </span><br><span class="line">coredns-56c964478c-zmt2j                13m          14Mi            </span><br><span class="line">kube-flannel-ds-amd64-8g6f9             6m           15Mi            </span><br><span class="line">kube-flannel-ds-amd64-hslkh             6m           21Mi            </span><br><span class="line">kube-flannel-ds-amd64-ppqkb             8m           14Mi            </span><br><span class="line">kube-flannel-ds-amd64-swj8m             7m           14Mi            </span><br><span class="line">kube-flannel-ds-amd64-zs2sd             8m           17Mi            </span><br><span class="line">kube-proxy-2dq5x                        18m          23Mi            </span><br><span class="line">kube-proxy-9lzmj                        28m          23Mi            </span><br><span class="line">kube-proxy-9xtjc                        18m          23Mi            </span><br><span class="line">kube-proxy-w7mtg                        2m           23Mi            </span><br><span class="line">kube-proxy-zvp8d                        2m           21Mi            </span><br><span class="line">metrics-server-v0.3.1-98bdfb766-s6jf6   8m           22Mi</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/metrics-server&quot; 
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus使用RemoteStorage将监控数据写入TimescaleDB</title>
    <link href="https://luanlengli.github.io/2019/06/25/Prometheus%E4%BD%BF%E7%94%A8RemoteStorage%E5%B0%86%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5TimescaleDB.html"/>
    <id>https://luanlengli.github.io/2019/06/25/Prometheus使用RemoteStorage将监控数据写入TimescaleDB.html</id>
    <published>2019-06-25T07:28:52.000Z</published>
    <updated>2019-07-16T14:34:19.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li><code>prometheus-postgresql-adapter</code>最新版本是<code>2018-10-17</code>发布的<code>v0.4.1</code></li><li>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能直接跑起来</li><li>仅用于验证功能</li><li>记录实验操作过程</li></ul><h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><table><thead><tr><th>主机名</th><th>IP地址</th><th>说明</th></tr></thead><tbody><tr><td>timescaledb</td><td>172.16.80.201</td><td>部署TimescaleDB和prometheus-postgresql-adapter</td></tr><tr><td>prometheus</td><td>172.16.80.202</td><td>部署prometheus和node_exporter</td></tr></tbody></table><h1 id="部署TimescaleDB"><a href="#部署TimescaleDB" class="headerlink" title="部署TimescaleDB"></a>部署TimescaleDB</h1><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li>【<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html">PostgreSQL10安装部署和初始化</a>】</li><li>【<a href="https://luanlengli.github.io/2019/05/25/PostgreSQL10搭建时间序列数据库TimescaleDB.html">PostgreSQL10搭建时间序列数据库TimescaleDB</a>】</li></ul><h2 id="添加YUM源"><a href="#添加YUM源" class="headerlink" title="添加YUM源"></a>添加YUM源</h2><ul><li>使用清华大学的RPM文件</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br></pre></td></tr></table></figure><ul><li>替换YUM源地址</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,download.postgresql.org/pub,mirrors4.tuna.tsinghua.edu.cn/postgresql,g' -i /etc/yum.repos.d/pgdg-redhat-all.repo</span><br></pre></td></tr></table></figure><h2 id="安装PostgreSQL10"><a href="#安装PostgreSQL10" class="headerlink" title="安装PostgreSQL10"></a>安装PostgreSQL10</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgresql10 \</span><br><span class="line">               postgresql10-server \</span><br><span class="line">               postgresql10-contrib \</span><br><span class="line">               postgresql10-test</span><br></pre></td></tr></table></figure><h2 id="安装TimescaleDB"><a href="#安装TimescaleDB" class="headerlink" title="安装TimescaleDB"></a>安装TimescaleDB</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y timescaledb_10</span><br></pre></td></tr></table></figure><h2 id="安装pg-prometheus"><a href="#安装pg-prometheus" class="headerlink" title="安装pg_prometheus"></a>安装pg_prometheus</h2><ul><li>安装编译环境</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgresql10-devel make gcc make</span><br></pre></td></tr></table></figure><ul><li>下载源代码</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://github.com/timescale/pg_prometheus/archive/0.2.1.tar.gz | tar xz</span><br></pre></td></tr></table></figure><ul><li>切换目录</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd pg_prometheus-0.2.1</span><br></pre></td></tr></table></figure><ul><li>编译安装</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/usr/pgsql-10/bin:$PATH</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><ul><li>切换到<code>postgres</code>用户</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><ul><li>初始化数据库</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/pgsql-10/bin/initdb --encoding=UTF-8  \</span><br><span class="line">                         --local=en_US.UTF8 \</span><br><span class="line">                         --username=postgres \</span><br><span class="line">                         --pwprompt \</span><br><span class="line">                         --pgdata=$PGDATA \</span><br><span class="line">                         --data-checksums</span><br></pre></td></tr></table></figure><h2 id="配置数据库"><a href="#配置数据库" class="headerlink" title="配置数据库"></a>配置数据库</h2><ul><li><code>postgresql.conf</code></li></ul><blockquote><p><font color="red">最重要</font>的是添加<code>shared_preload_libraries = &#39;timescaledb, pg_prometheus&#39;</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PostgreSQL configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file consists of lines of the form:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   name = value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (The <span class="string">"="</span> is optional.)  Whitespace may be used.  Comments are introduced with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"#"</span> anywhere on a line.  The complete list of parameter names and allowed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> values can be found <span class="keyword">in</span> the PostgreSQL documentation.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The commented-out settings shown <span class="keyword">in</span> this file represent the default values.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Re-commenting a setting is NOT sufficient to revert it to the default value;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you need to reload the server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file is <span class="built_in">read</span> on server startup and when the server receives a SIGHUP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> signal.  If you edit the file on a running system, you have to SIGHUP the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server <span class="keyword">for</span> the changes to take effect, run <span class="string">"pg_ctl reload"</span>, or execute</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"SELECT pg_reload_conf()"</span>.  Some parameters, <span class="built_in">which</span> are marked below,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> require a server shutdown and restart to take effect.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Any parameter can also be given as a <span class="built_in">command</span>-line option to the server, e.g.,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"postgres -c log_connections=on"</span>.  Some parameters can be changed at run time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with the <span class="string">"SET"</span> SQL <span class="built_in">command</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Memory units:  kB = kilobytes        Time units:  ms  = milliseconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                MB = megabytes                     s   = seconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                GB = gigabytes                     min = minutes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                TB = terabytes                     h   = hours</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                                                   d   = days</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FILE LOCATIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">data_directory = <span class="string">'ConfigDir'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">hba_file = <span class="string">'ConfigDir/pg_hba.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ident_file = <span class="string">'ConfigDir/pg_ident.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">external_pid_file = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONNECTIONS AND AUTHENTICATION</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Connection Settings -</span></span><br><span class="line">listen_addresses = '*'</span><br><span class="line">port = 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> max_connections默认是100</span></span><br><span class="line">max_connections = 500</span><br><span class="line">superuser_reserved_connections = 3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - TCP settings -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为0，即使用系统默认值</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_idle = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_interval = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_count = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_user_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Authentication -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 认证超时时间，默认1min</span></span><br><span class="line">authentication_timeout = 30s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码加密算法，默认md5</span></span><br><span class="line">password_encryption = md5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GSSAPI using Kerberos</span></span><br><span class="line"><span class="meta">#</span><span class="bash">krb_server_keyfile = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">krb_caseins_users = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - SSL -</span></span><br><span class="line">ssl = off</span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ca_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_cert_file = <span class="string">'server.crt'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_crl_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_key_file = <span class="string">'server.key'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ciphers = <span class="string">'HIGH:MEDIUM:+3DES:!aNULL'</span> <span class="comment"># allowed SSL ciphers</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_prefer_server_ciphers = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ecdh_curve = <span class="string">'prime256v1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_min_protocol_version = <span class="string">'TLSv1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_max_protocol_version = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_dh_params_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_passphrase_command = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_passphrase_command_supports_reload = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RESOURCE USAGE (except WAL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Memory -</span></span><br><span class="line">shared_buffers = 128MB</span><br><span class="line"><span class="meta">#</span><span class="bash">huge_pages = try</span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_buffers = 8MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_prepared_transactions = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">work_mem = 4MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maintenance_work_mem = 64MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_work_mem = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_stack_depth = 2MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">shared_memory_type = mmap</span></span><br><span class="line">dynamic_shared_memory_type = posix</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Disk -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_file_limit = -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Kernel Resources -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_files_per_process = 1000</span></span><br><span class="line">shared_preload_libraries = 'timescaledb, pg_prometheus'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Cost-Based Vacuum Delay -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_delay = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_hit = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_miss = 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_dirty = 20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_limit = 200</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Background Writer -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_delay = 200ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_lru_maxpages = 100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_lru_multiplier = 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_flush_after = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Asynchronous Behavior -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">effective_io_concurrency = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_worker_processes = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_maintenance_workers = 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_workers_per_gather = 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_leader_participation = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_workers = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">old_snapshot_threshold = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">backend_flush_after = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WRITE AHEAD LOG</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Settings -</span></span><br><span class="line">wal_level = replica</span><br><span class="line">fsync = on</span><br><span class="line">synchronous_commit = on</span><br><span class="line">wal_sync_method = fdatasync</span><br><span class="line"><span class="meta">#</span><span class="bash">full_page_writes = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_compression = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如需要用pg_rewind修复WAL的timeline, 需要打开wal_log_hints</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 但是开启它会导致写wal变多, 请斟酌</span></span><br><span class="line">wal_log_hints = off</span><br><span class="line"><span class="meta">#</span><span class="bash">wal_init_zero = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_recycle = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_buffers = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_writer_delay = 200ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_writer_flush_after = 1MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">commit_delay = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">commit_siblings = 5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Checkpoints -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_timeout = 5min</span></span><br><span class="line">max_wal_size = 1GB</span><br><span class="line">min_wal_size = 80MB</span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_completion_target = 0.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_flush_after = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_warning = 30s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Archiving -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_mode = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_command = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> REPLICATION</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Sending Server(s) -</span></span><br><span class="line">max_wal_senders = 10</span><br><span class="line"><span class="meta">#</span><span class="bash"> wal_keep_segments可以设置大一点，每个segments大小16MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样在备库不会因为wal receiver启动太慢导致所需wal在主库被删除</span></span><br><span class="line">wal_sender_timeout = 60s</span><br><span class="line"><span class="meta">#</span><span class="bash">max_replication_slots = 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">track_commit_timestamp = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Master Server -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">synchronous_standby_names = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_defer_cleanup_age = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Standby Servers -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hot_standby = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_standby_archive_delay = 30s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_standby_streaming_delay = 30s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_receiver_status_interval = 10s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hot_standby_feedback = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_receiver_timeout = 60ss</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_retrieve_retry_interval = 5s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Subscribers -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_logical_replication_workers = 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_sync_workers_per_subscription = 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> QUERY TUNING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Planner Method Configuration -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_bitmapscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_hashagg = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_hashjoin = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_indexscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_indexonlyscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_material = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_mergejoin = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_nestloop = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_seqscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_sort = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_tidscan = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Planner Cost Constants -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">seq_page_cost = 1.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">random_page_cost = 4.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_tuple_cost = 0.01</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_index_tuple_cost = 0.005</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_operator_cost = 0.0025</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_tuple_cost = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_setup_cost = 1000.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">min_parallel_table_scan_size = 8MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">min_parallel_index_scan_size = 512kB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">effective_cache_size = 4GB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Genetic Query Optimizer -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_threshold = 12</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_effort = 5</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_pool_size = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_generations = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_selection_bias = 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_seed = 0.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Planner Options -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_statistics_target = 100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">constraint_exclusion = partition</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cursor_tuple_fraction = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">from_collapse_limit = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">join_collapse_limit = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">force_parallel_mode = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ERROR REPORTING AND LOGGING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Where to Log -</span></span><br><span class="line">log_destination = 'stderr'</span><br><span class="line">logging_collector = on</span><br><span class="line">log_directory = 'log'</span><br><span class="line">log_filename = 'postgresql-%Y%m%d.log'</span><br><span class="line"><span class="meta">#</span><span class="bash">log_file_mode = 0600</span></span><br><span class="line">log_truncate_on_rotation = off</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line">log_rotation_size = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> These are relevant when logging to syslog:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_facility = <span class="string">'LOCAL0'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_ident = <span class="string">'postgres'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_sequence_numbers = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_split_messages = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - When to Log -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_messages = warning </span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_error_statement = error</span></span><br><span class="line">log_min_duration_statement = 0 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - What to Log -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_parse = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_rewritten = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_plan = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_pretty_print = on</span></span><br><span class="line">log_checkpoints = on </span><br><span class="line">log_connections = on </span><br><span class="line">log_disconnections = on </span><br><span class="line">log_duration = on </span><br><span class="line">log_error_verbosity = verbose</span><br><span class="line"><span class="meta">#</span><span class="bash">log_hostname = off</span></span><br><span class="line">log_line_prefix = '%m [%p]: user=%u,db=%d '</span><br><span class="line">log_lock_waits = on</span><br><span class="line"><span class="meta">#</span><span class="bash">log_statement = <span class="string">'none'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_replication_commands = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_temp_files = -1</span></span><br><span class="line">log_timezone = 'PRC'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Process Title -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cluster_name = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">update_process_title = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RUNTIME STATISTICS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Query/Index Statistics Collector -</span></span><br><span class="line">track_activities = on</span><br><span class="line">track_counts = on</span><br><span class="line">track_io_timing = on</span><br><span class="line">track_functions = none</span><br><span class="line">track_activity_query_size = 1024</span><br><span class="line">stats_temp_directory = 'pg_stat_tmp'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Statistics Monitoring -</span></span><br><span class="line">log_parser_stats = on</span><br><span class="line">log_planner_stats = on</span><br><span class="line">log_executor_stats = on</span><br><span class="line">log_statement_stats = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AUTOVACUUM PARAMETERS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_autovacuum_min_duration = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_max_workers = 3</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_naptime = 1min</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_threshold = 50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_analyze_threshold = 50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_scale_factor = 0.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_analyze_scale_factor = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_freeze_max_age = 200000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_multixact_freeze_max_age = 400000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_cost_delay = 20ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_cost_limit = -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CLIENT CONNECTION DEFAULTS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Statement Behavior -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_min_messages = notice</span></span><br><span class="line"><span class="meta">#</span><span class="bash">search_path = <span class="string">'"$user", public'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_tablespace = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_tablespaces = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">check_function_bodies = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_isolation = <span class="string">'read committed'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_read_only = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_deferrable = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">session_replication_role = <span class="string">'origin'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">statement_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lock_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">idle_in_transaction_session_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_freeze_min_age = 50000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_freeze_table_age = 150000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_multixact_freeze_min_age = 5000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_multixact_freeze_table_age = 150000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bytea_output = <span class="string">'hex'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">xmlbinary = <span class="string">'base64'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">xmloption = <span class="string">'content'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">gin_fuzzy_search_limit = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gin_pending_list_limit = 4MB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Locale and Formatting -</span></span><br><span class="line">datestyle = 'iso, ymd'</span><br><span class="line"><span class="meta">#</span><span class="bash">intervalstyle = <span class="string">'postgres'</span></span></span><br><span class="line">timezone = 'PRC'</span><br><span class="line"><span class="meta">#</span><span class="bash">timezone_abbreviations = <span class="string">'Default'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">extra_float_digits = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_encoding = sql_ascii</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> These settings are initialized by initdb, but they can be changed.</span></span><br><span class="line">lc_messages = 'en_US.UTF-8'# locale for system error message strings</span><br><span class="line">lc_monetary = 'en_US.UTF-8'# locale for monetary formatting</span><br><span class="line">lc_numeric = 'en_US.UTF-8'# locale for number formatting</span><br><span class="line">lc_time = 'en_US.UTF-8'# locale for time formatting</span><br><span class="line"><span class="meta">#</span><span class="bash"> default configuration <span class="keyword">for</span> text search</span></span><br><span class="line">default_text_search_config = 'pg_catalog.english'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Defaults -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dynamic_library_path = <span class="string">'$libdir'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_preload_libraries = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">session_preload_libraries = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LOCK MANAGEMENT</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">deadlock_timeout = 1s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_locks_per_transaction = 64</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_transaction = 64</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_relation = -2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_page = 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> VERSION/PLATFORM COMPATIBILITY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Previous PostgreSQL Versions -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">array_nulls = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">backslash_quote = safe_encoding</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_with_oids = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">escape_string_warning = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lo_compat_privileges = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">operator_precedence_warning = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">quote_all_identifiers = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">standard_conforming_strings = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">synchronize_seqscans = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Platforms and Clients -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">transform_null_equals = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ERROR HANDLING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">exit_on_error = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">restart_after_crash = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">data_sync_retry = off</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG FILE INCLUDES</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">include_dir = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">include_if_exists = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">include = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CUSTOMIZED OPTIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Add settings <span class="keyword">for</span> extensions here</span></span><br></pre></td></tr></table></figure><ul><li><code>pg_hba.conf</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认配置数据库主机以socket、127.0.0.1、::1的方式连接数据库可以跳过认证阶段直接登录数据库</span></span><br><span class="line">local   all             all                                     trust</span><br><span class="line">host    all             all             127.0.0.1/32            trust</span><br><span class="line">host    all             all             ::1/128                 trust</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置app_user可以基于用户名密码+MD5加密算法从0.0.0.0/0访问数据库服务，并且是能访问所有databases</span></span><br><span class="line">host    all             all             0.0.0.0/0               md5</span><br></pre></td></tr></table></figure><h2 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable postgresql-10.service</span><br><span class="line">systemctl start postgresql-10.service</span><br></pre></td></tr></table></figure><h2 id="创建Prometheus数据库"><a href="#创建Prometheus数据库" class="headerlink" title="创建Prometheus数据库"></a>创建Prometheus数据库</h2><ul><li>登录数据库</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><ul><li>创建用户</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">ROLE</span> prometheus <span class="keyword">WITH</span> LOGIN <span class="keyword">PASSWORD</span> <span class="string">'prometheus_password'</span>;</span><br></pre></td></tr></table></figure><ul><li>创建数据库</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> prometheus owner prometheus;</span><br></pre></td></tr></table></figure><ul><li>切换数据库</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\connect prometheus ;</span><br></pre></td></tr></table></figure><ul><li>添加Extension</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION pg_prometheus;</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION timescaledb;</span><br></pre></td></tr></table></figure><ul><li>授权</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> all <span class="keyword">on</span> <span class="keyword">SCHEMA</span> prometheus <span class="keyword">TO</span> prometheus;</span><br></pre></td></tr></table></figure><ul><li>创建表</li></ul><blockquote><p>只使用pg_prometheus</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> create_prometheus_table(<span class="string">'metrics'</span>);</span><br></pre></td></tr></table></figure><blockquote><p>TimescaleDB可以实现时序数据库的功能，带来更强的性能和可扩展性。</p><p>如果postgresql已经安装了TimescaleDB的Extension，则会自动启用TimescaleDB。</p><p>可以显式的让pg_prometheus使用TimescaleDB扩展。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> create_prometheus_table(<span class="string">'metrics'</span>,use_timescaledb=&gt;<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h1 id="部署Adapter"><a href="#部署Adapter" class="headerlink" title="部署Adapter"></a>部署Adapter</h1><h2 id="下载二进制文件"><a href="#下载二进制文件" class="headerlink" title="下载二进制文件"></a>下载二进制文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://github.com/timescale/prometheus-postgresql-adapter/releases/download/0.4.1/prometheus-postgresql-adapter-0.4.1-linux-amd64.tar.gz | tar xz</span><br></pre></td></tr></table></figure><h2 id="拷贝到PATH目录"><a href="#拷贝到PATH目录" class="headerlink" title="拷贝到PATH目录"></a>拷贝到PATH目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv prometheus-postgresql-adapter /usr/local/bin/</span><br></pre></td></tr></table></figure><h2 id="创建systemd服务"><a href="#创建systemd服务" class="headerlink" title="创建systemd服务"></a>创建systemd服务</h2><ul><li>/usr/lib/systemd/system/prometheus-postgresql-adapter.service</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=prometheus-postgresql-adapter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">ExecStart=/usr/local/bin/prometheus-postgresql-adapter \</span><br><span class="line">          -adapter.send-timeout 30s \</span><br><span class="line">          -log.level info \</span><br><span class="line">          -pg.database prometheus \</span><br><span class="line">          -pg.host timescaledb \</span><br><span class="line">          -pg.port 5432 \</span><br><span class="line">          -pg.user prometheus \</span><br><span class="line">          -pg.password prometheus_password \</span><br><span class="line">          -web.listen-address :9201 \</span><br><span class="line">          -web.telemetry-path /metrics</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="启动Adapter"><a href="#启动Adapter" class="headerlink" title="启动Adapter"></a>启动Adapter</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable prometheus-postgresql-adapter.service</span><br><span class="line">systemctl start prometheus-postgresql-adapter.service</span><br></pre></td></tr></table></figure><h1 id="部署Prometheus"><a href="#部署Prometheus" class="headerlink" title="部署Prometheus"></a>部署Prometheus</h1><h2 id="参考文档-1"><a href="#参考文档-1" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li>【<a href="https://luanlengli.github.io/2019/05/01/Prometheus搭建简单的监控告警系统.html">Prometheus搭建简单的监控告警系统</a>】</li></ul><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus配置目录</span></span><br><span class="line">mkdir -p /etc/prometheus /etc/prometheus/rules.d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir -p /var/lib/prometheus</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus用户</span></span><br><span class="line">useradd prometheus</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改属主属组</span></span><br><span class="line">chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus</span><br></pre></td></tr></table></figure><h2 id="下载软件包"><a href="#下载软件包" class="headerlink" title="下载软件包"></a>下载软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz | tar xz</span><br></pre></td></tr></table></figure><h2 id="拷贝到PATH目录-1"><a href="#拷贝到PATH目录-1" class="headerlink" title="拷贝到PATH目录"></a>拷贝到PATH目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd prometheus-2.9.2.linux-amd64</span><br><span class="line">chown -R prometheus:prometheus prometheus \</span><br><span class="line">                               promtool \</span><br><span class="line">                               console_libraries \</span><br><span class="line">                               consoles \</span><br><span class="line">                               prometheus.yml</span><br><span class="line">mv prometheus promtool /usr/local/bin/</span><br><span class="line">mv console_libraries consoles prometheus.yml /etc/prometheus/</span><br></pre></td></tr></table></figure><h2 id="配置prometheus"><a href="#配置prometheus" class="headerlink" title="配置prometheus"></a>配置prometheus</h2><ul><li>/etc/prometheus/prometheus.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">alerting:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">rule_files:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line"><span class="attr">    - url:</span> <span class="string">"http://timescaledb:9201/write"</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line"><span class="attr">    - url:</span> <span class="string">"http://timescaledb:9201/read"</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9090</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9100</span></span><br></pre></td></tr></table></figure><h2 id="创建systemd服务-1"><a href="#创建systemd服务-1" class="headerlink" title="创建systemd服务"></a>创建systemd服务</h2><ul><li>/usr/lib/systemd/system/prometheus.service</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=prometheus</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/prometheus \</span><br><span class="line">          --config.file=/etc/prometheus/prometheus.yml \</span><br><span class="line">          --storage.tsdb.path=/var/lib/prometheus \</span><br><span class="line">          --storage.tsdb.retention.time=15d \</span><br><span class="line">          --storage.tsdb.retention.size=40GB \</span><br><span class="line">          --web.console.templates=/etc/prometheus/consoles \</span><br><span class="line">          --web.console.libraries=/etc/prometheus/console_libraries</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="启动prometheus"><a href="#启动prometheus" class="headerlink" title="启动prometheus"></a>启动prometheus</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable prometheus.service</span><br><span class="line">systemctl start prometheus.service</span><br></pre></td></tr></table></figure><h1 id="部署node-exporter"><a href="#部署node-exporter" class="headerlink" title="部署node_exporter"></a>部署node_exporter</h1><h2 id="下载软件包-1"><a href="#下载软件包-1" class="headerlink" title="下载软件包"></a>下载软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz | tar xz</span><br></pre></td></tr></table></figure><h2 id="拷贝到PATH目录-2"><a href="#拷贝到PATH目录-2" class="headerlink" title="拷贝到PATH目录"></a>拷贝到PATH目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd node_exporter-0.18.0.linux-amd64</span><br><span class="line">chown root:root node_exporter</span><br><span class="line">chmod 755 node_exporter</span><br><span class="line">mv node_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h2 id="创建systemd服务-2"><a href="#创建systemd服务-2" class="headerlink" title="创建systemd服务"></a>创建systemd服务</h2><ul><li>/usr/lib/systemd/system/node_exporter.service</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">ExecStart=/usr/local/bin/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="启动node-exporter"><a href="#启动node-exporter" class="headerlink" title="启动node_exporter"></a>启动node_exporter</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable node_exporter.service</span><br><span class="line">systemctl start node_exporter.service</span><br></pre></td></tr></table></figure><h1 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h1><h2 id="查看Adapter日志"><a href="#查看Adapter日志" class="headerlink" title="查看Adapter日志"></a>查看Adapter日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u prometheus-postgresql-adapter.service -f</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Month Day HH:mm:ss timescaledb prometheus-postgresql-adapter[6953]: node_xfs_block_map_btree_records_inserted_total&#123;device="sda1",instance="localhost:9100",job="node-exporter"&#125; 0 1563284554124</span><br><span class="line">Month Day HH:mm:ss timescaledb prometheus-postgresql-adapter[6953]: node_xfs_block_map_btree_records_inserted_total&#123;device="sda2",instance="localhost:9100",job="node-exporter"&#125; 0 1563284554124</span><br><span class="line">Month Day HH:mm:ss timescaledb prometheus-postgresql-adapter[6953]: node_xfs_block_mapping_extent_list_compares_total&#123;device="sda1",instance="localhost:9100",job="node-exporter"&#125; 0 1563284554124</span><br><span class="line">Month Day HH:mm:ss timescaledb prometheus-postgresql-adapter[6953]: node_xfs_block_mapping_extent_list_compares_total&#123;device="sda2",instance="localhost:9100",job="node-exporter"&#125; 0 1563284554124</span><br></pre></td></tr></table></figure><h2 id="查看网卡ens33总流量"><a href="#查看网卡ens33总流量" class="headerlink" title="查看网卡ens33总流量"></a>查看网卡ens33总流量</h2><h3 id="PromQL"><a href="#PromQL" class="headerlink" title="PromQL"></a>PromQL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_network_transmit_bytes_total&#123;device=&quot;ens33&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prometheus=&gt; SELECT time, value AS "total transmitted bytes"</span><br><span class="line">             FROM metrics</span><br><span class="line">             WHERE labels-&gt;&gt;'device' = 'ens33' AND</span><br><span class="line">                   name='node_network_transmit_bytes_total'</span><br><span class="line">             ORDER BY time;</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">            time            | total transmitted bytes </span><br><span class="line"><span class="comment">----------------------------+-------------------------</span></span><br><span class="line"> YYYY-MM-DD 21:42:34.124+08 |                 9058222</span><br><span class="line"> YYYY-MM-DD 21:42:39.123+08 |                 9095088</span><br><span class="line"> YYYY-MM-DD 21:42:44.124+08 |                 9128038</span><br><span class="line"> YYYY-MM-DD 21:42:49.124+08 |                 9161183</span><br><span class="line"> YYYY-MM-DD 21:42:54.123+08 |                 9198099</span><br><span class="line"> YYYY-MM-DD 21:42:59.124+08 |                 9231065</span><br></pre></td></tr></table></figure><h2 id="查系统最近24小时的5min平均负载"><a href="#查系统最近24小时的5min平均负载" class="headerlink" title="查系统最近24小时的5min平均负载"></a>查系统最近24小时的5min平均负载</h2><h3 id="PromQL-1"><a href="#PromQL-1" class="headerlink" title="PromQL"></a>PromQL</h3><blockquote><p>只能返回一个值</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_load5</span><br></pre></td></tr></table></figure><h3 id="SQL-1"><a href="#SQL-1" class="headerlink" title="SQL"></a>SQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">prometheus=&gt; SELECT time_bucket('5 minutes', time) AS five_min_bucket, name, avg(value)</span><br><span class="line">             FROM metrics</span><br><span class="line">             WHERE (name='node_load5' OR name='node_memory_Active_bytes') AND</span><br><span class="line">                   time &gt; NOW() - interval '1 day'</span><br><span class="line">             GROUP BY five_min_bucket,name</span><br><span class="line">             ORDER BY five_min_bucket;</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    five_min_bucket     |           name           |        avg         </span><br><span class="line"><span class="comment">------------------------+--------------------------+--------------------</span></span><br><span class="line"> YYYY-MM-DD 21:40:00+08 | node_load5               |              0.056</span><br><span class="line"> YYYY-MM-DD 21:40:00+08 | node_memory_Active_bytes |   177269828.266667</span><br><span class="line"> YYYY-MM-DD 21:45:00+08 | node_load5               | 0.0435593220338983</span><br><span class="line"> YYYY-MM-DD 21:45:00+08 | node_memory_Active_bytes |   177018845.288136</span><br><span class="line"> YYYY-MM-DD 21:50:00+08 | node_load5               | 0.0326666666666667</span><br><span class="line"> YYYY-MM-DD 21:50:00+08 | node_memory_Active_bytes |   182458094.933333</span><br><span class="line"> YYYY-MM-DD 21:55:00+08 | node_load5               |              0.024</span><br><span class="line"> YYYY-MM-DD 21:55:00+08 | node_memory_Active_bytes |        185453363.2</span><br><span class="line">(8 rows)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;prometheus-postgresql-adapter&lt;/code&gt;最新版本是&lt;code&gt;2018-10-17&lt;/
      
    
    </summary>
    
      <category term="Prometheus" scheme="https://luanlengli.github.io/categories/Prometheus/"/>
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/categories/Prometheus/PostgreSQL/"/>
    
    
      <category term="Prometheus" scheme="https://luanlengli.github.io/tags/Prometheus/"/>
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>二进制部署Kubernetes-v1.14.x高可用集群</title>
    <link href="https://luanlengli.github.io/2019/06/23/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes-v1-14-x%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2019/06/23/二进制部署Kubernetes-v1-14-x高可用集群.html</id>
    <published>2019-06-23T03:55:12.000Z</published>
    <updated>2019-08-12T05:19:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><ul><li><font color="red">只记录部署过程，不保证<code>ctrl+c</code>和<code>ctrl+v</code>能直接跑！请自行判断参数是否能直接套用！</font></li><li>Kubernetes-v1.15已经在<code>2019-06-19</code>发布，而Kubernetes-v1.14作为上一个release版本已经更新到了1.14.3。</li><li>之前写的Kubernetes-v1.11的高可用集群部署文档由于版本变迁部分参数需要改动，部署过程有些地方欠缺考虑，这里以Kubernetes-v1.14.3版本重新做一次文档整理</li><li>因此文章整体架构基本与【<a href="https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.x 高可用集群.html">二进制部署 kubernetes v1.11.x 高可用集群</a>】相同</li><li>配置部分参考kubeadm的参数</li></ul><h2 id="部署说明"><a href="#部署说明" class="headerlink" title="部署说明"></a>部署说明</h2><p>本次部署方式为二进制可执行文件的方式部署</p><ul><li>注意<font color="red">请根据自己的实际情况调整</font></li><li>对于生产环境部署，请注意某些参数的选择</li></ul><p>如无特殊说明，均在<font color="red">k8s-m1</font>节点上执行</p><h2 id="参考博文"><a href="#参考博文" class="headerlink" title="参考博文"></a>参考博文</h2><p>感谢两位大佬的文章，这里整合一下两位大佬的内容，结合自己的理解整理本文</p><ul><li>漠然大佬的【<a href="https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/" target="_blank" rel="noopener">Kubernetes 1.13.4 搭建</a>】</li><li>张馆长的【<a href="https://zhangguanzhang.github.io/2019/03/03/kubernetes-1-13-4/" target="_blank" rel="noopener">二进制部署Kubernetes v1.13.5 HA可选</a>】</li></ul><h2 id="软件版本"><a href="#软件版本" class="headerlink" title="软件版本"></a>软件版本</h2><blockquote><p>这里参考<code>kubeadm-1.14</code>的镜像版本和yum源依赖</p></blockquote><ul><li>Kubernetes版本<code>v1.14.3</code></li><li>Docker-CE版本<code>18.09.06</code></li><li>CNI-Plugins版本<code>v0.75</code></li><li>etcd版本<code>v3.2.24</code></li></ul><h2 id="网络信息"><a href="#网络信息" class="headerlink" title="网络信息"></a>网络信息</h2><ul><li>基于CNI的模式实现容器网络</li><li>Cluster IP CIDR: <code>10.244.0.0/16</code></li><li>Service Cluster IP CIDR: <code>10.96.0.0/12</code></li><li>Service DNS IP: <code>10.96.0.10</code></li><li>Kubernetes API VIP: <code>172.16.80.200</code></li></ul><h2 id="节点信息"><a href="#节点信息" class="headerlink" title="节点信息"></a>节点信息</h2><ul><li>操作系统可采用 <code>Ubuntu Server 16.04 LTS</code> 、<code>Ubuntu Server 18.04 LTS</code>和 <code>CentOS 7.6</code></li><li>由<code>keepalived</code>提供VIP</li><li>由<code>haproxy</code>提供<code>kube-apiserver</code>四层负载均衡</li><li>通过污点的方式防止工作负载被调度到master节点</li><li>服务器配置请根据实际情况适当调整</li></ul><table><thead><tr><th style="text-align:center">IP地址</th><th style="text-align:center">主机名</th><th>操作系统</th><th>内核版本</th><th style="text-align:center">角色</th><th style="text-align:center">CPU</th><th style="text-align:center">内存</th></tr></thead><tbody><tr><td style="text-align:center">172.16.80.201</td><td style="text-align:center">k8s-m1</td><td>CentOS-7.6.1810</td><td>3.10.0-957</td><td style="text-align:center">master+node</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.202</td><td style="text-align:center">k8s-m2</td><td>CentOS-7.6.1810</td><td>3.10.0-957</td><td style="text-align:center">master+node</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.203</td><td style="text-align:center">k8s-m3</td><td>CentOS-7.6.1810</td><td>3.10.0-957</td><td style="text-align:center">master+node</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.204</td><td style="text-align:center">k8s-n1</td><td>CentOS-7.6.1810</td><td>3.10.0-957</td><td style="text-align:center">node</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.205</td><td style="text-align:center">k8s-n2</td><td>CentOS-7.6.1810</td><td>3.10.0-957</td><td style="text-align:center">node</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr></tbody></table><h2 id="目录说明"><a href="#目录说明" class="headerlink" title="目录说明"></a>目录说明</h2><ul><li>/usr/local/bin/：存放kubernetes和etcd二进制文件</li><li>/opt/cni/bin/： 存放cni-plugin二进制文件</li><li>/etc/etcd/：存放etcd配置文件和SSL证书</li><li>/etc/kubernetes/：存放kubernetes配置和SSL证书</li><li>/etc/cni/net.d/：安装CNI插件后会在这里生成配置文件</li><li>$HOME/.kube/：kubectl命令会在家目录下建立此目录，用于保存访问kubernetes集群的配置和缓存</li><li>$HOME/.helm/：helm命令会建立此目录，用于保存helm缓存和repository信息</li></ul><h1 id="事前准备"><a href="#事前准备" class="headerlink" title="事前准备"></a>事前准备</h1><ul><li><p>事情准备在所有服务器上都需要完成</p></li><li><p>部署过程以<code>root用户</code>完成</p></li><li>所有服务器<code>网络互通</code>，<code>k8s-m1</code>可以通过SSH证书免密登录到其他master节点，用于分发文件</li></ul><h2 id="编辑hosts文件"><a href="#编辑hosts文件" class="headerlink" title="编辑hosts文件"></a>编辑hosts文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.200 k8s-vip</span><br><span class="line">172.16.80.201 k8s-m1</span><br><span class="line">172.16.80.202 k8s-m2</span><br><span class="line">172.16.80.203 k8s-m3</span><br><span class="line">172.16.80.204 k8s-n1</span><br><span class="line">172.16.80.205 k8s-n2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="时间同步服务"><a href="#时间同步服务" class="headerlink" title="时间同步服务"></a>时间同步服务</h2><p>集群系统需要各节点时间同步</p><p>参考链接：<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/sect-using_chrony" target="_blank" rel="noopener">RHEL7官方文档</a></p><p>这里使用公网对时，如果需要内网对时，请自行配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y chrony</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">systemctl start chronyd</span><br></pre></td></tr></table></figure><h2 id="关闭firewalld"><a href="#关闭firewalld" class="headerlink" title="关闭firewalld"></a>关闭firewalld</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清空iptables规则</span></span><br><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br></pre></td></tr></table></figure><h2 id="关闭无用服务"><a href="#关闭无用服务" class="headerlink" title="关闭无用服务"></a>关闭无用服务</h2><blockquote><p>请根据自己的环境针对性地关闭服务</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 禁用蓝牙</span></span><br><span class="line">systemctl disable bluetooth.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果不用NFS可以禁用rpcbind</span></span><br><span class="line">systemctl disable rpcbind.service</span><br><span class="line">systemctl disable rpcbind.socket</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用cockpit网页端管理工具</span></span><br><span class="line">systemctl disable cockpit.socket</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用CUPS打印机服务</span></span><br><span class="line">systemctl disable cups-browsed.service</span><br><span class="line">systemctl disable cups.path           </span><br><span class="line">systemctl disable cups.service        </span><br><span class="line">systemctl disable cups.socket</span><br></pre></td></tr></table></figure><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -ri '/^[^#]*SELINUX=/s#=.+$#=disabled#' /etc/selinux/config</span><br></pre></td></tr></table></figure><h2 id="禁用swap"><a href="#禁用swap" class="headerlink" title="禁用swap"></a>禁用swap</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab</span><br></pre></td></tr></table></figure><h2 id="配置sysctl参数"><a href="#配置sysctl参数" class="headerlink" title="配置sysctl参数"></a>配置<code>sysctl</code>参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-centos.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=5242880</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=5242880</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在CentOS7.4引入了一个新的参数来控制内核的行为。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /proc/sys/fs/may_detach_mounts 默认设置为0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统有容器运行的时候，需要将该值设置为1。</span></span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改动态NAT跟踪记录参数</span></span><br><span class="line">net.netfilter.nf_conntrack_max = 655350</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5120</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定重发 SYN/ACK 的次数</span></span><br><span class="line">net.ipv4.tcp_synack_retries = 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn = 4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许overcommit</span></span><br><span class="line">vm.overcommit_memory = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义了进程能拥有的最多内存区域</span></span><br><span class="line">vm.max_map_count = 65536</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置系统TCP连接keepalive的持续时间，默认7200</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用ipv6</span></span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 让sysctl参数生效</span></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><h2 id="更新软件包"><a href="#更新软件包" class="headerlink" title="更新软件包"></a>更新软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum groups install base -y</span><br><span class="line">yum install epel-release -y</span><br><span class="line">yum install jq nc git redhat-lsb vim ipvsadm tree dstat iotop htop socat ipset conntrack bash-completion-extras -y</span><br></pre></td></tr></table></figure><h2 id="配置开机加载ipvs模块"><a href="#配置开机加载ipvs模块" class="headerlink" title="配置开机加载ipvs模块"></a>配置开机加载ipvs模块</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装docker-ce"><a href="#安装docker-ce" class="headerlink" title="安装docker-ce"></a>安装docker-ce</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除旧版本docker</span></span><br><span class="line">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装docker-ce依赖</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加docker-ce软件源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改docker-ce软件源为阿里云</span></span><br><span class="line">sed -e 's,download.docker.com,mirrors.aliyun.com/docker-ce,g' -i /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装docker-ce 18.09</span></span><br><span class="line">yum install 1:docker-ce-cli-18.09.6-3.el7.x86_64 3:docker-ce-18.09.6-3.el7.x86_64 containerd.io -y</span><br></pre></td></tr></table></figure><h3 id="配置docker-ce"><a href="#配置docker-ce" class="headerlink" title="配置docker-ce"></a>配置docker-ce</h3><ul><li>参考【<a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" target="_blank" rel="noopener">container runtimes</a>】</li></ul><h4 id="CentOS-RHEL-7-4"><a href="#CentOS-RHEL-7-4" class="headerlink" title="CentOS/RHEL 7.4+"></a>CentOS/RHEL 7.4+</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash">/etc/docker/daemon.json&lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["https://dockerhub.azk8s.cn"],</span><br><span class="line">    "insecure-registries": [],</span><br><span class="line">    "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">    "log-driver": "json-file",</span><br><span class="line">    "log-opts": &#123;</span><br><span class="line">        "max-size": "100m"</span><br><span class="line">    &#125;,</span><br><span class="line">    "storage-driver": "overlay2",</span><br><span class="line">    "storage-opts": [</span><br><span class="line">        "overlay2.override_kernel_check=true"</span><br><span class="line">    ],</span><br><span class="line">    "data-root": "/var/lib/docker",</span><br><span class="line">    "max-concurrent-downloads": 10</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="Ubuntu-16-04"><a href="#Ubuntu-16-04" class="headerlink" title="Ubuntu 16.04"></a>Ubuntu 16.04</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash">/etc/docker/daemon.json&lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  "registry-mirrors": ["https://dockerhub.azk8s.cn"],</span><br><span class="line">  "insecure-registries": [],</span><br><span class="line">  "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">  "log-driver": "json-file",</span><br><span class="line">  "log-opts": &#123;</span><br><span class="line">    "max-size": "100m"</span><br><span class="line">  &#125;,</span><br><span class="line">  "storage-driver": "overlay2",</span><br><span class="line">  "data-root": "/var/lib/docker",</span><br><span class="line">  "max-concurrent-downloads": 10</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置docker命令补全"><a href="#配置docker命令补全" class="headerlink" title="配置docker命令补全"></a>配置docker命令补全</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/bash-completion/completions/docker /etc/bash_completion.d/</span><br></pre></td></tr></table></figure><h3 id="配置docker服务开机自启动"><a href="#配置docker服务开机自启动" class="headerlink" title="配置docker服务开机自启动"></a>配置docker服务开机自启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker.service</span><br><span class="line">systemctl start docker.service</span><br></pre></td></tr></table></figure><h3 id="查看docker信息"><a href="#查看docker信息" class="headerlink" title="查看docker信息"></a>查看docker信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure><h3 id="禁用docker源"><a href="#禁用docker源" class="headerlink" title="禁用docker源"></a>禁用docker源</h3><blockquote><p>为避免yum update时更新docker，将docker源禁用</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --disable docker-ce-stable</span><br></pre></td></tr></table></figure><h2 id="确保以最新的内核启动系统"><a href="#确保以最新的内核启动系统" class="headerlink" title="确保以最新的内核启动系统"></a>确保以最新的内核启动系统</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><h1 id="定义集群变量"><a href="#定义集群变量" class="headerlink" title="定义集群变量"></a><strong><font color="red">定义集群变量</font></strong></h1><font color="red"><strong>注意</strong></font><ul><li>这里的变量只对当前会话生效，如果会话断开或者重启服务器，都需要重新定义变量</li><li><code>HostArray</code>定义集群中所有节点的主机名和IP</li><li><code>MasterArray</code>定义master节点的主机名和IP</li><li><code>NodeArray</code>定义node节点的主机名和IP，这里master也运行kubelet所以也需要加入到NodeArray</li><li><code>VIP_IFACE</code>定义keepalived的VIP绑定在哪一个网卡</li><li><code>ETCD_SERVERS</code>以MasterArray的信息生成etcd集群服务器列表</li><li><code>ETCD_INITIAL_CLUSTER</code>以MasterArray信息生成etcd集群初始化列表</li><li><code>POD_DNS_SERVER_IP</code>定义Pod的DNS服务器IP地址</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">declare -A HostArray MasterArray NodeArray</span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明所有节点的信息</span></span><br><span class="line">HostArray=(</span><br><span class="line">   ['k8s-m1']=172.16.80.201</span><br><span class="line">   ['k8s-m2']=172.16.80.202</span><br><span class="line">   ['k8s-m3']=172.16.80.203</span><br><span class="line">   ['k8s-n1']=172.16.80.204</span><br><span class="line">   ['k8s-n2']=172.16.80.205</span><br><span class="line">   )</span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明master节点信息</span></span><br><span class="line">MasterArray=(</span><br><span class="line">    ['k8s-m1']=172.16.80.201</span><br><span class="line">    ['k8s-m2']=172.16.80.202</span><br><span class="line">    ['k8s-m3']=172.16.80.203</span><br><span class="line">    )</span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明node节点信息</span></span><br><span class="line">NodeArray=(</span><br><span class="line">    ['k8s-n1']=172.16.80.204</span><br><span class="line">    ['k8s-n2']=172.16.80.205</span><br><span class="line">    )</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置Kubernetes APIServer的VIP地址</span></span><br><span class="line">VIP="172.16.80.200"</span><br><span class="line">KUBE_APISERVER="https://172.16.80.200:8443"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义集群名字</span></span><br><span class="line">CLUSTER_NAME="kubernetes"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd版本号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubeadm-v1.14.3里面使用的是v3.2.24</span></span><br><span class="line">ETCD_VERSION="v3.2.24"</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubernetes版本号</span></span><br><span class="line">KUBERNETES_VERSION="v1.14.3"</span><br><span class="line"><span class="meta">#</span><span class="bash"> cni-plugin版本号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubernetes YUM源里用的是v0.7.5</span></span><br><span class="line">CNI_PLUGIN_VERSION="v0.7.5"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明VIP所在的网卡名称，以ens33为例</span></span><br><span class="line">VIP_IFACE="ens33"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明etcd_server</span></span><br><span class="line">ETCD_SERVERS=$( xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#^#https://#;s#$#:2379#;$s#\n##' | paste -d, -s - )</span><br><span class="line">ETCD_INITIAL_CLUSTER=$( for i in $&#123;!MasterArray[@]&#125;;do  echo $i=https://$&#123;MasterArray[$i]&#125;:2380; done | sort | paste -d, -s - )</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义POD_CLUSTER_CIDR</span></span><br><span class="line">POD_NET_CIDR="10.244.0.0/16"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义SVC_CLUSTER_CIDR</span></span><br><span class="line">SVC_CLUSTER_CIDR="10.96.0.0/12"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义POD_DNS_SERVER_IP</span></span><br><span class="line">POD_DNS_SERVER_IP="10.96.0.10"</span><br></pre></td></tr></table></figure><h1 id="下载所需软件包"><a href="#下载所需软件包" class="headerlink" title="下载所需软件包"></a>下载所需软件包</h1><h2 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/software</span><br><span class="line">cd /root/software</span><br></pre></td></tr></table></figure><h2 id="下载解压软件包"><a href="#下载解压软件包" class="headerlink" title="下载解压软件包"></a>下载解压软件包</h2><h3 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">echo "--- 下载kubernetes $&#123;KUBERNETES_VERSION&#125; 二进制包 ---"</span><br><span class="line">wget https://dl.k8s.io/$&#123;KUBERNETES_VERSION&#125;/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar xzf kubernetes-server-linux-amd64.tar.gz \</span><br><span class="line">        kubernetes/server/bin/kube-controller-manager \</span><br><span class="line">        kubernetes/server/bin/hyperkube \</span><br><span class="line">        kubernetes/server/bin/mounter \</span><br><span class="line">        kubernetes/server/bin/kubelet \</span><br><span class="line">        kubernetes/server/bin/kubectl \</span><br><span class="line">        kubernetes/server/bin/kube-scheduler \</span><br><span class="line">        kubernetes/server/bin/kube-proxy \</span><br><span class="line">        kubernetes/server/bin/kube-apiserver \</span><br><span class="line">        kubernetes/server/bin/cloud-controller-manager \</span><br><span class="line">        kubernetes/server/bin/kubeadm \</span><br><span class="line">        kubernetes/server/bin/apiextensions-apiserver</span><br><span class="line"></span><br><span class="line">chown -R root:root kubernetes/server/bin/*</span><br><span class="line">chmod 0755 kubernetes/server/bin/*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里需要先拷贝kubectl到/usr/<span class="built_in">local</span>/bin目录下，用于生成kubeconfig文件</span></span><br><span class="line">cp kubernetes/server/bin/kubectl /usr/local/bin/kubectl</span><br></pre></td></tr></table></figure><h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载etcd二进制包</span></span><br><span class="line">echo "--- 下载etcd $&#123;ETCD_VERSION&#125; 二进制包 ---"</span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/$&#123;ETCD_VERSION&#125;/etcd-$&#123;ETCD_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzf etcd-$&#123;ETCD_VERSION&#125;-linux-amd64.tar.gz \</span><br><span class="line">        etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl \</span><br><span class="line">        etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd</span><br><span class="line">chown root:root etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd</span><br><span class="line">chmod 0755 etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd</span><br></pre></td></tr></table></figure><h3 id="CNI-Plugin"><a href="#CNI-Plugin" class="headerlink" title="CNI-Plugin"></a>CNI-Plugin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载CNI-plugin</span></span><br><span class="line">echo "--- 下载cni-plugins $&#123;CNI_PLUGIN_VERSION&#125; 二进制包 ---"</span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/$&#123;CNI_PLUGIN_VERSION&#125;/cni-plugins-amd64-$&#123;CNI_PLUGIN_VERSION&#125;.tgz</span><br><span class="line">mkdir /root/software/cni-plugins</span><br><span class="line">tar xzf cni-plugins-amd64-$&#123;CNI_PLUGIN_VERSION&#125;.tgz -C /root/software/cni-plugins/</span><br></pre></td></tr></table></figure><h1 id="生成集群Certificates"><a href="#生成集群Certificates" class="headerlink" title="生成集群Certificates"></a>生成集群Certificates</h1><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>本次部署，需要为<code>etcd-server</code>、<code>etcd-client</code>、<code>kube-apiserver</code>、<code>kube-controller-manager</code>、<code>kube-scheduler</code>、<code>kube-proxy</code>生成证书。另外还需要生成<code>sa</code>、<code>front-proxy-ca</code>、<code>front-proxy-client</code>证书用于集群的其他功能。</p><ul><li>要注意CA JSON文件的<code>CN(Common Name)</code>与<code>O(Organization)</code>等内容是会影响Kubernetes组件认证的。<ul><li><code>CN</code> Common Name，kube-apiserver会从证书中提取该字段作为请求的用户名（User Name）</li><li><code>O</code> Oragnization，kube-apiserver会从证书中提取该字段作为请求用户的所属组（Group）</li></ul></li><li>CA是自签名根证书，用来给后续各种证书签名</li><li>kubernetes集群的所有状态信息都保存在etcd中，kubernetes组件会通过kube-apiserver读写etcd里面的信息</li><li>etcd如果暴露在公网且没做SSL/TLS验证，那么任何人都能读写数据，那么很可能会无端端在kubernetes集群里面多了挖坑Pod或者肉鸡Pod</li><li>本文使用<code>CFSSL</code>创建证书，证书有效期10年</li><li>建立证书过程在<font color="red" size="3">k8s-m1</font>上完成</li><li>用于生成证书的JSON文件已经打包好在这里<a href=".\二进制部署Kubernetes-v1-14-x高可用集群\pki.zip">pki.zip</a></li></ul><h2 id="下载CFSSL工具"><a href="#下载CFSSL工具" class="headerlink" title="下载CFSSL工具"></a>下载CFSSL工具</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/local/bin/cfssl-certinfo</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/local/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/local/bin/cfssljson</span><br><span class="line">chmod 755 /usr/local/bin/cfssl-certinfo \</span><br><span class="line">          /usr/local/bin/cfssl \</span><br><span class="line">          /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure><h2 id="创建工作目录-1"><a href="#创建工作目录-1" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/pki /root/master /root/node</span><br><span class="line">cd /root/pki</span><br></pre></td></tr></table></figure><h2 id="创建用于生成证书的json文件"><a href="#创建用于生成证书的json文件" class="headerlink" title="创建用于生成证书的json文件"></a>创建用于生成证书的json文件</h2><h3 id="ca-config-json"><a href="#ca-config-json" class="headerlink" title="ca-config.json"></a>ca-config.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "signing": &#123;</span><br><span class="line">    "default": &#123;</span><br><span class="line">      "expiry": "87600h"</span><br><span class="line">    &#125;,</span><br><span class="line">    "profiles": &#123;</span><br><span class="line">      "kubernetes": &#123;</span><br><span class="line">        "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ],</span><br><span class="line">        "expiry": "87600h"</span><br><span class="line">      &#125;,</span><br><span class="line">      "etcd-server": &#123;</span><br><span class="line">        "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ],</span><br><span class="line">        "expiry": "87600h"</span><br><span class="line">      &#125;,</span><br><span class="line">      "etcd-client": &#123;</span><br><span class="line">          "usages": [</span><br><span class="line">              "signing",</span><br><span class="line">              "key encipherment",</span><br><span class="line">              "client auth"</span><br><span class="line">          ],</span><br><span class="line">          "expiry": "87600h"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="ca-csr-json"><a href="#ca-csr-json" class="headerlink" title="ca-csr.json"></a>ca-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="etcd-ca-csr-json"><a href="#etcd-ca-csr-json" class="headerlink" title="etcd-ca-csr.json"></a>etcd-ca-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="etcd-server-csr-json"><a href="#etcd-server-csr-json" class="headerlink" title="etcd-server-csr.json"></a>etcd-server-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-server-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd-server",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="etcd-client-csr-json"><a href="#etcd-client-csr-json" class="headerlink" title="etcd-client-csr.json"></a>etcd-client-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd-client",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "hosts": [</span><br><span class="line">    ""</span><br><span class="line">  ],</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-apiserver-csr-json"><a href="#kube-apiserver-csr-json" class="headerlink" title="kube-apiserver-csr.json"></a>kube-apiserver-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kube-apiserver",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-manager-csr-json"><a href="#kube-manager-csr-json" class="headerlink" title="kube-manager-csr.json"></a>kube-manager-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-controller-manager",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-controller-manager",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-scheduler-csr-json"><a href="#kube-scheduler-csr-json" class="headerlink" title="kube-scheduler-csr.json"></a>kube-scheduler-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-scheduler",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-scheduler",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-proxy-csr-json"><a href="#kube-proxy-csr-json" class="headerlink" title="kube-proxy-csr.json"></a>kube-proxy-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-proxy",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-proxy",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-admin-csr-json"><a href="#kube-admin-csr-json" class="headerlink" title="kube-admin-csr.json"></a>kube-admin-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "admin",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:masters",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="front-proxy-ca-csr-json"><a href="#front-proxy-ca-csr-json" class="headerlink" title="front-proxy-ca-csr.json"></a>front-proxy-ca-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="front-proxy-client-csr-json"><a href="#front-proxy-client-csr-json" class="headerlink" title="front-proxy-client-csr.json"></a>front-proxy-client-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "front-proxy-client",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="sa-csr-json"><a href="#sa-csr-json" class="headerlink" title="sa-csr.json"></a>sa-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; sa-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "service-accounts",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="创建etcd证书"><a href="#创建etcd证书" class="headerlink" title="创建etcd证书"></a>创建etcd证书</h2><h3 id="etcd-ca证书"><a href="#etcd-ca证书" class="headerlink" title="etcd-ca证书"></a>etcd-ca证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建etcd-ca证书 ---'</span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca</span><br></pre></td></tr></table></figure><h3 id="etcd-server证书"><a href="#etcd-server证书" class="headerlink" title="etcd-server证书"></a>etcd-server证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建etcd-server证书 ---'</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=etcd-ca.pem \</span><br><span class="line">      -ca-key=etcd-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -hostname=127.0.0.1,$(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort  | paste -d, -s -) \</span><br><span class="line">      -profile=etcd-server etcd-server-csr.json | cfssljson -bare etcd-server</span><br></pre></td></tr></table></figure><h3 id="etcd-client证书"><a href="#etcd-client证书" class="headerlink" title="etcd-client证书"></a>etcd-client证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建etcd-client证书 ---'</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=etcd-ca.pem \</span><br><span class="line">      -ca-key=etcd-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=etcd-client etcd-client-csr.json | cfssljson -bare etcd-client</span><br></pre></td></tr></table></figure><h2 id="创建kubernetes证书"><a href="#创建kubernetes证书" class="headerlink" title="创建kubernetes证书"></a>创建kubernetes证书</h2><h3 id="kubernetes-CA-证书"><a href="#kubernetes-CA-证书" class="headerlink" title="kubernetes-CA 证书"></a>kubernetes-CA 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kubernetes-ca证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kubernetes-ca证书</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare kube-ca</span><br></pre></td></tr></table></figure><h3 id="kube-apiserver证书"><a href="#kube-apiserver证书" class="headerlink" title="kube-apiserver证书"></a>kube-apiserver证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-apiserver证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-apiserver证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的hostname字段中的10.96.0.1要跟上文提到的service cluster ip cidr对应</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -hostname=10.96.0.1,127.0.0.1,localhost,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,$&#123;VIP&#125;,$(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort  | paste -d, -s -) \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br></pre></td></tr></table></figure><h3 id="kube-controller-manager证书"><a href="#kube-controller-manager证书" class="headerlink" title="kube-controller-manager证书"></a>kube-controller-manager证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-controller-manager证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-controller-manager证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure><h3 id="kube-scheduler证书"><a href="#kube-scheduler证书" class="headerlink" title="kube-scheduler证书"></a>kube-scheduler证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-scheduler证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-scheduler证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure><h3 id="kube-proxy证书"><a href="#kube-proxy证书" class="headerlink" title="kube-proxy证书"></a>kube-proxy证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-proxy证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-proxy证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure><h3 id="kube-admin证书"><a href="#kube-admin证书" class="headerlink" title="kube-admin证书"></a>kube-admin证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-admin证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-admin证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-admin-csr.json | cfssljson -bare kube-admin</span><br></pre></td></tr></table></figure><h3 id="Front-Proxy证书"><a href="#Front-Proxy证书" class="headerlink" title="Front Proxy证书"></a>Front Proxy证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建Front Proxy Certificate证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建Front Proxy Certificate证书</span></span><br><span class="line">cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=front-proxy-ca.pem \</span><br><span class="line">      -ca-key=front-proxy-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br></pre></td></tr></table></figure><h3 id="Service-Account证书"><a href="#Service-Account证书" class="headerlink" title="Service Account证书"></a>Service Account证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建service account证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建创建service account证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      sa-csr.json | cfssljson -bare sa</span><br></pre></td></tr></table></figure><h3 id="bootstrap-token"><a href="#bootstrap-token" class="headerlink" title="bootstrap-token"></a>bootstrap-token</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 生成 Bootstrap Token</span></span><br><span class="line">BOOTSTRAP_TOKEN_ID=$(head -c 6 /dev/urandom | md5sum | head -c 6)</span><br><span class="line">BOOTSTRAP_TOKEN_SECRET=$(head -c 16 /dev/urandom | md5sum | head -c 16)</span><br><span class="line">BOOTSTRAP_TOKEN="$&#123;BOOTSTRAP_TOKEN_ID&#125;.$&#123;BOOTSTRAP_TOKEN_SECRET&#125;"</span><br><span class="line">echo "Bootstrap Token: $&#123;BOOTSTRAP_TOKEN&#125;"</span><br></pre></td></tr></table></figure><h3 id="encryption-yaml"><a href="#encryption-yaml" class="headerlink" title="encryption.yaml"></a>encryption.yaml</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ENCRYPTION_TOKEN=$(head -c 32 /dev/urandom | base64)</span><br><span class="line">echo "ENCRYPTION_TOKEN: $&#123;ENCRYPTION_TOKEN&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建encryption.yaml文件</span></span><br><span class="line">cat &gt; encryption.yaml &lt;&lt;EOF</span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: $&#123;ENCRYPTION_TOKEN&#125;</span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="audit-policy-yaml"><a href="#audit-policy-yaml" class="headerlink" title="audit-policy.yaml"></a>audit-policy.yaml</h3><blockquote><p>这里使用最低限度的审计策略文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建创建高级审计配置 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建高级审计配置</span></span><br><span class="line">cat &gt;&gt; audit-policy.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><ul><li>kubeconfig 文件用于组织关于集群、用户、命名空间和认证机制的信息。</li><li>命令行工具 <code>kubectl</code> 从 kubeconfig 文件中得到它要选择的集群以及跟集群 API server 交互的信息。</li><li>默认情况下，<code>kubectl</code> 会从 <code>$HOME/.kube</code> 目录下查找文件名为 <code>config</code> 的文件。</li></ul><blockquote><p><strong>注意：</strong> 用于配置集群访问信息的文件叫作 <code>kubeconfig文件</code>，这是一种引用配置文件的通用方式，并不是说它的文件名就是 <code>kubeconfig</code>。</p></blockquote><h3 id="Components-kubeconfig"><a href="#Components-kubeconfig" class="headerlink" title="Components kubeconfig"></a>Components kubeconfig</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">for TARGET in kube-controller-manager kube-scheduler kube-admin; do</span><br><span class="line">    kubectl config set-cluster kubernetes \</span><br><span class="line">        --certificate-authority=kube-ca.pem \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">        --kubeconfig=$&#123;TARGET&#125;.kubeconfig</span><br><span class="line">    kubectl config set-credentials system:$&#123;TARGET&#125; \</span><br><span class="line">        --client-certificate=$&#123;TARGET&#125;.pem \</span><br><span class="line">        --client-key=$&#123;TARGET&#125;-key.pem \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --kubeconfig=$&#123;TARGET&#125;.kubeconfig</span><br><span class="line">    kubectl config set-context default \</span><br><span class="line">        --cluster=kubernetes \</span><br><span class="line">        --user=system:$&#123;TARGET&#125; \</span><br><span class="line">        --kubeconfig=$&#123;TARGET&#125;.kubeconfig</span><br><span class="line">    kubectl config use-context default --kubeconfig=$&#123;TARGET&#125;.kubeconfig</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="Bootstrap-kubeconfig"><a href="#Bootstrap-kubeconfig" class="headerlink" title="Bootstrap kubeconfig"></a>Bootstrap kubeconfig</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></span><br><span class="line">kubectl config set-context kubelet-bootstrap \</span><br><span class="line">  --cluster=$&#123;CLUSTER_NAME&#125; \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置当前使用的上下文</span></span><br><span class="line">kubectl config use-context kubelet-bootstrap --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="清理证书CSR文件"><a href="#清理证书CSR文件" class="headerlink" title="清理证书CSR文件"></a>清理证书CSR文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 删除*.csr文件 ---'</span><br><span class="line">rm -rf *csr</span><br></pre></td></tr></table></figure><h2 id="修改文件权限"><a href="#修改文件权限" class="headerlink" title="修改文件权限"></a>修改文件权限</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown root:root *pem *kubeconfig *yaml</span><br><span class="line">chmod 0444 *pem *kubeconfig *yaml</span><br><span class="line">chmod 0400 *key.pem</span><br></pre></td></tr></table></figure><h1 id="Etcd-Cluster"><a href="#Etcd-Cluster" class="headerlink" title="Etcd Cluster"></a>Etcd Cluster</h1><h2 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h2><ul><li>Kubernetes集群数据需要存放在etcd中</li><li>etcd集群部署在master节点上</li><li>部署三节点的etcd cluster</li><li>etcd集群启用基于TLS的客户端身份验证+集群节点身份认证</li></ul><h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><h3 id="查看集群部署的环境变量"><a href="#查看集群部署的环境变量" class="headerlink" title="查看集群部署的环境变量"></a>查看集群部署的环境变量</h3><blockquote><p>这里主要检查上面集群变量定义的时候，是否有遗漏或者不正确</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo "ETCD_SERVERS=$&#123;ETCD_SERVERS&#125;"</span><br><span class="line">echo "ETCD_INITIAL_CLUSTER=$&#123;ETCD_INITIAL_CLUSTER&#125;"</span><br></pre></td></tr></table></figure><h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><blockquote><p>etcd以普通用户运行</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo '--- master节点添加etcd用户 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/sbin/useradd -r -s /bin/false etcd</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">echo '--- master节点创建目录 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    echo "--- 创建目录 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/bin/mkdir -p /etc/etcd/ssl \</span><br><span class="line">                                  /var/lib/etcd</span><br><span class="line">    echo "--- 修改目录权限 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/bin/chmod 0755 /etc/etcd \</span><br><span class="line">                                    /etc/etcd/ssl \</span><br><span class="line">                                    /var/lib/etcd</span><br><span class="line">    echo "--- 修改目录属组 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; chown -R etcd:etcd /etc/etcd/ /var/lib/etcd</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="创建工作目录-2"><a href="#创建工作目录-2" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/master</span><br></pre></td></tr></table></figure><h3 id="切换工作目录"><a href="#切换工作目录" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/master</span><br></pre></td></tr></table></figure><h2 id="部署etcd"><a href="#部署etcd" class="headerlink" title="部署etcd"></a>部署etcd</h2><h3 id="创建systemd服务脚本"><a href="#创建systemd服务脚本" class="headerlink" title="创建systemd服务脚本"></a>创建systemd服务脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=etcd</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yaml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建etcd配置模板"><a href="#创建etcd配置模板" class="headerlink" title="创建etcd配置模板"></a>创建etcd配置模板</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd.config.yaml.example &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> This is the configuration file <span class="keyword">for</span> the etcd server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Human-readable name <span class="keyword">for</span> this member.</span></span><br><span class="line">name: '&#123;HOSTNAME&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Path to the data directory.</span></span><br><span class="line">data-dir: '/var/lib/etcd/&#123;HOSTNAME&#125;.data/'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Path to the dedicated wal directory.</span></span><br><span class="line">wal-dir: '/var/lib/etcd/&#123;HOSTNAME&#125;.wal/'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line">snapshot-count: 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) of a heartbeat interval.</span></span><br><span class="line">heartbeat-interval: 100</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> an election to timeout.</span></span><br><span class="line">election-timeout: 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default quota.</span></span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of comma separated URLs to listen on <span class="keyword">for</span> peer traffic.</span></span><br><span class="line">listen-peer-urls: 'https://&#123;PUBLIC_IP&#125;:2380'</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of comma separated URLs to listen on <span class="keyword">for</span> client traffic.</span></span><br><span class="line">listen-client-urls: 'https://&#123;PUBLIC_IP&#125;:2379,http://127.0.0.1:2379'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line">max-snapshots: 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line">max-wals: 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> Comma-separated white list of origins <span class="keyword">for</span> CORS (cross-origin resource sharing).</span></span><br><span class="line">cors:</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of this member<span class="string">'s peer URLs to advertise to the rest of the cluster.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The URLs needed to be a comma-separated list.</span></span><br><span class="line">initial-advertise-peer-urls: 'https://&#123;PUBLIC_IP&#125;:2380'</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of this member<span class="string">'s client URLs to advertise to the public.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The URLs needed to be a comma-separated list.</span></span><br><span class="line">advertise-client-urls: 'https://&#123;PUBLIC_IP&#125;:2379'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Discovery URL used to bootstrap the cluster.</span></span><br><span class="line">discovery:</span><br><span class="line"><span class="meta">#</span><span class="bash"> Valid values include <span class="string">'exit'</span>, <span class="string">'proxy'</span></span></span><br><span class="line">discovery-fallback: 'proxy'</span><br><span class="line"><span class="meta">#</span><span class="bash"> HTTP proxy to use <span class="keyword">for</span> traffic to discovery service.</span></span><br><span class="line">discovery-proxy:</span><br><span class="line"><span class="meta">#</span><span class="bash"> DNS domain used to bootstrap initial cluster.</span></span><br><span class="line">discovery-srv:</span><br><span class="line"><span class="meta">#</span><span class="bash"> Initial cluster configuration <span class="keyword">for</span> bootstrapping.</span></span><br><span class="line">initial-cluster: '$&#123;ETCD_INITIAL_CLUSTER&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Initial cluster token <span class="keyword">for</span> the etcd cluster during bootstrap.</span></span><br><span class="line">initial-cluster-token: 'etcd-k8s-cluster'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Initial cluster state (<span class="string">'new'</span> or <span class="string">'existing'</span>).</span></span><br><span class="line">initial-cluster-state: 'new'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line">strict-reconfig-check: false</span><br><span class="line"><span class="meta">#</span><span class="bash"> Accept etcd V2 client requests</span></span><br><span class="line">enable-v2: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> Enable runtime profiling data via HTTP server</span></span><br><span class="line">enable-pprof: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> Valid values include <span class="string">'on'</span>, <span class="string">'readonly'</span>, <span class="string">'off'</span></span></span><br><span class="line">proxy: 'off'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) an endpoint will be held <span class="keyword">in</span> a failed state.</span></span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) of the endpoints refresh interval.</span></span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> a dial to timeout.</span></span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> a write to timeout.</span></span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> a <span class="built_in">read</span> to timeout.</span></span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the client server TLS cert file.</span></span><br><span class="line">  cert-file: '/etc/etcd/ssl/etcd-server.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the client server TLS key file.</span></span><br><span class="line">  key-file: '/etc/etcd/ssl/etcd-server-key.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Enable client cert authentication.</span></span><br><span class="line">  client-cert-auth: true</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the client server TLS trusted CA cert file.</span></span><br><span class="line">  trusted-ca-file: '/etc/etcd/ssl/etcd-ca.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Client TLS using generated certificates</span></span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the peer server TLS cert file.</span></span><br><span class="line">  cert-file: '/etc/etcd/ssl/etcd-server.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the peer server TLS key file.</span></span><br><span class="line">  key-file: '/etc/etcd/ssl/etcd-server-key.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Enable peer client cert authentication.</span></span><br><span class="line">  client-cert-auth: true</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line">  trusted-ca-file: '/etc/etcd/ssl/etcd-ca.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Peer TLS using generated certificates.</span></span><br><span class="line">  auto-tls: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> Enable debug-level logging <span class="keyword">for</span> etcd.</span></span><br><span class="line">debug: false</span><br><span class="line">logger: 'zap'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify <span class="string">'stdout'</span> or <span class="string">'stderr'</span> to skip journald logging even when running under systemd.</span></span><br><span class="line">log-outputs: [default]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Force to create a new one member cluster.</span></span><br><span class="line">force-new-cluster: false</span><br><span class="line">auto-compaction-mode: 'periodic'</span><br><span class="line">auto-compaction-retention: 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> Set level of detail <span class="keyword">for</span> exported metrics, specify <span class="string">'extensive'</span> to include histogram metrics.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default is <span class="string">'basic'</span></span></span><br><span class="line">metrics: 'extensive'</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="分发etcd集群文件"><a href="#分发etcd集群文件" class="headerlink" title="分发etcd集群文件"></a>分发etcd集群文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">    echo "--- 分发etcd二进制文件 ---"</span><br><span class="line">    rsync -avpt /root/software/etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl \</span><br><span class="line">                /root/software/etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd \</span><br><span class="line">                $&#123;NODE&#125;:/usr/local/bin/</span><br><span class="line">    echo '---- 分发etcd证书 ----'</span><br><span class="line">    rsync -avpt /root/pki/etcd-ca-key.pem \</span><br><span class="line">                /root/pki/etcd-ca.pem \</span><br><span class="line">                /root/pki/etcd-client-key.pem \</span><br><span class="line">                /root/pki/etcd-client.pem \</span><br><span class="line">                /root/pki/etcd-server-key.pem \</span><br><span class="line">                /root/pki/etcd-server.pem \</span><br><span class="line">                $&#123;NODE&#125;:/etc/etcd/ssl/</span><br><span class="line">    echo '---- 创建etcd服务脚本 ----'</span><br><span class="line">    sed -e "s/&#123;HOSTNAME&#125;/$&#123;NODE&#125;/g" \</span><br><span class="line">        -e "s/&#123;PUBLIC_IP&#125;/$&#123;MasterArray[$NODE]&#125;/g" \</span><br><span class="line">        etcd.config.yaml.example &gt; etcd.config.yaml.$&#123;NODE&#125;</span><br><span class="line">    echo '---- 分发etcd服务脚本 ----'</span><br><span class="line">    rsync -avpt etcd.config.yaml.$&#123;NODE&#125; $&#123;NODE&#125;:/etc/etcd/etcd.config.yaml</span><br><span class="line">    rsync -avpt etcd.service $&#123;NODE&#125;:/usr/lib/systemd/system/etcd.service</span><br><span class="line">    ssh $&#123;NODE&#125; "chown -R etcd:etcd /etc/etcd &amp;&amp; systemctl daemon-reload"</span><br><span class="line">    # 清理配置文件</span><br><span class="line">    rm -rf etcd.config.yaml.$&#123;NODE&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="启动etcd-cluster"><a href="#启动etcd-cluster" class="headerlink" title="启动etcd cluster"></a>启动etcd cluster</h2><ul><li>etcd 进程首次启动时会等待其它节点的 etcd 加入集群，命令 systemctl start etcd 会卡住一段时间，为正常现象</li><li>启动之后可以通过<code>etcdctl</code>命令查看集群状态</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $&#123;NODE&#125; systemctl enable etcd.service</span><br><span class="line">    ssh $&#123;NODE&#125; systemctl start etcd.service &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><ul><li>为方便维护，可使用alias简化etcdctl命令</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /root/.bashrc &lt;&lt;EOF</span><br><span class="line">alias etcdctl2="export ETCDCTL_API=2;etcdctl --ca-file '/etc/etcd/ssl/etcd-ca.pem' --cert-file '/etc/etcd/ssl/etcd-client.pem' --key-file '/etc/etcd/ssl/etcd-client-key.pem' --endpoints $&#123;ETCD_SERVERS&#125;"</span><br><span class="line">alias etcdctl3="export ETCDCTL_API=3;etcdctl --cacert=/etc/etcd/ssl/etcd-ca.pem --cert=/etc/etcd/ssl/etcd-client.pem --key=/etc/etcd/ssl/etcd-client-key.pem --endpoints=$&#123;ETCD_SERVERS&#125;"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="验证etcd集群状态"><a href="#验证etcd集群状态" class="headerlink" title="验证etcd集群状态"></a>验证etcd集群状态</h2><ul><li>etcd提供v2和v3两套API</li><li>kubernetes使用的是etcd v3 API</li></ul><h3 id="应用环境变量"><a href="#应用环境变量" class="headerlink" title="应用环境变量"></a>应用环境变量</h3><blockquote><p>应用上面定义的alias</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /root/.bashrc</span><br></pre></td></tr></table></figure><h3 id="使用v2-API访问集群"><a href="#使用v2-API访问集群" class="headerlink" title="使用v2 API访问集群"></a>使用v2 API访问集群</h3><h4 id="获取集群状态"><a href="#获取集群状态" class="headerlink" title="获取集群状态"></a>获取集群状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl2 cluster-health</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">member 222fd3b0bb4a5931 is healthy: got healthy result from https://172.16.80.203:2379</span><br><span class="line">member 8349ef180b115a83 is healthy: got healthy result from https://172.16.80.201:2379</span><br><span class="line">member f525d2d797a7c465 is healthy: got healthy result from https://172.16.80.202:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure><h4 id="获取成员列表"><a href="#获取成员列表" class="headerlink" title="获取成员列表"></a>获取成员列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl2 member list</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">222fd3b0bb4a5931: name=k8s-m3 peerURLs=https://172.16.80.203:2380 clientURLs=https://172.16.80.203:2379 isLeader=false</span><br><span class="line">8349ef180b115a83: name=k8s-m1 peerURLs=https://172.16.80.201:2380 clientURLs=https://172.16.80.201:2379 isLeader=false</span><br><span class="line">f525d2d797a7c465: name=k8s-m2 peerURLs=https://172.16.80.202:2380 clientURLs=https://172.16.80.202:2379 isLeader=true</span><br></pre></td></tr></table></figure><h3 id="使用v3-API访问集群"><a href="#使用v3-API访问集群" class="headerlink" title="使用v3 API访问集群"></a>使用v3 API访问集群</h3><h4 id="获取集群endpoint状态"><a href="#获取集群endpoint状态" class="headerlink" title="获取集群endpoint状态"></a>获取集群endpoint状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl3 endpoint health</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://172.16.80.201:2379 is healthy: successfully committed proposal: took = 2.879402ms</span><br><span class="line">https://172.16.80.203:2379 is healthy: successfully committed proposal: took = 6.708566ms</span><br><span class="line">https://172.16.80.202:2379 is healthy: successfully committed proposal: took = 7.187607ms</span><br></pre></td></tr></table></figure><h4 id="获取集群成员列表"><a href="#获取集群成员列表" class="headerlink" title="获取集群成员列表"></a>获取集群成员列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl3 member list --write-out=table</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------------+---------+--------+----------------------------+----------------------------+</span><br><span class="line">|        ID        | STATUS  |  NAME  |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+</span><br><span class="line">| 222fd3b0bb4a5931 | started | k8s-m3 | https://172.16.80.203:2380 | https://172.16.80.203:2379 |</span><br><span class="line">| 8349ef180b115a83 | started | k8s-m1 | https://172.16.80.201:2380 | https://172.16.80.201:2379 |</span><br><span class="line">| f525d2d797a7c465 | started | k8s-m2 | https://172.16.80.202:2380 | https://172.16.80.202:2379 |</span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure><h2 id="配置定时备份脚本"><a href="#配置定时备份脚本" class="headerlink" title="配置定时备份脚本"></a>配置定时备份脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">TIME=$(date +%Y%m%d)</span><br><span class="line">HOUR=$(date +%H)</span><br><span class="line">BASE_DIR="/path/to/etcd_backup"</span><br><span class="line">BACKUP_DIR="$&#123;BASE_DIR&#125;/$&#123;TIME&#125;"</span><br><span class="line">mkdir -p $BACKUP_DIR</span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">/usr/local/bin/etcdctl \</span><br><span class="line">    --cacert=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd-client.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-client-key.pem \</span><br><span class="line">    --endpoints=https://172.16.80.201:2379,https://172.16.80.201:2379,https://172.16.80.201:2379 \</span><br><span class="line">    snapshot save $BACKUP_DIR/etcd-snapshot-$&#123;HOUR&#125;.db</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清理15天前的etcd备份</span></span><br><span class="line">find $&#123;BASE_DIR&#125; -type d -mtime +15 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><h1 id="Kubernetes-Masters"><a href="#Kubernetes-Masters" class="headerlink" title="Kubernetes Masters"></a>Kubernetes Masters</h1><h2 id="Keepalived和HAProxy"><a href="#Keepalived和HAProxy" class="headerlink" title="Keepalived和HAProxy"></a>Keepalived和HAProxy</h2><h3 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h3><h4 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h4><ul><li>提供多个 API Server 的负载均衡(Load Balance)</li><li>监听VIP的<code>8443</code>端口负载均衡到三台master节点的<code>6443</code>端口</li></ul><h4 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a>Keepalived</h4><ul><li>提供虚拟IP位址(VIP),来让vip落在可用的master主机上供所有组件访问master节点</li><li>提供健康检查脚本用于切换VIP</li></ul><h3 id="切换工作目录-1"><a href="#切换工作目录-1" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/master</span><br></pre></td></tr></table></figure><h3 id="安装Keepalived和HAProxy"><a href="#安装Keepalived和HAProxy" class="headerlink" title="安装Keepalived和HAProxy"></a>安装Keepalived和HAProxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">    echo "---- 安装haproxy和keepalived ----"</span><br><span class="line">    ssh $NODE yum install keepalived haproxy -y</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="Keepalived-1"><a href="#Keepalived-1" class="headerlink" title="Keepalived"></a>Keepalived</h3><h4 id="创建配置模板"><a href="#创建配置模板" class="headerlink" title="创建配置模板"></a>创建配置模板</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; keepalived.conf.example &lt;&lt;EOF</span><br><span class="line">vrrp_script haproxy-check &#123;</span><br><span class="line">    script "/bin/bash /etc/keepalived/check_haproxy.sh"</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance haproxy-vip &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 101</span><br><span class="line">    interface &#123;&#123; VIP_IFACE &#125;&#125;</span><br><span class="line">    virtual_router_id 47</span><br><span class="line">    advert_int 3</span><br><span class="line"></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        &#123;&#123; VIP &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        haproxy-check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="生成配置文件"><a href="#生成配置文件" class="headerlink" title="生成配置文件"></a>生成配置文件</h4><blockquote><p>通过集群变量替换配置模板的字符串，然后重定向到新的配置文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sed -r -e "s#\&#123;\&#123; VIP \&#125;\&#125;#$&#123;VIP&#125;#" \</span><br><span class="line">       -e "s#\&#123;\&#123; VIP_IFACE \&#125;\&#125;#$&#123;VIP_IFACE&#125;#" \</span><br><span class="line">       -e '/unicast_peer/r '&lt;(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#^#\t#') \</span><br><span class="line">       keepalived.conf.example &gt; keepalived.conf</span><br></pre></td></tr></table></figure><h4 id="创建keepalived服务检查脚本"><a href="#创建keepalived服务检查脚本" class="headerlink" title="创建keepalived服务检查脚本"></a>创建keepalived服务检查脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; check_haproxy.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">VIRTUAL_IP=$&#123;VIP&#125;</span><br><span class="line"></span><br><span class="line">errorExit() &#123;</span><br><span class="line">    echo "*** $*" 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ip addr | grep -q \$VIRTUAL_IP ; then</span><br><span class="line">    curl -s --max-time 2 --insecure https://\$&#123;VIRTUAL_IP&#125;:8443/ -o /dev/null || errorExit "Error GET https://\$&#123;VIRTUAL_IP&#125;:8443/"</span><br><span class="line">fi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="HAproxy"><a href="#HAproxy" class="headerlink" title="HAproxy"></a>HAproxy</h3><h4 id="创建配置模板-1"><a href="#创建配置模板-1" class="headerlink" title="创建配置模板"></a>创建配置模板</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; haproxy.cfg.example &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  ulimit-n  16384</span><br><span class="line">  log  127.0.0.1 local0 err</span><br><span class="line">  stats timeout 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  log global</span><br><span class="line">  mode  http</span><br><span class="line">  option  httplog</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  timeout http-request 15s</span><br><span class="line">  timeout http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">frontend monitor-in</span><br><span class="line">  bind $&#123;VIP&#125;:33305</span><br><span class="line">  mode http</span><br><span class="line">  option httplog</span><br><span class="line">  monitor-uri /monitor</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">  bind    $&#123;VIP&#125;:8006</span><br><span class="line">  mode    http</span><br><span class="line">  stats   enable</span><br><span class="line">  stats   hide-version</span><br><span class="line">  stats   uri       /stats</span><br><span class="line">  stats   refresh   30s</span><br><span class="line">  stats   realm     Haproxy\ Statistics</span><br><span class="line">  stats   auth      admin:admin</span><br><span class="line"></span><br><span class="line">frontend k8s-api</span><br><span class="line">  bind $&#123;VIP&#125;:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-api</span><br><span class="line"></span><br><span class="line">backend k8s-api</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="生成配置文件-1"><a href="#生成配置文件-1" class="headerlink" title="生成配置文件"></a>生成配置文件</h4><blockquote><p>通过集群变量替换配置模板的字符串，然后重定向到新的配置文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e '$r '&lt;(paste &lt;( seq -f'  server k8s-api-%g'  $&#123;#MasterArray[@]&#125; ) &lt;( xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#$#:6443  check#')) haproxy.cfg.example &gt; haproxy.cfg</span><br></pre></td></tr></table></figure><h3 id="分发配置文件"><a href="#分发配置文件" class="headerlink" title="分发配置文件"></a>分发配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">rsync -avpt haproxy.cfg $NODE:/etc/haproxy/</span><br><span class="line">rsync -avpt keepalived.conf \</span><br><span class="line">            check_haproxy.sh \</span><br><span class="line">            $NODE:/etc/keepalived/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="启动keepalived和HAProxy服务"><a href="#启动keepalived和HAProxy服务" class="headerlink" title="启动keepalived和HAProxy服务"></a>启动keepalived和HAProxy服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">ssh $NODE systemctl enable --now keepalived.service haproxy.service</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="验证服务状态"><a href="#验证服务状态" class="headerlink" title="验证服务状态"></a>验证服务状态</h3><ul><li>需要大约十秒的时间等待keepalived和haproxy服务起来</li><li>这里由于后端的kube-apiserver服务还没启动，只测试是否能ping通VIP</li><li>如果VIP没起来，就要去确认一下各master节点的keepalived服务是否正常</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sleep 15 &amp;&amp; ping -c 4 $VIP</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-Master服务"><a href="#Kubernetes-Master服务" class="headerlink" title="Kubernetes Master服务"></a>Kubernetes Master服务</h2><h3 id="切换工作目录-2"><a href="#切换工作目录-2" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/master</span><br></pre></td></tr></table></figure><h3 id="添加用户-1"><a href="#添加用户-1" class="headerlink" title="添加用户"></a>添加用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo '--- master节点添加用户 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/sbin/useradd -r -s /bin/false kube</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="创建程序运行目录"><a href="#创建程序运行目录" class="headerlink" title="创建程序运行目录"></a>创建程序运行目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">echo '--- master节点创建目录 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    echo "--- 创建目录 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/bin/mkdir -p /etc/kubernetes \</span><br><span class="line">                                  /etc/kubernetes/pki \</span><br><span class="line">                                  /etc/kubernetes/manifests \</span><br><span class="line">                                  /var/run/kubernetes \</span><br><span class="line">                                  /var/log/kube-audit</span><br><span class="line">    echo "--- 修改目录权限 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/bin/chmod 0755 /etc/kubernetes \</span><br><span class="line">                                    /etc/kubernetes/pki \</span><br><span class="line">                                    /etc/kubernetes/manifests \</span><br><span class="line">                                    /var/log/kube-audit \</span><br><span class="line">                                    /var/run/kubernetes</span><br><span class="line">    echo "--- 修改目录属组 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; chown -R kube:kube /etc/kubernetes \</span><br><span class="line">                                   /etc/kubernetes/pki \</span><br><span class="line">                                   /etc/kubernetes/manifests \</span><br><span class="line">                                   /var/run/kubernetes \</span><br><span class="line">                                   /var/log/kube-audit</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h3><h4 id="说明-4"><a href="#说明-4" class="headerlink" title="说明"></a>说明</h4><ul><li>以 REST APIs 提供 Kubernetes 资源的 CRUD,如授权、认证、存取控制与 API 注册等机制。</li><li>关闭默认非安全端口8080,在安全端口 6443 接收 https 请求</li><li>严格的认证和授权策略 (x509、token、RBAC)</li><li>开启 bootstrap token 认证，支持 kubelet TLS bootstrapping</li><li>使用 https 访问 kubelet、etcd，加密通信</li></ul><h4 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h4><ul><li><p><code>--allow-privileged=true</code>启用容器特权模式</p></li><li><p><code>--apiserver-count=3</code>指定集群运行模式，其它节点处于阻塞状态</p></li><li><p><code>--audit-policy-file=/etc/kubernetes/audit-policy.yaml</code> 基于audit-policy.yaml文件定义的内容启动审计功能</p></li><li><p><code>--authorization-mode=Node,RBAC</code>开启 Node 和 RBAC 授权模式，拒绝未授权的请求</p></li><li><p><code>--disable-admission-plugins=</code>和<code>--enable-admission-plugins</code>禁用和启用准入控制插件。</p><p>准入控制插件会在请求通过认证和授权之后、对象被持久化之前拦截到达apiserver的请求。</p><p>准入控制插件依次执行，因此需要注意顺序。</p><p>如果插件序列中任何一个拒绝了请求，则整个请求将立刻被拒绝并返回错误给客户端。</p><p>关于admission-plugins官方文档里面有推荐配置，这里直接采用官方配置。</p><p>注意针对不同kubernetes版本都会有不一样的配置，具体可以看<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#is-there-a-recommended-set-of-admission-controllers-to-use" target="_blank" rel="noopener">这里</a>。</p><p>官方说明： For Kubernetes version 1.10 and later, the recommended admission controllers are enabled by default.</p></li><li><p><code>--enable-bootstrap-token-auth=true</code>启用 kubelet bootstrap 的 token 认证</p></li><li><p><code>--experimental-encryption-provider-config=/etc/kubernetes/encryption.yaml</code>启用加密特性将Secret数据加密存储到etcd</p></li><li><p><code>--insecure-port=0</code>关闭监听非安全端口8080</p></li><li><p><code>--runtime-config=api/all=true</code>启用所有版本的 APIs</p></li><li><p><code>--service-cluster-ip-range=10.96.0.0/12</code>指定 Service Cluster IP 地址段</p></li><li><p><code>--service-node-port-range=30000-32767</code>指定 NodePort 的端口范围</p></li><li><p><code>--target-ram-mb</code>配置缓存大小，参考值为<code>节点数*60</code></p></li><li><p><code>--event-ttl</code>配置kubernets events的保留时间，默认<code>1h0m0s</code></p></li></ul><h4 id="创建配置模板-2"><a href="#创建配置模板-2" class="headerlink" title="创建配置模板"></a>创建配置模板</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_APISERVER_ARGS=" \\</span><br><span class="line">--advertise-address=&#123;PUBLIC_IP&#125; \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--apiserver-count=3 \\</span><br><span class="line">--audit-log-maxage=30 \\</span><br><span class="line">--audit-log-maxbackup=3 \\</span><br><span class="line">--audit-log-maxsize=1000 \\</span><br><span class="line">--audit-log-path=/var/log/kube-audit/audit.log \\</span><br><span class="line">--audit-policy-file=/etc/kubernetes/audit-policy.yaml \\</span><br><span class="line">--authorization-mode=Node,RBAC \\</span><br><span class="line">--bind-address=0.0.0.0 \\</span><br><span class="line">--client-ca-file=/etc/kubernetes/pki/kube-ca.pem \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,TaintNodesByCondition,Priority,DefaultTolerationSeconds,DefaultStorageClass,PersistentVolumeClaimResize,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \\</span><br><span class="line">--enable-aggregator-routing=true \\</span><br><span class="line">--enable-bootstrap-token-auth=true \\</span><br><span class="line">--enable-garbage-collector=true \\</span><br><span class="line">--etcd-compaction-interval=0s \\</span><br><span class="line">--etcd-cafile=/etc/kubernetes/pki/etcd-ca.pem \\</span><br><span class="line">--etcd-certfile=/etc/kubernetes/pki/etcd-client.pem \\</span><br><span class="line">--etcd-keyfile=/etc/kubernetes/pki/etcd-client-key.pem \\</span><br><span class="line">--etcd-prefix=/registry \\</span><br><span class="line">--etcd-servers=$&#123;ETCD_SERVERS&#125; \\</span><br><span class="line">--encryption-provider-config=/etc/kubernetes/encryption.yaml \\</span><br><span class="line">--endpoint-reconciler-type=lease \\</span><br><span class="line">--event-ttl=24h0m0s \\</span><br><span class="line">--feature-gates=PodShareProcessNamespace=true,ExpandPersistentVolumes=true \\</span><br><span class="line">--insecure-port=0 \\</span><br><span class="line">--kubelet-client-certificate=/etc/kubernetes/pki/kube-apiserver.pem \\</span><br><span class="line">--kubelet-client-key=/etc/kubernetes/pki/kube-apiserver-key.pem \\</span><br><span class="line">--kubelet-https=true \\</span><br><span class="line">--kubelet-preferred-address-types=Hostname,InternalDNS,InternalIP,ExternalDNS,ExternalIP \\</span><br><span class="line">--kubelet-timeout=3s \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--max-mutating-requests-inflight=500 \\</span><br><span class="line">--max-requests-inflight=1500 \\</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\</span><br><span class="line">--requestheader-allowed-names=aggregator,front-proxy-client \\</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \\</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">--requestheader-username-headers=X-Remote-User \\</span><br><span class="line">--runtime-config=api/all=true \\</span><br><span class="line">--secure-port=6443 \\</span><br><span class="line">--service-account-key-file=/etc/kubernetes/pki/sa.pem \\</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/12 \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--storage-backend=etcd3 \\</span><br><span class="line">--storage-media-type=application/vnd.kubernetes.protobuf \\</span><br><span class="line">--target-ram-mb=300 \\</span><br><span class="line">--tls-cert-file=/etc/kubernetes/pki/kube-apiserver.pem \\</span><br><span class="line">--tls-private-key-file=/etc/kubernetes/pki/kube-apiserver-key.pem \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建systemd服务脚本-1"><a href="#创建systemd服务脚本-1" class="headerlink" title="创建systemd服务脚本"></a>创建systemd服务脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target etcd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \$KUBE_APISERVER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-controller-manager"><a href="#kube-controller-manager" class="headerlink" title="kube-controller-manager"></a>kube-controller-manager</h3><h4 id="说明-5"><a href="#说明-5" class="headerlink" title="说明"></a>说明</h4><ul><li>通过核心控制循环(Core Control Loop)监听 Kubernetes API<br>的资源来维护集群的状态，这些资源会被不同的控制器所管理，如 Replication Controller、Namespace<br>Controller 等等。而这些控制器会处理着自动扩展、滚动更新等等功能。</li><li>关闭非安全端口，在安全端口 10252 接收 https 请求</li><li>使用 kubeconfig 访问 kube-apiserver 的安全端口</li></ul><h4 id="配置参数-1"><a href="#配置参数-1" class="headerlink" title="配置参数"></a>配置参数</h4><ul><li><code>--allocate-node-cidrs=true</code>在cloud provider上分配和设置pod的CIDR</li><li><code>--cluster-cidr</code>集群内的pod的CIDR范围，需要 <code>--allocate-node-cidrs</code>设为true</li><li><code>--experimental-cluster-signing-duration=8670h0m0s</code>指定 TLS Bootstrap 证书的有效期</li><li><code>--feature-gates=RotateKubeletServerCertificate=true</code>开启 kublet server 证书的自动更新特性</li><li><code>--horizontal-pod-autoscaler-use-rest-clients=true</code>能够使用自定义资源（Custom Metrics）进行自动水平扩展</li><li><code>--leader-elect=true</code>集群运行模式，启用选举功能，被选为 leader 的节点负责处理工作，其它节点为阻塞状态</li><li><code>--node-cidr-mask-size=24</code>集群中node cidr的掩码</li><li><code>--service-cluster-ip-range=10.96.0.0/16</code>指定 Service Cluster IP 网段，必须和 kube-apiserver 中的同名参数一致</li><li><code>--terminated-pod-gc-threshold</code>exit状态的pod超过多少会触发gc</li></ul><h4 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-controller-manager.conf &lt;&lt;EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=" \\</span><br><span class="line">--address=0.0.0.0 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">--authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">--cluster-cidr=$POD_NET_CIDR \\</span><br><span class="line">--cluster-signing-cert-file=/etc/kubernetes/pki/kube-ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/etc/kubernetes/pki/kube-ca-key.pem \\</span><br><span class="line">--concurrent-service-syncs=10 \\</span><br><span class="line">--concurrent-serviceaccount-token-syncs=20 \\</span><br><span class="line">--controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">--enable-garbage-collector=true \\</span><br><span class="line">--experimental-cluster-signing-duration=8670h0m0s \\</span><br><span class="line">--feature-gates=PodShareProcessNamespace=true,ExpandPersistentVolumes=true \\</span><br><span class="line">--horizontal-pod-autoscaler-sync-period=10s \\</span><br><span class="line">--horizontal-pod-autoscaler-use-rest-clients=true \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--node-cidr-mask-size=24 \\</span><br><span class="line">--node-monitor-grace-period=40s \\</span><br><span class="line">--node-monitor-period=5s \\</span><br><span class="line">--pod-eviction-timeout=2m0s \\</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\</span><br><span class="line">--root-ca-file=/etc/kubernetes/pki/kube-ca.pem \\</span><br><span class="line">--service-account-private-key-file=/etc/kubernetes/pki/sa-key.pem \\</span><br><span class="line">--service-cluster-ip-range=$&#123;SVC_CLUSTER_CIDR&#125; \\</span><br><span class="line">--terminated-pod-gc-threshold=12500 \\</span><br><span class="line">--use-service-account-credentials=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建systemd服务脚本-2"><a href="#创建systemd服务脚本-2" class="headerlink" title="创建systemd服务脚本"></a>创建systemd服务脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-controller-manager.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h3><h4 id="说明-6"><a href="#说明-6" class="headerlink" title="说明"></a>说明</h4><ul><li>负责将一个(或多个)容器依据调度策略分配到对应节点上让容器引擎(如 Docker)执行。</li><li>调度受到 QoS 要求、软硬性约束、亲和性(Affinity)等等因素影响。</li></ul><h4 id="配置参数-2"><a href="#配置参数-2" class="headerlink" title="配置参数"></a>配置参数</h4><ul><li><code>--algorithm-provider=DefaultProvider</code>使用默认调度算法</li><li><code>--leader-elect=true</code>集群运行模式，启用选举功能，被选为 leader 的节点负责处理工作，其它节点为阻塞状态</li></ul><h4 id="创建配置文件-1"><a href="#创建配置文件-1" class="headerlink" title="创建配置文件"></a>创建配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler.conf &lt;&lt;EOF</span><br><span class="line">KUBE_SCHEDULER_ARGS="\\</span><br><span class="line">--address=0.0.0.0 \\</span><br><span class="line">--algorithm-provider=DefaultProvider \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建systemd服务脚本-3"><a href="#创建systemd服务脚本-3" class="headerlink" title="创建systemd服务脚本"></a>创建systemd服务脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \$KUBE_SCHEDULER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="分发配置文件-1"><a href="#分发配置文件-1" class="headerlink" title="分发配置文件"></a>分发配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    echo '---- 分发kubeconfig文件 yaml文件 ----'</span><br><span class="line">    rsync -avpt /root/pki/kube-admin.kubeconfig \</span><br><span class="line">                /root/pki/kube-controller-manager.kubeconfig \</span><br><span class="line">                /root/pki/kube-scheduler.kubeconfig \</span><br><span class="line">                /root/pki/audit-policy.yaml \</span><br><span class="line">                /root/pki/encryption.yaml \</span><br><span class="line">                $NODE:/etc/kubernetes/</span><br><span class="line">    echo '---- 分发sa证书 kube证书 front-proxy证书 ----'</span><br><span class="line">    rsync -avpt /root/pki/etcd-ca.pem \</span><br><span class="line">                /root/pki/etcd-client-key.pem \</span><br><span class="line">                /root/pki/etcd-client.pem \</span><br><span class="line">                /root/pki/front-proxy-ca.pem \</span><br><span class="line">                /root/pki/front-proxy-client-key.pem \</span><br><span class="line">                /root/pki/front-proxy-client.pem \</span><br><span class="line">                /root/pki/kube-apiserver-key.pem \</span><br><span class="line">                /root/pki/kube-apiserver.pem \</span><br><span class="line">                /root/pki/kube-ca.pem \</span><br><span class="line">                /root/pki/kube-ca-key.pem \</span><br><span class="line">                /root/pki/sa-key.pem \</span><br><span class="line">                /root/pki/sa.pem \</span><br><span class="line">                $NODE:/etc/kubernetes/pki/</span><br><span class="line">    echo '---- 分发kubernetes components服务脚本----'</span><br><span class="line">    rsync -avpt kube*service $NODE:/usr/lib/systemd/system/</span><br><span class="line">    echo '---- 分发kubernetes components配置----'</span><br><span class="line">    sed -e "s/&#123;PUBLIC_IP&#125;/$&#123;MasterArray[$NODE]&#125;/g" kube-apiserver.conf.example &gt; kube-apiserver.conf.$&#123;NODE&#125;</span><br><span class="line">    rsync -avpt kube-apiserver.conf.$&#123;NODE&#125; $NODE:/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">    rsync -avpt kube-controller-manager.conf $NODE:/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">    rsync -avpt kube-scheduler.conf $NODE:/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">    rm -rf kube-apiserver.conf.$&#123;NODE&#125;</span><br><span class="line">    ssh $NODE systemctl daemon-reload</span><br><span class="line">    ssh $NODE chown -R kube:kube /etc/kubernetes</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="分发master组件二进制文件"><a href="#分发master组件二进制文件" class="headerlink" title="分发master组件二进制文件"></a>分发master组件二进制文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 分发kubernetes和etcd二进制文件 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    rsync -avpt /root/software/kubernetes/server/bin/kube-controller-manager \</span><br><span class="line">                /root/software/kubernetes/server/bin/hyperkube \</span><br><span class="line">                /root/software/kubernetes/server/bin/mounter \</span><br><span class="line">                /root/software/kubernetes/server/bin/kubelet \</span><br><span class="line">                /root/software/kubernetes/server/bin/kubectl \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-scheduler \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-proxy \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-apiserver \</span><br><span class="line">                /root/software/kubernetes/server/bin/cloud-controller-manager \</span><br><span class="line">                /root/software/kubernetes/server/bin/kubeadm \</span><br><span class="line">                /root/software/kubernetes/server/bin/apiextensions-apiserver \</span><br><span class="line">                $NODE:/usr/local/bin/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="启动Kubernetes-master服务"><a href="#启动Kubernetes-master服务" class="headerlink" title="启动Kubernetes master服务"></a>启动Kubernetes master服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE "systemctl enable --now kube-apiserver.service"</span><br><span class="line">    # sleep 10秒，让apiserver先初始化完成</span><br><span class="line">    sleep 10</span><br><span class="line">    ssh $NODE "systemctl enable --now kube-controller-manager.service"</span><br><span class="line">    ssh $NODE "systemctl enable --now kube-scheduler.service"</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="验证Kubernetes集群服务"><a href="#验证Kubernetes集群服务" class="headerlink" title="验证Kubernetes集群服务"></a>验证Kubernetes集群服务</h2><h3 id="检查集群components状态"><a href="#检查集群components状态" class="headerlink" title="检查集群components状态"></a>检查集群components状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kube-admin.kubeconfig get cs</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;"health":"true"&#125;</span><br></pre></td></tr></table></figure><h3 id="检查集群endpoints状态"><a href="#检查集群endpoints状态" class="headerlink" title="检查集群endpoints状态"></a>检查集群endpoints状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kube-admin.kubeconfig get endpoints</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME         ENDPOINTS                                                  AGE</span><br><span class="line">kubernetes   172.16.80.201:6443,172.16.80.202:6443,172.16.80.203:6443   12m</span><br></pre></td></tr></table></figure><h2 id="配置kubectl"><a href="#配置kubectl" class="headerlink" title="配置kubectl"></a>配置kubectl</h2><h3 id="集群配置文件"><a href="#集群配置文件" class="headerlink" title="集群配置文件"></a>集群配置文件</h3><blockquote><p>kubectl默认会加载<code>~/.kube/config</code>文件，作为默认连接Kubernetes集群的凭证</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE mkdir -p /root/.kube</span><br><span class="line">    rsync -avpt /root/pki/kube-admin.kubeconfig $NODE:/root/.kube/config</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="kubectl命令补齐"><a href="#kubectl命令补齐" class="headerlink" title="kubectl命令补齐"></a>kubectl命令补齐</h3><h4 id="临时生效"><a href="#临时生效" class="headerlink" title="临时生效"></a>临时生效</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &lt;(kubectl completion bash)</span><br></pre></td></tr></table></figure><h4 id="开机自动加载"><a href="#开机自动加载" class="headerlink" title="开机自动加载"></a>开机自动加载</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    echo "--- kubectl命令自动补全 ---"</span><br><span class="line">    ssh $NODE "kubectl completion bash &gt; /etc/bash_completion.d/kubectl"</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="配置TLS-Bootstrap"><a href="#配置TLS-Bootstrap" class="headerlink" title="配置TLS Bootstrap"></a>配置TLS Bootstrap</h2><ul><li>当集群开启了 TLS 认证后，每个节点的 kubelet 组件都要使用由 apiserver 使用的 CA 签发的有效证书才能与<br>apiserver 通讯</li><li>如果节点多起来，为每个节点单独签署证书将是一件非常繁琐的事情</li><li>TLS bootstrapping 功能就是让 kubelet 先使用一个预定的低权限用户连接到 apiserver，然后向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署；</li></ul><h3 id="创建工作目录-3"><a href="#创建工作目录-3" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/</span><br><span class="line">cd /root/yaml/</span><br></pre></td></tr></table></figure><h3 id="创建TLS-Bootstrap-Token对象"><a href="#创建TLS-Bootstrap-Token对象" class="headerlink" title="创建TLS Bootstrap Token对象"></a>创建TLS Bootstrap Token对象</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system create secret generic bootstrap-token-$&#123;BOOTSTRAP_TOKEN_ID&#125; \</span><br><span class="line">        --type 'bootstrap.kubernetes.io/token' \</span><br><span class="line">        --from-literal description="cluster bootstrap token" \</span><br><span class="line">        --from-literal token-id=$&#123;BOOTSTRAP_TOKEN_ID&#125; \</span><br><span class="line">        --from-literal token-secret=$&#123;BOOTSTRAP_TOKEN_SECRET&#125; \</span><br><span class="line">        --from-literal usage-bootstrap-authentication=true \</span><br><span class="line">        --from-literal usage-bootstrap-signing=true \</span><br><span class="line">        --dry-run -o yaml &gt; /root/yaml/tls-bootstrap-token.yaml</span><br><span class="line">kubectl apply -f /root/yaml/tls-bootstrap-token.yaml</span><br></pre></td></tr></table></figure><h3 id="创建YAML文件"><a href="#创建YAML文件" class="headerlink" title="创建YAML文件"></a>创建YAML文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/kubelet-tls-bootstrap-rbac.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许 kubelet tls bootstrap 创建 csr 请求</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: create-csrs-for-bootstrapping</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node-bootstrapper</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:bootstrappers</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动批准 system:bootstrappers 组用户 TLS bootstrapping 首次申请证书的 CSR 请求</span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: auto-approve-csrs-for-group</span><br><span class="line">subjects:</span><br><span class="line">- kind: Group</span><br><span class="line">  name: system:bootstrappers</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: auto-approve-renewals-for-nodes</span><br><span class="line">subjects:</span><br><span class="line">- kind: Group</span><br><span class="line">  name: system:nodes</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建RBAC规则"><a href="#创建RBAC规则" class="headerlink" title="创建RBAC规则"></a>创建RBAC规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/kubelet-tls-bootstrap-rbac.yaml</span><br></pre></td></tr></table></figure><h2 id="kube-apiserver获取node信息的权限"><a href="#kube-apiserver获取node信息的权限" class="headerlink" title="kube-apiserver获取node信息的权限"></a>kube-apiserver获取node信息的权限</h2><h3 id="说明-7"><a href="#说明-7" class="headerlink" title="说明"></a>说明</h3><p>本文部署的<code>kubelet</code>关闭了匿名访问，因此需要额外为<code>kube-apiserver</code>添加权限用于访问kubelet的信息</p><p>若没添加此<code>RBAC</code>，则<code>kubectl</code>在执行<code>logs</code>、<code>exec</code>等指令的时候会提示<code>401 Forbidden</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system logs calico-node-pc8lq </span><br><span class="line">Error from server (Forbidden): Forbidden (user=kube-apiserver, verb=get, resource=nodes, subresource=proxy) ( pods/log calico-node-pc8lq)</span><br></pre></td></tr></table></figure><p>参考文档：<a href="https://jimmysong.io/kubernetes-handbook/guide/kubelet-authentication-authorization.html" target="_blank" rel="noopener">Kubelet的认证授权</a></p><h3 id="创建YAML文件-1"><a href="#创建YAML文件-1" class="headerlink" title="创建YAML文件"></a>创建YAML文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/apiserver-to-kubelet-rbac.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: "true"</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - proxy</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - nodes/log</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  - nodes/spec</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - '*'</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: ""</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kube-apiserver</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: systemctl:kubelet-api-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kubelet-api-admin</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: kube-apiserver</span><br><span class="line">---</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建RBAC规则-1"><a href="#创建RBAC规则-1" class="headerlink" title="创建RBAC规则"></a>创建RBAC规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure><h1 id="Kubernetes-Nodes"><a href="#Kubernetes-Nodes" class="headerlink" title="Kubernetes Nodes"></a>Kubernetes Nodes</h1><h2 id="说明-8"><a href="#说明-8" class="headerlink" title="说明"></a>说明</h2><h3 id="节点配置"><a href="#节点配置" class="headerlink" title="节点配置"></a>节点配置</h3><ul><li>安装Docker-ce，配置与master节点一致即可</li><li>安装cni-plugins、kubelet、kube-proxy</li><li>关闭防火墙和SELINUX</li><li><code>kubelet</code>运行需要root权限</li><li>这里是以k8s-m1、k8s-m2、k8s-m3、k8s-n1、k8s-n2作为Work节点加入集群</li></ul><h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><ul><li>管理容器生命周期、节点状态监控</li><li>目前 kubelet 支持三种数据源来获取节点Pod信息：<ul><li>本地文件</li><li>通过 url 从网络上某个地址来获取信息</li><li>API Server：从 kubernetes master 节点获取信息</li></ul></li><li>使用kubeconfig与kube-apiserver通信</li><li>这里启用<code>TLS-Bootstrap</code>实现kubelet证书动态签署证书，并自动生成kubeconfig</li></ul><h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><ul><li>Kube-proxy是实现Service的关键插件，kube-proxy会在每台节点上执行，然后监听API Server的Service与Endpoint资源物件的改变，然后来依据变化调用相应的组件来实现网路的转发</li><li>kube-proxy可以使用<code>userspace</code>（基本已废弃）、<code>iptables</code>（默认方式）和<code>ipvs</code>来实现数据报文的转发</li><li>这里使用的是性能更好、适合大规模使用的<code>ipvs</code></li><li>以DaemonSet方式运行</li></ul><h2 id="kubelet配置"><a href="#kubelet配置" class="headerlink" title="kubelet配置"></a>kubelet配置</h2><h3 id="说明-9"><a href="#说明-9" class="headerlink" title="说明"></a>说明</h3><ul><li>kubelet在<code>1.10</code>版本开始动态配置特性进入Beta阶段，因此绝大部分配置被标记为DEPRECATED，官方推荐使用<code>--config</code>指定配置文件，并在配置文件里面指定原来命令行中配置的内容。</li><li>因此kubelet的配置实际被分割成两个部分，启动参数和动态配置参数</li></ul><h3 id="创建目录-1"><a href="#创建目录-1" class="headerlink" title="创建目录"></a>创建目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/node</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-3"><a href="#切换工作目录-3" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/node</span><br></pre></td></tr></table></figure><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.config &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    # 这里写kubernetes-ca证书的路径</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/kube-ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line"><span class="meta">#</span><span class="bash"> cgroups的驱动，可选systemd和cgroupfs</span></span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定Pod的DNS地址，这里的地址需要指向CoreDNS的SVC地址</span></span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群域名</span></span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">configMapAndSecretChangeDetectionStrategy: Cache</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuCFSQuotaPeriod: 100ms</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 达到某些阈值之后，kubelet会驱逐Pod</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A <span class="built_in">set</span> of eviction thresholds (e.g. memory.available&lt;1Gi) that <span class="keyword">if</span> met would trigger a pod eviction.</span></span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测到系统已启用swap分区时kubelet会启动失败</span></span><br><span class="line">failSwapOn: false</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义feature gates</span></span><br><span class="line">featureGates:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 禁用Alpha的功能</span></span><br><span class="line">  AllAlpha: false </span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查kubelet配置文件变更的间隔</span></span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许endpoint在尝试访问自己的服务时会被负载均衡分发到自身</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可选值<span class="string">"promiscuous-bridge"</span>, <span class="string">"hairpin-veth"</span> and <span class="string">"none"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为promiscuous-bridge</span></span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里定义容器镜像触发回收空间的上限值和下限值</span></span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubelet进程最大能打开的文件数量</span></span><br><span class="line">maxOpenFiles: 1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前节点kubelet所能运行的最大Pod数量</span></span><br><span class="line">maxPods: 110</span><br><span class="line">nodeLeaseDurationSeconds: 40</span><br><span class="line"><span class="meta">#</span><span class="bash"> node状态上报间隔</span></span><br><span class="line">nodeStatusReportFrequency: 1m0s</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line"><span class="meta">#</span><span class="bash"> Pod PID数量限制，默认-1，即无限制</span></span><br><span class="line">podPidsLimit: -1</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubelet服务端口</span></span><br><span class="line">port: 10250</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定域名解析文件</span></span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">rotateServerCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拉镜像时，同一时间只拉取一个镜像，即串行化</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> We recommend *not* changing the default value on nodes that run docker daemon with version &lt; 1.9 or an Aufs storage backend. Issue <span class="comment">#10959 has more details. (default true)</span></span></span><br><span class="line">serializeImagePulls: false</span><br><span class="line"><span class="meta">#</span><span class="bash"> 静态Pod的manifest目录</span></span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="systemd服务脚本"><a href="#systemd服务脚本" class="headerlink" title="systemd服务脚本"></a>systemd服务脚本</h3><ul><li><code>--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig</code>指定bootstrap启动时使用的kubeconfig</li><li><code>--network-plugin=cni</code>定义网络插件，Pod生命周期使用此网络插件</li><li><code>--node-labels=node-role.kubernetes.io/node=&#39;&#39;</code>kubelet注册当前Node时设置的Label，以key=value的格式表示，多个labe以逗号分隔</li><li><code>--pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.1</code>Pod的pause镜像</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">               --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \\</span><br><span class="line">               --cert-dir=/etc/kubernetes/ssl \\</span><br><span class="line">               --config=/etc/kubernetes/kubelet.config \\</span><br><span class="line">               --cni-conf-dir=/etc/cni/net.d \\</span><br><span class="line">               --cni-bin-dir=/opt/cni/bin \\</span><br><span class="line">               --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">               --logtostderr=true \\</span><br><span class="line">               --network-plugin=cni \\</span><br><span class="line">               --pod-infra-container-image=gcrxio/pause:3.1 \\</span><br><span class="line">               --v=2</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="创建程序目录"><a href="#创建程序目录" class="headerlink" title="创建程序目录"></a>创建程序目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!HostArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    echo "--- 创建目录 ---"</span><br><span class="line">    ssh $NODE mkdir -p /opt/cni/bin \</span><br><span class="line">                       /etc/cni/net.d \</span><br><span class="line">                       /etc/kubernetes/pki \</span><br><span class="line">                       /etc/kubernetes/ssl \</span><br><span class="line">                       /etc/kubernetes/manifests \</span><br><span class="line">                       /var/lib/kubelet</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="分发文件"><a href="#分发文件" class="headerlink" title="分发文件"></a>分发文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!HostArray[@]&#125;";do</span><br><span class="line">    echo "--- $&#123;NODE&#125; ---"</span><br><span class="line">    echo "--- 分发kubernetes二进制文件 ---"</span><br><span class="line">    rsync -avpt /root/software/kubernetes/server/bin/kubelet \</span><br><span class="line">                $&#123;NODE&#125;:/usr/local/bin/</span><br><span class="line">    echo "--- 分发CNI-Plugins ---"</span><br><span class="line">    rsync -avpt /root/software/cni-plugins/* \</span><br><span class="line">                $&#123;NODE&#125;:/opt/cni/bin/</span><br><span class="line">    echo "--- 分发证书和kubeconfig文件 ---"</span><br><span class="line">    rsync -avpt /root/pki/bootstrap.kubeconfig \</span><br><span class="line">                $&#123;NODE&#125;:/etc/kubernetes/</span><br><span class="line">    rsync -avpt /root/pki/kube-ca.pem \</span><br><span class="line">                /root/pki/front-proxy-ca.pem \</span><br><span class="line">                $&#123;NODE&#125;:/etc/kubernetes/pki/</span><br><span class="line">    echo "--- 分发配置文件 ---"</span><br><span class="line">    rsync -avpt kubelet.config $&#123;NODE&#125;:/etc/kubernetes/</span><br><span class="line">    echo "--- 分发systemd服务脚本 ---"</span><br><span class="line">    rsync -avpt kubelet.service $&#123;NODE&#125;:/usr/lib/systemd/system/</span><br><span class="line">    ssh $&#123;NODE&#125; systemctl daemon-reload</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="启动kubelet服务"><a href="#启动kubelet服务" class="headerlink" title="启动kubelet服务"></a>启动kubelet服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!HostArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    ssh $NODE systemctl enable docker.service kubelet.service</span><br><span class="line">    ssh $NODE systemctl start docker.service kubelet.service</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="获取集群节点信息"><a href="#获取集群节点信息" class="headerlink" title="获取集群节点信息"></a>获取集群节点信息</h2><ul><li>此时由于未按照网络插件，所以节点状态为<font color="red"><code>NotReady</code></font></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node -o wide</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME      STATUS     ROLES     AGE       VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION              CONTAINER-RUNTIME</span><br><span class="line">k8s-m1    NotReady   node      12s       v1.14.3   172.16.80.201   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.3.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-m2    NotReady   node      12s       v1.14.3   172.16.80.202   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.3.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-m3    NotReady   node      12s       v1.14.3   172.16.80.203   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.3.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-n1    NotReady   node      12s       v1.14.3   172.16.80.204   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.3.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-n2    NotReady   node      12s       v1.14.3   172.16.80.205   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.3.el7.x86_64   docker://18.9.6</span><br></pre></td></tr></table></figure><h2 id="节点标签"><a href="#节点标签" class="headerlink" title="节点标签"></a>节点标签</h2><h3 id="master节点"><a href="#master节点" class="headerlink" title="master节点"></a>master节点</h3><ul><li>声明污点，避免没有声明容忍该污点的Pod被调度到master节点</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node $&#123;!MasterArray[@]&#125; node-role.kubernetes.io/master=""</span><br><span class="line">kubectl taint nodes $&#123;!MasterArray[@]&#125; node-role.kubernetes.io/master="":NoSchedule</span><br></pre></td></tr></table></figure><h3 id="node节点"><a href="#node节点" class="headerlink" title="node节点"></a>node节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes $&#123;!NodeArray[@]&#125; node-role.kubernetes.io/node=""</span><br></pre></td></tr></table></figure><h1 id="Kubernetes-Core-Addons"><a href="#Kubernetes-Core-Addons" class="headerlink" title="Kubernetes Core Addons"></a>Kubernetes Core Addons</h1><h2 id="Kube-Proxy"><a href="#Kube-Proxy" class="headerlink" title="Kube-Proxy"></a>Kube-Proxy</h2><h3 id="说明-10"><a href="#说明-10" class="headerlink" title="说明"></a>说明</h3><ul><li><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/kube-proxy" target="_blank" rel="noopener">Kube-proxy</a>是实现Service的关键插件,kube-proxy会在每台节点上执行,然后监听API<br>Server的Service与Endpoint资源物件的改变,然后来依据变化执行iptables来实现网路的转发。</li><li>本文使用DaemonSet来运行Kube-Proxy组件。</li></ul><h3 id="创建工作目录-4"><a href="#创建工作目录-4" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/CoreAddons/kube-proxy</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-4"><a href="#切换工作目录-4" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/CoreAddons/kube-proxy</span><br></pre></td></tr></table></figure><h3 id="创建YAML文件-2"><a href="#创建YAML文件-2" class="headerlink" title="创建YAML文件"></a>创建YAML文件</h3><h4 id="ServicAccount"><a href="#ServicAccount" class="headerlink" title="ServicAccount"></a>ServicAccount</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/kube-proxy/kube-proxy-sa.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-proxy</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/kube-proxy/kube-proxy-cm.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: kube-proxy</span><br><span class="line">  name: kube-proxy</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  config.conf: |-</span><br><span class="line">    apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">    kind: KubeProxyConfiguration</span><br><span class="line">    bindAddress: 0.0.0.0</span><br><span class="line">    clientConnection:</span><br><span class="line">      acceptContentTypes: ""</span><br><span class="line">      burst: 10</span><br><span class="line">      contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">      kubeconfig: /var/lib/kube-proxy/kubeconfig.conf</span><br><span class="line">      qps: 5</span><br><span class="line">    # 集群中pod的CIDR范围，从这个范围以外发送到服务集群IP的流量将被伪装</span><br><span class="line">    # 从POD发送到外部LoadBalanceIP的流量将被定向到各自的集群IP</span><br><span class="line">    clusterCIDR: 10.244.0.0/16</span><br><span class="line">    # 来自apiserver配置的刷新频率</span><br><span class="line">    configSyncPeriod: 15m0s</span><br><span class="line">    conntrack:</span><br><span class="line">      max: null</span><br><span class="line">      # 每个核心最大能跟踪的NAT连接数，默认32768</span><br><span class="line">      maxPerCore: 32768</span><br><span class="line">      min: 131072</span><br><span class="line">      # 处于CLOSE_WAIT状态的TCP连接超时时间</span><br><span class="line">      tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">      # 已建立的 TCP 连接的空闲超时</span><br><span class="line">      tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">    # 通过Web接口/debug/pprof启用性能分析</span><br><span class="line">    enableProfiling: false</span><br><span class="line">    featureGates:</span><br><span class="line">      SupportIPVSProxyMode: true</span><br><span class="line">    healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">    hostnameOverride: ""</span><br><span class="line">    iptables:</span><br><span class="line">      # SNAT所有通过服务集群ip发送的通信</span><br><span class="line">      masqueradeAll: false</span><br><span class="line">      masqueradeBit: 14</span><br><span class="line">      minSyncPeriod: 0s</span><br><span class="line">      # ipvs 规则刷新的最大时间间隔</span><br><span class="line">      syncPeriod: 30s</span><br><span class="line">    ipvs:</span><br><span class="line">      excludeCIDRs: null</span><br><span class="line">      minSyncPeriod: 0s</span><br><span class="line">      # ipvs调度类型，默认是rr</span><br><span class="line">      scheduler: rr</span><br><span class="line">      strictARP: false</span><br><span class="line">      syncPeriod: 30s</span><br><span class="line">    metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">    # 配置kube-proxy代理模式，可选iptables和ipvs，默认是iptables</span><br><span class="line">    mode: ipvs</span><br><span class="line">    nodePortAddresses: null</span><br><span class="line">    oomScoreAdj: -999</span><br><span class="line">    portRange: ""</span><br><span class="line">    resourceContainer: /kube-proxy</span><br><span class="line">    udpIdleTimeout: 250ms</span><br><span class="line">  kubeconfig.conf: |-</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: Config</span><br><span class="line">    clusters:</span><br><span class="line">    - cluster:</span><br><span class="line">        certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">        server: $&#123;KUBE_APISERVER&#125;</span><br><span class="line">      name: default</span><br><span class="line">    contexts:</span><br><span class="line">    - context:</span><br><span class="line">        cluster: default</span><br><span class="line">        namespace: default</span><br><span class="line">        user: default</span><br><span class="line">      name: default</span><br><span class="line">    current-context: default</span><br><span class="line">    users:</span><br><span class="line">    - name: default</span><br><span class="line">      user:</span><br><span class="line">        tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/kube-proxy/kube-proxy-ds.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-proxy</span><br><span class="line">  name: kube-proxy</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-proxy</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: ""</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-proxy</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - command:</span><br><span class="line">        - /usr/local/bin/kube-proxy</span><br><span class="line">        - --config=/var/lib/kube-proxy/config.conf</span><br><span class="line">        - --hostname-override=\$(NODE_NAME)</span><br><span class="line">        env:</span><br><span class="line">        - name: NODE_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: spec.nodeName</span><br><span class="line">        image: gcrxio/kube-proxy:v1.14.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: kube-proxy</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var/lib/kube-proxy</span><br><span class="line">          name: kube-proxy</span><br><span class="line">        - mountPath: /run/xtables.lock</span><br><span class="line">          name: xtables-lock</span><br><span class="line">        - mountPath: /lib/modules</span><br><span class="line">          name: lib-modules</span><br><span class="line">          readOnly: true</span><br><span class="line">        - mountPath: /etc/localtime</span><br><span class="line">          name: timezone-volume</span><br><span class="line">          readOnly: true</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      serviceAccountName: kube-proxy</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: CriticalAddonsOnly</span><br><span class="line">        operator: Exists</span><br><span class="line">      - operator: Exists</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          name: kube-proxy</span><br><span class="line">        name: kube-proxy</span><br><span class="line">      - hostPath:</span><br><span class="line">          path: /run/xtables.lock</span><br><span class="line">          type: FileOrCreate</span><br><span class="line">        name: xtables-lock</span><br><span class="line">      - hostPath:</span><br><span class="line">          path: /lib/modules</span><br><span class="line">        name: lib-modules</span><br><span class="line">      - hostPath:</span><br><span class="line">          path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">        name: timezone-volume</span><br><span class="line">  updateStrategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="ClusterRoleBinding"><a href="#ClusterRoleBinding" class="headerlink" title="ClusterRoleBinding"></a>ClusterRoleBinding</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/kube-proxy/kube-proxy-rbac.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubeadm:node-proxier</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node-proxier</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-proxy</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="部署Kube-Proxy"><a href="#部署Kube-Proxy" class="headerlink" title="部署Kube-Proxy"></a>部署Kube-Proxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/CoreAddons/kube-proxy/</span><br></pre></td></tr></table></figure><h3 id="验证Kube-Proxy"><a href="#验证Kube-Proxy" class="headerlink" title="验证Kube-Proxy"></a>验证Kube-Proxy</h3><h4 id="查看Pod"><a href="#查看Pod" class="headerlink" title="查看Pod"></a>查看Pod</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=kube-proxy</span><br></pre></td></tr></table></figure><h4 id="查看IPVS规则"><a href="#查看IPVS规则" class="headerlink" title="查看IPVS规则"></a>查看IPVS规则</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -ln</span><br></pre></td></tr></table></figure><h4 id="查看Kube-Proxy代理模式"><a href="#查看Kube-Proxy代理模式" class="headerlink" title="查看Kube-Proxy代理模式"></a>查看Kube-Proxy代理模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:10249/proxyMode</span><br></pre></td></tr></table></figure><h2 id="网络插件"><a href="#网络插件" class="headerlink" title="网络插件"></a>网络插件</h2><h3 id="说明-11"><a href="#说明-11" class="headerlink" title="说明"></a>说明</h3><ul><li>只要符合CNI规范的网络组件都可以给kubernetes使用</li><li>网络组件清单可以在这里看到<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">Network Plugins</a></li><li>这里只列举<code>kube-flannel</code>和<code>calico</code>，flannel和calico的区别可以自己去找资料</li><li><font color="red">网络组件只能选一个来部署</font></li><li>本文使用<code>kube-flannel</code>部署网络组件，<code>calico</code>已测试可用</li><li>在<font color="red">k8s-m1</font>上操作</li></ul><h3 id="创建工作目录-5"><a href="#创建工作目录-5" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/CoreAddons/network-plugin/&#123;kube-flannel,calico&#125;</span><br></pre></td></tr></table></figure><h3 id="kube-flannel"><a href="#kube-flannel" class="headerlink" title="kube-flannel"></a>kube-flannel</h3><h4 id="说明-12"><a href="#说明-12" class="headerlink" title="说明"></a>说明</h4><ul><li>kube-flannel基于VXLAN的方式创建容器二层网络，使用端口<font color="red"><code>8472/UDP</code></font>通信</li><li>flannel 第一次启动时，从 etcd 获取 Pod 网段信息，为本节点分配一个未使用的 /24 段地址，然后创建 flannel.1（也可能是其它名称，如 flannel1 等） 接口。</li><li>官方提供yaml文件部署为<code>DeamonSet</code></li><li>若需要使用<code>NetworkPolicy</code>功能，可以关注这个项目<a href="https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/flannel" target="_blank" rel="noopener">canal</a></li></ul><h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><p><img src="https://jimmysong.io/kubernetes-handbook/images/flannel-networking.png" alt=""></p><h4 id="切换工作目录-5"><a href="#切换工作目录-5" class="headerlink" title="切换工作目录"></a>切换工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/CoreAddons/network-plugin/kube-flannel</span><br></pre></td></tr></table></figure><h4 id="下载yaml文件"><a href="#下载yaml文件" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><ul><li><p>官方yaml文件包含多个平台的daemonset，包括amd64、arm64、arm、ppc64le、s390x</p></li><li><p>这里以amd64作为例子，其他的可以自行根据需要修改或者直接删除不需要的daemonset</p></li><li><p>官方yaml文件已经配置好容器网络为<code>10.244.0.0/16</code>，这里需要跟<code>kube-controller-manager.conf</code>里面的<code>--cluster-cidr</code>匹配</p></li><li><p>如果在<code>kube-controller-manager.conf</code>里面把<code>--cluster-cidr</code>改成了其他地址段，例如<code>192.168.0.0/16</code>，用以下命令替换<code>kube-flannel.yaml</code>相应的字段</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,"Network": "10.244.0.0/16","Network": "192.168.0.0/16," -i kube-flannel.yml</span><br></pre></td></tr></table></figure><ul><li><p>如果服务器有多个网卡，需要指定网卡用于flannel通信，以网卡ens33为例</p><ul><li>在<code>args</code>下面添加一行<font color="red"><code>- --iface=ens33</code></font></li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">- name: kube-flannel</span><br><span class="line">  command:</span><br><span class="line">  - /opt/bin/flanneld</span><br><span class="line">  args:</span><br><span class="line">  - --ip-masq</span><br><span class="line">  - --kube-subnet-mgr</span><br><span class="line">  - --iface=ens33</span><br></pre></td></tr></table></figure><h4 id="修改backend"><a href="#修改backend" class="headerlink" title="修改backend"></a>修改backend</h4><ul><li>flannel支持多种后端实现，可选值为<code>VXLAN</code>、<code>host-gw</code>、<code>UDP</code></li><li>从性能上，<code>host-gw</code>是最好的，<code>VXLAN</code>和<code>UDP</code>次之</li><li>默认值是<code>VXLAN</code>，这里以修改为<code>host-gw</code>为例，位置大概在75行左右</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    "Network": "10.244.0.0/16",</span></span><br><span class="line"><span class="string">    "Backend": &#123;</span></span><br><span class="line"><span class="string">      "Type": "host-gw"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br></pre></td></tr></table></figure><h4 id="部署kube-flannel"><a href="#部署kube-flannel" class="headerlink" title="部署kube-flannel"></a>部署kube-flannel</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><h4 id="检查部署情况"><a href="#检查部署情况" class="headerlink" title="检查部署情况"></a>检查部署情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=flannel</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                          READY   STATUS                  RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-amd64-4v8q7   1/1     Running                 0          3m46s</span><br><span class="line">kube-flannel-ds-amd64-6lq5q   1/1     Running                 0          3m47s</span><br><span class="line">kube-flannel-ds-amd64-cczp4   1/1     Running                 0          3m45s</span><br><span class="line">kube-flannel-ds-amd64-wjpkg   1/1     Running                 0          3m44s</span><br><span class="line">kube-flannel-ds-amd64-z2lm8   1/1     Running                 0          3m46s</span><br></pre></td></tr></table></figure><ul><li>如果等很久都没Running，可能是你所在的网络环境访问quay.io速度太慢了</li><li>可以替换一下镜像，重新apply</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,quay.io/coreos/,zhangguanzhang/quay.io.coreos.,g' -i kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yaml</span><br></pre></td></tr></table></figure><h3 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h3><h4 id="说明-13"><a href="#说明-13" class="headerlink" title="说明"></a>说明</h4><ul><li>Calico 是一款纯 Layer 3 的网络，节点之间基于BGP协议来通信。</li><li>这里以<code>calico-v3.7.0</code>来作为示例</li><li><a href="https://docs.projectcalico.org/v3.7/getting-started/kubernetes/installation/calico" target="_blank" rel="noopener">部署文档</a></li></ul><h4 id="架构图-1"><a href="#架构图-1" class="headerlink" title="架构图"></a>架构图</h4><p><img src="https://docs.projectcalico.org/images/calico-arch-gen-v3.2.svg" alt=""></p><h4 id="切换工作目录-6"><a href="#切换工作目录-6" class="headerlink" title="切换工作目录"></a>切换工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/CoreAddons/network-plugin/calico</span><br></pre></td></tr></table></figure><h4 id="下载yaml文件-1"><a href="#下载yaml文件-1" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h4><ul><li>这里选用的是【<code>Installing with the Kubernetes API datastore—50 nodes or less</code>】</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://docs.projectcalico.org/v3.7/manifests/calico.yaml</span><br></pre></td></tr></table></figure><h4 id="修改YAML文件"><a href="#修改YAML文件" class="headerlink" title="修改YAML文件"></a>修改YAML文件</h4><p>calico-node服务的主要参数如下</p><ul><li><code>CALICO_IPV4POOL_CIDR</code>配置Calico IPAM的IP地址池，默认是<code>192.168.0.0/16</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span></span><br><span class="line"><span class="comment"># chosen from this range. Changing this value after installation will have</span></span><br><span class="line"><span class="comment"># no effect. This should fall within `--cluster-cidr`.</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">CALICO_IPV4POOL_CIDR</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"192.168.0.0/16"</span></span><br></pre></td></tr></table></figure><ul><li><code>CALICO_IPV4POOL_IPIP</code> 配置是否使用IPIP模式，默认是打开的</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable IPIP</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">CALICO_IPV4POOL_IPIP</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"Always"</span></span><br></pre></td></tr></table></figure><h4 id="部署Calico"><a href="#部署Calico" class="headerlink" title="部署Calico"></a>部署Calico</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/CoreAddons/network-plugin/calico/</span><br></pre></td></tr></table></figure><h4 id="检查部署情况-1"><a href="#检查部署情况-1" class="headerlink" title="检查部署情况"></a>检查部署情况</h4><ul><li>检查calico-node</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=calico-node</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                READY     STATUS    RESTARTS   AGE</span><br><span class="line">calico-node-fjcj4   2/2       Running   0          6m</span><br><span class="line">calico-node-tzppt   2/2       Running   0          6m</span><br><span class="line">calico-node-zdq64   2/2       Running   0          6m</span><br><span class="line">calico-node-2hdqf   2/2       Running   0          6m</span><br><span class="line">calico-node-jh6vd   2/2       Running   0          6m</span><br></pre></td></tr></table></figure><h3 id="检查节点状态"><a href="#检查节点状态" class="headerlink" title="检查节点状态"></a>检查节点状态</h3><blockquote><p>网络组件部署完成之后，可以看到node状态已经为<code>Ready</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node </span><br><span class="line">NAME      STATUS    ROLES     AGE       VERSION</span><br><span class="line">k8s-m1    Ready     node      1d        v1.14.3</span><br><span class="line">k8s-m2    Ready     node      1d        v1.14.3</span><br><span class="line">k8s-m3    Ready     node      1d        v1.14.3</span><br><span class="line">k8s-n1    Ready     node      1d        v1.14.3</span><br><span class="line">k8s-n2    Ready     node      1d        v1.14.3</span><br></pre></td></tr></table></figure><h2 id="服务发现组件部署"><a href="#服务发现组件部署" class="headerlink" title="服务发现组件部署"></a>服务发现组件部署</h2><ul><li>kubernetes从v1.11之后，已经使用CoreDNS取代原来的KUBE DNS作为服务发现的组件</li><li>CoreDNS 是由 CNCF 维护的开源 DNS 方案，前身是 SkyDNS</li><li>配置文件以kubeadm生成的YAML文件作为模板，再添加额外配置</li></ul><h3 id="创建工作目录-6"><a href="#创建工作目录-6" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/CoreAddons/coredns</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-7"><a href="#切换工作目录-7" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/CoreAddons/coredns</span><br></pre></td></tr></table></figure><h3 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h3><h4 id="创建yaml文件"><a href="#创建yaml文件" class="headerlink" title="创建yaml文件"></a>创建yaml文件</h4><h4 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/coredns/coredns-sa.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="ConfigMap-1"><a href="#ConfigMap-1" class="headerlink" title="ConfigMap"></a>ConfigMap</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/coredns/coredns-cm.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">          pods insecure</span><br><span class="line">          upstream</span><br><span class="line">          fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/coredns/coredns-rbac.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/coredns/coredns-dp.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity: </span><br><span class="line">          preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - weight: 100</span><br><span class="line">            podAffinityTerm:</span><br><span class="line">              labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                - key: k8s-app </span><br><span class="line">                  operator: In </span><br><span class="line">                  values:</span><br><span class="line">                  - kube-dns</span><br><span class="line">              topologyKey: kubernetes.io/hostname</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - -conf</span><br><span class="line">        - /etc/coredns/Corefile</span><br><span class="line">        image: gcrxio/coredns:1.2.6</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        name: coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 170Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/coredns</span><br><span class="line">          name: config-volume</span><br><span class="line">          readOnly: true</span><br><span class="line">        - mountPath: /etc/localtime</span><br><span class="line">          name: timezone-volume</span><br><span class="line">          readOnly: true</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: CriticalAddonsOnly</span><br><span class="line">        operator: Exists</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/master</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          items:</span><br><span class="line">          - key: Corefile</span><br><span class="line">            path: Corefile</span><br><span class="line">          name: coredns</span><br><span class="line">        name: config-volume</span><br><span class="line">      - hostPath:</span><br><span class="line">          path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class="line">        name: timezone-volume</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/CoreAddons/coredns/coredns-svc.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/port: "9153"</span><br><span class="line">    prometheus.io/scrape: "true"</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    kubernetes.io/name: KubeDNS</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.96.0.10</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">    targetPort: 53</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 53</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="修改yaml文件"><a href="#修改yaml文件" class="headerlink" title="修改yaml文件"></a>修改yaml文件</h4><ul><li>yaml文件里面定义了<code>clusterIP</code>这里需要与<code>kubelet.config.file</code>里面定义的<code>cluster-dns</code>一致</li><li>如果kubelet.conf里面的<code>--cluster-dns</code>改成别的，例如<code>x.x.x.x</code>，这里也要做相应变动，不然Pod找不到DNS，无法正常工作</li><li>这里定义静态的hosts解析，这样Pod可以通过hostname来访问到各节点主机</li><li>用下面的命令根据<code>HostArray</code>的信息生成静态的hosts解析</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sed -e '16r '&lt;(\</span><br><span class="line">    echo '        hosts &#123;'; \</span><br><span class="line">    for NODE in "$&#123;!HostArray[@]&#125;";do \</span><br><span class="line">        echo "          $&#123;HostArray[$NODE]&#125; $NODE"; \</span><br><span class="line">    done;\</span><br><span class="line">    echo '          fallthrough'; \</span><br><span class="line">    echo '        &#125;';) \</span><br><span class="line">-i /root/yaml/CoreAddons/coredns/coredns-cm.yaml</span><br></pre></td></tr></table></figure><ul><li>上面的命令的作用是，通过<code>HostArray</code>的信息生成hosts解析配置，顺序是打乱的，可以手工调整顺序</li><li>也可以手动修改<code>coredns.yaml</code>文件来添加对应字段</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors</span></span><br><span class="line"><span class="string">        log</span></span><br><span class="line"><span class="string">        health</span></span><br><span class="line"><span class="string">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span></span><br><span class="line"><span class="string">          pods insecure</span></span><br><span class="line"><span class="string">          upstream</span></span><br><span class="line"><span class="string">          fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        hosts &#123;</span></span><br><span class="line"><span class="string">          172.16.80.201 k8s-m1</span></span><br><span class="line"><span class="string">          172.16.80.202 k8s-m2</span></span><br><span class="line"><span class="string">          172.16.80.203 k8s-m3</span></span><br><span class="line"><span class="string">          172.16.80.204 k8s-n1</span></span><br><span class="line"><span class="string">          172.16.80.205 k8s-n2</span></span><br><span class="line"><span class="string">          fallthrough</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        prometheus :9153</span></span><br><span class="line"><span class="string">        proxy . /etc/resolv.conf</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure><h4 id="部署CoreDNS"><a href="#部署CoreDNS" class="headerlink" title="部署CoreDNS"></a>部署CoreDNS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/CoreAddons/coredns/</span><br></pre></td></tr></table></figure><h4 id="检查部署状态"><a href="#检查部署状态" class="headerlink" title="检查部署状态"></a>检查部署状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=kube-dns</span><br></pre></td></tr></table></figure><blockquote><p>输出样例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                       READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5566c96697-6gzzc   1/1       Running   0          45s</span><br><span class="line">coredns-5566c96697-q5slk   1/1       Running   0          45s</span><br></pre></td></tr></table></figure><h3 id="验证集群DNS服务"><a href="#验证集群DNS服务" class="headerlink" title="验证集群DNS服务"></a>验证集群DNS服务</h3><ul><li>创建一个deployment测试DNS解析</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/busybox-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: busybox</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: busybox</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: busybox</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: busybox</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        image: busybox:1.26</span><br><span class="line">        command:</span><br><span class="line">        - sleep</span><br><span class="line">        - "36000"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于文件创建deployment</span></span><br><span class="line">kubectl apply -f /root/yaml/busybox-deployment.yaml</span><br></pre></td></tr></table></figure><ul><li>检查deployment部署情况</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">NAME                       READY     STATUS    RESTARTS   AGE</span><br><span class="line">busybox-7b9bfb5658-872gj   1/1       Running   0          6s</span><br></pre></td></tr></table></figure><ul><li>验证集群DNS解析</li><li>上一个命令获取到pod名字为<code>busybox-7b9bfb5658-872gj</code></li><li>通过kubectl命令连接到Pod运行<code>nslookup</code>命令测试使用域名来访问kube-apiserver和各节点主机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">echo "--- 通过CoreDNS访问kubernetes ---"</span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup kubernetes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo "--- 通过CoreDNS访问k8s-m1 ---"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup k8s-m1</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">Name:      k8s-m1</span><br><span class="line">Address 1: 172.16.80.201 k8s-m1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo "--- 通过CoreDNS访问k8s-m2 ---"</span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup k8s-m2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">Name:      k8s-n2</span><br><span class="line">Address 1: 172.16.80.202 k8s-m2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo "--- 通过CoreDNS访问并不存在的k8s-n3 ---"</span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup k8s-n3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">nslookup: can't resolve 'k8s-n3'</span><br></pre></td></tr></table></figure><h2 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h2><ul><li><a href="https://github.com/kubernetes-incubator/metrics-server" target="_blank" rel="noopener">Metrics Server</a><br>是实现了 Metrics API 的元件,其目标是取代 Heapster 作位 Pod 与 Node 提供资源的 Usage<br>metrics,该元件会从每个 Kubernetes 节点上的 Kubelet 所公开的 Summary API 中收集 Metrics</li><li>Horizontal Pod Autoscaler（HPA）控制器用于实现基于CPU使用率进行自动Pod伸缩的功能。</li><li>HPA控制器基于Master的kube-controller-manager服务启动参数–horizontal-pod-autoscaler-sync-period定义是时长（默认30秒）,周期性监控目标Pod的CPU使用率,并在满足条件时对ReplicationController或Deployment中的Pod副本数进行调整,以符合用户定义的平均Pod<br>CPU使用率。</li><li>在新版本的kubernetes中 Pod CPU使用率不在来源于heapster,而是来自于metrics-server</li><li>官网原话是 The –horizontal-pod-autoscaler-use-rest-clients is true or unset. Setting this to false switches to Heapster-based autoscaling, which is deprecated.</li></ul><h3 id="额外参数"><a href="#额外参数" class="headerlink" title="额外参数"></a>额外参数</h3><ul><li>设置kube-apiserver参数，这里在配置kube-apiserver阶段已经加进去了</li><li>front-proxy证书，在证书生成阶段已经完成且已分发</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem</span><br><span class="line">--requestheader-allowed-names=aggregator</span><br><span class="line">--requestheader-group-headers=X-Remote-Group</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">--requestheader-username-headers=X-Remote-User</span><br></pre></td></tr></table></figure><h3 id="创建工作目录-7"><a href="#创建工作目录-7" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/CoreAddons/metrics-server</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-8"><a href="#切换工作目录-8" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/CoreAddons/metrics-server</span><br></pre></td></tr></table></figure><h3 id="下载yaml文件-2"><a href="#下载yaml文件-2" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/v1.14.3/cluster/addons/metrics-server/auth-delegator.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/v1.14.3/cluster/addons/metrics-server/auth-reader.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/v1.14.3/cluster/addons/metrics-server/metrics-apiservice.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/v1.14.3/cluster/addons/metrics-server/metrics-server-service.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/v1.14.3/cluster/addons/metrics-server/resource-reader.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/v1.14.3/cluster/addons/metrics-server/metrics-server-deployment.yaml</span><br></pre></td></tr></table></figure><h3 id="修改metrics-server-deployment"><a href="#修改metrics-server-deployment" class="headerlink" title="修改metrics-server-deployment"></a>修改metrics-server-deployment</h3><ul><li><p>修改镜像地址</p></li><li><p>修改metrics-server启动参数</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">gcrxio/metrics-server-amd64:v0.3.1</span></span><br><span class="line"><span class="attr">  command:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/metrics-server</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--kubelet-preferred-address-types=Hostname,InternalDNS,InternalIP,ExternalDNS,ExternalIP</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--kubelet-insecure-tls</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--requestheader-extra-headers-prefix=x-remote-extra-</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--requestheader-group-headers=x-remote-group</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--requestheader-username-headers=x-remote-user</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">-v=2</span></span><br></pre></td></tr></table></figure><h3 id="修改resource-reader"><a href="#修改resource-reader" class="headerlink" title="修改resource-reader"></a>修改resource-reader</h3><ul><li>默认配置的权限无法获取node节点信息，会提示<code>403 Forbidden</code></li><li>需要在<code>ClusterRole</code>里面的<code>rules[0].resources</code>增加<code>nodes/stats</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:metrics-server</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/stats</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"extensions"</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:metrics-server</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:metrics-server</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><h3 id="部署metrics-server"><a href="#部署metrics-server" class="headerlink" title="部署metrics-server"></a>部署metrics-server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure><h3 id="查看pod状态"><a href="#查看pod状态" class="headerlink" title="查看pod状态"></a>查看pod状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=metrics-server</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/metrics-server-86bd9d7667-5hbn6   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h3 id="验证metrics"><a href="#验证metrics" class="headerlink" title="验证metrics"></a>验证metrics</h3><blockquote><p>完成后,等待一段时间(约 30s - 1m)收集 Metrics</p></blockquote><ul><li>请求metrics api的结果</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get --raw /apis/metrics.k8s.io/v1beta1</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "kind": "APIResourceList",</span><br><span class="line">  "apiVersion": "v1",</span><br><span class="line">  "groupVersion": "metrics.k8s.io/v1beta1",</span><br><span class="line">  "resources": [</span><br><span class="line">    &#123;</span><br><span class="line">      "name": "nodes",</span><br><span class="line">      "singularName": "",</span><br><span class="line">      "namespaced": false,</span><br><span class="line">      "kind": "NodeMetrics",</span><br><span class="line">      "verbs": [</span><br><span class="line">        "get",</span><br><span class="line">        "list"</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "name": "pods",</span><br><span class="line">      "singularName": "",</span><br><span class="line">      "namespaced": true,</span><br><span class="line">      "kind": "PodMetrics",</span><br><span class="line">      "verbs": [</span><br><span class="line">        "get",</span><br><span class="line">        "list"</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>获取节点性能数据</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl top node</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-m1   695m         17%    914Mi           11%       </span><br><span class="line">k8s-m2   360m         9%     553Mi           7%        </span><br><span class="line">k8s-m3   492m         12%    533Mi           6%        </span><br><span class="line">k8s-n1   144m         3%     311Mi           3%        </span><br><span class="line">k8s-n2   149m         3%     321Mi           4%</span><br></pre></td></tr></table></figure><ul><li>获取Pod性能数据</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system top pod</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NAME                                    CPU(cores)   MEMORY(bytes)   </span><br><span class="line">coredns-56c964478c-g7q8n                14m          14Mi            </span><br><span class="line">coredns-56c964478c-zmt2j                13m          14Mi            </span><br><span class="line">kube-flannel-ds-amd64-8g6f9             6m           15Mi            </span><br><span class="line">kube-flannel-ds-amd64-hslkh             6m           21Mi            </span><br><span class="line">kube-flannel-ds-amd64-ppqkb             8m           14Mi            </span><br><span class="line">kube-flannel-ds-amd64-swj8m             7m           14Mi            </span><br><span class="line">kube-flannel-ds-amd64-zs2sd             8m           17Mi            </span><br><span class="line">kube-proxy-2dq5x                        18m          23Mi            </span><br><span class="line">kube-proxy-9lzmj                        28m          23Mi            </span><br><span class="line">kube-proxy-9xtjc                        18m          23Mi            </span><br><span class="line">kube-proxy-w7mtg                        2m           23Mi            </span><br><span class="line">kube-proxy-zvp8d                        2m           21Mi            </span><br><span class="line">metrics-server-v0.3.1-98bdfb766-s6jf6   8m           22Mi</span><br></pre></td></tr></table></figure><p>#############################################################################</p><h1 id="Kubernetes集群已基本可用"><a href="#Kubernetes集群已基本可用" class="headerlink" title="Kubernetes集群已基本可用"></a><font color="red">Kubernetes集群已基本可用</font></h1><p>#############################################################################</p><h1 id="Kubernetes-ExtraAddons"><a href="#Kubernetes-ExtraAddons" class="headerlink" title="Kubernetes ExtraAddons"></a>Kubernetes ExtraAddons</h1><h2 id="说明-14"><a href="#说明-14" class="headerlink" title="说明"></a>说明</h2><ul><li>下面的部署流程，更多的是补充Kubernetes的能力</li><li><font color="red">只记录简单的部署过程，不保证<code>ctrl+c</code>和<code>ctrl+v</code>能直接跑！</font></li></ul><h2 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h2><h3 id="说明-15"><a href="#说明-15" class="headerlink" title="说明"></a>说明</h3><ul><li>Dashboard 是kubernetes社区提供的GUI界面，用于图形化管理kubernetes集群，同时可以看到资源报表。</li><li>官方提供yaml文件直接部署，但是需要更改<code>image</code>以便国内部署</li></ul><h3 id="创建工作目录-8"><a href="#创建工作目录-8" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/ExtraAddons/kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-9"><a href="#切换工作目录-9" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/ExtraAddons/kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="获取yaml文件"><a href="#获取yaml文件" class="headerlink" title="获取yaml文件"></a>获取yaml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure><h3 id="修改镜像地址"><a href="#修改镜像地址" class="headerlink" title="修改镜像地址"></a>修改镜像地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,k8s.gcr.io/kubernetes-dashboard-amd64,gcrxio/kubernetes-dashboard-amd64,g' -i kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure><h3 id="创建kubernetes-Dashboard"><a href="#创建kubernetes-Dashboard" class="headerlink" title="创建kubernetes-Dashboard"></a>创建kubernetes-Dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/ExtraAddons/kubernetes-dashboard/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure><h3 id="创建ServiceAccount-RBAC"><a href="#创建ServiceAccount-RBAC" class="headerlink" title="创建ServiceAccount RBAC"></a>创建ServiceAccount RBAC</h3><ul><li>官方的yaml文件，ServiceAccount绑定的RBAC权限很低，很多资源无法查看</li><li>需要创建一个用于管理全局的ServiceAccount</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在kube-system中创建名为admin-user的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将admin-user和cluster-admin绑定在一起</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-admin是kubernetes内置的clusterrole，具有集群管理员权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他内置的clusterrole可以通过kubectl get clusterrole查看</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="获取ServiceAccount的Token"><a href="#获取ServiceAccount的Token" class="headerlink" title="获取ServiceAccount的Token"></a>获取ServiceAccount的Token</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span><br></pre></td></tr></table></figure><h3 id="查看部署情况"><a href="#查看部署情况" class="headerlink" title="查看部署情况"></a>查看部署情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n kube-system --selector k8s-app=kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="访问Dashboard"><a href="#访问Dashboard" class="headerlink" title="访问Dashboard"></a>访问Dashboard</h3><ul><li>kubernetes-dashborad的svc默认是<code>clusterIP</code>，需要修改为<code>nodePort</code>才能被外部访问</li><li>随机分配<code>NodePort</code>，分配范围由<code>kube-apiserver</code>的<code>--service-node-port-range</code>参数指定</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -n kube-system svc kubernetes-dashboard -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;'</span><br></pre></td></tr></table></figure><ul><li>修改完之后，通过以下命令获取访问kubernetes-Dashboard的端口</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get svc --selector k8s-app=kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.106.183.192   &lt;none&gt;        443:30216/TCP   12s</span><br></pre></td></tr></table></figure><ul><li>可以看到已经将节点的<code>30216</code>端口暴露出来</li><li><p>IP地址不固定，只要运行了kube-proxy组件，都会在节点上添加<code>30216</code>端口规则用于转发请求到Pod</p><ul><li><a href="https://172.16.80.200:30216" target="_blank" rel="noopener">https://172.16.80.200:30216</a></li><li><a href="https://172.16.80.201:30216" target="_blank" rel="noopener">https://172.16.80.201:30216</a></li><li><a href="https://172.16.80.202:30216" target="_blank" rel="noopener">https://172.16.80.202:30216</a></li><li><a href="https://172.16.80.203:30216" target="_blank" rel="noopener">https://172.16.80.203:30216</a></li><li><a href="https://172.16.80.204:30216" target="_blank" rel="noopener">https://172.16.80.204:30216</a></li><li><a href="https://172.16.80.205:30216" target="_blank" rel="noopener">https://172.16.80.205:30216</a></li></ul></li><li><p>登录Dashboard，上面已经获取了token，这里只需要把token的值填入输入框，点击<code>SIGN IN</code>即可登录</p></li></ul><h3 id="Dashboard-UI预览图"><a href="#Dashboard-UI预览图" class="headerlink" title="Dashboard UI预览图"></a>Dashboard UI预览图</h3><p><a href="https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.0/docs/dashboard-ui.png" target="_blank" rel="noopener"><img src="https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.0/docs/dashboard-ui.png" alt="img"></a></p><h2 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h2><h3 id="说明-16"><a href="#说明-16" class="headerlink" title="说明"></a>说明</h3><ul><li>Ingress 是 Kubernetes 中的一个抽象资源，其功能是通过 Web Server 的 Virtual Host<br>概念以域名(Domain Name)方式转发到內部 Service，这避免了使用 Service 中的 NodePort 与<br>LoadBalancer 类型所带來的限制(如 Port 数量上限)，而实现 Ingress 功能则是通过 Ingress Controller<br>来达成，它会负责监听 Kubernetes API 中的 Ingress 与 Service 资源，并在发生资源变化时，根据资源预期的结果来设置 Web Server。</li><li>Ingress Controller 有许多实现可以选择，这里只是列举一小部分<ul><li><a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Ingress NGINX</a>：Kubernetes 官方维护的方案，<font color="red">本次安装使用此方案</font></li><li><a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">kubernetes-ingress</a>：由nginx社区维护的方案，使用社区版nginx和nginx-plus</li><li><a href="https://github.com/containous/traefik" target="_blank" rel="noopener">treafik</a>：一款开源的反向代理与负载均衡工具。它最大的优点是能够与常见的微服务系统直接整合，可以实现自动化动态配置</li></ul></li></ul><h3 id="创建工作目录-9"><a href="#创建工作目录-9" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/ExtraAddons/ingress/ingress-nginx</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-10"><a href="#切换工作目录-10" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/ExtraAddons/ingress/ingress-nginx</span><br></pre></td></tr></table></figure><h3 id="下载yaml文件-3"><a href="#下载yaml文件-3" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubernetes/ingress-nginx/raw/nginx-0.24.1/deploy/mandatory.yaml</span><br><span class="line">wget https://github.com/kubernetes/ingress-nginx/raw/nginx-0.24.1/deploy/provider/baremetal/service-nodeport.yaml</span><br></pre></td></tr></table></figure><h3 id="修改镜像地址-1"><a href="#修改镜像地址-1" class="headerlink" title="修改镜像地址"></a>修改镜像地址</h3><blockquote><p>如果访问quay.io比较缓慢的话，可以修改一下镜像源</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,quay.io/kubernetes-ingress-controller/,zhangguanzhang/quay.io.kubernetes-ingress-controller.,g' \</span><br><span class="line">    -i mandatory.yaml</span><br></pre></td></tr></table></figure><h3 id="创建ingress-nginx"><a href="#创建ingress-nginx" class="headerlink" title="创建ingress-nginx"></a>创建ingress-nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure><h3 id="检查部署情况-2"><a href="#检查部署情况-2" class="headerlink" title="检查部署情况"></a>检查部署情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n ingress-nginx get pod</span><br></pre></td></tr></table></figure><h3 id="访问ingress"><a href="#访问ingress" class="headerlink" title="访问ingress"></a>访问ingress</h3><ul><li>获取ingres的nodeport端口</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n ingress-nginx get svc</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx   NodePort   10.96.250.140   &lt;none&gt;        80:32603/TCP,443:30083/TCP   1m</span><br></pre></td></tr></table></figure><ul><li>默认的backend会返回404</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.16.80.200:32603</span><br><span class="line">curl -k https://172.16.80.200:30083</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default backend - 404</span><br></pre></td></tr></table></figure><p><strong>注意</strong></p><ul><li>这里部署之后，是<code>deployment</code>，且通过<code>nodePort</code>暴露服务</li><li>也可以修改yaml文件，将<code>Ingress-nginx</code>部署为<code>DaemonSet</code><ul><li>使用<code>labels</code>和<code>nodeSelector</code>来指定运行ingress-nginx的节点</li><li>使用<code>hostNetwork=true</code>来共享主机网络命名空间，或者使用<code>hostPort</code>指定主机端口映射</li><li>如果使用<code>hostNetwork</code>共享宿主机网络栈或者<code>hostPort</code>映射宿主机端口，记得要看看有没有端口冲突，否则无法启动</li><li>修改监听端口可以在<code>ingress-nginx</code>启动命令中添加<code>--http-port=8180</code>和<code>--https-port=8543</code>，还有下面的端口定义也相应变更即可</li></ul></li></ul><h3 id="创建kubernetes-Dashboard的Ingress"><a href="#创建kubernetes-Dashboard的Ingress" class="headerlink" title="创建kubernetes-Dashboard的Ingress"></a>创建kubernetes-Dashboard的Ingress</h3><ul><li>kubernetes-Dashboard默认是开启了HTTPS访问的</li><li>ingress-nginx需要以HTTPS的方式反向代理kubernetes-Dashboard</li><li>以HTTP方式访问kubernetes-Dashboard的时候会被重定向到HTTPS</li><li>需要创建HTTPS证书，用于访问ingress-nginx的HTTPS端口</li></ul><h4 id="创建HTTPS证书"><a href="#创建HTTPS证书" class="headerlink" title="创建HTTPS证书"></a>创建HTTPS证书</h4><ul><li>这里的<code>CN=域名/O=域名</code>需要跟后面的ingress主机名匹配</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -days 3650 \</span><br><span class="line">            -newkey rsa:2048 \</span><br><span class="line">            -keyout tls.key \</span><br><span class="line">            -out tls.crt \</span><br><span class="line">            -subj "/CN=dashboard.k8s.local/O=dashboard.k8s.local"</span><br></pre></td></tr></table></figure><h4 id="创建secret对象"><a href="#创建secret对象" class="headerlink" title="创建secret对象"></a>创建secret对象</h4><ul><li>这里将HTTPS证书创建为kubernetes的secret对象<code>dashboard-tls</code></li><li>ingress创建的时候需要加载这个作为HTTPS证书</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system create secret tls dashboard-tls --key ./tls.key --cert ./tls.crt</span><br></pre></td></tr></table></figure><h4 id="创建dashboard-ingress-yaml"><a href="#创建dashboard-ingress-yaml" class="headerlink" title="创建dashboard-ingress.yaml"></a>创建dashboard-ingress.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/secure-backends:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">  - hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">dashboard.k8s.local</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">dashboard-tls</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">dashboard.k8s.local</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">        - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">          backend:</span></span><br><span class="line"><span class="attr">            serviceName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">            servicePort:</span> <span class="number">443</span></span><br></pre></td></tr></table></figure><h4 id="创建ingress"><a href="#创建ingress" class="headerlink" title="创建ingress"></a>创建ingress</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f dashboard-ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="检查ingress"><a href="#检查ingress" class="headerlink" title="检查ingress"></a>检查ingress</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get ingress</span><br><span class="line">NAME                HOSTS                 ADDRESS         PORTS     AGE</span><br><span class="line">dashboard-ingress   dashboard.k8s.local                   80, 443   16m</span><br></pre></td></tr></table></figure><h4 id="访问kubernetes-Dashboard"><a href="#访问kubernetes-Dashboard" class="headerlink" title="访问kubernetes-Dashboard"></a>访问kubernetes-Dashboard</h4><ul><li>修改主机hosts静态域名解析，以本文为例在hosts文件里添加<code>172.16.80.200 dashboard.k8s.local</code></li><li>使用<code>https://dashboard.k8s.local:30083</code>访问kubernetesDashboard了</li><li>添加了TLS之后，访问HTTP会被跳转到HTTPS端口，这里比较坑爹，没法自定义跳转HTTPS的端口</li><li>此处使用的是自签名证书，浏览器会提示不安全，请忽略</li><li>建议搭配<code>external-DNS</code>和<code>LoadBalancer</code>一起食用，效果更佳</li></ul><blockquote><p>效果图</p></blockquote><p><img src="/2019/06/23/./二进制部署Kubernetes-v1-14-x高可用集群\访问kubernetes-dashboard-ingress.png" alt=""></p><h2 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h2><ul><li><a href="http://helm.sh/" target="_blank" rel="noopener">Helm</a>是一个kubernetes应用的包管理工具，用来管理<a href="https://github.com/kubernetes/charts" target="_blank" rel="noopener">charts</a>——预先配置好的安装包资源，有点类似于Ubuntu的APT和CentOS中的yum。</li><li>Helm chart是用来封装kubernetes原生应用程序的yaml文件，可以在你部署应用的时候自定义应用程序的一些metadata，便与应用程序的分发。</li><li>Helm和charts的主要作用：<ul><li>应用程序封装</li><li>版本管理</li><li>依赖检查</li><li>便于应用程序分发</li></ul></li></ul><h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h3><ul><li>kubernetes v1.6及以上的版本，启用RBAC</li><li>集群可以访问到chart仓库</li><li>helm客户端主机能访问kubernetes集群</li></ul><h3 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h3><p>安装方式二选一，需要科学上网</p><h4 id="直接脚本安装"><a href="#直接脚本安装" class="headerlink" title="直接脚本安装"></a>直接脚本安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://git.io/get_helm.sh | bash</span><br></pre></td></tr></table></figure><h4 id="下载二进制文件安装"><a href="#下载二进制文件安装" class="headerlink" title="下载二进制文件安装"></a>下载二进制文件安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="创建RBAC规则-2"><a href="#创建RBAC规则-2" class="headerlink" title="创建RBAC规则"></a>创建RBAC规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="安装服务端"><a href="#安装服务端" class="headerlink" title="安装服务端"></a>安装服务端</h3><ul><li>helm官方charts仓库 <a href="https://kubernetes-charts.storage.googleapis.com/" target="_blank" rel="noopener">https://kubernetes-charts.storage.googleapis.com/</a> 需要翻墙访问</li><li>这里指定了helm的stable repo国内镜像地址，使用的是微软Azure的源</li><li>具体说明请看<a href="http://mirror.azure.cn/help/kubernetes.html" target="_blank" rel="noopener">这里</a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image gcrxio/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h3 id="检查安装情况"><a href="#检查安装情况" class="headerlink" title="检查安装情况"></a>检查安装情况</h3><h4 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h4 id="查看helm版本"><a href="#查看helm版本" class="headerlink" title="查看helm版本"></a>查看helm版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h1 id="本文至此结束"><a href="#本文至此结束" class="headerlink" title="本文至此结束"></a>本文至此结束</h1><h2 id="说明-17"><a href="#说明-17" class="headerlink" title="说明"></a>说明</h2><p>在【<a href="https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.x 高可用集群.html">二进制部署 kubernetes v1.11.x 高可用集群</a>】里面对于ExtraAddons有额外的一些内容，例如<code>Rook</code>、<code>Prometheus-Operator</code>、<code>ExternalDNS</code>、<code>EFK</code>等等重新做整理适配实在是太麻烦了。后面再考虑另起文章专门来记录这些内容。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;font color=&quot;red&quot;&gt;只记录部署过程，不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/co
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
      <category term="Docker" scheme="https://luanlengli.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>kubeadm部署kubernetes-v1.13.x集群</title>
    <link href="https://luanlengli.github.io/2019/06/12/kubeadm%E9%83%A8%E7%BD%B2kubernetes-1.13.x%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2019/06/12/kubeadm部署kubernetes-1.13.x集群.html</id>
    <published>2019-06-12T08:56:50.000Z</published>
    <updated>2019-08-05T03:03:31.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>根据kubernetes v1.13的<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md#kubernetes-113-release-notes" target="_blank" rel="noopener">Release Note</a>说明</p><p>从Kubernetes v1.13.x开始，kubeadm的<code>kubeadm.k8s.io/v1alpha3</code>被标记为废弃并将于kubernetes v1.14版开始被移除，新的apiVersion为<code>kubeadm.k8s.io/v1beta1</code></p><p>这里是关于<code>kubeadm.k8s.io/v1beta1</code>的<a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta1" target="_blank" rel="noopener">说明文档</a></p><p>下面演示环境使用1个master节点+2个node节点部署kubernetes集群</p><p>仅记录我的部署流程，不一定满足各种需求，自己看菜吃饭！</p></blockquote><h1 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h1><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th><th>操作系统</th><th>Docker版本</th><th>kubeadm版本</th></tr></thead><tbody><tr><td>k8s-master</td><td>172.16.80.200</td><td>master+node</td><td>CentOS-7.6.1810</td><td>18.09.6</td><td>v1.13.7</td></tr><tr><td>k8s-node1</td><td>172.16.80.201</td><td>node</td><td>CentOS-7.6.1810</td><td>18.09.6</td><td>v1.13.7</td></tr><tr><td>k8s-node2</td><td>172.16.80.202</td><td>node</td><td>CentOS-7.6.1810</td><td>18.09.6</td><td>v1.13.7</td></tr></tbody></table><h1 id="服务器初始化"><a href="#服务器初始化" class="headerlink" title="服务器初始化"></a>服务器初始化</h1><blockquote><p>参考<a href="https://luanlengli.github.io/2018/12/05/CentOS-7-6-1810-虚拟机模板制作.html">CentOS-7.6(1810)虚拟机模板制作</a></p></blockquote><h2 id="配置-etc-hosts"><a href="#配置-etc-hosts" class="headerlink" title="配置/etc/hosts"></a>配置/etc/hosts</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1   localhost</span><br><span class="line">::1         localhost</span><br><span class="line">172.16.80.200 k8s-master</span><br><span class="line">172.16.80.201 k8s-node1</span><br><span class="line">172.16.80.202 k8s-node2</span><br></pre></td></tr></table></figure><h2 id="禁用swap分区"><a href="#禁用swap分区" class="headerlink" title="禁用swap分区"></a>禁用swap分区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab</span><br></pre></td></tr></table></figure><h1 id="部署kubernetes集群"><a href="#部署kubernetes集群" class="headerlink" title="部署kubernetes集群"></a>部署kubernetes集群</h1><h2 id="创建YUM源"><a href="#创建YUM源" class="headerlink" title="创建YUM源"></a>创建YUM源</h2><blockquote><p>使用阿里云的kubernetes YUM源</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></table></figure><h2 id="刷新YUM缓存"><a href="#刷新YUM缓存" class="headerlink" title="刷新YUM缓存"></a>刷新YUM缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h2 id="安装kubernetes-v1-13-7"><a href="#安装kubernetes-v1-13-7" class="headerlink" title="安装kubernetes-v1.13.7"></a>安装kubernetes-v1.13.7</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install kubeadm-1.13.7-0.x86_64 kubelet-1.13.7-0.x86_64 kubectl-1.13.7-0.x86_64 cri-tools-1.12.0-0.x86_64 kubernetes-cni-0.7.5-0.x86_64</span><br></pre></td></tr></table></figure><h2 id="添加bash自动补全命令"><a href="#添加bash自动补全命令" class="headerlink" title="添加bash自动补全命令"></a>添加bash自动补全命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm completion bash &gt; /etc/bash_completion.d/kubeadm</span><br><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br></pre></td></tr></table></figure><h2 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h2><p>kubeadm的配置文件被拆分成了以下几个类型</p><ul><li><code>InitConfiguration</code></li><li><code>ClusterConfiguration</code></li><li><code>KubeletConfiguration</code></li><li><code>KubeProxyConfiguration</code></li><li><code>JoinConfiguration</code></li></ul><p>对应到配置文件里面的格式如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">JoinConfiguration</span></span><br></pre></td></tr></table></figure><h2 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h2><blockquote><p>kubeadm命令可以打印<code>InitConfiguration</code>、<code>ClusterConfiguration</code>和<code>JoinConfiguration</code>的默认配置</p></blockquote><h3 id="init-defaults"><a href="#init-defaults" class="headerlink" title="init-defaults"></a>init-defaults</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults</span><br></pre></td></tr></table></figure><h4 id="输出示例"><a href="#输出示例" class="headerlink" title="输出示例"></a>输出示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="attr">- groups:</span></span><br><span class="line"><span class="attr">  - system:</span><span class="attr">bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="attr">  token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">  ttl:</span> <span class="number">24</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">  usages:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">signing</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line"><span class="attr">  advertiseAddress:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line"><span class="attr">  bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="attr">  taints:</span></span><br><span class="line"><span class="attr">  - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line"><span class="attr">  timeoutForControlPlane:</span> <span class="number">4</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">controllerManager:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.13.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line"><span class="attr">  dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="attr">  podSubnet:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h3 id="join-defaults"><a href="#join-defaults" class="headerlink" title="join-defaults"></a>join-defaults</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print join-defaults</span><br></pre></td></tr></table></figure><h4 id="输出示例-1"><a href="#输出示例-1" class="headerlink" title="输出示例"></a>输出示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">caCertPath:</span> <span class="string">/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">  bootstrapToken:</span></span><br><span class="line"><span class="attr">    apiServerEndpoint:</span> <span class="attr">kube-apiserver:6443</span></span><br><span class="line"><span class="attr">    token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">    unsafeSkipCAVerification:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  timeout:</span> <span class="number">5</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">  tlsBootstrapToken:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">JoinConfiguration</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-master</span></span><br></pre></td></tr></table></figure><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><blockquote><p>对于没有设置或者配置了一部分的参数，kubeadm会使用默认值</p><p>这里精简了很多配置，自己决定是否增加配置！</p></blockquote><p><code>kubeadm-init.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># InitConfiguration影响master节点初始化时，kubelet的配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="comment"># bootstrapTokens:</span></span><br><span class="line"><span class="comment"># - groups:</span></span><br><span class="line"><span class="comment">#   - system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="comment">#   token: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="comment">#   ttl: 24h0m0s</span></span><br><span class="line"><span class="comment">#   usages:</span></span><br><span class="line"><span class="comment">#   - signing</span></span><br><span class="line"><span class="comment">#   - authentication</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="comment"># master节点默认会加taints</span></span><br><span class="line"><span class="attr">  taints:</span></span><br><span class="line"><span class="attr">  - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">  kubeletExtraArgs:</span></span><br><span class="line"><span class="attr">    pod-infra-container-image:</span> <span class="string">"k8s.gcr.io/pause:3.1"</span></span><br><span class="line"><span class="attr">    network-plugin:</span> <span class="string">cni</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubeadm生成证书、manifest目录、staticPod的配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="comment"># kube-apiserver配置</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line"><span class="attr">  timeoutForControlPlane:</span> <span class="number">4</span><span class="string">m0s</span></span><br><span class="line">  <span class="comment"># 配置证书的SANs</span></span><br><span class="line"><span class="attr">  certSANs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">localhost</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes.default</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes.default.svc</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.200</span></span><br><span class="line">  <span class="comment"># 配置apiserver启动参数</span></span><br><span class="line"><span class="attr">  extraArgs:</span></span><br><span class="line"><span class="attr">    authorization-mode:</span> <span class="string">"Node,RBAC"</span></span><br><span class="line"><span class="attr">    runtime-config:</span> <span class="string">"api/all=true"</span></span><br><span class="line">  <span class="comment"># 配置apiserver容器挂载volume</span></span><br><span class="line"><span class="attr">  extraVolumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"timezone-volume"</span></span><br><span class="line"><span class="attr">    hostPath:</span> <span class="string">"/usr/share/zoneinfo/Asia/Shanghai"</span></span><br><span class="line"><span class="attr">    mountPath:</span> <span class="string">"/etc/localtime"</span></span><br><span class="line"><span class="attr">    readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    pathType:</span> <span class="string">File</span></span><br><span class="line"><span class="comment"># 配置证书目录</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="comment"># 配置集群名字</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">""</span></span><br><span class="line"><span class="comment"># kube-controller-manager配置</span></span><br><span class="line"><span class="attr">controllerManager:</span></span><br><span class="line">  <span class="comment"># 配置controller-manager启动参数</span></span><br><span class="line"><span class="attr">  extraArgs:</span></span><br><span class="line"><span class="attr">    address:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="attr">  extraVolumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"timezone-volume"</span></span><br><span class="line"><span class="attr">    hostPath:</span> <span class="string">"/usr/share/zoneinfo/Asia/Shanghai"</span></span><br><span class="line"><span class="attr">    mountPath:</span> <span class="string">"/etc/localtime"</span></span><br><span class="line"><span class="attr">    readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    pathType:</span> <span class="string">File</span></span><br><span class="line"><span class="comment"># kubernetes集群dns配置</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="comment"># 类型可选 CoreDNS 或者 kube-dns</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">  imageRepository:</span> <span class="string">"k8s.gcr.io"</span></span><br><span class="line"><span class="attr">  imageTag:</span> <span class="string">"1.2.6"</span></span><br><span class="line"><span class="comment"># etcd配置</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="comment"># local和external配置是冲突的，二选一</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    imageRepository:</span> <span class="string">"k8s.gcr.io"</span></span><br><span class="line"><span class="attr">    imageTag:</span> <span class="string">"3.2.24"</span></span><br><span class="line">    <span class="comment"># etcd数据目录</span></span><br><span class="line"><span class="attr">    dataDir:</span> <span class="string">"/var/lib/etcd"</span></span><br><span class="line"><span class="attr">    extraArgs:</span></span><br><span class="line"><span class="attr">      advertise-client-urls:</span> <span class="string">"https://172.16.80.200:2379"</span></span><br><span class="line"><span class="attr">      listen-client-urls:</span> <span class="string">"https://127.0.0.1:2379,https://172.16.80.200:2379"</span></span><br><span class="line"><span class="attr">      listen-peer-urls:</span> <span class="string">"https://172.16.80.200:2380"</span></span><br><span class="line">    <span class="comment"># 配置etcd server证书的SAN</span></span><br><span class="line"><span class="attr">    serverCertSANs:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">localhost</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">::1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.200</span></span><br><span class="line">    <span class="comment"># 配置etcd peer证书的SAN</span></span><br><span class="line"><span class="attr">    peerCertSANs:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">localhost</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">::1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.200</span></span><br><span class="line">  <span class="comment"># local和external配置是冲突的，二选一</span></span><br><span class="line">  <span class="comment"># external:</span></span><br><span class="line">  <span class="comment">#   endpoints:</span></span><br><span class="line">  <span class="comment">#   - "https://etcd_1:2379"</span></span><br><span class="line">  <span class="comment">#   - "https://etcd_2:2379"</span></span><br><span class="line">  <span class="comment">#   - "https://etcd_3:2379"</span></span><br><span class="line">  <span class="comment">#   caFile: "/path/to/etcd-ca.crt"</span></span><br><span class="line">  <span class="comment">#   certFile: "/path/to/etcd-client.crt"</span></span><br><span class="line">  <span class="comment">#   keyFile: "/path/to/etcd-client.key"</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">"v1.13.7"</span></span><br><span class="line"><span class="comment"># kubernetes网络配置</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="comment"># DNS域名</span></span><br><span class="line"><span class="attr">  dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="comment"># Pod网络</span></span><br><span class="line"><span class="attr">  podSubnet:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line">  <span class="comment"># Service网络</span></span><br><span class="line"><span class="attr">  serviceSubnet:</span> <span class="string">"10.96.0.0/12"</span></span><br><span class="line"><span class="comment"># kube-scheduler配置</span></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line"><span class="attr">  extraArgs:</span></span><br><span class="line"><span class="attr">    address:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="attr">  extraVolumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"timezone-volume"</span></span><br><span class="line"><span class="attr">    hostPath:</span> <span class="string">"/usr/share/zoneinfo/Asia/Shanghai"</span></span><br><span class="line"><span class="attr">    mountPath:</span> <span class="string">"/etc/localtime"</span></span><br><span class="line"><span class="attr">    readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    pathType:</span> <span class="string">File</span></span><br><span class="line"><span class="comment"># 是否使用HyperKube镜像</span></span><br><span class="line"><span class="comment"># hyperkube包含所有kubernetes的二进制文件,实现单二进制文件运行所有kubernetes服务</span></span><br><span class="line"><span class="attr">useHyperKubeImage:</span> <span class="literal">false</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 配置kubelet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="comment"># 默认配置下，kubelet检测到系统启用了swap会启动失败</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">110</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 配置kube-proxy</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">configSyncPeriod:</span> <span class="number">15</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">ipvs:</span></span><br><span class="line"><span class="attr">  scheduler:</span> <span class="string">"rr"</span></span><br><span class="line"><span class="comment"># 可选iptables或者ipvs</span></span><br><span class="line"><span class="comment"># iptables性能好兼容性好</span></span><br><span class="line"><span class="comment"># ipvs大规模场景下性能更好</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">"ipvs"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 这里的配置影响kubeadm join的节点上运行的kubelet参数</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">JoinConfiguration</span></span><br><span class="line"><span class="comment">#caCertPath: /etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="comment">#discovery:</span></span><br><span class="line"><span class="comment">#  bootstrapToken:</span></span><br><span class="line"><span class="comment">#    apiServerEndpoint: kube-apiserver:6443</span></span><br><span class="line"><span class="comment">#    token: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="comment">#    unsafeSkipCAVerification: true</span></span><br><span class="line"><span class="comment">#  timeout: 5m0s</span></span><br><span class="line"><span class="comment">#  tlsBootstrapToken: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  kubeletExtraArgs:</span></span><br><span class="line"><span class="attr">    pod-infra-container-image:</span> <span class="string">"k8s.gcr.io/pause:3.1"</span></span><br><span class="line"><span class="attr">    network-plugin:</span> <span class="string">cni</span></span><br></pre></td></tr></table></figure><h2 id="检查配置文件"><a href="#检查配置文件" class="headerlink" title="检查配置文件"></a>检查配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-init.yaml --dry-run</span><br></pre></td></tr></table></figure><blockquote><p>命令执行完毕，可以在<code>/tmp/kubeadm-init-dryrun*</code>里面看到生成的配置文件</p><p>可以检查一下是否符合预期！</p></blockquote><h2 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-init.yaml</span><br></pre></td></tr></table></figure><blockquote><p>集群初始化完成之后，终端会打印出信息</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 172.16.80.200:6443 --token uqc4n7.mfs4ep1br9l9ztsi --discovery-token-ca-cert-hash sha256:b30dd4d598baf1a3a53fe794d02302788e71e4314947cf7df5a75e98dd2ed97a</span><br></pre></td></tr></table></figure><h2 id="节点加入集群"><a href="#节点加入集群" class="headerlink" title="节点加入集群"></a>节点加入集群</h2><blockquote><p>运行kubeadm init初始化集群之后的提供的join命令，将节点加入集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 172.16.80.200:6443 --token uqc4n7.mfs4ep1br9l9ztsi --discovery-token-ca-cert-hash sha256:b30dd4d598baf1a3a53fe794d02302788e71e4314947cf7df5a75e98dd2ed97a</span><br></pre></td></tr></table></figure><h2 id="查看节点信息"><a href="#查看节点信息" class="headerlink" title="查看节点信息"></a>查看节点信息</h2><blockquote><p>还没部署CNI插件，所以节点状态为NotReady</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure><ul><li>输出示例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME         STATUS     ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME</span><br><span class="line">k8s-master   NotReady   master   4m45s   v1.13.7   172.16.80.200   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node1    NotReady   &lt;none&gt;   4m18s   v1.13.7   172.16.80.201   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node2    NotReady   &lt;none&gt;   4m17s   v1.13.7   172.16.80.202   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br></pre></td></tr></table></figure><h2 id="部署CNI插件"><a href="#部署CNI插件" class="headerlink" title="部署CNI插件"></a>部署CNI插件</h2><blockquote><p>这里用flannel</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><ul><li>查看节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure><blockquote><p>可以看到节点状态为Ready</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME         STATUS   ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME</span><br><span class="line">k8s-master   Ready    master   7m13s   v1.13.7   172.16.80.200   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node1    Ready    &lt;none&gt;   6m46s   v1.13.7   172.16.80.201   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node2    Ready    &lt;none&gt;   6m45s   v1.13.7   172.16.80.202   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br></pre></td></tr></table></figure><ul><li>查看Pod信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces -o wide --sort-by=.spec.nodeName</span><br></pre></td></tr></table></figure><blockquote><p>这里根据节点名字作为排序依据来输出结果</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   etcd-k8s-master                      1/1     Running   0          6m56s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master            1/1     Running   0          7m13s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master   1/1     Running   0          7m5s    172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-kccsf          1/1     Running   0          2m27s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-m68d5                     1/1     Running   0          7m56s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master            1/1     Running   0          7m1s    172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-86c58d9df4-jv465             1/1     Running   0          7m56s   10.244.1.2      k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-86c58d9df4-td2nl             1/1     Running   0          7m56s   10.244.1.3      k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-s9pds          1/1     Running   0          2m27s   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-l67jr                     1/1     Running   0          7m48s   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-r6h8s          1/1     Running   0          2m27s   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-pjz5w                     1/1     Running   0          7m47s   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="master节点参与负载"><a href="#master节点参与负载" class="headerlink" title="master节点参与负载"></a>master节点参与负载</h2><blockquote><p>kubeadm部署的kubernetes集群，出于安全考虑，在初始化集群后会给master节点打上<code>node-role.kubernetes.io/master:NoSchedule</code>污点，避免Pod被调度到master节点。</p><p>作为实验环境，可以去除污点，让Pod可以调度到master节点</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes k8s-master node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure><h1 id="至此kubernetes集群已经搭建完成"><a href="#至此kubernetes集群已经搭建完成" class="headerlink" title="至此kubernetes集群已经搭建完成"></a>至此kubernetes集群已经搭建完成</h1><blockquote><p>最简化的部署！！！！</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;根据kubernetes v1.13的&lt;a href=&quot;https://github.com/kubernetes/
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Redis安装部署记录</title>
    <link href="https://luanlengli.github.io/2019/06/03/Redis%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95.html"/>
    <id>https://luanlengli.github.io/2019/06/03/Redis安装部署记录.html</id>
    <published>2019-06-03T09:19:48.000Z</published>
    <updated>2019-11-21T02:45:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>仅记录安装部署过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>可以跑起来，自己判断哪些要改的！</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>Redis版本使用<code>4.0.14</code></p><font color="red">【根据自己的环境灵活调整，生产环境请务必提供独立数据盘！】</font></blockquote><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's,SELINUX=enforcing,SELINUX=disabled,' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure><h2 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-redis.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在CentOS7.4引入了一个新的参数来控制内核的行为。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /proc/sys/fs/may_detach_mounts 默认设置为0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统有容器运行的时候，需要将该值设置为1。</span></span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1024000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改动态NAT跟踪记录参数</span></span><br><span class="line">net.netfilter.nf_conntrack_max = 655350</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=512</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核允许超量使用内存直到用完为止</span></span><br><span class="line">vm.overcommit_memory = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-redis.conf &lt;&lt;EOF</span><br><span class="line">* soft nproc 1048576</span><br><span class="line">* hard nproc 1048576</span><br><span class="line">* soft nofile 1048576</span><br><span class="line">* hard nofile 1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改journal设置"><a href="#修改journal设置" class="headerlink" title="修改journal设置"></a>修改journal设置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#Compress=yes,Compress=yes,' \</span><br><span class="line">    -e 's,^#SystemMaxUse=,SystemMaxUse=1G,' \</span><br><span class="line">    -e 's,^#Seal=yes,Seal=yes,' \</span><br><span class="line">    -e 's,^#RateLimitBurst=1000,RateLimitBurst=2000,' \</span><br><span class="line">    -i /etc/systemd/journald.conf</span><br></pre></td></tr></table></figure><h2 id="更新系统软件"><a href="#更新系统软件" class="headerlink" title="更新系统软件"></a>更新系统软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc make jemalloc tcl -y</span><br></pre></td></tr></table></figure><h1 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h1><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd redis</span><br><span class="line">useradd -g redis -s /bin/false redis</span><br></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/software /opt/redis-data</span><br></pre></td></tr></table></figure><h2 id="下载Redis代码"><a href="#下载Redis代码" class="headerlink" title="下载Redis代码"></a>下载Redis代码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-4.0.14.tar.gz -O - | tar xz --directory=/opt/software/</span><br></pre></td></tr></table></figure><h2 id="创建软链接"><a href="#创建软链接" class="headerlink" title="创建软链接"></a>创建软链接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sv /opt/software/redis-4.0.14 /opt/software/redis</span><br></pre></td></tr></table></figure><h2 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/software/redis</span><br></pre></td></tr></table></figure><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make MALLOC=jemalloc &amp;&amp; make test &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/redis-data/redis.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听地址</span></span><br><span class="line">bind 0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 2048</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否以守护进程的方式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode yes</span><br><span class="line">supervised no</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置Redis有多少数据库</span></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义数据目录</span></span><br><span class="line">dir "/opt/redis-data"</span><br><span class="line">dbfilename "dump_6379.rdb"</span><br><span class="line">pidfile "/opt/redis-data/redis_6379.pid"</span><br><span class="line">logfile "/opt/redis-data/redis_6379.log"</span><br><span class="line">loglevel notice</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义访问redis的密码</span></span><br><span class="line">requirepass "abcd1234"</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename "redis_6379.aof"</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制最大内存使用量</span></span><br><span class="line">maxmemory 4gb</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改目录权限"><a href="#修改目录权限" class="headerlink" title="修改目录权限"></a>修改目录权限</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R redis:redis /opt/redis-data</span><br></pre></td></tr></table></figure><h2 id="启动Redis"><a href="#启动Redis" class="headerlink" title="启动Redis"></a>启动Redis</h2><blockquote><p>这里以前台方式运行Redis，查看输出日志，确认是否正常运行</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "/usr/local/bin/redis-server /opt/redis-data/redis.conf --daemonize no" redis</span><br></pre></td></tr></table></figure><h2 id="systemd服务"><a href="#systemd服务" class="headerlink" title="systemd服务"></a>systemd服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis In-Memory Data Store</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">ExecStart=/usr/local/bin/redis-server /opt/redis-data/redis.conf --daemonize no</span><br><span class="line">ExecStop=/usr/local/bin/redis-cli -a abcd1234 shutdown</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="设置开机自启动"><a href="#设置开机自启动" class="headerlink" title="设置开机自启动"></a>设置开机自启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable redis.service</span><br><span class="line">systemctl start redis.service</span><br></pre></td></tr></table></figure><h1 id="验证功能"><a href="#验证功能" class="headerlink" title="验证功能"></a>验证功能</h1><h2 id="登录redis"><a href="#登录redis" class="headerlink" title="登录redis"></a>登录redis</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -p 6379</span><br></pre></td></tr></table></figure><h2 id="认证登录"><a href="#认证登录" class="headerlink" title="认证登录"></a>认证登录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis&gt;</span><span class="bash"> auth abcd1234</span></span><br><span class="line">ok</span><br></pre></td></tr></table></figure><h2 id="测试功能"><a href="#测试功能" class="headerlink" title="测试功能"></a>测试功能</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis&gt;</span><span class="bash"> ping</span></span><br><span class="line">"PONG"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;仅记录安装部署过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/code&gt;
      
    
    </summary>
    
    
      <category term="Redis" scheme="https://luanlengli.github.io/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>MySQL基于PXC方案实现数据库HA</title>
    <link href="https://luanlengli.github.io/2019/05/31/MySQL%E5%9F%BA%E4%BA%8EPXC%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93HA.html"/>
    <id>https://luanlengli.github.io/2019/05/31/MySQL基于PXC方案实现数据库HA.html</id>
    <published>2019-05-31T02:59:42.000Z</published>
    <updated>2019-06-04T06:35:46.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>仅记录安装部署过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>可以跑起来，自己判断哪些要改的！</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>Percona XtraDB Cluster版本使用<code>57-5.7.25-31.35.1.el7</code></p><font color="red">【根据自己的环境灵活调整，生产环境请务必提供独立数据盘！】</font></blockquote><h1 id="集群架构模型"><a href="#集群架构模型" class="headerlink" title="集群架构模型"></a>集群架构模型</h1><p><img src="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/_images/cluster-diagram1.png" alt=""></p><h1 id="多主复制模型"><a href="#多主复制模型" class="headerlink" title="多主复制模型"></a>多主复制模型</h1><p><img src="https://www.percona.com/doc/percona-xtradb-cluster/5.7/_images/certificationbasedreplication.png" alt=""></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h2><table><thead><tr><th>主机名</th><th>IP地址</th></tr></thead><tbody><tr><td>db1</td><td>172.16.80.201</td></tr><tr><td>db2</td><td>172.16.80.202</td></tr><tr><td>db3</td><td>172.16.80.203</td></tr></tbody></table><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's,SELINUX=enforcing,SELINUX=disabled,' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl mask firewalld</span><br></pre></td></tr></table></figure><h2 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-centos.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max = 1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open = 1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个共享内存段的最大值，这里设置为物理内存大小的一半</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算方式，以2G内存为例</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2048 / 2 * 1024 * 1024 = 1073741824</span></span><br><span class="line">kernel.shmmax = 1073741824</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据接收窗口（字节）</span></span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据发送窗口（字节）</span></span><br><span class="line">net.core.wmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据接收窗口大小（字节）</span></span><br><span class="line">net.core.rmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据发送窗口大小（字节）</span></span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改动态NAT跟踪记录参数</span></span><br><span class="line">net.netfilter.nf_conntrack_max = 655350</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置主动发起连接时，端口范围，默认值32768-60000</span></span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统pagecache脏页达到系统内存dirty_ratio的百分比值时，会阻塞新的写请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 直到内存脏页落盘</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为30</span></span><br><span class="line">vm.dirty_ratio = 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="limits参数"><a href="#limits参数" class="headerlink" title="limits参数"></a>limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-mysql.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile  655360</span><br><span class="line">* hard nofile  655360</span><br><span class="line">* soft nproc   655360</span><br><span class="line">* hard nproc   655360</span><br><span class="line">* soft stack   unlimited</span><br><span class="line">* hard stack   unlimited</span><br><span class="line">* soft memlock 250000000</span><br><span class="line">* hard memlock 250000000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="更新系统软件"><a href="#更新系统软件" class="headerlink" title="更新系统软件"></a>更新系统软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="重启服务器"><a href="#重启服务器" class="headerlink" title="重启服务器"></a>重启服务器</h2><blockquote><p>可选</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><h2 id="获取安装包"><a href="#获取安装包" class="headerlink" title="获取安装包"></a>获取安装包</h2><blockquote><p>可以通过配置YUM源或者直接下载RPM包安装</p></blockquote><h3 id="配置YUM源"><a href="#配置YUM源" class="headerlink" title="配置YUM源"></a>配置YUM源</h3><ul><li>YUM源配置方法可以看<a href="https://www.percona.com/doc/percona-repo-config/percona-release.html#rpm-based-gnu-linux-distributions" target="_blank" rel="noopener">官方教程</a></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br><span class="line">yum install -y Percona-XtraDB-Cluster-full-57</span><br></pre></td></tr></table></figure><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><ul><li>官方下载页面链接在<a href="https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/" target="_blank" rel="noopener">这里</a></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-devel-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-client-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-full-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-test-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-server-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-shared-compat-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-shared-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.14/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.14-1.el7.x86_64.rpm</span><br><span class="line">wget http://repo.percona.com/percona/yum/release/7/RPMS/x86_64/qpress-11-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><ul><li>手动安装YUM包</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall -y *rpm</span><br></pre></td></tr></table></figure><h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><blockquote><font color="red">注意！</font><p>这里的初始化操作可以在集群任意节点进行，这里为了方便，在<code>db1</code>上进行操作</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql.service</span><br></pre></td></tr></table></figure><blockquote><p>启动完成后之后，需要获取临时密码</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep 'temporary password' /var/log/mysqld.log</span><br></pre></td></tr></table></figure><blockquote><p>使用<code>mysql_secure_installation</code>初始化MySQL数据库</p><ul><li>修改root密码</li><li>修改密码复杂度要求</li><li>禁止root远程登录</li><li>删除匿名用户和测试数据</li><li>刷新权限</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_install</span><br></pre></td></tr></table></figure><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><blockquote><p>创建SST用户并授权</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'sstuser'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'sstuser_password'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> RELOAD, <span class="keyword">LOCK</span> <span class="keyword">TABLES</span>, PROCESS, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'sstuser'</span>@<span class="string">'localhost'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure><blockquote><p>关闭数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysql.service</span><br></pre></td></tr></table></figure><h2 id="配置Galera"><a href="#配置Galera" class="headerlink" title="配置Galera"></a>配置Galera</h2><blockquote><p>配置过程参照<a href="https://www.percona.com/doc/percona-xtradb-cluster/5.7/configure.html#configure" target="_blank" rel="noopener">官方文档</a></p><p>额外定义一些参数</p></blockquote><h3 id="节点1"><a href="#节点1" class="headerlink" title="节点1"></a>节点1</h3><blockquote><p>清理一下配置文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find /etc/my.cnf.d/ -type f -name *cnf</span><br><span class="line">find /etc/percona-xtradb-cluster.conf.d/ -type f -name *cnf</span><br></pre></td></tr></table></figure><blockquote><p>将配置内容合并</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Template my.cnf <span class="keyword">for</span> PXC</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Edit to your requirements.</span></span><br><span class="line">[client]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义客户端从哪里获取mysql.sock的路径</span></span><br><span class="line">socket=/var/run/mysqld/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt="\u@db1 \R:\m:\s [\d]&gt; "</span><br><span class="line">no-auto-rehash</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听地址</span></span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">port = 3306</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认数据库引擎</span></span><br><span class="line">default-storage-engine = innodb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 字符集</span></span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 排序规则</span></span><br><span class="line">collation-server = utf8mb4_general_ci</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大连接数</span></span><br><span class="line">max_connections = 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制打开文件数</span></span><br><span class="line">open_files_limit = 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> server-id每个服务器唯一即可，一般用IP末位数字</span></span><br><span class="line">server-id = 201</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认时区</span></span><br><span class="line">default-time-zone = '+8:00'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置数据库事务隔离级别</span></span><br><span class="line">transaction_isolation = REPEATABLE-READ</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置超时时间</span></span><br><span class="line">interactive_timeout = 600</span><br><span class="line">wait_timeout = 600</span><br><span class="line">connect_timeout = 20</span><br><span class="line">lock_wait_timeout = 3600</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制数据库服务器接收数据包的大小</span></span><br><span class="line">max_allowed_packet = 64M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置排序和join的buffer大小</span></span><br><span class="line">sort_buffer_size = 4M</span><br><span class="line">join_buffer_size = 4M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里定义数据目录和日志目录</span></span><br><span class="line">datadir = /var/lib/mysql/</span><br><span class="line">socket = /var/run/mysql/mysql.sock</span><br><span class="line">log-error = /var/log/mysql/error.log</span><br><span class="line">pid-file = /var/run/mysql/mysqld.pid</span><br><span class="line">log-bin = /var/lib/mysql/mybinlog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置binlog</span></span><br><span class="line">binlog_format = ROW</span><br><span class="line">expire_logs_days = 7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启binlog校验功能</span></span><br><span class="line">binlog_checksum = 1</span><br><span class="line">binlog_cache_size = 4M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每1次提交变更后立刻将binlog落盘</span></span><br><span class="line">sync_binlog = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置performance_schema</span></span><br><span class="line">performance_schema = on</span><br><span class="line">performance_schema_instrument = '%memory%=on'</span><br><span class="line">performance_schema_instrument = '%lock%=on'</span><br><span class="line">skip-external-locking = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用域名解析</span></span><br><span class="line">skip-name-resolve = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用软链接</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line">back_log = 1024</span><br><span class="line"><span class="meta">#</span><span class="bash"> 慢日志查询配置</span></span><br><span class="line">slow_query_log = 1</span><br><span class="line">long_query_time = 1</span><br><span class="line">slow_query_log_file = /var/log/mysqld/slow.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置每个EVENT都要执行刷盘操作</span></span><br><span class="line">sync_master_info = 1</span><br><span class="line">sync_relay_log_info = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">log_slave_updates = on</span><br><span class="line">relay_log_recovery = 1</span><br><span class="line">relay_log_purge = 1</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line"><span class="meta">#</span><span class="bash"> InnoDB引擎配置</span></span><br><span class="line">innodb_file_per_table = on</span><br><span class="line">innodb_checksums = 1</span><br><span class="line">innodb_checksum_algorithm = crc32</span><br><span class="line">innodb_status_file = 1</span><br><span class="line">innodb_status_output = 0</span><br><span class="line">innodb_status_output_locks = 0</span><br><span class="line">innodb_stats_on_metadata = 0</span><br><span class="line">innodb_open_files = 65535</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_flush_sync = 0</span><br><span class="line">innodb_flush_neighbors = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每个事务提交后立即刷新binlog文件</span></span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">innodb_monitor_enable="module_innodb"</span><br><span class="line">innodb_monitor_enable="module_server"</span><br><span class="line">innodb_monitor_enable="module_dml"</span><br><span class="line">innodb_monitor_enable="module_ddl"</span><br><span class="line">innodb_monitor_enable="module_trx"</span><br><span class="line">innodb_monitor_enable="module_os"</span><br><span class="line">innodb_monitor_enable="module_purge"</span><br><span class="line">innodb_monitor_enable="module_log"</span><br><span class="line">innodb_monitor_enable="module_lock"</span><br><span class="line">innodb_monitor_enable="module_buffer"</span><br><span class="line">innodb_monitor_enable="module_index"</span><br><span class="line">innodb_monitor_enable="module_ibuf_system"</span><br><span class="line">innodb_monitor_enable="module_buffer_page"</span><br><span class="line">innodb_monitor_enable="module_adaptive_hash"</span><br><span class="line"><span class="meta">#</span><span class="bash"> SQL mode配置，这里是默认值</span></span><br><span class="line">sql_mode = ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line"><span class="meta">#</span><span class="bash"> GTID配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gtid_mode = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enforce_gtid_consistency = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wsrep配置</span></span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line">wsrep_cluster_name = pxc-cluster</span><br><span class="line">wsrep_cluster_address = gcomm://172.16.80.201:4567,172.16.80.202:4567,172.16.80.203:4567</span><br><span class="line">wsrep_provider = /usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_node_name = db1</span><br><span class="line">wsrep_node_address = 172.16.80.201:4567</span><br><span class="line">wsrep_sst_receive_address = 172.16.80.201:4444</span><br><span class="line">wsrep_sst_method = xtrabackup-v2</span><br><span class="line">wsrep_sst_auth = sstuser:sstuser_password</span><br><span class="line">wsrep_slave_threads = 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用Percona XtraDB Cluster中实验特性和不受支持的功能</span></span><br><span class="line">pxc_strict_mode = ENFORCING</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 32M</span><br></pre></td></tr></table></figure><h3 id="节点2"><a href="#节点2" class="headerlink" title="节点2"></a>节点2</h3><blockquote><p>配置过程跟节点1大体上是一样，区别在于要修改某些配置项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">prompt="\u@db2 \R:\m:\s [\d]&gt; "</span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 202</span><br><span class="line">wsrep_node_name = db2</span><br><span class="line">wsrep_node_address = 172.16.80.202:4567</span><br><span class="line">wsrep_sst_receive_address = 172.16.80.202:4444</span><br></pre></td></tr></table></figure><h3 id="节点3"><a href="#节点3" class="headerlink" title="节点3"></a>节点3</h3><blockquote><p>配置过程跟节点1一样，区别在于要修改某些配置项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">prompt="\u@db3 \R:\m:\s [\d]&gt; "</span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 203</span><br><span class="line">wsrep_node_name = db3</span><br><span class="line">wsrep_node_address = 172.16.80.203:4567</span><br><span class="line">wsrep_sst_receive_address = 172.16.80.203:4444</span><br></pre></td></tr></table></figure><h2 id="初始化PXC集群"><a href="#初始化PXC集群" class="headerlink" title="初始化PXC集群"></a>初始化PXC集群</h2><h3 id="节点1-1"><a href="#节点1-1" class="headerlink" title="节点1"></a>节点1</h3><blockquote><p>作为集群第一个节点引导启动集群，此节点必须包含完整的数据！否则会出现数据不一致</p><p>这里以节点1作为bootstrap node</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql@bootstrap.service</span><br></pre></td></tr></table></figure><blockquote><p>启动完成之后，可以查看日志</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/mysql/error.log</span><br></pre></td></tr></table></figure><blockquote><p>在看到ready for connection就可以启动其他节点了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YYYY-MM-DDTHH:mm:ss.534955Z 0 [Note] /usr/sbin/mysqld: ready for connections.</span><br></pre></td></tr></table></figure><h3 id="节点2-1"><a href="#节点2-1" class="headerlink" title="节点2"></a>节点2</h3><blockquote><p>启动数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql.service</span><br></pre></td></tr></table></figure><h3 id="节点3-1"><a href="#节点3-1" class="headerlink" title="节点3"></a>节点3</h3><blockquote><p>启动数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql.service</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><blockquote><p>如果提示<code>WSREP: Failed to prepare for &#39;xtrabackup-v2&#39; SST. Unrecoverable.</code></p><p>那么可以将配置文件里面的<code>wsrep_sst_method=xtrabackup-v2</code>修改为<code>wsrep_sst_method=rsync</code></p><p>然后再重新初始化集群</p></blockquote><h2 id="检查集群启动状态"><a href="#检查集群启动状态" class="headerlink" title="检查集群启动状态"></a>检查集群启动状态</h2><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><blockquote><p>检查wsrep节点数量</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'wsrep_cluster_size'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例输出</span></span><br><span class="line">+<span class="comment">--------------------+-------+</span></span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+<span class="comment">--------------------+-------+</span></span><br><span class="line">| wsrep_cluster_size | 3     |</span><br><span class="line">+<span class="comment">--------------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><blockquote><p>检查wsrep集群信息</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'wsrep%'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例输出</span></span><br><span class="line">+<span class="comment">----------------------------------+----------------------------------------------------------+</span></span><br><span class="line">| Variable_name                    | Value                                                    |</span><br><span class="line">+<span class="comment">----------------------------------+----------------------------------------------------------+</span></span><br><span class="line">| wsrep_local_state_uuid           | 77463f8f-82bf-11e9-b41f-92927bef6908                     |</span><br><span class="line">| wsrep_protocol_version           | 9                                                        |</span><br><span class="line">| wsrep_last_applied               | 25                                                       |</span><br><span class="line">| wsrep_last_committed             | 25                                                       |</span><br><span class="line">| wsrep_replicated                 | 14                                                       |</span><br><span class="line">| wsrep_replicated_bytes           | 3640                                                     |</span><br><span class="line">| wsrep_repl_keys                  | 15                                                       |</span><br><span class="line">| wsrep_repl_keys_bytes            | 456                                                      |</span><br><span class="line">| wsrep_repl_data_bytes            | 2237                                                     |</span><br><span class="line">| wsrep_repl_other_bytes           | 0                                                        |</span><br><span class="line">| wsrep_received                   | 6                                                        |</span><br><span class="line">| wsrep_received_bytes             | 1225                                                     |</span><br><span class="line">| wsrep_local_commits              | 0                                                        |</span><br><span class="line">| wsrep_local_cert_failures        | 0                                                        |</span><br><span class="line">| wsrep_local_replays              | 0                                                        |</span><br><span class="line">| wsrep_local_send_queue           | 0                                                        |</span><br><span class="line">| wsrep_local_send_queue_max       | 1                                                        |</span><br><span class="line">| wsrep_local_send_queue_min       | 0                                                        |</span><br><span class="line">| wsrep_local_send_queue_avg       | 0.000000                                                 |</span><br><span class="line">| wsrep_local_recv_queue           | 0                                                        |</span><br><span class="line">| wsrep_local_recv_queue_max       | 1                                                        |</span><br><span class="line">| wsrep_local_recv_queue_min       | 0                                                        |</span><br><span class="line">| wsrep_local_recv_queue_avg       | 0.000000                                                 |</span><br><span class="line">| wsrep_local_cached_downto        | 12                                                       |</span><br><span class="line">| wsrep_flow_control_paused_ns     | 0                                                        |</span><br><span class="line">| wsrep_flow_control_paused        | 0.000000                                                 |</span><br><span class="line">| wsrep_flow_control_sent          | 0                                                        |</span><br><span class="line">| wsrep_flow_control_recv          | 0                                                        |</span><br><span class="line">| wsrep_flow_control_interval      | [ 173, 173 ]                                             |</span><br><span class="line">| wsrep_flow_control_interval_low  | 173                                                      |</span><br><span class="line">| wsrep_flow_control_interval_high | 173                                                      |</span><br><span class="line">| wsrep_flow_control_status        | OFF                                                      |</span><br><span class="line">| wsrep_cert_deps_distance         | 1.000000                                                 |</span><br><span class="line">| wsrep_apply_oooe                 | 0.000000                                                 |</span><br><span class="line">| wsrep_apply_oool                 | 0.000000                                                 |</span><br><span class="line">| wsrep_apply_window               | 1.000000                                                 |</span><br><span class="line">| wsrep_commit_oooe                | 0.000000                                                 |</span><br><span class="line">| wsrep_commit_oool                | 0.000000                                                 |</span><br><span class="line">| wsrep_commit_window              | 1.000000                                                 |</span><br><span class="line">| wsrep_local_state                | 4                                                        |</span><br><span class="line">| wsrep_local_state_comment        | Synced                                                   |</span><br><span class="line">| wsrep_cert_index_size            | 3                                                        |</span><br><span class="line">| wsrep_cert_bucket_count          | 22                                                       |</span><br><span class="line">| wsrep_gcache_pool_size           | 5520                                                     |</span><br><span class="line">| wsrep_causal_reads               | 0                                                        |</span><br><span class="line">| wsrep_cert_interval              | 0.000000                                                 |</span><br><span class="line">| wsrep_open_transactions          | 0                                                        |</span><br><span class="line">| wsrep_open_connections           | 0                                                        |</span><br><span class="line">| wsrep_ist_receive_status         |                                                          |</span><br><span class="line">| wsrep_ist_receive_seqno_start    | 0                                                        |</span><br><span class="line">| wsrep_ist_receive_seqno_current  | 0                                                        |</span><br><span class="line">| wsrep_ist_receive_seqno_end      | 0                                                        |</span><br><span class="line">| wsrep_incoming_addresses         | 172.16.80.201:3306,172.16.80.202:3306,172.16.80.203:3306 |</span><br><span class="line">| wsrep_cluster_weight             | 3                                                        |</span><br><span class="line">| wsrep_desync_count               | 0                                                        |</span><br><span class="line">| wsrep_evs_delayed                |                                                          |</span><br><span class="line">| wsrep_evs_evict_list             |                                                          |</span><br><span class="line">| wsrep_evs_repl_latency           | 0/0/0/0/0                                                |</span><br><span class="line">| wsrep_evs_state                  | OPERATIONAL                                              |</span><br><span class="line">| wsrep_gcomm_uuid                 | 5ed853a2-834a-11e9-a850-17ef655007c8                     |</span><br><span class="line">| wsrep_cluster_conf_id            | 11                                                       |</span><br><span class="line">| wsrep_cluster_size               | 3                                                        |</span><br><span class="line">| wsrep_cluster_state_uuid         | 77463f8f-82bf-11e9-b41f-92927bef6908                     |</span><br><span class="line">| wsrep_cluster_status             | Primary                                                  |</span><br><span class="line">| wsrep_connected                  | ON                                                       |</span><br><span class="line">| wsrep_local_bf_aborts            | 0                                                        |</span><br><span class="line">| wsrep_local_index                | 0                                                        |</span><br><span class="line">| wsrep_provider_name              | Galera                                                   |</span><br><span class="line">| wsrep_provider_vendor            | Codership Oy &lt;info@codership.com&gt;                        |</span><br><span class="line">| wsrep_provider_version           | 3.35(rddf9876)                                           |</span><br><span class="line">| wsrep_ready                      | ON                                                       |</span><br><span class="line">+<span class="comment">----------------------------------+----------------------------------------------------------+</span></span><br><span class="line">71 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="简单验证集群"><a href="#简单验证集群" class="headerlink" title="简单验证集群"></a>简单验证集群</h1><blockquote><p>在节点1创建数据库</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql@db1&gt; CREATE DATABASE percona_test;</span><br></pre></td></tr></table></figure><blockquote><p>在节点2上创建表</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql@db2&gt; USE percona_test;</span><br><span class="line">mysql@db2&gt; CREATE TABLE example (node_id INT PRIMARY KEY, node_name VARCHAR(30));</span><br></pre></td></tr></table></figure><blockquote><p>在节点2上插入数据</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql@db2&gt; INSERT INTO percona_test.example VALUES (2, 'db2');</span><br></pre></td></tr></table></figure><blockquote><p>在节点3上查数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql@db3&gt; SELECT * FROM percona_test.example;</span><br><span class="line">+<span class="comment">---------+-----------+</span></span><br><span class="line">| node_id | node_name |</span><br><span class="line">+<span class="comment">---------+-----------+</span></span><br><span class="line">|       2 | db2       |</span><br><span class="line">+<span class="comment">---------+-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="集群维护操作"><a href="#集群维护操作" class="headerlink" title="集群维护操作"></a>集群维护操作</h1><h2 id="集群整体关机"><a href="#集群整体关机" class="headerlink" title="集群整体关机"></a>集群整体关机</h2><ul><li>按顺序逐台关停，例如db1→db2→db3</li></ul><h2 id="集群整体开机"><a href="#集群整体开机" class="headerlink" title="集群整体开机"></a>集群整体开机</h2><ul><li>启动时，则按照db3→db2→db1<ul><li>其中db3启动时，需要作为bootstrap node引导集群<code>systemctl start mysql@bootstrap.service</code></li></ul></li></ul><h2 id="集群少数节点维护"><a href="#集群少数节点维护" class="headerlink" title="集群少数节点维护"></a>集群少数节点维护</h2><ul><li>PXC集群能容忍少数节点离线而不影响集群数据库服务</li><li>这里的少数节点是指少于50%，即&lt; 50%</li><li>少数节点重新上线之后，会自动完成数据同步，在完成同步之后，wsrep状态被设置为true，才对外提供服务</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;仅记录安装部署过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/code&gt;
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Kong API网关搭建部署记录</title>
    <link href="https://luanlengli.github.io/2019/05/29/Kong-API%E7%BD%91%E5%85%B3%E6%90%AD%E5%BB%BA%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95.html"/>
    <id>https://luanlengli.github.io/2019/05/29/Kong-API网关搭建部署记录.html</id>
    <published>2019-05-29T02:27:08.000Z</published>
    <updated>2019-07-03T02:43:09.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li><p>仅记录安装部署过程</p></li><li><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p></li><li><p>kong版本为<code>1.1.2</code></p></li><li><p>官方文档在<a href="https://docs.konghq.com/" target="_blank" rel="noopener">这里</a></p></li></ul><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><h3 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h3><p>参考<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96.html">PostgreSQL10安装部署和初始化</a></p><h3 id="创建kong所需的数据库和用户"><a href="#创建kong所需的数据库和用户" class="headerlink" title="创建kong所需的数据库和用户"></a>创建kong所需的数据库和用户</h3><blockquote><p>登录PostgreSQL数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><blockquote><p>创建用户</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> kong <span class="keyword">with</span> <span class="keyword">password</span> <span class="string">'kong_password'</span>;</span><br></pre></td></tr></table></figure><blockquote><p>创建数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> kong owner kong;</span><br></pre></td></tr></table></figure><blockquote><p>授权用户拥有数据库所有权限</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> <span class="keyword">database</span> kong <span class="keyword">to</span> kong;</span><br></pre></td></tr></table></figure><h1 id="Kong安装"><a href="#Kong安装" class="headerlink" title="Kong安装"></a>Kong安装</h1><h2 id="配置YUM源"><a href="#配置YUM源" class="headerlink" title="配置YUM源"></a>配置YUM源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/kong.repo &lt;&lt;EOF</span><br><span class="line">[bintray--kong-kong-rpm]</span><br><span class="line">name=bintray--kong-kong-rpm</span><br><span class="line">baseurl=https://kong.bintray.com/kong-rpm/centos/7</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装kong"><a href="#安装kong" class="headerlink" title="安装kong"></a>安装kong</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kong-1.1.2-1</span><br></pre></td></tr></table></figure><h2 id="配置kong"><a href="#配置kong" class="headerlink" title="配置kong"></a>配置kong</h2><blockquote><p><code>/etc/kong/kong.conf</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -----------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kong configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -----------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> GENERAL</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 没啥好调的</span></span><br><span class="line">prefix = /usr/local/kong/</span><br><span class="line">log_level = notice</span><br><span class="line">proxy_access_log = /var/log/kong/access.log</span><br><span class="line">proxy_error_log = /var/log/kong/error.log</span><br><span class="line">admin_access_log = /var/log/kong/admin_access.log</span><br><span class="line">admin_error_log = /var/log/kong/admin_error.log</span><br><span class="line"><span class="meta">#</span><span class="bash">plugins = bundled</span></span><br><span class="line">anonymous_reports = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NGINX</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> proxy端口为对外提供服务的端口</span></span><br><span class="line">proxy_listen = 0.0.0.0:80, 0.0.0.0:443 http2 ssl</span><br><span class="line"><span class="meta">#</span><span class="bash">stream_listen = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 管理端口，注意安全！</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此API接口是无权限认证的！</span></span><br><span class="line">admin_listen = 127.0.0.1:8001, 127.0.0.1:8444 ssl</span><br><span class="line">nginx_user = nobody nobody</span><br><span class="line">nginx_worker_processes = auto</span><br><span class="line">nginx_daemon = on</span><br><span class="line">mem_cache_size = 128m</span><br><span class="line"><span class="meta">#</span><span class="bash"> SSL/TLS套件的说明可以看这里</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> https://wiki.mozilla.org/Security/Server_Side_TLS</span></span><br><span class="line">ssl_cipher_suite = modern</span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ciphers = <span class="string">""</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置proxy端口的https证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_cert = /path/to/cert</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_cert_key = /path/to/key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端证书认证，一般情况不用设置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_ssl = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_ssl_cert = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_ssl_cert_key = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置Admin API端口的https证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">admin_ssl_cert = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">admin_ssl_cert_key = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 与upstream保持TCP连接，减少频繁建立TCP连接带来的性能损耗</span></span><br><span class="line">upstream_keepalive = 60</span><br><span class="line"><span class="meta">#</span><span class="bash">headers = server_tokens, latency_tokens</span></span><br><span class="line"><span class="meta">#</span><span class="bash">trusted_ips = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 经过CDN或者多级HTTP服务反向代理时，添加X-Real-IP请求头可以追溯到客户端真实IP</span></span><br><span class="line">real_ip_header = X-Real-IP</span><br><span class="line"><span class="meta">#</span><span class="bash">real_ip_recursive = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端请求的body过大时会出现payload too large</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置为0时，不限制</span></span><br><span class="line">client_max_body_size = 0</span><br><span class="line">client_body_buffer_size = 16k</span><br><span class="line">error_default_type = text/plain</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DATASTORE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">database = postgres</span><br><span class="line">pg_host = 127.0.0.1</span><br><span class="line">pg_port = 5432</span><br><span class="line">pg_timeout = 5000</span><br><span class="line">pg_user = kong</span><br><span class="line">pg_password = kong_password</span><br><span class="line">pg_database = uat_kong</span><br><span class="line">pg_schema = public</span><br><span class="line">pg_ssl = off</span><br><span class="line"><span class="meta">#</span><span class="bash">pg_ssl_verify = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DATASTORE CACHE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用数据存储更新缓存的频率(秒)，默认值5</span></span><br><span class="line">db_update_frequency = 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库节点的更新时间，对于最终一致性模型的数据库，需要配置各数据库节点之间数据同步的延迟</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 整个kong同步配置的延迟时间 等于 db_update_frequency + db_update_propagation</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db_update_propagation = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 缓存过期时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db_cache_ttl = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 缓存刷新时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db_resurrect_ttl = 30</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DNS RESOLVER</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置DNS服务器列表，仅提供给Kong使用，不会覆盖系统配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_resolver = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置Kong的hosts文件，必须要重启Kong才能生效，仅提供给Kong使用，不会覆盖系统配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_hostsfile = /etc/hosts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解析不同记录类型的顺序。“LAST”类型表示最后一次成功查找的类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_order = LAST,SRV,A,CNAME</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_valid_ttl = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置DNS记录缓存过期时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_stale_ttl = 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_not_found_ttl = 30</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_error_ttl = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_no_sync = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEVELOPMENT &amp; MISCELLANEOUS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个地方没啥好改的，默认值就好了</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_ssl_trusted_certificate = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_ssl_verify_depth = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_package_path = ./?.lua;./?/init.lua;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_package_cpath = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_socket_pool_size = 30</span></span><br></pre></td></tr></table></figure><h2 id="创建日志目录"><a href="#创建日志目录" class="headerlink" title="创建日志目录"></a>创建日志目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/kong</span><br></pre></td></tr></table></figure><h2 id="初始化kong数据库"><a href="#初始化kong数据库" class="headerlink" title="初始化kong数据库"></a>初始化kong数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/kong migrations bootstrap -c /etc/kong/kong.conf</span><br></pre></td></tr></table></figure><blockquote><p>数据库初始化时输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">bootstrapping database...</span><br><span class="line">migrating core on database 'kong'...</span><br><span class="line">core migrated up to: 000_base (executed)</span><br><span class="line">core migrated up to: 001_14_to_15 (executed)</span><br><span class="line">core migrated up to: 002_15_to_1 (executed)</span><br><span class="line">core migrated up to: 003_100_to_110 (executed)</span><br><span class="line">migrating oauth2 on database 'kong'...</span><br><span class="line">oauth2 migrated up to: 000_base_oauth2 (executed)</span><br><span class="line">oauth2 migrated up to: 001_14_to_15 (executed)</span><br><span class="line">oauth2 migrated up to: 002_15_to_10 (executed)</span><br><span class="line">migrating acl on database 'kong'...</span><br><span class="line">acl migrated up to: 000_base_acl (executed)</span><br><span class="line">acl migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating jwt on database 'kong'...</span><br><span class="line">jwt migrated up to: 000_base_jwt (executed)</span><br><span class="line">jwt migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating basic-auth on database 'kong'...</span><br><span class="line">basic-auth migrated up to: 000_base_basic_auth (executed)</span><br><span class="line">basic-auth migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating key-auth on database 'kong'...</span><br><span class="line">key-auth migrated up to: 000_base_key_auth (executed)</span><br><span class="line">key-auth migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating rate-limiting on database 'kong'...</span><br><span class="line">rate-limiting migrated up to: 000_base_rate_limiting (executed)</span><br><span class="line">rate-limiting migrated up to: 001_14_to_15 (executed)</span><br><span class="line">rate-limiting migrated up to: 002_15_to_10 (executed)</span><br><span class="line">rate-limiting migrated up to: 003_10_to_112 (executed)</span><br><span class="line">migrating hmac-auth on database 'kong'...</span><br><span class="line">hmac-auth migrated up to: 000_base_hmac_auth (executed)</span><br><span class="line">hmac-auth migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating response-ratelimiting on database 'kong'...</span><br><span class="line">response-ratelimiting migrated up to: 000_base_response_rate_limiting (executed)</span><br><span class="line">response-ratelimiting migrated up to: 001_14_to_15 (executed)</span><br><span class="line">response-ratelimiting migrated up to: 002_15_to_10 (executed)</span><br><span class="line">24 migrations processed</span><br><span class="line">24 executed</span><br><span class="line">database is up-to-date</span><br></pre></td></tr></table></figure><h2 id="启动kong"><a href="#启动kong" class="headerlink" title="启动kong"></a>启动kong</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/kong start -c /etc/kong/kong.conf</span><br></pre></td></tr></table></figure><h2 id="查看监听端口"><a href="#查看监听端口" class="headerlink" title="查看监听端口"></a>查看监听端口</h2><blockquote><p>80和443端口是业务端口</p><p>8001和8444是Admin API端口</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      17493/nginx: master</span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      17493/nginx: master</span><br><span class="line">tcp        0      0 127.0.0.1:8444          0.0.0.0:*               LISTEN      17493/nginx: master</span><br><span class="line">tcp        0      0 127.0.0.1:8001          0.0.0.0:*               LISTEN      17493/nginx: master</span><br></pre></td></tr></table></figure><h2 id="Kong访问测试"><a href="#Kong访问测试" class="headerlink" title="Kong访问测试"></a>Kong访问测试</h2><blockquote><p>访问本机的8001端口</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://localhost:8001/</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 29 May 2019 06:38:35 GMT</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Server: kong/1.1.2</span><br><span class="line">Content-Length: 5777</span><br></pre></td></tr></table></figure><h2 id="查看Nginx日志"><a href="#查看Nginx日志" class="headerlink" title="查看Nginx日志"></a>查看Nginx日志</h2><blockquote><p>在本文中已经定义了日志路径为<code>/var/log/kong/</code></p><p>可以看到有四个日志文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/local/kong/logs/</span><br><span class="line">access.log admin_access.log admin_error.log error.log</span><br></pre></td></tr></table></figure><h2 id="查看Nginx的PID文件"><a href="#查看Nginx的PID文件" class="headerlink" title="查看Nginx的PID文件"></a>查看Nginx的PID文件</h2><blockquote><p>kong的配置文件没法定义PID文件的路径</p><p>默认在<code>/usr/local/kong/pids/nginx.pid</code></p></blockquote><h2 id="创建kong的systemd服务脚本"><a href="#创建kong的systemd服务脚本" class="headerlink" title="创建kong的systemd服务脚本"></a>创建kong的systemd服务脚本</h2><p><code>/usr/lib/systemd/system/kong.service</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kong API Gateway</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">ExecStart=/usr/local/bin/kong start -c /etc/kong/kong.conf</span><br><span class="line">ExecStop=/usr/local/bin/kong stop</span><br><span class="line">ExecReload=/usr/local/bin/kong reload -c /etc/kong/kong.conf</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/kong/pids/nginx.pid</span><br><span class="line">RestartSec=60</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure><h1 id="Kong集群"><a href="#Kong集群" class="headerlink" title="Kong集群"></a>Kong集群</h1><h2 id="单节点集群"><a href="#单节点集群" class="headerlink" title="单节点集群"></a>单节点集群</h2><blockquote><p>只有一个kong节点连接到数据库（cassandra或者PostgreSQL）时，通过kong的Admin API提交的变更都会立刻生效。</p><p>kong的配置信息是缓存在内存中。</p></blockquote><h2 id="多节点集群"><a href="#多节点集群" class="headerlink" title="多节点集群"></a>多节点集群</h2><blockquote><p>在多个kong节点组成的集群中，这些kong节点都连接到同一个数据库（cassandra或者PostgreSQL），即可组成集群。</p><p>当其中一个节点提交了修改，那么其他节点是不会立刻感知到已经提交的变更。</p><p>因此所有kong节点会在后台定期执行任务，从数据库中读取其他节点提交的变更。</p></blockquote><ul><li><code>db_update_frequency</code> 默认值5</li></ul><blockquote><p>每5秒，集群中所有的kong节点都会从数据库中获取最新的配置信息，并缓存到内存中</p></blockquote><ul><li><code>db_update_propagation</code>默认值0</li></ul><blockquote><p>如果使用了Cassandra数据库集群，那么如果数据库有更新，最多需要<code>db_update_propagation</code>时间来同步所有的数据库副本。</p><p>如果使用PostgreSQL或者单数据库，这个值可以被设置为0</p></blockquote><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><blockquote><p>以下数据会被缓存在内存中，并通过后台任务的机制查询后端数据库进行更新</p></blockquote><ul><li>Services</li><li>Routes</li><li>Plugins</li><li>Consumers</li><li>Credentials</li></ul><h1 id="Konga安装"><a href="#Konga安装" class="headerlink" title="Konga安装"></a>Konga安装</h1><blockquote><p>konga是kong的web可视化管理工具</p><p>这里在kong服务器上运行konga</p></blockquote><h2 id="安装Docker-CE"><a href="#安装Docker-CE" class="headerlink" title="安装Docker-CE"></a>安装Docker-CE</h2><p>安装过程见<a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">官方文档</a></p><h2 id="启动Docker"><a href="#启动Docker" class="headerlink" title="启动Docker"></a>启动Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker.service</span><br><span class="line">systemctl start docker.service</span><br></pre></td></tr></table></figure><h2 id="创建konga数据库"><a href="#创建konga数据库" class="headerlink" title="创建konga数据库"></a>创建konga数据库</h2><blockquote><p>登录PostgreSQL</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><blockquote><p>创建konga数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> konga owner kong;</span><br></pre></td></tr></table></figure><blockquote><p>授权kong用户拥有konga数据库所有权限</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> <span class="keyword">database</span> konga <span class="keyword">to</span> kong;</span><br></pre></td></tr></table></figure><h2 id="初始化konga数据库"><a href="#初始化konga数据库" class="headerlink" title="初始化konga数据库"></a>初始化konga数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">           --net=host \</span><br><span class="line">           pantsel/konga:latest \</span><br><span class="line">           -c prepare \</span><br><span class="line">           -a postgres \</span><br><span class="line">           -u postgresql://kong:kong_password@127.0.0.1:5432/konga</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">debug: Preparing database...</span><br><span class="line">Using postgres DB Adapter.</span><br><span class="line">Database exists. Continue...</span><br><span class="line">debug: Hook:api_health_checks:process() called</span><br><span class="line">debug: Hook:health_checks:process() called</span><br><span class="line">debug: Hook:start-scheduled-snapshots:process() called</span><br><span class="line">debug: Hook:upstream_health_checks:process() called</span><br><span class="line">debug: Hook:user_events_hook:process() called</span><br><span class="line">debug: Seeding User...</span><br><span class="line">debug: User seed planted</span><br><span class="line">debug: Seeding Kongnode...</span><br><span class="line">debug: Kongnode seed planted</span><br><span class="line">debug: Seeding Emailtransport...</span><br><span class="line">debug: Emailtransport seed planted</span><br><span class="line">debug: Database migrations completed!</span><br></pre></td></tr></table></figure><h2 id="运行konga"><a href="#运行konga" class="headerlink" title="运行konga"></a>运行konga</h2><blockquote><p>共享宿主机网络命名空间</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">           --net=host \</span><br><span class="line">           --name konga \</span><br><span class="line">           --restart=always \</span><br><span class="line">           -e "PORT=1337" \</span><br><span class="line">           -e "NODE_ENV=production"  \</span><br><span class="line">           -e "KONGA_LOG_LEVEL=info" \</span><br><span class="line">           -e "DB_ADAPTER=postgres" \</span><br><span class="line">           -e "DB_URI=postgresql://kong:kong_password@127.0.0.1:5432/konga" \</span><br><span class="line">           pantsel/konga:latest</span><br></pre></td></tr></table></figure><h2 id="查看监听端口-1"><a href="#查看监听端口-1" class="headerlink" title="查看监听端口"></a>查看监听端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp6       0      0 :::1337                 :::*                    LISTEN      19341/node</span><br></pre></td></tr></table></figure><h2 id="查看konga日志"><a href="#查看konga日志" class="headerlink" title="查看konga日志"></a>查看konga日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs konga</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Hook:api_health_checks:process() called</span><br><span class="line">Hook:health_checks:process() called</span><br><span class="line">Hook:start-scheduled-snapshots:process() called</span><br><span class="line">Hook:upstream_health_checks:process() called</span><br><span class="line">Hook:user_events_hook:process() called</span><br><span class="line">User had models, so no seed needed</span><br><span class="line">Kongnode had models, so no seed needed</span><br><span class="line">Emailtransport seeds updated</span><br><span class="line"></span><br><span class="line">               .-..-.</span><br><span class="line"></span><br><span class="line">   Sails              &lt;|    .-..-.</span><br><span class="line">   v0.12.14            |\</span><br><span class="line">                      /|.\</span><br><span class="line">                     / || \</span><br><span class="line">                   ,'  |'  \</span><br><span class="line">                .-'.-==|/_--'</span><br><span class="line">                `--'-------'</span><br><span class="line">   __---___--___---___--___---___--___</span><br><span class="line"> ____---___--___---___--___---___--___-__</span><br><span class="line"></span><br><span class="line">Server lifted in `/app`</span><br><span class="line">To see your app, visit http://localhost:1337</span><br><span class="line">To shut down Sails, press &lt;CTRL&gt; + C at any time.</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line">:: Weekday Month Day Years HH:mm:ss GMT+0000 (UTC)</span><br><span class="line"></span><br><span class="line">Environment : production</span><br><span class="line">Port        : 1337</span><br><span class="line">-------------------------------------------------------</span><br></pre></td></tr></table></figure><h2 id="访问konga"><a href="#访问konga" class="headerlink" title="访问konga"></a>访问konga</h2><ul><li>使用浏览器访问<code>http://konga服务器IP:1337</code></li><li>第一次打开konga需要注册管理员用户，请保证密码强度足够高</li><li>在弹出的<code>New Connection</code>窗口<ul><li>选择<code>Default</code></li><li><code>Name</code>填写kong的名字</li><li><code>kong Admin URL</code>填写<code>http://127.0.0.1:8001</code></li></ul></li></ul><h1 id="Kong维护"><a href="#Kong维护" class="headerlink" title="Kong维护"></a>Kong维护</h1><h2 id="检查kong配置文件"><a href="#检查kong配置文件" class="headerlink" title="检查kong配置文件"></a>检查kong配置文件</h2><blockquote><p>在更改配置文件之后，可以通过命令检查配置文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong check -v /etc/kong/kong.conf</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /etc/kong/kong.conf</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] configuration at /etc/kong/kong.conf is valid</span><br></pre></td></tr></table></figure><h2 id="Kong健康检查"><a href="#Kong健康检查" class="headerlink" title="Kong健康检查"></a>Kong健康检查</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong health --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /usr/local/kong/.kong_env</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] nginx.......running</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info]</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong is healthy at /usr/local/kong</span><br></pre></td></tr></table></figure><h2 id="Kong启动"><a href="#Kong启动" class="headerlink" title="Kong启动"></a>Kong启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong start -c /etc/kong/kong.conf --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /etc/kong/kong.conf</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] retrieving database schema state...</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] schema state retrieved</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] preparing nginx prefix directory at /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] default SSL certificate found at /usr/local/kong/ssl/kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Admin SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] admin SSL certificate found at /usr/local/kong/ssl/admin-kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong started</span><br></pre></td></tr></table></figure><h2 id="Kong关闭"><a href="#Kong关闭" class="headerlink" title="Kong关闭"></a>Kong关闭</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong stop --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /usr/local/kong/.kong_env</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] sending TERM signal to nginx running at /usr/local/kong/pids/nginx.pid</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong stopped</span><br></pre></td></tr></table></figure><h2 id="Kong重启"><a href="#Kong重启" class="headerlink" title="Kong重启"></a>Kong重启</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong restart -c /etc/kong/kong.conf --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong stopped</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /etc/kong/kong.conf</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] retrieving database schema state...</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] schema state retrieved</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] preparing nginx prefix directory at /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] default SSL certificate found at /usr/local/kong/ssl/kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Admin SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] admin SSL certificate found at /usr/local/kong/ssl/admin-kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong started</span><br></pre></td></tr></table></figure><h2 id="Kong重载配置"><a href="#Kong重载配置" class="headerlink" title="Kong重载配置"></a>Kong重载配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong reload -c /etc/kong/kong.conf --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /usr/local/kong/.kong_env</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] preparing nginx prefix directory at /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong reloaded</span><br></pre></td></tr></table></figure><h2 id="日志轮转"><a href="#日志轮转" class="headerlink" title="日志轮转"></a>日志轮转</h2><blockquote><p>底层是Nginx，因此可以借助logrotate工具做日志轮转</p></blockquote><h3 id="安装logrotate"><a href="#安装logrotate" class="headerlink" title="安装logrotate"></a>安装logrotate</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y logrotate</span><br></pre></td></tr></table></figure><h3 id="配置logrotate"><a href="#配置logrotate" class="headerlink" title="配置logrotate"></a>配置logrotate</h3><blockquote><p>每天切割日志</p><p>保留30天的日志记录</p><p>被切割的日志会压缩打包</p></blockquote><p><code>/etc/logrotate.d/kong</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/var/log/kong/*.log  &#123;</span><br><span class="line">daily</span><br><span class="line">rotate 30</span><br><span class="line">missingok</span><br><span class="line">dateext</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">postrotate</span><br><span class="line">    [ -e /usr/local/kong/pids/nginx.pid ] &amp;&amp; kill -USR1 `cat /usr/local/kong/pids/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试logrotate配置"><a href="#测试logrotate配置" class="headerlink" title="测试logrotate配置"></a>测试logrotate配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -d /etc/logrotate.d/kong</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">reading config file /etc/logrotate.d/kong</span><br><span class="line">Allocating hash table for state file, size 15360 B</span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/log/kong/*.log   after 1 days (30 rotations)</span><br><span class="line">empty log files are not rotated, old logs are removed</span><br><span class="line">considering log /var/log/kong/access.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br><span class="line">considering log /var/log/kong/admin_access.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br><span class="line">considering log /var/log/kong/admin_error.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br><span class="line">considering log /var/log/kong/error.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br></pre></td></tr></table></figure><h2 id="kong监控"><a href="#kong监控" class="headerlink" title="kong监控"></a>kong监控</h2><blockquote><p>kong内置了prometheus标准的metrics，默认只有Nginx的信息</p><p>开启了prometheus插件之后，可以为每个services都做监控</p><p><font color="red">注意！</font>metrics数据默认只能从Admin端口获取，不能走Proxy端口</p><p>因此想让Prometheus获取到kong的metric数据，需要修改<code>kong.conf</code>配置文件中<code>admin_listen</code>的值</p><p>具体的可以看<a href="https://docs.konghq.com/hub/kong-inc/prometheus/" target="_blank" rel="noopener">官方说明</a></p></blockquote><h3 id="开启插件"><a href="#开启插件" class="headerlink" title="开启插件"></a>开启插件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:8001/plugins --data "name=prometheus"</span><br></pre></td></tr></table></figure><h3 id="访问metric数据"><a href="#访问metric数据" class="headerlink" title="访问metric数据"></a>访问metric数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://localhost:8001/metrics</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p><p>这里kong是没配置任何服务，因此输出内容很少</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> HELP kong_datastore_reachable Datastore reachable from Kong, 0 is unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE kong_datastore_reachable gauge</span></span><br><span class="line">kong_datastore_reachable 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP kong_nginx_http_current_connections Number of HTTP connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE kong_nginx_http_current_connections gauge</span></span><br><span class="line">kong_nginx_http_current_connections&#123;state="accepted"&#125; 15</span><br><span class="line">kong_nginx_http_current_connections&#123;state="active"&#125; 1</span><br><span class="line">kong_nginx_http_current_connections&#123;state="handled"&#125; 15</span><br><span class="line">kong_nginx_http_current_connections&#123;state="reading"&#125; 0</span><br><span class="line">kong_nginx_http_current_connections&#123;state="total"&#125; 15</span><br><span class="line">kong_nginx_http_current_connections&#123;state="waiting"&#125; 0</span><br><span class="line">kong_nginx_http_current_connections&#123;state="writing"&#125; 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP kong_nginx_metric_errors_total Number of nginx-lua-prometheus errors</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE kong_nginx_metric_errors_total counter</span></span><br><span class="line">kong_nginx_metric_errors_total 0</span><br></pre></td></tr></table></figure><h3 id="监控数据可视化"><a href="#监控数据可视化" class="headerlink" title="监控数据可视化"></a>监控数据可视化</h3><blockquote><p>官方已经制作了grafana dashboard来展示Prometheus的数据</p></blockquote><p><a href="https://grafana.com/dashboards/7424" target="_blank" rel="noopener">Grafana Dashboard</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;仅记录安装部署过程&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;操作系统使用的&lt;code&gt;CentOS-7.6.1810 x86_64&lt;/
      
    
    </summary>
    
      <category term="Kong" scheme="https://luanlengli.github.io/categories/Kong/"/>
    
    
      <category term="Kong" scheme="https://luanlengli.github.io/tags/Kong/"/>
    
  </entry>
  
  <entry>
    <title>【施工中】PostgreSQL备份和恢复</title>
    <link href="https://luanlengli.github.io/2019/05/28/PostgreSQL%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D.html"/>
    <id>https://luanlengli.github.io/2019/05/28/PostgreSQL备份和恢复.html</id>
    <published>2019-05-28T15:32:05.000Z</published>
    <updated>2019-07-22T14:12:51.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>基于PostgreSQL 10.8版本做演示</p><p>其他版本自行调整</p></blockquote><h1 id="逻辑备份"><a href="#逻辑备份" class="headerlink" title="逻辑备份"></a>逻辑备份</h1><h2 id="pg-dump"><a href="#pg-dump" class="headerlink" title="pg_dump"></a>pg_dump</h2><h3 id="备份的逻辑"><a href="#备份的逻辑" class="headerlink" title="备份的逻辑"></a>备份的逻辑</h3><ul><li>pg_dump的一次完整的备份是在一个事务中完成的, 事务隔离级别为serializable 或者 repeatable read。</li><li>pg_dump在备份数据开始前, 需要对进行备份的对象加ACCESS SHARE锁。为了防止无休止的锁等待，可以使用<code>--lock-wait-timeout</code>设置锁超时时间</li><li>一切准备就绪后，pg_dump开始备份数据</li></ul><h3 id="备份的格式"><a href="#备份的格式" class="headerlink" title="备份的格式"></a>备份的格式</h3><ul><li><code>p</code>或者<code>plain</code><ul><li>默认格式，可读写的文本文件，里面是SQL语句</li></ul></li><li><code>c</code>或者<code>custom</code><ul><li>自定义格式，默认开启数据压缩，还原时可以调整对象还原顺序，必须使用<code>pg_restore</code>命令还原</li></ul></li><li><code>d</code>或者<code>directory</code><ul><li>目录归档格式，需要用<code>pg_restore</code>命令还原，目录归档格式下会创建一个目录, 然后每个表或者每个大对象对应一个备份输出文件，加上TOC文件名描述备份的详细信息, 这个格式默认支持压缩, 同时支持并行导出</li></ul></li><li><code>t</code>或者<code>tar</code><ul><li>tar归档格式, 不支持压缩, 同时限制每个表最大不能超过8GB, 同样需要使用<code>pg_restore</code>还原</li></ul></li></ul><h3 id="全库一致性"><a href="#全库一致性" class="headerlink" title="全库一致性"></a>全库一致性</h3><blockquote><p>指定是集群中的单个数据库的一致性备份。</p><p>因为备份不同的数据库需要切换连接，无法在不同的数据库之间共享snapshot，因此只能单库一致。</p></blockquote><h3 id="非全库一致性备份"><a href="#非全库一致性备份" class="headerlink" title="非全库一致性备份"></a>非全库一致性备份</h3><blockquote><p>如果单个库数据量越大，pg_dump备份时间就越长，持有锁的时间也就越长。</p><p>这时候会阻塞DDL语句。</p><p>未解决这个问题，可以将pg_dump的粒度缩小，只备份相关联且有一致性需求的数据表</p></blockquote><h2 id="pg-dumpall"><a href="#pg-dumpall" class="headerlink" title="pg_dumpall"></a>pg_dumpall</h2><blockquote><p>pg_dumpall最主要的是用于备份全局数据, 例如表空间的DDL, 创建用户的DDL</p></blockquote><h2 id="简单的备份脚本"><a href="#简单的备份脚本" class="headerlink" title="简单的备份脚本"></a>简单的备份脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -ex</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义PostgreSQL数据库连接</span></span><br><span class="line">export PGHOST='192.168.1.1'</span><br><span class="line">export PGPORT='5432'</span><br><span class="line">export PGUSER='postgres'</span><br><span class="line">export PGPASSWORD='postgres_passwd'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义目录</span></span><br><span class="line">BASE_DIR='/data/pgsql-dump'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义文件名</span></span><br><span class="line">FILENAME='pgsql-dump'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义时间格式，20190329-00</span></span><br><span class="line">DATE=$(date +%Y%m%d)</span><br><span class="line">TIME=$(date +%H%M)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据时间格式创建文件夹</span></span><br><span class="line">BACKUP_DIR="$&#123;BASE_DIR&#125;/$&#123;DATE&#125;/$&#123;TIME&#125;"</span><br><span class="line">mkdir -p $&#123;BACKUP_DIR&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤需要备份的数据库</span></span><br><span class="line">DATABASES=$(psql --host=$&#123;PGHOST&#125; --port=$&#123;PGPORT&#125; --username=$&#123;PGUSER&#125; -c "\l" | awk '&#123;print$1&#125;' | xargs)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对每个数据库单独做逻辑备份</span></span><br><span class="line">for DB in $DATABASES;do</span><br><span class="line">    pg_dump --host=$&#123;PGHOST&#125; --port=$&#123;PGPORT&#125; --username=$&#123;PGUSER&#125; --verbose --clean --create $&#123;DB&#125; | gzip -c &gt; $&#123;BACKUP_DIR&#125;/$&#123;FILENAME&#125;_$&#123;DB&#125;.gz</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份整个数据库</span></span><br><span class="line">pg_dumpall --host=$&#123;PGHOST&#125; --port=$&#123;PGPORT&#125; --username=$&#123;PGUSER&#125; --verbose --clean | gzip -c &gt; $&#123;BACKUP_DIR&#125;/$&#123;FILENAME&#125;_all.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查找备份目录修改时间大于30天的文件并清理</span></span><br><span class="line">find $&#123;BASE_DIR&#125;/ -mtime +30 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><h1 id="物理备份"><a href="#物理备份" class="headerlink" title="物理备份"></a>物理备份</h1><h2 id="在线热备份"><a href="#在线热备份" class="headerlink" title="在线热备份"></a>在线热备份</h2><h3 id="pg-basebackup"><a href="#pg-basebackup" class="headerlink" title="pg_basebackup"></a>pg_basebackup</h3><blockquote><p>PostgreSQL自带的一个远程热备工具，可以将远程PostgreSQL热备到本地目录</p></blockquote><h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><ul><li><p>连接到一个远程PostgreSQL</p></li><li><p>执行pg_start_backup</p></li><li><p>将整个数据目录传输到本地</p></li><li><p>执行pg_stop_backup命令</p></li></ul><h4 id="命令示例"><a href="#命令示例" class="headerlink" title="命令示例"></a>命令示例</h4><blockquote><p>使用<code>postgres</code>用户将<code>192.168.1.1:5432</code>PostgreSQL的数据备份到<code>/path/to/data_dir</code>目录</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_basebackup -h 192.168.1.1 -p 5432 -U postgres -D /path/to/data_dir</span><br></pre></td></tr></table></figure><h3 id="pg-rman"><a href="#pg-rman" class="headerlink" title="pg_rman"></a>pg_rman</h3><blockquote><p>PostgreSQL的备份与恢复工具，支持全量、增量、归档三种备方式，支持数据压缩与备份集管理。</p><p>pg_rman跑的不是流复制协议，而是文件拷贝，所以pg_rman必须与数据库服务器跑在同一台机器。</p><p>具体用法可以看德哥的<a href="https://github.com/digoal/blog/blob/master/201608/20160826_01.md" target="_blank" rel="noopener">文档</a></p><p><a href="https://github.com/ossc-db/pg_rman" target="_blank" rel="noopener">项目首页</a></p></blockquote><h4 id="工作流程-1"><a href="#工作流程-1" class="headerlink" title="工作流程"></a>工作流程</h4><ul><li>连接到本地PostgreSQL</li><li>执行pg_start_backup</li><li>全量备份文件或者通过比较数据文件块的lsn号进行增量备份</li><li>执行pg_stop_backup命令</li><li>备份归档日志</li></ul><h4 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h4><ul><li>开启归档<ul><li><code>archive_mode = on</code></li><li><code>archive_command = &#39;cp %p /data/pg-archlog/%f&#39;</code></li></ul></li><li>配置csvlog<ul><li><code>log_destination = csvlog</code></li><li><code>log_directory = pg_log</code></li></ul></li></ul><h1 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;基于PostgreSQL 10.8版本做演示&lt;/p&gt;&lt;p&gt;其他版本自行调整&lt;/p&gt;&lt;/blockquote&gt;&lt;h1 
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10搭建时间序列数据库TimescaleDB</title>
    <link href="https://luanlengli.github.io/2019/05/25/PostgreSQL10%E6%90%AD%E5%BB%BA%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%BA%93TimescaleDB.html"/>
    <id>https://luanlengli.github.io/2019/05/25/PostgreSQL10搭建时间序列数据库TimescaleDB.html</id>
    <published>2019-05-25T06:05:38.000Z</published>
    <updated>2019-05-29T03:33:40.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>这里只记录搭建和简单测试过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能完整跑起来</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>PostgreSQL版本号<code>10.8</code></p><p>TimescaleDB版本号<code>1.3.0</code></p><p>虚拟机配置<code>1CPU 2G内存 20G系统盘</code></p><p><code>postgres</code>用户默认情况下PGDATA变量是<code>/var/lib/pgsql/10/data</code></p><font color="red">这里没有使用数据盘，有需要的可以自行调整！</font></blockquote><h1 id="TimescaleDB简介"><a href="#TimescaleDB简介" class="headerlink" title="TimescaleDB简介"></a>TimescaleDB简介</h1><p><font color="red">这段介绍是来自德哥的Github文档</font><a href="https://github.com/digoal/blog/blob/master/201704/20170409_05.md" target="_blank" rel="noopener">TimescaleDB介绍</a></p><blockquote><p>TimescaleDB是基于PostgreSQL数据库打造的一款时序数据库，插件化的形式，随着PostgreSQL的版本升级而升级。</p></blockquote><h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="https://github.com/digoal/blog/raw/master/201704/20170409_05_pic_001.jpg" alt=""></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h2><p>这个参考<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html">PostgreSQL10安装部署和初始化</a></p><h1 id="TimescaleDB安装"><a href="#TimescaleDB安装" class="headerlink" title="TimescaleDB安装"></a>TimescaleDB安装</h1><blockquote><p>TimescaleDB的YUM包已经被集成到PostgreSQL社区源里面，所以直接装就是了</p></blockquote><h2 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y timescaledb_10</span><br></pre></td></tr></table></figure><h2 id="配置PostgreSQL"><a href="#配置PostgreSQL" class="headerlink" title="配置PostgreSQL"></a>配置PostgreSQL</h2><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><blockquote><p>在<code>$PGDATA/postgresql.conf</code>添加配置</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shared_preload_libraries = 'timescaledb'</span><br></pre></td></tr></table></figure><h2 id="重启PostgreSQL"><a href="#重启PostgreSQL" class="headerlink" title="重启PostgreSQL"></a>重启PostgreSQL</h2><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">pg_ctl restart -D $PGDATA</span><br></pre></td></tr></table></figure><h2 id="验证TimescaleDB功能"><a href="#验证TimescaleDB功能" class="headerlink" title="验证TimescaleDB功能"></a>验证TimescaleDB功能</h2><blockquote><p>登录PostgreSQL</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><blockquote><p>创建名为<code>tutorial</code>的数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">database</span> tutorial;</span><br></pre></td></tr></table></figure><blockquote><p>切换到<code>tutorial</code>数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\c tutorial</span><br></pre></td></tr></table></figure><blockquote><p>加载TimescaleDB的extensions</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> timescaledb <span class="keyword">CASCADE</span>;</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">WARNING:</span><br><span class="line">WELCOME TO</span><br><span class="line"> _____ _                               _     ____________</span><br><span class="line">|_   _(_)                             | |    |  _  \ ___ \</span><br><span class="line">  | |  _ _ __ ___   ___  ___  ___ __ _| | ___| | | | |_/ /</span><br><span class="line">  | | | |  _ ` _ \ / _ \/ __|/ __/ _` | |/ _ \ | | | ___ \</span><br><span class="line">  | | | | | | | | |  __/\__ \ (_| (_| | |  __/ |/ /| |_/ /</span><br><span class="line">  |_| |_|_| |_| |_|\___||___/\___\__,_|_|\___|___/ \____/</span><br><span class="line">               Running version 1.3.0</span><br><span class="line">For more information on TimescaleDB, please visit the following links:</span><br><span class="line"></span><br><span class="line"> 1. Getting started: https://docs.timescale.com/getting-started</span><br><span class="line"> 2. API reference documentation: https://docs.timescale.com/api</span><br><span class="line"> 3. How TimescaleDB is designed: https://docs.timescale.com/introduction/architecture</span><br><span class="line"></span><br><span class="line">Note: TimescaleDB collects anonymous reports to better understand and assist our users.</span><br><span class="line">For more information and how to disable, please see our docs https://docs.timescaledb.com/using-timescaledb/telemetry.</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br></pre></td></tr></table></figure><blockquote><p>创建一个普通SQL标准的表</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> conditions (</span><br><span class="line">  <span class="built_in">time</span>        TIMESTAMPTZ       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  location    <span class="built_in">TEXT</span>              <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  temperature <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>  <span class="literal">NULL</span>,</span><br><span class="line">  humidity    <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>  <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>查看表结构</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># \d conditions</span></span><br><span class="line">                        Table "public.conditions"</span><br><span class="line">   Column    |           Type           | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+--------------------------+-----------+----------+---------</span></span><br><span class="line"> time        | timestamp <span class="keyword">with</span> <span class="built_in">time</span> zone |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> location    | <span class="built_in">text</span>                     |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> temperature | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"> humidity    | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br></pre></td></tr></table></figure><blockquote><p>使用<code>create_hypertable</code>创建<code>hypertable</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> create_hypertable(<span class="string">'conditions'</span>, <span class="string">'time'</span>);</span><br><span class="line">    create_hypertable</span><br><span class="line"><span class="comment">-------------------------</span></span><br><span class="line"> (1,public,conditions,t)</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><blockquote><p>这时再看表结构的时候，会发现不一样了</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># \d conditions</span></span><br><span class="line">                        Table "public.conditions"</span><br><span class="line">   Column    |           Type           | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+--------------------------+-----------+----------+---------</span></span><br><span class="line"> time        | timestamp <span class="keyword">with</span> <span class="built_in">time</span> zone |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> location    | <span class="built_in">text</span>                     |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> temperature | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"> humidity    | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"><span class="keyword">Indexes</span>:</span><br><span class="line">    <span class="string">"conditions_time_idx"</span> btree (<span class="string">"time"</span> <span class="keyword">DESC</span>)</span><br><span class="line"><span class="keyword">Triggers</span>:</span><br><span class="line">    ts_insert_blocker <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> conditions <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> _timescaledb_internal.insert_blocker()</span><br></pre></td></tr></table></figure><blockquote><p>插入数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># INSERT INTO conditions(time, location, temperature, humidity) VALUES (NOW(), 'office', 70.0, 50.0);</span></span><br></pre></td></tr></table></figure><blockquote><p>查询数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># SELECT * FROM conditions ORDER BY time DESC LIMIT 100;</span></span><br><span class="line">             time              | location | temperature | humidity</span><br><span class="line"><span class="comment">-------------------------------+----------+-------------+----------</span></span><br><span class="line"> YYYY-MM-DD HH:mm:SS.354351+08 | office   |          70 |       50</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h1 id="TimescaleDB-Tutorials"><a href="#TimescaleDB-Tutorials" class="headerlink" title="TimescaleDB Tutorials"></a>TimescaleDB Tutorials</h1><blockquote><p>这里使用TimescaleDB官方的测试样例</p><p>地址在<a href="https://docs.timescale.com/v1.3/tutorials" target="_blank" rel="noopener">这里</a></p></blockquote><h2 id="纽约TAXI数据透视分析"><a href="#纽约TAXI数据透视分析" class="headerlink" title="纽约TAXI数据透视分析"></a>纽约TAXI数据透视分析</h2><h3 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h3><blockquote><p>这里直接下载的同时解压压缩包</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://timescaledata.blob.core.windows.net/datasets/nyc_data.tar.gz | tar xz</span><br></pre></td></tr></table></figure><blockquote><p>解压出来有三个文件</p></blockquote><ul><li><code>nyc_data_contagg.sql</code></li><li><code>nyc_data.sql</code></li><li><code>nyc_data_rides.csv</code></li></ul><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nyc_data;</span><br><span class="line">\c nyc_data</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> timescaledb <span class="keyword">CASCADE</span>;</span><br></pre></td></tr></table></figure><h4 id="创建表结构"><a href="#创建表结构" class="headerlink" title="创建表结构"></a>创建表结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -d nyc_data -h localhost &lt; nyc_data.sql</span><br></pre></td></tr></table></figure><h4 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -d nyc_data -h localhost -c "\COPY rides FROM nyc_data_rides.csv CSV"</span><br></pre></td></tr></table></figure><h4 id="查看表"><a href="#查看表" class="headerlink" title="查看表"></a>查看表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \dt</span></span><br><span class="line">             List of relations</span><br><span class="line"> Schema |     Name      | Type  |  Owner</span><br><span class="line"><span class="comment">--------+---------------+-------+----------</span></span><br><span class="line"> public | payment_types | table | postgres</span><br><span class="line"> public | rates         | table | postgres</span><br><span class="line"> public | rides         | table | postgres</span><br><span class="line">(3 rows)</span><br></pre></td></tr></table></figure><h4 id="查看表结构"><a href="#查看表结构" class="headerlink" title="查看表结构"></a>查看表结构</h4><ul><li>payments</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \d payment_types</span></span><br><span class="line">              Table "public.payment_types"</span><br><span class="line">    Column    |  Type   | Collation | Nullable | Default</span><br><span class="line"><span class="comment">--------------+---------+-----------+----------+---------</span></span><br><span class="line"> payment_type | integer |           |          |</span><br><span class="line"> description  | text    |           |          |</span><br></pre></td></tr></table></figure><ul><li>rates</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \d rates</span></span><br><span class="line">                  Table "public.rates"</span><br><span class="line">   Column    |  Type   | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+---------+-----------+----------+---------</span></span><br><span class="line"> rate_code   | integer |           |          |</span><br><span class="line"> description | text    |           |          |</span><br></pre></td></tr></table></figure><ul><li>rides</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># \d+ rides;</span></span><br><span class="line">                                                     Table "public.rides"</span><br><span class="line">        Column         |            Type             | Collation | Nullable | Default | Storage  | Stats target | Description</span><br><span class="line"><span class="comment">-----------------------+-----------------------------+-----------+----------+---------+----------+--------------+-------------</span></span><br><span class="line"> vendor_id             | text                        |           |          |         | extended |              |</span><br><span class="line"> pickup_datetime       | timestamp without time zone |           | not null |         | plain    |              |</span><br><span class="line"> dropoff_datetime      | timestamp without time zone |           | not null |         | plain    |              |</span><br><span class="line"> passenger_count       | numeric                     |           |          |         | main     |              |</span><br><span class="line"> trip_distance         | numeric                     |           |          |         | main     |              |</span><br><span class="line"> pickup_longitude      | numeric                     |           |          |         | main     |              |</span><br><span class="line"> pickup_latitude       | numeric                     |           |          |         | main     |              |</span><br><span class="line"> rate_code             | integer                     |           |          |         | plain    |              |</span><br><span class="line"> dropoff_longitude     | numeric                     |           |          |         | main     |              |</span><br><span class="line"> dropoff_latitude      | numeric                     |           |          |         | main     |              |</span><br><span class="line"> payment_type          | integer                     |           |          |         | plain    |              |</span><br><span class="line"> fare_amount           | numeric                     |           |          |         | main     |              |</span><br><span class="line"> extra                 | numeric                     |           |          |         | main     |              |</span><br><span class="line"> mta_tax               | numeric                     |           |          |         | main     |              |</span><br><span class="line"> tip_amount            | numeric                     |           |          |         | main     |              |</span><br><span class="line"> tolls_amount          | numeric                     |           |          |         | main     |              |</span><br><span class="line"> improvement_surcharge | numeric                     |           |          |         | main     |              |</span><br><span class="line"> total_amount          | numeric                     |           |          |         | main     |              |</span><br><span class="line">Indexes:</span><br><span class="line">    "rides_passenger_count_pickup_datetime_idx" btree (passenger_count, pickup_datetime DESC)</span><br><span class="line">    "rides_pickup_datetime_vendor_id_idx" btree (pickup_datetime DESC, vendor_id)</span><br><span class="line">    "rides_rate_code_pickup_datetime_idx" btree (rate_code, pickup_datetime DESC)</span><br><span class="line">    "rides_vendor_id_pickup_datetime_idx" btree (vendor_id, pickup_datetime DESC)</span><br><span class="line">Triggers:</span><br><span class="line">    ts_insert_blocker BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> rides <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> _timescaledb_internal.insert_blocker()</span><br><span class="line"><span class="keyword">Child</span> <span class="keyword">tables</span>: _timescaledb_internal._hyper_2_10_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_11_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_12_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_1_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_2_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_3_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_4_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_5_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_6_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_7_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_8_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_9_chunk</span><br></pre></td></tr></table></figure><h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><h4 id="普通查询"><a href="#普通查询" class="headerlink" title="普通查询"></a>普通查询</h4><blockquote><p>1月1日至1月10日，同车超过两人，每天平均计费是多少</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT date_trunc('day', pickup_datetime) as day, avg(fare_amount)</span></span><br><span class="line">nyc_data-<span class="comment"># FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># WHERE passenger_count &gt; 1 AND (pickup_datetime &gt;= '2016-01-01' AND pickup_datetime &lt;= '2016-01-10')</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY day ORDER BY day;</span></span><br><span class="line">         day         |         avg</span><br><span class="line"><span class="comment">---------------------+---------------------</span></span><br><span class="line"> 2016-01-01 00:00:00 | 13.3990821679715529</span><br><span class="line"> 2016-01-02 00:00:00 | 13.0224687415181399</span><br><span class="line"> 2016-01-03 00:00:00 | 13.5382068607068607</span><br><span class="line"> 2016-01-04 00:00:00 | 12.9618895561740149</span><br><span class="line"> 2016-01-05 00:00:00 | 12.6614611935518309</span><br><span class="line"> 2016-01-06 00:00:00 | 12.5775245695086098</span><br><span class="line"> 2016-01-07 00:00:00 | 12.5868802584437019</span><br><span class="line"> 2016-01-08 00:00:00 | 12.4288630909742120</span><br><span class="line"> 2016-01-09 00:00:00 | 11.8049625897430078</span><br><span class="line"> 2016-01-10 00:00:00 | 27.2500000000000000</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure><blockquote><p>查询每天交易了多少笔，只显示头五个记录</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT date_trunc('day', pickup_datetime) as day, COUNT(*) FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY day ORDER BY day</span></span><br><span class="line">nyc_data-<span class="comment"># LIMIT 5;</span></span><br><span class="line">         day         | count</span><br><span class="line"><span class="comment">---------------------+--------</span></span><br><span class="line"> 2016-01-01 00:00:00 | 345037</span><br><span class="line"> 2016-01-02 00:00:00 | 312831</span><br><span class="line"> 2016-01-03 00:00:00 | 302878</span><br><span class="line"> 2016-01-04 00:00:00 | 316171</span><br><span class="line"> 2016-01-05 00:00:00 | 343251</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure><h4 id="使用TimescaleDB内置函数"><a href="#使用TimescaleDB内置函数" class="headerlink" title="使用TimescaleDB内置函数"></a>使用TimescaleDB内置函数</h4><blockquote><p>每5分钟间隔为一个BUCKET，输出每个间隔产生了多少笔订单</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT time_bucket('5 minute', pickup_datetime) as five_min, count(*)  </span></span><br><span class="line">nyc_data=<span class="comment"># FROM rides  </span></span><br><span class="line">nyc_data=<span class="comment"># WHERE pickup_datetime &lt; '2016-01-01 02:00'  </span></span><br><span class="line">nyc_data=<span class="comment"># GROUP BY five_min ORDER BY five_min; </span></span><br><span class="line"></span><br><span class="line">      five_min       | count</span><br><span class="line"><span class="comment">---------------------+-------</span></span><br><span class="line"> 2016-01-01 00:00:00 |   703</span><br><span class="line"> 2016-01-01 00:05:00 |  1482</span><br><span class="line"> 2016-01-01 00:10:00 |  1959</span><br><span class="line"> 2016-01-01 00:15:00 |  2200</span><br><span class="line"> 2016-01-01 00:20:00 |  2285</span><br><span class="line"> 2016-01-01 00:25:00 |  2291</span><br><span class="line"> 2016-01-01 00:30:00 |  2349</span><br><span class="line"> 2016-01-01 00:35:00 |  2328</span><br><span class="line"> 2016-01-01 00:40:00 |  2440</span><br><span class="line"> 2016-01-01 00:45:00 |  2372</span><br><span class="line"> 2016-01-01 00:50:00 |  2388</span><br><span class="line"> 2016-01-01 00:55:00 |  2473</span><br><span class="line"> 2016-01-01 01:00:00 |  2395</span><br><span class="line"> 2016-01-01 01:05:00 |  2510</span><br><span class="line"> 2016-01-01 01:10:00 |  2412</span><br><span class="line"> 2016-01-01 01:15:00 |  2482</span><br><span class="line"> 2016-01-01 01:20:00 |  2428</span><br><span class="line"> 2016-01-01 01:25:00 |  2433</span><br><span class="line"> 2016-01-01 01:30:00 |  2337</span><br><span class="line"> 2016-01-01 01:35:00 |  2366</span><br><span class="line"> 2016-01-01 01:40:00 |  2325</span><br><span class="line"> 2016-01-01 01:45:00 |  2257</span><br><span class="line"> 2016-01-01 01:50:00 |  2316</span><br><span class="line"> 2016-01-01 01:55:00 |  2250</span><br><span class="line">(24 rows)</span><br></pre></td></tr></table></figure><blockquote><p>每个城市的TAXI交易量</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT rates.description, COUNT(vendor_id) as num_trips FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># JOIN rates on rides.rate_code = rates.rate_code</span></span><br><span class="line">nyc_data-<span class="comment"># WHERE pickup_datetime &lt; '2016-01-08'</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY rates.description ORDER BY rates.description;</span></span><br><span class="line">      description      | num_trips</span><br><span class="line"><span class="comment">-----------------------+-----------</span></span><br><span class="line"> group ride            |        17</span><br><span class="line"> JFK                   |     54832</span><br><span class="line"> Nassau or Westchester |       967</span><br><span class="line"> negotiated fare       |      7193</span><br><span class="line"> Newark                |      4126</span><br><span class="line"> standard rate         |   2266401</span><br><span class="line">(6 rows)</span><br></pre></td></tr></table></figure><h4 id="查看select执行计划"><a href="#查看select执行计划" class="headerlink" title="查看select执行计划"></a>查看select执行计划</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># EXPLAIN SELECT * FROM rides;</span></span><br><span class="line">                                    QUERY PLAN</span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"> Append  (cost=0.00..282354.03 rows=5963403 width=258)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_1_chunk  (cost=0.00..23485.78 rows=781178 width=113)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_2_chunk  (cost=0.00..36322.06 rows=1187506 width=115)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_3_chunk  (cost=0.00..32909.67 rows=1075467 width=116)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_4_chunk  (cost=0.00..15601.72 rows=518772 width=112)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_5_chunk  (cost=0.00..20396.28 rows=281328 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_6_chunk  (cost=0.00..41670.68 rows=574768 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_7_chunk  (cost=0.00..20921.76 rows=288576 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_8_chunk  (cost=0.00..42966.40 rows=592640 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_9_chunk  (cost=0.00..15160.04 rows=209104 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_10_chunk  (cost=0.00..32896.44 rows=453744 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_11_chunk  (cost=0.00..11.60 rows=160 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_12_chunk  (cost=0.00..11.60 rows=160 width=472)</span><br><span class="line">(13 rows)</span><br></pre></td></tr></table></figure><h3 id="配合PostGIS插件实现时间-空间数据库"><a href="#配合PostGIS插件实现时间-空间数据库" class="headerlink" title="配合PostGIS插件实现时间+空间数据库"></a>配合PostGIS插件实现时间+空间数据库</h3><h4 id="安装PostGIS"><a href="#安装PostGIS" class="headerlink" title="安装PostGIS"></a>安装PostGIS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgis25_10</span><br></pre></td></tr></table></figure><h4 id="加载PostGIS"><a href="#加载PostGIS" class="headerlink" title="加载PostGIS"></a>加载PostGIS</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># create extension postgis;</span></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br></pre></td></tr></table></figure><h4 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># ALTER TABLE rides ADD COLUMN pickup_geom geometry(POINT,2163);</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span></span><br><span class="line">postgres=<span class="comment"># ALTER TABLE rides ADD COLUMN dropoff_geom geometry(POINT,2163);</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span></span><br><span class="line">postgres=<span class="comment"># UPDATE rides SET pickup_geom = ST_Transform(ST_SetSRID(ST_MakePoint(pickup_longitude,pickup_latitude),4326),2163);</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">10906860</span></span><br><span class="line">postgres=<span class="comment"># UPDATE rides SET dropoff_geom = ST_Transform(ST_SetSRID(ST_MakePoint(dropoff_longitude,dropoff_latitude),4326),2163);</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">10906860</span></span><br></pre></td></tr></table></figure><h4 id="查询数据-1"><a href="#查询数据-1" class="headerlink" title="查询数据"></a>查询数据</h4><blockquote><p>查询在(lat, long) (40.7589,-73.9851)附近400米范围内，每30分钟有多少辆的士被乘坐</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># SELECT time_bucket('30 minutes', pickup_datetime) AS thirty_min, COUNT(*) AS near_times_sq</span></span><br><span class="line">postgres-<span class="comment">#   FROM rides</span></span><br><span class="line">postgres-<span class="comment">#   WHERE ST_Distance(pickup_geom, ST_Transform(ST_SetSRID(ST_MakePoint(-73.9851,40.7589),4326),2163)) &lt; 400</span></span><br><span class="line">postgres-<span class="comment">#     AND pickup_datetime &lt; '2016-01-01 14:00'</span></span><br><span class="line">postgres-<span class="comment">#   GROUP BY thirty_min ORDER BY thirty_min;</span></span><br><span class="line">     thirty_min      | near_times_sq</span><br><span class="line"><span class="comment">---------------------+---------------</span></span><br><span class="line"> 2016-01-01 00:00:00 |            74</span><br><span class="line"> 2016-01-01 00:30:00 |           102</span><br><span class="line"> 2016-01-01 01:00:00 |           120</span><br><span class="line"> 2016-01-01 01:30:00 |            98</span><br><span class="line"> 2016-01-01 02:00:00 |           112</span><br><span class="line"> 2016-01-01 02:30:00 |           109</span><br><span class="line"> 2016-01-01 03:00:00 |           163</span><br><span class="line"> 2016-01-01 03:30:00 |           181</span><br><span class="line"> 2016-01-01 04:00:00 |           214</span><br><span class="line"> 2016-01-01 04:30:00 |           185</span><br><span class="line"> 2016-01-01 05:00:00 |           158</span><br><span class="line"> 2016-01-01 05:30:00 |           113</span><br><span class="line"> 2016-01-01 06:00:00 |           102</span><br><span class="line"> 2016-01-01 06:30:00 |            91</span><br><span class="line"> 2016-01-01 07:00:00 |            88</span><br><span class="line"> 2016-01-01 07:30:00 |            58</span><br><span class="line"> 2016-01-01 08:00:00 |            72</span><br><span class="line"> 2016-01-01 08:30:00 |            94</span><br><span class="line"> 2016-01-01 09:00:00 |           115</span><br><span class="line"> 2016-01-01 09:30:00 |           118</span><br><span class="line"> 2016-01-01 10:00:00 |           135</span><br><span class="line"> 2016-01-01 10:30:00 |           160</span><br><span class="line"> 2016-01-01 11:00:00 |           212</span><br><span class="line"> 2016-01-01 11:30:00 |           229</span><br><span class="line"> 2016-01-01 12:00:00 |           244</span><br><span class="line"> 2016-01-01 12:30:00 |           230</span><br><span class="line"> 2016-01-01 13:00:00 |           235</span><br><span class="line"> 2016-01-01 13:30:00 |           238</span><br><span class="line">(28 rows)</span><br></pre></td></tr></table></figure><h1 id="TimescaleDB集群"><a href="#TimescaleDB集群" class="headerlink" title="TimescaleDB集群"></a>TimescaleDB集群</h1><blockquote><p>由于TimescaleDB是PostgreSQL的一个插件，因此可以借助PostgreSQL自身的特性实现集群功能</p></blockquote><ul><li>基于流复制实现主从数据同步</li><li>基于PGPool实现读写分离+主从自动切换</li><li>基于patroni实现高可用集群</li><li>基于PostgreSQL-X2实现多主多读+横向扩展的分布式集群</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里只记录搭建和简单测试过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
</feed>
