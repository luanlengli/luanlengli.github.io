<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>luanlengli&#39;s Blog</title>
  
  <subtitle>“不知道”的五大理由，不读，不查，不试，理解能力差，满脑子想着怎么利用他人</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://luanlengli.github.io/"/>
  <updated>2019-06-18T09:40:20.779Z</updated>
  <id>https://luanlengli.github.io/</id>
  
  <author>
    <name>乱愣黎</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>kubeadm部署kubernetes-v1.13.x集群</title>
    <link href="https://luanlengli.github.io/2019/06/12/kubeadm%E9%83%A8%E7%BD%B2kubernetes-1.13.x%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2019/06/12/kubeadm部署kubernetes-1.13.x集群.html</id>
    <published>2019-06-12T08:56:50.000Z</published>
    <updated>2019-06-18T09:40:20.779Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>根据kubernetes v1.13的<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md#kubernetes-113-release-notes" target="_blank" rel="noopener">Release Note</a>说明</p><p>从Kubernetes v1.13.x开始，kubeadm的<code>kubeadm.k8s.io/v1alpha3</code>被标记为废弃并将于kubernetes v1.14版开始被移除，新的apiVersion为<code>kubeadm.k8s.io/v1beta1</code></p><p>这里是关于<code>kubeadm.k8s.io/v1beta1</code>的<a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta1" target="_blank" rel="noopener">说明文档</a></p><p>下面演示环境使用1个master节点+2个node节点部署kubernetes集群</p><p>仅记录我的部署流程，不一定满足各种需求，自己看菜吃饭！</p></blockquote><h1 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h1><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th><th>操作系统</th><th>Docker版本</th><th>kubeadm版本</th></tr></thead><tbody><tr><td>k8s-master</td><td>172.16.80.200</td><td>master+node</td><td>CentOS-7.6.1810</td><td>18.09.6</td><td>v1.13.7</td></tr><tr><td>k8s-node1</td><td>172.16.80.201</td><td>node</td><td>CentOS-7.6.1810</td><td>18.09.6</td><td>v1.13.7</td></tr><tr><td>k8s-node2</td><td>172.16.80.202</td><td>node</td><td>CentOS-7.6.1810</td><td>18.09.6</td><td>v1.13.7</td></tr></tbody></table><h1 id="服务器初始化"><a href="#服务器初始化" class="headerlink" title="服务器初始化"></a>服务器初始化</h1><blockquote><p>参考<a href="https://luanlengli.github.io/2018/12/05/CentOS-7-6-1810-虚拟机模板制作.html">CentOS-7.6(1810)虚拟机模板制作</a></p></blockquote><h2 id="配置-etc-hosts"><a href="#配置-etc-hosts" class="headerlink" title="配置/etc/hosts"></a>配置/etc/hosts</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1   localhost</span><br><span class="line">::1         localhost</span><br><span class="line">172.16.80.200 k8s-master</span><br><span class="line">172.16.80.201 k8s-node1</span><br><span class="line">172.16.80.202 k8s-node2</span><br></pre></td></tr></table></figure><h2 id="禁用swap分区"><a href="#禁用swap分区" class="headerlink" title="禁用swap分区"></a>禁用swap分区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab</span><br></pre></td></tr></table></figure><h1 id="部署kubernetes集群"><a href="#部署kubernetes集群" class="headerlink" title="部署kubernetes集群"></a>部署kubernetes集群</h1><h2 id="创建YUM源"><a href="#创建YUM源" class="headerlink" title="创建YUM源"></a>创建YUM源</h2><blockquote><p>使用阿里云的kubernetes YUM源</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></table></figure><h2 id="刷新YUM缓存"><a href="#刷新YUM缓存" class="headerlink" title="刷新YUM缓存"></a>刷新YUM缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h2 id="安装kubernetes-v1-13-7"><a href="#安装kubernetes-v1-13-7" class="headerlink" title="安装kubernetes-v1.13.7"></a>安装kubernetes-v1.13.7</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install kubeadm-1.13.7-0.x86_64 kubelet-1.13.7-0.x86_64 kubectl-1.13.7-0.x86_64 cri-tools-1.12.0-0.x86_64 kubernetes-cni-0.7.5-0.x86_64</span><br></pre></td></tr></table></figure><h2 id="添加bash自动补全命令"><a href="#添加bash自动补全命令" class="headerlink" title="添加bash自动补全命令"></a>添加bash自动补全命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm completion bash &gt; /etc/bash_completion.d/kubeadm</span><br><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br></pre></td></tr></table></figure><h2 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h2><p>kubeadm的配置文件被拆分成了以下几个类型</p><ul><li><code>InitConfiguration</code></li><li><code>ClusterConfiguration</code></li><li><code>KubeletConfiguration</code></li><li><code>KubeProxyConfiguration</code></li><li><code>JoinConfiguration</code></li></ul><p>对应到配置文件里面的格式如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">JoinConfiguration</span></span><br></pre></td></tr></table></figure><h2 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h2><blockquote><p>kubeadm命令可以打印<code>InitConfiguration</code>、<code>ClusterConfiguration</code>和<code>JoinConfiguration</code>的默认配置</p></blockquote><h3 id="init-defaults"><a href="#init-defaults" class="headerlink" title="init-defaults"></a>init-defaults</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults</span><br></pre></td></tr></table></figure><h4 id="输出示例"><a href="#输出示例" class="headerlink" title="输出示例"></a>输出示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="attr">- groups:</span></span><br><span class="line"><span class="attr">  - system:</span><span class="attr">bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="attr">  token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">  ttl:</span> <span class="number">24</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">  usages:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">signing</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line"><span class="attr">  advertiseAddress:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line"><span class="attr">  bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="attr">  taints:</span></span><br><span class="line"><span class="attr">  - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line"><span class="attr">  timeoutForControlPlane:</span> <span class="number">4</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">controllerManager:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.13.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line"><span class="attr">  dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="attr">  podSubnet:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h3 id="join-defaults"><a href="#join-defaults" class="headerlink" title="join-defaults"></a>join-defaults</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print join-defaults</span><br></pre></td></tr></table></figure><h4 id="输出示例-1"><a href="#输出示例-1" class="headerlink" title="输出示例"></a>输出示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">caCertPath:</span> <span class="string">/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">  bootstrapToken:</span></span><br><span class="line"><span class="attr">    apiServerEndpoint:</span> <span class="attr">kube-apiserver:6443</span></span><br><span class="line"><span class="attr">    token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">    unsafeSkipCAVerification:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  timeout:</span> <span class="number">5</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">  tlsBootstrapToken:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">JoinConfiguration</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-master</span></span><br></pre></td></tr></table></figure><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><blockquote><p>对于没有设置或者配置了一部分的参数，kubeadm会使用默认值</p><p>这里精简了很多配置，自己决定是否增加配置！</p></blockquote><p><code>kubeadm-init.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># InitConfiguration影响master节点初始化时，kubelet的配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="comment">#bootstrapTokens:</span></span><br><span class="line"><span class="comment">#- groups:</span></span><br><span class="line"><span class="comment">#  - system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="comment">#  token: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="comment">#  ttl: 24h0m0s</span></span><br><span class="line"><span class="comment">#  usages:</span></span><br><span class="line"><span class="comment">#  - signing</span></span><br><span class="line"><span class="comment">#  - authentication</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="comment"># master节点默认会加taints</span></span><br><span class="line"><span class="attr">  taints:</span></span><br><span class="line"><span class="attr">  - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">  kubeletExtraArgs:</span></span><br><span class="line"><span class="attr">    pod-infra-container-image:</span> <span class="string">"k8s.gcr.io/pause:3.1"</span></span><br><span class="line"><span class="attr">    network-plugin:</span> <span class="string">cni</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubeadm生成证书、manifest目录、staticPod的配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="comment"># kube-apiserver配置</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line"><span class="attr">  timeoutForControlPlane:</span> <span class="number">4</span><span class="string">m0s</span></span><br><span class="line">  <span class="comment"># 配置证书的SANs</span></span><br><span class="line"><span class="attr">  certSANs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">localhost</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes.default</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes.default.svc</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.200</span></span><br><span class="line">  <span class="comment"># 配置apiserver启动参数</span></span><br><span class="line"><span class="attr">  extraArgs:</span></span><br><span class="line"><span class="attr">    authorization-mode:</span> <span class="string">"Node,RBAC"</span></span><br><span class="line"><span class="attr">    runtime-config:</span> <span class="string">"api/all=true"</span></span><br><span class="line">  <span class="comment"># 配置apiserver容器挂载volume</span></span><br><span class="line"><span class="attr">  extraVolumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"timezone-volume"</span></span><br><span class="line"><span class="attr">    hostPath:</span> <span class="string">"/usr/share/zoneinfo/Asia/Shanghai"</span></span><br><span class="line"><span class="attr">    mountPath:</span> <span class="string">"/etc/localtime"</span></span><br><span class="line"><span class="attr">    readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    pathType:</span> <span class="string">File</span></span><br><span class="line"><span class="comment"># 配置证书目录</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="comment"># 配置集群名字</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">""</span></span><br><span class="line"><span class="comment"># kube-controller-manager配置</span></span><br><span class="line"><span class="attr">controllerManager:</span></span><br><span class="line">  <span class="comment"># 配置controller-manager启动参数</span></span><br><span class="line"><span class="attr">  extraArgs:</span></span><br><span class="line"><span class="attr">    address:</span> <span class="string">"127.0.0.1"</span></span><br><span class="line"><span class="attr">    horizontal-pod-autoscaler-use-rest-clients:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">    horizontal-pod-autoscaler-sync-period:</span> <span class="string">"10s"</span></span><br><span class="line"><span class="attr">    node-monitor-grace-period:</span> <span class="string">"10s"</span></span><br><span class="line"><span class="attr">  extraVolumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"timezone-volume"</span></span><br><span class="line"><span class="attr">    hostPath:</span> <span class="string">"/usr/share/zoneinfo/Asia/Shanghai"</span></span><br><span class="line"><span class="attr">    mountPath:</span> <span class="string">"/etc/localtime"</span></span><br><span class="line"><span class="attr">    readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    pathType:</span> <span class="string">File</span></span><br><span class="line"><span class="comment"># kubernetes集群dns配置</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="comment"># 类型可选 CoreDNS 或者 kube-dns</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">  imageRepository:</span> <span class="string">"k8s.gcr.io"</span></span><br><span class="line"><span class="attr">  imageTag:</span> <span class="string">"1.2.6"</span></span><br><span class="line"><span class="comment"># etcd配置</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    imageRepository:</span> <span class="string">"k8s.gcr.io"</span></span><br><span class="line"><span class="attr">    imageTag:</span> <span class="string">"3.2.24"</span></span><br><span class="line">    <span class="comment"># etcd数据目录</span></span><br><span class="line"><span class="attr">    dataDir:</span> <span class="string">"/var/lib/etcd"</span></span><br><span class="line"><span class="attr">    extraArgs:</span></span><br><span class="line"><span class="attr">      advertise-client-urls:</span> <span class="string">"https://172.16.80.200:2379"</span></span><br><span class="line"><span class="attr">      listen-client-urls:</span> <span class="string">"https://127.0.0.1:2379,https://172.16.80.200:2379"</span></span><br><span class="line"><span class="attr">      listen-peer-urls:</span> <span class="string">"https://172.16.80.200:2380"</span></span><br><span class="line">    <span class="comment"># 配置etcd server证书的SAN</span></span><br><span class="line"><span class="attr">    serverCertSANs:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">localhost</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">::1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.200</span></span><br><span class="line">    <span class="comment"># 配置etcd peer证书的SAN</span></span><br><span class="line"><span class="attr">    peerCertSANs:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">k8s-master</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">localhost</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">::1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">172.16</span><span class="number">.80</span><span class="number">.200</span></span><br><span class="line"><span class="attr">    external:</span></span><br><span class="line"><span class="attr">      endpoints:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"k8s-master:2379"</span></span><br><span class="line"><span class="attr">      caFile:</span> <span class="string">"/etcd/kubernetes/pki/etcd/etcd-ca.crt"</span></span><br><span class="line"><span class="attr">      certFile:</span> <span class="string">"/etcd/kubernetes/pki/etcd/etcd.crt"</span></span><br><span class="line"><span class="attr">      keyFile:</span> <span class="string">"/etcd/kubernetes/pki/etcd/etcd.key"</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">"v1.13.7"</span></span><br><span class="line"><span class="comment"># kubernetes网络配置</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="comment"># DNS域名</span></span><br><span class="line"><span class="attr">  dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="comment"># Pod网络</span></span><br><span class="line"><span class="attr">  podSubnet:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line">  <span class="comment"># Service网络</span></span><br><span class="line"><span class="attr">  serviceSubnet:</span> <span class="string">"10.96.0.0/12"</span></span><br><span class="line"><span class="comment"># kube-scheduler配置</span></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line"><span class="attr">  extraArgs:</span></span><br><span class="line"><span class="attr">    address:</span> <span class="string">"127.0.0.1"</span></span><br><span class="line"><span class="attr">  extraVolumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"timezone-volume"</span></span><br><span class="line"><span class="attr">    hostPath:</span> <span class="string">"/usr/share/zoneinfo/Asia/Shanghai"</span></span><br><span class="line"><span class="attr">    mountPath:</span> <span class="string">"/etc/localtime"</span></span><br><span class="line"><span class="attr">    readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    pathType:</span> <span class="string">File</span></span><br><span class="line"><span class="comment"># 是否使用HyperKube镜像</span></span><br><span class="line"><span class="comment"># hyperkube is an all-in-one binary for the Kubernetes server components.</span></span><br><span class="line"><span class="attr">useHyperKubeImage:</span> <span class="literal">false</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 配置kubelet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="comment"># 默认配置下，kubelet检测到系统启用了swap会启动失败</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">110</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 配置kube-proxy</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">configSyncPeriod:</span> <span class="number">15</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">ipvs:</span></span><br><span class="line"><span class="attr">  scheduler:</span> <span class="string">"rr"</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">"ipvs"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 这里的配置影响kubeadm join的节点上运行的kubelet参数</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">JoinConfiguration</span></span><br><span class="line"><span class="comment">#caCertPath: /etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="comment">#discovery:</span></span><br><span class="line"><span class="comment">#  bootstrapToken:</span></span><br><span class="line"><span class="comment">#    apiServerEndpoint: kube-apiserver:6443</span></span><br><span class="line"><span class="comment">#    token: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="comment">#    unsafeSkipCAVerification: true</span></span><br><span class="line"><span class="comment">#  timeout: 5m0s</span></span><br><span class="line"><span class="comment">#  tlsBootstrapToken: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  kubeletExtraArgs:</span></span><br><span class="line"><span class="attr">    pod-infra-container-image:</span> <span class="string">"k8s.gcr.io/pause:3.1"</span></span><br><span class="line"><span class="attr">    network-plugin:</span> <span class="string">cni</span></span><br></pre></td></tr></table></figure><h2 id="检查配置文件"><a href="#检查配置文件" class="headerlink" title="检查配置文件"></a>检查配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-init.yaml --dry-run</span><br></pre></td></tr></table></figure><blockquote><p>命令执行完毕，可以在<code>/tmp/kubeadm-init-dryrun*</code>里面看到生成的配置文件</p><p>可以检查一下是否符合预期！</p></blockquote><h2 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-init.yaml</span><br></pre></td></tr></table></figure><blockquote><p>集群初始化完成之后，终端会打印出信息</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 172.16.80.200:6443 --token uqc4n7.mfs4ep1br9l9ztsi --discovery-token-ca-cert-hash sha256:b30dd4d598baf1a3a53fe794d02302788e71e4314947cf7df5a75e98dd2ed97a</span><br></pre></td></tr></table></figure><h2 id="节点加入集群"><a href="#节点加入集群" class="headerlink" title="节点加入集群"></a>节点加入集群</h2><blockquote><p>运行kubeadm init初始化集群之后的提供的join命令，将节点加入集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 172.16.80.200:6443 --token uqc4n7.mfs4ep1br9l9ztsi --discovery-token-ca-cert-hash sha256:b30dd4d598baf1a3a53fe794d02302788e71e4314947cf7df5a75e98dd2ed97a</span><br></pre></td></tr></table></figure><h2 id="查看节点信息"><a href="#查看节点信息" class="headerlink" title="查看节点信息"></a>查看节点信息</h2><blockquote><p>还没部署CNI插件，所以节点状态为NotReady</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure><ul><li>输出示例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME         STATUS     ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME</span><br><span class="line">k8s-master   NotReady   master   4m45s   v1.13.7   172.16.80.200   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node1    NotReady   &lt;none&gt;   4m18s   v1.13.7   172.16.80.201   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node2    NotReady   &lt;none&gt;   4m17s   v1.13.7   172.16.80.202   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br></pre></td></tr></table></figure><h2 id="部署CNI插件"><a href="#部署CNI插件" class="headerlink" title="部署CNI插件"></a>部署CNI插件</h2><blockquote><p>这里用flannel</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><ul><li>查看节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure><blockquote><p>可以看到节点状态为Ready</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME         STATUS   ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME</span><br><span class="line">k8s-master   Ready    master   7m13s   v1.13.7   172.16.80.200   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node1    Ready    &lt;none&gt;   6m46s   v1.13.7   172.16.80.201   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br><span class="line">k8s-node2    Ready    &lt;none&gt;   6m45s   v1.13.7   172.16.80.202   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.2.el7.x86_64   docker://18.9.6</span><br></pre></td></tr></table></figure><ul><li>查看Pod信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces -o wide --sort-by=.spec.nodeName</span><br></pre></td></tr></table></figure><blockquote><p>这里根据节点名字作为排序依据来输出结果</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   etcd-k8s-master                      1/1     Running   0          6m56s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master            1/1     Running   0          7m13s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master   1/1     Running   0          7m5s    172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-kccsf          1/1     Running   0          2m27s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-m68d5                     1/1     Running   0          7m56s   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master            1/1     Running   0          7m1s    172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-86c58d9df4-jv465             1/1     Running   0          7m56s   10.244.1.2      k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-86c58d9df4-td2nl             1/1     Running   0          7m56s   10.244.1.3      k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-s9pds          1/1     Running   0          2m27s   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-l67jr                     1/1     Running   0          7m48s   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-r6h8s          1/1     Running   0          2m27s   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-pjz5w                     1/1     Running   0          7m47s   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="master节点参与负载"><a href="#master节点参与负载" class="headerlink" title="master节点参与负载"></a>master节点参与负载</h2><blockquote><p>kubeadm部署的kubernetes集群，出于安全考虑，在初始化集群后会给master节点打上<code>node-role.kubernetes.io/master:NoSchedule</code>污点，避免Pod被调度到master节点。</p><p>作为实验环境，可以去除污点，让Pod可以调度到master节点</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes k8s-master node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure><h1 id="至此kubernetes集群已经搭建完成"><a href="#至此kubernetes集群已经搭建完成" class="headerlink" title="至此kubernetes集群已经搭建完成"></a>至此kubernetes集群已经搭建完成</h1><blockquote><p>最简化的部署！！！！</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;根据kubernetes v1.13的&lt;a href=&quot;https://github.com/kubernetes/
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Redis安装部署记录</title>
    <link href="https://luanlengli.github.io/2019/06/03/Redis%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95.html"/>
    <id>https://luanlengli.github.io/2019/06/03/Redis安装部署记录.html</id>
    <published>2019-06-03T09:19:48.000Z</published>
    <updated>2019-06-05T07:04:51.186Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>仅记录安装部署过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>可以跑起来，自己判断哪些要改的！</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>Redis版本使用<code>4.0.14</code></p><font color="red">【根据自己的环境灵活调整，生产环境请务必提供独立数据盘！】</font></blockquote><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's,SELINUX=enforcing,SELINUX=disabled,' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure><h2 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-redis.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在CentOS7.4引入了一个新的参数来控制内核的行为。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /proc/sys/fs/may_detach_mounts 默认设置为0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统有容器运行的时候，需要将该值设置为1。</span></span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1024000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改动态NAT跟踪记录参数</span></span><br><span class="line">net.netfilter.nf_conntrack_max = 655350</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=512</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核允许超量使用内存直到用完为止</span></span><br><span class="line">vm.overcommit_memory = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-redis.conf &lt;&lt;EOF</span><br><span class="line">* soft nproc 1048576</span><br><span class="line">* hard nproc 1048576</span><br><span class="line">* soft nofile 1048576</span><br><span class="line">* hard nofile 1048576</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改journal设置"><a href="#修改journal设置" class="headerlink" title="修改journal设置"></a>修改journal设置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#Compress=yes,Compress=yes,' \</span><br><span class="line">    -e 's,^#SystemMaxUse=,SystemMaxUse=1G,' \</span><br><span class="line">    -e 's,^#Seal=yes,Seal=yes,' \</span><br><span class="line">    -e 's,^#RateLimitBurst=1000,RateLimitBurst=2000,' \</span><br><span class="line">    -i /etc/systemd/journald.conf</span><br></pre></td></tr></table></figure><h2 id="更新系统软件"><a href="#更新系统软件" class="headerlink" title="更新系统软件"></a>更新系统软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc make jemalloc tcl -y</span><br></pre></td></tr></table></figure><h1 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h1><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd redis</span><br><span class="line">useradd -g redis -s /bin/false</span><br></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/software /opt/redis-data</span><br></pre></td></tr></table></figure><h2 id="下载Redis代码"><a href="#下载Redis代码" class="headerlink" title="下载Redis代码"></a>下载Redis代码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-4.0.14.tar.gz -O - | tar xz --directory=/opt/software/</span><br></pre></td></tr></table></figure><h2 id="创建软链接"><a href="#创建软链接" class="headerlink" title="创建软链接"></a>创建软链接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sv /opt/software/redis-4.0.14 /opt/software/redis</span><br></pre></td></tr></table></figure><h2 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/software/redis</span><br></pre></td></tr></table></figure><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make MALLOC=jemalloc &amp;&amp; make test &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/redis-data/redis.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听地址</span></span><br><span class="line">bind 0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 2048</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否以守护进程的方式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode yes</span><br><span class="line">supervised no</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置Redis有多少数据库</span></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义数据目录</span></span><br><span class="line">dir "/opt/redis-data"</span><br><span class="line">dbfilename "dump_6379.rdb"</span><br><span class="line">pidfile "/opt/redis-data/redis_6379.pid"</span><br><span class="line">logfile "/opt/redis-data/redis_6379.log"</span><br><span class="line">loglevel notice</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义访问redis的密码</span></span><br><span class="line">requirepass "abcd1234"</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename "redis_6379.aof"</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制最大内存使用量</span></span><br><span class="line">maxmemory 4gb</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改目录权限"><a href="#修改目录权限" class="headerlink" title="修改目录权限"></a>修改目录权限</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R redis:redis /opt/redis-data</span><br></pre></td></tr></table></figure><h2 id="启动Redis"><a href="#启动Redis" class="headerlink" title="启动Redis"></a>启动Redis</h2><blockquote><p>这里以前台方式运行Redis，查看输出日志，确认是否正常运行</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "/usr/local/bin/redis-server /opt/redis-data/redis.conf --daemonize no" redis</span><br></pre></td></tr></table></figure><h2 id="systemd服务"><a href="#systemd服务" class="headerlink" title="systemd服务"></a>systemd服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis In-Memory Data Store</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">ExecStart=/usr/local/bin/redis-server /opt/redis-data/redis.conf --daemonize no</span><br><span class="line">ExecStop=/usr/local/bin/redis-cli -a abcd1234 shutdown</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="设置开机自启动"><a href="#设置开机自启动" class="headerlink" title="设置开机自启动"></a>设置开机自启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable redis.service</span><br><span class="line">systemctl start redis.service</span><br></pre></td></tr></table></figure><h1 id="验证功能"><a href="#验证功能" class="headerlink" title="验证功能"></a>验证功能</h1><h2 id="登录redis"><a href="#登录redis" class="headerlink" title="登录redis"></a>登录redis</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -p 6379</span><br></pre></td></tr></table></figure><h2 id="认证登录"><a href="#认证登录" class="headerlink" title="认证登录"></a>认证登录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis&gt;</span><span class="bash"> auth abcd1234</span></span><br><span class="line">ok</span><br></pre></td></tr></table></figure><h2 id="测试功能"><a href="#测试功能" class="headerlink" title="测试功能"></a>测试功能</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis&gt;</span><span class="bash"> ping</span></span><br><span class="line">"PONG"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;仅记录安装部署过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/code&gt;
      
    
    </summary>
    
    
      <category term="Redis" scheme="https://luanlengli.github.io/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>MySQL基于PXC方案实现数据库HA</title>
    <link href="https://luanlengli.github.io/2019/05/31/MySQL%E5%9F%BA%E4%BA%8EPXC%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93HA.html"/>
    <id>https://luanlengli.github.io/2019/05/31/MySQL基于PXC方案实现数据库HA.html</id>
    <published>2019-05-31T02:59:42.000Z</published>
    <updated>2019-06-04T06:35:46.963Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>仅记录安装部署过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>可以跑起来，自己判断哪些要改的！</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>Percona XtraDB Cluster版本使用<code>57-5.7.25-31.35.1.el7</code></p><font color="red">【根据自己的环境灵活调整，生产环境请务必提供独立数据盘！】</font></blockquote><h1 id="集群架构模型"><a href="#集群架构模型" class="headerlink" title="集群架构模型"></a>集群架构模型</h1><p><img src="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/_images/cluster-diagram1.png" alt=""></p><h1 id="多主复制模型"><a href="#多主复制模型" class="headerlink" title="多主复制模型"></a>多主复制模型</h1><p><img src="https://www.percona.com/doc/percona-xtradb-cluster/5.7/_images/certificationbasedreplication.png" alt=""></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h2><table><thead><tr><th>主机名</th><th>IP地址</th></tr></thead><tbody><tr><td>db1</td><td>172.16.80.201</td></tr><tr><td>db2</td><td>172.16.80.202</td></tr><tr><td>db3</td><td>172.16.80.203</td></tr></tbody></table><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's,SELINUX=enforcing,SELINUX=disabled,' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl mask firewalld</span><br></pre></td></tr></table></figure><h2 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-centos.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max = 1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open = 1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个共享内存段的最大值，这里设置为物理内存大小的一半</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算方式，以2G内存为例</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2048 / 2 * 1024 * 1024 = 1073741824</span></span><br><span class="line">kernel.shmmax = 1073741824</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据接收窗口（字节）</span></span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据发送窗口（字节）</span></span><br><span class="line">net.core.wmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据接收窗口大小（字节）</span></span><br><span class="line">net.core.rmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据发送窗口大小（字节）</span></span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改动态NAT跟踪记录参数</span></span><br><span class="line">net.netfilter.nf_conntrack_max = 655350</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置主动发起连接时，端口范围，默认值32768-60000</span></span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统pagecache脏页达到系统内存dirty_ratio的百分比值时，会阻塞新的写请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 直到内存脏页落盘</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为30</span></span><br><span class="line">vm.dirty_ratio = 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="limits参数"><a href="#limits参数" class="headerlink" title="limits参数"></a>limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-mysql.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile  655360</span><br><span class="line">* hard nofile  655360</span><br><span class="line">* soft nproc   655360</span><br><span class="line">* hard nproc   655360</span><br><span class="line">* soft stack   unlimited</span><br><span class="line">* hard stack   unlimited</span><br><span class="line">* soft memlock 250000000</span><br><span class="line">* hard memlock 250000000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="更新系统软件"><a href="#更新系统软件" class="headerlink" title="更新系统软件"></a>更新系统软件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="重启服务器"><a href="#重启服务器" class="headerlink" title="重启服务器"></a>重启服务器</h2><blockquote><p>可选</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><h2 id="获取安装包"><a href="#获取安装包" class="headerlink" title="获取安装包"></a>获取安装包</h2><blockquote><p>可以通过配置YUM源或者直接下载RPM包安装</p></blockquote><h3 id="配置YUM源"><a href="#配置YUM源" class="headerlink" title="配置YUM源"></a>配置YUM源</h3><ul><li>YUM源配置方法可以看<a href="https://www.percona.com/doc/percona-repo-config/percona-release.html#rpm-based-gnu-linux-distributions" target="_blank" rel="noopener">官方教程</a></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br><span class="line">yum install -y Percona-XtraDB-Cluster-full-57</span><br></pre></td></tr></table></figure><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><ul><li>官方下载页面链接在<a href="https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/" target="_blank" rel="noopener">这里</a></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-devel-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-client-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-full-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-test-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-server-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-shared-compat-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.25-31.35/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-shared-57-5.7.25-31.35.1.el7.x86_64.rpm</span><br><span class="line">wget https://www.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.14/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.14-1.el7.x86_64.rpm</span><br><span class="line">wget http://repo.percona.com/percona/yum/release/7/RPMS/x86_64/qpress-11-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><ul><li>手动安装YUM包</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall -y *rpm</span><br></pre></td></tr></table></figure><h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><blockquote><font color="red">注意！</font><p>这里的初始化操作可以在集群任意节点进行，这里为了方便，在<code>db1</code>上进行操作</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql.service</span><br></pre></td></tr></table></figure><blockquote><p>启动完成后之后，需要获取临时密码</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep 'temporary password' /var/log/mysqld.log</span><br></pre></td></tr></table></figure><blockquote><p>使用<code>mysql_secure_installation</code>初始化MySQL数据库</p><ul><li>修改root密码</li><li>修改密码复杂度要求</li><li>禁止root远程登录</li><li>删除匿名用户和测试数据</li><li>刷新权限</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_install</span><br></pre></td></tr></table></figure><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><blockquote><p>创建SST用户并授权</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'sstuser'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'sstuser_password'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> RELOAD, <span class="keyword">LOCK</span> <span class="keyword">TABLES</span>, PROCESS, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'sstuser'</span>@<span class="string">'localhost'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure><blockquote><p>关闭数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysql.service</span><br></pre></td></tr></table></figure><h2 id="配置Galera"><a href="#配置Galera" class="headerlink" title="配置Galera"></a>配置Galera</h2><blockquote><p>配置过程参照<a href="https://www.percona.com/doc/percona-xtradb-cluster/5.7/configure.html#configure" target="_blank" rel="noopener">官方文档</a></p><p>额外定义一些参数</p></blockquote><h3 id="节点1"><a href="#节点1" class="headerlink" title="节点1"></a>节点1</h3><blockquote><p>清理一下配置文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find /etc/my.cnf.d/ -type f -name *cnf</span><br><span class="line">find /etc/percona-xtradb-cluster.conf.d/ -type f -name *cnf</span><br></pre></td></tr></table></figure><blockquote><p>将配置内容合并</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Template my.cnf <span class="keyword">for</span> PXC</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Edit to your requirements.</span></span><br><span class="line">[client]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义客户端从哪里获取mysql.sock的路径</span></span><br><span class="line">socket=/var/run/mysqld/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt="\u@db1 \R:\m:\s [\d]&gt; "</span><br><span class="line">no-auto-rehash</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听地址</span></span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">port = 3306</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认数据库引擎</span></span><br><span class="line">default-storage-engine = innodb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 字符集</span></span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 排序规则</span></span><br><span class="line">collation-server = utf8mb4_general_ci</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大连接数</span></span><br><span class="line">max_connections = 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制打开文件数</span></span><br><span class="line">open_files_limit = 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> server-id每个服务器唯一即可，一般用IP末位数字</span></span><br><span class="line">server-id = 201</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认时区</span></span><br><span class="line">default-time-zone = '+8:00'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置数据库事务隔离级别</span></span><br><span class="line">transaction_isolation = REPEATABLE-READ</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置超时时间</span></span><br><span class="line">interactive_timeout = 600</span><br><span class="line">wait_timeout = 600</span><br><span class="line">connect_timeout = 20</span><br><span class="line">lock_wait_timeout = 3600</span><br><span class="line"><span class="meta">#</span><span class="bash"> 限制数据库服务器接收数据包的大小</span></span><br><span class="line">max_allowed_packet = 64M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置排序和join的buffer大小</span></span><br><span class="line">sort_buffer_size = 4M</span><br><span class="line">join_buffer_size = 4M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里定义数据目录和日志目录</span></span><br><span class="line">datadir = /var/lib/mysql/</span><br><span class="line">socket = /var/run/mysql/mysql.sock</span><br><span class="line">log-error = /var/log/mysql/error.log</span><br><span class="line">pid-file = /var/run/mysql/mysqld.pid</span><br><span class="line">log-bin = /var/lib/mysql/mybinlog</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置binlog</span></span><br><span class="line">binlog_format = ROW</span><br><span class="line">expire_logs_days = 7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启binlog校验功能</span></span><br><span class="line">binlog_checksum = 1</span><br><span class="line">binlog_cache_size = 4M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每1次提交变更后立刻将binlog落盘</span></span><br><span class="line">sync_binlog = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置performance_schema</span></span><br><span class="line">performance_schema = on</span><br><span class="line">performance_schema_instrument = '%memory%=on'</span><br><span class="line">performance_schema_instrument = '%lock%=on'</span><br><span class="line">skip-external-locking = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用域名解析</span></span><br><span class="line">skip-name-resolve = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用软链接</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line">back_log = 1024</span><br><span class="line"><span class="meta">#</span><span class="bash"> 慢日志查询配置</span></span><br><span class="line">slow_query_log = 1</span><br><span class="line">long_query_time = 1</span><br><span class="line">slow_query_log_file = /var/log/mysqld/slow.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置每个EVENT都要执行刷盘操作</span></span><br><span class="line">sync_master_info = 1</span><br><span class="line">sync_relay_log_info = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">log_slave_updates = on</span><br><span class="line">relay_log_recovery = 1</span><br><span class="line">relay_log_purge = 1</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line"><span class="meta">#</span><span class="bash"> InnoDB引擎配置</span></span><br><span class="line">innodb_file_per_table = on</span><br><span class="line">innodb_checksums = 1</span><br><span class="line">innodb_checksum_algorithm = crc32</span><br><span class="line">innodb_status_file = 1</span><br><span class="line">innodb_status_output = 0</span><br><span class="line">innodb_status_output_locks = 0</span><br><span class="line">innodb_stats_on_metadata = 0</span><br><span class="line">innodb_open_files = 65535</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_flush_sync = 0</span><br><span class="line">innodb_flush_neighbors = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每个事务提交后立即刷新binlog文件</span></span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">innodb_monitor_enable="module_innodb"</span><br><span class="line">innodb_monitor_enable="module_server"</span><br><span class="line">innodb_monitor_enable="module_dml"</span><br><span class="line">innodb_monitor_enable="module_ddl"</span><br><span class="line">innodb_monitor_enable="module_trx"</span><br><span class="line">innodb_monitor_enable="module_os"</span><br><span class="line">innodb_monitor_enable="module_purge"</span><br><span class="line">innodb_monitor_enable="module_log"</span><br><span class="line">innodb_monitor_enable="module_lock"</span><br><span class="line">innodb_monitor_enable="module_buffer"</span><br><span class="line">innodb_monitor_enable="module_index"</span><br><span class="line">innodb_monitor_enable="module_ibuf_system"</span><br><span class="line">innodb_monitor_enable="module_buffer_page"</span><br><span class="line">innodb_monitor_enable="module_adaptive_hash"</span><br><span class="line"><span class="meta">#</span><span class="bash"> SQL mode配置，这里是默认值</span></span><br><span class="line">sql_mode = ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line"><span class="meta">#</span><span class="bash"> GTID配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gtid_mode = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enforce_gtid_consistency = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wsrep配置</span></span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line">wsrep_cluster_name = pxc-cluster</span><br><span class="line">wsrep_cluster_address = gcomm://172.16.80.201:4567,172.16.80.202:4567,172.16.80.203:4567</span><br><span class="line">wsrep_provider = /usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_node_name = db1</span><br><span class="line">wsrep_node_address = 172.16.80.201:4567</span><br><span class="line">wsrep_sst_receive_address = 172.16.80.201:4444</span><br><span class="line">wsrep_sst_method = xtrabackup-v2</span><br><span class="line">wsrep_sst_auth = sstuser:sstuser_password</span><br><span class="line">wsrep_slave_threads = 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用Percona XtraDB Cluster中实验特性和不受支持的功能</span></span><br><span class="line">pxc_strict_mode = ENFORCING</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 32M</span><br></pre></td></tr></table></figure><h3 id="节点2"><a href="#节点2" class="headerlink" title="节点2"></a>节点2</h3><blockquote><p>配置过程跟节点1大体上是一样，区别在于要修改某些配置项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">prompt="\u@db2 \R:\m:\s [\d]&gt; "</span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 202</span><br><span class="line">wsrep_node_name = db2</span><br><span class="line">wsrep_node_address = 172.16.80.202:4567</span><br><span class="line">wsrep_sst_receive_address = 172.16.80.202:4444</span><br></pre></td></tr></table></figure><h3 id="节点3"><a href="#节点3" class="headerlink" title="节点3"></a>节点3</h3><blockquote><p>配置过程跟节点1一样，区别在于要修改某些配置项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">prompt="\u@db3 \R:\m:\s [\d]&gt; "</span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 203</span><br><span class="line">wsrep_node_name = db3</span><br><span class="line">wsrep_node_address = 172.16.80.203:4567</span><br><span class="line">wsrep_sst_receive_address = 172.16.80.203:4444</span><br></pre></td></tr></table></figure><h2 id="初始化PXC集群"><a href="#初始化PXC集群" class="headerlink" title="初始化PXC集群"></a>初始化PXC集群</h2><h3 id="节点1-1"><a href="#节点1-1" class="headerlink" title="节点1"></a>节点1</h3><blockquote><p>作为集群第一个节点引导启动集群，此节点必须包含完整的数据！否则会出现数据不一致</p><p>这里以节点1作为bootstrap node</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql@bootstrap.service</span><br></pre></td></tr></table></figure><blockquote><p>启动完成之后，可以查看日志</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/mysql/error.log</span><br></pre></td></tr></table></figure><blockquote><p>在看到ready for connection就可以启动其他节点了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YYYY-MM-DDTHH:mm:ss.534955Z 0 [Note] /usr/sbin/mysqld: ready for connections.</span><br></pre></td></tr></table></figure><h3 id="节点2-1"><a href="#节点2-1" class="headerlink" title="节点2"></a>节点2</h3><blockquote><p>启动数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql.service</span><br></pre></td></tr></table></figure><h3 id="节点3-1"><a href="#节点3-1" class="headerlink" title="节点3"></a>节点3</h3><blockquote><p>启动数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql.service</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><blockquote><p>如果提示<code>WSREP: Failed to prepare for &#39;xtrabackup-v2&#39; SST. Unrecoverable.</code></p><p>那么可以将配置文件里面的<code>wsrep_sst_method=xtrabackup-v2</code>修改为<code>wsrep_sst_method=rsync</code></p><p>然后再重新初始化集群</p></blockquote><h2 id="检查集群启动状态"><a href="#检查集群启动状态" class="headerlink" title="检查集群启动状态"></a>检查集群启动状态</h2><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><blockquote><p>检查wsrep节点数量</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'wsrep_cluster_size'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例输出</span></span><br><span class="line">+<span class="comment">--------------------+-------+</span></span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+<span class="comment">--------------------+-------+</span></span><br><span class="line">| wsrep_cluster_size | 3     |</span><br><span class="line">+<span class="comment">--------------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><blockquote><p>检查wsrep集群信息</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'wsrep%'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例输出</span></span><br><span class="line">+<span class="comment">----------------------------------+----------------------------------------------------------+</span></span><br><span class="line">| Variable_name                    | Value                                                    |</span><br><span class="line">+<span class="comment">----------------------------------+----------------------------------------------------------+</span></span><br><span class="line">| wsrep_local_state_uuid           | 77463f8f-82bf-11e9-b41f-92927bef6908                     |</span><br><span class="line">| wsrep_protocol_version           | 9                                                        |</span><br><span class="line">| wsrep_last_applied               | 25                                                       |</span><br><span class="line">| wsrep_last_committed             | 25                                                       |</span><br><span class="line">| wsrep_replicated                 | 14                                                       |</span><br><span class="line">| wsrep_replicated_bytes           | 3640                                                     |</span><br><span class="line">| wsrep_repl_keys                  | 15                                                       |</span><br><span class="line">| wsrep_repl_keys_bytes            | 456                                                      |</span><br><span class="line">| wsrep_repl_data_bytes            | 2237                                                     |</span><br><span class="line">| wsrep_repl_other_bytes           | 0                                                        |</span><br><span class="line">| wsrep_received                   | 6                                                        |</span><br><span class="line">| wsrep_received_bytes             | 1225                                                     |</span><br><span class="line">| wsrep_local_commits              | 0                                                        |</span><br><span class="line">| wsrep_local_cert_failures        | 0                                                        |</span><br><span class="line">| wsrep_local_replays              | 0                                                        |</span><br><span class="line">| wsrep_local_send_queue           | 0                                                        |</span><br><span class="line">| wsrep_local_send_queue_max       | 1                                                        |</span><br><span class="line">| wsrep_local_send_queue_min       | 0                                                        |</span><br><span class="line">| wsrep_local_send_queue_avg       | 0.000000                                                 |</span><br><span class="line">| wsrep_local_recv_queue           | 0                                                        |</span><br><span class="line">| wsrep_local_recv_queue_max       | 1                                                        |</span><br><span class="line">| wsrep_local_recv_queue_min       | 0                                                        |</span><br><span class="line">| wsrep_local_recv_queue_avg       | 0.000000                                                 |</span><br><span class="line">| wsrep_local_cached_downto        | 12                                                       |</span><br><span class="line">| wsrep_flow_control_paused_ns     | 0                                                        |</span><br><span class="line">| wsrep_flow_control_paused        | 0.000000                                                 |</span><br><span class="line">| wsrep_flow_control_sent          | 0                                                        |</span><br><span class="line">| wsrep_flow_control_recv          | 0                                                        |</span><br><span class="line">| wsrep_flow_control_interval      | [ 173, 173 ]                                             |</span><br><span class="line">| wsrep_flow_control_interval_low  | 173                                                      |</span><br><span class="line">| wsrep_flow_control_interval_high | 173                                                      |</span><br><span class="line">| wsrep_flow_control_status        | OFF                                                      |</span><br><span class="line">| wsrep_cert_deps_distance         | 1.000000                                                 |</span><br><span class="line">| wsrep_apply_oooe                 | 0.000000                                                 |</span><br><span class="line">| wsrep_apply_oool                 | 0.000000                                                 |</span><br><span class="line">| wsrep_apply_window               | 1.000000                                                 |</span><br><span class="line">| wsrep_commit_oooe                | 0.000000                                                 |</span><br><span class="line">| wsrep_commit_oool                | 0.000000                                                 |</span><br><span class="line">| wsrep_commit_window              | 1.000000                                                 |</span><br><span class="line">| wsrep_local_state                | 4                                                        |</span><br><span class="line">| wsrep_local_state_comment        | Synced                                                   |</span><br><span class="line">| wsrep_cert_index_size            | 3                                                        |</span><br><span class="line">| wsrep_cert_bucket_count          | 22                                                       |</span><br><span class="line">| wsrep_gcache_pool_size           | 5520                                                     |</span><br><span class="line">| wsrep_causal_reads               | 0                                                        |</span><br><span class="line">| wsrep_cert_interval              | 0.000000                                                 |</span><br><span class="line">| wsrep_open_transactions          | 0                                                        |</span><br><span class="line">| wsrep_open_connections           | 0                                                        |</span><br><span class="line">| wsrep_ist_receive_status         |                                                          |</span><br><span class="line">| wsrep_ist_receive_seqno_start    | 0                                                        |</span><br><span class="line">| wsrep_ist_receive_seqno_current  | 0                                                        |</span><br><span class="line">| wsrep_ist_receive_seqno_end      | 0                                                        |</span><br><span class="line">| wsrep_incoming_addresses         | 172.16.80.201:3306,172.16.80.202:3306,172.16.80.203:3306 |</span><br><span class="line">| wsrep_cluster_weight             | 3                                                        |</span><br><span class="line">| wsrep_desync_count               | 0                                                        |</span><br><span class="line">| wsrep_evs_delayed                |                                                          |</span><br><span class="line">| wsrep_evs_evict_list             |                                                          |</span><br><span class="line">| wsrep_evs_repl_latency           | 0/0/0/0/0                                                |</span><br><span class="line">| wsrep_evs_state                  | OPERATIONAL                                              |</span><br><span class="line">| wsrep_gcomm_uuid                 | 5ed853a2-834a-11e9-a850-17ef655007c8                     |</span><br><span class="line">| wsrep_cluster_conf_id            | 11                                                       |</span><br><span class="line">| wsrep_cluster_size               | 3                                                        |</span><br><span class="line">| wsrep_cluster_state_uuid         | 77463f8f-82bf-11e9-b41f-92927bef6908                     |</span><br><span class="line">| wsrep_cluster_status             | Primary                                                  |</span><br><span class="line">| wsrep_connected                  | ON                                                       |</span><br><span class="line">| wsrep_local_bf_aborts            | 0                                                        |</span><br><span class="line">| wsrep_local_index                | 0                                                        |</span><br><span class="line">| wsrep_provider_name              | Galera                                                   |</span><br><span class="line">| wsrep_provider_vendor            | Codership Oy &lt;info@codership.com&gt;                        |</span><br><span class="line">| wsrep_provider_version           | 3.35(rddf9876)                                           |</span><br><span class="line">| wsrep_ready                      | ON                                                       |</span><br><span class="line">+<span class="comment">----------------------------------+----------------------------------------------------------+</span></span><br><span class="line">71 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="简单验证集群"><a href="#简单验证集群" class="headerlink" title="简单验证集群"></a>简单验证集群</h1><blockquote><p>在节点1创建数据库</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql@db1&gt; CREATE DATABASE percona_test;</span><br></pre></td></tr></table></figure><blockquote><p>在节点2上创建表</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql@db2&gt; USE percona_test;</span><br><span class="line">mysql@db2&gt; CREATE TABLE example (node_id INT PRIMARY KEY, node_name VARCHAR(30));</span><br></pre></td></tr></table></figure><blockquote><p>在节点2上插入数据</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql@db2&gt; INSERT INTO percona_test.example VALUES (2, 'db2');</span><br></pre></td></tr></table></figure><blockquote><p>在节点3上查数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql@db3&gt; SELECT * FROM percona_test.example;</span><br><span class="line">+<span class="comment">---------+-----------+</span></span><br><span class="line">| node_id | node_name |</span><br><span class="line">+<span class="comment">---------+-----------+</span></span><br><span class="line">|       2 | db2       |</span><br><span class="line">+<span class="comment">---------+-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h1 id="集群维护操作"><a href="#集群维护操作" class="headerlink" title="集群维护操作"></a>集群维护操作</h1><h2 id="集群整体关机"><a href="#集群整体关机" class="headerlink" title="集群整体关机"></a>集群整体关机</h2><ul><li>按顺序逐台关停，例如db1→db2→db3</li></ul><h2 id="集群整体开机"><a href="#集群整体开机" class="headerlink" title="集群整体开机"></a>集群整体开机</h2><ul><li>启动时，则按照db3→db2→db1<ul><li>其中db3启动时，需要作为bootstrap node引导集群<code>systemctl start mysql@bootstrap.service</code></li></ul></li></ul><h2 id="集群少数节点维护"><a href="#集群少数节点维护" class="headerlink" title="集群少数节点维护"></a>集群少数节点维护</h2><ul><li>PXC集群能容忍少数节点离线而不影响集群数据库服务</li><li>这里的少数节点是指少于50%，即&lt; 50%</li><li>少数节点重新上线之后，会自动完成数据同步，在完成同步之后，wsrep状态被设置为true，才对外提供服务</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;仅记录安装部署过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/code&gt;
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Kong API网关搭建部署记录</title>
    <link href="https://luanlengli.github.io/2019/05/29/Kong-API%E7%BD%91%E5%85%B3%E6%90%AD%E5%BB%BA%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95.html"/>
    <id>https://luanlengli.github.io/2019/05/29/Kong-API网关搭建部署记录.html</id>
    <published>2019-05-29T02:27:08.000Z</published>
    <updated>2019-05-31T15:51:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>仅记录安装部署过程</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>kong版本为<code>1.1.2</code></p><p>官方文档在<a href="https://docs.konghq.com/" target="_blank" rel="noopener">这里</a></p></blockquote><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><h3 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h3><p>参考<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96.html">PostgreSQL10安装部署和初始化</a></p><h3 id="创建kong所需的数据库和用户"><a href="#创建kong所需的数据库和用户" class="headerlink" title="创建kong所需的数据库和用户"></a>创建kong所需的数据库和用户</h3><blockquote><p>登录PostgreSQL数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><blockquote><p>创建用户</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> kong <span class="keyword">with</span> <span class="keyword">password</span> <span class="string">'kong_password'</span>;</span><br></pre></td></tr></table></figure><blockquote><p>创建数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> kong owner kong;</span><br></pre></td></tr></table></figure><blockquote><p>授权用户拥有数据库所有权限</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> <span class="keyword">database</span> kong <span class="keyword">to</span> kong;</span><br></pre></td></tr></table></figure><h1 id="Kong安装"><a href="#Kong安装" class="headerlink" title="Kong安装"></a>Kong安装</h1><h2 id="配置YUM源"><a href="#配置YUM源" class="headerlink" title="配置YUM源"></a>配置YUM源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/kong.repo &lt;&lt;EOF</span><br><span class="line">[bintray--kong-kong-rpm]</span><br><span class="line">name=bintray--kong-kong-rpm</span><br><span class="line">baseurl=https://kong.bintray.com/kong-rpm/centos/7</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装kong"><a href="#安装kong" class="headerlink" title="安装kong"></a>安装kong</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kong-1.1.2-1</span><br></pre></td></tr></table></figure><h2 id="配置kong"><a href="#配置kong" class="headerlink" title="配置kong"></a>配置kong</h2><blockquote><p><code>/etc/kong/kong.conf</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -----------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kong configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -----------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> GENERAL</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 没啥好调的</span></span><br><span class="line">prefix = /usr/local/kong/</span><br><span class="line">log_level = notice</span><br><span class="line">proxy_access_log = /var/log/kong/access.log</span><br><span class="line">proxy_error_log = /var/log/kong/error.log</span><br><span class="line">admin_access_log = /var/log/kong/admin_access.log</span><br><span class="line">admin_error_log = /var/log/kong/admin_error.log</span><br><span class="line"><span class="meta">#</span><span class="bash">plugins = bundled</span></span><br><span class="line">anonymous_reports = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NGINX</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> proxy端口为对外提供服务的端口</span></span><br><span class="line">proxy_listen = 0.0.0.0:80, 0.0.0.0:443 http2 ssl</span><br><span class="line"><span class="meta">#</span><span class="bash">stream_listen = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 管理端口，注意安全！</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此API接口是无权限认证的！</span></span><br><span class="line">admin_listen = 127.0.0.1:8001, 127.0.0.1:8444 ssl</span><br><span class="line">nginx_user = nobody nobody</span><br><span class="line">nginx_worker_processes = auto</span><br><span class="line">nginx_daemon = on</span><br><span class="line">mem_cache_size = 128m</span><br><span class="line">ssl_cipher_suite = custom</span><br><span class="line">ssl_ciphers = "ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置proxy端口的https证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_cert = /path/to/cert</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_cert_key = /path/to/key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端证书认证，一般情况不用设置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_ssl = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_ssl_cert = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_ssl_cert_key = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置Admin API端口的https证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">admin_ssl_cert = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">admin_ssl_cert_key = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 与upstream保持TCP连接，减少频繁建立TCP连接带来的性能损耗</span></span><br><span class="line">upstream_keepalive = 60</span><br><span class="line"><span class="meta">#</span><span class="bash">headers = server_tokens, latency_tokens</span></span><br><span class="line"><span class="meta">#</span><span class="bash">trusted_ips = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 经过CDN或者多级HTTP服务反向代理时，添加X-Real-IP请求头可以追溯到客户端真实IP</span></span><br><span class="line">real_ip_header = X-Real-IP</span><br><span class="line"><span class="meta">#</span><span class="bash">real_ip_recursive = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端请求的body过大时会出现payload too large</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置为0时，不限制</span></span><br><span class="line">client_max_body_size = 0</span><br><span class="line">client_body_buffer_size = 4m</span><br><span class="line">error_default_type = text/plain</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DATASTORE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">database = postgres</span><br><span class="line">pg_host = 127.0.0.1</span><br><span class="line">pg_port = 5432</span><br><span class="line">pg_timeout = 5000</span><br><span class="line">pg_user = kong</span><br><span class="line">pg_password = kong_password</span><br><span class="line">pg_database = uat_kong</span><br><span class="line">pg_schema = public</span><br><span class="line">pg_ssl = off</span><br><span class="line"><span class="meta">#</span><span class="bash">pg_ssl_verify = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DATASTORE CACHE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用数据存储更新缓存的频率(秒)，默认值5</span></span><br><span class="line">db_update_frequency = 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库节点的更新时间，对于最终一致性模型的数据库，需要配置各数据库节点之间数据同步的延迟</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 整个kong同步配置的延迟时间 等于 db_update_frequency + db_update_propagation</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db_update_propagation = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 缓存过期时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db_cache_ttl = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 缓存刷新时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">db_resurrect_ttl = 30</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DNS RESOLVER</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置DNS服务器列表，仅提供给Kong使用，不会覆盖系统配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_resolver = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置Kong的hosts文件，必须要重启Kong才能生效，仅提供给Kong使用，不会覆盖系统配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_hostsfile = /etc/hosts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解析不同记录类型的顺序。“LAST”类型表示最后一次成功查找的类型</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_order = LAST,SRV,A,CNAME</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_valid_ttl = </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置DNS记录缓存过期时间</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_stale_ttl = 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_not_found_ttl = 30</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_error_ttl = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dns_no_sync = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEVELOPMENT &amp; MISCELLANEOUS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个地方没啥好改的，默认值就好了</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_ssl_trusted_certificate = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_ssl_verify_depth = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_package_path = ./?.lua;./?/init.lua;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_package_cpath = </span></span><br><span class="line"><span class="meta">#</span><span class="bash">lua_socket_pool_size = 30</span></span><br></pre></td></tr></table></figure><h2 id="创建日志目录"><a href="#创建日志目录" class="headerlink" title="创建日志目录"></a>创建日志目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/kong</span><br></pre></td></tr></table></figure><h2 id="初始化kong数据库"><a href="#初始化kong数据库" class="headerlink" title="初始化kong数据库"></a>初始化kong数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/kong migrations bootstrap -c /etc/kong/kong.conf</span><br></pre></td></tr></table></figure><blockquote><p>数据库初始化时输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">bootstrapping database...</span><br><span class="line">migrating core on database 'kong'...</span><br><span class="line">core migrated up to: 000_base (executed)</span><br><span class="line">core migrated up to: 001_14_to_15 (executed)</span><br><span class="line">core migrated up to: 002_15_to_1 (executed)</span><br><span class="line">core migrated up to: 003_100_to_110 (executed)</span><br><span class="line">migrating oauth2 on database 'kong'...</span><br><span class="line">oauth2 migrated up to: 000_base_oauth2 (executed)</span><br><span class="line">oauth2 migrated up to: 001_14_to_15 (executed)</span><br><span class="line">oauth2 migrated up to: 002_15_to_10 (executed)</span><br><span class="line">migrating acl on database 'kong'...</span><br><span class="line">acl migrated up to: 000_base_acl (executed)</span><br><span class="line">acl migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating jwt on database 'kong'...</span><br><span class="line">jwt migrated up to: 000_base_jwt (executed)</span><br><span class="line">jwt migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating basic-auth on database 'kong'...</span><br><span class="line">basic-auth migrated up to: 000_base_basic_auth (executed)</span><br><span class="line">basic-auth migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating key-auth on database 'kong'...</span><br><span class="line">key-auth migrated up to: 000_base_key_auth (executed)</span><br><span class="line">key-auth migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating rate-limiting on database 'kong'...</span><br><span class="line">rate-limiting migrated up to: 000_base_rate_limiting (executed)</span><br><span class="line">rate-limiting migrated up to: 001_14_to_15 (executed)</span><br><span class="line">rate-limiting migrated up to: 002_15_to_10 (executed)</span><br><span class="line">rate-limiting migrated up to: 003_10_to_112 (executed)</span><br><span class="line">migrating hmac-auth on database 'kong'...</span><br><span class="line">hmac-auth migrated up to: 000_base_hmac_auth (executed)</span><br><span class="line">hmac-auth migrated up to: 001_14_to_15 (executed)</span><br><span class="line">migrating response-ratelimiting on database 'kong'...</span><br><span class="line">response-ratelimiting migrated up to: 000_base_response_rate_limiting (executed)</span><br><span class="line">response-ratelimiting migrated up to: 001_14_to_15 (executed)</span><br><span class="line">response-ratelimiting migrated up to: 002_15_to_10 (executed)</span><br><span class="line">24 migrations processed</span><br><span class="line">24 executed</span><br><span class="line">database is up-to-date</span><br></pre></td></tr></table></figure><h2 id="启动kong"><a href="#启动kong" class="headerlink" title="启动kong"></a>启动kong</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/kong start -c /etc/kong/kong.conf</span><br></pre></td></tr></table></figure><h2 id="查看监听端口"><a href="#查看监听端口" class="headerlink" title="查看监听端口"></a>查看监听端口</h2><blockquote><p>80和443端口是业务端口</p><p>8001和8444是Admin API端口</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      17493/nginx: master</span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      17493/nginx: master</span><br><span class="line">tcp        0      0 127.0.0.1:8444          0.0.0.0:*               LISTEN      17493/nginx: master</span><br><span class="line">tcp        0      0 127.0.0.1:8001          0.0.0.0:*               LISTEN      17493/nginx: master</span><br></pre></td></tr></table></figure><h2 id="Kong访问测试"><a href="#Kong访问测试" class="headerlink" title="Kong访问测试"></a>Kong访问测试</h2><blockquote><p>访问本机的8001端口</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://localhost:8001/</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 29 May 2019 06:38:35 GMT</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Server: kong/1.1.2</span><br><span class="line">Content-Length: 5777</span><br></pre></td></tr></table></figure><h2 id="查看Nginx日志"><a href="#查看Nginx日志" class="headerlink" title="查看Nginx日志"></a>查看Nginx日志</h2><blockquote><p>在本文中已经定义了日志路径为<code>/var/log/kong/</code></p><p>可以看到有四个日志文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/local/kong/logs/</span><br><span class="line">access.log admin_access.log admin_error.log error.log</span><br></pre></td></tr></table></figure><h2 id="查看Nginx的PID文件"><a href="#查看Nginx的PID文件" class="headerlink" title="查看Nginx的PID文件"></a>查看Nginx的PID文件</h2><blockquote><p>kong的配置文件没法定义PID文件的路径</p><p>默认在<code>/usr/local/kong/pids/nginx.pid</code></p></blockquote><h2 id="创建kong的systemd服务脚本"><a href="#创建kong的systemd服务脚本" class="headerlink" title="创建kong的systemd服务脚本"></a>创建kong的systemd服务脚本</h2><p><code>/usr/lib/systemd/system/kong.service</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kong API Gateway</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">ExecStart=/usr/local/bin/kong start -c /etc/kong/kong.conf</span><br><span class="line">ExecStop=/usr/local/bin/kong stop</span><br><span class="line">ExecReload=/usr/local/bin/kong reload -c /etc/kong/kong.conf</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/kong/pids/nginx.pid</span><br><span class="line">RestartSec=60</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure><h1 id="Kong集群"><a href="#Kong集群" class="headerlink" title="Kong集群"></a>Kong集群</h1><h2 id="单节点集群"><a href="#单节点集群" class="headerlink" title="单节点集群"></a>单节点集群</h2><blockquote><p>只有一个kong节点连接到数据库（cassandra或者PostgreSQL）时，通过kong的Admin API提交的变更都会立刻生效。</p><p>kong的配置信息是缓存在内存中。</p></blockquote><h2 id="多节点集群"><a href="#多节点集群" class="headerlink" title="多节点集群"></a>多节点集群</h2><blockquote><p>在多个kong节点组成的集群中，这些kong节点都连接到同一个数据库（cassandra或者PostgreSQL），即可组成集群。</p><p>当其中一个节点提交了修改，那么其他节点是不会立刻感知到已经提交的变更。</p><p>因此所有kong节点会在后台定期执行任务，从数据库中读取其他节点提交的变更。</p></blockquote><ul><li><code>db_update_frequency</code> 默认值5</li></ul><blockquote><p>每5秒，集群中所有的kong节点都会从数据库中获取最新的配置信息，并缓存到内存中</p></blockquote><ul><li><code>db_update_propagation</code>默认值0</li></ul><blockquote><p>如果使用了Cassandra数据库集群，那么如果数据库有更新，最多需要<code>db_update_propagation</code>时间来同步所有的数据库副本。</p><p>如果使用PostgreSQL或者单数据库，这个值可以被设置为0</p></blockquote><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><blockquote><p>以下数据会被缓存在内存中，并通过后台任务的机制查询后端数据库进行更新</p></blockquote><ul><li>Services</li><li>Routes</li><li>Plugins</li><li>Consumers</li><li>Credentials</li></ul><h1 id="Konga安装"><a href="#Konga安装" class="headerlink" title="Konga安装"></a>Konga安装</h1><blockquote><p>konga是kong的web可视化管理工具</p><p>这里在kong服务器上运行konga</p></blockquote><h2 id="安装Docker-CE"><a href="#安装Docker-CE" class="headerlink" title="安装Docker-CE"></a>安装Docker-CE</h2><p>安装过程见<a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">官方文档</a></p><h2 id="启动Docker"><a href="#启动Docker" class="headerlink" title="启动Docker"></a>启动Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker.service</span><br><span class="line">systemctl start docker.service</span><br></pre></td></tr></table></figure><h2 id="创建konga数据库"><a href="#创建konga数据库" class="headerlink" title="创建konga数据库"></a>创建konga数据库</h2><blockquote><p>登录PostgreSQL</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><blockquote><p>创建konga数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> konga owner kong;</span><br></pre></td></tr></table></figure><blockquote><p>授权kong用户拥有konga数据库所有权限</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> <span class="keyword">database</span> konga <span class="keyword">to</span> kong;</span><br></pre></td></tr></table></figure><h2 id="初始化konga数据库"><a href="#初始化konga数据库" class="headerlink" title="初始化konga数据库"></a>初始化konga数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">           --net=host \</span><br><span class="line">           pantsel/konga:latest \</span><br><span class="line">           -c prepare \</span><br><span class="line">           -a postgres \</span><br><span class="line">           -u postgresql://kong:kong_password@127.0.0.1:5432/konga</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">debug: Preparing database...</span><br><span class="line">Using postgres DB Adapter.</span><br><span class="line">Database exists. Continue...</span><br><span class="line">debug: Hook:api_health_checks:process() called</span><br><span class="line">debug: Hook:health_checks:process() called</span><br><span class="line">debug: Hook:start-scheduled-snapshots:process() called</span><br><span class="line">debug: Hook:upstream_health_checks:process() called</span><br><span class="line">debug: Hook:user_events_hook:process() called</span><br><span class="line">debug: Seeding User...</span><br><span class="line">debug: User seed planted</span><br><span class="line">debug: Seeding Kongnode...</span><br><span class="line">debug: Kongnode seed planted</span><br><span class="line">debug: Seeding Emailtransport...</span><br><span class="line">debug: Emailtransport seed planted</span><br><span class="line">debug: Database migrations completed!</span><br></pre></td></tr></table></figure><h2 id="运行konga"><a href="#运行konga" class="headerlink" title="运行konga"></a>运行konga</h2><blockquote><p>共享宿主机网络命名空间</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">           --net=host \</span><br><span class="line">           --name konga \</span><br><span class="line">           --restart=always \</span><br><span class="line">           -e "PORT=1337" \</span><br><span class="line">           -e "NODE_ENV=production"  \</span><br><span class="line">           -e "KONGA_LOG_LEVEL=info" \</span><br><span class="line">           -e "DB_ADAPTER=postgres" \</span><br><span class="line">           -e "DB_URI=postgresql://kong:kong_password@127.0.0.1:5432/konga" \</span><br><span class="line">           pantsel/konga:latest</span><br></pre></td></tr></table></figure><h2 id="查看监听端口-1"><a href="#查看监听端口-1" class="headerlink" title="查看监听端口"></a>查看监听端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp6       0      0 :::1337                 :::*                    LISTEN      19341/node</span><br></pre></td></tr></table></figure><h2 id="查看konga日志"><a href="#查看konga日志" class="headerlink" title="查看konga日志"></a>查看konga日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs konga</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Hook:api_health_checks:process() called</span><br><span class="line">Hook:health_checks:process() called</span><br><span class="line">Hook:start-scheduled-snapshots:process() called</span><br><span class="line">Hook:upstream_health_checks:process() called</span><br><span class="line">Hook:user_events_hook:process() called</span><br><span class="line">User had models, so no seed needed</span><br><span class="line">Kongnode had models, so no seed needed</span><br><span class="line">Emailtransport seeds updated</span><br><span class="line"></span><br><span class="line">               .-..-.</span><br><span class="line"></span><br><span class="line">   Sails              &lt;|    .-..-.</span><br><span class="line">   v0.12.14            |\</span><br><span class="line">                      /|.\</span><br><span class="line">                     / || \</span><br><span class="line">                   ,'  |'  \</span><br><span class="line">                .-'.-==|/_--'</span><br><span class="line">                `--'-------'</span><br><span class="line">   __---___--___---___--___---___--___</span><br><span class="line"> ____---___--___---___--___---___--___-__</span><br><span class="line"></span><br><span class="line">Server lifted in `/app`</span><br><span class="line">To see your app, visit http://localhost:1337</span><br><span class="line">To shut down Sails, press &lt;CTRL&gt; + C at any time.</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line">:: Weekday Month Day Years HH:mm:ss GMT+0000 (UTC)</span><br><span class="line"></span><br><span class="line">Environment : production</span><br><span class="line">Port        : 1337</span><br><span class="line">-------------------------------------------------------</span><br></pre></td></tr></table></figure><h2 id="访问konga"><a href="#访问konga" class="headerlink" title="访问konga"></a>访问konga</h2><ul><li>使用浏览器访问<code>http://konga服务器IP:1337</code></li><li>第一次打开konga需要注册管理员用户，请保证密码强度足够高</li><li>在弹出的<code>New Connection</code>窗口<ul><li>选择<code>Default</code></li><li><code>Name</code>填写kong的名字</li><li><code>kong Admin URL</code>填写<code>http://127.0.0.1:8001</code></li></ul></li></ul><h1 id="Kong维护"><a href="#Kong维护" class="headerlink" title="Kong维护"></a>Kong维护</h1><h2 id="检查kong配置文件"><a href="#检查kong配置文件" class="headerlink" title="检查kong配置文件"></a>检查kong配置文件</h2><blockquote><p>在更改配置文件之后，可以通过命令检查配置文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong check -v /etc/kong/kong.conf</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /etc/kong/kong.conf</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] configuration at /etc/kong/kong.conf is valid</span><br></pre></td></tr></table></figure><h2 id="Kong健康检查"><a href="#Kong健康检查" class="headerlink" title="Kong健康检查"></a>Kong健康检查</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong health --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /usr/local/kong/.kong_env</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] nginx.......running</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info]</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong is healthy at /usr/local/kong</span><br></pre></td></tr></table></figure><h2 id="Kong启动"><a href="#Kong启动" class="headerlink" title="Kong启动"></a>Kong启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong start -c /etc/kong/kong.conf --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /etc/kong/kong.conf</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] retrieving database schema state...</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] schema state retrieved</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] preparing nginx prefix directory at /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] default SSL certificate found at /usr/local/kong/ssl/kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Admin SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] admin SSL certificate found at /usr/local/kong/ssl/admin-kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong started</span><br></pre></td></tr></table></figure><h2 id="Kong关闭"><a href="#Kong关闭" class="headerlink" title="Kong关闭"></a>Kong关闭</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong stop --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /usr/local/kong/.kong_env</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] sending TERM signal to nginx running at /usr/local/kong/pids/nginx.pid</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong stopped</span><br></pre></td></tr></table></figure><h2 id="Kong重启"><a href="#Kong重启" class="headerlink" title="Kong重启"></a>Kong重启</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong restart -c /etc/kong/kong.conf --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong stopped</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /etc/kong/kong.conf</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] retrieving database schema state...</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] schema state retrieved</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] preparing nginx prefix directory at /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] default SSL certificate found at /usr/local/kong/ssl/kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Admin SSL enabled, no custom certificate set: using default certificate</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] admin SSL certificate found at /usr/local/kong/ssl/admin-kong-default.crt</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong started</span><br></pre></td></tr></table></figure><h2 id="Kong重载配置"><a href="#Kong重载配置" class="headerlink" title="Kong重载配置"></a>Kong重载配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong reload -c /etc/kong/kong.conf --v</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">YYYY/MM/DD HH:mm:ss [verbose] Kong: 1.1.2</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] reading config file at /usr/local/kong/.kong_env</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] prefix in use: /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [verbose] preparing nginx prefix directory at /usr/local/kong</span><br><span class="line">YYYY/MM/DD HH:mm:ss [info] Kong reloaded</span><br></pre></td></tr></table></figure><h2 id="日志轮转"><a href="#日志轮转" class="headerlink" title="日志轮转"></a>日志轮转</h2><blockquote><p>底层是Nginx，因此可以借助logrotate工具做日志轮转</p></blockquote><h3 id="安装logrotate"><a href="#安装logrotate" class="headerlink" title="安装logrotate"></a>安装logrotate</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y logrotate</span><br></pre></td></tr></table></figure><h3 id="配置logrotate"><a href="#配置logrotate" class="headerlink" title="配置logrotate"></a>配置logrotate</h3><blockquote><p>每天切割日志</p><p>保留30天的日志记录</p><p>被切割的日志会压缩打包</p></blockquote><p><code>/etc/logrotate.d/kong</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/var/log/kong/*.log  &#123;</span><br><span class="line">daily</span><br><span class="line">rotate 30</span><br><span class="line">missingok</span><br><span class="line">dateext</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">postrotate</span><br><span class="line">    [ -e /usr/local/kong/pids/nginx.pid ] &amp;&amp; kill -USR1 `cat /usr/local/kong/pids/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试logrotate配置"><a href="#测试logrotate配置" class="headerlink" title="测试logrotate配置"></a>测试logrotate配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -d /etc/logrotate.d/kong</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">reading config file /etc/logrotate.d/kong</span><br><span class="line">Allocating hash table for state file, size 15360 B</span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/log/kong/*.log   after 1 days (30 rotations)</span><br><span class="line">empty log files are not rotated, old logs are removed</span><br><span class="line">considering log /var/log/kong/access.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br><span class="line">considering log /var/log/kong/admin_access.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br><span class="line">considering log /var/log/kong/admin_error.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br><span class="line">considering log /var/log/kong/error.log</span><br><span class="line">  log does not need rotating (log has been already rotated)</span><br></pre></td></tr></table></figure><h2 id="kong监控"><a href="#kong监控" class="headerlink" title="kong监控"></a>kong监控</h2><blockquote><p>kong内置了prometheus标准的metrics，默认只有Nginx的信息</p><p>开启了prometheus插件之后，可以为每个services都做监控</p><p><font color="red">注意！</font>metrics数据默认只能从Admin端口获取，不能走Proxy端口</p><p>因此想让Prometheus获取到kong的metric数据，需要修改<code>kong.conf</code>配置文件中<code>admin_listen</code>的值</p><p>具体的可以看<a href="https://docs.konghq.com/hub/kong-inc/prometheus/" target="_blank" rel="noopener">官方说明</a></p></blockquote><h3 id="开启插件"><a href="#开启插件" class="headerlink" title="开启插件"></a>开启插件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:8001/plugins --data "name=prometheus"</span><br></pre></td></tr></table></figure><h3 id="访问metric数据"><a href="#访问metric数据" class="headerlink" title="访问metric数据"></a>访问metric数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://localhost:8001/metrics</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p><p>这里kong是没配置任何服务，因此输出内容很少</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> HELP kong_datastore_reachable Datastore reachable from Kong, 0 is unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE kong_datastore_reachable gauge</span></span><br><span class="line">kong_datastore_reachable 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP kong_nginx_http_current_connections Number of HTTP connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE kong_nginx_http_current_connections gauge</span></span><br><span class="line">kong_nginx_http_current_connections&#123;state="accepted"&#125; 15</span><br><span class="line">kong_nginx_http_current_connections&#123;state="active"&#125; 1</span><br><span class="line">kong_nginx_http_current_connections&#123;state="handled"&#125; 15</span><br><span class="line">kong_nginx_http_current_connections&#123;state="reading"&#125; 0</span><br><span class="line">kong_nginx_http_current_connections&#123;state="total"&#125; 15</span><br><span class="line">kong_nginx_http_current_connections&#123;state="waiting"&#125; 0</span><br><span class="line">kong_nginx_http_current_connections&#123;state="writing"&#125; 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP kong_nginx_metric_errors_total Number of nginx-lua-prometheus errors</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE kong_nginx_metric_errors_total counter</span></span><br><span class="line">kong_nginx_metric_errors_total 0</span><br></pre></td></tr></table></figure><h3 id="监控数据可视化"><a href="#监控数据可视化" class="headerlink" title="监控数据可视化"></a>监控数据可视化</h3><blockquote><p>官方已经制作了grafana dashboard来展示Prometheus的数据</p></blockquote><p><a href="https://grafana.com/dashboards/7424" target="_blank" rel="noopener">Grafana Dashboard</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;仅记录安装部署过程&lt;/p&gt;&lt;p&gt;操作系统使用的&lt;code&gt;CentOS-7.6.1810 x86_64&lt;/code&gt;
      
    
    </summary>
    
    
      <category term="Kong" scheme="https://luanlengli.github.io/tags/Kong/"/>
    
      <category term="API-Gateway" scheme="https://luanlengli.github.io/tags/API-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>【施工中】PostgreSQL备份和恢复</title>
    <link href="https://luanlengli.github.io/2019/05/28/PostgreSQL%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D.html"/>
    <id>https://luanlengli.github.io/2019/05/28/PostgreSQL备份和恢复.html</id>
    <published>2019-05-28T15:32:05.000Z</published>
    <updated>2019-05-30T02:00:20.408Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>基于PostgreSQL 10.8版本做演示</p><p>其他版本自行调整</p></blockquote><h1 id="逻辑备份"><a href="#逻辑备份" class="headerlink" title="逻辑备份"></a>逻辑备份</h1><h2 id="pg-dump"><a href="#pg-dump" class="headerlink" title="pg_dump"></a>pg_dump</h2><h3 id="备份的逻辑"><a href="#备份的逻辑" class="headerlink" title="备份的逻辑"></a>备份的逻辑</h3><ul><li>pg_dump的一次完整的备份是在一个事务中完成的, 事务隔离级别为serializable 或者 repeatable read。</li><li>pg_dump在备份数据开始前, 需要对进行备份的对象加ACCESS SHARE锁。为了防止无休止的锁等待，可以使用<code>--lock-wait-timeout</code>设置锁超时时间</li><li>一切准备就绪后，pg_dump开始备份数据</li></ul><h3 id="备份的格式"><a href="#备份的格式" class="headerlink" title="备份的格式"></a>备份的格式</h3><ul><li><code>p</code>或者<code>plain</code><ul><li>默认格式，可读写的文本文件，里面是SQL语句</li></ul></li><li><code>c</code>或者<code>custom</code><ul><li>自定义格式，默认开启数据压缩，还原时可以调整对象还原顺序，必须使用<code>pg_restore</code>命令还原</li></ul></li><li><code>d</code>或者<code>directory</code><ul><li>目录归档格式，需要用<code>pg_restore</code>命令还原，目录归档格式下会创建一个目录, 然后每个表或者每个大对象对应一个备份输出文件，加上TOC文件名描述备份的详细信息, 这个格式默认支持压缩, 同时支持并行导出</li></ul></li><li><code>t</code>或者<code>tar</code><ul><li>tar归档格式, 不支持压缩, 同时限制每个表最大不能超过8GB, 同样需要使用<code>pg_restore</code>还原</li></ul></li></ul><h3 id="全库一致性"><a href="#全库一致性" class="headerlink" title="全库一致性"></a>全库一致性</h3><blockquote><p>指定是集群中的单个数据库的一致性备份。</p><p>因为备份不同的数据库需要切换连接，无法在不同的数据库之间共享snapshot，因此只能单库一致。</p></blockquote><h3 id="非全库一致性备份"><a href="#非全库一致性备份" class="headerlink" title="非全库一致性备份"></a>非全库一致性备份</h3><blockquote><p>如果单个库数据量越大，pg_dump备份时间就越长，持有锁的时间也就越长。</p><p>这时候会阻塞DDL语句。</p><p>未解决这个问题，可以将pg_dump的粒度缩小，只备份相关联且有一致性需求的数据表</p></blockquote><h2 id="pg-dumpall"><a href="#pg-dumpall" class="headerlink" title="pg_dumpall"></a>pg_dumpall</h2><blockquote><p>pg_dumpall最主要的是用于备份全局数据, 例如表空间的DDL, 创建用户的DDL</p></blockquote><h2 id="简单的备份脚本"><a href="#简单的备份脚本" class="headerlink" title="简单的备份脚本"></a>简单的备份脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -ex</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义PostgreSQL数据库连接</span></span><br><span class="line">export PGHOST='192.168.1.1'</span><br><span class="line">export PGPORT='5432'</span><br><span class="line">export PGUSER='postgres'</span><br><span class="line">export PGPASSWORD='postgres_passwd'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义目录</span></span><br><span class="line">BASE_DIR='/data/pgsql-dump'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义文件名</span></span><br><span class="line">FILENAME='pgsql-dump'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义时间格式，20190329-00</span></span><br><span class="line">DATE=$(date +%Y%m%d)</span><br><span class="line">TIME=$(date +%H%M)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据时间格式创建文件夹</span></span><br><span class="line">BACKUP_DIR="$&#123;BASE_DIR&#125;/$&#123;DATE&#125;/$&#123;TIME&#125;"</span><br><span class="line">mkdir -p $&#123;BACKUP_DIR&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤需要备份的数据库</span></span><br><span class="line">DATABASES=$(psql --host=$&#123;PGHOST&#125; --port=$&#123;PGPORT&#125; --username=$&#123;PGUSER&#125; -c "\l" | awk '&#123;print$1&#125;' | xargs)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对每个数据库单独做逻辑备份</span></span><br><span class="line">for DB in $DATABASES;do</span><br><span class="line">    pg_dump --host=$&#123;PGHOST&#125; --port=$&#123;PGPORT&#125; --username=$&#123;PGUSER&#125; --verbose --clean --create $&#123;DB&#125; | gzip -c &gt; $&#123;BACKUP_DIR&#125;/$&#123;FILENAME&#125;_$&#123;DB&#125;.gz</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份整个数据库</span></span><br><span class="line">pg_dumpall --host=$&#123;PGHOST&#125; --port=$&#123;PGPORT&#125; --username=$&#123;PGUSER&#125; --verbose --clean | gzip -c &gt; $&#123;BACKUP_DIR&#125;/$&#123;FILENAME&#125;_all.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查找备份目录修改时间大于30天的文件并清理</span></span><br><span class="line">find $&#123;BASE_DIR&#125;/ -mtime +30 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><h1 id="物理备份"><a href="#物理备份" class="headerlink" title="物理备份"></a>物理备份</h1><h2 id="在线热备份"><a href="#在线热备份" class="headerlink" title="在线热备份"></a>在线热备份</h2><h3 id="pg-basebackup"><a href="#pg-basebackup" class="headerlink" title="pg_basebackup"></a>pg_basebackup</h3><blockquote><p>PostgreSQL自带的一个远程热备工具，可以将远程PostgreSQL热备到本地目录</p></blockquote><h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><ul><li><p>连接到一个远程PostgreSQL</p></li><li><p>执行pg_start_backup</p></li><li><p>将整个数据目录传输到本地</p></li><li><p>执行pg_stop_backup命令</p></li></ul><h4 id="命令示例"><a href="#命令示例" class="headerlink" title="命令示例"></a>命令示例</h4><blockquote><p>使用<code>postgres</code>用户将<code>192.168.1.1:5432</code>PostgreSQL的数据备份到<code>/path/to/data_dir</code>目录</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_basebackup -h 192.168.1.1 -p 5432 -U postgres -D /path/to/data_dir</span><br></pre></td></tr></table></figure><h3 id="pg-rman"><a href="#pg-rman" class="headerlink" title="pg_rman"></a>pg_rman</h3><blockquote><p>PostgreSQL的备份与恢复工具，支持全量、增量、归档三种备方式，支持数据压缩与备份集管理。</p><p>pg_rman跑的不是流复制协议，而是文件拷贝，所以pg_rman必须与数据库服务器跑在同一台机器。</p><p>具体用法可以看德哥的<a href="https://github.com/digoal/blog/blob/master/201608/20160826_01.md" target="_blank" rel="noopener">文档</a></p><p><a href="https://github.com/ossc-db/pg_rman" target="_blank" rel="noopener">项目首页</a></p></blockquote><h4 id="工作流程-1"><a href="#工作流程-1" class="headerlink" title="工作流程"></a>工作流程</h4><ul><li>连接到本地PostgreSQL</li><li>执行pg_start_backup</li><li>全量备份文件或者通过比较数据文件块的lsn号进行增量备份</li><li>执行pg_stop_backup命令</li><li>备份归档日志</li></ul><h4 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h4><ul><li>开启归档<ul><li><code>archive_mode = on</code></li><li><code>archive_command = &#39;cp %p /data/pg-archlog/%f&#39;</code></li></ul></li><li>配置csvlog<ul><li><code>log_destination = csvlog</code></li><li><code>log_directory = pg_log</code></li></ul></li></ul><h1 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;基于PostgreSQL 10.8版本做演示&lt;/p&gt;&lt;p&gt;其他版本自行调整&lt;/p&gt;&lt;/blockquote&gt;&lt;h1 
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10搭建时间序列数据库TimescaleDB</title>
    <link href="https://luanlengli.github.io/2019/05/25/PostgreSQL10%E6%90%AD%E5%BB%BA%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E5%BA%93TimescaleDB.html"/>
    <id>https://luanlengli.github.io/2019/05/25/PostgreSQL10搭建时间序列数据库TimescaleDB.html</id>
    <published>2019-05-25T06:05:38.000Z</published>
    <updated>2019-05-29T03:33:40.743Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>这里只记录搭建和简单测试过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能完整跑起来</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>PostgreSQL版本号<code>10.8</code></p><p>TimescaleDB版本号<code>1.3.0</code></p><p>虚拟机配置<code>1CPU 2G内存 20G系统盘</code></p><p><code>postgres</code>用户默认情况下PGDATA变量是<code>/var/lib/pgsql/10/data</code></p><font color="red">这里没有使用数据盘，有需要的可以自行调整！</font></blockquote><h1 id="TimescaleDB简介"><a href="#TimescaleDB简介" class="headerlink" title="TimescaleDB简介"></a>TimescaleDB简介</h1><p><font color="red">这段介绍是来自德哥的Github文档</font><a href="https://github.com/digoal/blog/blob/master/201704/20170409_05.md" target="_blank" rel="noopener">TimescaleDB介绍</a></p><blockquote><p>TimescaleDB是基于PostgreSQL数据库打造的一款时序数据库，插件化的形式，随着PostgreSQL的版本升级而升级。</p></blockquote><h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="https://github.com/digoal/blog/raw/master/201704/20170409_05_pic_001.jpg" alt=""></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h2><p>这个参考<a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html">PostgreSQL10安装部署和初始化</a></p><h1 id="TimescaleDB安装"><a href="#TimescaleDB安装" class="headerlink" title="TimescaleDB安装"></a>TimescaleDB安装</h1><blockquote><p>TimescaleDB的YUM包已经被集成到PostgreSQL社区源里面，所以直接装就是了</p></blockquote><h2 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y timescaledb_10</span><br></pre></td></tr></table></figure><h2 id="配置PostgreSQL"><a href="#配置PostgreSQL" class="headerlink" title="配置PostgreSQL"></a>配置PostgreSQL</h2><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><blockquote><p>在<code>$PGDATA/postgresql.conf</code>添加配置</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shared_preload_libraries = 'timescaledb'</span><br></pre></td></tr></table></figure><h2 id="重启PostgreSQL"><a href="#重启PostgreSQL" class="headerlink" title="重启PostgreSQL"></a>重启PostgreSQL</h2><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">pg_ctl restart -D $PGDATA</span><br></pre></td></tr></table></figure><h2 id="验证TimescaleDB功能"><a href="#验证TimescaleDB功能" class="headerlink" title="验证TimescaleDB功能"></a>验证TimescaleDB功能</h2><blockquote><p>登录PostgreSQL</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><blockquote><p>创建名为<code>tutorial</code>的数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">database</span> tutorial;</span><br></pre></td></tr></table></figure><blockquote><p>切换到<code>tutorial</code>数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\c tutorial</span><br></pre></td></tr></table></figure><blockquote><p>加载TimescaleDB的extensions</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> timescaledb <span class="keyword">CASCADE</span>;</span><br></pre></td></tr></table></figure><blockquote><p>示例输出</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">WARNING:</span><br><span class="line">WELCOME TO</span><br><span class="line"> _____ _                               _     ____________</span><br><span class="line">|_   _(_)                             | |    |  _  \ ___ \</span><br><span class="line">  | |  _ _ __ ___   ___  ___  ___ __ _| | ___| | | | |_/ /</span><br><span class="line">  | | | |  _ ` _ \ / _ \/ __|/ __/ _` | |/ _ \ | | | ___ \</span><br><span class="line">  | | | | | | | | |  __/\__ \ (_| (_| | |  __/ |/ /| |_/ /</span><br><span class="line">  |_| |_|_| |_| |_|\___||___/\___\__,_|_|\___|___/ \____/</span><br><span class="line">               Running version 1.3.0</span><br><span class="line">For more information on TimescaleDB, please visit the following links:</span><br><span class="line"></span><br><span class="line"> 1. Getting started: https://docs.timescale.com/getting-started</span><br><span class="line"> 2. API reference documentation: https://docs.timescale.com/api</span><br><span class="line"> 3. How TimescaleDB is designed: https://docs.timescale.com/introduction/architecture</span><br><span class="line"></span><br><span class="line">Note: TimescaleDB collects anonymous reports to better understand and assist our users.</span><br><span class="line">For more information and how to disable, please see our docs https://docs.timescaledb.com/using-timescaledb/telemetry.</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br></pre></td></tr></table></figure><blockquote><p>创建一个普通SQL标准的表</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> conditions (</span><br><span class="line">  <span class="built_in">time</span>        TIMESTAMPTZ       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  location    <span class="built_in">TEXT</span>              <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  temperature <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>  <span class="literal">NULL</span>,</span><br><span class="line">  humidity    <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>  <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>查看表结构</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># \d conditions</span></span><br><span class="line">                        Table "public.conditions"</span><br><span class="line">   Column    |           Type           | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+--------------------------+-----------+----------+---------</span></span><br><span class="line"> time        | timestamp <span class="keyword">with</span> <span class="built_in">time</span> zone |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> location    | <span class="built_in">text</span>                     |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> temperature | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"> humidity    | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br></pre></td></tr></table></figure><blockquote><p>使用<code>create_hypertable</code>创建<code>hypertable</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> create_hypertable(<span class="string">'conditions'</span>, <span class="string">'time'</span>);</span><br><span class="line">    create_hypertable</span><br><span class="line"><span class="comment">-------------------------</span></span><br><span class="line"> (1,public,conditions,t)</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><blockquote><p>这时再看表结构的时候，会发现不一样了</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># \d conditions</span></span><br><span class="line">                        Table "public.conditions"</span><br><span class="line">   Column    |           Type           | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+--------------------------+-----------+----------+---------</span></span><br><span class="line"> time        | timestamp <span class="keyword">with</span> <span class="built_in">time</span> zone |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> location    | <span class="built_in">text</span>                     |           | <span class="keyword">not</span> <span class="literal">null</span> |</span><br><span class="line"> temperature | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"> humidity    | <span class="keyword">double</span> <span class="keyword">precision</span>         |           |          |</span><br><span class="line"><span class="keyword">Indexes</span>:</span><br><span class="line">    <span class="string">"conditions_time_idx"</span> btree (<span class="string">"time"</span> <span class="keyword">DESC</span>)</span><br><span class="line"><span class="keyword">Triggers</span>:</span><br><span class="line">    ts_insert_blocker <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> conditions <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> _timescaledb_internal.insert_blocker()</span><br></pre></td></tr></table></figure><blockquote><p>插入数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># INSERT INTO conditions(time, location, temperature, humidity) VALUES (NOW(), 'office', 70.0, 50.0);</span></span><br></pre></td></tr></table></figure><blockquote><p>查询数据</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tutorial=<span class="comment"># SELECT * FROM conditions ORDER BY time DESC LIMIT 100;</span></span><br><span class="line">             time              | location | temperature | humidity</span><br><span class="line"><span class="comment">-------------------------------+----------+-------------+----------</span></span><br><span class="line"> YYYY-MM-DD HH:mm:SS.354351+08 | office   |          70 |       50</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h1 id="TimescaleDB-Tutorials"><a href="#TimescaleDB-Tutorials" class="headerlink" title="TimescaleDB Tutorials"></a>TimescaleDB Tutorials</h1><blockquote><p>这里使用TimescaleDB官方的测试样例</p><p>地址在<a href="https://docs.timescale.com/v1.3/tutorials" target="_blank" rel="noopener">这里</a></p></blockquote><h2 id="纽约TAXI数据透视分析"><a href="#纽约TAXI数据透视分析" class="headerlink" title="纽约TAXI数据透视分析"></a>纽约TAXI数据透视分析</h2><h3 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h3><blockquote><p>这里直接下载的同时解压压缩包</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://timescaledata.blob.core.windows.net/datasets/nyc_data.tar.gz | tar xz</span><br></pre></td></tr></table></figure><blockquote><p>解压出来有三个文件</p></blockquote><ul><li><code>nyc_data_contagg.sql</code></li><li><code>nyc_data.sql</code></li><li><code>nyc_data_rides.csv</code></li></ul><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nyc_data;</span><br><span class="line">\c nyc_data</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> timescaledb <span class="keyword">CASCADE</span>;</span><br></pre></td></tr></table></figure><h4 id="创建表结构"><a href="#创建表结构" class="headerlink" title="创建表结构"></a>创建表结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -d nyc_data -h localhost &lt; nyc_data.sql</span><br></pre></td></tr></table></figure><h4 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -d nyc_data -h localhost -c "\COPY rides FROM nyc_data_rides.csv CSV"</span><br></pre></td></tr></table></figure><h4 id="查看表"><a href="#查看表" class="headerlink" title="查看表"></a>查看表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \dt</span></span><br><span class="line">             List of relations</span><br><span class="line"> Schema |     Name      | Type  |  Owner</span><br><span class="line"><span class="comment">--------+---------------+-------+----------</span></span><br><span class="line"> public | payment_types | table | postgres</span><br><span class="line"> public | rates         | table | postgres</span><br><span class="line"> public | rides         | table | postgres</span><br><span class="line">(3 rows)</span><br></pre></td></tr></table></figure><h4 id="查看表结构"><a href="#查看表结构" class="headerlink" title="查看表结构"></a>查看表结构</h4><ul><li>payments</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \d payment_types</span></span><br><span class="line">              Table "public.payment_types"</span><br><span class="line">    Column    |  Type   | Collation | Nullable | Default</span><br><span class="line"><span class="comment">--------------+---------+-----------+----------+---------</span></span><br><span class="line"> payment_type | integer |           |          |</span><br><span class="line"> description  | text    |           |          |</span><br></pre></td></tr></table></figure><ul><li>rates</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># \d rates</span></span><br><span class="line">                  Table "public.rates"</span><br><span class="line">   Column    |  Type   | Collation | Nullable | Default</span><br><span class="line"><span class="comment">-------------+---------+-----------+----------+---------</span></span><br><span class="line"> rate_code   | integer |           |          |</span><br><span class="line"> description | text    |           |          |</span><br></pre></td></tr></table></figure><ul><li>rides</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># \d+ rides;</span></span><br><span class="line">                                                     Table "public.rides"</span><br><span class="line">        Column         |            Type             | Collation | Nullable | Default | Storage  | Stats target | Description</span><br><span class="line"><span class="comment">-----------------------+-----------------------------+-----------+----------+---------+----------+--------------+-------------</span></span><br><span class="line"> vendor_id             | text                        |           |          |         | extended |              |</span><br><span class="line"> pickup_datetime       | timestamp without time zone |           | not null |         | plain    |              |</span><br><span class="line"> dropoff_datetime      | timestamp without time zone |           | not null |         | plain    |              |</span><br><span class="line"> passenger_count       | numeric                     |           |          |         | main     |              |</span><br><span class="line"> trip_distance         | numeric                     |           |          |         | main     |              |</span><br><span class="line"> pickup_longitude      | numeric                     |           |          |         | main     |              |</span><br><span class="line"> pickup_latitude       | numeric                     |           |          |         | main     |              |</span><br><span class="line"> rate_code             | integer                     |           |          |         | plain    |              |</span><br><span class="line"> dropoff_longitude     | numeric                     |           |          |         | main     |              |</span><br><span class="line"> dropoff_latitude      | numeric                     |           |          |         | main     |              |</span><br><span class="line"> payment_type          | integer                     |           |          |         | plain    |              |</span><br><span class="line"> fare_amount           | numeric                     |           |          |         | main     |              |</span><br><span class="line"> extra                 | numeric                     |           |          |         | main     |              |</span><br><span class="line"> mta_tax               | numeric                     |           |          |         | main     |              |</span><br><span class="line"> tip_amount            | numeric                     |           |          |         | main     |              |</span><br><span class="line"> tolls_amount          | numeric                     |           |          |         | main     |              |</span><br><span class="line"> improvement_surcharge | numeric                     |           |          |         | main     |              |</span><br><span class="line"> total_amount          | numeric                     |           |          |         | main     |              |</span><br><span class="line">Indexes:</span><br><span class="line">    "rides_passenger_count_pickup_datetime_idx" btree (passenger_count, pickup_datetime DESC)</span><br><span class="line">    "rides_pickup_datetime_vendor_id_idx" btree (pickup_datetime DESC, vendor_id)</span><br><span class="line">    "rides_rate_code_pickup_datetime_idx" btree (rate_code, pickup_datetime DESC)</span><br><span class="line">    "rides_vendor_id_pickup_datetime_idx" btree (vendor_id, pickup_datetime DESC)</span><br><span class="line">Triggers:</span><br><span class="line">    ts_insert_blocker BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> rides <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> _timescaledb_internal.insert_blocker()</span><br><span class="line"><span class="keyword">Child</span> <span class="keyword">tables</span>: _timescaledb_internal._hyper_2_10_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_11_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_12_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_1_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_2_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_3_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_4_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_5_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_6_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_7_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_8_chunk,</span><br><span class="line">              _timescaledb_internal._hyper_2_9_chunk</span><br></pre></td></tr></table></figure><h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><h4 id="普通查询"><a href="#普通查询" class="headerlink" title="普通查询"></a>普通查询</h4><blockquote><p>1月1日至1月10日，同车超过两人，每天平均计费是多少</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT date_trunc('day', pickup_datetime) as day, avg(fare_amount)</span></span><br><span class="line">nyc_data-<span class="comment"># FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># WHERE passenger_count &gt; 1 AND (pickup_datetime &gt;= '2016-01-01' AND pickup_datetime &lt;= '2016-01-10')</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY day ORDER BY day;</span></span><br><span class="line">         day         |         avg</span><br><span class="line"><span class="comment">---------------------+---------------------</span></span><br><span class="line"> 2016-01-01 00:00:00 | 13.3990821679715529</span><br><span class="line"> 2016-01-02 00:00:00 | 13.0224687415181399</span><br><span class="line"> 2016-01-03 00:00:00 | 13.5382068607068607</span><br><span class="line"> 2016-01-04 00:00:00 | 12.9618895561740149</span><br><span class="line"> 2016-01-05 00:00:00 | 12.6614611935518309</span><br><span class="line"> 2016-01-06 00:00:00 | 12.5775245695086098</span><br><span class="line"> 2016-01-07 00:00:00 | 12.5868802584437019</span><br><span class="line"> 2016-01-08 00:00:00 | 12.4288630909742120</span><br><span class="line"> 2016-01-09 00:00:00 | 11.8049625897430078</span><br><span class="line"> 2016-01-10 00:00:00 | 27.2500000000000000</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure><blockquote><p>查询每天交易了多少笔，只显示头五个记录</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT date_trunc('day', pickup_datetime) as day, COUNT(*) FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY day ORDER BY day</span></span><br><span class="line">nyc_data-<span class="comment"># LIMIT 5;</span></span><br><span class="line">         day         | count</span><br><span class="line"><span class="comment">---------------------+--------</span></span><br><span class="line"> 2016-01-01 00:00:00 | 345037</span><br><span class="line"> 2016-01-02 00:00:00 | 312831</span><br><span class="line"> 2016-01-03 00:00:00 | 302878</span><br><span class="line"> 2016-01-04 00:00:00 | 316171</span><br><span class="line"> 2016-01-05 00:00:00 | 343251</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure><h4 id="使用TimescaleDB内置函数"><a href="#使用TimescaleDB内置函数" class="headerlink" title="使用TimescaleDB内置函数"></a>使用TimescaleDB内置函数</h4><blockquote><p>每5分钟间隔为一个BUCKET，输出每个间隔产生了多少笔订单</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT time_bucket('5 minute', pickup_datetime) as five_min, count(*)  </span></span><br><span class="line">nyc_data=<span class="comment"># FROM rides  </span></span><br><span class="line">nyc_data=<span class="comment"># WHERE pickup_datetime &lt; '2016-01-01 02:00'  </span></span><br><span class="line">nyc_data=<span class="comment"># GROUP BY five_min ORDER BY five_min; </span></span><br><span class="line"></span><br><span class="line">      five_min       | count</span><br><span class="line"><span class="comment">---------------------+-------</span></span><br><span class="line"> 2016-01-01 00:00:00 |   703</span><br><span class="line"> 2016-01-01 00:05:00 |  1482</span><br><span class="line"> 2016-01-01 00:10:00 |  1959</span><br><span class="line"> 2016-01-01 00:15:00 |  2200</span><br><span class="line"> 2016-01-01 00:20:00 |  2285</span><br><span class="line"> 2016-01-01 00:25:00 |  2291</span><br><span class="line"> 2016-01-01 00:30:00 |  2349</span><br><span class="line"> 2016-01-01 00:35:00 |  2328</span><br><span class="line"> 2016-01-01 00:40:00 |  2440</span><br><span class="line"> 2016-01-01 00:45:00 |  2372</span><br><span class="line"> 2016-01-01 00:50:00 |  2388</span><br><span class="line"> 2016-01-01 00:55:00 |  2473</span><br><span class="line"> 2016-01-01 01:00:00 |  2395</span><br><span class="line"> 2016-01-01 01:05:00 |  2510</span><br><span class="line"> 2016-01-01 01:10:00 |  2412</span><br><span class="line"> 2016-01-01 01:15:00 |  2482</span><br><span class="line"> 2016-01-01 01:20:00 |  2428</span><br><span class="line"> 2016-01-01 01:25:00 |  2433</span><br><span class="line"> 2016-01-01 01:30:00 |  2337</span><br><span class="line"> 2016-01-01 01:35:00 |  2366</span><br><span class="line"> 2016-01-01 01:40:00 |  2325</span><br><span class="line"> 2016-01-01 01:45:00 |  2257</span><br><span class="line"> 2016-01-01 01:50:00 |  2316</span><br><span class="line"> 2016-01-01 01:55:00 |  2250</span><br><span class="line">(24 rows)</span><br></pre></td></tr></table></figure><blockquote><p>每个城市的TAXI交易量</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nyc_data=<span class="comment"># SELECT rates.description, COUNT(vendor_id) as num_trips FROM rides</span></span><br><span class="line">nyc_data-<span class="comment"># JOIN rates on rides.rate_code = rates.rate_code</span></span><br><span class="line">nyc_data-<span class="comment"># WHERE pickup_datetime &lt; '2016-01-08'</span></span><br><span class="line">nyc_data-<span class="comment"># GROUP BY rates.description ORDER BY rates.description;</span></span><br><span class="line">      description      | num_trips</span><br><span class="line"><span class="comment">-----------------------+-----------</span></span><br><span class="line"> group ride            |        17</span><br><span class="line"> JFK                   |     54832</span><br><span class="line"> Nassau or Westchester |       967</span><br><span class="line"> negotiated fare       |      7193</span><br><span class="line"> Newark                |      4126</span><br><span class="line"> standard rate         |   2266401</span><br><span class="line">(6 rows)</span><br></pre></td></tr></table></figure><h4 id="查看select执行计划"><a href="#查看select执行计划" class="headerlink" title="查看select执行计划"></a>查看select执行计划</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># EXPLAIN SELECT * FROM rides;</span></span><br><span class="line">                                    QUERY PLAN</span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"> Append  (cost=0.00..282354.03 rows=5963403 width=258)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_1_chunk  (cost=0.00..23485.78 rows=781178 width=113)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_2_chunk  (cost=0.00..36322.06 rows=1187506 width=115)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_3_chunk  (cost=0.00..32909.67 rows=1075467 width=116)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_4_chunk  (cost=0.00..15601.72 rows=518772 width=112)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_5_chunk  (cost=0.00..20396.28 rows=281328 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_6_chunk  (cost=0.00..41670.68 rows=574768 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_7_chunk  (cost=0.00..20921.76 rows=288576 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_8_chunk  (cost=0.00..42966.40 rows=592640 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_9_chunk  (cost=0.00..15160.04 rows=209104 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_10_chunk  (cost=0.00..32896.44 rows=453744 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_11_chunk  (cost=0.00..11.60 rows=160 width=472)</span><br><span class="line">   -&gt;  Seq Scan on _hyper_2_12_chunk  (cost=0.00..11.60 rows=160 width=472)</span><br><span class="line">(13 rows)</span><br></pre></td></tr></table></figure><h3 id="配合PostGIS插件实现时间-空间数据库"><a href="#配合PostGIS插件实现时间-空间数据库" class="headerlink" title="配合PostGIS插件实现时间+空间数据库"></a>配合PostGIS插件实现时间+空间数据库</h3><h4 id="安装PostGIS"><a href="#安装PostGIS" class="headerlink" title="安装PostGIS"></a>安装PostGIS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgis25_10</span><br></pre></td></tr></table></figure><h4 id="加载PostGIS"><a href="#加载PostGIS" class="headerlink" title="加载PostGIS"></a>加载PostGIS</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># create extension postgis;</span></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br></pre></td></tr></table></figure><h4 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># ALTER TABLE rides ADD COLUMN pickup_geom geometry(POINT,2163);</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span></span><br><span class="line">postgres=<span class="comment"># ALTER TABLE rides ADD COLUMN dropoff_geom geometry(POINT,2163);</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span></span><br><span class="line">postgres=<span class="comment"># UPDATE rides SET pickup_geom = ST_Transform(ST_SetSRID(ST_MakePoint(pickup_longitude,pickup_latitude),4326),2163);</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">10906860</span></span><br><span class="line">postgres=<span class="comment"># UPDATE rides SET dropoff_geom = ST_Transform(ST_SetSRID(ST_MakePoint(dropoff_longitude,dropoff_latitude),4326),2163);</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">10906860</span></span><br></pre></td></tr></table></figure><h4 id="查询数据-1"><a href="#查询数据-1" class="headerlink" title="查询数据"></a>查询数据</h4><blockquote><p>查询在(lat, long) (40.7589,-73.9851)附近400米范围内，每30分钟有多少辆的士被乘坐</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># SELECT time_bucket('30 minutes', pickup_datetime) AS thirty_min, COUNT(*) AS near_times_sq</span></span><br><span class="line">postgres-<span class="comment">#   FROM rides</span></span><br><span class="line">postgres-<span class="comment">#   WHERE ST_Distance(pickup_geom, ST_Transform(ST_SetSRID(ST_MakePoint(-73.9851,40.7589),4326),2163)) &lt; 400</span></span><br><span class="line">postgres-<span class="comment">#     AND pickup_datetime &lt; '2016-01-01 14:00'</span></span><br><span class="line">postgres-<span class="comment">#   GROUP BY thirty_min ORDER BY thirty_min;</span></span><br><span class="line">     thirty_min      | near_times_sq</span><br><span class="line"><span class="comment">---------------------+---------------</span></span><br><span class="line"> 2016-01-01 00:00:00 |            74</span><br><span class="line"> 2016-01-01 00:30:00 |           102</span><br><span class="line"> 2016-01-01 01:00:00 |           120</span><br><span class="line"> 2016-01-01 01:30:00 |            98</span><br><span class="line"> 2016-01-01 02:00:00 |           112</span><br><span class="line"> 2016-01-01 02:30:00 |           109</span><br><span class="line"> 2016-01-01 03:00:00 |           163</span><br><span class="line"> 2016-01-01 03:30:00 |           181</span><br><span class="line"> 2016-01-01 04:00:00 |           214</span><br><span class="line"> 2016-01-01 04:30:00 |           185</span><br><span class="line"> 2016-01-01 05:00:00 |           158</span><br><span class="line"> 2016-01-01 05:30:00 |           113</span><br><span class="line"> 2016-01-01 06:00:00 |           102</span><br><span class="line"> 2016-01-01 06:30:00 |            91</span><br><span class="line"> 2016-01-01 07:00:00 |            88</span><br><span class="line"> 2016-01-01 07:30:00 |            58</span><br><span class="line"> 2016-01-01 08:00:00 |            72</span><br><span class="line"> 2016-01-01 08:30:00 |            94</span><br><span class="line"> 2016-01-01 09:00:00 |           115</span><br><span class="line"> 2016-01-01 09:30:00 |           118</span><br><span class="line"> 2016-01-01 10:00:00 |           135</span><br><span class="line"> 2016-01-01 10:30:00 |           160</span><br><span class="line"> 2016-01-01 11:00:00 |           212</span><br><span class="line"> 2016-01-01 11:30:00 |           229</span><br><span class="line"> 2016-01-01 12:00:00 |           244</span><br><span class="line"> 2016-01-01 12:30:00 |           230</span><br><span class="line"> 2016-01-01 13:00:00 |           235</span><br><span class="line"> 2016-01-01 13:30:00 |           238</span><br><span class="line">(28 rows)</span><br></pre></td></tr></table></figure><h1 id="TimescaleDB集群"><a href="#TimescaleDB集群" class="headerlink" title="TimescaleDB集群"></a>TimescaleDB集群</h1><blockquote><p>由于TimescaleDB是PostgreSQL的一个插件，因此可以借助PostgreSQL自身的特性实现集群功能</p></blockquote><ul><li>基于流复制实现主从数据同步</li><li>基于PGPool实现读写分离+主从自动切换</li><li>基于patroni实现高可用集群</li><li>基于PostgreSQL-X2实现多主多读+横向扩展的分布式集群</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里只记录搭建和简单测试过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10流复制配合PGPool-II实现数据库HA主备切换</title>
    <link href="https://luanlengli.github.io/2019/05/24/PostgreSQL10%E6%B5%81%E5%A4%8D%E5%88%B6-PGPool-II%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93HA%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2.html"/>
    <id>https://luanlengli.github.io/2019/05/24/PostgreSQL10流复制-PGPool-II实现数据库HA主备切换.html</id>
    <published>2019-05-24T03:01:59.000Z</published>
    <updated>2019-05-27T03:23:00.007Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>这里只记录搭建和简单测试过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能完整跑起来</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>PostgreSQL版本号<code>10.8</code></p><p>PGPool版本号<code>4.0.5</code></p><p>虚拟机配置<code>1CPU 2G内存 20G系统盘</code></p><p><code>postgres</code>用户默认情况下PGDATA变量是<code>/var/lib/pgsql/10/data</code></p><p>这里没有使用数据盘，有需要的可以自行调整！</p><p>由watchdog通过ARP协议提供的VIP切换来保证服务可用性，这里不涉及负载均衡！</p><font color="red">注意！在某些公有云环境不一定支持基于ARP协议做VIP</font></blockquote><h1 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h1><p><img src="https://fatdragon.me/sites/default/files/watchdog_master_slave.png" alt="PGPool内部如何管理后端PostgreSQL数据库"></p><p><img src="/2019/05/24/./PostgreSQL10流复制-PGPool-II实现数据库HA主备切换\客户端通过PGPool访问PostgreSQL数据库.png" alt="客户端通过PGPool访问PostgreSQL数据库"></p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="主机清单"><a href="#主机清单" class="headerlink" title="主机清单"></a>主机清单</h2><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th><th>监听端口</th></tr></thead><tbody><tr><td>vip</td><td>172.16.80.200</td><td>vip</td><td></td></tr><tr><td>pg1</td><td>172.16.80.201</td><td>master</td><td>5432</td></tr><tr><td>pg2</td><td>172.16.80.202</td><td>slave</td><td>5432</td></tr></tbody></table><h2 id="准备基于stream的主从集群"><a href="#准备基于stream的主从集群" class="headerlink" title="准备基于stream的主从集群"></a>准备基于stream的主从集群</h2><p>这里可以看这个链接<a href="https://luanlengli.github.io/2019/05/21/PostgreSQL10%E5%9F%BA%E4%BA%8Estream%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4.html">PostgreSQL10基于stream复制搭建主从集群</a></p><h2 id="修改hosts文件"><a href="#修改hosts文件" class="headerlink" title="修改hosts文件"></a>修改hosts文件</h2><blockquote><p>把每个服务器的主机IP地址做静态解析</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.80.200 vip</span><br><span class="line">172.16.80.201 pg1</span><br><span class="line">172.16.80.202 pg2</span><br></pre></td></tr></table></figure><h2 id="配置系统命令权限"><a href="#配置系统命令权限" class="headerlink" title="配置系统命令权限"></a>配置系统命令权限</h2><blockquote><p>切换脚本需要使用root权限运行</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+s /usr/sbin/ip /usr/sbin/arping</span><br></pre></td></tr></table></figure><h2 id="配置SSH密钥"><a href="#配置SSH密钥" class="headerlink" title="配置SSH密钥"></a>配置SSH密钥</h2><ul><li>修改postgres用户的密码</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd postgres</span><br></pre></td></tr></table></figure><ul><li>切换到postgres用户</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><ul><li>生成SSH密钥</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ecdsa -b 521 -N '' -f ~/.ssh/id_ecdsa</span><br></pre></td></tr></table></figure><ul><li>配置SSH免密登录</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id pg1</span><br><span class="line">ssh-copy-id pg2</span><br></pre></td></tr></table></figure><h1 id="PGPool"><a href="#PGPool" class="headerlink" title="PGPool"></a>PGPool</h1><h2 id="创建PGPool健康检查用户"><a href="#创建PGPool健康检查用户" class="headerlink" title="创建PGPool健康检查用户"></a>创建PGPool健康检查用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create user pgpool_check with password 'pgpool_password';</span><br><span class="line">grant all privileges on database postgres to pgpool_check;</span><br></pre></td></tr></table></figure><h2 id="安装PGPool"><a href="#安装PGPool" class="headerlink" title="安装PGPool"></a>安装PGPool</h2><blockquote><p>PGPool在PostgreSQL社区提供的YUM源里面有，直接装就是了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pgpool-II-10-4.0.5-1.rhel7 pgpool-II-10-extensions-4.0.5-1.rhel7</span><br></pre></td></tr></table></figure><blockquote><p>PGPool也提供了WebUI方便管理，按需安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pgpoolAdmin</span><br></pre></td></tr></table></figure><h2 id="配置PGPool"><a href="#配置PGPool" class="headerlink" title="配置PGPool"></a>配置PGPool</h2><blockquote><p>配置文件的目录在<code>/etc/pgpool-II-10</code></p></blockquote><h3 id="配置pcp-conf"><a href="#配置pcp-conf" class="headerlink" title="配置pcp.conf"></a>配置pcp.conf</h3><blockquote><p><code>pcp.conf</code>是配置<code>pgpool-II</code>自己的用户名和密码</p></blockquote><ul><li>使用pg_md5命令加密密码</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_md5 pgpool_password</span><br></pre></td></tr></table></figure><ul><li>输出示例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4aa0cb9673e84b06d4c8a848c80eb5d0</span><br></pre></td></tr></table></figure><ul><li>添加到<code>pcp.conf</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres:4aa0cb9673e84b06d4c8a848c80eb5d0</span><br></pre></td></tr></table></figure><h3 id="配置pool-hba-conf"><a href="#配置pool-hba-conf" class="headerlink" title="配置pool_hba.conf"></a>配置pool_hba.conf</h3><blockquote><p><code>pool_hba.conf</code>跟PostgreSQL里面的<code>pg_hba.conf</code>作用一样，可以拷贝<code>pg_hba.conf</code>的内容过来</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认配置数据库主机以socket、127.0.0.1、::1的方式连接数据库可以跳过认证阶段直接登录数据库</span></span><br><span class="line">local   all             all                                     trust</span><br><span class="line">host    all             all             127.0.0.1/32            trust</span><br><span class="line">host    all             all             ::1/128                 trust</span><br><span class="line">host    all             all             172.16.80.0/24          md5</span><br></pre></td></tr></table></figure><h3 id="配置pgpool-conf"><a href="#配置pgpool-conf" class="headerlink" title="配置pgpool.conf"></a>配置pgpool.conf</h3><blockquote><p><code>pgpool.conf</code>可以参考<code>/etc/pgpool-II-10/pgpool.conf.sample</code>的配置</p><p>需要注意的几个点！</p></blockquote><h4 id="master节点"><a href="#master节点" class="headerlink" title="master节点"></a>master节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pgPool-II configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONNECTIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">listen_addresses = '*'</span><br><span class="line">port = 9999</span><br><span class="line">socket_dir = '/tmp'</span><br><span class="line">listen_backlog_multiplier = 2</span><br><span class="line">serialize_accept = off</span><br><span class="line">pcp_listen_addresses = '*'</span><br><span class="line">pcp_port = 9898</span><br><span class="line">pcp_socket_dir = '/tmp'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Backend Connection Settings -</span></span><br><span class="line">backend_hostname0 = 'pg1'</span><br><span class="line">backend_port0 = 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> load_balance_mode为off时不生效</span></span><br><span class="line">backend_weight0 = 1</span><br><span class="line">backend_data_directory0 = '/var/lib/pgsql/10/data'</span><br><span class="line">backend_flag0 = 'ALLOW_TO_FAILOVER'</span><br><span class="line">backend_hostname1 = 'pg2'</span><br><span class="line">backend_port1 = 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> load_balance_mode为off时不生效</span></span><br><span class="line">backend_weight1 = 1</span><br><span class="line">backend_data_directory1 = '/var/lib/pgsql/10/data'</span><br><span class="line">backend_flag1 = 'ALLOW_TO_FAILOVER'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Authentication -</span></span><br><span class="line">enable_pool_hba = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义pool_hba.conf读取password文件</span></span><br><span class="line">pool_passwd = 'pool_passwd'</span><br><span class="line">authentication_timeout = 30</span><br><span class="line">allow_clear_text_frontend_auth = off</span><br><span class="line"><span class="meta">#</span><span class="bash"> - SSL Connections -</span></span><br><span class="line">ssl = off</span><br><span class="line">ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'</span><br><span class="line">ssl_prefer_server_ciphers = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> POOLS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Concurrent session and pool size -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> num_init_children * max_pool的值为PGPool可以接收多少客户端并发连接，计算方式</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (max_pool * num_init_children) &lt; (max_connections - superuser_reserved_connections)</span></span><br><span class="line">num_init_children = 32</span><br><span class="line">max_pool = 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Life time -</span></span><br><span class="line">child_life_time = 600</span><br><span class="line">child_max_connections = 0</span><br><span class="line">connection_life_time = 0</span><br><span class="line">client_idle_limit = 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LOGS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Where to <span class="built_in">log</span> -</span></span><br><span class="line">log_destination = 'stderr'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - What to <span class="built_in">log</span> -</span></span><br><span class="line">log_line_prefix = '%t PID=%p: '</span><br><span class="line">log_connections = on</span><br><span class="line">log_hostname = on</span><br><span class="line">log_statement = on</span><br><span class="line">log_per_node_statement = on</span><br><span class="line">log_client_messages = on</span><br><span class="line">log_standby_delay = 'none'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Syslog specific -</span></span><br><span class="line">syslog_facility = 'LOCAL0'</span><br><span class="line">syslog_ident = 'pgpool'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Debug -</span></span><br><span class="line">log_error_verbosity = verbose</span><br><span class="line"><span class="meta">#</span><span class="bash">client_min_messages = notice</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_messages = warning</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FILE LOCATIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">pid_file_name = '/var/run/pgpool-II-10/pgpool.pid'</span><br><span class="line">logdir = '/var/log/pgpool-II-10'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONNECTION POOLING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">connection_cache = on</span><br><span class="line">reset_query_list = 'ABORT; DISCARD ALL'</span><br><span class="line"><span class="meta">#</span><span class="bash">reset_query_list = <span class="string">'ABORT; RESET ALL; SET SESSION AUTHORIZATION DEFAULT'</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> REPLICATION MODE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">replication_mode = off</span><br><span class="line">replicate_select = off</span><br><span class="line">insert_lock = on</span><br><span class="line">lobj_lock_table = ''</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Degenerate handling -</span></span><br><span class="line">replication_stop_on_mismatch = off</span><br><span class="line">failover_if_affected_tuples_mismatch = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LOAD BALANCING MODE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">load_balance_mode = off</span><br><span class="line">ignore_leading_white_space = on</span><br><span class="line">white_function_list = ''</span><br><span class="line">black_function_list = 'currval,lastval,nextval,setval'</span><br><span class="line">black_query_pattern_list = ''</span><br><span class="line">database_redirect_preference_list = ''</span><br><span class="line">app_name_redirect_preference_list = ''</span><br><span class="line">allow_sql_comments = off</span><br><span class="line">disable_load_balance_on_write = 'transaction'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER/SLAVE MODE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">master_slave_mode = on</span><br><span class="line">master_slave_sub_mode = 'stream'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Streaming -</span></span><br><span class="line">sr_check_period = 3</span><br><span class="line">sr_check_user = 'repluser'</span><br><span class="line">sr_check_password = 'repluser_password'</span><br><span class="line">sr_check_database = 'postgres'</span><br><span class="line">delay_threshold = 'always'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Special commands -</span></span><br><span class="line">follow_master_command = ''</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> HEALTH CHECK GLOBAL PARAMETERS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">health_check_period = 10</span><br><span class="line">health_check_timeout = 3</span><br><span class="line">health_check_user = 'pgpool_check'</span><br><span class="line">health_check_password = 'pgpool_password'</span><br><span class="line">health_check_database = 'postgres'</span><br><span class="line">health_check_max_retries = 3</span><br><span class="line">health_check_retry_delay = 1</span><br><span class="line">connect_timeout = 3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> HEALTH CHECK PER NODE PARAMETERS (OPTIONAL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_period0 = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_timeout0 = 20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_user0 = <span class="string">'nobody'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_password0 = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_database0 = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_max_retries0 = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">health_check_retry_delay0 = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">connect_timeout0 = 10000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FAILOVER AND FAILBACK</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">failover_command = '/etc/pgpool-II-10/failover_stream.sh -d %d -h %h -p %p -D %D -M %M -m %m -H %H -P %P -r %r -R %R &gt; /var/lib/pgsql/10/data/log/failover.log'</span><br><span class="line">failback_command = ''</span><br><span class="line">failover_on_backend_error = on</span><br><span class="line">detach_false_primary = off</span><br><span class="line">search_primary_node_timeout = 60</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ONLINE RECOVERY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">recovery_user = 'nobody'</span><br><span class="line">recovery_password = ''</span><br><span class="line">recovery_1st_stage_command = ''</span><br><span class="line">recovery_2nd_stage_command = ''</span><br><span class="line">recovery_timeout = 90</span><br><span class="line">client_idle_limit_in_recovery = 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WATCHDOG</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Enabling -</span></span><br><span class="line">use_watchdog = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> -Connection to up stream servers -</span></span><br><span class="line">trusted_servers = ''</span><br><span class="line">ping_path = '/bin'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Watchdog communication Settings -</span></span><br><span class="line">wd_hostname = 'pg1'</span><br><span class="line">wd_port = 9000</span><br><span class="line">wd_priority = 1</span><br><span class="line">wd_authkey = 'pgpool_watchdog'</span><br><span class="line">wd_ipc_socket_dir = '/tmp'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Virtual IP control Setting -</span></span><br><span class="line">delegate_IP = '172.16.80.200'</span><br><span class="line">if_cmd_path = '/usr/sbin'</span><br><span class="line">if_up_cmd = 'ip addr add $_IP_$/24 dev ens33 label ens33:0'</span><br><span class="line">if_down_cmd = 'ip addr del $_IP_$/24 dev ens33'</span><br><span class="line">arping_path = '/usr/sbin'</span><br><span class="line">arping_cmd = 'arping -U $_IP_$ -w 1'</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Behaivor on escalation Setting -</span></span><br><span class="line">clear_memqcache_on_escalation = on</span><br><span class="line">wd_escalation_command = ''</span><br><span class="line">wd_de_escalation_command = ''</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Watchdog consensus settings <span class="keyword">for</span> failover -</span></span><br><span class="line">failover_when_quorum_exists = on</span><br><span class="line">failover_require_consensus = on</span><br><span class="line">allow_multiple_failover_requests_from_node = off</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Lifecheck Setting -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -- common --</span></span><br><span class="line">wd_monitoring_interfaces_list = 'ens33'</span><br><span class="line">wd_lifecheck_method = 'heartbeat'</span><br><span class="line">wd_interval = 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> -- heartbeat mode --</span></span><br><span class="line">wd_heartbeat_port = 9694</span><br><span class="line">wd_heartbeat_keepalive = 2</span><br><span class="line">wd_heartbeat_deadtime = 30</span><br><span class="line">heartbeat_destination0 = 'pg2'</span><br><span class="line">heartbeat_destination_port0 = 9694</span><br><span class="line">heartbeat_device0 = 'ens33'</span><br><span class="line"><span class="meta">#</span><span class="bash"> -- query mode --</span></span><br><span class="line">wd_life_point = 3</span><br><span class="line">wd_lifecheck_query = 'SELECT 1'</span><br><span class="line">wd_lifecheck_dbname = 'template1'</span><br><span class="line">wd_lifecheck_user = 'nobody'</span><br><span class="line">wd_lifecheck_password = ''</span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other pgpool Connection Settings -</span></span><br><span class="line">other_pgpool_hostname0 = 'pg2'</span><br><span class="line">other_pgpool_port0 = 9999</span><br><span class="line">other_wd_port0 = 9000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> OTHERS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">relcache_expire = 0</span><br><span class="line">relcache_size = 256</span><br><span class="line">check_temp_table = on</span><br><span class="line">check_unlogged_table = on</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IN MEMORY QUERY MEMORY CACHE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line">memory_cache_enabled = off</span><br><span class="line">memqcache_method = 'shmem'</span><br><span class="line">memqcache_memcached_host = 'localhost'</span><br><span class="line">memqcache_memcached_port = 11211</span><br><span class="line">memqcache_total_size = 67108864</span><br><span class="line">memqcache_max_num_cache = 1000000</span><br><span class="line">memqcache_expire = 0</span><br><span class="line">memqcache_auto_cache_invalidation = on</span><br><span class="line">memqcache_maxcache = 409600</span><br><span class="line">memqcache_cache_block_size = 1048576</span><br><span class="line">memqcache_oiddir = '/var/log/pgpool/oiddir'</span><br><span class="line">white_memqcache_table_list = ''</span><br><span class="line">black_memqcache_table_list = ''</span><br></pre></td></tr></table></figure><h4 id="slave节点"><a href="#slave节点" class="headerlink" title="slave节点"></a>slave节点</h4><blockquote><p>可以照抄master节点的配置</p><p>注意以下几个地方要做对应变更</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wd_hostname = 'pg2'</span><br><span class="line">heartbeat_destination0 = 'pg1'</span><br><span class="line">other_pgpool_hostname0 = 'pg1'</span><br></pre></td></tr></table></figure><h3 id="生成pool-passwd文件"><a href="#生成pool-passwd文件" class="headerlink" title="生成pool_passwd文件"></a>生成pool_passwd文件</h3><blockquote><p>在<code>/etc/pgpool-II-10/pool_passwd</code>添加连接到后端PostgreSQL数据库的用户密码</p><p>会提示输入密码，这里的密码请填写PostgreSQL数据库用户对应的密码</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pg_md5 -p -m -u postgres pool_passwd</span><br><span class="line">pg_md5 -p -m -u appuser pool_passwd</span><br></pre></td></tr></table></figure><blockquote><p>修改权限</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+r /etc/pgpool-II-10/pool_passwd</span><br></pre></td></tr></table></figure><h3 id="创建切换脚本"><a href="#创建切换脚本" class="headerlink" title="创建切换脚本"></a>创建切换脚本</h3><p><code>/etc/pgpool-II-10/failover_stream.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -ex</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取参数</span></span><br><span class="line">while getopts 'd:D:h:H:m:M:p:P:r:R:' OPT; do</span><br><span class="line">    case $OPT in</span><br><span class="line">        d)</span><br><span class="line">            NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        D)</span><br><span class="line">            DATABASE_CLUSTER_PATH="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        h)</span><br><span class="line">            HOSTNAME="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        H)</span><br><span class="line">            NEW_MASTER_HOSTNAME="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        m)</span><br><span class="line">            NEW_MASTER_NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        M)</span><br><span class="line">            OLD_MASTER_NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        p)</span><br><span class="line">            PORT_NUM="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        P)</span><br><span class="line">            OLD_PRIMARY_NODE_ID="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        r)</span><br><span class="line">            NEW_MASTER_PORT_NUM="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        R)</span><br><span class="line">            NEW_MASTER_DATABASE_CLUSTER_PATH="$OPTARG"</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            echo "Usage: `basename $0` -d NODE_ID -D DATABASE_CLUSTER_PATH -h HOSTNAME -H NEW_MASTER_NODE_HOSTNAME -m NEW_MASTER_NODE_ID -M OLD_MASTER_NODE_ID -p PORT_NUM -P OLD_PRIMARY_NODE_ID -r NEW_MASTER_PORT_NUM -R NEW_MASTER_DATABASE_PATH"</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 大型变量打印现场</span></span><br><span class="line">echo "HOSTNAME: $&#123;HOSTNAME&#125;"</span><br><span class="line">echo "NODE_ID: $&#123;NODE_ID&#125;"</span><br><span class="line">echo "PORT_NUM: $&#123;PORT_NUM&#125;"</span><br><span class="line">echo "DATABASE_CLUSTER_PATH: $&#123;DATABASE_CLUSTER_PATH&#125;"</span><br><span class="line">echo "OLD_MASTER_NODE_ID: $&#123;OLD_MASTER_NODE_ID&#125;"</span><br><span class="line">echo "OLD_PRIMARY_NODE_ID: $&#123;OLD_PRIMARY_NODE_ID&#125;"</span><br><span class="line">echo "NEW_MASTER_HOSTNAME: $&#123;NEW_MASTER_HOSTNAME&#125;"</span><br><span class="line">echo "NEW_MASTER_NODE_ID: $&#123;NEW_MASTER_NODE_ID&#125;"</span><br><span class="line">echo "NEW_MASTER_PORT_NUM: $&#123;NEW_MASTER_PORT_NUM&#125;"</span><br><span class="line">echo "NEW_MASTER_DATABASE_CLUSTER_PATH: $&#123;NEW_MASTER_DATABASE_CLUSTER_PATH&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义PostgreSQL家目录，默认是/usr/pgsql-10</span></span><br><span class="line">PGHOME='/usr/pgsql-10'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义PGDATA，默认是/var/lib/pgsql/10/data，这里使用pgpool.conf定义的backend_data_directory</span></span><br><span class="line">PGDATA=$&#123;NEW_MASTER_DATABASE_CLUSTER_PATH&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拼凑字符串命令</span></span><br><span class="line">TRIGGER_COMMAND="$PGHOME/bin/pg_ctl promote -D $PGDATA"</span><br><span class="line"><span class="meta">#</span><span class="bash"> pg_ctl promote的功能是让备份服务器退出恢复进程并且转为读写模式</span></span><br><span class="line">/usr/bin/ssh -T $&#123;NEW_MASTER_HOSTNAME&#125; $&#123;TRIGGER_COMMAND&#125;</span><br><span class="line">exit 0;</span><br></pre></td></tr></table></figure><blockquote><p>增加执行权限</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+rx /etc/pgpool-II-10/failover_stream.sh</span><br></pre></td></tr></table></figure><h2 id="启动PGPool"><a href="#启动PGPool" class="headerlink" title="启动PGPool"></a>启动PGPool</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable pgpool-II-10.service</span><br><span class="line">systemctl start pgpool-II-10.service</span><br></pre></td></tr></table></figure><h1 id="验证PGPool"><a href="#验证PGPool" class="headerlink" title="验证PGPool"></a>验证PGPool</h1><ul><li>使用psql连接PGPool</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h vip -p 9999</span><br></pre></td></tr></table></figure><ul><li>查看PGPool节点</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># show pool_nodes;</span></span><br><span class="line"> node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line"><span class="comment">---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+---------------------</span></span><br><span class="line"> 0       | pg1      | 5432 | up     | 0.500000  | primary | 2          | true              | 0                 | 2019-05-26 20:40:44</span><br><span class="line"> 1       | pg2      | 5432 | up     | 0.500000  | standby | 0          | false             | 0                 | 2019-05-26 20:40:44</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><h2 id="PGPool节点重启"><a href="#PGPool节点重启" class="headerlink" title="PGPool节点重启"></a>PGPool节点重启</h2><ul><li>查看watchdog的VIP所在主机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip address</span><br></pre></td></tr></table></figure><ul><li>重启前查看PGPool节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line">-[ RECORD 1 ]------+--------------------</span><br><span class="line">node_id            | 0</span><br><span class="line">hostname           | pg1</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | primary</span><br><span class="line">select_cnt         | 7</span><br><span class="line">load_balance_node  | true</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:40:44</span><br><span class="line">-[ RECORD 2 ]------+--------------------</span><br><span class="line">node_id            | 1</span><br><span class="line">hostname           | pg2</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | standby</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | false</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:40:44</span><br></pre></td></tr></table></figure><ul><li>登录VIP所在主机直接重启</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><ul><li>再次查看节点信息</li></ul><blockquote><p>可以看到VIP所在主机重启之后</p><p>SQL连接会提示连接不可用</p><p>在watchdog的作用下，VIP会自动切换到另一个PGPool节点</p><p>SQL连接再次重新连接成功！</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line">server closed the connection unexpectedly</span><br><span class="line">This probably means the server terminated abnormally</span><br><span class="line">before or while processing the request.</span><br><span class="line">The connection to the server was lost. Attempting reset: Succeeded.</span><br><span class="line">postgres=# show pool_nodes;</span><br><span class="line">-[ RECORD 1 ]------+--------------------</span><br><span class="line">node_id            | 0</span><br><span class="line">hostname           | pg1</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | primary</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | true</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:48</span><br><span class="line">-[ RECORD 2 ]------+--------------------</span><br><span class="line">node_id            | 1</span><br><span class="line">hostname           | pg2</span><br><span class="line">port               | 5432</span><br><span class="line">status             | down</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | standby</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | false</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:42</span><br></pre></td></tr></table></figure><h2 id="PGPool进程被杀"><a href="#PGPool进程被杀" class="headerlink" title="PGPool进程被杀"></a>PGPool进程被杀</h2><ul><li>查看watchdog的VIP所在主机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip address</span><br></pre></td></tr></table></figure><ul><li>查看PGPool节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">postgres=# \x</span><br><span class="line">Expanded display is on.</span><br><span class="line">postgres=# show pool_nodes;</span><br><span class="line">-[ RECORD 1 ]------+--------------------</span><br><span class="line">node_id            | 0</span><br><span class="line">hostname           | pg1</span><br><span class="line">port               | 5432</span><br><span class="line">status             | up</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | primary</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | true</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:48</span><br><span class="line">-[ RECORD 2 ]------+--------------------</span><br><span class="line">node_id            | 1</span><br><span class="line">hostname           | pg2</span><br><span class="line">port               | 5432</span><br><span class="line">status             | down</span><br><span class="line">lb_weight          | 0.500000</span><br><span class="line">role               | standby</span><br><span class="line">select_cnt         | 0</span><br><span class="line">load_balance_node  | false</span><br><span class="line">replication_delay  | 0</span><br><span class="line">last_status_change | 2019-05-26 20:46:42</span><br></pre></td></tr></table></figure><ul><li>找PGPool的进程</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep pgpool</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">postgres  12641      1  0 20:39 ?        00:00:00 /usr/pgpool-10/bin/pgpool -f /etc/pgpool-II-10/pgpool.conf -n -D</span><br></pre></td></tr></table></figure><ul><li>杀PGPool进程</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 12641</span><br></pre></td></tr></table></figure><ul><li>PGPool进程日志</li></ul><blockquote><p>可以看到PGPool的watchdog几乎立刻就反应过来了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">May 26 20:53:14 pg2 pgpool[9607]: LOG:  watchdog node state changed from [STANDBY] to [JOINING]</span><br><span class="line">May 26 20:53:14 pg2 pgpool[9607]: LOCATION:  watchdog.c:6360</span><br><span class="line">May 26 20:53:18 pg2 pgpool[9607]: LOG:  watchdog node state changed from [JOINING] to [INITIALIZING]</span><br><span class="line">May 26 20:53:18 pg2 pgpool[9607]: LOCATION:  watchdog.c:6360</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOG:  I am the only alive node in the watchdog cluster</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: HINT:  skipping stand for coordinator state</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOCATION:  watchdog.c:5231</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOG:  watchdog node state changed from [INITIALIZING] to [MASTER]</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOCATION:  watchdog.c:6360</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOG:  I am announcing my self as master/coordinator watchdog node</span><br><span class="line">May 26 20:53:19 pg2 pgpool[9607]: LOCATION:  watchdog.c:5420</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  I am the cluster leader node</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: DETAIL:  our declare coordinator message is accepted by all nodes</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:5454</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  setting the local node "pg2:9999 Linux pg2" as watchdog cluster master</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:7087</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  I am the cluster leader node. Starting escalation process</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:5473</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  escalation process started with PID:10118</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:6000</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  new IPC connection received</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  watchdog.c:3147</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOG:  watchdog: escalation started</span><br><span class="line">May 26 20:53:23 pg2 pgpool[9607]: LOCATION:  wd_escalation.c:93</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOG:  successfully acquired the delegate IP:"172.16.80.200"</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: DETAIL:  'if_up_cmd' returned with success</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOCATION:  wd_if.c:169</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOG:  watchdog escalation process with pid: 10118 exit with SUCCESS.</span><br><span class="line">May 26 20:53:27 pg2 pgpool[9607]: LOCATION:  watchdog.c:2976</span><br></pre></td></tr></table></figure><h2 id="模拟master节点宕机"><a href="#模拟master节点宕机" class="headerlink" title="模拟master节点宕机"></a>模拟master节点宕机</h2><ul><li>查看节点信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line"> node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line">---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+---------------------</span><br><span class="line"> 0       | pg1      | 5432 | up     | 0.500000  | primary | 0          | true              | 0                 | 2019-05-26 20:58:11</span><br><span class="line"> 1       | pg2      | 5432 | up     | 0.500000  | standby | 0          | false             | 0                 | 2019-05-26 20:59:22</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><ul><li>master节点直接关机</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now</span><br></pre></td></tr></table></figure><ul><li>查看PGPool日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  new IPC connection received</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:3147</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  watchdog received the failover command from local pgpool-II on IPC interface</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2570</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  watchdog is processing the failover command [DEGENERATE_BACKEND_REQUEST] received from local pgpool-II on IPC interface</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2491</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  we have got the consensus to perform the failover</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: DETAIL:  1 node(s) voted in the favor</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2363</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  Pgpool-II parent process has received failover request</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:1594</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  new IPC connection received</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:3147</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  received the failover indication from Pgpool-II on IPC interface</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2716</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOG:  watchdog is informed of failover start by the main process</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10801 USER=[No Connection] DB=[No Connection]: LOCATION:  watchdog.c:2784</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  starting degeneration. shutdown host pg1(5432)</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:1873</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  Restart all children</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:2023</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOG:  execute command: /etc/pgpool-II-10/failover_stream.sh 0 pg1 5432 /var/lib/pgsql/10/data 0 1 pg2 0 5432 /var/lib/pgsql/10/data &gt; /var/lib/pgsql/10/data/log/failover.log</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10800 USER=[No Connection] DB=[No Connection]: LOCATION:  pgpool_main.c:3070</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + getopts d:D:h:H:m:M:p:P:r:R: OPT</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'HOSTNAME: pg2'</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'PORT_NUM: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'DATABASE_CLUSTER_PATH: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'OLD_MASTER_NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'OLD_PRIMARY_NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_HOSTNAME: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_NODE_ID: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_PORT_NUM: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + echo 'NEW_MASTER_DATABASE_CLUSTER_PATH: '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + PGHOME=/usr/pgsql-10</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + PGDATA=</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + TRIGGER_COMMAND='/usr/pgsql-10/bin/pg_ctl promote -D '</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: + /usr/bin/ssh -T /usr/pgsql-10/bin/pg_ctl promote -D</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10871 USER=postgres DB=postgres: WARNING:  failover/failback is in progress</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10871 USER=postgres DB=postgres: DETAIL:  executing failover or failback on backend</span><br><span class="line">May 26 21:06:02 pg2 pgpool[10800]: 2019-05-26 21:06:02 PID=10871 USER=postgres DB=postgres: HINT:  In a moment you should be able to reconnect to the database</span><br></pre></td></tr></table></figure><ul><li>查看PGPool节点</li></ul><blockquote><p>可以看到PGPool帮我们自动将standby节点切换为primary</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line"> node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line">---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+---------------------</span><br><span class="line"> 0       | pg1      | 5432 | down   | 0.500000  | standby | 0          | false             | 0                 | 2019-05-26 21:09:59</span><br><span class="line"> 1       | pg2      | 5432 | up     | 0.500000  | primary | 0          | true              | 0                 | 2019-05-26 21:12:56</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><ul><li><p>启动master节点</p></li><li><p>在master登录到自己的PostgreSQL</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><ul><li>查看<code>pg_is_in_recovery()</code></li></ul><blockquote><p>发现master节点上面的PostgreSQL状态为<code>f</code>，没有自动转换为pg2的从库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> f</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><ul><li>手动处理一下</li></ul><blockquote><p>切换用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cd $PGDATA</span><br></pre></td></tr></table></figure><blockquote><p>创建<code>recovery.conf</code>文件</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定timeline为latest，保证主从数据差异尽可能小</span></span><br><span class="line">recovery_target_timeline = 'latest'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此选项会让PostgreSQL一直处于数据恢复状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不断去请求primary_conninfo定义的主节点的WAL日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 并将这些WAL日志恢复到本地数据库中</span></span><br><span class="line">standby_mode = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义主库的连接方式</span></span><br><span class="line">primary_conninfo = 'host=pg2 port=5432 user=repluser password=repluser_password'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个文件是用于触发停止流复制的操作！不需要手动创建</span></span><br><span class="line">trigger_file = '/var/lib/pgsql/10/data/pg.trigger'</span><br></pre></td></tr></table></figure><blockquote><p>重启PostgreSQL</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_ctl restart</span><br></pre></td></tr></table></figure><blockquote><p>登录数据库查看状态，可以看到状态变成了<code>t</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><blockquote><p>手动加入PGPool集群</p><p>这里输入之前<code>pcp.conf</code>定义的用户密码</p></blockquote><ul><li>参数解析如下<ul><li><code>-h</code>这里指定pcp的IP地址，这里用VIP</li><li><code>-p</code>这里指定pcp的端口，默认是9898</li><li><code>-U</code>这里指定登录pcp的用户，在<code>/etc/pgpool-II-10/pcp.conf</code>里面定义的</li><li><code>-n</code>这里指定节点ID，可以在<code>show pool_nodes</code>里面查到节点对应的ID号</li><li><code>-d</code>输出debug日志</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pcp_attach_node -U postgres -h vip -p 9898 -n 0 -d</span><br><span class="line">Password: </span><br><span class="line">DEBUG: recv: tos="m", len=8</span><br><span class="line">DEBUG: recv: tos="r", len=21</span><br><span class="line">DEBUG: send: tos="C", len=6</span><br><span class="line">DEBUG: recv: tos="c", len=20</span><br><span class="line">pcp_attach_node -- Command Successful</span><br><span class="line">DEBUG: send: tos="X", len=4</span><br></pre></td></tr></table></figure><blockquote><p>查看PGPool节点状态，可以看到pg1状态是waiting，过一阵之后就变成up了</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres=# show pool_nodes;</span><br><span class="line"> node_id | hostname | port | status  | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | last_status_change  </span><br><span class="line">---------+----------+------+---------+-----------+---------+------------+-------------------+-------------------+---------------------</span><br><span class="line"> 0       | pg1      | 5432 | up      | 0.500000  | standby | 0          | false             | 4200              | 2019-05-26 21:19:05</span><br><span class="line"> 1       | pg2      | 5432 | up      | 0.500000  | primary | 0          | true              | 0                 | 2019-05-26 21:12:56</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure><h1 id="维护操作"><a href="#维护操作" class="headerlink" title="维护操作"></a>维护操作</h1><h2 id="PGPool节点down"><a href="#PGPool节点down" class="headerlink" title="PGPool节点down"></a>PGPool节点down</h2><ul><li>检查PostgreSQL是否正常启动</li><li>查看<code>$PGDATA</code>目录是否有<code>recovery.conf</code>或者<code>recovery.done</code>，一般情况下，只存在一个文件<ul><li>其中<code>recovery.done</code>会让数据库启动时以主库形式启动</li><li><code>recovery.conf</code>会让数据库作为从库启动</li><li>在发生主从切换的时候，<code>recovery.conf</code>会被重命名为<code>recovery.done</code></li></ul></li><li>如确认当前down节点是要作为从库启动，则重命名<code>recovery.done</code>为<code>recovery.conf</code>，然后重启数据库<ul><li>需要确认一下是否能从新的主库同步数据</li></ul></li></ul><h2 id="PGPool节点waiting"><a href="#PGPool节点waiting" class="headerlink" title="PGPool节点waiting"></a>PGPool节点waiting</h2><ul><li>节点还在做主从同步</li><li>PGPool还在创建子进程用于连接此节点，子进程数量多，耗时会相应变长</li><li>如果登录很久都是waiting，可以尝试重启一下PGPool的服务</li></ul><h2 id="PGPool重新添加节点"><a href="#PGPool重新添加节点" class="headerlink" title="PGPool重新添加节点"></a>PGPool重新添加节点</h2><blockquote><p>确保主从数据库都已正常，但是节点状态还是down，就需要手工添加到集群中了</p></blockquote><ul><li>使用<code>pcp_attach_node</code>命令，输入<code>pcp.conf</code>定义的密码之后即可将节点重新加入PGPool</li><li>参数解析如下<ul><li><code>-h</code>这里指定pcp的IP地址，这里用VIP</li><li><code>-p</code>这里指定pcp的端口，默认是9898</li><li><code>-U</code>这里指定登录pcp的用户，在<code>/etc/pgpool-II-10/pcp.conf</code>里面定义的</li><li><code>-n</code>这里指定节点ID，可以在<code>show pool_nodes</code>里面查到节点对应的ID号</li><li><code>-d</code>输出debug日志</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pcp_attach_node -h vip -p 9898 -U postgres -n NODE_ID -d</span><br><span class="line">Password:</span><br><span class="line">DEBUG: recv: tos="m", len=8</span><br><span class="line">DEBUG: recv: tos="r", len=21</span><br><span class="line">DEBUG: send: tos="C", len=6</span><br><span class="line">DEBUG: recv: tos="c", len=20</span><br><span class="line">pcp_attach_node -- Command Successful</span><br><span class="line">DEBUG: send: tos="X", len=4</span><br></pre></td></tr></table></figure><blockquote></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里只记录搭建和简单测试过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10基于stream复制搭建主从集群</title>
    <link href="https://luanlengli.github.io/2019/05/21/PostgreSQL10%E5%9F%BA%E4%BA%8Estream%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2019/05/21/PostgreSQL10基于stream复制搭建主从集群.html</id>
    <published>2019-05-21T03:00:47.000Z</published>
    <updated>2019-06-03T12:42:52.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>这里只记录搭建和简单测试过程</p><p>不保证<code>ctrl+c</code>和<code>ctrl+v</code>能完整跑起来</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>PostgreSQL版本号<code>10.8</code></p><p>虚拟机配置<code>1CPU 2G内存 20G系统盘</code></p><p><code>postgres</code>用户默认情况下PGDATA变量是<code>/var/lib/pgsql/10/data</code></p><font color="red">这里没有使用数据盘，有需要的可以自行调整！</font></blockquote><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="主机清单"><a href="#主机清单" class="headerlink" title="主机清单"></a>主机清单</h2><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th><th>监听端口</th></tr></thead><tbody><tr><td>pg1</td><td>172.16.80.201</td><td>master</td><td>5432</td></tr><tr><td>pg2</td><td>172.16.80.202</td><td>slave</td><td>5432</td></tr></tbody></table><h2 id="配置-etc-hosts"><a href="#配置-etc-hosts" class="headerlink" title="配置/etc/hosts"></a>配置/etc/hosts</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.201 pg1</span><br><span class="line">172.16.80.202 pg2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h2><p>参照此链接在两个节点上面安装好PostgreSQL，但是先不初始化数据库！！！！</p><p><a href="https://luanlengli.github.io/2019/05/20/PostgreSQL10%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96.html">PostgreSQL10安装部署和初始化</a></p><h1 id="基于stream主从复制配置"><a href="#基于stream主从复制配置" class="headerlink" title="基于stream主从复制配置"></a>基于stream主从复制配置</h1><h2 id="master节点"><a href="#master节点" class="headerlink" title="master节点"></a>master节点</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><blockquote><font color="red">如果是有业务在跑，已经有数据了就不要做这一步操作！直接从</font><strong>创建复制用户</strong><font color="red">那一步开始</font></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/pgsql-10/bin/postgresql-10-setup initdb</span><br></pre></td></tr></table></figure><h3 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now postgres-10.service</span><br></pre></td></tr></table></figure><h3 id="登录数据库"><a href="#登录数据库" class="headerlink" title="登录数据库"></a>登录数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><h3 id="创建复制用户"><a href="#创建复制用户" class="headerlink" title="创建复制用户"></a>创建复制用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER repluser REPLICATION LOGIN CONNECTION LIMIT 2 ENCRYPTED PASSWORD 'repluser_password';</span><br></pre></td></tr></table></figure><h3 id="创建-pgpass文件"><a href="#创建-pgpass文件" class="headerlink" title="创建.pgpass文件"></a>创建.pgpass文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cat &gt; ~/.pgpass &lt;&lt;EOF</span><br><span class="line">pg2:5432:replication:repluser:repluser_password</span><br><span class="line">EOF</span><br><span class="line">chmod 0600 ~/.pgpass</span><br></pre></td></tr></table></figure><h3 id="编辑pg-hba-conf"><a href="#编辑pg-hba-conf" class="headerlink" title="编辑pg_hba.conf"></a>编辑pg_hba.conf</h3><blockquote><p>增加配置如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host    replication     repluser        172.16.80.0/24          md5</span><br></pre></td></tr></table></figure><h3 id="编辑postgres-conf"><a href="#编辑postgres-conf" class="headerlink" title="编辑postgres.conf"></a>编辑postgres.conf</h3><blockquote><p>增加配置参数如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wal_level = replica</span><br><span class="line"><span class="meta">#</span><span class="bash"> 有多少个slave节点，max_wal_senders就设置为多少</span></span><br><span class="line">max_wal_senders = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> wal_keep_segments可以设置大一点，每个segments大小16MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样在备库不会因为wal receiver启动太慢导致所需wal在主库被删除</span></span><br><span class="line">wal_keep_segments = 64</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加上这个synchronous_standby_names可以开启同步复制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从库不在线或者无法执行写操作时，本地执行完之后会卡住无法返回写入成功</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请自行斟酌之后再决定是否配置同步复制</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> synchronous_standby_names = <span class="string">'pg2'</span></span></span><br></pre></td></tr></table></figure><h3 id="重启数据库"><a href="#重启数据库" class="headerlink" title="重启数据库"></a>重启数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">/usr/pgsql-10/bin/pg_ctl restart -D $PGDATA</span><br></pre></td></tr></table></figure><h2 id="slave节点"><a href="#slave节点" class="headerlink" title="slave节点"></a>slave节点</h2><h3 id="创建-pgpass文件-1"><a href="#创建-pgpass文件-1" class="headerlink" title="创建.pgpass文件"></a>创建.pgpass文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cat &gt; ~/.pgpass &lt;&lt;EOF</span><br><span class="line">pg1:5432:replication:repluser:repluser_password</span><br><span class="line">EOF</span><br><span class="line">chmod 0600 ~/.pgpass</span><br></pre></td></tr></table></figure><h3 id="pg-basebackup生成备库文件"><a href="#pg-basebackup生成备库文件" class="headerlink" title="pg_basebackup生成备库文件"></a>pg_basebackup生成备库文件</h3><blockquote><p>把master节点的数据以物理备份的方式，保存到slave节点。</p><p>备份过程不影响其他客户端访问。</p><p>备份出来的内容是整个数据库的所有数据，包括配置文件！</p></blockquote><ul><li><code>-D</code>指定PostgreSQL数据目录</li><li><code>-Fp</code>指定输出格式为plain，这里是缩写，相当于<code>--format=plain</code></li><li><code>-Xs</code>指定传输WAL日志的方法为<code>stream</code>，这里是缩写，相当于<code>--wal-method=stream</code></li><li><code>-h</code>指定PostgreSQL master节点</li><li><code>-p</code>指定端口</li><li><code>-U</code>指定用户</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">pg_basebackup -D $PGDATA -Fp -Xs -v -P -h pg1 -p 5432 -U repluser</span><br></pre></td></tr></table></figure><h3 id="配置recovery-conf"><a href="#配置recovery-conf" class="headerlink" title="配置recovery.conf"></a>配置recovery.conf</h3><blockquote><p>从master节点拷贝过来的数据文件是没有<code>recovery.conf</code>的</p><p>需要手动创建</p><p>好在PostgreSQL安装的时候是有这个配置文件的模板</p><p>里面都是注释</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">cp /usr/pgsql-10/share/recovery.conf.sample $PGDATA/recovery.conf</span><br></pre></td></tr></table></figure><p>修改之后，内容如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定timeline为latest，保证主从数据差异尽可能小</span></span><br><span class="line">recovery_target_timeline = 'latest'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此选项会让PostgreSQL一直处于数据恢复状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不断去请求primary_conninfo定义的主节点的WAL日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 并将这些WAL日志恢复到本地数据库中</span></span><br><span class="line">standby_mode = on</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义主库的连接方式</span></span><br><span class="line">primary_conninfo = 'host=pg1 port=5432 user=repluser password=repluser_password application_name=pg2'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个文件是用于触发停止流复制的操作！不需要手动创建</span></span><br><span class="line">trigger_file = '/var/lib/pgsql/10/data/pg.trigger'</span><br></pre></td></tr></table></figure><h3 id="启动备库"><a href="#启动备库" class="headerlink" title="启动备库"></a>启动备库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now postgresql-10.service</span><br></pre></td></tr></table></figure><h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><h2 id="master节点-1"><a href="#master节点-1" class="headerlink" title="master节点"></a>master节点</h2><h3 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep postgres</span><br></pre></td></tr></table></figure><blockquote><p>查看是否有<code>postgres: wal sender process</code></p></blockquote><h3 id="查看recovery状态"><a href="#查看recovery状态" class="headerlink" title="查看recovery状态"></a>查看recovery状态</h3><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h pg1</span><br></pre></td></tr></table></figure><blockquote><p>输入sql语句，主库返回<code>f</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> f</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h3 id="查看主备同步状态"><a href="#查看主备同步状态" class="headerlink" title="查看主备同步状态"></a>查看主备同步状态</h3><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h pg1</span><br></pre></td></tr></table></figure><blockquote><p>修改一下输出格式，将每列数据以键值对的方式显示，类似于MySQL的<code>\G</code></p><p>这里是输入一次，当前会话有效，想取消就再输入一次</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x</span><br></pre></td></tr></table></figure><blockquote><p>查看同步状态</p><p>这里可以看到<code>sync_state</code>为<code>async</code>，即异步流复制</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select * from pg_stat_replication ;</span></span><br><span class="line">-[ RECORD 1 ]<span class="comment">----+------------------------------</span></span><br><span class="line">pid              | 8154</span><br><span class="line">usesysid         | 16384</span><br><span class="line">usename          | repluser</span><br><span class="line">application_name | pg2</span><br><span class="line">client_addr      | 172.16.80.202</span><br><span class="line">client_hostname  |</span><br><span class="line">client_port      | 17024</span><br><span class="line">backend_start    | YYYY-MM-DD HH:mm:ss.800271+08</span><br><span class="line">backend_xmin     |</span><br><span class="line">state            | streaming</span><br><span class="line">sent_lsn         | 0/3000108</span><br><span class="line">write_lsn        | 0/3000108</span><br><span class="line">flush_lsn        | 0/3000108</span><br><span class="line">replay_lsn       | 0/3000108</span><br><span class="line">write_lag        |</span><br><span class="line">flush_lag        |</span><br><span class="line">replay_lag       |</span><br><span class="line">sync_priority    | 1</span><br><span class="line">sync_state       | async</span><br></pre></td></tr></table></figure><h2 id="slave节点-1"><a href="#slave节点-1" class="headerlink" title="slave节点"></a>slave节点</h2><h3 id="查看进程-1"><a href="#查看进程-1" class="headerlink" title="查看进程"></a>查看进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep postgres</span><br></pre></td></tr></table></figure><blockquote><p>查看是否有<code>postgres: wal receiver process</code></p></blockquote><h3 id="查看recovery状态-1"><a href="#查看recovery状态-1" class="headerlink" title="查看recovery状态"></a>查看recovery状态</h3><blockquote><p>登录数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -h pg2</span><br></pre></td></tr></table></figure><blockquote><p>输入sql语句，从库返回<code>t</code></p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># select pg_is_in_recovery();</span></span><br><span class="line"> pg_is_in_recovery </span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;这里只记录搭建和简单测试过程&lt;/p&gt;&lt;p&gt;不保证&lt;code&gt;ctrl+c&lt;/code&gt;和&lt;code&gt;ctrl+v&lt;/
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL10安装部署和初始化</title>
    <link href="https://luanlengli.github.io/2019/05/20/PostgreSQL10%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96.html"/>
    <id>https://luanlengli.github.io/2019/05/20/PostgreSQL10安装部署和初始化.html</id>
    <published>2019-05-20T03:03:26.000Z</published>
    <updated>2019-05-29T13:47:14.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录安装部署和初始化过程</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>PostgreSQL版本号为<code>10.8</code></li><li>虚拟机配置<code>1CPU 2G内存 20G系统盘 30G数据盘</code></li><li><font color="red">【根据自己的环境灵活调整，生产环境请务必提供独立数据盘！】</font></li></ul><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld.service</span><br></pre></td></tr></table></figure><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -e 's,^SELINUX=.*,SELINUX=disabled,' -i /etc/selinux/config</span><br></pre></td></tr></table></figure><h2 id="sysctl参数"><a href="#sysctl参数" class="headerlink" title="sysctl参数"></a>sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-pgsql.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示最大限度使用物理内存，物理内存用满再用swap</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度，默认值128</span></span><br><span class="line">net.core.somaxconn=4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max = 1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open = 1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个共享内存段的最大值，这里设置为物理内存大小的一半</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算方式 2048 / 2 * 1024 * 1024 = 1073741824</span></span><br><span class="line">kernel.shmmax = 1073741824</span><br><span class="line"><span class="meta">#</span><span class="bash"> kernel.sem对应四个值分别为SEMMSL、SEMMNS、SEMOPM、SEMMNI</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMMSL 每个信号集的最大信号数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMMNS 用于控制整个 Linux 系统中信号（而不是信号集）的最大数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMOPM 内核参数用于控制每个 semop 系统调用可以执行的信号操作的数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SEMMNI 内核参数用于控制整个 Linux 系统中信号集的最大数量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里套用Oracle 11gR2的最小要求值</span></span><br><span class="line">kernel.sem = 250 32000 100 128</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据接收窗口（字节）</span></span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大的TCP数据发送窗口（字节）</span></span><br><span class="line">net.core.wmem_max = 4194304</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据接收窗口大小（字节）</span></span><br><span class="line">net.core.rmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认的TCP数据发送窗口大小（字节）</span></span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置主动发起连接时，端口范围，默认值32768-60000</span></span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65535</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统pagecache脏页达到系统内存dirty_ratio的百分比值时，会阻塞新的写请求</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 直到内存脏页落盘</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为30</span></span><br><span class="line">vm.dirty_ratio = 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="limits参数"><a href="#limits参数" class="headerlink" title="limits参数"></a>limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-pgsql.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 655360</span><br><span class="line">* soft nproc 655360</span><br><span class="line">* hard nproc 655360</span><br><span class="line">* soft stack unlimited</span><br><span class="line">* hard stack unlimited</span><br><span class="line">* soft   memlock    250000000</span><br><span class="line">* hard   memlock    250000000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="准备数据盘"><a href="#准备数据盘" class="headerlink" title="准备数据盘"></a>准备数据盘</h2><h3 id="确认数据盘"><a href="#确认数据盘" class="headerlink" title="确认数据盘"></a>确认数据盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lsblk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  20G  0 disk</span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  19G  0 part /</span><br><span class="line">sdb      8:16   0  30G  0 disk</span><br></pre></td></tr></table></figure><h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>使用<code>fdisk /dev/sdb</code>格式化硬盘，默认已做4K对齐</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/sdb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain in memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write command.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0xa5fd5a2b.</span><br><span class="line"></span><br><span class="line">Command (m for help): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 32.2 GB, 32212254720 bytes, 62914560 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0xa5fd5a2b</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line"></span><br><span class="line">Command (m for help): n</span><br><span class="line">Partition type:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (1-4, default 1): 1</span><br><span class="line">First sector (2048-62914559, default 2048):</span><br><span class="line">Using default value 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-62914559, default 62914559):</span><br><span class="line">Using default value 62914559</span><br><span class="line">Partition 1 of type Linux and of size 30 GiB is set</span><br><span class="line"></span><br><span class="line">Command (m for help): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 32.2 GB, 32212254720 bytes, 62914560 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0xa5fd5a2b</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sdb1            2048    62914559    31456256   83  Linux</span><br><span class="line"></span><br><span class="line">Command (m for help): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lsblk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  20G  0 disk</span><br><span class="line">├─sda1   8:1    0   1G  0 part /boot</span><br><span class="line">└─sda2   8:2    0  19G  0 part /</span><br><span class="line">sdb      8:16   0  30G  0 disk</span><br><span class="line">└─sdb1   8:17   0  30G  0 part</span><br></pre></td></tr></table></figure><h3 id="格式化分区"><a href="#格式化分区" class="headerlink" title="格式化分区"></a>格式化分区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs -f -b size=4096 /dev/sdb1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">meta-data=/dev/sdb1              isize=512    agcount=4, agsize=1966016 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0, sparse=0</span><br><span class="line">data     =                       bsize=4096   blocks=7864064, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line">log      =internal log           bsize=4096   blocks=3839, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure><h3 id="创建数据目录"><a href="#创建数据目录" class="headerlink" title="创建数据目录"></a>创建数据目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data</span><br></pre></td></tr></table></figure><h3 id="挂载数据盘"><a href="#挂载数据盘" class="headerlink" title="挂载数据盘"></a>挂载数据盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t xfs -o nolargeio,noatime,nodiratime /dev/sdb1 /data</span><br></pre></td></tr></table></figure><h3 id="修改-etc-fstab"><a href="#修改-etc-fstab" class="headerlink" title="修改/etc/fstab"></a>修改/etc/fstab</h3><p>追加一行记录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1 /data xfs nolargeio,noatime,nodiratime 0 0</span><br></pre></td></tr></table></figure><h1 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h1><h2 id="准备YUM源"><a href="#准备YUM源" class="headerlink" title="准备YUM源"></a>准备YUM源</h2><p><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">社区配置YUM源的文档</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br></pre></td></tr></table></figure><blockquote><p>由于默认的源服务器地址在国外，修改为国内镜像地址可以改善下载速度</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br></pre></td></tr></table></figure><blockquote><p>默认源服务器地址是PostgreSQL社区的服务器，这里替换成清华大学的镜像源地址</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,download.postgresql.org/pub,mirrors4.tuna.tsinghua.edu.cn/postgresql,g' -i /etc/yum.repos.d/pgdg-redhat-all.repo</span><br></pre></td></tr></table></figure><h2 id="安装PostgreSQL10"><a href="#安装PostgreSQL10" class="headerlink" title="安装PostgreSQL10"></a>安装PostgreSQL10</h2><blockquote><font color="red">必装</font></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgresql10 postgresql10-server</span><br></pre></td></tr></table></figure><blockquote><p>选装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y postgresql10-contrib postgresql10-test</span><br></pre></td></tr></table></figure><blockquote><p>PostgreSQL也有基于WebUI的图形管理工具<code>pgAdmin</code>，具体怎么用，自己看<a href="https://www.pgadmin.org/docs/pgadmin4/4.x/" target="_blank" rel="noopener">文档</a></p><p>windows版的看<a href="https://www.pgadmin.org/download/pgadmin-4-windows/" target="_blank" rel="noopener">这里</a></p><p>容器化部署看<a href="https://www.pgadmin.org/docs/pgadmin4/4.x/container_deployment.html" target="_blank" rel="noopener">这里</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pgadmin4</span><br></pre></td></tr></table></figure><h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><ul><li>使用默认数据目录</li></ul><blockquote><p>默认数据目录在<code>/var/lib/pgsql/10/data</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/pgsql-10/bin/postgresql-10-setup initdb</span><br></pre></td></tr></table></figure><ul><li>使用自定义数据目录</li></ul><blockquote><p>这里自定义数据目录为<code>/data</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改数据目录权限</span></span><br><span class="line">chown -R postgres:postgres /data</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改服务启动脚本的数据目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务脚本默认的Environment=PGDATA=/var/lib/pgsql/10/data</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不改这个会导致服务启动失败</span></span><br><span class="line">sed -e 's,^Environment=PGDATA=.*,Environment=PGDATA=/data,' -i /usr/lib/systemd/system/postgresql-10.service</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到postgres用户</span></span><br><span class="line">su - postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改默认PGDATA环境变量</span></span><br><span class="line">sed -e 's,^PGDATA.*,PGDATA=/data,' -i ~/.bash_profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用变量</span></span><br><span class="line">source ~/.bash_profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化数据库</span></span><br><span class="line">/usr/pgsql-10/bin/initdb --encoding=UTF-8  \</span><br><span class="line">                         --local=en_US.UTF8 \</span><br><span class="line">                         --username=postgres \</span><br><span class="line">                         --pwprompt \</span><br><span class="line">                         --pgdata=$PGDATA \</span><br><span class="line">                         --data-checksums</span><br></pre></td></tr></table></figure><h2 id="启动PostgreSQL"><a href="#启动PostgreSQL" class="headerlink" title="启动PostgreSQL"></a>启动PostgreSQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable postgresql-10.service</span><br><span class="line">systemctl start postgresql-10.service</span><br></pre></td></tr></table></figure><h2 id="验证数据库"><a href="#验证数据库" class="headerlink" title="验证数据库"></a>验证数据库</h2><h3 id="查看数据库进程"><a href="#查看数据库进程" class="headerlink" title="查看数据库进程"></a>查看数据库进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">postgres  13558      1  0 13:25 ?        00:00:00 /usr/pgsql-10/bin/postmaster -D /data</span><br><span class="line">postgres  13560  13558  0 13:25 ?        00:00:00 postgres: logger process</span><br><span class="line">postgres  13562  13558  0 13:25 ?        00:00:00 postgres: checkpointer process</span><br><span class="line">postgres  13563  13558  0 13:25 ?        00:00:00 postgres: writer process</span><br><span class="line">postgres  13564  13558  0 13:25 ?        00:00:00 postgres: wal writer process</span><br><span class="line">postgres  13565  13558  0 13:25 ?        00:00:00 postgres: autovacuum launcher process</span><br><span class="line">postgres  13566  13558  0 13:25 ?        00:00:00 postgres: stats collector process</span><br><span class="line">postgres  13567  13558  0 13:25 ?        00:00:00 postgres: bgworker: logical replication launcher</span><br></pre></td></tr></table></figure><h3 id="查看数据库监听端口"><a href="#查看数据库监听端口" class="headerlink" title="查看数据库监听端口"></a>查看数据库监听端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netstat -antupl | grep 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      13558/postmaster</span><br><span class="line">tcp6       0      0 ::1:5432                :::*                    LISTEN      13558/postmaster</span><br></pre></td></tr></table></figure><h3 id="切换用户"><a href="#切换用户" class="headerlink" title="切换用户"></a>切换用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><h3 id="登录数据库"><a href="#登录数据库" class="headerlink" title="登录数据库"></a>登录数据库</h3><blockquote><p>在postgres用户下可以直接免密码登录到数据库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure><h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># \conninfo</span></span><br><span class="line">You are connected to database "postgres" as user "postgres" via socket in "/var/run/postgresql" at port "5432".</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># \l</span></span><br><span class="line">                                 List of databases</span><br><span class="line">   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges</span><br><span class="line"><span class="comment">-----------+----------+----------+------------+------------+-----------------------</span></span><br><span class="line"> postgres  | postgres | UTF8     | zh_CN.UTF8 | zh_CN.UTF8 |</span><br><span class="line"> template0 | postgres | UTF8     | zh_CN.UTF8 | zh_CN.UTF8 | =c/postgres          +</span><br><span class="line">           |          |          |            |            | postgres=CTc/postgres</span><br><span class="line"> template1 | postgres | UTF8     | zh_CN.UTF8 | zh_CN.UTF8 | =c/postgres          +</span><br><span class="line">           |          |          |            |            | postgres=CTc/postgres</span><br><span class="line">(3 rows)</span><br></pre></td></tr></table></figure><h1 id="配置PostgreSQL数据库"><a href="#配置PostgreSQL数据库" class="headerlink" title="配置PostgreSQL数据库"></a>配置PostgreSQL数据库</h1><h2 id="配置文件路径"><a href="#配置文件路径" class="headerlink" title="配置文件路径"></a>配置文件路径</h2><p>配置文件是放在数据目录，懒得记路径可以这么做</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">cd $PGDATA</span><br><span class="line">ls</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">base              pg_dynshmem    pg_notify     pg_stat_tmp  pg_wal                postmaster.pid</span><br><span class="line">current_logfiles  pg_hba.conf    pg_replslot   pg_subtrans  pg_xact</span><br><span class="line">global            pg_ident.conf  pg_serial     pg_tblspc    postgresql.auto.conf</span><br><span class="line">log               pg_logical     pg_snapshots  pg_twophase  postgresql.conf</span><br><span class="line">pg_commit_ts      pg_multixact   pg_stat       PG_VERSION   postmaster.opts</span><br></pre></td></tr></table></figure><h2 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h2><h3 id="postgresql-conf"><a href="#postgresql-conf" class="headerlink" title="postgresql.conf"></a>postgresql.conf</h3><blockquote><p>数据库服务的配置文件</p><p>默认配置文件条目非常多，可以根据注释来配置对应选项</p><p>也可以查看<a href="https://github.com/postgres/postgres/blob/REL_10_8/src/backend/utils/misc/postgresql.conf.sample" target="_blank" rel="noopener">在线版本</a></p><p>这里简单做一下配置</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PostgreSQL configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file consists of lines of the form:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   name = value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (The <span class="string">"="</span> is optional.)  Whitespace may be used.  Comments are introduced with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"#"</span> anywhere on a line.  The complete list of parameter names and allowed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> values can be found <span class="keyword">in</span> the PostgreSQL documentation.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The commented-out settings shown <span class="keyword">in</span> this file represent the default values.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Re-commenting a setting is NOT sufficient to revert it to the default value;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you need to reload the server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file is <span class="built_in">read</span> on server startup and when the server receives a SIGHUP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> signal.  If you edit the file on a running system, you have to SIGHUP the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server <span class="keyword">for</span> the changes to take effect, run <span class="string">"pg_ctl reload"</span>, or execute</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"SELECT pg_reload_conf()"</span>.  Some parameters, <span class="built_in">which</span> are marked below,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> require a server shutdown and restart to take effect.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Any parameter can also be given as a <span class="built_in">command</span>-line option to the server, e.g.,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"postgres -c log_connections=on"</span>.  Some parameters can be changed at run time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with the <span class="string">"SET"</span> SQL <span class="built_in">command</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Memory units:  kB = kilobytes        Time units:  ms  = milliseconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                MB = megabytes                     s   = seconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                GB = gigabytes                     min = minutes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                TB = terabytes                     h   = hours</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                                                   d   = days</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FILE LOCATIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">data_directory = <span class="string">'ConfigDir'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">hba_file = <span class="string">'ConfigDir/pg_hba.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ident_file = <span class="string">'ConfigDir/pg_ident.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">external_pid_file = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONNECTIONS AND AUTHENTICATION</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Connection Settings -</span></span><br><span class="line">listen_addresses = '*'</span><br><span class="line">port = 5432</span><br><span class="line"><span class="meta">#</span><span class="bash"> max_connections默认是100</span></span><br><span class="line">max_connections = 500</span><br><span class="line">superuser_reserved_connections = 3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - TCP settings -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为0，即使用系统默认值</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_idle = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_interval = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_keepalives_count = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tcp_user_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Authentication -</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 认证超时时间，默认1min</span></span><br><span class="line">authentication_timeout = 30s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码加密算法，默认md5</span></span><br><span class="line">password_encryption = md5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GSSAPI using Kerberos</span></span><br><span class="line"><span class="meta">#</span><span class="bash">krb_server_keyfile = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">krb_caseins_users = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - SSL -</span></span><br><span class="line">ssl = off</span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ca_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_cert_file = <span class="string">'server.crt'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_crl_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_key_file = <span class="string">'server.key'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ciphers = <span class="string">'HIGH:MEDIUM:+3DES:!aNULL'</span> <span class="comment"># allowed SSL ciphers</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_prefer_server_ciphers = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_ecdh_curve = <span class="string">'prime256v1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_min_protocol_version = <span class="string">'TLSv1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_max_protocol_version = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_dh_params_file = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_passphrase_command = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ssl_passphrase_command_supports_reload = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RESOURCE USAGE (except WAL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Memory -</span></span><br><span class="line">shared_buffers = 128MB</span><br><span class="line"><span class="meta">#</span><span class="bash">huge_pages = try</span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_buffers = 8MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_prepared_transactions = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">work_mem = 4MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maintenance_work_mem = 64MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_work_mem = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_stack_depth = 2MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">shared_memory_type = mmap</span></span><br><span class="line">dynamic_shared_memory_type = posix</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Disk -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_file_limit = -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Kernel Resources -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_files_per_process = 1000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">shared_preload_libraries = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Cost-Based Vacuum Delay -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_delay = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_hit = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_miss = 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_page_dirty = 20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_cost_limit = 200</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Background Writer -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_delay = 200ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_lru_maxpages = 100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_lru_multiplier = 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bgwriter_flush_after = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Asynchronous Behavior -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">effective_io_concurrency = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_worker_processes = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_maintenance_workers = 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_workers_per_gather = 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_leader_participation = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_parallel_workers = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">old_snapshot_threshold = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">backend_flush_after = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WRITE AHEAD LOG</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Settings -</span></span><br><span class="line">wal_level = replica</span><br><span class="line">fsync = on</span><br><span class="line">synchronous_commit = on</span><br><span class="line">wal_sync_method = fdatasync</span><br><span class="line"><span class="meta">#</span><span class="bash">full_page_writes = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_compression = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如需要用pg_rewind修复WAL的timeline, 需要打开wal_log_hints</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 但是开启它会导致写wal变多, 请斟酌</span></span><br><span class="line">wal_log_hints = off</span><br><span class="line"><span class="meta">#</span><span class="bash">wal_init_zero = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_recycle = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_buffers = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_writer_delay = 200ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_writer_flush_after = 1MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">commit_delay = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">commit_siblings = 5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Checkpoints -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_timeout = 5min</span></span><br><span class="line">max_wal_size = 1GB</span><br><span class="line">min_wal_size = 80MB</span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_completion_target = 0.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_flush_after = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">checkpoint_warning = 30s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Archiving -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_mode = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_command = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">archive_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> REPLICATION</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Sending Server(s) -</span></span><br><span class="line">max_wal_senders = 10</span><br><span class="line"><span class="meta">#</span><span class="bash"> wal_keep_segments可以设置大一点，每个segments大小16MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样在备库不会因为wal receiver启动太慢导致所需wal在主库被删除</span></span><br><span class="line">wal_sender_timeout = 60s</span><br><span class="line"><span class="meta">#</span><span class="bash">max_replication_slots = 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">track_commit_timestamp = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Master Server -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">synchronous_standby_names = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_defer_cleanup_age = 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Standby Servers -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hot_standby = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_standby_archive_delay = 30s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_standby_streaming_delay = 30s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_receiver_status_interval = 10s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hot_standby_feedback = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_receiver_timeout = 60ss</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wal_retrieve_retry_interval = 5s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Subscribers -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_logical_replication_workers = 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_sync_workers_per_subscription = 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> QUERY TUNING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Planner Method Configuration -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_bitmapscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_hashagg = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_hashjoin = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_indexscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_indexonlyscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_material = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_mergejoin = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_nestloop = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_seqscan = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_sort = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">enable_tidscan = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Planner Cost Constants -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">seq_page_cost = 1.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">random_page_cost = 4.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_tuple_cost = 0.01</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_index_tuple_cost = 0.005</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cpu_operator_cost = 0.0025</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_tuple_cost = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">parallel_setup_cost = 1000.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">min_parallel_table_scan_size = 8MB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">min_parallel_index_scan_size = 512kB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">effective_cache_size = 4GB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Genetic Query Optimizer -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_threshold = 12</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_effort = 5</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_pool_size = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_generations = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_selection_bias = 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">geqo_seed = 0.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Planner Options -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_statistics_target = 100</span></span><br><span class="line"><span class="meta">#</span><span class="bash">constraint_exclusion = partition</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cursor_tuple_fraction = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">from_collapse_limit = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">join_collapse_limit = 8</span></span><br><span class="line"><span class="meta">#</span><span class="bash">force_parallel_mode = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ERROR REPORTING AND LOGGING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Where to Log -</span></span><br><span class="line">log_destination = 'stderr'</span><br><span class="line">logging_collector = on</span><br><span class="line">log_directory = 'log'</span><br><span class="line">log_filename = 'postgresql-%Y%m%d.log'</span><br><span class="line"><span class="meta">#</span><span class="bash">log_file_mode = 0600</span></span><br><span class="line">log_truncate_on_rotation = off</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line">log_rotation_size = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> These are relevant when logging to syslog:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_facility = <span class="string">'LOCAL0'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_ident = <span class="string">'postgres'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_sequence_numbers = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">syslog_split_messages = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - When to Log -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_messages = warning </span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_min_error_statement = error</span></span><br><span class="line">log_min_duration_statement = 0 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - What to Log -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_parse = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_rewritten = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_print_plan = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">debug_pretty_print = on</span></span><br><span class="line">log_checkpoints = on </span><br><span class="line">log_connections = on </span><br><span class="line">log_disconnections = on </span><br><span class="line">log_duration = on </span><br><span class="line">log_error_verbosity = verbose</span><br><span class="line"><span class="meta">#</span><span class="bash">log_hostname = off</span></span><br><span class="line">log_line_prefix = '%m [%p]: user=%u,db=%d '</span><br><span class="line">log_lock_waits = on</span><br><span class="line"><span class="meta">#</span><span class="bash">log_statement = <span class="string">'none'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_replication_commands = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_temp_files = -1</span></span><br><span class="line">log_timezone = 'PRC'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Process Title -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cluster_name = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">update_process_title = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RUNTIME STATISTICS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Query/Index Statistics Collector -</span></span><br><span class="line">track_activities = on</span><br><span class="line">track_counts = on</span><br><span class="line">track_io_timing = on</span><br><span class="line">track_functions = none</span><br><span class="line">track_activity_query_size = 1024</span><br><span class="line">stats_temp_directory = 'pg_stat_tmp'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Statistics Monitoring -</span></span><br><span class="line">log_parser_stats = on</span><br><span class="line">log_planner_stats = on</span><br><span class="line">log_executor_stats = on</span><br><span class="line">log_statement_stats = off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AUTOVACUUM PARAMETERS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_autovacuum_min_duration = -1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_max_workers = 3</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_naptime = 1min</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_threshold = 50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_analyze_threshold = 50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_scale_factor = 0.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_analyze_scale_factor = 0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_freeze_max_age = 200000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_multixact_freeze_max_age = 400000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_cost_delay = 20ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autovacuum_vacuum_cost_limit = -1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CLIENT CONNECTION DEFAULTS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Statement Behavior -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_min_messages = notice</span></span><br><span class="line"><span class="meta">#</span><span class="bash">search_path = <span class="string">'"$user", public'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_tablespace = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">temp_tablespaces = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">check_function_bodies = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_isolation = <span class="string">'read committed'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_read_only = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_transaction_deferrable = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">session_replication_role = <span class="string">'origin'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">statement_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lock_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">idle_in_transaction_session_timeout = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_freeze_min_age = 50000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_freeze_table_age = 150000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_multixact_freeze_min_age = 5000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vacuum_multixact_freeze_table_age = 150000000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bytea_output = <span class="string">'hex'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">xmlbinary = <span class="string">'base64'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">xmloption = <span class="string">'content'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">gin_fuzzy_search_limit = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gin_pending_list_limit = 4MB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Locale and Formatting -</span></span><br><span class="line">datestyle = 'iso, ymd'</span><br><span class="line"><span class="meta">#</span><span class="bash">intervalstyle = <span class="string">'postgres'</span></span></span><br><span class="line">timezone = 'PRC'</span><br><span class="line"><span class="meta">#</span><span class="bash">timezone_abbreviations = <span class="string">'Default'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">extra_float_digits = 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client_encoding = sql_ascii</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> These settings are initialized by initdb, but they can be changed.</span></span><br><span class="line">lc_messages = 'en_US.UTF-8'# locale for system error message strings</span><br><span class="line">lc_monetary = 'en_US.UTF-8'# locale for monetary formatting</span><br><span class="line">lc_numeric = 'en_US.UTF-8'# locale for number formatting</span><br><span class="line">lc_time = 'en_US.UTF-8'# locale for time formatting</span><br><span class="line"><span class="meta">#</span><span class="bash"> default configuration <span class="keyword">for</span> text search</span></span><br><span class="line">default_text_search_config = 'pg_catalog.english'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Defaults -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dynamic_library_path = <span class="string">'$libdir'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_preload_libraries = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">session_preload_libraries = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LOCK MANAGEMENT</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">deadlock_timeout = 1s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_locks_per_transaction = 64</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_transaction = 64</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_relation = -2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max_pred_locks_per_page = 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> VERSION/PLATFORM COMPATIBILITY</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Previous PostgreSQL Versions -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">array_nulls = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">backslash_quote = safe_encoding</span></span><br><span class="line"><span class="meta">#</span><span class="bash">default_with_oids = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">escape_string_warning = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lo_compat_privileges = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">operator_precedence_warning = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">quote_all_identifiers = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">standard_conforming_strings = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">synchronize_seqscans = on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> - Other Platforms and Clients -</span></span><br><span class="line"><span class="meta">#</span><span class="bash">transform_null_equals = off</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ERROR HANDLING</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">exit_on_error = off</span></span><br><span class="line"><span class="meta">#</span><span class="bash">restart_after_crash = on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">data_sync_retry = off</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG FILE INCLUDES</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">include_dir = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">include_if_exists = <span class="string">''</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">include = <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CUSTOMIZED OPTIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Add settings <span class="keyword">for</span> extensions here</span></span><br></pre></td></tr></table></figure><h3 id="pg-hba-conf"><a href="#pg-hba-conf" class="headerlink" title="pg_hba.conf"></a>pg_hba.conf</h3><blockquote><p>基于主机认证的配置文件</p><p>默认的配置文件好多注释，看着不方便</p><p>简化之后如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认配置数据库主机以socket、127.0.0.1、::1的方式连接数据库可以跳过认证阶段直接登录数据库</span></span><br><span class="line">local   all             all                                     trust</span><br><span class="line">host    all             all             127.0.0.1/32            trust</span><br><span class="line">host    all             all             ::1/128                 trust</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置app_user可以基于用户名密码+MD5加密算法从0.0.0.0/0访问数据库服务，并且是能访问所有databases</span></span><br><span class="line">host    all             all             0.0.0.0/0               md5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置app_user可以基于用户名密码+MD5加密算法从*.exmpale.com访问数据库服务，只能访问app_db1和app_db2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">host    app_db1,app_db2 app_user        .exmpale.com            md5</span></span><br></pre></td></tr></table></figure><p>pg_hba.conf的配置选项非常多，更详细的资料可以查看配置文件自带的注释或者查看pgsql中文社区PostgreSQL10的中文版手册，<a href="http://www.postgres.cn/docs/10/auth-pg-hba-conf.html" target="_blank" rel="noopener">链接在这</a></p><h2 id="激活数据库配置"><a href="#激活数据库配置" class="headerlink" title="激活数据库配置"></a>激活数据库配置</h2><ul><li>注释里没提及<code>change requires restart</code>，可以通过reload的方式加载配置</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">/usr/pgsql-10/bin/pg_ctl reload -D $PGDATA</span><br></pre></td></tr></table></figure><ul><li>注释里明确列明了<code>change requires restart</code>，只能restart的方式重启数据库才能生效</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgresql</span><br><span class="line">/usr/pgsql-10/bin/pg_ctl restart -D $PGDATA</span><br></pre></td></tr></table></figure><h1 id="PostgreSQL日志"><a href="#PostgreSQL日志" class="headerlink" title="PostgreSQL日志"></a>PostgreSQL日志</h1><h2 id="日志路径"><a href="#日志路径" class="headerlink" title="日志路径"></a>日志路径</h2><h3 id="默认路径"><a href="#默认路径" class="headerlink" title="默认路径"></a>默认路径</h3><p>在数据目录的log目录里面，<code>%PGDATA/log</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%a.log'</span><br></pre></td></tr></table></figure><p>其中<code>%a</code>是指星期几的缩写作为标识，例如<code>postgresql-Mon.log</code>、<code>postgresql-Tue.log</code></p><h3 id="自定义文件名"><a href="#自定义文件名" class="headerlink" title="自定义文件名"></a>自定义文件名</h3><p>postgresql.conf里面的参数控制日志的文件名</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%Y%m%d.log'</span><br></pre></td></tr></table></figure><h2 id="日志轮转"><a href="#日志轮转" class="headerlink" title="日志轮转"></a>日志轮转</h2><p>在<code>postgresql.conf</code>可以定义这些参数</p><ul><li>每天生成一个日志文件</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%Y%m%d.log'</span><br><span class="line">log_truncate_on_rotation = off</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line">log_rotation_size = 0</span><br></pre></td></tr></table></figure><ul><li>每天一个日志文件，只保留7天日志，循环覆盖之前的日志</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_filename = 'postgresql-%a.log'</span><br><span class="line">log_truncate_on_rotation = on</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line">log_rotation_size = 0</span><br></pre></td></tr></table></figure><h1 id="增加PATH变量"><a href="#增加PATH变量" class="headerlink" title="增加PATH变量"></a>增加PATH变量</h1><blockquote><p>切换到postgres用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure><blockquote><p>修改<code>~/.bash_profile</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PGHOME='/usr/pgsql-10'</span><br><span class="line">export PATH=$&#123;PGHOME&#125;/bin:$&#123;PATH&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;仅记录安装部署和初始化过程&lt;/li&gt;&lt;li&gt;操作系统使用的&lt;code&gt;CentOS-7.6.1810 x86_64&lt;/code&gt;&lt;
      
    
    </summary>
    
    
      <category term="PostgreSQL" scheme="https://luanlengli.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus搭建简单的监控告警系统</title>
    <link href="https://luanlengli.github.io/2019/05/01/Prometheus%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E7%B3%BB%E7%BB%9F.html"/>
    <id>https://luanlengli.github.io/2019/05/01/Prometheus搭建简单的监控告警系统.html</id>
    <published>2019-05-01T02:26:45.000Z</published>
    <updated>2019-06-01T07:13:06.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>使用的操作系统为CentOS 7.6.1810，其他系统请自己根据差异做对应调整</p><p>仅用于记录部署过程</p><p>告警通知对接了邮件和钉钉机器人</p></blockquote><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote><p>在监控告警系统主机上安装prometheus、alertmanager和grafana</p><p>被监控的主机安装各种各样的exporter，每个exporter只监控自身的服务状态</p></blockquote><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus配置目录</span></span><br><span class="line">mkdir -p /etc/prometheus /etc/prometheus/rules.d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus用户</span></span><br><span class="line">useradd prometheus</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改属主属组</span></span><br><span class="line">chown -R prometheus:prometheus /etc/prometheus</span><br></pre></td></tr></table></figure><h2 id="软件包"><a href="#软件包" class="headerlink" title="软件包"></a>软件包</h2><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><p><a href="https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz" target="_blank" rel="noopener">prometheus-v2.9.2</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz | tar xz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir -p /var/lib/prometheus</span><br><span class="line">chwon -R prometheus:prometheus /var/lib/prometheus</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件到对应位置</span></span><br><span class="line">cd prometheus-2.9.2.linux-amd64</span><br><span class="line">chown -R prometheus:prometheus prometheus promtool console_libraries consoles prometheus.yml</span><br><span class="line">mv prometheus promtool /usr/local/bin/</span><br><span class="line">mv console_libraries consoles prometheus.yml /etc/prometheus/</span><br></pre></td></tr></table></figure><h3 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h3><p><a href="https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz" target="_blank" rel="noopener">alertmanager-v0.17.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz | tar xz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir -p /var/lib/prometheus</span><br><span class="line">chwon -R prometheus:prometheus /var/lib/prometheus</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">cd alertmanager-0.17.0.linux-amd64</span><br><span class="line">chown -R prometheus:prometheus alertmanager alertmanager.yml amtool</span><br><span class="line">mv alertmanager amtool /usr/local/bin/</span><br><span class="line">mv alertmanager.yml /etc/prometheus</span><br></pre></td></tr></table></figure><h3 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h3><p><a href="https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz" target="_blank" rel="noopener">node_exporter-v0.18.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd node_exporter-0.18.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus node_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv node_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter"><a href="#mysqld-exporter" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p><a href="https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz" target="_blank" rel="noopener">mysqld_exporter-v0.11.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd mysqld_exporter-0.11.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus mysqld_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv mysqld_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter"><a href="#postgresql-exporter" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/wrouesnel/postgres_exporter/releases/download/v0.4.7/postgres_exporter_v0.4.7_linux-amd64.tar.gz | tar xz</span><br><span class="line">cd postgres_exporter_v0.4.7_linux-amd64</span><br><span class="line">chown prometheus:prometheus postgres_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv postgres_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p><a href="https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz" target="_blank" rel="noopener">blackbox_exporter-v0.14.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd blackbox_exporter-0.14.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus blackbox_exporter blackbox.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv blackbox_exporter /usr/local/bin/</span><br><span class="line">mv blackbox.yml /etc/prometheus/</span><br></pre></td></tr></table></figure><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><p><a href="https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm" target="_blank" rel="noopener">grafana-v6.1.6</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line">wget https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm</span><br><span class="line">yum localinstall grafana-6.1.6-1.x86_64.rpm</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><p>/etc/prometheus/prometheus.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line"><span class="attr">  - static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span></span><br><span class="line"><span class="attr">      - localhost:</span><span class="number">9093</span></span><br><span class="line"><span class="attr">    scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules.d/*.rules</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9090</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9100</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">mysqld-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9104</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">postgresql-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9187</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/host-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">host-status-rule</span></span><br><span class="line"><span class="attr">    rules:</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemSpaceUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">(node_filesystem_avail_bytes&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;)</span> <span class="string">)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 85</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统空间使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统空间使用率超过 85% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemInodeUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">(node_filesystem_files_free&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_files&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;)</span> <span class="string">)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统inode使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统inode使用率超过 80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemReadOnly</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">node_filesystem_readonly&#123;job="node-exporter",device!~'rootfs'&#125;</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统只读状态"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统只读状态"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeMemoryUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(node_memory_MemTotal</span> <span class="bullet">-</span> <span class="string">(node_memory_MemFree+node_memory_Buffers+node_memory_Cached</span> <span class="string">))</span> <span class="string">/</span> <span class="string">node_memory_MemTotal</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 内存使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 内存使用率过高超过80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeCPUUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode='idle',job="node-exporter"&#125;[1m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">))</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: CPU使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: CPU使用率超过80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/mysql-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">MySQLStatsAlert</span></span><br><span class="line"><span class="attr">    rules:</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">MySQL</span> <span class="string">is</span> <span class="string">down</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> MySQL is down"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"MySQL database is down. This requires immediate action!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">open</span> <span class="string">files</span> <span class="string">high</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_innodb_num_open_files</span> <span class="string">&gt; (mysql_global_variables_open_files_limit) * 0.75</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> open files high"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Open files is high. Please consider increasing open_files_limit."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Read</span> <span class="string">buffer</span> <span class="string">size</span> <span class="string">is</span> <span class="string">bigger</span> <span class="string">than</span> <span class="string">max.</span> <span class="string">allowed</span> <span class="string">packet</span> <span class="string">size</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_read_buffer_size</span> <span class="string">&gt; mysql_global_variables_slave_max_allowed_packet </span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Read buffer size is bigger than max. allowed packet size"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Read buffer size (read_buffer_size) is bigger than max. allowed packet size (max_allowed_packet).This can break your replication."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Sort</span> <span class="string">buffer</span> <span class="string">possibly</span> <span class="string">missconfigured</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_sort_buffer_size</span> <span class="string">&lt;256*1024</span> <span class="string">or</span> <span class="string">mysql_global_variables_read_buffer_size</span> <span class="string">&gt; 4*1024*1024 </span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Sort buffer possibly missconfigured"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Sort buffer size is either too big or too small. A good value for sort_buffer_size is between 256k and 4M."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Thread</span> <span class="string">stack</span> <span class="string">size</span> <span class="string">is</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_thread_stack</span> <span class="string">&lt;196608</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Thread stack size is too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Thread stack size is too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Used</span> <span class="string">more</span> <span class="string">than</span> <span class="number">80</span><span class="string">%</span> <span class="string">of</span> <span class="string">max</span> <span class="string">connections</span> <span class="string">limited</span> </span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_max_used_connections</span> <span class="string">&gt; mysql_global_variables_max_connections * 0.8</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Used more than 80% of max connections limited"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Used more than 80% of max connections limited"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Force</span> <span class="string">Recovery</span> <span class="string">is</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_force_recovery</span> <span class="string">!=</span> <span class="number">0</span> </span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Force Recovery is enabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Force Recovery is enabled. This mode should be used for data recovery purposes only. It prohibits writing to the data."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Log</span> <span class="string">File</span> <span class="string">size</span> <span class="string">is</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_log_file_size</span> <span class="string">&lt;</span> <span class="number">16777216</span> </span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Log File size is too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"The InnoDB Log File size is possibly too small. Choosing a small InnoDB Log File size can have significant performance impacts."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Flush</span> <span class="string">Log</span> <span class="string">at</span> <span class="string">Transaction</span> <span class="string">Commit</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_flush_log_at_trx_commit</span> <span class="string">!=</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Flush Log at Transaction Commit"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Flush Log at Transaction Commit is set to a values != 1. This can lead to a loss of commited transactions in case of a power failure."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Table</span> <span class="string">definition</span> <span class="string">cache</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_open_table_definitions</span> <span class="string">&gt; mysql_global_variables_table_definition_cache</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Table definition cache too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Your Table Definition Cache is possibly too small. If it is much too small this can have significant performance impacts!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Table</span> <span class="string">open</span> <span class="string">cache</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_open_tables</span> <span class="string">&gt;mysql_global_variables_table_open_cache</span> <span class="string">*</span> <span class="number">99</span><span class="string">/100</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Table open cache too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Your Table Open Cache is possibly too small (old name Table Cache). If it is much too small this can have significant performance impacts!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Thread</span> <span class="string">stack</span> <span class="string">size</span> <span class="string">is</span> <span class="string">possibly</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_thread_stack</span> <span class="string">&lt;</span> <span class="number">262144</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Thread stack size is possibly too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Thread stack size is possibly too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Plugin</span> <span class="string">is</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_ignore_builtin_innodb</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Plugin is enabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Plugin is enabled"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binary</span> <span class="string">Log</span> <span class="string">is</span> <span class="string">disabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_log_bin</span> <span class="string">!=</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binary Log is disabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binary Log is disabled. This prohibits you to do Point in Time Recovery (PiTR)."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binlog</span> <span class="string">Cache</span> <span class="string">size</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_binlog_cache_size</span> <span class="string">&lt;</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binlog Cache size too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binlog Cache size is possibly to small. A value of 1 Mbyte or higher is OK."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binlog</span> <span class="string">Transaction</span> <span class="string">Cache</span> <span class="string">size</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_binlog_cache_size</span>  <span class="string">&lt;</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binlog Transaction Cache size too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binlog Transaction Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK."</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/postgresql-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">PostgreSQL-Status-Alert</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">########## EXPORTER RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGExporterScrapeError</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">pg_exporter_last_scrape_error</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Postgres Exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> (instance: <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>) is encountering scrape errors processing queries. Error count: ( <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> )'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">NodeExporterScrapeError</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_textfile_scrape_error</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span> </span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Node Exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> (instance: <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>) is encountering scrape errors processing custom metrics.  Error count: ( <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> )'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## POSTGRESQL RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIsUp</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">pg_up</span> <span class="string">&lt;</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'postgres_exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is unable to communicate with the configured database'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whether a system switches from primary to replica or vice versa must be configured per named job.</span></span><br><span class="line"><span class="comment"># No way to tell what value a system is supposed to be without a rule expression for that specific system</span></span><br><span class="line"><span class="comment"># 2 to 1 means it changed from primary to replica. 1 to 2 means it changed from replica to primary</span></span><br><span class="line"><span class="comment"># Set this alert for each system that you want to monitor a recovery status change</span></span><br><span class="line"><span class="comment"># Below is an example for a target job called "Replica" and watches for the value to change above 1 which means it's no longer a replica</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGRecoveryStatusSwitch_Replica </span></span><br><span class="line"><span class="comment">#    expr: ccp_is_in_recovery_status&#123;job="Replica"&#125; &gt; 1 </span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      summary: '&#123;&#123; $labels.job &#125;&#125; has changed from replica to primary'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Absence alerts must be configured per named job, otherwise there's no way to know which job is down</span></span><br><span class="line"><span class="comment"># Below is an example for a target job called "Prod"</span></span><br><span class="line"><span class="comment">#  - alert: PGConnectionAbsent</span></span><br><span class="line"><span class="comment">#    expr: absent(ccp_connection_stats_max_connections&#123;job="Prod"&#125;)</span></span><br><span class="line"><span class="comment">#    for: 10s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      description: 'Connection metric is absent from target (Prod). Check that postgres_exporter can connect to PostgreSQL.'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIdleTxn</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_idle_in_txn_time</span> <span class="string">&gt; 300</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one session idle in transaction for over 5 minutes.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance idle transactions'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIdleTxn</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_idle_in_txn_time</span> <span class="string">&gt; 900</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one session idle in transaction for over 15 minutes.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance idle transactions'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGQueryTime</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_query_time</span> <span class="string">&gt; 43200</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span> </span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one query running for over 12 hours.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Max Query Runtime'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGQueryTime</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_query_time</span> <span class="string">&gt; 86400 </span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one query running for over 1 day.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Max Query Runtime'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGConnPerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="number">100</span> <span class="string">*</span> <span class="string">(ccp_connection_stats_total</span> <span class="string">/</span> <span class="string">ccp_connection_stats_max_connections)</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is using 75% or more of available connections (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance connections'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGConnPerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="number">100</span> <span class="string">*</span> <span class="string">(ccp_connection_stats_total</span> <span class="string">/</span> <span class="string">ccp_connection_stats_max_connections)</span> <span class="string">&gt; 90 </span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is using 90% or more of available connections (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance connections'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGDBSize</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_database_size</span> <span class="string">&gt; 1.073741824e+11</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> over 100GB in size: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> bytes'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance size warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGDBSize</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_database_size</span> <span class="string">&gt; 2.68435456e+11</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> over 250GB in size: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> bytes'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance size critical'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationByteLag</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_status_byte_lag</span> <span class="string">&gt; 5.24288e+07</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one replica lagging over 50MB behind.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance replica lag warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationByteLag</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_status_byte_lag</span> <span class="string">&gt; 1.048576e+08</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one replica lagging over 100MB behind.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance replica lag warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationSlotsInactive</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_slots_active</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has one or more inactive replication slots'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance inactive replication slot'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGXIDWraparound</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_wraparound</span> <span class="string">&gt; 50</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 50% towards transaction id wraparound.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> transaction id wraparound imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGXIDWraparound</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_wraparound</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 75% towards transaction id wraparound.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance transaction id wraparound imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGEmergencyVacuum</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_emergency_autovac</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 75% towards emergency autovacuum processes beginning'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance emergency vacuum imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGEmergencyVacuum</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_emergency_autovac</span> <span class="string">&gt; 90</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 90% towards emergency autovacuum processes beginning'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance emergency vacuum imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGArchiveCommandStatus</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_archive_command_status_seconds_since_last_fail</span> <span class="string">&gt; 300</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">        severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has a recent failing archive command'</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">'Seconds since the last recorded failure of the archive_command'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGSequenceExhaustion</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_sequence_exhaustion_count</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">        severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">'Count of sequences on instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at over 75% usage: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>. Run following query to see full sequence status: SELECT * FROM monitor.sequence_status() WHERE percent &gt;= 75'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## SYSTEM RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">ExporterDown</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">avg_over_time(up[5m])</span> <span class="string">&lt;</span> <span class="number">0.9</span> </span><br><span class="line"><span class="attr">    for:</span> <span class="number">10</span><span class="string">s</span> </span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Metrics exporter service for <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> running on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has been down at least 50% of the time for the last 5 minutes. Service may be flapping or down.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Prometheus Exporter Service Down'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskUsagePerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="number">100</span> <span class="string">*</span> <span class="string">sum(node_filesystem_avail_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;)</span> <span class="string">BY</span> <span class="string">(job,device))</span> <span class="string">&gt; 70</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Disk usage on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskUsagePerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="number">100</span> <span class="string">*</span> <span class="string">sum(node_filesystem_avail_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;)</span> <span class="string">BY</span> <span class="string">(job,device))</span> <span class="string">&gt; 85</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Disk usage on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskFillPredict</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">predict_linear(node_filesystem_free_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;[1h],</span> <span class="number">4</span> <span class="string">*</span> <span class="number">3600</span><span class="string">)</span> <span class="string">&lt;</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'(EXPERIMENTAL) Disk <span class="template-variable">&#123;&#123; $labels.device &#125;&#125;</span> on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is predicted to fill in 4 hrs based on current usage'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SystemLoad5m</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_load5</span> <span class="string">&gt; 5</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'System load for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is high (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SystemLoad5m</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_load5</span> <span class="string">&gt; 10</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'System load for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is high (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">MemoryAvailable</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_Available_bytes)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes)</span> <span class="string">&lt;</span> <span class="number">25</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Memory available for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">MemoryAvailable</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_MemAvailable_bytes)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes)</span> <span class="string">&lt;</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Memory available for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SwapUsage</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_SwapFree_bytes</span> <span class="string">/</span> <span class="string">node_memory_SwapTotal_bytes)))</span> <span class="string">&gt; 60</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Swap usage for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SwapUsage</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_SwapFree_byte</span> <span class="string">/</span> <span class="string">node_memory_SwapTotal_bytes)))</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Swap usage for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## PGBACKREST RULES ##########</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Uncomment and customize one or more of these rules to monitor your pgbackrest backups. </span></span><br><span class="line"><span class="comment"># Full backups are considered the equivalent of both differentials and incrementals since both are based on the last full</span></span><br><span class="line"><span class="comment">#   And differentials are considered incrementals since incrementals will be based off the last diff if one exists</span></span><br><span class="line"><span class="comment">#   This avoid false alerts, for example when you don't run diff/incr backups on the days that you run a full</span></span><br><span class="line"><span class="comment"># Stanza should also be set if different intervals are expected for each stanza. </span></span><br><span class="line"><span class="comment">#   Otherwise rule will be applied to all stanzas returned on target system if not set.</span></span><br><span class="line"><span class="comment"># Otherwise, all backups returned by the pgbackrest info command run from where the database exists will be checked</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Relevant metric names are: </span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_full_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_incr_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_diff_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastCompletedFull_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_full_backup_time_since_completion_seconds&#123;stanza="main"&#125; &gt; 604800</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Full backup for stanza [main] on system &#123;&#123; $labels.job &#125;&#125; has not completed in the last week.'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastCompletedIncr_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_incr_backup_time_since_completion_seconds&#123;stanza="main"&#125; &gt; 86400</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Incremental backup for stanza [main] on system &#123;&#123; $labels.job &#125;&#125; has not completed in the last 24 hours.'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Runtime monitoring is handled with a single metric:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_runtime_backup_runtime_seconds</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Runtime monitoring should have the "backup_type" label set. </span></span><br><span class="line"><span class="comment">#   Otherwise the rule will apply to the last run of all backup types returned (full, diff, incr)</span></span><br><span class="line"><span class="comment"># Stanza should also be set if runtimes per stanza have different expected times</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastRuntimeFull_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_runtime_backup_runtime_seconds&#123;backup_type="full", stanza="main"&#125; &gt; 14400</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Expected runtime of full backup for stanza [main] has exceeded 4 hours'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastRuntimeDiff_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_runtime_backup_runtime_seconds&#123;backup_type="diff", stanza="main"&#125; &gt; 3600</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Expected runtime of diff backup for stanza [main] has exceeded 1 hour'</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## If the pgbackrest command fails to run, the metric disappears from the exporter output and the alert never fires. </span></span><br><span class="line"><span class="comment">## An absence alert must be configured explicitly for each target (job) that backups are being monitored.</span></span><br><span class="line"><span class="comment">## Checking for absence of just the full backup type should be sufficient (no need for diff/incr).</span></span><br><span class="line"><span class="comment">## Note that while the backrest check command failing will likely also cause a scrape error alert, the addition of this </span></span><br><span class="line"><span class="comment">## check gives a clearer answer as to what is causing it and that something is wrong with the backups.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackrestAbsentFull_Prod</span></span><br><span class="line"><span class="comment">#    expr: absent(ccp_backrest_last_full_backup_time_since_completion_seconds&#123;job="Prod"&#125;)</span></span><br><span class="line"><span class="comment">#    for: 10s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      description: 'Backup Full status missing for Prod. Check that pgbackrest info command is working on target system.'</span></span><br></pre></td></tr></table></figure><h3 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h3><p>/etc/prometheus/alertmanager.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  resolve_timeout:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">  http_config:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  smtp_from:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">  smtp_hello:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  smtp_smarthost:</span> <span class="string">smtp.example.com:465</span></span><br><span class="line"><span class="attr">  smtp_auth_username:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">  smtp_auth_password:</span> <span class="string">'这里写密码'</span></span><br><span class="line"><span class="attr">  smtp_require_tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  pagerduty_url:</span> <span class="attr">https://events.pagerduty.com/v2/enqueue</span></span><br><span class="line"><span class="attr">  hipchat_api_url:</span> <span class="attr">https://api.hipchat.com/</span></span><br><span class="line"><span class="attr">  opsgenie_api_url:</span> <span class="attr">https://api.opsgenie.com/</span></span><br><span class="line"><span class="attr">  wechat_api_url:</span> <span class="attr">https://qyapi.weixin.qq.com/cgi-bin/</span></span><br><span class="line"><span class="attr">  victorops_api_url:</span> <span class="attr">https://alert.victorops.com/integrations/generic/20131114/alert/</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="comment"># 这里配置默认路由到'default-receiver'</span></span><br><span class="line"><span class="attr">  receiver:</span> <span class="string">default-receiver</span></span><br><span class="line"><span class="attr">  group_by:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertname</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cluster</span></span><br><span class="line"><span class="attr">  group_wait:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  group_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  repeat_interval:</span> <span class="number">1</span><span class="string">h</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line"><span class="attr">- source_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">  target_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">  equal:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertname</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">dev</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">instance</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">default-receiver</span></span><br><span class="line"><span class="attr">  email_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    to:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    from:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    hello:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    smarthost:</span> <span class="string">smtp.example.com:465</span></span><br><span class="line"><span class="attr">    auth_username:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    auth_password:</span> <span class="string">'这里写密码'</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="attr">      From:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">      Subject:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "email.default.subject" . &#125;&#125;</span>'</span></span><br><span class="line"><span class="attr">      To:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    html:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "email.default.html" . &#125;&#125;</span>'</span></span><br><span class="line"><span class="attr">    require_tls:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 配置钉钉机器人</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">http://localhost:8060/dingtalk/webhook001/send</span></span><br><span class="line"><span class="comment"># 配置钉钉机器人</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">dingtalk002</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">http://localhost:8060/dingtalk/webhook002/send</span></span><br><span class="line"><span class="attr">templates:</span> <span class="string">[]</span></span><br></pre></td></tr></table></figure><p>配置dingtalk webhook程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 这里偷懒用docker跑钉钉的webhook</span></span><br><span class="line">docker run -d \</span><br><span class="line">           --restart=always \</span><br><span class="line">           --name prometheus-webhook-dingtalk \</span><br><span class="line">           -p 8060:8060 \</span><br><span class="line">           -v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro \</span><br><span class="line">           timonwong/prometheus-webhook-dingtalk \</span><br><span class="line">           --ding.profile="webhook001=https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx" \</span><br><span class="line">           --ding.profile="webhook002=https://oapi.dingtalk.com/robot/send?access_token=yyyyyyyyyyy"</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter-1"><a href="#blackbox-exporter-1" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p>/etc/prometheus/backbox_exporter.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">没空搞，占个位</span></span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter-1"><a href="#mysqld-exporter-1" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p>需要创建用于监控的数据库用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'prometheus'</span>@<span class="string">'127.0.0.1'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'prometheus_password'</span> <span class="keyword">WITH</span> MAX_USER_CONNECTIONS <span class="number">3</span>;</span><br><span class="line"><span class="keyword">GRANT</span> PROCESS, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span>, <span class="keyword">SELECT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'prometheus'</span>@<span class="string">'127.0.0.1'</span>;</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter-1"><a href="#postgresql-exporter-1" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><p>根据需求决定是否使用superuser作为postgresql_exporter的数据库用户</p><p>如果要创建专用用户可以参照下面的方式创建用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建postgresql_exporter专用用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> postgres_exporter <span class="keyword">PASSWORD</span> <span class="string">'password'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> postgres_exporter <span class="keyword">SET</span> SEARCH_PATH <span class="keyword">TO</span> postgres_exporter,pg_catalog;</span><br><span class="line"><span class="comment"># 创建schema</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SCHEMA</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 授权schema</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">USAGE</span> <span class="keyword">ON</span> <span class="keyword">SCHEMA</span> postgres_exporter <span class="keyword">TO</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 创建函数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_pg_stat_activity() <span class="keyword">RETURNS</span> SETOF pg_stat_activity <span class="keyword">AS</span></span><br><span class="line">$$ <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_catalog.pg_stat_activity; $$</span><br><span class="line">LANGUAGE sql</span><br><span class="line">VOLATILE</span><br><span class="line">SECURITY DEFINER;</span><br><span class="line"><span class="comment"># 创建视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> postgres_exporter.pg_stat_activity</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">from</span> get_pg_stat_activity();</span><br><span class="line"><span class="comment"># 视图授权</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> postgres_exporter.pg_stat_activity <span class="keyword">TO</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 创建函数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_pg_stat_replication() <span class="keyword">RETURNS</span> SETOF pg_stat_replication <span class="keyword">AS</span></span><br><span class="line">$$ <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_catalog.pg_stat_replication; $$</span><br><span class="line">LANGUAGE sql</span><br><span class="line">VOLATILE</span><br><span class="line">SECURITY DEFINER;</span><br><span class="line"><span class="comment"># 创建视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> postgres_exporter.pg_stat_replication</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> get_pg_stat_replication();</span><br><span class="line"><span class="comment"># 视图授权</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> postgres_exporter.pg_stat_replication <span class="keyword">TO</span> postgres_exporter;</span><br></pre></td></tr></table></figure><h3 id="grafana-1"><a href="#grafana-1" class="headerlink" title="grafana"></a>grafana</h3><blockquote><font color="red">偷懒警告！</font><p>这里定义管理员用户密码，还有secret_key，记得自己改，别瞎抄作业！</p><p>生产环境不要用默认密码，不然有你哭的时候</p><p>[security]<br>admin_user = admin<br>admin_password = admin<br>secret_key = SW2YcwTIb9zpOOhoPsMm</p></blockquote><p>/etc/grafana/grafana.ini</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">app_mode</span> = production</span><br><span class="line"><span class="section">[paths]</span></span><br><span class="line"><span class="attr">data</span> = /var/lib/grafana</span><br><span class="line"><span class="attr">temp_data_lifetime</span> = <span class="number">24</span>h</span><br><span class="line"><span class="attr">logs</span> = /var/log/grafana</span><br><span class="line"><span class="attr">plugins</span> = /var/lib/grafana/plugins</span><br><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="attr">protocol</span> = http</span><br><span class="line"><span class="attr">http_port</span> = <span class="number">3000</span></span><br><span class="line"><span class="comment"># 这里的domain与下面的root_url匹配</span></span><br><span class="line"><span class="attr">domain</span> = grafana</span><br><span class="line"><span class="comment"># root_url定义浏览器怎么访问grafana</span></span><br><span class="line"><span class="comment"># http://IP_ADDRESS:3000或者http://domainname:3000</span></span><br><span class="line"><span class="attr">root_url</span> = http://grafana:<span class="number">3000</span></span><br><span class="line"><span class="attr">enable_gzip</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">log_queries</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[remote_cache]</span></span><br><span class="line"><span class="section">[session]</span></span><br><span class="line"><span class="attr">provider</span> = file</span><br><span class="line"><span class="section">[dataproxy]</span></span><br><span class="line"><span class="section">[analytics]</span></span><br><span class="line"><span class="attr">reporting_enabled</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">check_for_updates</span> = <span class="literal">false</span></span><br><span class="line"><span class="section">[security]</span></span><br><span class="line"><span class="attr">admin_user</span> = admin</span><br><span class="line"><span class="attr">admin_password</span> = admin</span><br><span class="line"><span class="attr">secret_key</span> = SW2YcwTIb9zpOOhoPsMm</span><br><span class="line"><span class="section">[snapshots]</span></span><br><span class="line"><span class="section">[dashboards]</span></span><br><span class="line"><span class="attr">versions_to_keep</span> = <span class="number">10</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">default_theme</span> = dark</span><br><span class="line"><span class="section">[auth]</span></span><br><span class="line"><span class="section">[auth.anonymous]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">org_role</span> = Viewer</span><br><span class="line"><span class="section">[auth.github]</span></span><br><span class="line"><span class="section">[auth.google]</span></span><br><span class="line"><span class="section">[auth.generic_oauth]</span></span><br><span class="line"><span class="section">[auth.grafana_com]</span></span><br><span class="line"><span class="section">[auth.proxy]</span></span><br><span class="line"><span class="section">[auth.basic]</span></span><br><span class="line"><span class="section">[auth.ldap]</span></span><br><span class="line"><span class="section">[smtp]</span></span><br><span class="line"><span class="section">[emails]</span></span><br><span class="line"><span class="section">[log]</span></span><br><span class="line"><span class="attr">mode</span> = console file</span><br><span class="line"><span class="attr">level</span> = info</span><br><span class="line"><span class="section">[log.console]</span></span><br><span class="line"><span class="section">[log.file]</span></span><br><span class="line"><span class="attr">log_rotate</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">daily_rotate</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">max_days</span> = <span class="number">7</span></span><br><span class="line"><span class="section">[log.syslog]</span></span><br><span class="line"><span class="section">[alerting]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">execute_alerts</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[explore]</span></span><br><span class="line"><span class="section">[metrics]</span></span><br><span class="line"><span class="attr">enabled</span>           = <span class="literal">true</span></span><br><span class="line"><span class="attr">interval_seconds</span>  = <span class="number">10</span></span><br><span class="line"><span class="section">[metrics.graphite]</span></span><br><span class="line"><span class="section">[tracing.jaeger]</span></span><br><span class="line"><span class="section">[grafana_com]</span></span><br><span class="line"><span class="attr">url</span> = https://grafana.com</span><br><span class="line"><span class="section">[external_image_storage]</span></span><br><span class="line"><span class="section">[external_image_storage.s3]</span></span><br><span class="line"><span class="section">[external_image_storage.webdav]</span></span><br><span class="line"><span class="section">[external_image_storage.gcs]</span></span><br><span class="line"><span class="section">[external_image_storage.azure_blob]</span></span><br><span class="line"><span class="section">[external_image_storage.local]</span></span><br><span class="line"><span class="section">[rendering]</span></span><br><span class="line"><span class="section">[enterprise]</span></span><br><span class="line"><span class="section">[panels]</span></span><br></pre></td></tr></table></figure><h2 id="systemd服务"><a href="#systemd服务" class="headerlink" title="systemd服务"></a>systemd服务</h2><h3 id="prometheus-service"><a href="#prometheus-service" class="headerlink" title="prometheus.service"></a>prometheus.service</h3><p>/usr/lib/systemd/system/prometheus.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=prometheus</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/prometheus \</span><br><span class="line">          --config.file=/etc/prometheus/prometheus.yml \</span><br><span class="line">          --storage.tsdb.path=/var/lib/prometheus \</span><br><span class="line">          --storage.tsdb.retention.time=15d \</span><br><span class="line">          --storage.tsdb.retention.size=40GB \</span><br><span class="line">          --web.console.templates=/etc/prometheus/consoles \</span><br><span class="line">          --web.console.libraries=/etc/prometheus/console_libraries</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="alertmanager-servicce"><a href="#alertmanager-servicce" class="headerlink" title="alertmanager.servicce"></a>alertmanager.servicce</h3><p>/usr/lib/systemd/system/alertmanager.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=alertmanager</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/alertmanager \</span><br><span class="line">          --config.file=/etc/prometheus/alertmanager.yml \</span><br><span class="line">          --storage.path=/var/lib/alertmanager \</span><br><span class="line">          --data.retention=120h</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="node-exporter-service"><a href="#node-exporter-service" class="headerlink" title="node_exporter.service"></a>node_exporter.service</h3><p>/usr/lib/systemd/system/node_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter-service"><a href="#blackbox-exporter-service" class="headerlink" title="blackbox_exporter.service"></a>blackbox_exporter.service</h3><p>/usr/lib/systemd/system/balckbox_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=blackbox_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/blackbox_exporter \</span><br><span class="line">          --config.file=/etc/prometheus/blackbox.yml \</span><br><span class="line">          --web.listen-address=:9115 \</span><br><span class="line">          --log.level=info          </span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter-service"><a href="#mysqld-exporter-service" class="headerlink" title="mysqld_exporter.service"></a>mysqld_exporter.service</h3><p>/usr/lib/systemd/system/mysqld_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=mysqld_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">Environment='DATA_SOURCE_NAME=prometheus:prometheus_password@tcp(127.0.0.1:3306)'</span><br><span class="line">ExecStart=/usr/local/bin/mysqld_exporter \</span><br><span class="line">          --collect.engine_innodb_status \</span><br><span class="line">          --collect.info_schema.innodb_metrics \</span><br><span class="line">          --collect.info_schema.userstats \</span><br><span class="line">          --collect.perf_schema.eventsstatements \</span><br><span class="line">          --collect.perf_schema.indexiowaits \</span><br><span class="line">          --collect.perf_schema.tableiowaits \</span><br><span class="line">          --collect.slave_status \</span><br><span class="line">          --log.level=info \</span><br><span class="line">          --web.listen-address=:9104 \</span><br><span class="line">          --web.telemetry-path=/metrics</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter-service"><a href="#postgresql-exporter-service" class="headerlink" title="postgresql_exporter.service"></a>postgresql_exporter.service</h3><p>/usr/lib/systemd/system/postgresql_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=postgresql_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">Environment=DATA_SOURCE_NAME=postgresql://postgres_exporter:password@localhost:5432/postgres?sslmode=disable</span><br><span class="line">ExecStart=/usr/local/bin/postgresql_exporter \</span><br><span class="line">          --web.listen-address=:9187 \</span><br><span class="line">          --web.telemetry-path=/metrics \</span><br><span class="line">          --log.level=info \</span><br><span class="line">          --log.format=logger:stderr</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>修改了systemd脚本之后需要reload一下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><h3 id="prometheus-1"><a href="#prometheus-1" class="headerlink" title="prometheus"></a>prometheus</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now prometheus.service</span><br></pre></td></tr></table></figure><h3 id="alertmanager-1"><a href="#alertmanager-1" class="headerlink" title="alertmanager"></a>alertmanager</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now alertmanager.service</span><br></pre></td></tr></table></figure><h3 id="node-exporter-1"><a href="#node-exporter-1" class="headerlink" title="node_exporter"></a>node_exporter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now node_exporter.service</span><br></pre></td></tr></table></figure><h3 id="grafana-2"><a href="#grafana-2" class="headerlink" title="grafana"></a>grafana</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now grafana.service</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><blockquote><p>其他服务同理，择需启动对应的服务即可</p></blockquote><h2 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h2><h3 id="prometheus-2"><a href="#prometheus-2" class="headerlink" title="prometheus"></a>prometheus</h3><p>浏览器访问<code>http://prometheus_server_ip:9090</code></p><h3 id="alertmanager-2"><a href="#alertmanager-2" class="headerlink" title="alertmanager"></a>alertmanager</h3><p>浏览器访问<code>http://prometheus_server_ip:9093</code></p><h3 id="node-exporter-2"><a href="#node-exporter-2" class="headerlink" title="node_exporter"></a>node_exporter</h3><p>浏览器访问<code>http://prometheus_server_ip:9100</code></p><h3 id="grafana-3"><a href="#grafana-3" class="headerlink" title="grafana"></a>grafana</h3><p>浏览器访问<code>http://prometheus_server_ip:3000</code></p><p>默认用户密码<code>admin</code>/<code>admin</code>，初次登录需要改密码</p><h1 id="配置grafana监控面板"><a href="#配置grafana监控面板" class="headerlink" title="配置grafana监控面板"></a>配置grafana监控面板</h1><p><a href="https://grafana.com/dashboards" target="_blank" rel="noopener">这里</a>很多作业可以抄，这里简单列举几个我用到的面板</p><blockquote><p>抄作业之前，先看看人家的说明！</p></blockquote><h2 id="node-exporter面板"><a href="#node-exporter面板" class="headerlink" title="node_exporter面板"></a>node_exporter面板</h2><p><a href="https://grafana.com/dashboards/8919" target="_blank" rel="noopener">1 Node Exporter 0.16–0.18 for Prometheus 监控展示看板</a></p><p><img src="http://img.starsl.cn/image.jpg" alt=""></p><h2 id="mysqld-exporter面板"><a href="#mysqld-exporter面板" class="headerlink" title="mysqld_exporter面板"></a>mysqld_exporter面板</h2><p><a href="https://github.com/percona/grafana-dashboards" target="_blank" rel="noopener">Percona出品的dashboard</a></p><p><img src="https://raw.githubusercontent.com/percona/grafana-dashboards/master/assets/sample2.png" alt=""></p><p><a href="https://grafana.com/dashboards/7362" target="_blank" rel="noopener">第三方人员提供的dashboard</a></p><p><img src="https://grafana.com/api/dashboards/7362/images/4691/image" alt=""></p><h2 id="postgresql-exporter面板"><a href="#postgresql-exporter面板" class="headerlink" title="postgresql_exporter面板"></a>postgresql_exporter面板</h2><p><a href="https://grafana.com/dashboards/455" target="_blank" rel="noopener">Postgres Overview</a></p><p><img src="https://grafana.com/api/dashboards/455/images/350/image" alt=""></p><h2 id="kong面板"><a href="#kong面板" class="headerlink" title="kong面板"></a>kong面板</h2><p><a href="https://grafana.com/dashboards/7424" target="_blank" rel="noopener">kong官方提供的dashboard</a></p><p><img src="https://grafana.com/api/dashboards/7424/images/5837/image" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;使用的操作系统为CentOS 7.6.1810，其他系统请自己根据差异做对应调整&lt;/p&gt;&lt;p&gt;仅用于记录部署过程&lt;/
      
    
    </summary>
    
    
      <category term="Prometheus" scheme="https://luanlengli.github.io/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>Shell处理xml文件的简单方法</title>
    <link href="https://luanlengli.github.io/2019/04/09/Shell%E5%A4%84%E7%90%86xml%E6%96%87%E4%BB%B6%E7%9A%84%E7%AE%80%E5%8D%95%E6%96%B9%E6%B3%95.html"/>
    <id>https://luanlengli.github.io/2019/04/09/Shell处理xml文件的简单方法.html</id>
    <published>2019-04-09T01:51:59.000Z</published>
    <updated>2019-04-09T10:25:55.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>工作中遇到需要使用shell命令编辑xml文件，以shell自带的命令去处理非常的不方便，于是乎找了一下处理xml的命令行工具。在此记录一下处理过程</p><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ul><li>操作系统<code>CentOS-7.x</code></li><li>软件包<code>libxml2</code>、<code>xml2</code>、<code>xmlstarlet</code></li></ul><h1 id="操作样例"><a href="#操作样例" class="headerlink" title="操作样例"></a>操作样例</h1><ul><li>准备一个xml文件，这里以<code>Apache maven</code>的<code>settings.xml</code>为例</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment">or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment">distributed with this work for additional information</span></span><br><span class="line"><span class="comment">regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment">to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment">"License"); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment">with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing,</span></span><br><span class="line"><span class="comment">software distributed under the License is distributed on an</span></span><br><span class="line"><span class="comment">"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span></span><br><span class="line"><span class="comment">KIND, either express or implied.  See the License for the</span></span><br><span class="line"><span class="comment">specific language governing permissions and limitations</span></span><br><span class="line"><span class="comment">under the License.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> | This is the configuration file for Maven. It can be specified at two levels:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |  1. User Level. This settings.xml file provides configuration for a single user,</span></span><br><span class="line"><span class="comment"> |                 and is normally provided in $&#123;user.home&#125;/.m2/settings.xml.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 <span class="doctag">NOTE:</span> This location can be overridden with the CLI option:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 -s /path/to/user/settings.xml</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |  2. Global Level. This settings.xml file provides configuration for all Maven</span></span><br><span class="line"><span class="comment"> |                 users on a machine (assuming they're all using the same Maven</span></span><br><span class="line"><span class="comment"> |                 installation). It's normally provided in</span></span><br><span class="line"><span class="comment"> |                 $&#123;maven.conf&#125;/settings.xml.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 <span class="doctag">NOTE:</span> This location can be overridden with the CLI option:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 -gs /path/to/global/settings.xml</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> | The sections in this sample file are intended to give you a running start at</span></span><br><span class="line"><span class="comment"> | getting the most out of your Maven installation. Where appropriate, the default</span></span><br><span class="line"><span class="comment"> | values (values used when the setting is not specified) are provided.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- localRepository</span></span><br><span class="line"><span class="comment">   | The path to the local repository maven will use to store artifacts.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: $&#123;user.home&#125;/.m2/repository</span></span><br><span class="line"><span class="comment">  &lt;localRepository&gt;/path/to/local/repo&lt;/localRepository&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- interactiveMode</span></span><br><span class="line"><span class="comment">   | This will determine whether maven prompts you when it needs input. If set to false,</span></span><br><span class="line"><span class="comment">   | maven will use a sensible default value, perhaps based on some other setting, for</span></span><br><span class="line"><span class="comment">   | the parameter in question.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: true</span></span><br><span class="line"><span class="comment">  &lt;interactiveMode&gt;true&lt;/interactiveMode&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- offline</span></span><br><span class="line"><span class="comment">   | Determines whether maven should attempt to connect to the network when executing a build.</span></span><br><span class="line"><span class="comment">   | This will have an effect on artifact downloads, artifact deployment, and others.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: false</span></span><br><span class="line"><span class="comment">  &lt;offline&gt;false&lt;/offline&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- pluginGroups</span></span><br><span class="line"><span class="comment">   | This is a list of additional group identifiers that will be searched when resolving plugins by their prefix, i.e.</span></span><br><span class="line"><span class="comment">   | when invoking a command line like "mvn prefix:goal". Maven will automatically add the group identifiers</span></span><br><span class="line"><span class="comment">   | "org.apache.maven.plugins" and "org.codehaus.mojo" if these are not already contained in the list.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- pluginGroup</span></span><br><span class="line"><span class="comment">     | Specifies a further group identifier to use for plugin lookup.</span></span><br><span class="line"><span class="comment">    &lt;pluginGroup&gt;com.your.plugins&lt;/pluginGroup&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- proxies</span></span><br><span class="line"><span class="comment">   | This is a list of proxies which can be used on this machine to connect to the network.</span></span><br><span class="line"><span class="comment">   | Unless otherwise specified (by system property or command-line switch), the first proxy</span></span><br><span class="line"><span class="comment">   | specification in this list marked as active will be used.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">proxies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- proxy</span></span><br><span class="line"><span class="comment">     | Specification for one proxy, to be used in connecting to the network.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;proxy&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;optional&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;active&gt;true&lt;/active&gt;</span></span><br><span class="line"><span class="comment">      &lt;protocol&gt;http&lt;/protocol&gt;</span></span><br><span class="line"><span class="comment">      &lt;username&gt;proxyuser&lt;/username&gt;</span></span><br><span class="line"><span class="comment">      &lt;password&gt;proxypass&lt;/password&gt;</span></span><br><span class="line"><span class="comment">      &lt;host&gt;proxy.host.net&lt;/host&gt;</span></span><br><span class="line"><span class="comment">      &lt;port&gt;80&lt;/port&gt;</span></span><br><span class="line"><span class="comment">      &lt;nonProxyHosts&gt;local.net|some.host.com&lt;/nonProxyHosts&gt;</span></span><br><span class="line"><span class="comment">    &lt;/proxy&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">proxies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- servers</span></span><br><span class="line"><span class="comment">   | This is a list of authentication profiles, keyed by the server-id used within the system.</span></span><br><span class="line"><span class="comment">   | Authentication profiles can be used whenever maven must make a connection to a remote server.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- server</span></span><br><span class="line"><span class="comment">     | Specifies the authentication information to use when connecting to a particular server, identified by</span></span><br><span class="line"><span class="comment">     | a unique name within the system (referred to by the 'id' attribute below).</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | <span class="doctag">NOTE:</span> You should either specify username/password OR privateKey/passphrase, since these pairings are</span></span><br><span class="line"><span class="comment">     |       used together.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;server&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;deploymentRepo&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;username&gt;repouser&lt;/username&gt;</span></span><br><span class="line"><span class="comment">      &lt;password&gt;repopwd&lt;/password&gt;</span></span><br><span class="line"><span class="comment">    &lt;/server&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Another sample, using keys to authenticate.</span></span><br><span class="line"><span class="comment">    &lt;server&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;siteServer&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;privateKey&gt;/path/to/private/key&lt;/privateKey&gt;</span></span><br><span class="line"><span class="comment">      &lt;passphrase&gt;optional; leave empty if not used.&lt;/passphrase&gt;</span></span><br><span class="line"><span class="comment">    &lt;/server&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- mirrors</span></span><br><span class="line"><span class="comment">   | This is a list of mirrors to be used in downloading artifacts from remote repositories.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | It works like this: a POM may declare a repository to use in resolving certain artifacts.</span></span><br><span class="line"><span class="comment">   | However, this repository may have problems with heavy traffic at times, so people have mirrored</span></span><br><span class="line"><span class="comment">   | it to several places.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | That repository definition will have a unique id, so we can create a mirror reference for that</span></span><br><span class="line"><span class="comment">   | repository, to be used as an alternate download site. The mirror site will be the preferred</span></span><br><span class="line"><span class="comment">   | server for that repository.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mirror</span></span><br><span class="line"><span class="comment">     | Specifies a repository mirror site to use instead of a given repository. The repository that</span></span><br><span class="line"><span class="comment">     | this mirror serves has an ID that matches the mirrorOf element of this mirror. IDs are used</span></span><br><span class="line"><span class="comment">     | for inheritance and direct lookup purposes, and must be unique across the set of mirrors.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;mirror&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;mirrorId&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;mirrorOf&gt;repositoryId&lt;/mirrorOf&gt;</span></span><br><span class="line"><span class="comment">      &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;</span></span><br><span class="line"><span class="comment">      &lt;url&gt;http://my.repository.com/repo/path&lt;/url&gt;</span></span><br><span class="line"><span class="comment">    &lt;/mirror&gt;</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- profiles</span></span><br><span class="line"><span class="comment">   | This is a list of profiles which can be activated in a variety of ways, and which can modify</span></span><br><span class="line"><span class="comment">   | the build process. Profiles provided in the settings.xml are intended to provide local machine-</span></span><br><span class="line"><span class="comment">   | specific paths and repository locations which allow the build to work in the local environment.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | For example, if you have an integration testing plugin - like cactus - that needs to know where</span></span><br><span class="line"><span class="comment">   | your Tomcat instance is installed, you can provide a variable here such that the variable is</span></span><br><span class="line"><span class="comment">   | dereferenced during the build process to configure the cactus plugin.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | As noted above, profiles can be activated in a variety of ways. One way - the activeProfiles</span></span><br><span class="line"><span class="comment">   | section of this document (settings.xml) - will be discussed later. Another way essentially</span></span><br><span class="line"><span class="comment">   | relies on the detection of a system property, either matching a particular value for the property,</span></span><br><span class="line"><span class="comment">   | or merely testing its existence. Profiles can also be activated by JDK version prefix, where a</span></span><br><span class="line"><span class="comment">   | value of '1.4' might activate a profile when the build is executed on a JDK version of '1.4.2_07'.</span></span><br><span class="line"><span class="comment">   | Finally, the list of active profiles can be specified directly from the command line.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | <span class="doctag">NOTE:</span> For profiles defined in the settings.xml, you are restricted to specifying only artifact</span></span><br><span class="line"><span class="comment">   |       repositories, plugin repositories, and free-form properties to be used as configuration</span></span><br><span class="line"><span class="comment">   |       variables for plugins in the POM.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- profile</span></span><br><span class="line"><span class="comment">     | Specifies a set of introductions to the build process, to be activated using one or more of the</span></span><br><span class="line"><span class="comment">     | mechanisms described above. For inheritance purposes, and to activate profiles via &lt;activatedProfiles/&gt;</span></span><br><span class="line"><span class="comment">     | or the command line, profiles have to have an ID that is unique.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | An encouraged best practice for profile identification is to use a consistent naming convention</span></span><br><span class="line"><span class="comment">     | for profiles, such as 'env-dev', 'env-test', 'env-production', 'user-jdcasey', 'user-brett', etc.</span></span><br><span class="line"><span class="comment">     | This will make it more intuitive to understand what the set of introduced profiles is attempting</span></span><br><span class="line"><span class="comment">     | to accomplish, particularly when you only have a list of profile id's for debug.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | This profile example uses the JDK version to trigger activation, and provides a JDK-specific repo.</span></span><br><span class="line"><span class="comment">    &lt;profile&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;jdk-1.4&lt;/id&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;activation&gt;</span></span><br><span class="line"><span class="comment">        &lt;jdk&gt;1.4&lt;/jdk&gt;</span></span><br><span class="line"><span class="comment">      &lt;/activation&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;repositories&gt;</span></span><br><span class="line"><span class="comment">        &lt;repository&gt;</span></span><br><span class="line"><span class="comment">          &lt;id&gt;jdk14&lt;/id&gt;</span></span><br><span class="line"><span class="comment">          &lt;name&gt;Repository for JDK 1.4 builds&lt;/name&gt;</span></span><br><span class="line"><span class="comment">          &lt;url&gt;http://www.myhost.com/maven/jdk14&lt;/url&gt;</span></span><br><span class="line"><span class="comment">          &lt;layout&gt;default&lt;/layout&gt;</span></span><br><span class="line"><span class="comment">          &lt;snapshotPolicy&gt;always&lt;/snapshotPolicy&gt;</span></span><br><span class="line"><span class="comment">        &lt;/repository&gt;</span></span><br><span class="line"><span class="comment">      &lt;/repositories&gt;</span></span><br><span class="line"><span class="comment">    &lt;/profile&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">     | Here is another profile, activated by the system property 'target-env' with a value of 'dev',</span></span><br><span class="line"><span class="comment">     | which provides a specific path to the Tomcat instance. To use this, your plugin configuration</span></span><br><span class="line"><span class="comment">     | might hypothetically look like:</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | ...</span></span><br><span class="line"><span class="comment">     | &lt;plugin&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;groupId&gt;org.myco.myplugins&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;artifactId&gt;myplugin&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     |   &lt;configuration&gt;</span></span><br><span class="line"><span class="comment">     |     &lt;tomcatLocation&gt;$&#123;tomcatPath&#125;&lt;/tomcatLocation&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;/configuration&gt;</span></span><br><span class="line"><span class="comment">     | &lt;/plugin&gt;</span></span><br><span class="line"><span class="comment">     | ...</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | <span class="doctag">NOTE:</span> If you just wanted to inject this configuration whenever someone set 'target-env' to</span></span><br><span class="line"><span class="comment">     |       anything, you could just leave off the &lt;value/&gt; inside the activation-property.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;profile&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;env-dev&lt;/id&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;activation&gt;</span></span><br><span class="line"><span class="comment">        &lt;property&gt;</span></span><br><span class="line"><span class="comment">          &lt;name&gt;target-env&lt;/name&gt;</span></span><br><span class="line"><span class="comment">          &lt;value&gt;dev&lt;/value&gt;</span></span><br><span class="line"><span class="comment">        &lt;/property&gt;</span></span><br><span class="line"><span class="comment">      &lt;/activation&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;properties&gt;</span></span><br><span class="line"><span class="comment">        &lt;tomcatPath&gt;/path/to/tomcat/instance&lt;/tomcatPath&gt;</span></span><br><span class="line"><span class="comment">      &lt;/properties&gt;</span></span><br><span class="line"><span class="comment">    &lt;/profile&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- activeProfiles</span></span><br><span class="line"><span class="comment">   | List of profiles that are active for all builds.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">  &lt;activeProfiles&gt;</span></span><br><span class="line"><span class="comment">    &lt;activeProfile&gt;alwaysActiveProfile&lt;/activeProfile&gt;</span></span><br><span class="line"><span class="comment">    &lt;activeProfile&gt;anotherAlwaysActiveProfile&lt;/activeProfile&gt;</span></span><br><span class="line"><span class="comment">  &lt;/activeProfiles&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在国内使用maven都需要在<code>settings.xml</code>里面配置国内的mirrors，以加速maven下载依赖包的过程。</li></ul><blockquote><p>这里以阿里云的为例，需要在settings.xml文件里面添加如下内容</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span>  </span><br><span class="line">    ...   </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>          </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h1><h2 id="处理settings-xml"><a href="#处理settings-xml" class="headerlink" title="处理settings.xml"></a>处理settings.xml</h2><ul><li>将settings.xml处理成容易处理的字符串</li><li>清理注释</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xmlstarlet ed -d <span class="string">'//comment()'</span> settings.xml | grep -v mirrors | xml2</span><br><span class="line"><span class="comment"># 输出实例</span></span><br><span class="line">/settings/@xmlns=http://maven.apache.org/SETTINGS/1.0.0</span><br><span class="line">/settings/@xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance</span><br><span class="line">/settings/@xsi:schemaLocation=http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><br><span class="line">/settings/pluginGroups</span><br><span class="line">/settings/proxies</span><br><span class="line">/settings/servers</span><br><span class="line">/settings/profiles</span><br></pre></td></tr></table></figure><h2 id="处理mirror配置"><a href="#处理mirror配置" class="headerlink" title="处理mirror配置"></a>处理mirror配置</h2><ul><li>同样使用xml2处理xml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; aliyun_mirror.xml &lt;&lt;EOF</span><br><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;mirrors&gt;</span><br><span class="line">        &lt;mirror&gt;  </span><br><span class="line">          &lt;id&gt;alimaven&lt;/id&gt;  </span><br><span class="line">          &lt;name&gt;aliyun maven&lt;/name&gt;  </span><br><span class="line">          &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;  </span><br><span class="line">          &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;          </span><br><span class="line">        &lt;/mirror&gt;</span><br><span class="line">    &lt;/mirrors&gt;</span><br><span class="line">&lt;/settings&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">xml2 &lt; aliyun_mirror.xml</span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">settings/mirrors/mirror/id=alimaven</span><br><span class="line">settings/mirrors/mirror/name=aliyun maven</span><br><span class="line">settings/mirrors/mirror/url=http://maven.aliyun.com/nexus/content/groups/public/</span><br><span class="line">settings/mirrors/mirror/mirrorOf=central</span><br></pre></td></tr></table></figure><h2 id="合并配置"><a href="#合并配置" class="headerlink" title="合并配置"></a>合并配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Settings=$(xmlstarlet ed -d <span class="string">'//comment()'</span> settings.xml | grep -v mirrors | xml2)</span><br><span class="line">AliyunMirror=$(xml2 &lt; aliyun_mirror.xml)</span><br><span class="line"><span class="built_in">printf</span> <span class="string">"<span class="variable">$Settings</span>\n<span class="variable">$AliyunMirror</span>"</span></span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">/settings/@xmlns=http://maven.apache.org/SETTINGS/1.0.0</span><br><span class="line">/settings/@xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance</span><br><span class="line">/settings/@xsi:schemaLocation=http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><br><span class="line">/settings/pluginGroups</span><br><span class="line">/settings/proxies</span><br><span class="line">/settings/servers</span><br><span class="line">/settings/profiles/settings/mirrors/mirror/id=alimaven</span><br><span class="line">/settings/mirrors/mirror/name=aliyun maven</span><br><span class="line">/settings/mirrors/mirror/url=http://maven.aliyun.com/nexus/content/groups/public/</span><br><span class="line">/settings/mirrors/mirror/mirrorOf=central</span><br></pre></td></tr></table></figure><h2 id="将字符串转换成xml格式文件"><a href="#将字符串转换成xml格式文件" class="headerlink" title="将字符串转换成xml格式文件"></a>将字符串转换成xml格式文件</h2><ul><li>这里将输出结果打印在终端，可以直接重定向到settings.xml文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">"<span class="variable">$Settings</span>\n<span class="variable">$AliyunMirror</span>"</span> | 2xml | xmllint --format -</span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span><br><span class="line">&lt;settings xmlns=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> xsi:schemaLocation=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"</span>&gt;</span><br><span class="line">  &lt;pluginGroups/&gt;</span><br><span class="line">  &lt;proxies/&gt;</span><br><span class="line">  &lt;servers/&gt;</span><br><span class="line">  &lt;profiles/&gt;</span><br><span class="line">  &lt;mirrors&gt;</span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;alimaven&lt;/id&gt;</span><br><span class="line">      &lt;name&gt;aliyun maven&lt;/name&gt;</span><br><span class="line">      &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">      &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line">  &lt;/mirrors&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;p&gt;工作中遇到需要使用shell命令编辑xml文件，以shell自带的命令去处理非常的不方便，于是乎找了一下处理xml的命令行工具。在此记录一下
      
    
    </summary>
    
    
      <category term="shell" scheme="https://luanlengli.github.io/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>git pull免密码配置</title>
    <link href="https://luanlengli.github.io/2019/04/07/git-pull%E5%85%8D%E5%AF%86%E7%A0%81%E9%85%8D%E7%BD%AE.html"/>
    <id>https://luanlengli.github.io/2019/04/07/git-pull免密码配置.html</id>
    <published>2019-04-07T14:25:00.000Z</published>
    <updated>2019-04-07T14:29:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>git 拉取代码的时候，如果不使用密钥的方式时，会要求输入用户密码，非常繁琐</li><li>为此需要配置免账号密码登录</li></ul><h1 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h1><ul><li>切换到用户家目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure><ul><li>运行git命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.helper store</span><br></pre></td></tr></table></figure><ul><li>此命令会在用户家目录生成一个<code>.gitconfig</code>，内容如下</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[credential]</span><br><span class="line">helper = store</span><br></pre></td></tr></table></figure><ul><li>再次运行<code>git pull</code>还是会提示输入用户密码，命令会在用户家目录生成<code>.git-credentials</code>文件，里面会保存刚才输入的用户密码。</li><li>后续操作git的时候就不会要求输入用户密码了</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;git 拉取代码的时候，如果不使用密钥的方式时，会要求输入用户密码，非常繁琐&lt;/li&gt;&lt;li&gt;为此需要配置免账号密码登录&lt;/li&gt;
      
    
    </summary>
    
    
      <category term="git" scheme="https://luanlengli.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>阿里云RDS数据库MySQL5.7实例主从搭建过程</title>
    <link href="https://luanlengli.github.io/2019/04/06/%E9%98%BF%E9%87%8C%E4%BA%91RDS%E6%95%B0%E6%8D%AE%E5%BA%93MySQL5-7%E5%AE%9E%E4%BE%8B%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B.html"/>
    <id>https://luanlengli.github.io/2019/04/06/阿里云RDS数据库MySQL5-7实例主从搭建过程.html</id>
    <published>2019-04-06T03:16:33.000Z</published>
    <updated>2019-04-25T15:26:30.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>工作中遇到需要搭建阿里云RDS数据库MySQL5.7实例主从集群，在此记录搭建过程</li><li>主库<ul><li>阿里云RDS数据库MySQL5.7实例</li></ul></li><li>从库<ul><li>本地服务器MySQL5.7，通过公网访问阿里云RDS实例</li></ul></li></ul><h1 id="阿里云RDS实例准备操作"><a href="#阿里云RDS实例准备操作" class="headerlink" title="阿里云RDS实例准备操作"></a>阿里云RDS实例准备操作</h1><ul><li>登录阿里云管理控制台</li><li>选择【云数据库RDS版】</li><li>切换到【云数据库RDS版】界面，左上角选择【数据中心】，在【实例列表】中找到主库，点击右侧的【管理】</li><li>在【基本信息】可以看到主库的【外网地址】和端口<ul><li>外网地址示例：<code>rm-xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com</code></li><li>端口：<code>3306</code></li></ul></li><li>切换到【账号管理】，点击【创建账号】<ul><li>用户名：<code>repuser</code></li><li>密码：<code>repuserpassword</code></li><li>账号类型：<code>普通帐号</code></li><li>授权数据库：<code>选择需要同步的数据库</code>，选择完毕后，权限统一设置为【只读】</li></ul></li><li>登录阿里云RDS实例，查看主库信息<ul><li><code>show variables like &#39;%binlog_format%&#39;;</code></li><li><code>show variables like &#39;server_id&#39;;</code></li></ul></li></ul><h1 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h1><ul><li>安装MySQL5.7，这里网上很多教程，自行解决</li><li>修改从库<code>my.cnf</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># 这里的server-id要跟RDS主库查询到的server-id不一样</span></span><br><span class="line">server-id                =  3306              </span><br><span class="line">log_bin                  =  /data/mysql-data</span><br><span class="line">expire_logs_days         =  7</span><br><span class="line">max_binlog_size          =  100M</span><br><span class="line">replicate-ignore-db      =  ccccc                  <span class="comment">#不想同步的数据库</span></span><br><span class="line">replicate-ignore-db      =  ddddd                  <span class="comment">#不想同步的数据库</span></span><br><span class="line"><span class="comment"># 启动GTID </span></span><br><span class="line">gtid_mode                =  on</span><br><span class="line">enforce_gtid_consistency =  on</span><br><span class="line">binlog_format            =  row                    <span class="comment">#设置 binlog 为 row</span></span><br><span class="line"><span class="built_in">log</span>-slave-updates        =  1</span><br></pre></td></tr></table></figure><ul><li>在从库上对阿里云RDS实例做一次dump备份</li></ul><blockquote><p>假设我们要同步的是aaa和bbb两个库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u'repuser' \</span><br><span class="line">          -h'rm-xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com' \</span><br><span class="line">          -P 3306 \</span><br><span class="line">          -p'repuserpassword' \</span><br><span class="line">          --set-gtid-purged=ON \</span><br><span class="line">          --master-data=2 \</span><br><span class="line">          --single-transaction \</span><br><span class="line">          --databases aaa bbb &gt; aliyun_rds_dump.sql</span><br></pre></td></tr></table></figure><ul><li>从库导入dump备份</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u<span class="string">'root'</span> \</span><br><span class="line">      -p \</span><br><span class="line">      -P3306 \</span><br><span class="line">      &lt; aliyun_rds_dump.sql</span><br></pre></td></tr></table></figure><ul><li>设置从库</li></ul><blockquote><p>启用基于GTID的主从同步</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host = &apos;xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com&apos;,</span><br><span class="line">                        master_port = 3306, </span><br><span class="line">                        master_user = &apos;repuser&apos;, </span><br><span class="line">                        master_password=&apos;repuserpassword&apos;, </span><br><span class="line">                        master_connect_retry=10,</span><br><span class="line">                        master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure><ul><li>检查主从同步状态</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G</span><br><span class="line">mysql&gt; show processlist \G</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;工作中遇到需要搭建阿里云RDS数据库MySQL5.7实例主从集群，在此记录搭建过程&lt;/li&gt;&lt;li&gt;主库&lt;ul&gt;&lt;li&gt;阿里云RD
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper安装部署记录</title>
    <link href="https://luanlengli.github.io/2019/03/29/Zookeeper%E6%90%AD%E5%BB%BA%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95.html"/>
    <id>https://luanlengli.github.io/2019/03/29/Zookeeper搭建部署记录.html</id>
    <published>2019-03-29T02:26:22.000Z</published>
    <updated>2019-06-04T09:01:55.631Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>此文仅记录Zookeeper单机和多节点搭建部署过程</p><p>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></p><p>JDK版本<code>OpenJDK-1.8</code></p><p>ZooKeeper版本<code>3.4.14</code></p><p>虚拟机配置<code>1CPU 4G内存 20G系统盘 30G数据盘</code></p></blockquote><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="安装OpenJDK"><a href="#安装OpenJDK" class="headerlink" title="安装OpenJDK"></a>安装OpenJDK</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br></pre></td></tr></table></figure><h1 id="安装ZooKeeper"><a href="#安装ZooKeeper" class="headerlink" title="安装ZooKeeper"></a>安装ZooKeeper</h1><h2 id="创建Zookeeper用户"><a href="#创建Zookeeper用户" class="headerlink" title="创建Zookeeper用户"></a>创建Zookeeper用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd zookeeper</span><br><span class="line">useradd -r -g zookeeper -s /bin/false zookeeper</span><br></pre></td></tr></table></figure><h2 id="创建Zookeeper程序目录"><a href="#创建Zookeeper程序目录" class="headerlink" title="创建Zookeeper程序目录"></a>创建Zookeeper程序目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/zookeeper</span><br></pre></td></tr></table></figure><h2 id="切换工作目录"><a href="#切换工作目录" class="headerlink" title="切换工作目录"></a>切换工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/software</span><br></pre></td></tr></table></figure><h2 id="下载ZooKeeper"><a href="#下载ZooKeeper" class="headerlink" title="下载ZooKeeper"></a>下载ZooKeeper</h2><blockquote><p>国内有Apache基金会的镜像源，这里用的是清华大学的源</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz | tar xz --directory=/opt/software</span><br></pre></td></tr></table></figure><h2 id="创建软连接"><a href="#创建软连接" class="headerlink" title="创建软连接"></a>创建软连接</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sv zookeeper-3.4.14 zookeeper</span><br></pre></td></tr></table></figure><h2 id="创建数据目录"><a href="#创建数据目录" class="headerlink" title="创建数据目录"></a>创建数据目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/zk-data /opt/zk-log</span><br></pre></td></tr></table></figure><h2 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/software/zookeeper/conf/zoo.cfg &lt;&lt;EOF</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/opt/zk-data</span><br><span class="line">dataLogDir=/opt/zk-log</span><br><span class="line">clientPort=2181</span><br><span class="line">maxClientCnxns=200</span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line">autopurge.purgeInterval=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="授权目录"><a href="#授权目录" class="headerlink" title="授权目录"></a>授权目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R zookeeper:zookeeper /opt/zookeeper /opt/zk-data /opt/zk-log</span><br></pre></td></tr></table></figure><h2 id="启动Zookeeper"><a href="#启动Zookeeper" class="headerlink" title="启动Zookeeper"></a>启动Zookeeper</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c "/opt/software/zookeeper/bin/zkServer.sh start /opt/software/zookeeper/conf/zoo.cfg" zookeeper</span><br></pre></td></tr></table></figure><h1 id="测试Zookeeper"><a href="#测试Zookeeper" class="headerlink" title="测试Zookeeper"></a>测试Zookeeper</h1><blockquote><p>使用客户端登陆</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/opt/software/zookeeper/bin/zkCli.sh -server localhost:2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">/bin/java</span><br><span class="line">Connecting to localhost:2181</span><br><span class="line">YYYY-MM-DD 10:53:57,868 [myid:] - INFO  [main:Environment@109] - Client environment:zookeeper.version=3.5.5-390fe37ea45dee01bf87dc1c042b5e3dcce88653, built on 05/03/2019 12:07 GMT</span><br><span class="line">YYYY-MM-DD 10:53:57,871 [myid:] - INFO  [main:Environment@109] - Client environment:host.name=localhost</span><br><span class="line">YYYY-MM-DD 10:53:57,871 [myid:] - INFO  [main:Environment@109] - Client environment:java.version=1.8.0_212</span><br><span class="line">YYYY-MM-DD 10:53:57,878 [myid:] - INFO  [main:Environment@109] - Client environment:java.vendor=Oracle Corporation</span><br><span class="line">YYYY-MM-DD 10:53:57,878 [myid:] - INFO  [main:Environment@109] - Client environment:java.home=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.212.b04-0.el7_6.x86_64/jre</span><br><span class="line">YYYY-MM-DD 10:53:57,878 [myid:] - INFO  [main:Environment@109] - Client environment:java.class.path=/opt/zookeeper/zookeeper/bin/../zookeeper-server/target/classes:/opt/zookeeper/zookeeper/bin/../build/classes:/opt/zookeeper/zookeeper/bin/../zookeeper-server/target/lib/*.jar:/opt/zookeeper/zookeeper/bin/../build/lib/*.jar:/opt/zookeeper/zookeeper/bin/../lib/zookeeper-jute-3.5.5.jar:/opt/zookeeper/zookeeper/bin/../lib/zookeeper-3.5.5.jar:/opt/zookeeper/zookeeper/bin/../lib/slf4j-log4j12-1.7.25.jar:/opt/zookeeper/zookeeper/bin/../lib/slf4j-api-1.7.25.jar:/opt/zookeeper/zookeeper/bin/../lib/netty-all-4.1.29.Final.jar:/opt/zookeeper/zookeeper/bin/../lib/log4j-1.2.17.jar:/opt/zookeeper/zookeeper/bin/../lib/json-simple-1.1.1.jar:/opt/zookeeper/zookeeper/bin/../lib/jline-2.11.jar:/opt/zookeeper/zookeeper/bin/../lib/jetty-util-9.4.17.v20190418.jar:/opt/zookeeper/zookeeper/bin/../lib/jetty-servlet-9.4.17.v20190418.jar:/opt/zookeeper/zookeeper/bin/../lib/jetty-server-9.4.17.v20190418.jar:/opt/zookeeper/zookeeper/bin/../lib/jetty-security-9.4.17.v20190418.jar:/opt/zookeeper/zookeeper/bin/../lib/jetty-io-9.4.17.v20190418.jar:/opt/zookeeper/zookeeper/bin/../lib/jetty-http-9.4.17.v20190418.jar:/opt/zookeeper/zookeeper/bin/../lib/javax.servlet-api-3.1.0.jar:/opt/zookeeper/zookeeper/bin/../lib/jackson-databind-2.9.8.jar:/opt/zookeeper/zookeeper/bin/../lib/jackson-core-2.9.8.jar:/opt/zookeeper/zookeeper/bin/../lib/jackson-annotations-2.9.0.jar:/opt/zookeeper/zookeeper/bin/../lib/commons-cli-1.2.jar:/opt/zookeeper/zookeeper/bin/../lib/audience-annotations-0.5.0.jar:/opt/zookeeper/zookeeper/bin/../zookeeper-*.jar:/opt/zookeeper/zookeeper/bin/../zookeeper-server/src/main/resources/lib/*.jar:/opt/zookeeper/zookeeper/bin/../conf:</span><br><span class="line">YYYY-MM-DD 10:53:57,879 [myid:] - INFO  [main:Environment@109] - Client environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line">YYYY-MM-DD 10:53:57,879 [myid:] - INFO  [main:Environment@109] - Client environment:java.io.tmpdir=/tmp</span><br><span class="line">YYYY-MM-DD 10:53:57,880 [myid:] - INFO  [main:Environment@109] - Client environment:java.compiler=&lt;NA&gt;</span><br><span class="line">YYYY-MM-DD 10:53:57,880 [myid:] - INFO  [main:Environment@109] - Client environment:os.name=Linux</span><br><span class="line">YYYY-MM-DD 10:53:57,880 [myid:] - INFO  [main:Environment@109] - Client environment:os.arch=amd64</span><br><span class="line">YYYY-MM-DD 10:53:57,880 [myid:] - INFO  [main:Environment@109] - Client environment:os.version=3.10.0-957.12.2.el7.x86_64</span><br><span class="line">YYYY-MM-DD 10:53:57,880 [myid:] - INFO  [main:Environment@109] - Client environment:user.name=zookeeper</span><br><span class="line">YYYY-MM-DD 10:53:57,881 [myid:] - INFO  [main:Environment@109] - Client environment:user.home=/home/zookeeper</span><br><span class="line">YYYY-MM-DD 10:53:57,881 [myid:] - INFO  [main:Environment@109] - Client environment:user.dir=/home/zookeeper</span><br><span class="line">YYYY-MM-DD 10:53:57,882 [myid:] - INFO  [main:Environment@109] - Client environment:os.memory.free=55MB</span><br><span class="line">YYYY-MM-DD 10:53:57,887 [myid:] - INFO  [main:Environment@109] - Client environment:os.memory.max=247MB</span><br><span class="line">YYYY-MM-DD 10:53:57,887 [myid:] - INFO  [main:Environment@109] - Client environment:os.memory.total=59MB</span><br><span class="line">YYYY-MM-DD 10:53:57,890 [myid:] - INFO  [main:ZooKeeper@868] - Initiating client connection, connectString=localhost:2181 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain$MyWatcher@3b95a09c</span><br><span class="line">YYYY-MM-DD 10:53:57,906 [myid:] - INFO  [main:X509Util@79] - Setting -D jdk.tls.rejectClientInitiatedRenegotiation=true to disable client-initiated TLS renegotiation</span><br><span class="line">YYYY-MM-DD 10:53:57,930 [myid:] - INFO  [main:ClientCnxnSocket@237] - jute.maxbuffer value is 4194304 Bytes</span><br><span class="line">YYYY-MM-DD 10:53:57,943 [myid:] - INFO  [main:ClientCnxn@1653] - zookeeper.request.timeout value is 0. feature enabled=</span><br><span class="line">YYYY-MM-DD 10:53:57,951 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@1112] - Opening socket connection to server localhost/0:0:0:0:0:0:0:1:2181. Will not attempt to authenticate using SASL (unknown error)</span><br><span class="line">Welcome to ZooKeeper!</span><br><span class="line">JLine support is enabled</span><br><span class="line">YYYY-MM-DD 10:53:58,115 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@959] - Socket connection established, initiating session, client: /0:0:0:0:0:0:0:1:56998, server: localhost/0:0:0:0:0:0:0:1:2181</span><br><span class="line">YYYY-MM-DD 10:53:58,149 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@1394] - Session establishment complete on server localhost/0:0:0:0:0:0:0:1:2181, sessionid = 0x1000012d1c20002, negotiated timeout = 30000</span><br><span class="line"></span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:None path:null</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[zookeeper]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /zookeeper</span><br><span class="line">[config, quota]</span><br></pre></td></tr></table></figure><h1 id="托管为systemd服务"><a href="#托管为systemd服务" class="headerlink" title="托管为systemd服务"></a>托管为systemd服务</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Zookeeper service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=zookeeper</span><br><span class="line">Group=zookeeper</span><br><span class="line">Environment=ZOO_LOG_DIR=/opt/zk-log</span><br><span class="line">ExecStart=/opt/software/zookeeper/bin/zkServer.sh start-foreground /opt/software/zookeeper/conf/zoo.cfg</span><br><span class="line">ExecStop=/opt/software/zookeeper/bin/zkServer.sh stop /opt/software/zookeeper/conf/zoo.cfg</span><br><span class="line">WorkingDirectory=/opt/zk-data</span><br><span class="line">RestartSec=60</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h1 id="多节点部署Zookeeper"><a href="#多节点部署Zookeeper" class="headerlink" title="多节点部署Zookeeper"></a>多节点部署Zookeeper</h1><blockquote><p>Zookeeper多节点部署比较简单</p><p>一般情况下使用三个节点，奇数节点方便集群内部选主</p></blockquote><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><blockquote><p>这里需要在<code>zoo.cfg</code>添加集群节点信息</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.1=zk1:2888:3888</span><br><span class="line">server.2=zk2:2888:3888</span><br><span class="line">server.3=zk3:2888:3888</span><br></pre></td></tr></table></figure><h2 id="创建myid文件"><a href="#创建myid文件" class="headerlink" title="创建myid文件"></a>创建myid文件</h2><blockquote><p>每个节点都需要在zookeeper数据目录下创建<code>myid</code>，用于标记节点序号</p></blockquote><ul><li>zk1</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo '1' &gt; /opt/zk-data/myid</span><br></pre></td></tr></table></figure><ul><li>zk2</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo '2' &gt; /opt/zk-data/myid</span><br></pre></td></tr></table></figure><ul><li>zk3</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo '3' &gt; /opt/zk-data/myid</span><br></pre></td></tr></table></figure><h2 id="启动Zookeeper-1"><a href="#启动Zookeeper-1" class="headerlink" title="启动Zookeeper"></a>启动Zookeeper</h2><blockquote><p>在<code>initLimit</code>配置初始化时间内，在<code>zk1</code>、<code>zk2</code>、<code>zk3</code>启动Zookeeper即可</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;此文仅记录Zookeeper单机和多节点搭建部署过程&lt;/p&gt;&lt;p&gt;操作系统使用的&lt;code&gt;CentOS-7.6.1
      
    
    </summary>
    
    
      <category term="ZooKeeper" scheme="https://luanlengli.github.io/tags/ZooKeeper/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-学习笔记</title>
    <link href="https://luanlengli.github.io/2019/02/22/Elasticsearch-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://luanlengli.github.io/2019/02/22/Elasticsearch-学习笔记.html</id>
    <published>2019-02-22T15:28:10.000Z</published>
    <updated>2019-03-03T14:13:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="cat-APIs"><a href="#cat-APIs" class="headerlink" title="_cat APIs"></a>_cat APIs</h1><p>通过访问elasticsearch集群的<code>/_cat</code>可以获取很多有用的信息。</p><p>使用<code>curl -X GET &quot;http://elasticsearch:9200/_cat&quot;</code>可以单独列出所有可用的命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">"http://elasticsearch-1:9200/_cat/"</span></span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;<span class="built_in">alias</span>&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure><h2 id="获取-cat-API帮助"><a href="#获取-cat-API帮助" class="headerlink" title="获取_cat API帮助"></a>获取_cat API帮助</h2><ul><li>可以在<code>/_cat/COMMAND</code>后面加上参数help，获取对应的帮助信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/allocation?help"</span></span><br><span class="line">shards       | s              | number of shards on node      </span><br><span class="line">disk.indices | di,diskIndices | disk used by ES indices       </span><br><span class="line">disk.used    | du,diskUsed    | disk used (total, not just ES)</span><br><span class="line">disk.avail   | da,diskAvail   | disk available                </span><br><span class="line">disk.total   | dt,diskTotal   | total capacity of all volumes </span><br><span class="line">disk.percent | dp,diskPercent | percent disk used             </span><br><span class="line">host         | h              | host of node                  </span><br><span class="line">ip           |                | ip of node                    </span><br><span class="line">node         | n              | name of node</span><br></pre></td></tr></table></figure><h2 id="获取当前master信息"><a href="#获取当前master信息" class="headerlink" title="获取当前master信息"></a>获取当前master信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/master?v"</span></span><br><span class="line">id                     host          ip            node</span><br><span class="line">JLyKyWH_QnSiXXuRNCj_3g 172.16.80.201 172.16.80.201 elasticsearch-1</span><br></pre></td></tr></table></figure><h2 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/nodes?format=json&amp;pretty"</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ip"</span> : <span class="string">"172.16.80.201"</span>,</span><br><span class="line">    <span class="string">"heap.percent"</span> : <span class="string">"7"</span>,</span><br><span class="line">    <span class="string">"ram.percent"</span> : <span class="string">"85"</span>,</span><br><span class="line">    <span class="string">"cpu"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"load_1m"</span> : <span class="string">"0.00"</span>,</span><br><span class="line">    <span class="string">"load_5m"</span> : <span class="string">"0.08"</span>,</span><br><span class="line">    <span class="string">"load_15m"</span> : <span class="string">"0.20"</span>,</span><br><span class="line">    <span class="string">"node.role"</span> : <span class="string">"mdi"</span>,</span><br><span class="line">    <span class="string">"master"</span> : <span class="string">"*"</span>,</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="获取索引信息"><a href="#获取索引信息" class="headerlink" title="获取索引信息"></a>获取索引信息</h2><ul><li>以json格式返回结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET -H <span class="string">"Accept: application/json"</span> <span class="string">"http://elasticsearch-1:9200/_cat/indices?format=json&amp;pretty"</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">".kibana"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"V_t2TnJKQ9WV8E1C_uzIfA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"6"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"37.3kb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"37.3kb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"bank"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"3OEfeSwsTyKyC2zKHbuzJQ"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"1000"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"640.8kb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"640.8kb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.18"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"h8m1NlTIQS6Z49mHACYokA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4631"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"27mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"27mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"shakespeare"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"xwoP7Pc3Q3ySZ47MosHrFA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"111396"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"29mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"29mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.20"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"ewX3DcZHScOK4Mi6lF6Hqg"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4750"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"30.3mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"30.3mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.19"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"siQA71vbSYOgE3a8M7HDhg"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4624"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"29.3mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"29.3mb"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>以yaml格式返回结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/indices?format=yaml&amp;pretty"</span></span><br><span class="line">---</span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">".kibana"</span></span><br><span class="line">  uuid: <span class="string">"V_t2TnJKQ9WV8E1C_uzIfA"</span></span><br><span class="line">  pri: <span class="string">"1"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"6"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"37.3kb"</span></span><br><span class="line">  pri.store.size: <span class="string">"37.3kb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"bank"</span></span><br><span class="line">  uuid: <span class="string">"3OEfeSwsTyKyC2zKHbuzJQ"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"1000"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"640.8kb"</span></span><br><span class="line">  pri.store.size: <span class="string">"640.8kb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.18"</span></span><br><span class="line">  uuid: <span class="string">"h8m1NlTIQS6Z49mHACYokA"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4631"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"27mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"27mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"shakespeare"</span></span><br><span class="line">  uuid: <span class="string">"xwoP7Pc3Q3ySZ47MosHrFA"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"111396"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"29mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"29mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.20"</span></span><br><span class="line">  uuid: <span class="string">"ewX3DcZHScOK4Mi6lF6Hqg"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4750"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"30.3mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"30.3mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.19"</span></span><br><span class="line">  uuid: <span class="string">"siQA71vbSYOgE3a8M7HDhg"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4624"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"29.3mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"29.3mb"</span></span><br></pre></td></tr></table></figure><h1 id="cluster-APIs"><a href="#cluster-APIs" class="headerlink" title="_cluster APIs"></a>_cluster APIs</h1><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster.html" target="_blank" rel="noopener">这里</a></p><h2 id="Cluster-Health"><a href="#Cluster-Health" class="headerlink" title="Cluster Health"></a>Cluster Health</h2><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html" target="_blank" rel="noopener">这里</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/health?format=yaml&amp;pretty"</span></span><br><span class="line">---</span><br><span class="line">cluster_name: <span class="string">"elasticsearch"</span></span><br><span class="line">status: <span class="string">"yellow"</span></span><br><span class="line">timed_out: <span class="literal">false</span></span><br><span class="line">number_of_nodes: 1</span><br><span class="line">number_of_data_nodes: 1</span><br><span class="line">active_primary_shards: 26</span><br><span class="line">active_shards: 26</span><br><span class="line">relocating_shards: 0</span><br><span class="line">initializing_shards: 0</span><br><span class="line">unassigned_shards: 26</span><br><span class="line">delayed_unassigned_shards: 0</span><br><span class="line">number_of_pending_tasks: 0</span><br><span class="line">number_of_in_flight_fetch: 0</span><br><span class="line">task_max_waiting_in_queue_millis: 0</span><br><span class="line">active_shards_percent_as_number: 50.0</span><br></pre></td></tr></table></figure><h2 id="Cluster-State"><a href="#Cluster-State" class="headerlink" title="Cluster State"></a>Cluster State</h2><p>显示集群状态，官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state.html" target="_blank" rel="noopener">这里</a></p><h3 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/version?"</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"version"</span> : 16,</span><br><span class="line">  <span class="string">"state_uuid"</span> : <span class="string">"w0Bp1nGfRdCGxhA5zD1BBw"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看master节点"><a href="#查看master节点" class="headerlink" title="查看master节点"></a>查看master节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/master_node?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"master_node"</span> : <span class="string">"JLyKyWH_QnSiXXuRNCj_3g"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/nodes?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"nodes"</span> : &#123;</span><br><span class="line">    <span class="string">"JLyKyWH_QnSiXXuRNCj_3g"</span> : &#123;</span><br><span class="line">      <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span>,</span><br><span class="line">      <span class="string">"ephemeral_id"</span> : <span class="string">"qdnVkiizToCVPhmDieH3Mg"</span>,</span><br><span class="line">      <span class="string">"transport_address"</span> : <span class="string">"172.16.80.201:9300"</span>,</span><br><span class="line">      <span class="string">"attributes"</span> : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Cluster-States"><a href="#Cluster-States" class="headerlink" title="Cluster States"></a>Cluster States</h2><p>显示集群统计信息，官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-stats.html" target="_blank" rel="noopener">这里</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/stats?format=json&amp;pretty"</span></span><br></pre></td></tr></table></figure><h2 id="Cluster-Update-Settings"><a href="#Cluster-Update-Settings" class="headerlink" title="Cluster Update Settings"></a>Cluster Update Settings</h2><p>用于更新集群设置，可以永久persistent和临时transient设置某些参数</p><ul><li>新启动的集群是没有配置的信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/settings?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"persistent"</span> : &#123; &#125;,</span><br><span class="line">  <span class="string">"transient"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>临时修改集群recovery最大速度</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT \</span><br><span class="line">     -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">     <span class="string">"http://elasticsearch-1:9200/_cluster/settings?format=json&amp;pretty"</span> \</span><br><span class="line">     -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "persistent" : &#123;</span></span><br><span class="line"><span class="string">        "indices.recovery.max_bytes_per_sec" : "50mb"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="Node-Stats"><a href="#Node-Stats" class="headerlink" title="Node Stats"></a>Node Stats</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_nodes/stats?format=json&amp;pretty"</span></span><br></pre></td></tr></table></figure><h2 id="Node-Info"><a href="#Node-Info" class="headerlink" title="Node Info"></a>Node Info</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不带过滤参数，默认显示所有节点信息</span></span><br><span class="line">GET /_nodes</span><br><span class="line"><span class="comment"># 获取所有节点信息</span></span><br><span class="line">GET /_nodes/_all</span><br><span class="line"><span class="comment"># 获取当前节点信息</span></span><br><span class="line">GET /_nodes/_local</span><br><span class="line"><span class="comment"># 获取master节点信息</span></span><br><span class="line">GET /_nodes/_master</span><br><span class="line"><span class="comment"># 以主机名作为条件过滤节点，或者使用通配符匹配节点</span></span><br><span class="line">GET /_nodes/node_name_goes_here</span><br><span class="line">GET /_nodes/node_name_goes_*</span><br><span class="line"><span class="comment"># 可以使用IP地址加通配符过滤节点</span></span><br><span class="line">GET /_nodes/10.0.0.3,10.0.0.4</span><br><span class="line">GET /_nodes/10.0.0.*</span><br><span class="line"><span class="comment"># 以role作为过滤条件</span></span><br><span class="line">GET /_nodes/_all,master:<span class="literal">false</span></span><br><span class="line">GET /_nodes/data:<span class="literal">true</span>,ingest:<span class="literal">true</span></span><br><span class="line">GET /_nodes/coordinating_only:<span class="literal">true</span></span><br><span class="line"><span class="comment"># 根据elasticsearch.yml文件定义的node.attr.rack属性过滤节点，例如`node.attr.rack: 2`</span></span><br><span class="line">GET /_nodes/rack:2</span><br><span class="line">GET /_nodes/ra*:2</span><br><span class="line">GET /_nodes/ra*:2*</span><br></pre></td></tr></table></figure><h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/5.6/index.html" target="_blank" rel="noopener">这里</a></p><p>二进制文件<code>elasticsearch/bin/elasticsearch-plugin</code></p><h2 id="查看默认可用的插件"><a href="#查看默认可用的插件" class="headerlink" title="查看默认可用的插件"></a>查看默认可用的插件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-plugin install --<span class="built_in">help</span></span><br><span class="line">Install a plugin</span><br><span class="line"></span><br><span class="line">The following official plugins may be installed by name:</span><br><span class="line">  analysis-icu</span><br><span class="line">  analysis-kuromoji</span><br><span class="line">  analysis-phonetic</span><br><span class="line">  analysis-smartcn</span><br><span class="line">  analysis-stempel</span><br><span class="line">  analysis-ukrainian</span><br><span class="line">  discovery-azure-classic</span><br><span class="line">  discovery-ec2</span><br><span class="line">  discovery-file</span><br><span class="line">  discovery-gce</span><br><span class="line">  ingest-attachment</span><br><span class="line">  ingest-geoip</span><br><span class="line">  ingest-user-agent</span><br><span class="line">  lang-javascript</span><br><span class="line">  lang-python</span><br><span class="line">  mapper-attachments</span><br><span class="line">  mapper-murmur3</span><br><span class="line">  mapper-size</span><br><span class="line">  repository-azure</span><br><span class="line">  repository-gcs</span><br><span class="line">  repository-hdfs</span><br><span class="line">  repository-s3</span><br><span class="line">  store-smb</span><br><span class="line">  x-pack</span><br></pre></td></tr></table></figure><h1 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h1><h2 id="新增索引"><a href="#新增索引" class="headerlink" title="新增索引"></a>新增索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://elasticsearch-1:9200/twitter"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "settings" : &#123;</span></span><br><span class="line"><span class="string">        "index" : &#123;</span></span><br><span class="line"><span class="string">            "number_of_shards" : 3, </span></span><br><span class="line"><span class="string">            "number_of_replicas" : 2 </span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure><h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE <span class="string">"http://elasticsearch-1:9200/twitter"</span></span><br></pre></td></tr></table></figure><h2 id="获取索引"><a href="#获取索引" class="headerlink" title="获取索引"></a>获取索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">"http://elasticsearch-1:9200/twitter"</span></span><br></pre></td></tr></table></figure><h2 id="更新索引"><a href="#更新索引" class="headerlink" title="更新索引"></a>更新索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://elasticsearch-1:9200/twitter/_settings"</span> \</span><br><span class="line">     -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">     -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "index" : &#123;</span></span><br><span class="line"><span class="string">        "number_of_replicas" : 2</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure><h2 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class1/1?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Jing",</span></span><br><span class="line"><span class="string">  "last_name": "Guo",</span></span><br><span class="line"><span class="string">  "gender": "Male",</span></span><br><span class="line"><span class="string">  "age": 25,</span></span><br><span class="line"><span class="string">  "courses": "Xiang Long Shi Ba Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Rong",</span></span><br><span class="line"><span class="string">  "last_name": "Huang",</span></span><br><span class="line"><span class="string">  "gender": "Female",</span></span><br><span class="line"><span class="string">  "age": 23,</span></span><br><span class="line"><span class="string">  "courses": "Luo Ying Shen Jian Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class2/1?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Guo",</span></span><br><span class="line"><span class="string">  "last_name": "Yang",</span></span><br><span class="line"><span class="string">  "gender": "Male",</span></span><br><span class="line"><span class="string">  "age": 2,</span></span><br><span class="line"><span class="string">  "courses": "An Ran Xiao Hun Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="获取文档"><a href="#获取文档" class="headerlink" title="获取文档"></a>获取文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/class1/1?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"students"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"class1"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 3,</span><br><span class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"_source"</span> : &#123;</span><br><span class="line">    <span class="string">"first_name"</span> : <span class="string">"Jing"</span>,</span><br><span class="line">    <span class="string">"last_name"</span> : <span class="string">"Guo"</span>,</span><br><span class="line">    <span class="string">"gender"</span> : <span class="string">"Male"</span>,</span><br><span class="line">    <span class="string">"age"</span> : 25,</span><br><span class="line">    <span class="string">"courses"</span> : <span class="string">"Xiang Long Shi Ba Zhang"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"students"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"class1"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 1,</span><br><span class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"_source"</span> : &#123;</span><br><span class="line">    <span class="string">"first_name"</span> : <span class="string">"Rong"</span>,</span><br><span class="line">    <span class="string">"last_name"</span> : <span class="string">"Huang"</span>,</span><br><span class="line">    <span class="string">"gender"</span> : <span class="string">"Female"</span>,</span><br><span class="line">    <span class="string">"age"</span> : 23,</span><br><span class="line">    <span class="string">"courses"</span> : <span class="string">"Luo Ying Shen Jian Zhang"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><ul><li>直接PUT覆盖</li><li>使用<code>_update</code>API</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">"http://elasticsearch-1:9200/students/class1/2/_update?pretty"</span> \</span><br><span class="line">     -H <span class="string">"Accept: application/json"</span> \</span><br><span class="line">     -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "doc" : &#123;</span></span><br><span class="line"><span class="string">    "age" : 22</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span></span><br></pre></td></tr></table></figure><h1 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h1><h2 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="查询操作阶段"><a href="#查询操作阶段" class="headerlink" title="查询操作阶段"></a>查询操作阶段</h2><ul><li>分散阶段</li><li>合并阶段</li></ul><h2 id="查询方式"><a href="#查询方式" class="headerlink" title="查询方式"></a>查询方式</h2><ul><li>通过Restful API查询，查询参数见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-uri-request.html" target="_blank" rel="noopener">官方文档</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span></span><br></pre></td></tr></table></figure><ul><li>通过发送REST request body查询，查询参数见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-request-body.html" target="_blank" rel="noopener">官方文档</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配所有</span></span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配年龄</span></span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query":&#123;</span></span><br><span class="line"><span class="string">    "bool":&#123;</span></span><br><span class="line"><span class="string">      "must":[</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          "range":&#123;</span></span><br><span class="line"><span class="string">            "age":&#123;</span></span><br><span class="line"><span class="string">              "gt":"21",</span></span><br><span class="line"><span class="string">              "lt":"24"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="多索引、多类型查询"><a href="#多索引、多类型查询" class="headerlink" title="多索引、多类型查询"></a>多索引、多类型查询</h2><ul><li><code>_search</code>：所有索引</li><li><code>/INDEX_NAME/_search</code>：单索引</li><li><code>/INDEX1,INDEX2/_search</code>：多索引</li><li><code>/students/class1/_search</code>：单类型搜索</li><li><code>/students/class1,class2/_search</code>：多类型搜索</li></ul><h1 id="Mapping和Analysis"><a href="#Mapping和Analysis" class="headerlink" title="Mapping和Analysis"></a>Mapping和Analysis</h1><ul><li>Elasticsearch对每个文档，会取得所有域的所有值，生成一个名为<code>“_all”</code>的域</li><li>执行查询的时候，如果未指定<code>query_string</code>，则在<code>“_all”</code>域上执行查询操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在_all域搜索</span></span><br><span class="line">curl /_search?q=<span class="string">"Keyword"</span></span><br><span class="line"><span class="comment"># 在指定的FIELD_NAME这个域搜索</span></span><br><span class="line">curl /_search?q=FIELD_NAME:<span class="string">"Keyword"</span></span><br></pre></td></tr></table></figure><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/mapping-types.html" target="_blank" rel="noopener">官方文档</a></p><ul><li>array</li><li>binary</li><li>range</li><li>boolean</li><li>date</li><li>geo-point</li><li>geo-shape</li><li>IP</li><li>keyword</li><li>nested</li><li>numeric</li><li>object</li><li>text</li><li>token count</li><li>percolatro</li><li>join</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;cat-APIs&quot;&gt;&lt;a href=&quot;#cat-APIs&quot; class=&quot;headerlink&quot; title=&quot;_cat APIs&quot;&gt;&lt;/a&gt;_cat APIs&lt;/h1&gt;&lt;p&gt;通过访问elasticsearch集群的&lt;code&gt;/_cat&lt;/code&gt;可以获取很多
      
    
    </summary>
    
    
      <category term="elasticsearch" scheme="https://luanlengli.github.io/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-5.6.x安装配置</title>
    <link href="https://luanlengli.github.io/2019/02/21/Elasticsearch-5-6-x%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE.html"/>
    <id>https://luanlengli.github.io/2019/02/21/Elasticsearch-5-6-x安装配置.html</id>
    <published>2019-02-21T09:57:55.000Z</published>
    <updated>2019-05-21T03:15:10.572Z</updated>
    
    <content type="html"><![CDATA[<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><h2 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS-7"></a>CentOS-7</h2><p>准备两台服务器，做elasticsearch集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="hosts静态解析"><a href="#hosts静态解析" class="headerlink" title="hosts静态解析"></a>hosts静态解析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.201 elasticsearch-1</span><br><span class="line">172.16.80.202 elasticsearch-2</span><br></pre></td></tr></table></figure><h2 id="Oracle-JDK-8u201"><a href="#Oracle-JDK-8u201" class="headerlink" title="Oracle JDK-8u201"></a>Oracle JDK-8u201</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换工作目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="comment"># 下载JDK并解压</span></span><br><span class="line">wget --no-check-certificate \</span><br><span class="line">     -O - \</span><br><span class="line">     -c \</span><br><span class="line">     --header <span class="string">"Cookie: oraclelicense=accept-securebackup-cookie"</span> <span class="string">"https://download.oracle.com/otn-pub/java/jdk/8u201-b09/42970487e3af4f5aa5bca3f542482c60/jdk-8u201-linux-x64.tar.gz"</span> \</span><br><span class="line">     | tar xz </span><br><span class="line"><span class="comment"># 创建软链接</span></span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/jdk1.8.0_201 /usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">cat &gt; /etc/profile.d/java.sh &lt;&lt;EOF</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span> </span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/java.sh</span><br></pre></td></tr></table></figure><h2 id="创建elasticsearch用户"><a href="#创建elasticsearch用户" class="headerlink" title="创建elasticsearch用户"></a>创建elasticsearch用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd esuser</span><br></pre></td></tr></table></figure><h2 id="修改limits"><a href="#修改limits" class="headerlink" title="修改limits"></a>修改limits</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/esuser.conf &lt;&lt;EOF</span><br><span class="line">esuser  -  nofile  262144</span><br><span class="line">esuser  -  memlock unlimited</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br><span class="line">cat &gt; /etc/sysctl.d/elasticsearch.conf &lt;&lt;EOF</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"><span class="comment"># 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="安装elasticsearch"><a href="#安装elasticsearch" class="headerlink" title="安装elasticsearch"></a>安装elasticsearch</h1><h2 id="下载elasticsearch"><a href="#下载elasticsearch" class="headerlink" title="下载elasticsearch"></a>下载elasticsearch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.15.tar.gz</span><br><span class="line">tar xzf elasticsearch-5.6.15.tar.gz</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/elasticsearch-5.6.15 /usr/<span class="built_in">local</span>/elasticsearch</span><br><span class="line">chown -R esuser:esuser /usr/<span class="built_in">local</span>/elasticsearch /usr/<span class="built_in">local</span>/elasticsearch-5.6.15</span><br></pre></td></tr></table></figure><h2 id="配置elasticsearch"><a href="#配置elasticsearch" class="headerlink" title="配置elasticsearch"></a>配置elasticsearch</h2><ul><li>修改<code>config/elasticsearch.yml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义节点名字</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">elasticsearch-1</span></span><br><span class="line"><span class="comment"># 定义数据目录</span></span><br><span class="line"><span class="string">path.data:</span> <span class="string">/home/esuser/data</span></span><br><span class="line"><span class="comment"># 定义日志目录</span></span><br><span class="line"><span class="string">path.logs:</span> <span class="string">/home/esuser/logs</span></span><br><span class="line"><span class="comment"># 定义节点为master</span></span><br><span class="line"><span class="string">node.master</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 定义节点为data</span></span><br><span class="line"><span class="string">node.data</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 启动时锁定内存，避免内存被系统swap</span></span><br><span class="line"><span class="comment"># 看情况开启，默认是关闭的</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment"># 定义监听端口</span></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment"># 定义服务端口</span></span><br><span class="line"><span class="string">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment"># 定义单播主机</span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">elasticsearch-1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">elasticsearch-2</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure><ul><li>修改<code>config/jvm.options</code></li></ul><blockquote><p>这里只需要修改<code>-Xms</code>和<code>-Xmx</code>，默认是2g，最大不超过32g，两个选项的值保持一致</p></blockquote><ul><li>设置elasticsearch系统变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /home/esuser/elasticsearch &lt;&lt;EOF</span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>添加PATH</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/profile.d/elasticsearch.sh &lt;&lt;EOF</span><br><span class="line"><span class="built_in">export</span> ES_HOME=<span class="string">"/usr/local/elasticsearch"</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$ES_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><ul><li>创建systemd服务脚本</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=ElasticSearch Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/home/esuser/elasticsearch</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/elasticsearch/bin/elasticsearch</span><br><span class="line">PIDFile=/usr/<span class="built_in">local</span>/elasticsearch/run/elasticsearch.pid</span><br><span class="line">User=esuser</span><br><span class="line">LimitNOFILE=262144</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure><h1 id="启动elasticsearch"><a href="#启动elasticsearch" class="headerlink" title="启动elasticsearch"></a>启动elasticsearch</h1><ul><li>通过systemd命令启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now elasticsearch</span><br></pre></td></tr></table></figure><ul><li>命令行启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c <span class="string">"/usr/local/elasticsearch/bin/elasticsearch -d"</span> esuser</span><br></pre></td></tr></table></figure><ul><li>访问elasticsearch</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9200/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"JN0WSrAZQo2qWCaZrbDGjg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"5.6.15"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"fe7575a"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2019-02-13T16:21:45.880Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"6.6.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="安装elasticsearch-head"><a href="#安装elasticsearch-head" class="headerlink" title="安装elasticsearch-head"></a>安装elasticsearch-head</h1><ul><li>直接用容器启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=host --restart=always -d --name elasticsearch-head mobz/elasticsearch-head:5-alpine</span><br></pre></td></tr></table></figure><ul><li>访问elasticsearch-head</li></ul><p><code>curl -I http://127.0.0.1:9100</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a&gt;系统环境&lt;/h1&gt;&lt;h2 id=&quot;CentOS-7&quot;&gt;&lt;a href=&quot;#CentOS-7&quot; class=&quot;headerlink&quot; title=&quot;C
      
    
    </summary>
    
    
      <category term="Elasticsearch" scheme="https://luanlengli.github.io/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Linux运维常见面试题</title>
    <link href="https://luanlengli.github.io/2019/02/14/Linux%E8%BF%90%E7%BB%B4%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98.html"/>
    <id>https://luanlengli.github.io/2019/02/14/Linux运维常见面试题.html</id>
    <published>2019-02-14T02:07:19.000Z</published>
    <updated>2019-02-15T02:36:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="LINUX系统软件安装和卸载的常见方法"><a href="#LINUX系统软件安装和卸载的常见方法" class="headerlink" title="LINUX系统软件安装和卸载的常见方法"></a><strong>LINUX系统软件安装和卸载的常见方法</strong></h2><ul><li><p>RHEL/CentOS系列</p><ul><li><p><code>rpm -e &quot;软件包名字&quot;</code></p></li><li><p><code>yum remove &quot;软件包名字&quot;</code>，此操作会卸载相关的依赖</p></li></ul></li><li><p>Debian/Ubuntu系列</p><ul><li><code>apt-get remove &quot;软件包名字&quot;</code>，不删除依赖，保留配置文件</li><li><code>apt-get autoremove &quot;软件包名字&quot;</code>，删除依赖，保留配置文件</li><li><code>apt-get purge &quot;软件包名字&quot;</code>，不删除依赖，删除配置文件</li></ul></li><li><p>源代码安装的，可以使用<code>make uninstall</code>，或者直接删掉软件目录</p></li></ul><h2 id="修改LINUX的主机名"><a href="#修改LINUX的主机名" class="headerlink" title="修改LINUX的主机名"></a><strong>修改LINUX的主机名</strong></h2><ul><li>RHEL/CentOS系列<ul><li><code>hostnamectl set-hostname &quot;主机名&quot;</code></li><li>修改<code>/etc/sysconfig/network</code>里面的<code>HOSTNAME</code></li></ul></li><li>Debian/Ubuntu系列<ul><li>修改<code>/etc/hosts</code>和<code>/etc/hostname</code>的主机名，然后运行<code>/etc/init.d/hostname.sh start</code></li></ul></li><li>临时有效<ul><li><code>hostname &quot;主机名&quot;</code></li></ul></li></ul><h2 id="自动切割压缩备份日志脚本"><a href="#自动切割压缩备份日志脚本" class="headerlink" title="自动切割压缩备份日志脚本"></a><strong>自动切割压缩备份日志脚本</strong></h2><ul><li>每天凌晨5点执行，带日期后缀</li><li>以Nginx日志为例</li><li>切割打包压缩前一天的日志之后，将压缩包上传到FTP服务器<code>192.168.1.2</code>账号<code>aaa</code>密码<code>bbb</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">LOG_PATH=<span class="string">'/path/to/nginx_log/'</span></span><br><span class="line">DATE=`date +%F`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让Nginx切割日志</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `ls | grep *<span class="built_in">log</span>`;<span class="keyword">do</span></span><br><span class="line">    mv <span class="variable">$&#123;file&#125;</span> <span class="variable">$&#123;file&#125;</span>.<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">nginx -s reopen</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包文件</span></span><br><span class="line">tar nginx_log_<span class="variable">$&#123;DATE&#125;</span>.tar.gz `ls *<span class="variable">$&#123;DATE&#125;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理日志文件</span></span><br><span class="line">rm -rf *<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line">ftp -n &lt;&lt;- EOF</span><br><span class="line">open 192.168.1.2</span><br><span class="line">user aaa bbb</span><br><span class="line">put nginx_log_<span class="variable">$&#123;DATE&#125;</span>.tar.gz</span><br><span class="line"><span class="built_in">bye</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除过期文件</span></span><br><span class="line">find <span class="variable">$&#123;LOG_PATH&#125;</span> -<span class="built_in">type</span> f -mtime +60 -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 5 * * * /bin/bash /path/to/logrotate.sh</span><br></pre></td></tr></table></figure><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a><strong>iptables</strong></h2><p><strong>允许来自127.0.0.1端口1234访问114.114.114.114端口80</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 127.0.0.1 --sport 1234 -d 114.114.114.114 --dport 80 -j ACCPET</span><br></pre></td></tr></table></figure><p><strong>禁用从lo进入的流量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j REJECT</span><br></pre></td></tr></table></figure><p><strong>允许外部访问22端口</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCPET</span><br></pre></td></tr></table></figure><p><strong>在postrouting链上，把源地址192.168.2.0/24的数据包源地址修改为192.168.1.2</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.2.0/24 -j SNAT --to-source 192.168.1.2</span><br></pre></td></tr></table></figure><p><strong>删除INPUT链上第八条规则</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -Ln --line-numbers</span><br><span class="line">iptables -D INPUT 8</span><br></pre></td></tr></table></figure><p><strong>eth0的数据包转发到eth1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT</span><br></pre></td></tr></table></figure><p><strong>iptables匹配参数</strong></p><ul><li><code>-A</code>：在chain里追加规则</li><li><code>-D</code>：删除chain里的规则</li><li><code>-I</code>：将规则插入到chain</li><li><code>-t</code>：指定表</li><li><code>-s</code>：匹配源地址</li><li><code>-d</code>：匹配目的地址</li><li><code>-p</code>：协议匹配</li><li><code>-i</code>：入口匹配</li><li><code>-o</code>：出口匹配</li><li><code>--sport</code>：源端口匹配</li><li><code>--dport</code>：出口端口匹配</li><li><code>-j</code>：数据包处理动作</li><li><code>!</code>：取反</li></ul><h2 id="iptables基本概念"><a href="#iptables基本概念" class="headerlink" title="iptables基本概念"></a>iptables基本概念</h2><h3 id="table"><a href="#table" class="headerlink" title="table"></a>table</h3><ul><li><code>raw</code> 用于配置数据包，<code>raw</code> 中的数据包不会被系统跟踪</li><li><code>filter</code> 是用于存放所有与防火墙相关操作的默认表</li><li><code>nat</code> 用于 网络地址转换（例如：端口转发）</li><li><code>mangle</code> 用于对特定数据包的修改</li><li><code>security</code> 用于 强制访问控制网络规则（例如： SELinux）</li></ul><h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                             XXX     Network    XXX</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                                       +</span><br><span class="line">                                       |</span><br><span class="line">                                       v</span><br><span class="line"> +-------------+              +------------------+</span><br><span class="line"> |table: filter| &lt;---+        | table: nat       |</span><br><span class="line"> |chain: INPUT |     |        | chain: PREROUTING|</span><br><span class="line"> +-----+-------+     |        +--------+---------+</span><br><span class="line">       |             |                 |</span><br><span class="line">       v             |                 v</span><br><span class="line"> [<span class="built_in">local</span> process]     |           ****************          +--------------+</span><br><span class="line">       |             +---------+ Routing decision +------&gt; |table: filter |</span><br><span class="line">       v                         ****************          |chain: FORWARD|</span><br><span class="line">****************                                           +------+-------+</span><br><span class="line">Routing decision                                                  |</span><br><span class="line">****************                                                  |</span><br><span class="line">       |                                                          |</span><br><span class="line">       v                        ****************                  |</span><br><span class="line">+-------------+       +------&gt;  Routing decision  &lt;---------------+</span><br><span class="line">|table: nat   |       |         ****************</span><br><span class="line">|chain: OUTPUT|       |               +</span><br><span class="line">+-----+-------+       |               |</span><br><span class="line">      |               |               v</span><br><span class="line">      v               |      +-------------------+</span><br><span class="line">+--------------+      |      | table: nat        |</span><br><span class="line">|table: filter | +----+      | chain: POSTROUTING|</span><br><span class="line">|chain: OUTPUT |             +--------+----------+</span><br><span class="line">+--------------+                      |</span><br><span class="line">                                      v</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                             XXX    Network     XXX</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure><h2 id="统计TCP连接状态"><a href="#统计TCP连接状态" class="headerlink" title="统计TCP连接状态"></a>统计TCP连接状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an|awk <span class="string">'/tcp/ &#123;print $6&#125;'</span>|sort|uniq -c</span><br></pre></td></tr></table></figure><h2 id="列出每个IP的TCP连接数"><a href="#列出每个IP的TCP连接数" class="headerlink" title="列出每个IP的TCP连接数"></a><strong>列出每个IP的TCP连接数</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -n | awk <span class="string">'/^tcp/ &#123;print $5&#125;'</span> | awk -F: <span class="string">'&#123;print $1&#125;'</span> | sort | uniq -c | sort -rn</span><br></pre></td></tr></table></figure><h2 id="生成随机字符串"><a href="#生成随机字符串" class="headerlink" title="生成随机字符串"></a><strong>生成随机字符串</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 20</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/urandom bs=128 count=1 2&gt;/dev/null | base64 | tr -d <span class="string">"=+/[:space:]"</span> | dd bs=32 count=1 2&gt;/dev/null</span><br></pre></td></tr></table></figure><h2 id="描述tcp三次握手的过程"><a href="#描述tcp三次握手的过程" class="headerlink" title="描述tcp三次握手的过程"></a><strong>描述tcp三次握手的过程</strong></h2><p>第一次握手：建立连接时，客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；</p><p>第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器 进入SYN_RECV状态；</p><p>第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入 ESTABLISHED状态，完成三次握手。</p><h2 id="内核参数的含义"><a href="#内核参数的含义" class="headerlink" title="内核参数的含义"></a><strong>内核参数的含义</strong></h2><ul><li><code>net.ipv4.tcp_tw_recycle=1</code><ul><li>启用此功能可以加快TIME-WAIT状态的TCP连接回收</li><li>内核会记录最后一个报文的时间戳，如果新的TCP报文时间戳小于最后一个报文的时间戳，则会drop包，导致无法建立TCP连接</li></ul></li><li><code>net.ipv4.tcp_tw_reuse=1</code><ul><li>允许将处于TIME-WAIT状态的socket用于新的TCP连接</li></ul></li><li><code>net.ipv4.tcp_timestamps=1</code><ul><li>发送TCP时间戳</li></ul></li><li><code>vm.swappiness=0</code><ul><li>最大限度使用物理内存，物理内存耗尽才启用swap</li></ul></li></ul><h2 id="Linux开机启动顺序"><a href="#Linux开机启动顺序" class="headerlink" title="Linux开机启动顺序"></a><strong>Linux开机启动顺序</strong></h2><p>以<code>BIOS-based</code>和<code>RHEL/CentOS-7</code>为例</p><ul><li>硬件加电</li><li>加载BIOS</li><li>硬件自检</li><li>BIOS按照启动顺序读取存储设备的MBR</li><li>根据MBR找到并加载bootloader</li><li>bootloader从<code>/boot</code>目录加载<code>vmlinuz</code>内核镜像，提取<code>initramfs</code>的内容并存放在<code>tmpfs</code>中</li><li>操作系统内核从<code>initramfs</code>中加载必要的驱动和挂载根文件系统，启动<code>systemd</code>作为第一个系统进程</li><li>systemd读取配置文件，读取<code>default-target</code>文件，引导至<code>default-target</code>定义的状态<ul><li>初始化网络</li><li>设置主机名</li><li>基于内核参数初始化硬件设备</li><li>加载文件系统</li><li>启动systemd服务</li></ul></li><li>启动完成</li></ul><h2 id="ps-aux中VSZ和RSS的含义"><a href="#ps-aux中VSZ和RSS的含义" class="headerlink" title="ps aux中VSZ和RSS的含义"></a>ps aux中VSZ和RSS的含义</h2><ul><li>VSZ：虚拟内存集，代表进程占用的虚拟内存空间</li><li>RSS：物理内存集，代表进程实际占用的物理内存空间</li></ul><h2 id="top命令中字段的含义"><a href="#top命令中字段的含义" class="headerlink" title="top命令中字段的含义"></a>top命令中字段的含义</h2><ul><li>PID：进程ID</li><li>USER：进程所有者的用户名</li><li>PR：进程优先级</li><li>NI：nice值，数值越小，优先级越高</li><li>VIRT：虚拟内存集，代表进程占用的虚拟内存空间</li><li>RES：物理内存集，代表进程实际占用的物理内存空间</li><li>SHR：共享内存大小</li><li>S：进程状态</li><li>%CPU：CPU时间占比</li><li>%MEM：物理内存占比</li><li>TIME+：进程使用的CPU时间总量</li><li>COMMAND：进程命令</li></ul><h2 id="load-average含义"><a href="#load-average含义" class="headerlink" title="load average含义"></a>load average含义</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load average: 0.00, 0.00, 0.00</span><br></pre></td></tr></table></figure><ul><li>分别代表1分钟内、5分钟内、15分钟内系统的平均负载</li><li>系统负载指的是运行队列的长度，即等待CPU的平均进程数</li><li>因此<code>load average的值=CPU核数</code>是最理想的状态</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;LINUX系统软件安装和卸载的常见方法&quot;&gt;&lt;a href=&quot;#LINUX系统软件安装和卸载的常见方法&quot; class=&quot;headerlink&quot; title=&quot;LINUX系统软件安装和卸载的常见方法&quot;&gt;&lt;/a&gt;&lt;strong&gt;LINUX系统软件安装和卸载的常见方法&lt;/
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>kubectl命令的用法</title>
    <link href="https://luanlengli.github.io/2019/02/12/kubectl%E5%91%BD%E4%BB%A4%E7%9A%84%E7%94%A8%E6%B3%95.html"/>
    <id>https://luanlengli.github.io/2019/02/12/kubectl命令的用法.html</id>
    <published>2019-02-12T07:10:40.000Z</published>
    <updated>2019-06-18T09:40:11.877Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h1 id="命令介绍"><a href="#命令介绍" class="headerlink" title="命令介绍"></a>命令介绍</h1><h2 id="获取帮助"><a href="#获取帮助" class="headerlink" title="获取帮助"></a>获取帮助</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --help</span><br></pre></td></tr></table></figure><h2 id="查看集群信息"><a href="#查看集群信息" class="headerlink" title="查看集群信息"></a>查看集群信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info</span><br></pre></td></tr></table></figure><h2 id="指定kubeconfig"><a href="#指定kubeconfig" class="headerlink" title="指定kubeconfig"></a>指定kubeconfig</h2><p>默认是当前用户家目录下的<code>~/.kube/config</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --config /path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="kubeconfig上下文配置"><a href="#kubeconfig上下文配置" class="headerlink" title="kubeconfig上下文配置"></a>kubeconfig上下文配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看kubeconfig信息</span></span><br><span class="line">kubectl config view</span><br><span class="line"><span class="comment"># 合并多个kubeconfig文件并查看合并后的kubeconfig信息</span></span><br><span class="line">KUBECONFIG=~/.kube/config:~/.kube/kubconfig2 kubectl config view</span><br><span class="line"><span class="comment"># 显示当前上下文</span></span><br><span class="line">kubectl config current-context</span><br><span class="line"><span class="comment"># 设置默认上下文为cluster-name</span></span><br><span class="line">kubectl config use-context cluster-name</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="指定命名空间"><a href="#指定命名空间" class="headerlink" title="指定命名空间"></a>指定命名空间</h2><p>默认命名空间是<code>default</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --namespace kube-system</span><br><span class="line">kubectl -n kube-system</span><br></pre></td></tr></table></figure><h2 id="指定所有命名空间"><a href="#指定所有命名空间" class="headerlink" title="指定所有命名空间"></a>指定所有命名空间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl --all-namespaces</span><br></pre></td></tr></table></figure><h2 id="指定输出格式"><a href="#指定输出格式" class="headerlink" title="指定输出格式"></a>指定输出格式</h2><p>默认不带任何输出参数时，是以较短结果输出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">kubectl get pod --output=wide</span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">kubectl get pod -o json</span><br><span class="line">kubectl get pod -o yaml</span><br></pre></td></tr></table></figure><h2 id="输出结果排序"><a href="#输出结果排序" class="headerlink" title="输出结果排序"></a>输出结果排序</h2><p>默认是以Pod名字排序</p><p>可以通过指定<code>--sort-by</code>来做排序</p><p>例如让Pod以宿主机名称排序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system -o wide --sort-by="&#123;.spec.nodeName&#125;"</span><br><span class="line"></span><br><span class="line">输出样例</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-scheduler-k8s-master              1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-k8s-master                        1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-k8s-master              1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-k8s-master     1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-mqcft            1/1     Running   2          6d22h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-lhxv5                       1/1     Running   1          6d21h   172.16.80.200   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-86c58d9df4-wpk5p               1/1     Running   2          6d21h   10.244.1.10     k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">metrics-server-74845f6646-jqzcm        1/1     Running   2          6d21h   10.244.1.11     k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-xhd96            1/1     Running   2          6d22h   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-28tw2                       1/1     Running   1          6d21h   172.16.80.201   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-86c58d9df4-mbbxm               1/1     Running   2          6d21h   10.244.2.11     k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-t77hm                       1/1     Running   1          6d21h   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-57df4db6b-gk67k   1/1     Running   2          6d21h   10.244.2.13     k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-2rhs4            1/1     Running   2          6d22h   172.16.80.202   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">tiller-deploy-5b4c9697bf-q5dh6         1/1     Running   2          6d21h   10.244.2.12     k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="测试yaml文件，实际不生效"><a href="#测试yaml文件，实际不生效" class="headerlink" title="测试yaml文件，实际不生效"></a>测试yaml文件，实际不生效</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f demo.yaml --dry-run</span><br></pre></td></tr></table></figure><h2 id="生成模板文件"><a href="#生成模板文件" class="headerlink" title="生成模板文件"></a>生成模板文件</h2><p>yaml文件内容字段比较多，很难一下子想到所需的字段，可以通过kubectl命令来生成对应的模板</p><p>下面以deployment为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get deployment coredns -o yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: "1"</span><br><span class="line">  creationTimestamp: "2019-03-18T03:46:22Z"</span><br><span class="line">  generation: 1</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: "8560"</span><br><span class="line">  selfLink: /apis/extensions/v1beta1/namespaces/kube-system/deployments/coredns</span><br><span class="line">  uid: 65e22088-4930-11e9-93e0-00505634ce7c</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 2</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - -conf</span><br><span class="line">        - /etc/coredns/Corefile</span><br><span class="line">        image: k8s.gcr.io/coredns:1.2.6</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        name: coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 170Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          procMount: Default</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/coredns</span><br><span class="line">          name: config-volume</span><br><span class="line">          readOnly: true</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">      securityContext: &#123;&#125;</span><br><span class="line">      serviceAccount: coredns</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: CriticalAddonsOnly</span><br><span class="line">        operator: Exists</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/master</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - key: Corefile</span><br><span class="line">            path: Corefile</span><br><span class="line">          name: coredns</span><br><span class="line">        name: config-volume</span><br><span class="line">status:</span><br><span class="line">  availableReplicas: 2</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: "2019-03-18T03:46:37Z"</span><br><span class="line">    lastUpdateTime: "2019-03-18T03:51:36Z"</span><br><span class="line">    message: ReplicaSet "coredns-86c58d9df4" has successfully progressed.</span><br><span class="line">    reason: NewReplicaSetAvailable</span><br><span class="line">    status: "True"</span><br><span class="line">    type: Progressing</span><br><span class="line">  - lastTransitionTime: "2019-03-18T05:13:16Z"</span><br><span class="line">    lastUpdateTime: "2019-03-18T05:13:16Z"</span><br><span class="line">    message: Deployment has minimum availability.</span><br><span class="line">    reason: MinimumReplicasAvailable</span><br><span class="line">    status: "True"</span><br><span class="line">    type: Available</span><br><span class="line">  observedGeneration: 1</span><br><span class="line">  readyReplicas: 2</span><br><span class="line">  replicas: 2</span><br><span class="line">  updatedReplicas: 2</span><br></pre></td></tr></table></figure><h2 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a>创建资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除指定yaml定义的资源</span></span><br><span class="line">kubectl apply -f /path/to/yaml</span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">kubectl delete pod busybox</span><br><span class="line"><span class="comment"># 删除带k8s-app: busybox标签的pod</span></span><br><span class="line">kubectl delete pod -l k8s-app=busybox</span><br><span class="line"><span class="comment"># 删除所有pod</span></span><br><span class="line">kubectl delete pod --all</span><br></pre></td></tr></table></figure><h2 id="编辑资源"><a href="#编辑资源" class="headerlink" title="编辑资源"></a>编辑资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑名为CoreDNS的configmaps</span></span><br><span class="line">kubectl edit -n kube-system configmaps coredns</span><br><span class="line"><span class="comment"># 设置kube的编辑器</span></span><br><span class="line">KUBE_EDITOR=<span class="string">"nano"</span> kubectl edit configmaps coredns</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;h1 id=&quot;命令介绍&quot;&gt;&lt;a href=&quot;#命令介绍&quot; class=&quot;headerlink&quot; title=&quot;命令介绍&quot;&gt;&lt;/a&gt;命令介绍&lt;/h
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>如何生成kubeconfig文件</title>
    <link href="https://luanlengli.github.io/2019/02/12/%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90kubeconfig%E6%96%87%E4%BB%B6.html"/>
    <id>https://luanlengli.github.io/2019/02/12/如何生成kubeconfig文件.html</id>
    <published>2019-02-12T06:56:58.000Z</published>
    <updated>2019-06-18T09:40:55.139Z</updated>
    
    <content type="html"><![CDATA[<h2 id="修改cluster"><a href="#修改cluster" class="headerlink" title="修改cluster"></a>修改cluster</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-cluster CLUSTER_NAME \</span><br><span class="line">--certificate-authority=/path/to/ca \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=KUBE_APISERVER \</span><br><span class="line">--kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="修改user"><a href="#修改user" class="headerlink" title="修改user"></a>修改user</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials USERNAME \</span><br><span class="line">--client-certificate=/path/to/cert \</span><br><span class="line">--client-key=/path/to/key \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="修改context"><a href="#修改context" class="headerlink" title="修改context"></a>修改context</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context CONTEXT \</span><br><span class="line">--cluster=CLUSTER_NAME \</span><br><span class="line">--user=USERNAME \</span><br><span class="line">--kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure><h2 id="设置默认context"><a href="#设置默认context" class="headerlink" title="设置默认context"></a>设置默认context</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context CONTEXT --kubeconfig=/path/to/kubeconfig</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;修改cluster&quot;&gt;&lt;a href=&quot;#修改cluster&quot; class=&quot;headerlink&quot; title=&quot;修改cluster&quot;&gt;&lt;/a&gt;修改cluster&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes TLS Bootstrap与节点证书签发</title>
    <link href="https://luanlengli.github.io/2019/02/04/kubernetes-TLS-Bootstrap%E4%B8%8E%E8%8A%82%E7%82%B9%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%8F%91.html"/>
    <id>https://luanlengli.github.io/2019/02/04/kubernetes-TLS-Bootstrap与节点证书签发.html</id>
    <published>2019-02-04T05:03:18.000Z</published>
    <updated>2019-06-18T09:40:30.773Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Bootstrap初始化流程"><a href="#Bootstrap初始化流程" class="headerlink" title="Bootstrap初始化流程"></a>Bootstrap初始化流程</h1><blockquote><p>参考<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/" target="_blank" rel="noopener">官方文档</a></p></blockquote><ol><li>kubelet启动</li><li>kubelet发现没有<code>kubeconfig</code>文件</li><li>kubelet查找<code>bootstrap-kubeconfig</code>文件</li><li>kubelet读取<code>bootstrap-kubeconfig</code>文件，获取kube-apiserver的URL和最低权限的<code>token</code></li><li>kubelet具备了创建和检索CSR请求的受限<code>token</code></li><li>kubelet使用此<code>token</code>作为凭证与kube-apiserver通信</li><li>kubelet使用<code>bootstrap-kubeconfig</code>的CA证书为自己创建CSR（nodeclient）</li><li>CSR可以通过两种方式获得批准，批准之后下发证书（kubelet-client.crt）<ol><li>配置kube-controller-manager自动批准CSR</li><li>配置外部流程去通过kubernetes API或者kubectl去批准CSR</li></ol></li><li>kubelet使用密钥和证书创建kubeconfig文件</li><li>kubelet开始正常启动流程</li><li>可选：<ol><li>当证书接近到期时，kubelet会自动请求续订证书</li><li>证书的续订自动签发，可以参考CSR批准证书的过程</li></ol></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Bootstrap初始化流程&quot;&gt;&lt;a href=&quot;#Bootstrap初始化流程&quot; class=&quot;headerlink&quot; title=&quot;Bootstrap初始化流程&quot;&gt;&lt;/a&gt;Bootstrap初始化流程&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;参考&lt;a href=
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://luanlengli.github.io/tags/Kubernetes/"/>
    
  </entry>
  
</feed>
