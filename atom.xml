<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>luanlengli&#39;s Blog</title>
  
  <subtitle>“不知道”的五大理由，不读，不查，不试，理解能力差，满脑子想着怎么利用他人</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://luanlengli.github.io/"/>
  <updated>2019-05-20T07:52:53.471Z</updated>
  <id>https://luanlengli.github.io/</id>
  
  <author>
    <name>乱愣黎</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Prometheus搭建简单的监控告警系统</title>
    <link href="https://luanlengli.github.io/2019/05/01/Prometheus%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E7%B3%BB%E7%BB%9F.html"/>
    <id>https://luanlengli.github.io/2019/05/01/Prometheus搭建简单的监控告警系统.html</id>
    <published>2019-05-01T02:26:45.000Z</published>
    <updated>2019-05-20T07:52:53.471Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Prometheus搭建简单的监控告警系统"><a href="#Prometheus搭建简单的监控告警系统" class="headerlink" title="Prometheus搭建简单的监控告警系统"></a>Prometheus搭建简单的监控告警系统</h1><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><p>仅用于记录部署过程</p><p>告警通知对接了邮件和钉钉机器人</p></blockquote><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote><p>在监控告警系统主机上安装prometheus、alertmanager和grafana</p><p>被监控的主机安装各种各样的exporter，每个exporter只监控自身的服务状态</p></blockquote><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus配置目录</span></span><br><span class="line">mkdir -p /etc/prometheus /etc/prometheus/rules.d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建prometheus用户</span></span><br><span class="line">useradd prometheus</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改属主属组</span></span><br><span class="line">chown -R prometheus:prometheus /etc/prometheus</span><br></pre></td></tr></table></figure><h2 id="软件包"><a href="#软件包" class="headerlink" title="软件包"></a>软件包</h2><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><p><a href="https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz" target="_blank" rel="noopener">prometheus-v2.9.2</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz | tar xz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir -p /var/lib/prometheus</span><br><span class="line">chwon -R prometheus:prometheus /var/lib/prometheus</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件到对应位置</span></span><br><span class="line">cd prometheus-2.9.2.linux-amd64</span><br><span class="line">chown -R prometheus:prometheus prometheus promtool console_libraries consoles prometheus.yml</span><br><span class="line">mv prometheus promtool /usr/local/bin/</span><br><span class="line">mv console_libraries consoles prometheus.yml /etc/prometheus/</span><br></pre></td></tr></table></figure><h3 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h3><p><a href="https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz" target="_blank" rel="noopener">alertmanager-v0.17.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz | tar xz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir -p /var/lib/prometheus</span><br><span class="line">chwon -R prometheus:prometheus /var/lib/prometheus</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">cd alertmanager-0.17.0.linux-amd64</span><br><span class="line">chown -R prometheus:prometheus alertmanager alertmanager.yml amtool</span><br><span class="line">mv alertmanager amtool /usr/local/bin/</span><br><span class="line">mv alertmanager.yml /etc/prometheus</span><br></pre></td></tr></table></figure><h3 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h3><p><a href="https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz" target="_blank" rel="noopener">node_exporter-v0.18.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd node_exporter-0.18.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus node_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv node_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter"><a href="#mysqld-exporter" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p><a href="https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz" target="_blank" rel="noopener">mysqld_exporter-v0.11.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd mysqld_exporter-0.11.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus mysqld_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv mysqld_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter"><a href="#postgresql-exporter" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/wrouesnel/postgres_exporter/releases/download/v0.4.7/postgres_exporter_v0.4.7_linux-amd64.tar.gz | tar xz</span><br><span class="line">cd postgres_exporter_v0.4.7_linux-amd64</span><br><span class="line">chown prometheus:prometheus postgres_exporter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv postgres_exporter /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p><a href="https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz" target="_blank" rel="noopener">blackbox_exporter-v0.14.0</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载解压</span></span><br><span class="line">wget -O - https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz | tar xz</span><br><span class="line">cd blackbox_exporter-0.14.0.linux-amd64</span><br><span class="line">chown prometheus:prometheus blackbox_exporter blackbox.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件</span></span><br><span class="line">mv blackbox_exporter /usr/local/bin/</span><br><span class="line">mv blackbox.yml /etc/prometheus/</span><br></pre></td></tr></table></figure><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><p><a href="https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm" target="_blank" rel="noopener">grafana-v6.1.6</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line">wget https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm</span><br><span class="line">yum localinstall grafana-6.1.6-1.x86_64.rpm</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><p>/etc/prometheus/prometheus.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line"><span class="attr">  - static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span></span><br><span class="line"><span class="attr">      - localhost:</span><span class="number">9093</span></span><br><span class="line"><span class="attr">    scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules.d/*.rules</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9090</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9100</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">mysqld-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9104</span></span><br><span class="line"><span class="attr">- job_name:</span> <span class="string">postgresql-exporter</span></span><br><span class="line"><span class="attr">  honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">  metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  static_configs:</span></span><br><span class="line"><span class="attr">  - targets:</span></span><br><span class="line"><span class="attr">    - localhost:</span><span class="number">9187</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/host-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">host-status-rule</span></span><br><span class="line"><span class="attr">    rules:</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemSpaceUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">(node_filesystem_avail_bytes&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;)</span> <span class="string">)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 85</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统空间使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统空间使用率超过 85% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemInodeUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">(node_filesystem_files_free&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_files&#123;fstype=~"ext[234]|btrfs|xfs|zfs"&#125;)</span> <span class="string">)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统inode使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统inode使用率超过 80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeFilesystemReadOnly</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">node_filesystem_readonly&#123;job="node-exporter",device!~'rootfs'&#125;</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统只读状态"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 文件系统只读状态"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeMemoryUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(node_memory_MemTotal</span> <span class="bullet">-</span> <span class="string">(node_memory_MemFree+node_memory_Buffers+node_memory_Cached</span> <span class="string">))</span> <span class="string">/</span> <span class="string">node_memory_MemTotal</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 内存使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: 内存使用率过高超过80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">NodeCPUUsage</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode='idle',job="node-exporter"&#125;[1m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">))</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        team:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: CPU使用率过高"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>: CPU使用率超过80% (当前使用率: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/mysql-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">MySQLStatsAlert</span></span><br><span class="line"><span class="attr">    rules:</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">MySQL</span> <span class="string">is</span> <span class="string">down</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> MySQL is down"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"MySQL database is down. This requires immediate action!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">open</span> <span class="string">files</span> <span class="string">high</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_innodb_num_open_files</span> <span class="string">&gt; (mysql_global_variables_open_files_limit) * 0.75</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> open files high"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Open files is high. Please consider increasing open_files_limit."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Read</span> <span class="string">buffer</span> <span class="string">size</span> <span class="string">is</span> <span class="string">bigger</span> <span class="string">than</span> <span class="string">max.</span> <span class="string">allowed</span> <span class="string">packet</span> <span class="string">size</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_read_buffer_size</span> <span class="string">&gt; mysql_global_variables_slave_max_allowed_packet </span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Read buffer size is bigger than max. allowed packet size"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Read buffer size (read_buffer_size) is bigger than max. allowed packet size (max_allowed_packet).This can break your replication."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Sort</span> <span class="string">buffer</span> <span class="string">possibly</span> <span class="string">missconfigured</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_sort_buffer_size</span> <span class="string">&lt;256*1024</span> <span class="string">or</span> <span class="string">mysql_global_variables_read_buffer_size</span> <span class="string">&gt; 4*1024*1024 </span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Sort buffer possibly missconfigured"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Sort buffer size is either too big or too small. A good value for sort_buffer_size is between 256k and 4M."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Thread</span> <span class="string">stack</span> <span class="string">size</span> <span class="string">is</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_thread_stack</span> <span class="string">&lt;196608</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Thread stack size is too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Thread stack size is too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Used</span> <span class="string">more</span> <span class="string">than</span> <span class="number">80</span><span class="string">%</span> <span class="string">of</span> <span class="string">max</span> <span class="string">connections</span> <span class="string">limited</span> </span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_max_used_connections</span> <span class="string">&gt; mysql_global_variables_max_connections * 0.8</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Used more than 80% of max connections limited"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Used more than 80% of max connections limited"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Force</span> <span class="string">Recovery</span> <span class="string">is</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_force_recovery</span> <span class="string">!=</span> <span class="number">0</span> </span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Force Recovery is enabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Force Recovery is enabled. This mode should be used for data recovery purposes only. It prohibits writing to the data."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Log</span> <span class="string">File</span> <span class="string">size</span> <span class="string">is</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_log_file_size</span> <span class="string">&lt;</span> <span class="number">16777216</span> </span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Log File size is too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"The InnoDB Log File size is possibly too small. Choosing a small InnoDB Log File size can have significant performance impacts."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Flush</span> <span class="string">Log</span> <span class="string">at</span> <span class="string">Transaction</span> <span class="string">Commit</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_innodb_flush_log_at_trx_commit</span> <span class="string">!=</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Flush Log at Transaction Commit"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Flush Log at Transaction Commit is set to a values != 1. This can lead to a loss of commited transactions in case of a power failure."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Table</span> <span class="string">definition</span> <span class="string">cache</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_open_table_definitions</span> <span class="string">&gt; mysql_global_variables_table_definition_cache</span></span><br><span class="line"><span class="string"></span><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Table definition cache too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Your Table Definition Cache is possibly too small. If it is much too small this can have significant performance impacts!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Table</span> <span class="string">open</span> <span class="string">cache</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_status_open_tables</span> <span class="string">&gt;mysql_global_variables_table_open_cache</span> <span class="string">*</span> <span class="number">99</span><span class="string">/100</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Table open cache too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Your Table Open Cache is possibly too small (old name Table Cache). If it is much too small this can have significant performance impacts!"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Thread</span> <span class="string">stack</span> <span class="string">size</span> <span class="string">is</span> <span class="string">possibly</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_thread_stack</span> <span class="string">&lt;</span> <span class="number">262144</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Thread stack size is possibly too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Thread stack size is possibly too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">InnoDB</span> <span class="string">Plugin</span> <span class="string">is</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_ignore_builtin_innodb</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> InnoDB Plugin is enabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"InnoDB Plugin is enabled"</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binary</span> <span class="string">Log</span> <span class="string">is</span> <span class="string">disabled</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_log_bin</span> <span class="string">!=</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binary Log is disabled"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binary Log is disabled. This prohibits you to do Point in Time Recovery (PiTR)."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binlog</span> <span class="string">Cache</span> <span class="string">size</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_binlog_cache_size</span> <span class="string">&lt;</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binlog Cache size too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binlog Cache size is possibly to small. A value of 1 Mbyte or higher is OK."</span></span><br><span class="line"><span class="attr">    - alert:</span> <span class="string">Binlog</span> <span class="string">Transaction</span> <span class="string">Cache</span> <span class="string">size</span> <span class="string">too</span> <span class="string">small</span></span><br><span class="line"><span class="attr">      expr:</span> <span class="string">mysql_global_variables_binlog_cache_size</span>  <span class="string">&lt;</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">      for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> Binlog Transaction Cache size too small"</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">"Binlog Transaction Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK."</span></span><br></pre></td></tr></table></figure><p>/etc/prometheus/rules.d/postgresql-status.rules</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">PostgreSQL-Status-Alert</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">########## EXPORTER RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGExporterScrapeError</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">pg_exporter_last_scrape_error</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Postgres Exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> (instance: <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>) is encountering scrape errors processing queries. Error count: ( <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> )'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">NodeExporterScrapeError</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_textfile_scrape_error</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span> </span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Node Exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> (instance: <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>) is encountering scrape errors processing custom metrics.  Error count: ( <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> )'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## POSTGRESQL RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIsUp</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">pg_up</span> <span class="string">&lt;</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'postgres_exporter running on <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is unable to communicate with the configured database'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whether a system switches from primary to replica or vice versa must be configured per named job.</span></span><br><span class="line"><span class="comment"># No way to tell what value a system is supposed to be without a rule expression for that specific system</span></span><br><span class="line"><span class="comment"># 2 to 1 means it changed from primary to replica. 1 to 2 means it changed from replica to primary</span></span><br><span class="line"><span class="comment"># Set this alert for each system that you want to monitor a recovery status change</span></span><br><span class="line"><span class="comment"># Below is an example for a target job called "Replica" and watches for the value to change above 1 which means it's no longer a replica</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGRecoveryStatusSwitch_Replica </span></span><br><span class="line"><span class="comment">#    expr: ccp_is_in_recovery_status&#123;job="Replica"&#125; &gt; 1 </span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      summary: '&#123;&#123; $labels.job &#125;&#125; has changed from replica to primary'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Absence alerts must be configured per named job, otherwise there's no way to know which job is down</span></span><br><span class="line"><span class="comment"># Below is an example for a target job called "Prod"</span></span><br><span class="line"><span class="comment">#  - alert: PGConnectionAbsent</span></span><br><span class="line"><span class="comment">#    expr: absent(ccp_connection_stats_max_connections&#123;job="Prod"&#125;)</span></span><br><span class="line"><span class="comment">#    for: 10s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      description: 'Connection metric is absent from target (Prod). Check that postgres_exporter can connect to PostgreSQL.'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIdleTxn</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_idle_in_txn_time</span> <span class="string">&gt; 300</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one session idle in transaction for over 5 minutes.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance idle transactions'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGIdleTxn</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_idle_in_txn_time</span> <span class="string">&gt; 900</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one session idle in transaction for over 15 minutes.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance idle transactions'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGQueryTime</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_query_time</span> <span class="string">&gt; 43200</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span> </span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one query running for over 12 hours.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Max Query Runtime'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGQueryTime</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_connection_stats_max_query_time</span> <span class="string">&gt; 86400 </span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one query running for over 1 day.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Max Query Runtime'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGConnPerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="number">100</span> <span class="string">*</span> <span class="string">(ccp_connection_stats_total</span> <span class="string">/</span> <span class="string">ccp_connection_stats_max_connections)</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is using 75% or more of available connections (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance connections'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGConnPerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="number">100</span> <span class="string">*</span> <span class="string">(ccp_connection_stats_total</span> <span class="string">/</span> <span class="string">ccp_connection_stats_max_connections)</span> <span class="string">&gt; 90 </span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is using 90% or more of available connections (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance connections'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGDBSize</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_database_size</span> <span class="string">&gt; 1.073741824e+11</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> over 100GB in size: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> bytes'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance size warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGDBSize</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_database_size</span> <span class="string">&gt; 2.68435456e+11</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> over 250GB in size: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span> bytes'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance size critical'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationByteLag</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_status_byte_lag</span> <span class="string">&gt; 5.24288e+07</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one replica lagging over 50MB behind.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance replica lag warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationByteLag</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_status_byte_lag</span> <span class="string">&gt; 1.048576e+08</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has at least one replica lagging over 100MB behind.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance replica lag warning'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGReplicationSlotsInactive</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_replication_slots_active</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has one or more inactive replication slots'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance inactive replication slot'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGXIDWraparound</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_wraparound</span> <span class="string">&gt; 50</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 50% towards transaction id wraparound.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> transaction id wraparound imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGXIDWraparound</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_wraparound</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 75% towards transaction id wraparound.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance transaction id wraparound imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGEmergencyVacuum</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_emergency_autovac</span> <span class="string">&gt; 75</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 75% towards emergency autovacuum processes beginning'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance emergency vacuum imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGEmergencyVacuum</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_transaction_wraparound_percent_towards_emergency_autovac</span> <span class="string">&gt; 90</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is over 90% towards emergency autovacuum processes beginning'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'PGSQL Instance emergency vacuum imminent'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGArchiveCommandStatus</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_archive_command_status_seconds_since_last_fail</span> <span class="string">&gt; 300</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">        severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">'PGSQL Instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has a recent failing archive command'</span></span><br><span class="line"><span class="attr">        summary:</span> <span class="string">'Seconds since the last recorded failure of the archive_command'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">PGSequenceExhaustion</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ccp_sequence_exhaustion_count</span> <span class="string">&gt; 0</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">        severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">        severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">        description:</span> <span class="string">'Count of sequences on instance <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at over 75% usage: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>. Run following query to see full sequence status: SELECT * FROM monitor.sequence_status() WHERE percent &gt;= 75'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## SYSTEM RULES ##########</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">ExporterDown</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">avg_over_time(up[5m])</span> <span class="string">&lt;</span> <span class="number">0.9</span> </span><br><span class="line"><span class="attr">    for:</span> <span class="number">10</span><span class="string">s</span> </span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Metrics exporter service for <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> running on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has been down at least 50% of the time for the last 5 minutes. Service may be flapping or down.'</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">'Prometheus Exporter Service Down'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskUsagePerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="number">100</span> <span class="string">*</span> <span class="string">sum(node_filesystem_avail_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;)</span> <span class="string">BY</span> <span class="string">(job,device))</span> <span class="string">&gt; 70</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Disk usage on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskUsagePerc</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="number">100</span> <span class="string">*</span> <span class="string">sum(node_filesystem_avail_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;)</span> <span class="string">BY</span> <span class="string">(job,device))</span> <span class="string">&gt; 85</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Disk usage on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">DiskFillPredict</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">predict_linear(node_filesystem_free_bytes&#123;device!~"tmpfs|by-uuid",fstype=~"xfs|ext"&#125;[1h],</span> <span class="number">4</span> <span class="string">*</span> <span class="number">3600</span><span class="string">)</span> <span class="string">&lt;</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'(EXPERIMENTAL) Disk <span class="template-variable">&#123;&#123; $labels.device &#125;&#125;</span> on target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is predicted to fill in 4 hrs based on current usage'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SystemLoad5m</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_load5</span> <span class="string">&gt; 5</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'System load for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is high (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SystemLoad5m</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">node_load5</span> <span class="string">&gt; 10</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'System load for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is high (<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">MemoryAvailable</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_Available_bytes)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes)</span> <span class="string">&lt;</span> <span class="number">25</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Memory available for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">MemoryAvailable</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_MemAvailable_bytes)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes)</span> <span class="string">&lt;</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Memory available for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SwapUsage</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_SwapFree_bytes</span> <span class="string">/</span> <span class="string">node_memory_SwapTotal_bytes)))</span> <span class="string">&gt; 60</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Swap usage for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">SwapUsage</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">(100</span> <span class="bullet">-</span> <span class="string">(100</span> <span class="string">*</span> <span class="string">(node_memory_SwapFree_byte</span> <span class="string">/</span> <span class="string">node_memory_SwapTotal_bytes)))</span> <span class="string">&gt; 80</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">1</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">system</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">      severity_num:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'Swap usage for target <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> is at <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########## PGBACKREST RULES ##########</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Uncomment and customize one or more of these rules to monitor your pgbackrest backups. </span></span><br><span class="line"><span class="comment"># Full backups are considered the equivalent of both differentials and incrementals since both are based on the last full</span></span><br><span class="line"><span class="comment">#   And differentials are considered incrementals since incrementals will be based off the last diff if one exists</span></span><br><span class="line"><span class="comment">#   This avoid false alerts, for example when you don't run diff/incr backups on the days that you run a full</span></span><br><span class="line"><span class="comment"># Stanza should also be set if different intervals are expected for each stanza. </span></span><br><span class="line"><span class="comment">#   Otherwise rule will be applied to all stanzas returned on target system if not set.</span></span><br><span class="line"><span class="comment"># Otherwise, all backups returned by the pgbackrest info command run from where the database exists will be checked</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Relevant metric names are: </span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_full_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_incr_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_diff_time_since_completion_seconds</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastCompletedFull_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_full_backup_time_since_completion_seconds&#123;stanza="main"&#125; &gt; 604800</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Full backup for stanza [main] on system &#123;&#123; $labels.job &#125;&#125; has not completed in the last week.'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastCompletedIncr_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_incr_backup_time_since_completion_seconds&#123;stanza="main"&#125; &gt; 86400</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Incremental backup for stanza [main] on system &#123;&#123; $labels.job &#125;&#125; has not completed in the last 24 hours.'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Runtime monitoring is handled with a single metric:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   ccp_backrest_last_runtime_backup_runtime_seconds</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Runtime monitoring should have the "backup_type" label set. </span></span><br><span class="line"><span class="comment">#   Otherwise the rule will apply to the last run of all backup types returned (full, diff, incr)</span></span><br><span class="line"><span class="comment"># Stanza should also be set if runtimes per stanza have different expected times</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastRuntimeFull_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_runtime_backup_runtime_seconds&#123;backup_type="full", stanza="main"&#125; &gt; 14400</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Expected runtime of full backup for stanza [main] has exceeded 4 hours'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackRestLastRuntimeDiff_main</span></span><br><span class="line"><span class="comment">#    expr: ccp_backrest_last_runtime_backup_runtime_seconds&#123;backup_type="diff", stanza="main"&#125; &gt; 3600</span></span><br><span class="line"><span class="comment">#    for: 60s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#       service: postgresql</span></span><br><span class="line"><span class="comment">#       severity: critical</span></span><br><span class="line"><span class="comment">#       severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#       summary: 'Expected runtime of diff backup for stanza [main] has exceeded 1 hour'</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## If the pgbackrest command fails to run, the metric disappears from the exporter output and the alert never fires. </span></span><br><span class="line"><span class="comment">## An absence alert must be configured explicitly for each target (job) that backups are being monitored.</span></span><br><span class="line"><span class="comment">## Checking for absence of just the full backup type should be sufficient (no need for diff/incr).</span></span><br><span class="line"><span class="comment">## Note that while the backrest check command failing will likely also cause a scrape error alert, the addition of this </span></span><br><span class="line"><span class="comment">## check gives a clearer answer as to what is causing it and that something is wrong with the backups.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - alert: PGBackrestAbsentFull_Prod</span></span><br><span class="line"><span class="comment">#    expr: absent(ccp_backrest_last_full_backup_time_since_completion_seconds&#123;job="Prod"&#125;)</span></span><br><span class="line"><span class="comment">#    for: 10s</span></span><br><span class="line"><span class="comment">#    labels:</span></span><br><span class="line"><span class="comment">#      service: postgresql</span></span><br><span class="line"><span class="comment">#      severity: critical</span></span><br><span class="line"><span class="comment">#      severity_num: 300</span></span><br><span class="line"><span class="comment">#    annotations:</span></span><br><span class="line"><span class="comment">#      description: 'Backup Full status missing for Prod. Check that pgbackrest info command is working on target system.'</span></span><br></pre></td></tr></table></figure><h3 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h3><p>/etc/prometheus/alertmanager.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  resolve_timeout:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">  http_config:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  smtp_from:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">  smtp_hello:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  smtp_smarthost:</span> <span class="string">smtp.example.com:465</span></span><br><span class="line"><span class="attr">  smtp_auth_username:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">  smtp_auth_password:</span> <span class="string">'这里写密码'</span></span><br><span class="line"><span class="attr">  smtp_require_tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  pagerduty_url:</span> <span class="attr">https://events.pagerduty.com/v2/enqueue</span></span><br><span class="line"><span class="attr">  hipchat_api_url:</span> <span class="attr">https://api.hipchat.com/</span></span><br><span class="line"><span class="attr">  opsgenie_api_url:</span> <span class="attr">https://api.opsgenie.com/</span></span><br><span class="line"><span class="attr">  wechat_api_url:</span> <span class="attr">https://qyapi.weixin.qq.com/cgi-bin/</span></span><br><span class="line"><span class="attr">  victorops_api_url:</span> <span class="attr">https://alert.victorops.com/integrations/generic/20131114/alert/</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="comment"># 这里配置默认路由到'default-receiver'</span></span><br><span class="line"><span class="attr">  receiver:</span> <span class="string">default-receiver</span></span><br><span class="line"><span class="attr">  group_by:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertname</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cluster</span></span><br><span class="line"><span class="attr">  group_wait:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  group_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  repeat_interval:</span> <span class="number">1</span><span class="string">h</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line"><span class="attr">- source_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">critical</span></span><br><span class="line"><span class="attr">  target_match:</span></span><br><span class="line"><span class="attr">    severity:</span> <span class="string">warning</span></span><br><span class="line"><span class="attr">  equal:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">alertname</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">dev</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">instance</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">default-receiver</span></span><br><span class="line"><span class="attr">  email_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    to:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    from:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    hello:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    smarthost:</span> <span class="string">smtp.example.com:465</span></span><br><span class="line"><span class="attr">    auth_username:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    auth_password:</span> <span class="string">'这里写密码'</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="attr">      From:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">      Subject:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "email.default.subject" . &#125;&#125;</span>'</span></span><br><span class="line"><span class="attr">      To:</span> <span class="string">monitor@example.com</span></span><br><span class="line"><span class="attr">    html:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "email.default.html" . &#125;&#125;</span>'</span></span><br><span class="line"><span class="attr">    require_tls:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 配置钉钉机器人</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">http://localhost:8060/dingtalk/webhook001/send</span></span><br><span class="line"><span class="comment"># 配置钉钉机器人</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">dingtalk002</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - send_resolved:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">http://localhost:8060/dingtalk/webhook002/send</span></span><br><span class="line"><span class="attr">templates:</span> <span class="string">[]</span></span><br></pre></td></tr></table></figure><p>配置dingtalk webhook程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 这里偷懒用docker跑钉钉的webhook</span></span><br><span class="line">docker run -d \</span><br><span class="line">           --restart=always \</span><br><span class="line">           --name prometheus-webhook-dingtalk \</span><br><span class="line">           -p 8060:8060 \</span><br><span class="line">           -v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro \</span><br><span class="line">           timonwong/prometheus-webhook-dingtalk \</span><br><span class="line">           --ding.profile="webhook001=https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx" \</span><br><span class="line">           --ding.profile="webhook002=https://oapi.dingtalk.com/robot/send?access_token=yyyyyyyyyyy"</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter-1"><a href="#blackbox-exporter-1" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p>/etc/prometheus/backbox_exporter.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">没空搞，占个位</span></span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter-1"><a href="#mysqld-exporter-1" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p>需要创建用于监控的数据库用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;prometheus&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY &apos;prometheus_password&apos; WITH MAX_USER_CONNECTIONS 3;</span><br><span class="line">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO &apos;prometheus&apos;@&apos;127.0.0.1&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter-1"><a href="#postgresql-exporter-1" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><p>根据需求决定是否使用superuser作为postgresql_exporter的数据库用户</p><p>如果要创建专用用户可以参照下面的方式创建用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建postgresql_exporter专用用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> postgres_exporter <span class="keyword">PASSWORD</span> <span class="string">'password'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> postgres_exporter <span class="keyword">SET</span> SEARCH_PATH <span class="keyword">TO</span> postgres_exporter,pg_catalog;</span><br><span class="line"><span class="comment"># 创建schema</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SCHEMA</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 授权schema</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">USAGE</span> <span class="keyword">ON</span> <span class="keyword">SCHEMA</span> postgres_exporter <span class="keyword">TO</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 创建函数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_pg_stat_activity() <span class="keyword">RETURNS</span> SETOF pg_stat_activity <span class="keyword">AS</span></span><br><span class="line">$$ <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_catalog.pg_stat_activity; $$</span><br><span class="line">LANGUAGE sql</span><br><span class="line">VOLATILE</span><br><span class="line">SECURITY DEFINER;</span><br><span class="line"><span class="comment"># 创建视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> postgres_exporter.pg_stat_activity</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">from</span> get_pg_stat_activity();</span><br><span class="line"><span class="comment"># 视图授权</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> postgres_exporter.pg_stat_activity <span class="keyword">TO</span> postgres_exporter;</span><br><span class="line"><span class="comment"># 创建函数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_pg_stat_replication() <span class="keyword">RETURNS</span> SETOF pg_stat_replication <span class="keyword">AS</span></span><br><span class="line">$$ <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pg_catalog.pg_stat_replication; $$</span><br><span class="line">LANGUAGE sql</span><br><span class="line">VOLATILE</span><br><span class="line">SECURITY DEFINER;</span><br><span class="line"><span class="comment"># 创建视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> postgres_exporter.pg_stat_replication</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> get_pg_stat_replication();</span><br><span class="line"><span class="comment"># 视图授权</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> postgres_exporter.pg_stat_replication <span class="keyword">TO</span> postgres_exporter;</span><br></pre></td></tr></table></figure><h3 id="grafana-1"><a href="#grafana-1" class="headerlink" title="grafana"></a>grafana</h3><p>/etc/grafana/grafana.ini</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">app_mode</span> = production</span><br><span class="line"><span class="section">[paths]</span></span><br><span class="line"><span class="attr">data</span> = /var/lib/grafana</span><br><span class="line"><span class="attr">temp_data_lifetime</span> = <span class="number">24</span>h</span><br><span class="line"><span class="attr">logs</span> = /var/log/grafana</span><br><span class="line"><span class="attr">plugins</span> = /var/lib/grafana/plugins</span><br><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="attr">protocol</span> = http</span><br><span class="line"><span class="attr">http_port</span> = <span class="number">3000</span></span><br><span class="line"><span class="attr">domain</span> = gkht</span><br><span class="line"><span class="attr">root_url</span> = http://localhost:<span class="number">3000</span></span><br><span class="line"><span class="attr">enable_gzip</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">log_queries</span> =</span><br><span class="line"><span class="section">[remote_cache]</span></span><br><span class="line"><span class="section">[session]</span></span><br><span class="line"><span class="attr">provider</span> = file</span><br><span class="line"><span class="section">[dataproxy]</span></span><br><span class="line"><span class="section">[analytics]</span></span><br><span class="line"><span class="attr">reporting_enabled</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">check_for_updates</span> = <span class="literal">false</span></span><br><span class="line"><span class="section">[security]</span></span><br><span class="line"><span class="attr">admin_user</span> = admin</span><br><span class="line"><span class="attr">admin_password</span> = admin</span><br><span class="line"><span class="attr">secret_key</span> = SW2YcwTIb9zpOOhoPsMm</span><br><span class="line"><span class="section">[snapshots]</span></span><br><span class="line"><span class="section">[dashboards]</span></span><br><span class="line"><span class="attr">versions_to_keep</span> = <span class="number">10</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">default_theme</span> = dark</span><br><span class="line"><span class="section">[auth]</span></span><br><span class="line"><span class="section">[auth.anonymous]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">org_role</span> = Viewer</span><br><span class="line"><span class="section">[auth.github]</span></span><br><span class="line"><span class="section">[auth.google]</span></span><br><span class="line"><span class="section">[auth.generic_oauth]</span></span><br><span class="line"><span class="section">[auth.grafana_com]</span></span><br><span class="line"><span class="section">[auth.proxy]</span></span><br><span class="line"><span class="section">[auth.basic]</span></span><br><span class="line"><span class="section">[auth.ldap]</span></span><br><span class="line"><span class="section">[smtp]</span></span><br><span class="line"><span class="section">[emails]</span></span><br><span class="line"><span class="section">[log]</span></span><br><span class="line"><span class="attr">mode</span> = console file</span><br><span class="line"><span class="attr">level</span> = info</span><br><span class="line"><span class="section">[log.console]</span></span><br><span class="line"><span class="section">[log.file]</span></span><br><span class="line"><span class="attr">log_rotate</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">daily_rotate</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">max_days</span> = <span class="number">7</span></span><br><span class="line"><span class="section">[log.syslog]</span></span><br><span class="line"><span class="section">[alerting]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">execute_alerts</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[explore]</span></span><br><span class="line"><span class="section">[metrics]</span></span><br><span class="line"><span class="attr">enabled</span>           = <span class="literal">true</span></span><br><span class="line"><span class="attr">interval_seconds</span>  = <span class="number">10</span></span><br><span class="line"><span class="section">[metrics.graphite]</span></span><br><span class="line"><span class="section">[tracing.jaeger]</span></span><br><span class="line"><span class="section">[grafana_com]</span></span><br><span class="line"><span class="attr">url</span> = https://grafana.com</span><br><span class="line"><span class="section">[external_image_storage]</span></span><br><span class="line"><span class="section">[external_image_storage.s3]</span></span><br><span class="line"><span class="section">[external_image_storage.webdav]</span></span><br><span class="line"><span class="section">[external_image_storage.gcs]</span></span><br><span class="line"><span class="section">[external_image_storage.azure_blob]</span></span><br><span class="line"><span class="section">[external_image_storage.local]</span></span><br><span class="line"><span class="section">[rendering]</span></span><br><span class="line"><span class="section">[enterprise]</span></span><br><span class="line"><span class="section">[panels]</span></span><br></pre></td></tr></table></figure><h2 id="systemd服务"><a href="#systemd服务" class="headerlink" title="systemd服务"></a>systemd服务</h2><h3 id="prometheus-service"><a href="#prometheus-service" class="headerlink" title="prometheus.service"></a>prometheus.service</h3><p>/usr/lib/systemd/system/prometheus.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=prometheus</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/prometheus \</span><br><span class="line">          --config.file=/etc/prometheus/prometheus.yml \</span><br><span class="line">          --storage.tsdb.path=/var/lib/prometheus \</span><br><span class="line">          --storage.tsdb.retention.time=15d \</span><br><span class="line">          --storage.tsdb.retention.size=40GB \</span><br><span class="line">          --web.console.templates=/etc/prometheus/consoles \</span><br><span class="line">          --web.console.libraries=/etc/prometheus/console_libraries</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="alertmanager-servicce"><a href="#alertmanager-servicce" class="headerlink" title="alertmanager.servicce"></a>alertmanager.servicce</h3><p>/usr/lib/systemd/system/alertmanager.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=alertmanager</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/alertmanager \</span><br><span class="line">          --config.file=/etc/prometheus/alertmanager.yml \</span><br><span class="line">          --storage.path=/var/lib/alertmanager \</span><br><span class="line">          --data.retention=120h</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="node-exporter-service"><a href="#node-exporter-service" class="headerlink" title="node_exporter.service"></a>node_exporter.service</h3><p>/usr/lib/systemd/system/node_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="blackbox-exporter-service"><a href="#blackbox-exporter-service" class="headerlink" title="blackbox_exporter.service"></a>blackbox_exporter.service</h3><p>/usr/lib/systemd/system/balckbox_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=blackbox_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/bin/blackbox_exporter \</span><br><span class="line">          --config.file=/etc/prometheus/blackbox.yml \</span><br><span class="line">          --web.listen-address=:9115 \</span><br><span class="line">          --log.level=info          </span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="mysqld-exporter-service"><a href="#mysqld-exporter-service" class="headerlink" title="mysqld_exporter.service"></a>mysqld_exporter.service</h3><p>/usr/lib/systemd/system/mysqld_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=mysqld_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">Environment='DATA_SOURCE_NAME=prometheus:prometheus_password@tcp(127.0.0.1:3306)'</span><br><span class="line">ExecStart=/usr/local/bin/mysqld_exporter \</span><br><span class="line">          --collect.engine_innodb_status \</span><br><span class="line">          --collect.info_schema.innodb_metrics \</span><br><span class="line">          --collect.info_schema.userstats \</span><br><span class="line">          --collect.perf_schema.eventsstatements \</span><br><span class="line">          --collect.perf_schema.indexiowaits \</span><br><span class="line">          --collect.perf_schema.tableiowaits \</span><br><span class="line">          --collect.slave_status \</span><br><span class="line">          --log.level=info \</span><br><span class="line">          --web.listen-address=:9104 \</span><br><span class="line">          --web.telemetry-path=/metrics</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="postgresql-exporter-service"><a href="#postgresql-exporter-service" class="headerlink" title="postgresql_exporter.service"></a>postgresql_exporter.service</h3><p>/usr/lib/systemd/system/postgresql_exporter.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=postgresql_exporter</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">Environment=DATA_SOURCE_NAME=postgresql://postgres_exporter:password@localhost:5432/postgres?sslmode=disable</span><br><span class="line">ExecStart=/usr/local/bin/postgresql_exporter \</span><br><span class="line">          --web.listen-address=:9187 \</span><br><span class="line">          --web.telemetry-path=/metrics \</span><br><span class="line">          --log.level=info \</span><br><span class="line">          --log.format=logger:stderr</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>修改了systemd脚本之后需要reload一下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><h3 id="prometheus-1"><a href="#prometheus-1" class="headerlink" title="prometheus"></a>prometheus</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now prometheus.service</span><br></pre></td></tr></table></figure><h3 id="alertmanager-1"><a href="#alertmanager-1" class="headerlink" title="alertmanager"></a>alertmanager</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now alertmanager.service</span><br></pre></td></tr></table></figure><h3 id="node-exporter-1"><a href="#node-exporter-1" class="headerlink" title="node_exporter"></a>node_exporter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now node_exporter.service</span><br></pre></td></tr></table></figure><h3 id="grafana-2"><a href="#grafana-2" class="headerlink" title="grafana"></a>grafana</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now grafana.service</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><blockquote><p>其他服务同理，择需启动对应的服务即可</p></blockquote><h2 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h2><h3 id="prometheus-2"><a href="#prometheus-2" class="headerlink" title="prometheus"></a>prometheus</h3><p>浏览器访问<code>http://prometheus_server_ip:9090</code></p><h3 id="alertmanager-2"><a href="#alertmanager-2" class="headerlink" title="alertmanager"></a>alertmanager</h3><p>浏览器访问<code>http://prometheus_server_ip:9093</code></p><h3 id="node-exporter-2"><a href="#node-exporter-2" class="headerlink" title="node_exporter"></a>node_exporter</h3><p>浏览器访问<code>http://prometheus_server_ip:9100</code></p><h3 id="grafana-3"><a href="#grafana-3" class="headerlink" title="grafana"></a>grafana</h3><p>浏览器访问<code>http://prometheus_server_ip:3000</code></p><p>默认密码见grafana配置章节</p><h2 id="配置grafana监控面板"><a href="#配置grafana监控面板" class="headerlink" title="配置grafana监控面板"></a>配置grafana监控面板</h2><p>这里很多作业可以抄</p><p><a href="https://grafana.com/dashboards" target="_blank" rel="noopener">grafana dashboard</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Prometheus搭建简单的监控告警系统&quot;&gt;&lt;a href=&quot;#Prometheus搭建简单的监控告警系统&quot; class=&quot;headerlink&quot; title=&quot;Prometheus搭建简单的监控告警系统&quot;&gt;&lt;/a&gt;Prometheus搭建简单的监控告警系统&lt;/
      
    
    </summary>
    
    
      <category term="Prometheus" scheme="https://luanlengli.github.io/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>Shell处理xml文件的简单方法</title>
    <link href="https://luanlengli.github.io/2019/04/09/Shell%E5%A4%84%E7%90%86xml%E6%96%87%E4%BB%B6%E7%9A%84%E7%AE%80%E5%8D%95%E6%96%B9%E6%B3%95.html"/>
    <id>https://luanlengli.github.io/2019/04/09/Shell处理xml文件的简单方法.html</id>
    <published>2019-04-09T01:51:59.000Z</published>
    <updated>2019-04-09T10:25:55.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>工作中遇到需要使用shell命令编辑xml文件，以shell自带的命令去处理非常的不方便，于是乎找了一下处理xml的命令行工具。在此记录一下处理过程</p><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ul><li>操作系统<code>CentOS-7.x</code></li><li>软件包<code>libxml2</code>、<code>xml2</code>、<code>xmlstarlet</code></li></ul><h1 id="操作样例"><a href="#操作样例" class="headerlink" title="操作样例"></a>操作样例</h1><ul><li>准备一个xml文件，这里以<code>Apache maven</code>的<code>settings.xml</code>为例</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment">or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment">distributed with this work for additional information</span></span><br><span class="line"><span class="comment">regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment">to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment">"License"); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment">with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing,</span></span><br><span class="line"><span class="comment">software distributed under the License is distributed on an</span></span><br><span class="line"><span class="comment">"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span></span><br><span class="line"><span class="comment">KIND, either express or implied.  See the License for the</span></span><br><span class="line"><span class="comment">specific language governing permissions and limitations</span></span><br><span class="line"><span class="comment">under the License.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> | This is the configuration file for Maven. It can be specified at two levels:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |  1. User Level. This settings.xml file provides configuration for a single user,</span></span><br><span class="line"><span class="comment"> |                 and is normally provided in $&#123;user.home&#125;/.m2/settings.xml.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 <span class="doctag">NOTE:</span> This location can be overridden with the CLI option:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 -s /path/to/user/settings.xml</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |  2. Global Level. This settings.xml file provides configuration for all Maven</span></span><br><span class="line"><span class="comment"> |                 users on a machine (assuming they're all using the same Maven</span></span><br><span class="line"><span class="comment"> |                 installation). It's normally provided in</span></span><br><span class="line"><span class="comment"> |                 $&#123;maven.conf&#125;/settings.xml.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 <span class="doctag">NOTE:</span> This location can be overridden with the CLI option:</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |                 -gs /path/to/global/settings.xml</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> | The sections in this sample file are intended to give you a running start at</span></span><br><span class="line"><span class="comment"> | getting the most out of your Maven installation. Where appropriate, the default</span></span><br><span class="line"><span class="comment"> | values (values used when the setting is not specified) are provided.</span></span><br><span class="line"><span class="comment"> |</span></span><br><span class="line"><span class="comment"> |--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- localRepository</span></span><br><span class="line"><span class="comment">   | The path to the local repository maven will use to store artifacts.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: $&#123;user.home&#125;/.m2/repository</span></span><br><span class="line"><span class="comment">  &lt;localRepository&gt;/path/to/local/repo&lt;/localRepository&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- interactiveMode</span></span><br><span class="line"><span class="comment">   | This will determine whether maven prompts you when it needs input. If set to false,</span></span><br><span class="line"><span class="comment">   | maven will use a sensible default value, perhaps based on some other setting, for</span></span><br><span class="line"><span class="comment">   | the parameter in question.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: true</span></span><br><span class="line"><span class="comment">  &lt;interactiveMode&gt;true&lt;/interactiveMode&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- offline</span></span><br><span class="line"><span class="comment">   | Determines whether maven should attempt to connect to the network when executing a build.</span></span><br><span class="line"><span class="comment">   | This will have an effect on artifact downloads, artifact deployment, and others.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | Default: false</span></span><br><span class="line"><span class="comment">  &lt;offline&gt;false&lt;/offline&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- pluginGroups</span></span><br><span class="line"><span class="comment">   | This is a list of additional group identifiers that will be searched when resolving plugins by their prefix, i.e.</span></span><br><span class="line"><span class="comment">   | when invoking a command line like "mvn prefix:goal". Maven will automatically add the group identifiers</span></span><br><span class="line"><span class="comment">   | "org.apache.maven.plugins" and "org.codehaus.mojo" if these are not already contained in the list.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- pluginGroup</span></span><br><span class="line"><span class="comment">     | Specifies a further group identifier to use for plugin lookup.</span></span><br><span class="line"><span class="comment">    &lt;pluginGroup&gt;com.your.plugins&lt;/pluginGroup&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- proxies</span></span><br><span class="line"><span class="comment">   | This is a list of proxies which can be used on this machine to connect to the network.</span></span><br><span class="line"><span class="comment">   | Unless otherwise specified (by system property or command-line switch), the first proxy</span></span><br><span class="line"><span class="comment">   | specification in this list marked as active will be used.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">proxies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- proxy</span></span><br><span class="line"><span class="comment">     | Specification for one proxy, to be used in connecting to the network.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;proxy&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;optional&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;active&gt;true&lt;/active&gt;</span></span><br><span class="line"><span class="comment">      &lt;protocol&gt;http&lt;/protocol&gt;</span></span><br><span class="line"><span class="comment">      &lt;username&gt;proxyuser&lt;/username&gt;</span></span><br><span class="line"><span class="comment">      &lt;password&gt;proxypass&lt;/password&gt;</span></span><br><span class="line"><span class="comment">      &lt;host&gt;proxy.host.net&lt;/host&gt;</span></span><br><span class="line"><span class="comment">      &lt;port&gt;80&lt;/port&gt;</span></span><br><span class="line"><span class="comment">      &lt;nonProxyHosts&gt;local.net|some.host.com&lt;/nonProxyHosts&gt;</span></span><br><span class="line"><span class="comment">    &lt;/proxy&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">proxies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- servers</span></span><br><span class="line"><span class="comment">   | This is a list of authentication profiles, keyed by the server-id used within the system.</span></span><br><span class="line"><span class="comment">   | Authentication profiles can be used whenever maven must make a connection to a remote server.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- server</span></span><br><span class="line"><span class="comment">     | Specifies the authentication information to use when connecting to a particular server, identified by</span></span><br><span class="line"><span class="comment">     | a unique name within the system (referred to by the 'id' attribute below).</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | <span class="doctag">NOTE:</span> You should either specify username/password OR privateKey/passphrase, since these pairings are</span></span><br><span class="line"><span class="comment">     |       used together.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;server&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;deploymentRepo&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;username&gt;repouser&lt;/username&gt;</span></span><br><span class="line"><span class="comment">      &lt;password&gt;repopwd&lt;/password&gt;</span></span><br><span class="line"><span class="comment">    &lt;/server&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Another sample, using keys to authenticate.</span></span><br><span class="line"><span class="comment">    &lt;server&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;siteServer&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;privateKey&gt;/path/to/private/key&lt;/privateKey&gt;</span></span><br><span class="line"><span class="comment">      &lt;passphrase&gt;optional; leave empty if not used.&lt;/passphrase&gt;</span></span><br><span class="line"><span class="comment">    &lt;/server&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- mirrors</span></span><br><span class="line"><span class="comment">   | This is a list of mirrors to be used in downloading artifacts from remote repositories.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | It works like this: a POM may declare a repository to use in resolving certain artifacts.</span></span><br><span class="line"><span class="comment">   | However, this repository may have problems with heavy traffic at times, so people have mirrored</span></span><br><span class="line"><span class="comment">   | it to several places.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | That repository definition will have a unique id, so we can create a mirror reference for that</span></span><br><span class="line"><span class="comment">   | repository, to be used as an alternate download site. The mirror site will be the preferred</span></span><br><span class="line"><span class="comment">   | server for that repository.</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mirror</span></span><br><span class="line"><span class="comment">     | Specifies a repository mirror site to use instead of a given repository. The repository that</span></span><br><span class="line"><span class="comment">     | this mirror serves has an ID that matches the mirrorOf element of this mirror. IDs are used</span></span><br><span class="line"><span class="comment">     | for inheritance and direct lookup purposes, and must be unique across the set of mirrors.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;mirror&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;mirrorId&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;mirrorOf&gt;repositoryId&lt;/mirrorOf&gt;</span></span><br><span class="line"><span class="comment">      &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;</span></span><br><span class="line"><span class="comment">      &lt;url&gt;http://my.repository.com/repo/path&lt;/url&gt;</span></span><br><span class="line"><span class="comment">    &lt;/mirror&gt;</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- profiles</span></span><br><span class="line"><span class="comment">   | This is a list of profiles which can be activated in a variety of ways, and which can modify</span></span><br><span class="line"><span class="comment">   | the build process. Profiles provided in the settings.xml are intended to provide local machine-</span></span><br><span class="line"><span class="comment">   | specific paths and repository locations which allow the build to work in the local environment.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | For example, if you have an integration testing plugin - like cactus - that needs to know where</span></span><br><span class="line"><span class="comment">   | your Tomcat instance is installed, you can provide a variable here such that the variable is</span></span><br><span class="line"><span class="comment">   | dereferenced during the build process to configure the cactus plugin.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | As noted above, profiles can be activated in a variety of ways. One way - the activeProfiles</span></span><br><span class="line"><span class="comment">   | section of this document (settings.xml) - will be discussed later. Another way essentially</span></span><br><span class="line"><span class="comment">   | relies on the detection of a system property, either matching a particular value for the property,</span></span><br><span class="line"><span class="comment">   | or merely testing its existence. Profiles can also be activated by JDK version prefix, where a</span></span><br><span class="line"><span class="comment">   | value of '1.4' might activate a profile when the build is executed on a JDK version of '1.4.2_07'.</span></span><br><span class="line"><span class="comment">   | Finally, the list of active profiles can be specified directly from the command line.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   | <span class="doctag">NOTE:</span> For profiles defined in the settings.xml, you are restricted to specifying only artifact</span></span><br><span class="line"><span class="comment">   |       repositories, plugin repositories, and free-form properties to be used as configuration</span></span><br><span class="line"><span class="comment">   |       variables for plugins in the POM.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">   |--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- profile</span></span><br><span class="line"><span class="comment">     | Specifies a set of introductions to the build process, to be activated using one or more of the</span></span><br><span class="line"><span class="comment">     | mechanisms described above. For inheritance purposes, and to activate profiles via &lt;activatedProfiles/&gt;</span></span><br><span class="line"><span class="comment">     | or the command line, profiles have to have an ID that is unique.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | An encouraged best practice for profile identification is to use a consistent naming convention</span></span><br><span class="line"><span class="comment">     | for profiles, such as 'env-dev', 'env-test', 'env-production', 'user-jdcasey', 'user-brett', etc.</span></span><br><span class="line"><span class="comment">     | This will make it more intuitive to understand what the set of introduced profiles is attempting</span></span><br><span class="line"><span class="comment">     | to accomplish, particularly when you only have a list of profile id's for debug.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | This profile example uses the JDK version to trigger activation, and provides a JDK-specific repo.</span></span><br><span class="line"><span class="comment">    &lt;profile&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;jdk-1.4&lt;/id&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;activation&gt;</span></span><br><span class="line"><span class="comment">        &lt;jdk&gt;1.4&lt;/jdk&gt;</span></span><br><span class="line"><span class="comment">      &lt;/activation&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;repositories&gt;</span></span><br><span class="line"><span class="comment">        &lt;repository&gt;</span></span><br><span class="line"><span class="comment">          &lt;id&gt;jdk14&lt;/id&gt;</span></span><br><span class="line"><span class="comment">          &lt;name&gt;Repository for JDK 1.4 builds&lt;/name&gt;</span></span><br><span class="line"><span class="comment">          &lt;url&gt;http://www.myhost.com/maven/jdk14&lt;/url&gt;</span></span><br><span class="line"><span class="comment">          &lt;layout&gt;default&lt;/layout&gt;</span></span><br><span class="line"><span class="comment">          &lt;snapshotPolicy&gt;always&lt;/snapshotPolicy&gt;</span></span><br><span class="line"><span class="comment">        &lt;/repository&gt;</span></span><br><span class="line"><span class="comment">      &lt;/repositories&gt;</span></span><br><span class="line"><span class="comment">    &lt;/profile&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">     | Here is another profile, activated by the system property 'target-env' with a value of 'dev',</span></span><br><span class="line"><span class="comment">     | which provides a specific path to the Tomcat instance. To use this, your plugin configuration</span></span><br><span class="line"><span class="comment">     | might hypothetically look like:</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | ...</span></span><br><span class="line"><span class="comment">     | &lt;plugin&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;groupId&gt;org.myco.myplugins&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;artifactId&gt;myplugin&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     |   &lt;configuration&gt;</span></span><br><span class="line"><span class="comment">     |     &lt;tomcatLocation&gt;$&#123;tomcatPath&#125;&lt;/tomcatLocation&gt;</span></span><br><span class="line"><span class="comment">     |   &lt;/configuration&gt;</span></span><br><span class="line"><span class="comment">     | &lt;/plugin&gt;</span></span><br><span class="line"><span class="comment">     | ...</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">     | <span class="doctag">NOTE:</span> If you just wanted to inject this configuration whenever someone set 'target-env' to</span></span><br><span class="line"><span class="comment">     |       anything, you could just leave off the &lt;value/&gt; inside the activation-property.</span></span><br><span class="line"><span class="comment">     |</span></span><br><span class="line"><span class="comment">    &lt;profile&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;env-dev&lt;/id&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;activation&gt;</span></span><br><span class="line"><span class="comment">        &lt;property&gt;</span></span><br><span class="line"><span class="comment">          &lt;name&gt;target-env&lt;/name&gt;</span></span><br><span class="line"><span class="comment">          &lt;value&gt;dev&lt;/value&gt;</span></span><br><span class="line"><span class="comment">        &lt;/property&gt;</span></span><br><span class="line"><span class="comment">      &lt;/activation&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      &lt;properties&gt;</span></span><br><span class="line"><span class="comment">        &lt;tomcatPath&gt;/path/to/tomcat/instance&lt;/tomcatPath&gt;</span></span><br><span class="line"><span class="comment">      &lt;/properties&gt;</span></span><br><span class="line"><span class="comment">    &lt;/profile&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- activeProfiles</span></span><br><span class="line"><span class="comment">   | List of profiles that are active for all builds.</span></span><br><span class="line"><span class="comment">   |</span></span><br><span class="line"><span class="comment">  &lt;activeProfiles&gt;</span></span><br><span class="line"><span class="comment">    &lt;activeProfile&gt;alwaysActiveProfile&lt;/activeProfile&gt;</span></span><br><span class="line"><span class="comment">    &lt;activeProfile&gt;anotherAlwaysActiveProfile&lt;/activeProfile&gt;</span></span><br><span class="line"><span class="comment">  &lt;/activeProfiles&gt;</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在国内使用maven都需要在<code>settings.xml</code>里面配置国内的mirrors，以加速maven下载依赖包的过程。</li></ul><blockquote><p>这里以阿里云的为例，需要在settings.xml文件里面添加如下内容</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span>  </span><br><span class="line">    ...   </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>          </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h1><h2 id="处理settings-xml"><a href="#处理settings-xml" class="headerlink" title="处理settings.xml"></a>处理settings.xml</h2><ul><li>将settings.xml处理成容易处理的字符串</li><li>清理注释</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xmlstarlet ed -d <span class="string">'//comment()'</span> settings.xml | grep -v mirrors | xml2</span><br><span class="line"><span class="comment"># 输出实例</span></span><br><span class="line">/settings/@xmlns=http://maven.apache.org/SETTINGS/1.0.0</span><br><span class="line">/settings/@xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance</span><br><span class="line">/settings/@xsi:schemaLocation=http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><br><span class="line">/settings/pluginGroups</span><br><span class="line">/settings/proxies</span><br><span class="line">/settings/servers</span><br><span class="line">/settings/profiles</span><br></pre></td></tr></table></figure><h2 id="处理mirror配置"><a href="#处理mirror配置" class="headerlink" title="处理mirror配置"></a>处理mirror配置</h2><ul><li>同样使用xml2处理xml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; aliyun_mirror.xml &lt;&lt;EOF</span><br><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;mirrors&gt;</span><br><span class="line">        &lt;mirror&gt;  </span><br><span class="line">          &lt;id&gt;alimaven&lt;/id&gt;  </span><br><span class="line">          &lt;name&gt;aliyun maven&lt;/name&gt;  </span><br><span class="line">          &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;  </span><br><span class="line">          &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;          </span><br><span class="line">        &lt;/mirror&gt;</span><br><span class="line">    &lt;/mirrors&gt;</span><br><span class="line">&lt;/settings&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">xml2 &lt; aliyun_mirror.xml</span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">settings/mirrors/mirror/id=alimaven</span><br><span class="line">settings/mirrors/mirror/name=aliyun maven</span><br><span class="line">settings/mirrors/mirror/url=http://maven.aliyun.com/nexus/content/groups/public/</span><br><span class="line">settings/mirrors/mirror/mirrorOf=central</span><br></pre></td></tr></table></figure><h2 id="合并配置"><a href="#合并配置" class="headerlink" title="合并配置"></a>合并配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Settings=$(xmlstarlet ed -d <span class="string">'//comment()'</span> settings.xml | grep -v mirrors | xml2)</span><br><span class="line">AliyunMirror=$(xml2 &lt; aliyun_mirror.xml)</span><br><span class="line"><span class="built_in">printf</span> <span class="string">"<span class="variable">$Settings</span>\n<span class="variable">$AliyunMirror</span>"</span></span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">/settings/@xmlns=http://maven.apache.org/SETTINGS/1.0.0</span><br><span class="line">/settings/@xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance</span><br><span class="line">/settings/@xsi:schemaLocation=http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd</span><br><span class="line">/settings/pluginGroups</span><br><span class="line">/settings/proxies</span><br><span class="line">/settings/servers</span><br><span class="line">/settings/profiles/settings/mirrors/mirror/id=alimaven</span><br><span class="line">/settings/mirrors/mirror/name=aliyun maven</span><br><span class="line">/settings/mirrors/mirror/url=http://maven.aliyun.com/nexus/content/groups/public/</span><br><span class="line">/settings/mirrors/mirror/mirrorOf=central</span><br></pre></td></tr></table></figure><h2 id="将字符串转换成xml格式文件"><a href="#将字符串转换成xml格式文件" class="headerlink" title="将字符串转换成xml格式文件"></a>将字符串转换成xml格式文件</h2><ul><li>这里将输出结果打印在终端，可以直接重定向到settings.xml文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">"<span class="variable">$Settings</span>\n<span class="variable">$AliyunMirror</span>"</span> | 2xml | xmllint --format -</span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span><br><span class="line">&lt;settings xmlns=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> xsi:schemaLocation=<span class="string">"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"</span>&gt;</span><br><span class="line">  &lt;pluginGroups/&gt;</span><br><span class="line">  &lt;proxies/&gt;</span><br><span class="line">  &lt;servers/&gt;</span><br><span class="line">  &lt;profiles/&gt;</span><br><span class="line">  &lt;mirrors&gt;</span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;alimaven&lt;/id&gt;</span><br><span class="line">      &lt;name&gt;aliyun maven&lt;/name&gt;</span><br><span class="line">      &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">      &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line">  &lt;/mirrors&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;p&gt;工作中遇到需要使用shell命令编辑xml文件，以shell自带的命令去处理非常的不方便，于是乎找了一下处理xml的命令行工具。在此记录一下
      
    
    </summary>
    
    
      <category term="shell" scheme="https://luanlengli.github.io/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>git pull免密码配置</title>
    <link href="https://luanlengli.github.io/2019/04/07/git-pull%E5%85%8D%E5%AF%86%E7%A0%81%E9%85%8D%E7%BD%AE.html"/>
    <id>https://luanlengli.github.io/2019/04/07/git-pull免密码配置.html</id>
    <published>2019-04-07T14:25:00.000Z</published>
    <updated>2019-04-07T14:29:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>git 拉取代码的时候，如果不使用密钥的方式时，会要求输入用户密码，非常繁琐</li><li>为此需要配置免账号密码登录</li></ul><h1 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h1><ul><li>切换到用户家目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure><ul><li>运行git命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.helper store</span><br></pre></td></tr></table></figure><ul><li>此命令会在用户家目录生成一个<code>.gitconfig</code>，内容如下</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[credential]</span><br><span class="line">helper = store</span><br></pre></td></tr></table></figure><ul><li>再次运行<code>git pull</code>还是会提示输入用户密码，命令会在用户家目录生成<code>.git-credentials</code>文件，里面会保存刚才输入的用户密码。</li><li>后续操作git的时候就不会要求输入用户密码了</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;git 拉取代码的时候，如果不使用密钥的方式时，会要求输入用户密码，非常繁琐&lt;/li&gt;&lt;li&gt;为此需要配置免账号密码登录&lt;/li&gt;
      
    
    </summary>
    
    
      <category term="git" scheme="https://luanlengli.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>阿里云RDS数据库MySQL5.7实例主从搭建过程</title>
    <link href="https://luanlengli.github.io/2019/04/06/%E9%98%BF%E9%87%8C%E4%BA%91RDS%E6%95%B0%E6%8D%AE%E5%BA%93MySQL5-7%E5%AE%9E%E4%BE%8B%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B.html"/>
    <id>https://luanlengli.github.io/2019/04/06/阿里云RDS数据库MySQL5-7实例主从搭建过程.html</id>
    <published>2019-04-06T03:16:33.000Z</published>
    <updated>2019-04-25T15:26:30.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>工作中遇到需要搭建阿里云RDS数据库MySQL5.7实例主从集群，在此记录搭建过程</li><li>主库<ul><li>阿里云RDS数据库MySQL5.7实例</li></ul></li><li>从库<ul><li>本地服务器MySQL5.7，通过公网访问阿里云RDS实例</li></ul></li></ul><h1 id="阿里云RDS实例准备操作"><a href="#阿里云RDS实例准备操作" class="headerlink" title="阿里云RDS实例准备操作"></a>阿里云RDS实例准备操作</h1><ul><li>登录阿里云管理控制台</li><li>选择【云数据库RDS版】</li><li>切换到【云数据库RDS版】界面，左上角选择【数据中心】，在【实例列表】中找到主库，点击右侧的【管理】</li><li>在【基本信息】可以看到主库的【外网地址】和端口<ul><li>外网地址示例：<code>rm-xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com</code></li><li>端口：<code>3306</code></li></ul></li><li>切换到【账号管理】，点击【创建账号】<ul><li>用户名：<code>repuser</code></li><li>密码：<code>repuserpassword</code></li><li>账号类型：<code>普通帐号</code></li><li>授权数据库：<code>选择需要同步的数据库</code>，选择完毕后，权限统一设置为【只读】</li></ul></li><li>登录阿里云RDS实例，查看主库信息<ul><li><code>show variables like &#39;%binlog_format%&#39;;</code></li><li><code>show variables like &#39;server_id&#39;;</code></li></ul></li></ul><h1 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h1><ul><li>安装MySQL5.7，这里网上很多教程，自行解决</li><li>修改从库<code>my.cnf</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># 这里的server-id要跟RDS主库查询到的server-id不一样</span></span><br><span class="line">server-id                =  3306              </span><br><span class="line">log_bin                  =  /data/mysql-data</span><br><span class="line">expire_logs_days         =  7</span><br><span class="line">max_binlog_size          =  100M</span><br><span class="line">replicate-ignore-db      =  ccccc                  <span class="comment">#不想同步的数据库</span></span><br><span class="line">replicate-ignore-db      =  ddddd                  <span class="comment">#不想同步的数据库</span></span><br><span class="line"><span class="comment"># 启动GTID </span></span><br><span class="line">gtid_mode                =  on</span><br><span class="line">enforce_gtid_consistency =  on</span><br><span class="line">binlog_format            =  row                    <span class="comment">#设置 binlog 为 row</span></span><br><span class="line"><span class="built_in">log</span>-slave-updates        =  1</span><br></pre></td></tr></table></figure><ul><li>在从库上对阿里云RDS实例做一次dump备份</li></ul><blockquote><p>假设我们要同步的是aaa和bbb两个库</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u'repuser' \</span><br><span class="line">          -h'rm-xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com' \</span><br><span class="line">          -P 3306 \</span><br><span class="line">          -p'repuserpassword' \</span><br><span class="line">          --set-gtid-purged=ON \</span><br><span class="line">          --master-data=2 \</span><br><span class="line">          --single-transaction \</span><br><span class="line">          --databases aaa bbb &gt; aliyun_rds_dump.sql</span><br></pre></td></tr></table></figure><ul><li>从库导入dump备份</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u<span class="string">'root'</span> \</span><br><span class="line">      -p \</span><br><span class="line">      -P3306 \</span><br><span class="line">      &lt; aliyun_rds_dump.sql</span><br></pre></td></tr></table></figure><ul><li>设置从库</li></ul><blockquote><p>启用基于GTID的主从同步</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host = &apos;xxxxxxxxxxxxxxx.mysql.rds.aliyuncs.com&apos;,</span><br><span class="line">                        master_port = 3306, </span><br><span class="line">                        master_user = &apos;repuser&apos;, </span><br><span class="line">                        master_password=&apos;repuserpassword&apos;, </span><br><span class="line">                        master_connect_retry=10,</span><br><span class="line">                        master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure><ul><li>检查主从同步状态</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G</span><br><span class="line">mysql&gt; show processlist \G</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;工作中遇到需要搭建阿里云RDS数据库MySQL5.7实例主从集群，在此记录搭建过程&lt;/li&gt;&lt;li&gt;主库&lt;ul&gt;&lt;li&gt;阿里云RD
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL常用SQL语句</title>
    <link href="https://luanlengli.github.io/2019/03/29/MySQL%E5%B8%B8%E7%94%A8SQL%E8%AF%AD%E5%8F%A5.html"/>
    <id>https://luanlengli.github.io/2019/03/29/MySQL常用SQL语句.html</id>
    <published>2019-03-29T01:54:19.000Z</published>
    <updated>2019-04-16T13:32:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="查看所有数据库大小"><a href="#查看所有数据库大小" class="headerlink" title="查看所有数据库大小"></a>查看所有数据库大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                                 <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(table_rows)                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>))  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.tables</span><br><span class="line"><span class="keyword">GROUP</span>  <span class="keyword">BY</span> table_schema</span><br><span class="line"><span class="keyword">ORDER</span>  <span class="keyword">BY</span> <span class="keyword">Sum</span>(data_length) <span class="keyword">DESC</span>,</span><br><span class="line">          <span class="keyword">Sum</span>(index_length) <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h1 id="查看数据库各表大小"><a href="#查看数据库各表大小" class="headerlink" title="查看数据库各表大小"></a>查看数据库各表大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                            <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       table_name                              <span class="keyword">AS</span> <span class="string">'表名'</span>,</span><br><span class="line">       table_rows                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.TABLES</span><br><span class="line"><span class="keyword">ORDER</span>  <span class="keyword">BY</span> data_length <span class="keyword">DESC</span>,</span><br><span class="line">          index_length <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h1 id="查看指定数据库大小"><a href="#查看指定数据库大小" class="headerlink" title="查看指定数据库大小"></a>查看指定数据库大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                                 <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(table_rows)                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>))  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">Sum</span>(<span class="keyword">Truncate</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.tables</span><br><span class="line"><span class="keyword">WHERE</span>  table_schema = <span class="string">'mysql'</span>;</span><br></pre></td></tr></table></figure><h1 id="查看指定数据库各表大小"><a href="#查看指定数据库各表大小" class="headerlink" title="查看指定数据库各表大小"></a>查看指定数据库各表大小</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_schema                            <span class="keyword">AS</span> <span class="string">'数据库'</span>,</span><br><span class="line">       table_name                              <span class="keyword">AS</span> <span class="string">'表名'</span>,</span><br><span class="line">       table_rows                              <span class="keyword">AS</span> <span class="string">'记录数'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(data_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>)  <span class="keyword">AS</span> <span class="string">'数据容量(MB)'</span>,</span><br><span class="line">       <span class="keyword">TRUNCATE</span>(index_length / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">AS</span> <span class="string">'索引容量(MB)'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.TABLES</span><br><span class="line"><span class="keyword">WHERE</span>  table_schema = <span class="string">'mysql'</span></span><br><span class="line"><span class="keyword">ORDER</span>  <span class="keyword">BY</span> data_length <span class="keyword">DESC</span>,</span><br><span class="line">          index_length <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h1 id="建库时指定字符集和排序规则"><a href="#建库时指定字符集和排序规则" class="headerlink" title="建库时指定字符集和排序规则"></a>建库时指定字符集和排序规则</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE DB_NAME </span><br><span class="line">  CHARACTER SET utf8mb4 </span><br><span class="line">  COLLATE utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;查看所有数据库大小&quot;&gt;&lt;a href=&quot;#查看所有数据库大小&quot; class=&quot;headerlink&quot; title=&quot;查看所有数据库大小&quot;&gt;&lt;/a&gt;查看所有数据库大小&lt;/h1&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td 
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-学习笔记</title>
    <link href="https://luanlengli.github.io/2019/02/22/Elasticsearch-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://luanlengli.github.io/2019/02/22/Elasticsearch-学习笔记.html</id>
    <published>2019-02-22T15:28:10.000Z</published>
    <updated>2019-03-03T14:13:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="cat-APIs"><a href="#cat-APIs" class="headerlink" title="_cat APIs"></a>_cat APIs</h1><p>通过访问elasticsearch集群的<code>/_cat</code>可以获取很多有用的信息。</p><p>使用<code>curl -X GET &quot;http://elasticsearch:9200/_cat&quot;</code>可以单独列出所有可用的命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">"http://elasticsearch-1:9200/_cat/"</span></span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;<span class="built_in">alias</span>&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure><h2 id="获取-cat-API帮助"><a href="#获取-cat-API帮助" class="headerlink" title="获取_cat API帮助"></a>获取_cat API帮助</h2><ul><li>可以在<code>/_cat/COMMAND</code>后面加上参数help，获取对应的帮助信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/allocation?help"</span></span><br><span class="line">shards       | s              | number of shards on node      </span><br><span class="line">disk.indices | di,diskIndices | disk used by ES indices       </span><br><span class="line">disk.used    | du,diskUsed    | disk used (total, not just ES)</span><br><span class="line">disk.avail   | da,diskAvail   | disk available                </span><br><span class="line">disk.total   | dt,diskTotal   | total capacity of all volumes </span><br><span class="line">disk.percent | dp,diskPercent | percent disk used             </span><br><span class="line">host         | h              | host of node                  </span><br><span class="line">ip           |                | ip of node                    </span><br><span class="line">node         | n              | name of node</span><br></pre></td></tr></table></figure><h2 id="获取当前master信息"><a href="#获取当前master信息" class="headerlink" title="获取当前master信息"></a>获取当前master信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/master?v"</span></span><br><span class="line">id                     host          ip            node</span><br><span class="line">JLyKyWH_QnSiXXuRNCj_3g 172.16.80.201 172.16.80.201 elasticsearch-1</span><br></pre></td></tr></table></figure><h2 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/nodes?format=json&amp;pretty"</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"ip"</span> : <span class="string">"172.16.80.201"</span>,</span><br><span class="line">    <span class="string">"heap.percent"</span> : <span class="string">"7"</span>,</span><br><span class="line">    <span class="string">"ram.percent"</span> : <span class="string">"85"</span>,</span><br><span class="line">    <span class="string">"cpu"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"load_1m"</span> : <span class="string">"0.00"</span>,</span><br><span class="line">    <span class="string">"load_5m"</span> : <span class="string">"0.08"</span>,</span><br><span class="line">    <span class="string">"load_15m"</span> : <span class="string">"0.20"</span>,</span><br><span class="line">    <span class="string">"node.role"</span> : <span class="string">"mdi"</span>,</span><br><span class="line">    <span class="string">"master"</span> : <span class="string">"*"</span>,</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="获取索引信息"><a href="#获取索引信息" class="headerlink" title="获取索引信息"></a>获取索引信息</h2><ul><li>以json格式返回结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET -H <span class="string">"Accept: application/json"</span> <span class="string">"http://elasticsearch-1:9200/_cat/indices?format=json&amp;pretty"</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">".kibana"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"V_t2TnJKQ9WV8E1C_uzIfA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"6"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"37.3kb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"37.3kb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"bank"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"3OEfeSwsTyKyC2zKHbuzJQ"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"1000"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"640.8kb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"640.8kb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.18"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"h8m1NlTIQS6Z49mHACYokA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4631"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"27mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"27mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"shakespeare"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"xwoP7Pc3Q3ySZ47MosHrFA"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"111396"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"29mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"29mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.20"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"ewX3DcZHScOK4Mi6lF6Hqg"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4750"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"30.3mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"30.3mb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"health"</span> : <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"status"</span> : <span class="string">"open"</span>,</span><br><span class="line">    <span class="string">"index"</span> : <span class="string">"logstash-2015.05.19"</span>,</span><br><span class="line">    <span class="string">"uuid"</span> : <span class="string">"siQA71vbSYOgE3a8M7HDhg"</span>,</span><br><span class="line">    <span class="string">"pri"</span> : <span class="string">"5"</span>,</span><br><span class="line">    <span class="string">"rep"</span> : <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"docs.count"</span> : <span class="string">"4624"</span>,</span><br><span class="line">    <span class="string">"docs.deleted"</span> : <span class="string">"0"</span>,</span><br><span class="line">    <span class="string">"store.size"</span> : <span class="string">"29.3mb"</span>,</span><br><span class="line">    <span class="string">"pri.store.size"</span> : <span class="string">"29.3mb"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>以yaml格式返回结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cat/indices?format=yaml&amp;pretty"</span></span><br><span class="line">---</span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">".kibana"</span></span><br><span class="line">  uuid: <span class="string">"V_t2TnJKQ9WV8E1C_uzIfA"</span></span><br><span class="line">  pri: <span class="string">"1"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"6"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"37.3kb"</span></span><br><span class="line">  pri.store.size: <span class="string">"37.3kb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"bank"</span></span><br><span class="line">  uuid: <span class="string">"3OEfeSwsTyKyC2zKHbuzJQ"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"1000"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"640.8kb"</span></span><br><span class="line">  pri.store.size: <span class="string">"640.8kb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.18"</span></span><br><span class="line">  uuid: <span class="string">"h8m1NlTIQS6Z49mHACYokA"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4631"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"27mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"27mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"shakespeare"</span></span><br><span class="line">  uuid: <span class="string">"xwoP7Pc3Q3ySZ47MosHrFA"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"111396"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"29mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"29mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.20"</span></span><br><span class="line">  uuid: <span class="string">"ewX3DcZHScOK4Mi6lF6Hqg"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4750"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"30.3mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"30.3mb"</span></span><br><span class="line">- health: <span class="string">"yellow"</span></span><br><span class="line">  status: <span class="string">"open"</span></span><br><span class="line">  index: <span class="string">"logstash-2015.05.19"</span></span><br><span class="line">  uuid: <span class="string">"siQA71vbSYOgE3a8M7HDhg"</span></span><br><span class="line">  pri: <span class="string">"5"</span></span><br><span class="line">  rep: <span class="string">"1"</span></span><br><span class="line">  docs.count: <span class="string">"4624"</span></span><br><span class="line">  docs.deleted: <span class="string">"0"</span></span><br><span class="line">  store.size: <span class="string">"29.3mb"</span></span><br><span class="line">  pri.store.size: <span class="string">"29.3mb"</span></span><br></pre></td></tr></table></figure><h1 id="cluster-APIs"><a href="#cluster-APIs" class="headerlink" title="_cluster APIs"></a>_cluster APIs</h1><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster.html" target="_blank" rel="noopener">这里</a></p><h2 id="Cluster-Health"><a href="#Cluster-Health" class="headerlink" title="Cluster Health"></a>Cluster Health</h2><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html" target="_blank" rel="noopener">这里</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/health?format=yaml&amp;pretty"</span></span><br><span class="line">---</span><br><span class="line">cluster_name: <span class="string">"elasticsearch"</span></span><br><span class="line">status: <span class="string">"yellow"</span></span><br><span class="line">timed_out: <span class="literal">false</span></span><br><span class="line">number_of_nodes: 1</span><br><span class="line">number_of_data_nodes: 1</span><br><span class="line">active_primary_shards: 26</span><br><span class="line">active_shards: 26</span><br><span class="line">relocating_shards: 0</span><br><span class="line">initializing_shards: 0</span><br><span class="line">unassigned_shards: 26</span><br><span class="line">delayed_unassigned_shards: 0</span><br><span class="line">number_of_pending_tasks: 0</span><br><span class="line">number_of_in_flight_fetch: 0</span><br><span class="line">task_max_waiting_in_queue_millis: 0</span><br><span class="line">active_shards_percent_as_number: 50.0</span><br></pre></td></tr></table></figure><h2 id="Cluster-State"><a href="#Cluster-State" class="headerlink" title="Cluster State"></a>Cluster State</h2><p>显示集群状态，官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state.html" target="_blank" rel="noopener">这里</a></p><h3 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/version?"</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"version"</span> : 16,</span><br><span class="line">  <span class="string">"state_uuid"</span> : <span class="string">"w0Bp1nGfRdCGxhA5zD1BBw"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看master节点"><a href="#查看master节点" class="headerlink" title="查看master节点"></a>查看master节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/master_node?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"master_node"</span> : <span class="string">"JLyKyWH_QnSiXXuRNCj_3g"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/state/nodes?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"nodes"</span> : &#123;</span><br><span class="line">    <span class="string">"JLyKyWH_QnSiXXuRNCj_3g"</span> : &#123;</span><br><span class="line">      <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span>,</span><br><span class="line">      <span class="string">"ephemeral_id"</span> : <span class="string">"qdnVkiizToCVPhmDieH3Mg"</span>,</span><br><span class="line">      <span class="string">"transport_address"</span> : <span class="string">"172.16.80.201:9300"</span>,</span><br><span class="line">      <span class="string">"attributes"</span> : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Cluster-States"><a href="#Cluster-States" class="headerlink" title="Cluster States"></a>Cluster States</h2><p>显示集群统计信息，官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-stats.html" target="_blank" rel="noopener">这里</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/stats?format=json&amp;pretty"</span></span><br></pre></td></tr></table></figure><h2 id="Cluster-Update-Settings"><a href="#Cluster-Update-Settings" class="headerlink" title="Cluster Update Settings"></a>Cluster Update Settings</h2><p>用于更新集群设置，可以永久persistent和临时transient设置某些参数</p><ul><li>新启动的集群是没有配置的信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_cluster/settings?format=json&amp;pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"persistent"</span> : &#123; &#125;,</span><br><span class="line">  <span class="string">"transient"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>临时修改集群recovery最大速度</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT \</span><br><span class="line">     -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">     <span class="string">"http://elasticsearch-1:9200/_cluster/settings?format=json&amp;pretty"</span> \</span><br><span class="line">     -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "persistent" : &#123;</span></span><br><span class="line"><span class="string">        "indices.recovery.max_bytes_per_sec" : "50mb"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="Node-Stats"><a href="#Node-Stats" class="headerlink" title="Node Stats"></a>Node Stats</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/_nodes/stats?format=json&amp;pretty"</span></span><br></pre></td></tr></table></figure><h2 id="Node-Info"><a href="#Node-Info" class="headerlink" title="Node Info"></a>Node Info</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不带过滤参数，默认显示所有节点信息</span></span><br><span class="line">GET /_nodes</span><br><span class="line"><span class="comment"># 获取所有节点信息</span></span><br><span class="line">GET /_nodes/_all</span><br><span class="line"><span class="comment"># 获取当前节点信息</span></span><br><span class="line">GET /_nodes/_local</span><br><span class="line"><span class="comment"># 获取master节点信息</span></span><br><span class="line">GET /_nodes/_master</span><br><span class="line"><span class="comment"># 以主机名作为条件过滤节点，或者使用通配符匹配节点</span></span><br><span class="line">GET /_nodes/node_name_goes_here</span><br><span class="line">GET /_nodes/node_name_goes_*</span><br><span class="line"><span class="comment"># 可以使用IP地址加通配符过滤节点</span></span><br><span class="line">GET /_nodes/10.0.0.3,10.0.0.4</span><br><span class="line">GET /_nodes/10.0.0.*</span><br><span class="line"><span class="comment"># 以role作为过滤条件</span></span><br><span class="line">GET /_nodes/_all,master:<span class="literal">false</span></span><br><span class="line">GET /_nodes/data:<span class="literal">true</span>,ingest:<span class="literal">true</span></span><br><span class="line">GET /_nodes/coordinating_only:<span class="literal">true</span></span><br><span class="line"><span class="comment"># 根据elasticsearch.yml文件定义的node.attr.rack属性过滤节点，例如`node.attr.rack: 2`</span></span><br><span class="line">GET /_nodes/rack:2</span><br><span class="line">GET /_nodes/ra*:2</span><br><span class="line">GET /_nodes/ra*:2*</span><br></pre></td></tr></table></figure><h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><p>官方文档见<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/5.6/index.html" target="_blank" rel="noopener">这里</a></p><p>二进制文件<code>elasticsearch/bin/elasticsearch-plugin</code></p><h2 id="查看默认可用的插件"><a href="#查看默认可用的插件" class="headerlink" title="查看默认可用的插件"></a>查看默认可用的插件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-plugin install --<span class="built_in">help</span></span><br><span class="line">Install a plugin</span><br><span class="line"></span><br><span class="line">The following official plugins may be installed by name:</span><br><span class="line">  analysis-icu</span><br><span class="line">  analysis-kuromoji</span><br><span class="line">  analysis-phonetic</span><br><span class="line">  analysis-smartcn</span><br><span class="line">  analysis-stempel</span><br><span class="line">  analysis-ukrainian</span><br><span class="line">  discovery-azure-classic</span><br><span class="line">  discovery-ec2</span><br><span class="line">  discovery-file</span><br><span class="line">  discovery-gce</span><br><span class="line">  ingest-attachment</span><br><span class="line">  ingest-geoip</span><br><span class="line">  ingest-user-agent</span><br><span class="line">  lang-javascript</span><br><span class="line">  lang-python</span><br><span class="line">  mapper-attachments</span><br><span class="line">  mapper-murmur3</span><br><span class="line">  mapper-size</span><br><span class="line">  repository-azure</span><br><span class="line">  repository-gcs</span><br><span class="line">  repository-hdfs</span><br><span class="line">  repository-s3</span><br><span class="line">  store-smb</span><br><span class="line">  x-pack</span><br></pre></td></tr></table></figure><h1 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h1><h2 id="新增索引"><a href="#新增索引" class="headerlink" title="新增索引"></a>新增索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://elasticsearch-1:9200/twitter"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "settings" : &#123;</span></span><br><span class="line"><span class="string">        "index" : &#123;</span></span><br><span class="line"><span class="string">            "number_of_shards" : 3, </span></span><br><span class="line"><span class="string">            "number_of_replicas" : 2 </span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure><h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE <span class="string">"http://elasticsearch-1:9200/twitter"</span></span><br></pre></td></tr></table></figure><h2 id="获取索引"><a href="#获取索引" class="headerlink" title="获取索引"></a>获取索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">"http://elasticsearch-1:9200/twitter"</span></span><br></pre></td></tr></table></figure><h2 id="更新索引"><a href="#更新索引" class="headerlink" title="更新索引"></a>更新索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://elasticsearch-1:9200/twitter/_settings"</span> \</span><br><span class="line">     -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">     -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "index" : &#123;</span></span><br><span class="line"><span class="string">        "number_of_replicas" : 2</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure><h2 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class1/1?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Jing",</span></span><br><span class="line"><span class="string">  "last_name": "Guo",</span></span><br><span class="line"><span class="string">  "gender": "Male",</span></span><br><span class="line"><span class="string">  "age": 25,</span></span><br><span class="line"><span class="string">  "courses": "Xiang Long Shi Ba Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Rong",</span></span><br><span class="line"><span class="string">  "last_name": "Huang",</span></span><br><span class="line"><span class="string">  "gender": "Female",</span></span><br><span class="line"><span class="string">  "age": 23,</span></span><br><span class="line"><span class="string">  "courses": "Luo Ying Shen Jian Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://elasticsearch-1:9200/students/class2/1?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "first_name": "Guo",</span></span><br><span class="line"><span class="string">  "last_name": "Yang",</span></span><br><span class="line"><span class="string">  "gender": "Male",</span></span><br><span class="line"><span class="string">  "age": 2,</span></span><br><span class="line"><span class="string">  "courses": "An Ran Xiao Hun Zhang"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="获取文档"><a href="#获取文档" class="headerlink" title="获取文档"></a>获取文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/class1/1?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"students"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"class1"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 3,</span><br><span class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"_source"</span> : &#123;</span><br><span class="line">    <span class="string">"first_name"</span> : <span class="string">"Jing"</span>,</span><br><span class="line">    <span class="string">"last_name"</span> : <span class="string">"Guo"</span>,</span><br><span class="line">    <span class="string">"gender"</span> : <span class="string">"Male"</span>,</span><br><span class="line">    <span class="string">"age"</span> : 25,</span><br><span class="line">    <span class="string">"courses"</span> : <span class="string">"Xiang Long Shi Ba Zhang"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"students"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"class1"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 1,</span><br><span class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"_source"</span> : &#123;</span><br><span class="line">    <span class="string">"first_name"</span> : <span class="string">"Rong"</span>,</span><br><span class="line">    <span class="string">"last_name"</span> : <span class="string">"Huang"</span>,</span><br><span class="line">    <span class="string">"gender"</span> : <span class="string">"Female"</span>,</span><br><span class="line">    <span class="string">"age"</span> : 23,</span><br><span class="line">    <span class="string">"courses"</span> : <span class="string">"Luo Ying Shen Jian Zhang"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><ul><li>直接PUT覆盖</li><li>使用<code>_update</code>API</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">"http://elasticsearch-1:9200/students/class1/2/_update?pretty"</span> \</span><br><span class="line">     -H <span class="string">"Accept: application/json"</span> \</span><br><span class="line">     -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "doc" : &#123;</span></span><br><span class="line"><span class="string">    "age" : 22</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">"http://elasticsearch-1:9200/students/class1/2?pretty"</span></span><br></pre></td></tr></table></figure><h1 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h1><h2 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/query-dsl.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="查询操作阶段"><a href="#查询操作阶段" class="headerlink" title="查询操作阶段"></a>查询操作阶段</h2><ul><li>分散阶段</li><li>合并阶段</li></ul><h2 id="查询方式"><a href="#查询方式" class="headerlink" title="查询方式"></a>查询方式</h2><ul><li>通过Restful API查询，查询参数见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-uri-request.html" target="_blank" rel="noopener">官方文档</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span></span><br></pre></td></tr></table></figure><ul><li>通过发送REST request body查询，查询参数见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/search-request-body.html" target="_blank" rel="noopener">官方文档</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配所有</span></span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配年龄</span></span><br><span class="line">curl -XGET <span class="string">"http://elasticsearch-1:9200/students/_search?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query":&#123;</span></span><br><span class="line"><span class="string">    "bool":&#123;</span></span><br><span class="line"><span class="string">      "must":[</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          "range":&#123;</span></span><br><span class="line"><span class="string">            "age":&#123;</span></span><br><span class="line"><span class="string">              "gt":"21",</span></span><br><span class="line"><span class="string">              "lt":"24"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="多索引、多类型查询"><a href="#多索引、多类型查询" class="headerlink" title="多索引、多类型查询"></a>多索引、多类型查询</h2><ul><li><code>_search</code>：所有索引</li><li><code>/INDEX_NAME/_search</code>：单索引</li><li><code>/INDEX1,INDEX2/_search</code>：多索引</li><li><code>/students/class1/_search</code>：单类型搜索</li><li><code>/students/class1,class2/_search</code>：多类型搜索</li></ul><h1 id="Mapping和Analysis"><a href="#Mapping和Analysis" class="headerlink" title="Mapping和Analysis"></a>Mapping和Analysis</h1><ul><li>Elasticsearch对每个文档，会取得所有域的所有值，生成一个名为<code>“_all”</code>的域</li><li>执行查询的时候，如果未指定<code>query_string</code>，则在<code>“_all”</code>域上执行查询操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在_all域搜索</span></span><br><span class="line">curl /_search?q=<span class="string">"Keyword"</span></span><br><span class="line"><span class="comment"># 在指定的FIELD_NAME这个域搜索</span></span><br><span class="line">curl /_search?q=FIELD_NAME:<span class="string">"Keyword"</span></span><br></pre></td></tr></table></figure><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/mapping-types.html" target="_blank" rel="noopener">官方文档</a></p><ul><li>array</li><li>binary</li><li>range</li><li>boolean</li><li>date</li><li>geo-point</li><li>geo-shape</li><li>IP</li><li>keyword</li><li>nested</li><li>numeric</li><li>object</li><li>text</li><li>token count</li><li>percolatro</li><li>join</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;cat-APIs&quot;&gt;&lt;a href=&quot;#cat-APIs&quot; class=&quot;headerlink&quot; title=&quot;_cat APIs&quot;&gt;&lt;/a&gt;_cat APIs&lt;/h1&gt;&lt;p&gt;通过访问elasticsearch集群的&lt;code&gt;/_cat&lt;/code&gt;可以获取很多
      
    
    </summary>
    
    
      <category term="elasticsearch" scheme="https://luanlengli.github.io/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-5.6.x安装配置</title>
    <link href="https://luanlengli.github.io/2019/02/21/Elasticsearch-5-6-x%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE.html"/>
    <id>https://luanlengli.github.io/2019/02/21/Elasticsearch-5-6-x安装配置.html</id>
    <published>2019-02-21T09:57:55.000Z</published>
    <updated>2019-03-01T16:45:56.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><h2 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS-7"></a>CentOS-7</h2><p>准备两台服务器，做elasticsearch集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="hosts静态解析"><a href="#hosts静态解析" class="headerlink" title="hosts静态解析"></a>hosts静态解析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.201 elasticsearch-1</span><br><span class="line">172.16.80.202 elasticsearch-2</span><br></pre></td></tr></table></figure><h2 id="Oracle-JDK-8u201"><a href="#Oracle-JDK-8u201" class="headerlink" title="Oracle JDK-8u201"></a>Oracle JDK-8u201</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换工作目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="comment"># 下载JDK并解压</span></span><br><span class="line">wget --no-check-certificate \</span><br><span class="line">     -O - \</span><br><span class="line">     -c \</span><br><span class="line">     --header <span class="string">"Cookie: oraclelicense=accept-securebackup-cookie"</span> <span class="string">"https://download.oracle.com/otn-pub/java/jdk/8u201-b09/42970487e3af4f5aa5bca3f542482c60/jdk-8u201-linux-x64.tar.gz"</span> \</span><br><span class="line">     | tar xz </span><br><span class="line"><span class="comment"># 创建软链接</span></span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/jdk1.8.0_201 /usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">cat &gt; /etc/profile.d/java.sh &lt;&lt;EOF</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span> </span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/java.sh</span><br></pre></td></tr></table></figure><h2 id="创建elasticsearch用户"><a href="#创建elasticsearch用户" class="headerlink" title="创建elasticsearch用户"></a>创建elasticsearch用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd esuser</span><br></pre></td></tr></table></figure><h2 id="修改limits"><a href="#修改limits" class="headerlink" title="修改limits"></a>修改limits</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/esuser.conf &lt;&lt;EOF</span><br><span class="line">esuser  -  nofile  262144</span><br><span class="line">esuser  -  memlock unlimited</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br><span class="line">cat &gt; /etc/sysctl.d/elasticsearch.conf &lt;&lt;EOF</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"><span class="comment"># 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="安装elasticsearch"><a href="#安装elasticsearch" class="headerlink" title="安装elasticsearch"></a>安装elasticsearch</h1><h2 id="下载elasticsearch"><a href="#下载elasticsearch" class="headerlink" title="下载elasticsearch"></a>下载elasticsearch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.15.tar.gz</span><br><span class="line">tar xzf elasticsearch-5.6.15.tar.gz</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/elasticsearch-5.6.15 /usr/<span class="built_in">local</span>/elasticsearch</span><br><span class="line">chown -R esuser:esuser /usr/<span class="built_in">local</span>/elasticsearch /usr/<span class="built_in">local</span>/elasticsearch-5.6.15</span><br></pre></td></tr></table></figure><h2 id="配置elasticsearch"><a href="#配置elasticsearch" class="headerlink" title="配置elasticsearch"></a>配置elasticsearch</h2><ul><li>修改<code>config/elasticsearch.yml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义节点名字</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">elasticsearch-1</span></span><br><span class="line"><span class="comment"># 定义数据目录</span></span><br><span class="line"><span class="string">path.data:</span> <span class="string">/home/esuser/data</span></span><br><span class="line"><span class="comment"># 定义日志目录</span></span><br><span class="line"><span class="string">path.logs:</span> <span class="string">/home/esuser/logs</span></span><br><span class="line"><span class="comment"># 定义节点为master</span></span><br><span class="line"><span class="string">node.master</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 定义节点为data</span></span><br><span class="line"><span class="string">node.data</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 启动时锁定内存，避免内存被系统swap</span></span><br><span class="line"><span class="string">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 定义监听端口</span></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment"># 定义服务端口</span></span><br><span class="line"><span class="string">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment"># 定义单播主机</span></span><br><span class="line"><span class="string">discovery.zen.ping.unicast.hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">elasticsearch-1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">elasticsearch-2</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure><ul><li>修改<code>config/jvm.options</code></li></ul><blockquote><p>这里只需要修改<code>-Xms</code>和<code>-Xmx</code>，默认是2g，最大不超过32g，两个选项的值保持一致</p></blockquote><ul><li>设置elasticsearch系统变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /home/esuser/elasticsearch &lt;&lt;EOF</span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>添加PATH</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/profile.d/elasticsearch.sh &lt;&lt;EOF</span><br><span class="line"><span class="built_in">export</span> ES_HOME=<span class="string">"/usr/local/elasticsearch"</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$ES_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><ul><li>创建systemd服务脚本</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=ElasticSearch Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/home/esuser/elasticsearch</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/elasticsearch/bin/elasticsearch</span><br><span class="line">PIDFile=/usr/<span class="built_in">local</span>/elasticsearch/run/elasticsearch.pid</span><br><span class="line">User=esuser</span><br><span class="line">LimitNOFILE=262144</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure><h1 id="启动elasticsearch"><a href="#启动elasticsearch" class="headerlink" title="启动elasticsearch"></a>启动elasticsearch</h1><ul><li>通过systemd命令启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now elasticsearch</span><br></pre></td></tr></table></figure><ul><li>命令行启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c <span class="string">"/usr/local/elasticsearch/bin/elasticsearch -d"</span> esuser</span><br></pre></td></tr></table></figure><ul><li>访问elasticsearch</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9200/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elasticsearch-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"JN0WSrAZQo2qWCaZrbDGjg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"5.6.15"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"fe7575a"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2019-02-13T16:21:45.880Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"6.6.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="安装elasticsearch-head"><a href="#安装elasticsearch-head" class="headerlink" title="安装elasticsearch-head"></a>安装elasticsearch-head</h1><ul><li>直接用容器启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=host --restart=always -d --name elasticsearch-head mobz/elasticsearch-head:5-alpine</span><br></pre></td></tr></table></figure><ul><li>访问elasticsearch-head</li></ul><p><code>curl -I http://127.0.0.1:9100</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a&gt;系统环境&lt;/h1&gt;&lt;h2 id=&quot;CentOS-7&quot;&gt;&lt;a href=&quot;#CentOS-7&quot; class=&quot;headerlink&quot; title=&quot;C
      
    
    </summary>
    
    
      <category term="Elasticsearch" scheme="https://luanlengli.github.io/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>MySQL5.7学习笔记</title>
    <link href="https://luanlengli.github.io/2019/02/15/MySQL5-7%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://luanlengli.github.io/2019/02/15/MySQL5-7学习笔记.html</id>
    <published>2019-02-15T10:33:01.000Z</published>
    <updated>2019-03-29T05:10:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="本文基于MySQL-5-7记录"><a href="#本文基于MySQL-5-7记录" class="headerlink" title="本文基于MySQL 5.7记录"></a>本文基于MySQL 5.7记录</h1><h1 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h1><h2 id="1、二进制安装"><a href="#1、二进制安装" class="headerlink" title="1、二进制安装"></a>1、二进制安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建mysql相关的组和用户</span></span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载二进制包</span></span><br><span class="line">cd /usr/local/</span><br><span class="line">wget --no-check-certificate https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar xvzf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将目录移动到/usr/<span class="built_in">local</span>/mysql</span></span><br><span class="line">ln -s mysql-5.7.24-linux-glibc2.12-x86_64 /usr/local/mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据库数据目录</span></span><br><span class="line">mkdir -p /path/to/mysql_data_dir</span><br><span class="line">chown -R mysql:mysql /path/to/mysql_data_dir</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用叶金荣的配置生成工具创建my.cnf文件放在/etc/my.cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://imysql.com/my-cnf-wizard.html</span></span><br><span class="line">chmod a+r /etc/my.cnf</span><br><span class="line">chown mysql:mysql /etc/my.cnf</span><br><span class="line">/usr/local/mysql/bin/mysqld --defaults-file=/etc/my.cnf --initialize --user=mysql --basedir=/usr/local/mysql/ --datadir=/mysql_data</span><br><span class="line">/usr/local/mysql/bin/mysql_ssl_rsa_setup --datadir=/mysql_data</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看error.log文件里面的root密码</span></span><br><span class="line">grep password error.log | awk '&#123;print$NF&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动MySQL</span></span><br><span class="line">mysqld_safe --user=mysql &amp;</span><br></pre></td></tr></table></figure><h2 id="2、rpm-deb软件源安装"><a href="#2、rpm-deb软件源安装" class="headerlink" title="2、rpm/deb软件源安装"></a>2、rpm/deb软件源安装</h2><p>以CentOS7为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取MySQL软件源</span></span><br><span class="line">yum install -y https://dev.mysql.com/get/mysql57-community-release-el7-1.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新YUM缓存</span></span><br><span class="line">yum makecache</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装MySQL5.7</span></span><br><span class="line">yum install mysql-community-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动MySQL</span></span><br><span class="line">systemctl start mysqld.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取ROOT密码</span></span><br><span class="line">grep 'temporary password' /var/log/mysqld.log</span><br></pre></td></tr></table></figure><h2 id="3、源码安装"><a href="#3、源码安装" class="headerlink" title="3、源码安装"></a>3、源码安装</h2><p>以CentOS7为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装编译环境</span></span><br><span class="line">yum -y install make gcc-c++ cmake bison-devel ncurses-devel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载MySQL源代码</span></span><br><span class="line">wget --no-check-certificate https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.24.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建MySQL相关的组和用户</span></span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建MySQL相关文件夹</span></span><br><span class="line">mkdir -p /app/mysql</span><br><span class="line">mkdir -p /app/data</span><br><span class="line">mkdir -p /app/etc</span><br><span class="line">mkdir -p /app/log</span><br><span class="line">chown -R mysql:mysql /app</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压源代码</span></span><br><span class="line">tar xvzf mysql-boost-5.7.24.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建cmake编译目录</span></span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用CMake生成makefile</span></span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/app/mysql/ \</span><br><span class="line">-DMYSQL_USER=mysql \</span><br><span class="line">-DMYSQL_TCP_PORT=3306 \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/app/data/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DEXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_READLINE=1 \</span><br><span class="line">-DWITH_SYSTEMD=1 \</span><br><span class="line">-DWITH_BOOST=/root/mysql-5.7.24/boost/boost_1_59_0/ \</span><br><span class="line">/root/mysql-5.7.24/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译安装</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用叶金荣MySQL配置生成工具生成my.cnf放在/app/etc/my.cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://imysql.com/my-cnf-wizard.html</span></span><br><span class="line">chown mysql:mysql /app/etc/my.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化MySQL数据库</span></span><br><span class="line">mysqld --initialize --defaults-file=/app/etc/my.cnf --user=mysql --basedir=/app/mysql/ --datadir=/app/data/</span><br><span class="line">mysql_ssl_rsa_setup --datadir=/app/data/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动MySQL数据库</span></span><br><span class="line">mysqld_safe --defaults-file=/app/etc/my.cnf --user=mysql &amp; </span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取MySQL ROOT密码</span></span><br><span class="line">grep password error.log | awk '&#123;print$NF&#125;'</span><br></pre></td></tr></table></figure><h2 id="4、安装后设定"><a href="#4、安装后设定" class="headerlink" title="4、安装后设定"></a>4、安装后设定</h2><h3 id="4-1、安全设置"><a href="#4-1、安全设置" class="headerlink" title="4.1、安全设置"></a>4.1、安全设置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure><h3 id="4-2、建议设置"><a href="#4-2、建议设置" class="headerlink" title="4.2、建议设置"></a>4.2、建议设置</h3><p>关闭主机名反向解析，在配置文件的[mysqld]里面添加skip_name_resolve = 1</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">...</span><br><span class="line">skip_name_resolve = 1</span><br></pre></td></tr></table></figure><h2 id="5、数据库连接"><a href="#5、数据库连接" class="headerlink" title="5、数据库连接"></a>5、数据库连接</h2><h3 id="5-1、mysql命令行客户端"><a href="#5-1、mysql命令行客户端" class="headerlink" title="5.1、mysql命令行客户端"></a>5.1、mysql命令行客户端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -ppassword -h127.0.0.1 -P3306 -D db1</span><br></pre></td></tr></table></figure><h3 id="5-2、MySQL-Benchmark图形客户端"><a href="#5-2、MySQL-Benchmark图形客户端" class="headerlink" title="5.2、MySQL Benchmark图形客户端"></a>5.2、MySQL Benchmark图形客户端</h3><p><a href="https://dev.mysql.com/downloads/workbench/" target="_blank" rel="noopener">官方网站下载页面</a></p><h2 id="6、获取MySQL编译的参数"><a href="#6、获取MySQL编译的参数" class="headerlink" title="6、获取MySQL编译的参数"></a>6、获取MySQL编译的参数</h2><p>在MySQL目录的docs/INFO_BIN</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 例如安装目录为/usr/<span class="built_in">local</span>/mysql</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MySQL官方YUM源安装的路径为/usr/share/doc/packages/MySQL-server</span></span><br><span class="line">cat /usr/local/bin/mysql/docs/INFO_BIN</span><br><span class="line">===== Information about the build process: =====</span><br><span class="line">Build was run at 2018-10-04 08:26:03 on host 'vitro45'</span><br><span class="line"></span><br><span class="line">Build was done on  Linux-3.8.13-16.2.1.el6uek.x86_64 using x86_64</span><br><span class="line">Build was done using cmake 2.8.12 </span><br><span class="line"></span><br><span class="line">===== Compiler flags used (from the 'sql/' subdirectory): =====</span><br><span class="line"><span class="meta">#</span><span class="bash"> compile C with /usr/bin/cc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> compile CXX with /usr/bin/c++</span></span><br><span class="line">C_FLAGS =  -fPIC -Wall -Wextra -Wformat-security -Wvla -Wwrite-strings -Wdeclaration-after-statement -O3 -g -fabi-version=2 -fno-omit-frame-pointer -fno-strict-aliasing -DDBUG_OFF -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/rapidjson/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/export -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/zlib -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/release/zlib -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/conn_handler -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/auth -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/regex -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/taocrypt/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/lz4 -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include/boost_1_59_0/patches -isystem /usr/global/share/boost_1_59_0    -DHAVE_YASSL -DYASSL_PREFIX -DHAVE_OPENSSL -DMULTI_THREADED</span><br><span class="line">C_DEFINES = -DHAVE_CONFIG_H -DHAVE_LIBEVENT1 -DHAVE_REPLICATION -DMYSQL_SERVER -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE</span><br><span class="line">CXX_FLAGS =  -fPIC -Wall -Wextra -Wformat-security -Wvla -Woverloaded-virtual -Wno-unused-parameter -O3 -g -fabi-version=2 -fno-omit-frame-pointer -fno-strict-aliasing -DDBUG_OFF -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/rapidjson/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/export -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/zlib -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/release/zlib -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/conn_handler -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/libbinlogevents/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/sql/auth -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/regex -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/yassl/taocrypt/include -I/export/home/pb2/build/sb_0-30854123-1538633287.09/release/sql -I/export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/extra/lz4 -isystem /export/home/pb2/build/sb_0-30854123-1538633287.09/mysql-5.7.24/include/boost_1_59_0/patches -isystem /usr/global/share/boost_1_59_0    -DHAVE_YASSL -DYASSL_PREFIX -DHAVE_OPENSSL -DMULTI_THREADED</span><br><span class="line">CXX_DEFINES = -DHAVE_CONFIG_H -DHAVE_LIBEVENT1 -DHAVE_REPLICATION -DMYSQL_SERVER -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE</span><br><span class="line"></span><br><span class="line">Pointer size: 8</span><br><span class="line"></span><br><span class="line">===== Feature flags used: =====</span><br><span class="line">-- Cache values</span><br><span class="line">BOOST_INCLUDE_DIR:PATH=/usr/global/share/boost_1_59_0</span><br><span class="line">BUILD_TESTING:BOOL=ON</span><br><span class="line">BUNDLE_MECAB:BOOL=ON</span><br><span class="line">CMAKE_BACKWARDS_COMPATIBILITY:STRING=2.4</span><br><span class="line">CMAKE_BUILD_TYPE:STRING=RelWithDebInfo</span><br><span class="line">CMAKE_INSTALL_PREFIX:PATH=/usr/local/mysql</span><br><span class="line">COMMUNITY_BUILD:BOOL=ON</span><br><span class="line">CTAGS_EXECUTABLE:FILEPATH=/usr/bin/ctags</span><br><span class="line">DEB_CHANGELOG_TIMESTAMP:STRING=Thu, 04 Oct 2018 08:14:16 +0200</span><br><span class="line">DEB_CODENAME:STRING=n/a</span><br><span class="line">DOWNLOAD_BOOST:BOOL=OFF</span><br><span class="line">DOWNLOAD_BOOST_TIMEOUT:STRING=600</span><br><span class="line">ENABLED_PROFILING:BOOL=ON</span><br><span class="line">ENABLE_DOWNLOADS:BOOL=OFF</span><br><span class="line">ENABLE_GCOV:BOOL=OFF</span><br><span class="line">ENABLE_GPROF:BOOL=OFF</span><br><span class="line">ENABLE_MEMCACHED_SASL:BOOL=OFF</span><br><span class="line">ENABLE_MEMCACHED_SASL_PWDB:BOOL=OFF</span><br><span class="line">EXECUTABLE_OUTPUT_PATH:PATH=</span><br><span class="line">FEATURE_SET:STRING=community</span><br><span class="line">INSTALL_LAYOUT:STRING=STANDALONE</span><br><span class="line">INSTALL_PKGCONFIGDIR:PATH=</span><br><span class="line">LIBRARY_OUTPUT_PATH:PATH=</span><br><span class="line">LOCAL_BOOST_DIR:FILEPATH=/usr/global/share/boost_1_59_0</span><br><span class="line">LOCAL_BOOST_ZIP:FILEPATH=/usr/global/share/boost_1_59_0.tar.gz</span><br><span class="line">LOCAL_GMOCK_ZIP:FILEPATH=/usr/global/share/googletest-release-1.8.0.zip</span><br><span class="line">MECAB_INCLUDE_DIR:PATH=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit/include</span><br><span class="line">MECAB_LIBRARY:FILEPATH=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit/lib/libmecab.a</span><br><span class="line">MERGE_UNITTESTS:BOOL=ON</span><br><span class="line">MUTEXTYPE:STRING=event</span><br><span class="line">MYSQL_DATADIR:PATH=/usr/local/mysql/data</span><br><span class="line">MYSQL_KEYRINGDIR:PATH=/usr/local/mysql/keyring</span><br><span class="line">MYSQL_MAINTAINER_MODE:BOOL=OFF</span><br><span class="line">OPTIMIZER_TRACE:BOOL=ON</span><br><span class="line">REPRODUCIBLE_BUILD:BOOL=OFF</span><br><span class="line">RPC_INCLUDE_DIR:PATH=/usr/include</span><br><span class="line">SASL_SYSTEM_LIBRARY:FILEPATH=/usr/lib64/libsasl2.so</span><br><span class="line">TMPDIR:PATH=P_tmpdir</span><br><span class="line">WITH_ARCHIVE_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_ASAN:BOOL=OFF</span><br><span class="line">WITH_ASAN_SCOPE:BOOL=OFF</span><br><span class="line">WITH_BLACKHOLE_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_BOOST:PATH=/usr/global/share</span><br><span class="line">WITH_CLIENT_PROTOCOL_TRACING:BOOL=ON</span><br><span class="line">WITH_DEBUG:BOOL=OFF</span><br><span class="line">WITH_DEFAULT_COMPILER_OPTIONS:BOOL=ON</span><br><span class="line">WITH_DEFAULT_FEATURE_SET:BOOL=ON</span><br><span class="line">WITH_EDITLINE:STRING=bundled</span><br><span class="line">WITH_EMBEDDED_SERVER:BOOL=ON</span><br><span class="line">WITH_EMBEDDED_SHARED_LIBRARY:BOOL=OFF</span><br><span class="line">WITH_EXTRA_CHARSETS:STRING=all</span><br><span class="line">WITH_FEDERATED_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_INNODB_EXTRA_DEBUG:BOOL=OFF</span><br><span class="line">WITH_INNODB_MEMCACHED:BOOL=1</span><br><span class="line">WITH_LIBEVENT:STRING=bundled</span><br><span class="line">WITH_LIBWRAP:BOOL=OFF</span><br><span class="line">WITH_LZ4:STRING=bundled</span><br><span class="line">WITH_MECAB:STRING=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit</span><br><span class="line">WITH_MECAB_PATH:PATH=/export/home/pb2/build/sb_0-30854123-1538633287.09/mecab-0.996-el6-x86-64bit</span><br><span class="line">WITH_MSAN:BOOL=OFF</span><br><span class="line">WITH_NGRAM_PARSER:BOOL=ON</span><br><span class="line">WITH_NUMA:BOOL=ON</span><br><span class="line">WITH_PARTITION_STORAGE_ENGINE:BOOL=ON</span><br><span class="line">WITH_PIC:BOOL=ON</span><br><span class="line">WITH_RAPID:BOOL=ON</span><br><span class="line">WITH_SASL:STRING=system</span><br><span class="line">WITH_SSL:STRING=bundled</span><br><span class="line">WITH_SYSTEMD:BOOL=OFF</span><br><span class="line">WITH_TEST_TRACE_PLUGIN:BOOL=OFF</span><br><span class="line">WITH_UBSAN:BOOL=OFF</span><br><span class="line">WITH_UNIT_TESTS:BOOL=ON</span><br><span class="line">WITH_VALGRIND:BOOL=OFF</span><br><span class="line">WITH_ZLIB:STRING=bundled</span><br><span class="line">XPLUGIN_LOG_PROTOBUF:STRING=1</span><br><span class="line"></span><br><span class="line">===== EOF =====</span><br></pre></td></tr></table></figure><h1 id="二、配置数据库"><a href="#二、配置数据库" class="headerlink" title="二、配置数据库"></a>二、配置数据库</h1><h2 id="1、配置文件路径"><a href="#1、配置文件路径" class="headerlink" title="1、配置文件路径"></a>1、配置文件路径</h2><p>文件优先级，同一个参数以最后一个为准，启动时可指定–default-file=/path/to/my.cnf</p><ul><li>/etc/my.cnf</li><li>/etc/mysql/my.cnf</li><li>$MYSQL_HOME/my.cnf</li><li>–default-extra-file=/path/to/*.cnf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port    = 3306</span><br><span class="line">socket    = /data/mysql/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=&quot;\u@mysqldb \R:\m:\s [\d]&gt; &quot;</span><br><span class="line">no-auto-rehash</span><br><span class="line">[mysqld]</span><br><span class="line">user    = mysql</span><br><span class="line">port    = 3306</span><br><span class="line">basedir    = /usr/local/mysql</span><br><span class="line">datadir    = /data/mysql/</span><br><span class="line">socket    = /data/mysql/mysql.sock</span><br><span class="line">pid-file = mysqldb.pid</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">open_files_limit    = 65535</span><br><span class="line">back_log = 1024</span><br><span class="line">max_connections = 512</span><br><span class="line">max_connect_errors = 1000000</span><br><span class="line">table_open_cache = 1024</span><br><span class="line">table_definition_cache = 1024</span><br><span class="line">table_open_cache_instances = 64</span><br><span class="line">thread_stack = 512K</span><br><span class="line">external-locking = FALSE</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">sort_buffer_size = 16M</span><br><span class="line">join_buffer_size = 16M</span><br><span class="line">thread_cache_size = 768</span><br><span class="line">interactive_timeout = 600</span><br><span class="line">wait_timeout = 600</span><br><span class="line">tmp_table_size = 96M</span><br><span class="line">max_heap_table_size = 96M</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /data/mysql/slow.log</span><br><span class="line">log-error = /data/mysql/error.log</span><br><span class="line">long_query_time = 0.1</span><br><span class="line">log_queries_not_using_indexes =1</span><br><span class="line">log_throttle_queries_not_using_indexes = 60</span><br><span class="line">min_examined_row_limit = 100</span><br><span class="line">log_slow_admin_statements = 1</span><br><span class="line">log_slow_slave_statements = 1</span><br><span class="line">server-id = 3306</span><br><span class="line">log-bin = /data/mysql/mybinlog</span><br><span class="line">sync_binlog = 1</span><br><span class="line">binlog_cache_size = 4M</span><br><span class="line">max_binlog_cache_size = 2G</span><br><span class="line">max_binlog_size = 1G</span><br><span class="line">expire_logs_days = 7</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line">slave-rows-search-algorithms = &apos;INDEX_SCAN,HASH_SCAN&apos;</span><br><span class="line">binlog_format = row</span><br><span class="line">binlog_checksum = 1</span><br><span class="line">relay_log_recovery = 1</span><br><span class="line">relay-log-purge = 1</span><br><span class="line">key_buffer_size = 32M</span><br><span class="line">read_buffer_size = 8M</span><br><span class="line">read_rnd_buffer_size = 16M</span><br><span class="line">bulk_insert_buffer_size = 64M</span><br><span class="line">myisam_sort_buffer_size = 128M</span><br><span class="line">myisam_max_sort_file_size = 10G</span><br><span class="line">myisam_repair_threads = 1</span><br><span class="line">lock_wait_timeout = 3600</span><br><span class="line">explicit_defaults_for_timestamp = 1</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_sync_spin_loops = 100</span><br><span class="line">innodb_spin_wait_delay = 30</span><br><span class="line">transaction_isolation = REPEATABLE-READ</span><br><span class="line">#innodb_additional_mem_pool_size = 16M</span><br><span class="line">innodb_buffer_pool_size = 45875M</span><br><span class="line">innodb_buffer_pool_instances = 4</span><br><span class="line">innodb_buffer_pool_load_at_startup = 1</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown = 1</span><br><span class="line">innodb_data_file_path = ibdata1:1G:autoextend</span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">innodb_log_buffer_size = 32M</span><br><span class="line">innodb_log_file_size = 2G</span><br><span class="line">innodb_log_files_in_group = 2</span><br><span class="line">innodb_max_undo_log_size = 2G</span><br><span class="line">innodb_undo_directory = undolog</span><br><span class="line">innodb_undo_tablespaces = 8</span><br><span class="line"># 根据您的服务器IOPS能力适当调整</span><br><span class="line"># 一般配普通SSD盘的话，可以调整到 10000 - 20000</span><br><span class="line"># 配置高端PCIe SSD卡的话，则可以调整的更高，比如 50000 - 80000</span><br><span class="line">innodb_io_capacity = 4000</span><br><span class="line">innodb_io_capacity_max = 8000</span><br><span class="line">innodb_flush_neighbors = 0</span><br><span class="line">innodb_write_io_threads = 8</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_purge_threads = 4</span><br><span class="line">innodb_page_cleaners = 4</span><br><span class="line">innodb_open_files = 65535</span><br><span class="line">innodb_max_dirty_pages_pct = 50</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_lru_scan_depth = 4000</span><br><span class="line">innodb_checksum_algorithm = crc32</span><br><span class="line">innodb_lock_wait_timeout = 10</span><br><span class="line">innodb_rollback_on_timeout = 1</span><br><span class="line">innodb_print_all_deadlocks = 1</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_online_alter_log_max_size = 2G</span><br><span class="line">internal_tmp_disk_storage_engine = InnoDB</span><br><span class="line">innodb_stats_on_metadata = 0</span><br><span class="line"># some var for MySQL 8</span><br><span class="line">log_error_verbosity = 3</span><br><span class="line">innodb_print_ddl_logs = 1</span><br><span class="line">binlog_expire_logs_seconds = 604800</span><br><span class="line">#innodb_dedicated_server = 0</span><br><span class="line">innodb_status_file = 1</span><br><span class="line"># 注意: 开启 innodb_status_output &amp; innodb_status_output_locks 后, 可能会导致log-error文件增长较快</span><br><span class="line">innodb_status_output = 0</span><br><span class="line">innodb_status_output_locks = 0</span><br><span class="line">#performance_schema</span><br><span class="line">performance_schema = 1</span><br><span class="line">performance_schema_instrument = &apos;%=on&apos;</span><br><span class="line">#innodb monitor</span><br><span class="line">innodb_monitor_enable=&quot;module_innodb&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_server&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_dml&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_ddl&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_trx&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_os&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_purge&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_log&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_lock&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_buffer&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_index&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_ibuf_system&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_buffer_page&quot;</span><br><span class="line">innodb_monitor_enable=&quot;module_adaptive_hash&quot;</span><br><span class="line">[mysqld_safe]</span><br><span class="line">[mysqld_multi]</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">[server]</span><br></pre></td></tr></table></figure></li></ul><h2 id="2、数据库变量"><a href="#2、数据库变量" class="headerlink" title="2、数据库变量"></a>2、数据库变量</h2><h3 id="2-1、查看数据库全局变量"><a href="#2-1、查看数据库全局变量" class="headerlink" title="2.1、查看数据库全局变量"></a>2.1、查看数据库全局变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables;</span><br></pre></td></tr></table></figure><h3 id="2-2、查看数据库会话变量"><a href="#2-2、查看数据库会话变量" class="headerlink" title="2.2、查看数据库会话变量"></a>2.2、查看数据库会话变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show session variables;</span><br></pre></td></tr></table></figure><h3 id="3、开启MySQL-SSL功能"><a href="#3、开启MySQL-SSL功能" class="headerlink" title="3、开启MySQL SSL功能"></a>3、开启MySQL SSL功能</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用MySQL自带工具生成证书</span></span><br><span class="line">mysql_ssl_rsa_setup --datadir=MYSQL_DATA_DIR</span><br><span class="line"><span class="meta">#</span><span class="bash"> 证书默认存放data-dir</span></span><br><span class="line">ll /mysql_data/*pem</span><br><span class="line">-rw------- 1 root root 1675 Oct 30 13:43 /mysql_data/ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1107 Oct 30 13:43 /mysql_data/ca.pem</span><br><span class="line">-rw-r--r-- 1 root root 1107 Oct 30 13:43 /mysql_data/client-cert.pem</span><br><span class="line">-rw------- 1 root root 1679 Oct 30 13:43 /mysql_data/client-key.pem</span><br><span class="line">-rw------- 1 root root 1675 Oct 30 13:43 /mysql_data/private_key.pem</span><br><span class="line">-rw-r--r-- 1 root root  451 Oct 30 13:43 /mysql_data/public_key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1107 Oct 30 13:43 /mysql_data/server-cert.pem</span><br><span class="line">-rw------- 1 root root 1675 Oct 30 13:43 /mysql_data/server-key.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件指明SSL证书路径</span></span><br><span class="line">[mysqld]</span><br><span class="line">ssl-ca=/mysql_data/ca.pem</span><br><span class="line">ssl-cert=/mysql_data/server-cert.pem</span><br><span class="line">ssl-key=/mysql_data/server-key.pem</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 查看数据库SSL变量</span><br><span class="line">mysql&gt; show global variables like &apos;%ssl%&apos;;</span><br><span class="line">+---------------+-----------------------------+</span><br><span class="line">| Variable_name | Value                       |</span><br><span class="line">+---------------+-----------------------------+</span><br><span class="line">| have_openssl  | DISABLED                    |</span><br><span class="line">| have_ssl      | DISABLED                    |</span><br><span class="line">| ssl_ca        | /mysql_data/ca.pem          |</span><br><span class="line">| ssl_capath    |                             |</span><br><span class="line">| ssl_cert      | /mysql_data/server-cert.pem |</span><br><span class="line">| ssl_cipher    |                             |</span><br><span class="line">| ssl_crl       |                             |</span><br><span class="line">| ssl_crlpath   |                             |</span><br><span class="line">| ssl_key       | /mysql_data/server-key.pem  |</span><br><span class="line">+---------------+-----------------------------+</span><br><span class="line"># 强制用户使用SSL登录</span><br><span class="line">mysql&gt; alter user &apos;username&apos;@&apos;host&apos; require ssl;</span><br><span class="line"># 创建用户时要求使用SSL登录</span><br><span class="line">mysql&gt; grant all privileges on dbname.tablename to &apos;username&apos;@&apos;host&apos; identified by &apos;password&apos; require ssl;</span><br><span class="line"># 取消强制用户使用SSL登录</span><br><span class="line">mysql&gt; alter user &apos;username&apos;@&apos;host&apos; require none;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用SSL证书登录数据库</span></span><br><span class="line">mysql -uUSERNAME -pPASSWORD -hHOSTNAME \</span><br><span class="line">--ssl-ca=ca.pem \</span><br><span class="line">--ssl-cert=client-cert.pem \</span><br><span class="line">--ssl-key=client-key.pem</span><br></pre></td></tr></table></figure><h1 id="三、事务隔离"><a href="#三、事务隔离" class="headerlink" title="三、事务隔离"></a>三、事务隔离</h1><p>一组原子性SQL操作，或者是独立的工作单元。</p><h2 id="1、ACID"><a href="#1、ACID" class="headerlink" title="1、ACID"></a>1、ACID</h2><h3 id="1-1、Atomicity原子性"><a href="#1-1、Atomicity原子性" class="headerlink" title="1.1、Atomicity原子性"></a>1.1、Atomicity原子性</h3><p>整个事务中的所有操作要么全部执行成功，要么失败后完全回滚。</p><h3 id="1-2、Consistency一致性"><a href="#1-2、Consistency一致性" class="headerlink" title="1.2、Consistency一致性"></a>1.2、Consistency一致性</h3><p>数据库总是从一个一致性状态转换到另一个一致性状态。</p><h3 id="1-3、Isolation隔离性"><a href="#1-3、Isolation隔离性" class="headerlink" title="1.3、Isolation隔离性"></a>1.3、Isolation隔离性</h3><p>一个事务的操作在提交之前，不能被其他会话所见。</p><p>可分为多个隔离级别</p><h3 id="1-4、Durability永久性"><a href="#1-4、Durability永久性" class="headerlink" title="1.4、Durability永久性"></a>1.4、Durability永久性</h3><p>事务一旦提交，操作结果将永久保存到数据库中。</p><h2 id="2、锁机制"><a href="#2、锁机制" class="headerlink" title="2、锁机制"></a>2、锁机制</h2><h3 id="2-1、写锁"><a href="#2-1、写锁" class="headerlink" title="2.1、写锁"></a>2.1、写锁</h3><p>其他事务不能读取，也不能写。</p><h3 id="2-2、读锁"><a href="#2-2、读锁" class="headerlink" title="2.2、读锁"></a>2.2、读锁</h3><p>其他事务可以读，但不能写。</p><h2 id="3、脏读"><a href="#3、脏读" class="headerlink" title="3、脏读"></a>3、脏读</h2><p>脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。</p><h2 id="4、不可重复读"><a href="#4、不可重复读" class="headerlink" title="4、不可重复读"></a>4、不可重复读</h2><p>是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。</p><h2 id="5、幻读"><a href="#5、幻读" class="headerlink" title="5、幻读"></a>5、幻读</h2><p>指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。</p><h2 id="6、事务隔离级别"><a href="#6、事务隔离级别" class="headerlink" title="6、事务隔离级别"></a>6、事务隔离级别</h2><p>默认是REPEATEABLE READ 可重复读</p><h3 id="6-1、READ-UNCOMMITED读未提交"><a href="#6-1、READ-UNCOMMITED读未提交" class="headerlink" title="6.1、READ UNCOMMITED读未提交"></a>6.1、READ UNCOMMITED读未提交</h3><p>事务间完全不隔离，会产生脏读，可以读取未提交的记录。</p><h3 id="6-2、READ-COMMITED读已提交"><a href="#6-2、READ-COMMITED读已提交" class="headerlink" title="6.2、READ COMMITED读已提交"></a>6.2、READ COMMITED读已提交</h3><p>仅能读取到已提交的记录，不会脏读，会不可重复读，会幻读。</p><h3 id="6-3、REPEATABLE-READ可重复读"><a href="#6-3、REPEATABLE-READ可重复读" class="headerlink" title="6.3、REPEATABLE READ可重复读"></a>6.3、REPEATABLE READ可重复读</h3><p>每次读取的结果集都相同，而不管其他事务有没有提交，但是无法阻止其他事务插入数据，因此可能导致幻读。</p><h3 id="6-4、SERIALIZABILE可串行化"><a href="#6-4、SERIALIZABILE可串行化" class="headerlink" title="6.4、SERIALIZABILE可串行化"></a>6.4、SERIALIZABILE可串行化</h3><p>最严格的锁，在事务完成前，其他事务无法对数据对象进行写操作。并行性能最差。</p><h1 id="四、数据库日志"><a href="#四、数据库日志" class="headerlink" title="四、数据库日志"></a>四、数据库日志</h1><h2 id="1、查询日志-query-log"><a href="#1、查询日志-query-log" class="headerlink" title="1、查询日志 query log"></a>1、查询日志 query log</h2><p>记录查询操作，产生额外IO消耗，一般不打开。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%general%&apos;;</span><br><span class="line">+------------------+---------------------------+</span><br><span class="line">| Variable_name    | Value                     |</span><br><span class="line">+------------------+---------------------------+</span><br><span class="line">| general_log      | OFF                       |</span><br><span class="line">| general_log_file | /var/log/hostname.log     |</span><br><span class="line">+------------------+---------------------------+</span><br><span class="line">mysql&gt; show global variables like &apos;log_output&apos;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_output    | FILE  |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure><h2 id="2、慢查询日志-slow-query-log"><a href="#2、慢查询日志-slow-query-log" class="headerlink" title="2、慢查询日志 slow query log"></a>2、慢查询日志 slow query log</h2><p>执行时长超过指定时长的查询操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;long_query_time&apos;;</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| Variable_name   | Value    |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| long_query_time | 0.100000 |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">&gt; show global variables like &apos;%slow%&apos;;</span><br><span class="line">+---------------------------+-------------------------+</span><br><span class="line">| Variable_name             | Value                   |</span><br><span class="line">+---------------------------+-------------------------+</span><br><span class="line">| log_slow_admin_statements | ON                      |</span><br><span class="line">| log_slow_slave_statements | ON                      |</span><br><span class="line">| slow_launch_time          | 2                       |</span><br><span class="line">| slow_query_log            | ON                      |</span><br><span class="line">| slow_query_log_file       | /var/log/mysql/slow.log |</span><br><span class="line">+---------------------------+-------------------------+</span><br></pre></td></tr></table></figure><h2 id="3、错误日志-error-log"><a href="#3、错误日志-error-log" class="headerlink" title="3、错误日志 error log"></a>3、错误日志 error log</h2><p>记录MySQL启动关闭过程输出的日志</p><p>记录MySQL运行过程中产生的错误日志</p><p>记录event scheduler运行event时产生的日志</p><p>记录主从复制架构中从服务器上启动从服务器线程时产生的日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; show global variables like &apos;%error%&apos;;</span><br><span class="line">+---------------------+--------------------------+</span><br><span class="line">| Variable_name       | Value                    |</span><br><span class="line">+---------------------+--------------------------+</span><br><span class="line">| binlog_error_action | ABORT_SERVER             |</span><br><span class="line">| log_error           | /var/log/mysql/error.log |</span><br><span class="line">| log_error_verbosity | 3                        |</span><br><span class="line">| max_connect_errors  | 1000000                  |</span><br><span class="line">| max_error_count     | 64                       |</span><br><span class="line">| slave_skip_errors   | OFF                      |</span><br><span class="line">+---------------------+--------------------------+</span><br></pre></td></tr></table></figure><h2 id="4、二进制日志-binary-log"><a href="#4、二进制日志-binary-log" class="headerlink" title="4、二进制日志 binary log"></a>4、二进制日志 binary log</h2><h3 id="4-1、介绍"><a href="#4-1、介绍" class="headerlink" title="4.1、介绍"></a>4.1、介绍</h3><p>记录对mysql数据更新或潜在发生更新的SQL语句，并以”事务”的形式保存在磁盘中。</p><p>用于通过“重放”日志生成数据副本。</p><h3 id="4-2、日志记录内容"><a href="#4-2、日志记录内容" class="headerlink" title="4.2、日志记录内容"></a>4.2、日志记录内容</h3><p>基于“语句”记录：statement</p><p>基于“行”记录：row</p><p>混合模式：mixed，由数据库自动判定</p><h3 id="4-3、日志文件构成"><a href="#4-3、日志文件构成" class="headerlink" title="4.3、日志文件构成"></a>4.3、日志文件构成</h3><p>日志文件：mysql-bin，二进制格式</p><p>索引文件：mysql-bin.index，文本格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show global variables like &apos;%bin%&apos;;</span><br><span class="line">+--------------------------------------------+----------------------------+</span><br><span class="line">| Variable_name                              | Value                      |</span><br><span class="line">+--------------------------------------------+----------------------------+</span><br><span class="line">| binlog_cache_size                          | 4194304                    |</span><br><span class="line">| binlog_checksum                            | CRC32                      |</span><br><span class="line">| binlog_direct_non_transactional_updates    | OFF                        |</span><br><span class="line">| binlog_error_action                        | ABORT_SERVER               |</span><br><span class="line">| binlog_format                              | ROW                        |</span><br><span class="line">| binlog_group_commit_sync_delay             | 0                          |</span><br><span class="line">| binlog_group_commit_sync_no_delay_count    | 0                          |</span><br><span class="line">| binlog_gtid_simple_recovery                | ON                         |</span><br><span class="line">| binlog_max_flush_queue_time                | 0                          |</span><br><span class="line">| binlog_order_commits                       | ON                         |</span><br><span class="line">| binlog_row_image                           | FULL                       |</span><br><span class="line">| binlog_rows_query_log_events               | OFF                        |</span><br><span class="line">| binlog_stmt_cache_size                     | 32768                      |</span><br><span class="line">| binlog_transaction_dependency_history_size | 25000                      |</span><br><span class="line">| binlog_transaction_dependency_tracking     | COMMIT_ORDER               |</span><br><span class="line">| innodb_api_enable_binlog                   | OFF                        |</span><br><span class="line">| innodb_locks_unsafe_for_binlog             | OFF                        |</span><br><span class="line">| log_bin                                    | ON                         |</span><br><span class="line">| log_bin_basename                           | /mysql_data/mybinlog       |</span><br><span class="line">| log_bin_index                              | /mysql_data/mybinlog.index |</span><br><span class="line">| log_bin_trust_function_creators            | OFF                        |</span><br><span class="line">| log_bin_use_v1_row_events                  | OFF                        |</span><br><span class="line">| log_statements_unsafe_for_binlog           | ON                         |</span><br><span class="line">| max_binlog_cache_size                      | 2147483648                 |</span><br><span class="line">| max_binlog_size                            | 1073741824                 |</span><br><span class="line">| max_binlog_stmt_cache_size                 | 18446744073709547520       |</span><br><span class="line">| sync_binlog                                | 1                          |</span><br><span class="line">+--------------------------------------------+----------------------------+</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show binary logs;</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| mybinlog.000001 |       177 |</span><br><span class="line">| mybinlog.000002 |     11841 |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">mysql &gt; show master status;</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File            | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                         |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mybinlog.000002 |    11841 |              |                  | 2c719e09-d6a4-11e8-b4f9-560000590d55:1-31 |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">mysql &gt; show binlog events in &apos;mybinlog.000002&apos; from 4 limit 1;</span><br><span class="line">+-----------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+-----------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mybinlog.000002 |   4 | Format_desc |      3306 |         123 | Server ver: 5.7.24-log, Binlog ver: 4 |</span><br><span class="line">+-----------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="4-4、mysqlbinlog工具读取二进制日志"><a href="#4-4、mysqlbinlog工具读取二进制日志" class="headerlink" title="4.4、mysqlbinlog工具读取二进制日志"></a>4.4、mysqlbinlog工具读取二进制日志</h3><p>基于时间点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -uroot -pxvnCv3Yz -hlocalhost -P3306 --start-datetime='2018-10-23 00:00:00' --stop-datetime='2018-10-24 13:00:00' -d myblog /mysql_data/mybinlog.000002</span><br></pre></td></tr></table></figure><p>基于position</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -uroot -pxvnCv3Yz -hlocalhost -P3306 --start-position=10613 --stop-position=11684 -d myblog /mysql_data/mybinlog.000002</span><br></pre></td></tr></table></figure><h3 id="4-5、二进制日志事件的格式"><a href="#4-5、二进制日志事件的格式" class="headerlink" title="4.5、二进制日志事件的格式"></a>4.5、二进制日志事件的格式</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># at 11305</span></span><br><span class="line"><span class="comment">#181024 11:38:30 server id 3306  end_log_pos 11684 CRC32 0xf0b28827     Query    thread_id=32    exec</span></span><br><span class="line">_time=0    error_code=0</span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">TIMESTAMP</span>=<span class="number">1540352310</span><span class="comment">/*!*/</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote_record_memory`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`vote_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`group_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`index_user_id`</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4</span><br><span class="line"><span class="comment">/*!*/</span>;</span><br></pre></td></tr></table></figure><p>事件发生的日期和时间： 181024 11:38:30</p><p>事件发生的服务器标识： server id 3306</p><p>事件结束位置： end_log_pos 11684</p><p>事件类型： Query</p><p>事件发生时所在服务器执行此事件的线程ID： thread_id=32</p><p>语句的时间戳与写入二进制文件的时间差： exec_time=0</p><p>错误代码： error_code=0</p><p>事件内容</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="built_in">TIMESTAMP</span>=<span class="number">1540352310</span><span class="comment">/*!*/</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote_record_memory`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`vote_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`group_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`index_user_id`</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4</span><br><span class="line"><span class="comment">/*!*/</span>;</span><br></pre></td></tr></table></figure><p>GTID：Global Transaction ID；全局事务ID</p><h2 id="5、中继日志-relay-log"><a href="#5、中继日志-relay-log" class="headerlink" title="5、中继日志 relay log"></a>5、中继日志 relay log</h2><p>主从复制架构中，从服务器将主服务器的二进制日志事件拷贝到自己的中继日志。</p><h2 id="6、事务日志-transaction-log"><a href="#6、事务日志-transaction-log" class="headerlink" title="6、事务日志 transaction log"></a>6、事务日志 transaction log</h2><p>由数据库引擎自行管理。</p><p>当有更新操作时，存储引擎只将数据在内存中的copy修改成更新后的值，但并不将数据的更新刷新的硬盘，只是将更新操作的行为记录到硬盘上的事务日志中。因为事务日志的记录是采用文件追加的方式，因此写日志的操作是磁盘上一小块区域内的顺序I/O，而不像随机I/O需要在磁盘的多个地方移动磁头。</p><p>因此事务日志的记录是非常快的。</p><p>事务日志由多个日志文件组组成，循环使用日志文件。</p><p>事务日志的大小需要根据实际情况设定。</p><h3 id="6-1、重做日志redo-log"><a href="#6-1、重做日志redo-log" class="headerlink" title="6.1、重做日志redo log"></a>6.1、重做日志redo log</h3><p>用于记录修改后的数据，顺序记录，可以根据这个文件的记录内容重新恢复数据。</p><h3 id="6-2、回滚日志undo-log"><a href="#6-2、回滚日志undo-log" class="headerlink" title="6.2、回滚日志undo log"></a>6.2、回滚日志undo log</h3><p>用于存放被修改前的数据，回滚操作，实现事务一致性。</p><h1 id="五、备份还原"><a href="#五、备份还原" class="headerlink" title="五、备份还原"></a>五、备份还原</h1><h2 id="1、为什么要备份"><a href="#1、为什么要备份" class="headerlink" title="1、为什么要备份"></a>1、为什么要备份</h2><ul><li>灾难备份</li><li>硬件故障</li><li>软件故障</li><li>自然灾害</li><li>黑客攻击</li><li>人为操作</li><li>业务测试</li></ul><h2 id="2、注意事项"><a href="#2、注意事项" class="headerlink" title="2、注意事项"></a>2、注意事项</h2><ul><li>能容忍丢失多少数据</li><li>备份操作持锁时长</li><li>备份负载</li><li>恢复数据的时长</li><li>需要恢复哪些数据</li><li>备份的有效性</li><li>备份恢复测试和演练</li><li>生产数据和备份数据分开存放</li></ul><h2 id="3、备份类型"><a href="#3、备份类型" class="headerlink" title="3、备份类型"></a>3、备份类型</h2><ul><li>热备：备份过程数据库可读可写</li><li>温备：备份过程数据库可读不可写</li><li>冷备：备份过程数据库不可读不可写</li><li>全量备份：完整数据集</li><li>增量备份：仅备份最近一次全备或者增备以来变化的数据</li><li>差异备份：仅备份最近一次全备以来变化的数据</li><li>物理备份：块级别备份，备份数据文件</li><li>逻辑备份：从数据库导出数据，与存储引擎无关，可用于数据迁移<h2 id="4、备份内容"><a href="#4、备份内容" class="headerlink" title="4、备份内容"></a>4、备份内容</h2></li><li>数据</li><li>二进制日志、InnoDB事务日志</li><li>配置文件</li><li>代码（存储过程、存储函数、触发器、事件调度器）<h2 id="5、逻辑备份工具"><a href="#5、逻辑备份工具" class="headerlink" title="5、逻辑备份工具"></a>5、逻辑备份工具</h2>Schema和数据存储在一个巨大的单个SQL语句文件<h3 id="5-1、mysqldump"><a href="#5-1、mysqldump" class="headerlink" title="5.1、mysqldump"></a>5.1、mysqldump</h3></li></ul><p><strong>MyISAM</strong>：备份库添加只读锁，直至备份完成</p><blockquote><p>默认导出所有数据库的所有表<br>锁定方法（对InnoDB有效实现温备）：<br>–lock-all-tables 锁定所有库的所有表<br>–log-tables 对于每个单独的数据库，在启动备份前锁定其所有表<br><strong>InnoDB</strong>：支持热备、温备<br>–single-transaction 设置本次会话隔离级别为Repeatable Read，确保本次会话不会看到其他会话提交的数据，保证数据一致性</p></blockquote><p>命令说明<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 备份指定数据库或者数据库中的表</span></span><br><span class="line">mysqldump [options] db_name [table_name]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份多个数据库</span></span><br><span class="line">mysqldump [options] --database db1 [db2, db3]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份所有数据库</span></span><br><span class="line">mysqldump [options] --all-databases</span><br></pre></td></tr></table></figure><p></p><p>命令示例<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 备份数据库db1，导出为db1.sql</span></span><br><span class="line">mysqldump -uroot -ppassword -h127.0.0.1 -P3306 db1 &gt; db1.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份数据库db1的table1表，导出为table1.sql</span></span><br><span class="line">mysqldump -uroot -ppassword -h127.0.0.1 -P3306 db1 table1 &gt; table1.sql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份数据库db1的table1和table2表，导出为table1_table2.sql</span></span><br><span class="line">mysqldump -uroot -ppassword -h127.0.0.1 -P3306 db1 table1 table2 &gt; table1_table2.sql</span><br></pre></td></tr></table></figure><p></p><h2 id="6、物理备份"><a href="#6、物理备份" class="headerlink" title="6、物理备份"></a>6、物理备份</h2><h3 id="6-1、xtrabackup"><a href="#6-1、xtrabackup" class="headerlink" title="6.1、xtrabackup"></a>6.1、xtrabackup</h3><p>适用于InnoDB和XtraDB，一般使用innobackupex（xtrabackup的命令简化版）</p><p><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="noopener">官方网站下载地址</a></p><p>安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载xtrabackup二进制包</span></span><br><span class="line">wget --no-check-certificate https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/tarball/percona-xtrabackup-2.4.12-Linux-x86_64.libgcrypt11.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压二进制包</span></span><br><span class="line">tar xvzf percona-xtrabackup-2.4.12-Linux-x86_64.libgcrypt11.tar.gz.tar.gz</span><br><span class="line">mv percona-xtrabackup-2.4.12-Linux-x86_64 /usr/local/</span><br><span class="line">ln -sv /usr/local/percona-xtrabackup-2.4.12-Linux-x86_64 /usr/local/xtrabackup</span><br></pre></td></tr></table></figure><p>命令说明</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 全量备份整个数据库（包括配置文件、二进制日志、重做日志、回滚日志、数据文件）</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --user=root --password=password --port=3306 BACKUP_DIR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 增量备份整个数据库</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --user=root --password=password --host=localhost --port=3306  --incremental --incremental-basedir=/backup_dir/YYYY-MM-DD_HH-mm-ss/ /mysql_backup/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将增量备份的redo <span class="built_in">log</span>合并到全量备份</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --apply-log --redo-only FULL_BACKUP_DIR</span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --apply-log --redo-only FULL_BACKUP_DIR --incremental-dir=/INCREMENTAL_BACKUP_DIR/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复全量备份</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --copy-back FULL_BACKUP_DIR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从全量备份中“导出”表</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要在配置中启用innodb_file_per_table=1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此命令会为每一个InnoDB表创建一个.exp结尾的文件仅包含数据，不包含表结构</span></span><br><span class="line">/usr/local/xtrabackup/bin/innobackupex --apply-log --export FULL_BACKUP_DIR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从全量备份中“导入”表</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create table table_name (...) engine=InnoDB;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> alter table db_name.table_name discard tablespaces;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将“导出”表的table_name.ibd和table_name文件拷贝到服务器数据目录，使用以下命令“导入”</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> alter table db_name.table_name import tablespaces;</span></span><br></pre></td></tr></table></figure><h3 id="6-2、其他备份工具"><a href="#6-2、其他备份工具" class="headerlink" title="6.2、其他备份工具"></a>6.2、其他备份工具</h3><ul><li><p>LVM快照</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 锁定所有表</span><br><span class="line">mysql &gt; flush tables with read lock;</span><br><span class="line"># 记录二进制日志文件和事件位置</span><br><span class="line">mysql &gt; flush logs;</span><br><span class="line">mysql -e &apos;show master status&apos; &gt; /path/to/file</span><br><span class="line"># 创建快照</span><br><span class="line">lvcreate -L # -s -p r -n NAME /dev/vg_name/lv_name</span><br><span class="line"># 释放锁</span><br><span class="line">mysql &gt; unlock tables;</span><br><span class="line"># 挂载快照卷，执行数据备份</span><br><span class="line"># 备份完成删除快照卷</span><br></pre></td></tr></table></figure></li></ul><h1 id="六、主从复制"><a href="#六、主从复制" class="headerlink" title="六、主从复制"></a>六、主从复制</h1><h2 id="1、主节点"><a href="#1、主节点" class="headerlink" title="1、主节点"></a>1、主节点</h2><blockquote><p>dump thread：为每个Slave的IO Thread 启动一个dump线程，向其发送binary log events</p></blockquote><h2 id="2、从节点"><a href="#2、从节点" class="headerlink" title="2、从节点"></a>2、从节点</h2><blockquote><p>IO Thread：从Master请求binary log events，并保存到中继日志</p><p>SQL Thread：从中继日志读取日志事件，在本地完成重放</p></blockquote><h2 id="3、特点"><a href="#3、特点" class="headerlink" title="3、特点"></a>3、特点</h2><ul><li>Mater和Slave之间是异步复制</li><li>主从数据不一致的情况比较常见</li></ul><h2 id="4、复制架构"><a href="#4、复制架构" class="headerlink" title="4、复制架构"></a>4、复制架构</h2><h3 id="4-1、主从复制"><a href="#4-1、主从复制" class="headerlink" title="4.1、主从复制"></a>4.1、主从复制</h3><h4 id="4-1-1、主节点配置过程"><a href="#4-1-1、主节点配置过程" class="headerlink" title="4.1.1、主节点配置过程"></a>4.1.1、主节点配置过程</h4><p>启动二进制日志</p><p>为当前节点设置全局唯一的ID号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin = master-binlog</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">server-id = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_flush_logs_at_trx_commit = 1</span><br><span class="line">sync_master_info = 1</span><br></pre></td></tr></table></figure><p>创建有复制权限的用户账号</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave,replication client on *.* to 'repuser'@'%' identified by 'password';</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h4 id="4-1-2、从节点配置过程"><a href="#4-1-2、从节点配置过程" class="headerlink" title="4.1.2、从节点配置过程"></a>4.1.2、从节点配置过程</h4><p>启动中继日志</p><p>为当前节点设置全局唯一的ID号</p><p>设置为只读状态（不影响主从复制）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip_slave_start = 1</span><br><span class="line">relay-log = relay-log</span><br><span class="line">relay-log = relay-log.index</span><br><span class="line">server-id = 2</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">read_only = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">sync_relay_log_info = 1</span><br></pre></td></tr></table></figure><p>使用有复制权限的用户账号连接到主服务器，并启动复制线程</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host='master-node',master_user='repuser',master_password='password',master_port=3306,master_log_file='mater-log.003',master_log_pos=1111,master_connect_retry=10;</span><br><span class="line">mysql&gt; start slave [io_thread|sql_thread];</span><br></pre></td></tr></table></figure><p>查看从状态信息</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure><h4 id="4-1-3、复制架构中应该注意的问题"><a href="#4-1-3、复制架构中应该注意的问题" class="headerlink" title="4.1.3、复制架构中应该注意的问题"></a>4.1.3、复制架构中应该注意的问题</h4><p>限制从服务器只读</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 确保my.cnf配置以下选项</span></span><br><span class="line">[mysqld]</span><br><span class="line">read_only = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> read_only对拥有super权限用户无效</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 阻止所有用户，不影响主从复制</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush tables with <span class="built_in">read</span> lock;</span></span><br></pre></td></tr></table></figure><p>保证主从复制事务安全</p><p>主节点配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次事务提交都写入binlog</span></span><br><span class="line">sync_binlog = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果启用了InnoDB，需要启用以下配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次事务提交时，<span class="built_in">log</span> buffer 会被写入到日志文件并刷写到磁盘。</span></span><br><span class="line">innodb_flush_logs_at_trx_commit = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次事务提交都写入master.info，这样在崩溃的时候，最多丢失一个事务，但是会造成大量的磁盘IO</span></span><br><span class="line">sync_master_info = 1</span><br></pre></td></tr></table></figure><p>从节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 手动启动slave</span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> slave的IO线程每次接受到master发送过来的binlog日志都要写入到系统缓冲去，然后刷入relay <span class="built_in">log</span>中继日志里面，这样在崩溃的时候，最多丢失一个事务，但是会造成大量的磁盘IO</span></span><br><span class="line">sync_relay_log = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> slave的IO线程每次接受到master发送过来的binlog日志都要写入到系统缓冲去，然后刷入relay-log.info中继日志里面，这样在崩溃的时候，最多丢失一个事务，但是会造成大量的磁盘IO</span></span><br><span class="line">sync_relay_log_info = 1</span><br></pre></td></tr></table></figure><h3 id="4-2、主主复制"><a href="#4-2、主主复制" class="headerlink" title="4.2、主主复制"></a>4.2、主主复制</h3><h4 id="4-2-1、注意事项"><a href="#4-2-1、注意事项" class="headerlink" title="4.2.1、注意事项"></a>4.2.1、注意事项</h4><p>互为主从</p><p>容易数据不一致，慎用</p><p>自动增长ID</p><p>A节点使用奇数ID</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">auto_increment_offset = 1</span><br><span class="line">auto_increment_increment = 2</span><br></pre></td></tr></table></figure><p>B节点使用偶数ID</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">auto_increment_increment = 2</span><br></pre></td></tr></table></figure><h4 id="4-2-2、配置步骤"><a href="#4-2-2、配置步骤" class="headerlink" title="4.2.2、配置步骤"></a>4.2.2、配置步骤</h4><p>使用唯一的server_id</p><p>启动bin_log和relay_log</p><p>创建拥有复制权限的用户</p><p>定义自动增长ID字段数值范围为奇偶</p><p>均把对方指定为主节点，启动复制线程</p><h3 id="4-3、半同步复制"><a href="#4-3、半同步复制" class="headerlink" title="4.3、半同步复制"></a>4.3、半同步复制</h3><p>跟主从复制类似</p><p>主节点会等待一个从节点写入完成再返回客户端写入成功</p><p>通过semisync插件提供半同步复制功能</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 二进制安装包</span></span><br><span class="line">/usr/local/mysql/lib/plugin/semisync_master.so</span><br><span class="line">/usr/local/mysql/lib/plugin/semisync_slave.so</span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm安装包</span></span><br><span class="line">/usr/lib64/mysql/plugin/semisync_master.so</span><br><span class="line">/usr/lib64/mysql/plugin/semisync_slave.so</span><br></pre></td></tr></table></figure><h4 id="4-3-1、主节点"><a href="#4-3-1、主节点" class="headerlink" title="4.3.1、主节点"></a>4.3.1、主节点</h4><p>启动二进制日志</p><p>为当前节点设置全局唯一的ID号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin = master-binlog</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">server-id = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_flush_logs_at_trx_commit = 1</span><br><span class="line">sync_master_info = 1</span><br></pre></td></tr></table></figure><p>创建有复制权限的用户账号</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave,replication client on *.* to 'repuser'@'%' identified by 'password';</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h4 id="4-3-2、从节点配置过程"><a href="#4-3-2、从节点配置过程" class="headerlink" title="4.3.2、从节点配置过程"></a>4.3.2、从节点配置过程</h4><p>启动中继日志</p><p>为当前节点设置全局唯一的ID号</p><p>设置为只读状态（不影响主从复制）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在my.cnf里面添加以下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip_slave_start = 1</span><br><span class="line">relay-log = relay-log</span><br><span class="line">relay-log = relay-log.index</span><br><span class="line">server-id = 2</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">read_only = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">sync_relay_log_info = 1</span><br></pre></td></tr></table></figure><p>使用有复制权限的用户账号连接到主服务器，并启动复制线程</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host='master-node',master_user='repuser',master_password='password',master_port=3306,master_log_file='mater-log.003',master_log_pos=1111,master_connect_retry=10;</span><br><span class="line">mysql&gt; start slave ;</span><br></pre></td></tr></table></figure><p>查看从状态信息</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure><h4 id="4-3-3、启动semicsync插件"><a href="#4-3-3、启动semicsync插件" class="headerlink" title="4.3.3、启动semicsync插件"></a>4.3.3、启动semicsync插件</h4><p>主节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 安装半同步复制master插件</span><br><span class="line">mysql&gt; install plugin rpl_semi_sync_master soname &apos;semisync_master.so&apos;;</span><br><span class="line">mysql&gt; show plugins;</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library            | License |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| rpl_semi_sync_master       | ACTIVE   | REPLICATION        | semisync_master.so | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">mysql&gt; &gt; show global variables like &apos;%semi%&apos;;</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| Variable_name                             | Value      |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| rpl_semi_sync_master_enabled              | OFF        |</span><br><span class="line">| rpl_semi_sync_master_timeout              | 10000      |</span><br><span class="line">| rpl_semi_sync_master_trace_level          | 32         |</span><br><span class="line">| rpl_semi_sync_master_wait_for_slave_count | 1          |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave        | ON         |</span><br><span class="line">| rpl_semi_sync_master_wait_point           | AFTER_SYNC |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line"># 启动半同步复制master节点</span><br><span class="line">mysql&gt; set global variables rpl_semi_sync_master_enable = 1</span><br><span class="line">mysql&gt; show status like &apos;%semi_sync_%&apos;;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_master_clients               | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 0     |</span><br><span class="line">| Rpl_semi_sync_slave_status                 | OFF   |</span><br><span class="line">+--------------------------------------------+-------+</span><br></pre></td></tr></table></figure><p>从节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 停止从节点复制线程</span><br><span class="line">mysql&gt; stop slave;</span><br><span class="line"># 安装半同步复制Slave插件</span><br><span class="line">mysql&gt; install plugin rpl_semi_sync_master soname &apos;semisync_slave.so&apos;;</span><br><span class="line">mysql&gt; &gt; show plugins;</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library            | License |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">| rpl_semi_sync_slave        | ACTIVE   | REPLICATION        | semisync_slave.so  | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+--------------------+---------+</span><br><span class="line">mysql&gt; &gt; show global variables like &apos;%semi%&apos;;</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| Variable_name                             | Value      |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| rpl_semi_sync_slave_enabled               | OFF        |</span><br><span class="line">| rpl_semi_sync_slave_trace_level           | 32         |</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line"># 启动半同步复制Slave插件</span><br><span class="line">mysql&gt; set global variables rpl_semi_sync_slave_enabled=1;</span><br><span class="line">mysql&gt; show status like &apos;%semi_sync_%&apos;;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Rpl_semi_sync_slave_status                 | ON    |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line"># 开启从节点复制线程</span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure><h2 id="5、复制过滤"><a href="#5、复制过滤" class="headerlink" title="5、复制过滤"></a>5、复制过滤</h2><h3 id="5-1、主服务器"><a href="#5-1、主服务器" class="headerlink" title="5.1、主服务器"></a>5.1、主服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库记录到binlog</span></span><br><span class="line">binlog_do_db = db1</span><br><span class="line">binlog_do_db = db2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略数据库</span></span><br><span class="line">binlog_ignore_db = db1,db2</span><br></pre></td></tr></table></figure><h3 id="5-2、从服务器"><a href="#5-2、从服务器" class="headerlink" title="5.2、从服务器"></a>5.2、从服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制数据库</span></span><br><span class="line">replicate_do_db = db1,db2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略复制数据库</span></span><br><span class="line">replicate_ignore_db = db1,db2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制表</span></span><br><span class="line">replicate_do_table = db.table1,db.table2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略复制表</span></span><br><span class="line">replicate_ingore_table = db.table1,db.table2</span><br></pre></td></tr></table></figure><h2 id="6、监控维护"><a href="#6、监控维护" class="headerlink" title="6、监控维护"></a>6、监控维护</h2><h3 id="6-1、相关文件"><a href="#6-1、相关文件" class="headerlink" title="6.1、相关文件"></a>6.1、相关文件</h3><h5 id="6-1-1、master-info"><a href="#6-1-1、master-info" class="headerlink" title="6.1.1、master.info"></a>6.1.1、master.info</h5><p>保存Slave连接至master时的相关信息，例如账号密码、服务器地址、Position等</p><h5 id="6-1-2、relay-log-info"><a href="#6-1-2、relay-log-info" class="headerlink" title="6.1.2、relay-log.info"></a>6.1.2、relay-log.info</h5><p>保存当前Slave节点已经复制的当前二进制日志与本地relay-log日志的对应项</p><h3 id="6-2、清理日志"><a href="#6-2、清理日志" class="headerlink" title="6.2、清理日志"></a>6.2、清理日志</h3><h3 id="6-3、复制监控"><a href="#6-3、复制监控" class="headerlink" title="6.3、复制监控"></a>6.3、复制监控</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">mysql&gt; show binlog events;</span><br><span class="line">mysql&gt; show binary logs;</span><br><span class="line">mysql&gt; show slave status;</span><br><span class="line">mysql&gt; show processlist;</span><br></pre></td></tr></table></figure><h3 id="6-4、从服务器是否落后于主服务器"><a href="#6-4、从服务器是否落后于主服务器" class="headerlink" title="6.4、从服务器是否落后于主服务器"></a>6.4、从服务器是否落后于主服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G;</span><br><span class="line">Seconds_Behind_Master: 0</span><br></pre></td></tr></table></figure><h3 id="6-5、确定主从数据是否一致"><a href="#6-5、确定主从数据是否一致" class="headerlink" title="6.5、确定主从数据是否一致"></a>6.5、确定主从数据是否一致</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖包</span></span><br><span class="line">yum install perl-Time-HiRes -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载二进制包</span></span><br><span class="line">wget https://www.percona.com/downloads/percona-toolkit/3.0.12/binary/tarball/percona-toolkit-3.0.12_x86_64.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar xzf percona-toolkit-3.0.12_x86_64.tar.gz</span><br><span class="line">mv percona-toolkit-3.0.12 /usr/local/</span><br><span class="line">ln -sv /usr/local/percona-toolkit-3.0.12 /usr/local/percona-toolkit</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行工具检查</span></span><br><span class="line">pt-table-checksum</span><br></pre></td></tr></table></figure><h3 id="6-6、数据不一致如何处理"><a href="#6-6、数据不一致如何处理" class="headerlink" title="6.6、数据不一致如何处理"></a>6.6、数据不一致如何处理</h3><p>重新同步</p><h1 id="七、MHA（Master-High-Availability）"><a href="#七、MHA（Master-High-Availability）" class="headerlink" title="七、MHA（Master High Availability）"></a>七、MHA（Master High Availability）</h1><h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>MHA(Master High Availability)目前在MySQL高可用方面是一个相对成熟的解决方案，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。MySQL故障切换过程中，MHA能做到在0～30秒之内自动完成数据库的故障切换操作，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p><p>该软件由两部分组成：MHA Manager(管理节点)和MHA Node(数据节点)。MHA Mananger可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点中，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p><p>在MHA自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据不丢失，但这这并不总是可行的。例如，如果主服务器硬件故障或无法通过ssh访问，MHA没法保存二进制日志，只进行故障转移而丢失了最新的数据。使用MySQL 5.5的半同步复制，可以大大降低数据丢失的风险。MHA可以与半同步复制结合起来。如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性。</p><h2 id="2、MHA组件"><a href="#2、MHA组件" class="headerlink" title="2、MHA组件"></a>2、MHA组件</h2><p>Manager节点</p><ul><li>masterha_check_ssh：MHA依赖的SSH环境检测工具</li><li>masterha_check_repl：MySQL复制环境检测工具</li><li>masterha_manager：MHA服务主程序</li><li>masterha_check_status：MHA运行状态探测工具</li><li>masterha_master_monitor：MySQL master节点监测工具</li><li>masterha_master_switch：master节点切换工具</li><li>masterha_conf_host：添加删除配置的节点</li><li>masterha_stop：关闭MHA服务</li></ul><p>Node节点</p><ul><li>save_binary_logs：保存复制master的binlog</li><li>apply_diff_relay_logs：识别差异的中继日志事件并应用到其他slave</li><li>filter_mysqlbinlog：去除不必要的rollback事件（已弃用）</li><li>purge_relay_logs：清除中继日志（不阻塞SQL线程）</li></ul><p>自定义扩展</p><ul><li>secondary_check_script：通过多条网络路由检查master可用性</li><li>master_ip_failover_script：更新Application使用的master IP地址</li><li>shutdown_script：关闭master节点</li><li>report_script：发送报告</li><li>init_conf_load_script：加载初始化配置参数</li><li>master_ip_online_chage_script：更新master节点IP地址</li></ul><h2 id="3、准备MHA环境"><a href="#3、准备MHA环境" class="headerlink" title="3、准备MHA环境"></a>3、准备MHA环境</h2><h3 id="3-1、MHA对MySQL复制环境有特殊要求"><a href="#3-1、MHA对MySQL复制环境有特殊要求" class="headerlink" title="3.1、MHA对MySQL复制环境有特殊要求"></a>3.1、MHA对MySQL复制环境有特殊要求</h3><ul><li>各节点开启二进制日志和中继日志</li><li>从节点需要配置read-only，关闭relay_log_purge</li></ul><h3 id="3-2、服务器角色分配"><a href="#3-2、服务器角色分配" class="headerlink" title="3.2、服务器角色分配"></a>3.2、服务器角色分配</h3><ul><li>manager：MHA Manager</li><li>db1：master节点</li><li>db2：slave节点</li><li>db3：slave节点</li></ul><h3 id="3-3、环境准备"><a href="#3-3、环境准备" class="headerlink" title="3.3、环境准备"></a>3.3、环境准备</h3><p>各节点启用epel源</p><p>各节点/etc/hosts文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">10.0.0.10 manager</span><br><span class="line">10.0.0.11 db1</span><br><span class="line">10.0.0.12 db2</span><br><span class="line">10.0.0.13 db3</span><br></pre></td></tr></table></figure><p>初始master节点配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> server_id必须唯一</span></span><br><span class="line">server_id=1</span><br><span class="line">relay-log=relay-log</span><br><span class="line">log-bin=master-bin</span><br></pre></td></tr></table></figure><p>初始Slave节点配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> server_id必须唯一</span></span><br><span class="line">server_id=2</span><br><span class="line">relay-log=relay-log</span><br><span class="line">log-bin=master-bin</span><br><span class="line">relay_log_purge=0</span><br><span class="line">read_only=1</span><br></pre></td></tr></table></figure><p>配置主从复制</p><p>db1配置为master节点</p><p>db2、db3以db1为master节点，开启slave线程</p><p>所有数据库节点创建MHA所需的管理用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all privileges on *.* to &apos;mhauser&apos;@&apos;%&apos; identified by &apos;password&apos;;</span><br></pre></td></tr></table></figure><p>配置manager、db1、db2、db3免密码SSH连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在manager节点上配置证书，分发到其他节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面以root用户为例</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">cat /root/.ssh/id_rsa &gt; /root/.ssh/authorized_keys</span><br><span class="line">chmod 0600 /root/.ssh/authorized_keys</span><br><span class="line">for i in db1 db2 db3;</span><br><span class="line">do</span><br><span class="line">scp -p .ssh/id_rcs .ssh/authorized_keys $i:/root/.ssh/</span><br><span class="line">done</span><br><span class="line">for i in manager db1 db2 db3;</span><br><span class="line">do</span><br><span class="line">ssh $i date</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="3-4、安装MHA"><a href="#3-4、安装MHA" class="headerlink" title="3.4、安装MHA"></a>3.4、安装MHA</h3><h4 id="3-4-1、node节点安装"><a href="#3-4-1、node节点安装" class="headerlink" title="3.4.1、node节点安装"></a>3.4.1、node节点安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖包</span></span><br><span class="line">yum install perl perl-DBD-MySQL -y</span><br><span class="line">wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br><span class="line">yum localinstall mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="3-4-2、manager节点安装配置"><a href="#3-4-2、manager节点安装配置" class="headerlink" title="3.4.2、manager节点安装配置"></a>3.4.2、manager节点安装配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装perl相关软件包</span></span><br><span class="line">yum install perl perl-DBD-MySQL -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载安装mha4mysql-manager软件包</span></span><br><span class="line">wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span><br><span class="line">yum localinstall mha4mysql-manager-0.58-0.el7.centos.noarch.rpm -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑MHA配置文件/etc/mha_app1.conf</span></span><br><span class="line">cat &gt; /etc/mha_app1.conf &lt;&lt;EOF</span><br><span class="line">[server default]</span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql创建给MHA使用的账号密码</span></span><br><span class="line">user=root</span><br><span class="line">password=supersecure</span><br><span class="line"><span class="meta">#</span><span class="bash"> manager工作目录</span></span><br><span class="line">manager_workdir=/data/masterha/app1</span><br><span class="line"><span class="meta">#</span><span class="bash"> manager日志路径</span></span><br><span class="line">manager_log=/data/masterha/app1/manager.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> MySQL工作目录</span></span><br><span class="line">remote_workdir=/data/masterha/app1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh使用的用户</span></span><br><span class="line">ssh_user=root</span><br><span class="line">repl_user=repluser</span><br><span class="line">repl_password=password</span><br><span class="line">ping_interval=1</span><br><span class="line">[server1]</span><br><span class="line">hostname=db1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh_port=22222</span></span><br><span class="line">candidate_master=1</span><br><span class="line">[server2]</span><br><span class="line">hostname=db2</span><br><span class="line">candidate_master=1</span><br><span class="line">[server3]</span><br><span class="line">hostname=db3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止节点切换成master节点可以配置no_master=1</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-4-3、manager节点检测配置和启动"><a href="#3-4-3、manager节点检测配置和启动" class="headerlink" title="3.4.3、manager节点检测配置和启动"></a>3.4.3、manager节点检测配置和启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 检查各节点ssh互信通信配置</span></span><br><span class="line">masterha_check_ssh --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查受管MySQL复制集群配置</span></span><br><span class="line">masterha_check_repl --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动mha4mysql-manager</span></span><br><span class="line">masterha_manager --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查mha4mysql-manager状态</span></span><br><span class="line">masterha_check_status --conf=/etc/mha_app1.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭mha4mysql-manager服务</span></span><br><span class="line">masterha_stop --conf=/etc/mha_app1.conf</span><br></pre></td></tr></table></figure><h4 id="3-4-4、MHA注意点"><a href="#3-4-4、MHA注意点" class="headerlink" title="3.4.4、MHA注意点"></a>3.4.4、MHA注意点</h4><ul><li>keepalived提供VIP和master切换的对应脚本</li><li>masterha_manager启动参数<ul><li>–remove_dead_master_conf，当发生主从切换后，老的主库的IP将会从配置文件中移除</li><li>–ignore_last_failover，MHA切换时会产生app1.failover.complete文件，两次切换时间少于8小时会切换失败，使用该参数能忽略</li></ul></li></ul><h1 id="八、复制的问题和解决"><a href="#八、复制的问题和解决" class="headerlink" title="八、复制的问题和解决"></a>八、复制的问题和解决</h1><h2 id="1、数据损坏和丢失"><a href="#1、数据损坏和丢失" class="headerlink" title="1、数据损坏和丢失"></a>1、数据损坏和丢失</h2><ul><li>Master<ul><li>MHA + 半同步复制</li></ul></li><li>Slave<ul><li>重新复制</li></ul></li></ul><h2 id="2、混合使用存储引擎"><a href="#2、混合使用存储引擎" class="headerlink" title="2、混合使用存储引擎"></a>2、混合使用存储引擎</h2><ul><li>MyISAM不支持事务</li><li>InnoDB支持事务</li></ul><h2 id="3、server-id不唯一"><a href="#3、server-id不唯一" class="headerlink" title="3、server_id不唯一"></a>3、server_id不唯一</h2><ul><li>重新复制</li></ul><h2 id="4、复制延迟"><a href="#4、复制延迟" class="headerlink" title="4、复制延迟"></a>4、复制延迟</h2><ul><li>需要额外的监控工具辅助</li></ul><h1 id="九、Percona-XtraDB-Cluster"><a href="#九、Percona-XtraDB-Cluster" class="headerlink" title="九、Percona XtraDB Cluster"></a>九、Percona XtraDB Cluster</h1><h2 id="1、介绍-1"><a href="#1、介绍-1" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>项目地址： <a href="http://www.percona.com/doc/percona-xtradb-cluster/intro.html" target="_blank" rel="noopener">http://www.percona.com/doc/percona-xtradb-cluster/intro.html</a></p><p>Percona XtraDB Cluster是MySQL高可用性和可扩展性的解决方案.</p><p>Percona XtraDB Cluster提供的特性有：</p><ul><li><p>同步复制，事务要么在所有节点提交或不提交。</p></li><li><p>多主复制，可以在任意节点进行写操作。</p></li><li><p>在从服务器上并行应用事件，真正意义上的并行复制。</p></li><li><p>节点自动配置。</p></li><li><p>数据一致性，不再是异步复制。</p></li></ul><p>Percona XtraDB Cluster完全兼容MySQL和Percona Server，表现在：</p><ul><li><p>数据的兼容性</p></li><li><p>应用程序的兼容性：无需更改应用程序</p></li></ul><h2 id="2、特点"><a href="#2、特点" class="headerlink" title="2、特点"></a>2、特点</h2><ul><li>当执行一个查询时，在本地节点上执行。因为所有数据都在本地，无需远程访问。</li><li>无需集中管理。可以在任何时间点失去任何节点，但是集群将照常工作。</li><li>良好的读负载扩展，任意节点都可以查询。</li><li>加入新节点，开销大。需要复制完整的数据。</li><li>不能有效的解决写缩放问题，所有的写操作都将发生在所有节点上。</li><li>有多少个节点就有多少重复的数据。</li></ul><h2 id="3、局限性"><a href="#3、局限性" class="headerlink" title="3、局限性"></a>3、局限性</h2><ul><li>目前的复制仅仅支持InnoDB存储引擎。任何写入其他引擎的表，包括mysql.*表将不会复制。但是DDL语句会被复制的，因此创建用户将会被复制，但是insert into mysql.user…将不会被复制的。</li><li>DELETE操作不支持没有主键的表。没有主键的表在不同的节点顺序将不同，如果执行SELECT…LIMIT… 将出现不同的结果集。</li><li>在多主环境下LOCK/UNLOCK TABLES不支持。以及锁函数GET_LOCK(), RELEASE_LOCK()..</li><li>查询日志不能保存在表中。如果开启查询日志，只能保存到文件中。</li><li>允许最大的事务大小由wsrep_max_ws_rows和wsrep_max_ws_size定义。任何大型操作将被拒绝。如大型的LOAD DATA操作。</li><li>由于集群是乐观的并发控制，事务commit可能在该阶段中止。如果有两个事务向在集群中不同的节点向同一行写入并提交，失败的节点将中止。对于集群级别的中止，集群返回死锁错误代码(Error: 1213 SQLSTATE: 40001 (ER_LOCK_DEADLOCK)).</li><li>XA事务不支持，由于在提交上可能回滚。</li><li>整个集群的写入吞吐量是由最弱的节点限制，如果有一个节点变得缓慢，那么整个集群将是缓慢的。为了稳定的高性能要求，所有的节点应使用统一的硬件。</li><li>集群节点建议最少3个。2个也可以运行，但是官方不推荐这么做，因为3个节点是为了预防脑裂。</li><li>如果DDL语句有问题将破坏集群。建议使用pt-online-schema-change操作DDL。</li></ul><h2 id="4、安装galera-cluster"><a href="#4、安装galera-cluster" class="headerlink" title="4、安装galera-cluster"></a>4、安装galera-cluster</h2><h3 id="4-1、软件包"><a href="#4-1、软件包" class="headerlink" title="4.1、软件包"></a>4.1、软件包</h3><p><a href="https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/" target="_blank" rel="noopener">官网下载地址</a></p><p><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/index.html" target="_blank" rel="noopener">官方文档地址</a></p><h3 id="4-2、准备工作"><a href="#4-2、准备工作" class="headerlink" title="4.2、准备工作"></a>4.2、准备工作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/hosts</span><br><span class="line">10.0.0.11 db1</span><br><span class="line">10.0.0.12 db2</span><br><span class="line">10.0.0.13 db3</span><br></pre></td></tr></table></figure><p>节点一</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">[root@db1 ~]# mkdir -p /usr/local/pxc</span><br><span class="line">[root@db1 ~]# mkdir -p /data/pxc/mysql3306/&#123;data,tmp,logs&#125;</span><br><span class="line"> </span><br><span class="line">[root@db1 ~]# vi /etc/my.cnf</span><br><span class="line"> [client]</span><br><span class="line">port    = 3306</span><br><span class="line">socket  = /data/pxc/mysql3306/tmp/mysql.sock</span><br><span class="line"><span class="meta">#</span><span class="bash"> The MySQL server</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########Basic##################</span></span></span><br><span class="line">explicit_defaults_for_timestamp=true</span><br><span class="line"></span><br><span class="line">port        = 3306  </span><br><span class="line">user        = mysql   </span><br><span class="line">basedir         = /usr/local/pxc</span><br><span class="line">datadir         = /data/pxc/mysql3306/data   </span><br><span class="line">tmpdir          = /data/pxc/mysql3306/tmp   </span><br><span class="line">pid-file        = /data/pxc/mysql3306/tmp/mysql.pid    </span><br><span class="line">socket            = /data/pxc/mysql3306/tmp/mysql.sock   </span><br><span class="line"><span class="meta">#</span><span class="bash">skip-grant-tables  </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">character <span class="built_in">set</span></span></span><br><span class="line">character_set_server = utf8</span><br><span class="line"></span><br><span class="line">open_files_limit = 65535</span><br><span class="line">back_log = 500</span><br><span class="line"><span class="meta">#</span><span class="bash">event_scheduler = ON</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lower_case_table_names=1</span></span><br><span class="line">skip-external-locking</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">default-storage-engine = InnoDB</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">timeout</span></span><br><span class="line">wait_timeout=1000</span><br><span class="line">interactive_timeout=1000</span><br><span class="line">connect_timeout = 20</span><br><span class="line"></span><br><span class="line">server-id       = 11  #ip最后一位</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">plugin</span></span><br><span class="line">plugin-load="semisync_master.so;semisync_slave.so"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########error log#############</span></span></span><br><span class="line">log-error = /data/pxc/mysql3306/logs/error.log  </span><br><span class="line">log-warnings = 2  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########general log#############</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">general_log=1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">general_log_file=/data/pxc/mysql3306/logs/mysql.log </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########slow log#############</span></span></span><br><span class="line">slow_query_log = 1</span><br><span class="line">long_query_time=1</span><br><span class="line">slow_query_log_file = /data/pxc/mysql3306/logs/mysql.slow   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############ for replication###################</span></span></span><br><span class="line">log-bin     = /data/pxc/mysql3306/logs/mysql-bin   </span><br><span class="line">binlog_format = row</span><br><span class="line">max_binlog_size = 50M</span><br><span class="line">binlog_cache_size = 2M</span><br><span class="line">max_binlog_cache_size = 2M</span><br><span class="line">expire-logs-days = 7</span><br><span class="line">slave-net-timeout=30</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line">log-slave-updates = 1   </span><br><span class="line">skip-slave-start = 1</span><br><span class="line"><span class="meta">#</span><span class="bash">super_read_only =1    </span></span><br><span class="line"><span class="meta">#</span><span class="bash">GTID</span></span><br><span class="line">gtid-mode = on</span><br><span class="line">binlog_gtid_simple_recovery=1</span><br><span class="line">enforce_gtid_consistency=1</span><br><span class="line"><span class="meta">#</span><span class="bash">relay <span class="built_in">log</span></span></span><br><span class="line">relay-log = /data/pxc/mysql3306/logs/mysql-relay  </span><br><span class="line">relay-log-index=/data/pxc/mysql3306/logs/relay-bin.index</span><br><span class="line">max-relay-log-size = 500M</span><br><span class="line"><span class="meta">#</span><span class="bash">replication crash safe</span></span><br><span class="line">sync_master_info = 1</span><br><span class="line">sync_relay_log_info = 1</span><br><span class="line">sync_relay_log = 1</span><br><span class="line">relay_log_recovery = 1</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">######per_thread_buffers#####################</span></span></span><br><span class="line">max_connections=1100</span><br><span class="line">max_user_connections=1000</span><br><span class="line">max_connect_errors=10000</span><br><span class="line"><span class="meta">#</span><span class="bash">myisam_recover</span></span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line"><span class="meta">#</span><span class="bash">table_cache = 3096</span></span><br><span class="line">table_open_cache = 6144</span><br><span class="line">table_definition_cache = 4096</span><br><span class="line">read_buffer_size = 1M</span><br><span class="line">join_buffer_size = 128K</span><br><span class="line">read_rnd_buffer_size = 1M</span><br><span class="line"><span class="meta">#</span><span class="bash">myisam</span></span><br><span class="line">sort_buffer_size = 128K</span><br><span class="line">myisam_max_sort_file_size = 1G</span><br><span class="line">myisam_repair_threads = 1</span><br><span class="line">myisam_sort_buffer_size = 32M</span><br><span class="line">tmp_table_size = 32M</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">query_cache_type=0</span><br><span class="line">query_cache_size = 0</span><br><span class="line">bulk_insert_buffer_size = 32M</span><br><span class="line">thread_cache_size = 64</span><br><span class="line"><span class="meta">#</span><span class="bash">thread_concurrency = 32</span></span><br><span class="line">thread_stack = 192K</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##############InnoDB###########################</span></span></span><br><span class="line">innodb_data_home_dir = /data/pxc/mysql3306/data      </span><br><span class="line">innodb_log_group_home_dir = /data/pxc/mysql3306/logs    </span><br><span class="line">innodb_data_file_path = ibdata1:10M:autoextend</span><br><span class="line">innodb_buffer_pool_size = 512M  #根据内存大小设置</span><br><span class="line">innodb_buffer_pool_instances    = 8</span><br><span class="line"><span class="meta">#</span><span class="bash">innodb_additional_mem_pool_size = 16M</span></span><br><span class="line">innodb_log_file_size = 50M</span><br><span class="line">innodb_log_buffer_size = 16M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_lock_wait_timeout = 10</span><br><span class="line">innodb_sync_spin_loops = 40</span><br><span class="line">innodb_max_dirty_pages_pct = 80</span><br><span class="line">innodb_support_xa = 1</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_thread_sleep_delay = 500</span><br><span class="line">innodb_concurrency_tickets = 1000</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_read_io_threads = 16</span><br><span class="line">innodb_write_io_threads = 16</span><br><span class="line">innodb_io_capacity = 800  </span><br><span class="line">innodb_flush_neighbors = 1</span><br><span class="line">innodb_file_format = Barracuda</span><br><span class="line">innodb_purge_threads=4   </span><br><span class="line">innodb_purge_batch_size = 32</span><br><span class="line">innodb_old_blocks_pct=75</span><br><span class="line">innodb_change_buffering=all</span><br><span class="line">innodb_stats_on_metadata=OFF</span><br><span class="line">innodb_print_all_deadlocks = 1</span><br><span class="line">performance_schema=0  </span><br><span class="line">transaction_isolation = READ-COMMITTED</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############ PXC #####################                                                 </span></span></span><br><span class="line">innodb_autoinc_lock_mode=2                                                       </span><br><span class="line">wsrep_cluster_name=pxc-dongzheng                                                 </span><br><span class="line">wsrep_provider=/usr/local/pxc/lib/libgalera_smm.so                             </span><br><span class="line">wsrep_cluster_address=gcomm://10.0.0.11,10.0.0.12,10.0.13     </span><br><span class="line">wsrep_node_address=10.0.0.11    # 本机IP地址                                          </span><br><span class="line">wsrep_slave_threads=2                                                            </span><br><span class="line">wsrep_sst_auth=sst:sky                                                     </span><br><span class="line">wsrep_sst_method=xtrabackup-v2                                                   </span><br><span class="line">wsrep_provider_options="debug=1"</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 128M</span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">max_allowed_packet = 128M</span><br><span class="line">prompt                         = '(product)\u@\h:\p [\d]&gt; '</span><br><span class="line">default_character_set          = utf8</span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">sort_buffer_size = 512k</span><br><span class="line">read_buffer = 2M</span><br><span class="line">write_buffer = 2M</span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="meta">#</span><span class="bash">malloc-lib= /usr/<span class="built_in">local</span>/mysql/lib/mysql/libjemalloc.so</span></span><br></pre></td></tr></table></figure><p>节点二、节点三修改my.cnf里面的对应值就行</p><ul><li><p>wsrep_node_address =</p></li><li><p>server-id =</p></li></ul><h3 id="4-3、启动集群"><a href="#4-3、启动集群" class="headerlink" title="4.3、启动集群"></a>4.3、启动集群</h3><p>先初始化节点一，将节点一加入集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动集群</span></span><br><span class="line">mysqld --defaults-file=/etc/my.cnf --initialize-insecure</span><br><span class="line">mysqld --defaults-file=/etc/my.cnf --wsrep-new-cluster &amp;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建账号</span><br><span class="line">mysql&gt; GRANT PROCESS, RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO &apos;sst&apos;@&apos;localhost&apos;IDENTIFIED BY &apos;sky&apos;;FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>节点二、节点三加入集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --defaults-file=/etc/my.cnf &amp;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;本文基于MySQL-5-7记录&quot;&gt;&lt;a href=&quot;#本文基于MySQL-5-7记录&quot; class=&quot;headerlink&quot; title=&quot;本文基于MySQL 5.7记录&quot;&gt;&lt;/a&gt;本文基于MySQL 5.7记录&lt;/h1&gt;&lt;h1 id=&quot;一、安装&quot;&gt;&lt;a href
      
    
    </summary>
    
    
      <category term="MySQL" scheme="https://luanlengli.github.io/tags/MySQL/"/>
    
      <category term="Database" scheme="https://luanlengli.github.io/tags/Database/"/>
    
  </entry>
  
  <entry>
    <title>Linux运维常见面试题</title>
    <link href="https://luanlengli.github.io/2019/02/14/Linux%E8%BF%90%E7%BB%B4%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98.html"/>
    <id>https://luanlengli.github.io/2019/02/14/Linux运维常见面试题.html</id>
    <published>2019-02-14T02:07:19.000Z</published>
    <updated>2019-02-15T02:36:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="LINUX系统软件安装和卸载的常见方法"><a href="#LINUX系统软件安装和卸载的常见方法" class="headerlink" title="LINUX系统软件安装和卸载的常见方法"></a><strong>LINUX系统软件安装和卸载的常见方法</strong></h2><ul><li><p>RHEL/CentOS系列</p><ul><li><p><code>rpm -e &quot;软件包名字&quot;</code></p></li><li><p><code>yum remove &quot;软件包名字&quot;</code>，此操作会卸载相关的依赖</p></li></ul></li><li><p>Debian/Ubuntu系列</p><ul><li><code>apt-get remove &quot;软件包名字&quot;</code>，不删除依赖，保留配置文件</li><li><code>apt-get autoremove &quot;软件包名字&quot;</code>，删除依赖，保留配置文件</li><li><code>apt-get purge &quot;软件包名字&quot;</code>，不删除依赖，删除配置文件</li></ul></li><li><p>源代码安装的，可以使用<code>make uninstall</code>，或者直接删掉软件目录</p></li></ul><h2 id="修改LINUX的主机名"><a href="#修改LINUX的主机名" class="headerlink" title="修改LINUX的主机名"></a><strong>修改LINUX的主机名</strong></h2><ul><li>RHEL/CentOS系列<ul><li><code>hostnamectl set-hostname &quot;主机名&quot;</code></li><li>修改<code>/etc/sysconfig/network</code>里面的<code>HOSTNAME</code></li></ul></li><li>Debian/Ubuntu系列<ul><li>修改<code>/etc/hosts</code>和<code>/etc/hostname</code>的主机名，然后运行<code>/etc/init.d/hostname.sh start</code></li></ul></li><li>临时有效<ul><li><code>hostname &quot;主机名&quot;</code></li></ul></li></ul><h2 id="自动切割压缩备份日志脚本"><a href="#自动切割压缩备份日志脚本" class="headerlink" title="自动切割压缩备份日志脚本"></a><strong>自动切割压缩备份日志脚本</strong></h2><ul><li>每天凌晨5点执行，带日期后缀</li><li>以Nginx日志为例</li><li>切割打包压缩前一天的日志之后，将压缩包上传到FTP服务器<code>192.168.1.2</code>账号<code>aaa</code>密码<code>bbb</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">LOG_PATH=<span class="string">'/path/to/nginx_log/'</span></span><br><span class="line">DATE=`date +%F`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让Nginx切割日志</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `ls | grep *<span class="built_in">log</span>`;<span class="keyword">do</span></span><br><span class="line">    mv <span class="variable">$&#123;file&#125;</span> <span class="variable">$&#123;file&#125;</span>.<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">nginx -s reopen</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包文件</span></span><br><span class="line">tar nginx_log_<span class="variable">$&#123;DATE&#125;</span>.tar.gz `ls *<span class="variable">$&#123;DATE&#125;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理日志文件</span></span><br><span class="line">rm -rf *<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line">ftp -n &lt;&lt;- EOF</span><br><span class="line">open 192.168.1.2</span><br><span class="line">user aaa bbb</span><br><span class="line">put nginx_log_<span class="variable">$&#123;DATE&#125;</span>.tar.gz</span><br><span class="line"><span class="built_in">bye</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除过期文件</span></span><br><span class="line">find <span class="variable">$&#123;LOG_PATH&#125;</span> -<span class="built_in">type</span> f -mtime +60 -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 5 * * * /bin/bash /path/to/logrotate.sh</span><br></pre></td></tr></table></figure><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a><strong>iptables</strong></h2><p><strong>允许来自127.0.0.1端口1234访问114.114.114.114端口80</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 127.0.0.1 --sport 1234 -d 114.114.114.114 --dport 80 -j ACCPET</span><br></pre></td></tr></table></figure><p><strong>禁用从lo进入的流量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j REJECT</span><br></pre></td></tr></table></figure><p><strong>允许外部访问22端口</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCPET</span><br></pre></td></tr></table></figure><p><strong>在postrouting链上，把源地址192.168.2.0/24的数据包源地址修改为192.168.1.2</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.2.0/24 -j SNAT --to-source 192.168.1.2</span><br></pre></td></tr></table></figure><p><strong>删除INPUT链上第八条规则</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -Ln --line-numbers</span><br><span class="line">iptables -D INPUT 8</span><br></pre></td></tr></table></figure><p><strong>eth0的数据包转发到eth1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT</span><br></pre></td></tr></table></figure><p><strong>iptables匹配参数</strong></p><ul><li><code>-A</code>：在chain里追加规则</li><li><code>-D</code>：删除chain里的规则</li><li><code>-I</code>：将规则插入到chain</li><li><code>-t</code>：指定表</li><li><code>-s</code>：匹配源地址</li><li><code>-d</code>：匹配目的地址</li><li><code>-p</code>：协议匹配</li><li><code>-i</code>：入口匹配</li><li><code>-o</code>：出口匹配</li><li><code>--sport</code>：源端口匹配</li><li><code>--dport</code>：出口端口匹配</li><li><code>-j</code>：数据包处理动作</li><li><code>!</code>：取反</li></ul><h2 id="iptables基本概念"><a href="#iptables基本概念" class="headerlink" title="iptables基本概念"></a>iptables基本概念</h2><h3 id="table"><a href="#table" class="headerlink" title="table"></a>table</h3><ul><li><code>raw</code> 用于配置数据包，<code>raw</code> 中的数据包不会被系统跟踪</li><li><code>filter</code> 是用于存放所有与防火墙相关操作的默认表</li><li><code>nat</code> 用于 网络地址转换（例如：端口转发）</li><li><code>mangle</code> 用于对特定数据包的修改</li><li><code>security</code> 用于 强制访问控制网络规则（例如： SELinux）</li></ul><h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                             XXX     Network    XXX</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                                       +</span><br><span class="line">                                       |</span><br><span class="line">                                       v</span><br><span class="line"> +-------------+              +------------------+</span><br><span class="line"> |table: filter| &lt;---+        | table: nat       |</span><br><span class="line"> |chain: INPUT |     |        | chain: PREROUTING|</span><br><span class="line"> +-----+-------+     |        +--------+---------+</span><br><span class="line">       |             |                 |</span><br><span class="line">       v             |                 v</span><br><span class="line"> [<span class="built_in">local</span> process]     |           ****************          +--------------+</span><br><span class="line">       |             +---------+ Routing decision +------&gt; |table: filter |</span><br><span class="line">       v                         ****************          |chain: FORWARD|</span><br><span class="line">****************                                           +------+-------+</span><br><span class="line">Routing decision                                                  |</span><br><span class="line">****************                                                  |</span><br><span class="line">       |                                                          |</span><br><span class="line">       v                        ****************                  |</span><br><span class="line">+-------------+       +------&gt;  Routing decision  &lt;---------------+</span><br><span class="line">|table: nat   |       |         ****************</span><br><span class="line">|chain: OUTPUT|       |               +</span><br><span class="line">+-----+-------+       |               |</span><br><span class="line">      |               |               v</span><br><span class="line">      v               |      +-------------------+</span><br><span class="line">+--------------+      |      | table: nat        |</span><br><span class="line">|table: filter | +----+      | chain: POSTROUTING|</span><br><span class="line">|chain: OUTPUT |             +--------+----------+</span><br><span class="line">+--------------+                      |</span><br><span class="line">                                      v</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br><span class="line">                             XXX    Network     XXX</span><br><span class="line">                               XXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure><h2 id="统计TCP连接状态"><a href="#统计TCP连接状态" class="headerlink" title="统计TCP连接状态"></a>统计TCP连接状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an|awk <span class="string">'/tcp/ &#123;print $6&#125;'</span>|sort|uniq -c</span><br></pre></td></tr></table></figure><h2 id="列出每个IP的TCP连接数"><a href="#列出每个IP的TCP连接数" class="headerlink" title="列出每个IP的TCP连接数"></a><strong>列出每个IP的TCP连接数</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -n | awk <span class="string">'/^tcp/ &#123;print $5&#125;'</span> | awk -F: <span class="string">'&#123;print $1&#125;'</span> | sort | uniq -c | sort -rn</span><br></pre></td></tr></table></figure><h2 id="生成随机字符串"><a href="#生成随机字符串" class="headerlink" title="生成随机字符串"></a><strong>生成随机字符串</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 20</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/urandom bs=128 count=1 2&gt;/dev/null | base64 | tr -d <span class="string">"=+/[:space:]"</span> | dd bs=32 count=1 2&gt;/dev/null</span><br></pre></td></tr></table></figure><h2 id="描述tcp三次握手的过程"><a href="#描述tcp三次握手的过程" class="headerlink" title="描述tcp三次握手的过程"></a><strong>描述tcp三次握手的过程</strong></h2><p>第一次握手：建立连接时，客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；</p><p>第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器 进入SYN_RECV状态；</p><p>第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入 ESTABLISHED状态，完成三次握手。</p><h2 id="内核参数的含义"><a href="#内核参数的含义" class="headerlink" title="内核参数的含义"></a><strong>内核参数的含义</strong></h2><ul><li><code>net.ipv4.tcp_tw_recycle=1</code><ul><li>启用此功能可以加快TIME-WAIT状态的TCP连接回收</li><li>内核会记录最后一个报文的时间戳，如果新的TCP报文时间戳小于最后一个报文的时间戳，则会drop包，导致无法建立TCP连接</li></ul></li><li><code>net.ipv4.tcp_tw_reuse=1</code><ul><li>允许将处于TIME-WAIT状态的socket用于新的TCP连接</li></ul></li><li><code>net.ipv4.tcp_timestamps=1</code><ul><li>发送TCP时间戳</li></ul></li><li><code>vm.swappiness=0</code><ul><li>最大限度使用物理内存，物理内存耗尽才启用swap</li></ul></li></ul><h2 id="Linux开机启动顺序"><a href="#Linux开机启动顺序" class="headerlink" title="Linux开机启动顺序"></a><strong>Linux开机启动顺序</strong></h2><p>以<code>BIOS-based</code>和<code>RHEL/CentOS-7</code>为例</p><ul><li>硬件加电</li><li>加载BIOS</li><li>硬件自检</li><li>BIOS按照启动顺序读取存储设备的MBR</li><li>根据MBR找到并加载bootloader</li><li>bootloader从<code>/boot</code>目录加载<code>vmlinuz</code>内核镜像，提取<code>initramfs</code>的内容并存放在<code>tmpfs</code>中</li><li>操作系统内核从<code>initramfs</code>中加载必要的驱动和挂载根文件系统，启动<code>systemd</code>作为第一个系统进程</li><li>systemd读取配置文件，读取<code>default-target</code>文件，引导至<code>default-target</code>定义的状态<ul><li>初始化网络</li><li>设置主机名</li><li>基于内核参数初始化硬件设备</li><li>加载文件系统</li><li>启动systemd服务</li></ul></li><li>启动完成</li></ul><h2 id="ps-aux中VSZ和RSS的含义"><a href="#ps-aux中VSZ和RSS的含义" class="headerlink" title="ps aux中VSZ和RSS的含义"></a>ps aux中VSZ和RSS的含义</h2><ul><li>VSZ：虚拟内存集，代表进程占用的虚拟内存空间</li><li>RSS：物理内存集，代表进程实际占用的物理内存空间</li></ul><h2 id="top命令中字段的含义"><a href="#top命令中字段的含义" class="headerlink" title="top命令中字段的含义"></a>top命令中字段的含义</h2><ul><li>PID：进程ID</li><li>USER：进程所有者的用户名</li><li>PR：进程优先级</li><li>NI：nice值，数值越小，优先级越高</li><li>VIRT：虚拟内存集，代表进程占用的虚拟内存空间</li><li>RES：物理内存集，代表进程实际占用的物理内存空间</li><li>SHR：共享内存大小</li><li>S：进程状态</li><li>%CPU：CPU时间占比</li><li>%MEM：物理内存占比</li><li>TIME+：进程使用的CPU时间总量</li><li>COMMAND：进程命令</li></ul><h2 id="load-average含义"><a href="#load-average含义" class="headerlink" title="load average含义"></a>load average含义</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load average: 0.00, 0.00, 0.00</span><br></pre></td></tr></table></figure><ul><li>分别代表1分钟内、5分钟内、15分钟内系统的平均负载</li><li>系统负载指的是运行队列的长度，即等待CPU的平均进程数</li><li>因此<code>load average的值=CPU核数</code>是最理想的状态</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;LINUX系统软件安装和卸载的常见方法&quot;&gt;&lt;a href=&quot;#LINUX系统软件安装和卸载的常见方法&quot; class=&quot;headerlink&quot; title=&quot;LINUX系统软件安装和卸载的常见方法&quot;&gt;&lt;/a&gt;&lt;strong&gt;LINUX系统软件安装和卸载的常见方法&lt;/
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>以DaemonSet的方式运行kube-proxy</title>
    <link href="https://luanlengli.github.io/2019/01/08/%E4%BB%A5DaemonSet%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8Ckube-proxy.html"/>
    <id>https://luanlengli.github.io/2019/01/08/以DaemonSet的方式运行kube-proxy.html</id>
    <published>2019-01-08T02:23:31.000Z</published>
    <updated>2019-04-14T02:03:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>通常来说，二进制部署kubernetes集群的时候，一般都是把kube-proxy作为系统守护进程启动，例如注册成为systemd服务。</p><p>用过kubeadm的同学都知道，kubeadm是以DaemonSet的方式部署kube-proxy，将kube-proxy托管到kubernetes集群管理。</p><p>这样可以很方便的通过修改kube-proxy的configmap来统一管控集群的kube-proxy配置。</p><h1 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h1><h2 id="创建yaml文件"><a href="#创建yaml文件" class="headerlink" title="创建yaml文件"></a>创建yaml文件</h2><p>kube-proxy-daemonset.yaml</p><ul><li>根据情况替换<code></code>和<code></code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:kube-proxy</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:node-proxier</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">config.conf:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">    bindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    clientConnection:</span></span><br><span class="line"><span class="attr">      acceptContentTypes:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      burst:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      contentType:</span> <span class="string">application/vnd.kubernetes.protobuf</span></span><br><span class="line"><span class="attr">      kubeconfig:</span> <span class="string">/var/lib/kube-proxy/kubeconfig.conf</span></span><br><span class="line"><span class="attr">      qps:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment"># 集群中pod的CIDR范围，从这个范围以外发送到服务集群IP的流量将被伪装，从POD发送到外部LoadBalanceIP的流量将被定向到各自的集群IP</span></span><br><span class="line"><span class="attr">    clusterCIDR:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">    configSyncPeriod:</span> <span class="number">15</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">    conntrack:</span></span><br><span class="line">      <span class="comment"># 每个核心最大能跟踪的NAT连接数，默认32768</span></span><br><span class="line"><span class="attr">      maxPerCore:</span> <span class="number">32768</span></span><br><span class="line"><span class="attr">      min:</span> <span class="number">131072</span></span><br><span class="line"><span class="attr">      tcpCloseWaitTimeout:</span> <span class="number">1</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">      tcpEstablishedTimeout:</span> <span class="number">24</span><span class="string">h0m0s</span></span><br><span class="line"><span class="attr">    enableProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10256</span></span><br><span class="line"><span class="attr">    hostnameOverride:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    iptables:</span></span><br><span class="line">      <span class="comment"># SNAT所有通过服务集群ip发送的通信</span></span><br><span class="line"><span class="attr">      masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      masqueradeBit:</span> <span class="number">14</span></span><br><span class="line"><span class="attr">      minSyncPeriod:</span> <span class="number">0</span><span class="string">s</span></span><br><span class="line"><span class="attr">      syncPeriod:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">    ipvs:</span></span><br><span class="line"><span class="attr">      minSyncPeriod:</span> <span class="number">0</span><span class="string">s</span></span><br><span class="line">      <span class="comment"># ipvs调度类型，默认是rr</span></span><br><span class="line"><span class="attr">      scheduler:</span> <span class="string">rr</span></span><br><span class="line"><span class="attr">      syncPeriod:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">    metricsBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10249</span></span><br><span class="line">    <span class="comment"># 使用ipvs模式</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">ipvs</span></span><br><span class="line"><span class="attr">    featureGates:</span></span><br><span class="line"><span class="attr">      SupportIPVSProxyMode:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    oomScoreAdj:</span> <span class="bullet">-999</span></span><br><span class="line"><span class="attr">    portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resourceContainer:</span> <span class="string">/kube-proxy</span></span><br><span class="line"><span class="attr">    udpIdleTimeout:</span> <span class="number">250</span><span class="string">ms</span></span><br><span class="line">  <span class="string">kubeconfig.conf:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">    clusters:</span></span><br><span class="line"><span class="attr">    - cluster:</span></span><br><span class="line"><span class="attr">        certificate-authority:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="attr">        server:</span> <span class="string">&#123;&#123;KUBE_APISERVER&#125;&#125;</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    contexts:</span></span><br><span class="line"><span class="attr">    - context:</span></span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">        namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">        user:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    users:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      user:</span></span><br><span class="line"><span class="attr">        tokenFile:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/usr/local/bin/kube-proxy</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--config=/var/lib/kube-proxy/config.conf</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">k8s.gcr.io/kube-proxy-amd64:&#123;&#123;KUBE_VERSION&#125;&#125;</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">        terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">host-time</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/var/lib/kube-proxy</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">lib-modules</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">beta.kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/disk-pressure</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/memory-pressure</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/unschedulable</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.kubernetes.io/network-unavailable</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - configMap:</span></span><br><span class="line"><span class="attr">          defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">kube-proxy</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">FileOrCreate</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">lib-modules</span></span><br><span class="line"><span class="attr">      - hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">host-time</span></span><br><span class="line"><span class="attr">  templateGeneration:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br></pre></td></tr></table></figure><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-proxy-daemonset.yaml</span><br></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;p&gt;通常来说，二进制部署kubernetes集群的时候，一般都是把kube-proxy作为系统守护进程启动，例如注册成为systemd服务。&lt;/
      
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://luanlengli.github.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>RHEL/CentOS升级OpenSSL和OpenSSH</title>
    <link href="https://luanlengli.github.io/2019/01/07/RHEL-CentOS%E5%8D%87%E7%BA%A7OpenSSL%E5%92%8COpenSSH.html"/>
    <id>https://luanlengli.github.io/2019/01/07/RHEL-CentOS升级OpenSSL和OpenSSH.html</id>
    <published>2019-01-07T15:01:46.000Z</published>
    <updated>2019-02-11T14:39:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><ul><li>本文以<code>openssl-1.0.2p</code>和<code>openssh-7.9p1</code>为例</li><li>先编译安装新版本的OpenSSL，然后基于新版本的OpenSSL编译安装OpenSSH</li><li>RHEL/CentOS-6.x和7.x的操作类似</li></ul></blockquote><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a><font color="red">注意事项</font></h1><blockquote><ul><li>请不要盲目复制粘贴</li><li>考虑好每一步的后果，做好备份</li><li>先拿测试服务器做白老鼠测试，通过之后再通过自动化部署的方式升级</li></ul></blockquote><h1 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h1><h2 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h2><p><a href="https://www.openssl.org/source/" target="_blank" rel="noopener">官网地址</a></p><h2 id="OpenSSH"><a href="#OpenSSH" class="headerlink" title="OpenSSH"></a>OpenSSH</h2><p><a href="https://www.openssh.com/portable.html" target="_blank" rel="noopener">官网地址</a></p><h1 id="检查当前版本"><a href="#检查当前版本" class="headerlink" title="检查当前版本"></a>检查当前版本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查openssl版本</span></span><br><span class="line">openssl version</span><br><span class="line"><span class="comment"># 检查ssh版本</span></span><br><span class="line">ssh -V</span><br><span class="line"><span class="comment"># 检查openssh-server版本</span></span><br><span class="line">sshd --version</span><br></pre></td></tr></table></figure><h1 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc make zlib-devel pam-devel libedit-devel krb5-devel</span><br></pre></td></tr></table></figure><h1 id="安装OpenSSL"><a href="#安装OpenSSL" class="headerlink" title="安装OpenSSL"></a>安装OpenSSL</h1><h2 id="解压源代码"><a href="#解压源代码" class="headerlink" title="解压源代码"></a>解压源代码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf openssl-1.0.2p.tar.gz</span><br></pre></td></tr></table></figure><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>编译选项参照CentOS-7.x软件包的<a href="https://git.centos.org/blob/rpms!!openssl/653b37a36fcfa8d53d73e34d10ac70e7aaafba1c/SPECS!openssl.spec" target="_blank" rel="noopener">选项</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> openssl-1.0.2p.tar.gz</span><br><span class="line">./config --prefix=/usr/<span class="built_in">local</span>/openssl-1.0.2p \</span><br><span class="line">         no-asm 386 \</span><br><span class="line">         zlib \</span><br><span class="line">         <span class="built_in">enable</span>-camellia \</span><br><span class="line">         <span class="built_in">enable</span>-seed \</span><br><span class="line">         <span class="built_in">enable</span>-tlsext \</span><br><span class="line">         <span class="built_in">enable</span>-rfc3779 \</span><br><span class="line">         <span class="built_in">enable</span>-cms \</span><br><span class="line">         <span class="built_in">enable</span>-md2 \</span><br><span class="line">         no-mdc2 \</span><br><span class="line">         no-rc5 \</span><br><span class="line">         no-ec2m \</span><br><span class="line">         no-gost \</span><br><span class="line">         no-srp \</span><br><span class="line">         --with-krb5-flavor=MIT \</span><br><span class="line">         shared</span><br><span class="line">make depend &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="备份旧版本的openssl"><a href="#备份旧版本的openssl" class="headerlink" title="备份旧版本的openssl"></a>备份旧版本的openssl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/bin/openssl /usr/bin/openssl.`date +%Y%m%d`bak</span><br><span class="line">mv /usr/include/openssl /usr/include/openssl.`date +%Y%m%d`bak</span><br><span class="line">mv /usr/lib64/openssl/engines /usr/lib64/openssl/engines.`date +%Y%m%d`bak</span><br></pre></td></tr></table></figure><h2 id="创建软链接到新版本openssl"><a href="#创建软链接到新版本openssl" class="headerlink" title="创建软链接到新版本openssl"></a>创建软链接到新版本openssl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -sv /usr/<span class="built_in">local</span>/openssl-1.0.2p/bin/openssl /usr/bin/openssl</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/openssl-1.0.2p/include/openssl /usr/include/openssl</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/openssl-1.0.2p/lib/engines/ /usr/lib64/openssl/engines</span><br></pre></td></tr></table></figure><h2 id="创建新版本的链接库"><a href="#创建新版本的链接库" class="headerlink" title="创建新版本的链接库"></a>创建新版本的链接库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/ld.so.conf.d/openssl-1.0.2p.conf &lt;&lt;EOF</span><br><span class="line"><span class="comment"># OpenSSL 1.0.2p</span></span><br><span class="line">/usr/<span class="built_in">local</span>/openssl-1.0.2p/lib</span><br><span class="line">EOF</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><h2 id="检查openssl版本"><a href="#检查openssl版本" class="headerlink" title="检查openssl版本"></a>检查openssl版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl version</span><br></pre></td></tr></table></figure><h1 id="安装OpenSSH"><a href="#安装OpenSSH" class="headerlink" title="安装OpenSSH"></a>安装OpenSSH</h1><h2 id="解压源代码-1"><a href="#解压源代码-1" class="headerlink" title="解压源代码"></a>解压源代码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf openssh-7.9p1.tar.gz</span><br></pre></td></tr></table></figure><h2 id="使用新版OpenSSL编译安装OpenSSH"><a href="#使用新版OpenSSL编译安装OpenSSH" class="headerlink" title="使用新版OpenSSL编译安装OpenSSH"></a>使用新版OpenSSL编译安装OpenSSH</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> openssh-7.9p1</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/openssh-7.9p1 \</span><br><span class="line">            --with-ssl-dir=/usr/<span class="built_in">local</span>/openssl-1.0.2p \</span><br><span class="line">            --with-md5-passwords \</span><br><span class="line">            --with-mantype=man \</span><br><span class="line">            --<span class="built_in">disable</span>-strip \</span><br><span class="line">            --with-smartcard \</span><br><span class="line">            --with-pam \</span><br><span class="line">            --with-kerberos5</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h2 id="备份替换OpenSSH"><a href="#备份替换OpenSSH" class="headerlink" title="备份替换OpenSSH"></a>备份替换OpenSSH</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> binary <span class="keyword">in</span> `ls /usr/<span class="built_in">local</span>/openssh-7.9p1/bin/`;<span class="keyword">do</span></span><br><span class="line">    mv /usr/bin/<span class="variable">$&#123;binary&#125;</span> /usr/bin/<span class="variable">$&#123;binary&#125;</span>.`date +%Y%m%d`bak</span><br><span class="line">    ln -sv /usr/<span class="built_in">local</span>/openssh-7.9p1/bin/<span class="variable">$&#123;binary&#125;</span> /usr/bin/<span class="variable">$&#123;binary&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">exec</span> <span class="keyword">in</span> `ls /usr/<span class="built_in">local</span>/openssh-7.9p1/libexec/`;<span class="keyword">do</span></span><br><span class="line">    mv /usr/libexec/openssh/<span class="variable">$&#123;exec&#125;</span> /usr/libexec/openssh/<span class="variable">$&#123;exec&#125;</span>.`date +%Y%m%d`bak</span><br><span class="line">    ln -sv /usr/<span class="built_in">local</span>/openssh-7.9p1/libexec/<span class="variable">$&#123;exec&#125;</span> /usr/libexec/openssh/<span class="variable">$&#123;exec&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sbinary <span class="keyword">in</span> `ls /usr/<span class="built_in">local</span>/openssh-7.9p1/sbin/`;<span class="keyword">do</span></span><br><span class="line">    mv /usr/sbin/<span class="variable">$&#123;sbinary&#125;</span> /usr/sbin/<span class="variable">$&#123;sbinary&#125;</span>.`date +%Y%m%d`bak</span><br><span class="line">    ln -sv /usr/<span class="built_in">local</span>/openssh-7.9p1/sbin/<span class="variable">$&#123;sbinary&#125;</span> /usr/sbin/<span class="variable">$&#123;sbinary&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="链接配置目录到新版本的OpenSSH"><a href="#链接配置目录到新版本的OpenSSH" class="headerlink" title="链接配置目录到新版本的OpenSSH"></a>链接配置目录到新版本的OpenSSH</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/<span class="built_in">local</span>/openssh-7.9p1/etc /usr/<span class="built_in">local</span>/openssh-7.9p1/etc.bak</span><br><span class="line">ln -sv /etc/ssh /usr/<span class="built_in">local</span>/openssh-7.9p1/etc</span><br><span class="line">find /etc/ssh/ -name <span class="string">'*key'</span> -<span class="built_in">exec</span> chmod 0400 &#123;&#125; \;</span><br></pre></td></tr></table></figure><h2 id="检查SSH配置"><a href="#检查SSH配置" class="headerlink" title="检查SSH配置"></a>检查SSH配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshd -t -f /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><h2 id="重启SSH服务"><a href="#重启SSH服务" class="headerlink" title="重启SSH服务"></a>重启SSH服务</h2><blockquote><ul><li>RHEL/CentOS-6.x</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></table></figure><blockquote><ul><li>RHEL/CentOS-7.x</li></ul></blockquote><p>修改<code>/usr/lib/systemd/system/sshd.service</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/sshd.service</span><br><span class="line">...</span><br><span class="line">Type=simple</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>重启sshd服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><h2 id="检查OpenSSH版本"><a href="#检查OpenSSH版本" class="headerlink" title="检查OpenSSH版本"></a>检查OpenSSH版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -V</span><br><span class="line">sshd --version</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;本文以&lt;code&gt;openssl-1.0.2p&lt;/code&gt;和&lt;code&gt;openssh-7.9p1&lt;/c
      
    
    </summary>
    
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>etcd学习笔记</title>
    <link href="https://luanlengli.github.io/2018/12/22/etcd%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://luanlengli.github.io/2018/12/22/etcd学习笔记.html</id>
    <published>2018-12-22T08:49:18.000Z</published>
    <updated>2019-02-14T06:31:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>kubernetes底层数据存放在etcd中，这里记录一下学习的笔记。</p><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><blockquote><ul><li>Etcd 是 CoreOS 推出的分布式一致性键值存储，用于共享配置和服务发现</li><li>Etcd 支持集群模式部署，从而实现自身高可用</li><li>本文以<code>CentOS-7.6</code>和<code>etcd-v3.3.10</code>为例</li></ul></blockquote><h1 id="etcd安装"><a href="#etcd安装" class="headerlink" title="etcd安装"></a>etcd安装</h1><h2 id="二进制文件安装"><a href="#二进制文件安装" class="headerlink" title="二进制文件安装"></a>二进制文件安装</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载并解压</span></span><br><span class="line">wget -q -O - https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz | tar xz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看解压后的文件</span></span><br><span class="line">ls etcd-v3.3.10-linux-amd64</span><br><span class="line">Documentation  etcd  etcdctl  README-etcdctl.md  README.md  READMEv2-etcdctl.md</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将二进制执行文件移动到/usr/<span class="built_in">local</span>/bin/</span></span><br><span class="line">mv etcd-v3.3.10-linux-amd64/etcd etcd-v3.3.10-linux-amd64/etcdctl /usr/local/bin/</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r etcd</span><br><span class="line">useradd -r -g etcd -s /bin/false etcd</span><br></pre></td></tr></table></figure><h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/etcd /etc/etcd/</span><br></pre></td></tr></table></figure><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>创建配置文件etcd.config.yaml，内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'default'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/default.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="attr">http://localhost:2380</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="attr">http://localhost:2380</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">[stderr]</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h4 id="创建服务文件"><a href="#创建服务文件" class="headerlink" title="创建服务文件"></a>创建服务文件</h4><p>使用systemd托管etcd的服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd key-value store</span><br><span class="line">Documentation=https://github.com/etcd-io/etcd</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=etcd</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file /etc/etcd/etcd.config.yaml</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="运行etcd"><a href="#运行etcd" class="headerlink" title="运行etcd"></a>运行etcd</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R etcd:etcd /var/lib/etcd /etc/etcd</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd.service</span><br></pre></td></tr></table></figure><h3 id="验证etcd服务"><a href="#验证etcd服务" class="headerlink" title="验证etcd服务"></a>验证etcd服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl cluster-health</span><br><span class="line">member 8e9e05c52164694d is healthy: got healthy result from http://localhost:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure><h1 id="etcd集群部署"><a href="#etcd集群部署" class="headerlink" title="etcd集群部署"></a>etcd集群部署</h1><h2 id="构建集群的方式"><a href="#构建集群的方式" class="headerlink" title="构建集群的方式"></a>构建集群的方式</h2><h3 id="静态发现"><a href="#静态发现" class="headerlink" title="静态发现"></a>静态发现</h3><p>预先已知 Etcd 集群中有哪些节点，在启动时直接指定好 Etcd 的各个 node 节点地址</p><h3 id="动态发现"><a href="#动态发现" class="headerlink" title="动态发现"></a>动态发现</h3><p>通过已有的 Etcd 集群作为数据交互点，然后在扩展新的集群时实现通过已有集群进行服务发现的机制</p><h3 id="DNS动态发现"><a href="#DNS动态发现" class="headerlink" title="DNS动态发现"></a>DNS动态发现</h3><p>通过 DNS 查询方式获取其他节点地址信息</p><h2 id="节点信息"><a href="#节点信息" class="headerlink" title="节点信息"></a>节点信息</h2><font color="red">这里只提供静态发现部署etcd集群的流程</font><table><thead><tr><th style="text-align:center">IP地址</th><th style="text-align:center">主机名</th><th style="text-align:center">CPU</th><th style="text-align:center">内存</th></tr></thead><tbody><tr><td style="text-align:center">172.16.80.201</td><td style="text-align:center">etcd1</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.202</td><td style="text-align:center">etcd2</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.203</td><td style="text-align:center">etcd3</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr></tbody></table><h2 id="静态发现部署etcd集群"><a href="#静态发现部署etcd集群" class="headerlink" title="静态发现部署etcd集群"></a>静态发现部署etcd集群</h2><h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><h4 id="etcd1"><a href="#etcd1" class="headerlink" title="etcd1"></a>etcd1</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'etcd1'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/etcd1.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">'http://172.16.80.201:2380'</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">'http://172.16.80.201:2379,http://127.0.0.1:2379'</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">'http://172.16.80.201:2380'</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">'http://172.16.80.201:2379'</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">'etcd1=http://172.16.80.201:2380,etcd2=http://172.16.80.202:2380,etcd3=http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">['stderr']</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h4 id="etcd2"><a href="#etcd2" class="headerlink" title="etcd2"></a>etcd2</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'etcd2'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/etcd2.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">'http://172.16.80.202:2380'</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">'http://172.16.80.202:2379,http://127.0.0.1:2379'</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">'http://172.16.80.202:2380'</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">'http://172.16.80.202:2379'</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">'etcd1=http://172.16.80.201:2380,etcd2=http://172.16.80.202:2380,etcd3=http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">[stderr]</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h4 id="etcd3"><a href="#etcd3" class="headerlink" title="etcd3"></a>etcd3</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the configuration file for the etcd server.</span></span><br><span class="line"><span class="comment"># Human-readable name for this member.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">'etcd3'</span></span><br><span class="line"><span class="comment"># Path to the data directory.</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd/etcd3.etcd</span></span><br><span class="line"><span class="comment"># Path to the dedicated wal directory.</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="comment"># Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of a heartbeat interval.</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for an election to timeout.</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="comment"># default quota.</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for peer traffic.</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">'http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># List of comma separated URLs to listen on for client traffic.</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">'http://172.16.80.203:2379,http://127.0.0.1:2379'</span></span><br><span class="line"><span class="comment"># Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># Comma-separated white list of origins for CORS (cross-origin resource sharing).</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="comment"># List of this member's peer URLs to advertise to the rest of the cluster.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">'http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># List of this member's client URLs to advertise to the public.</span></span><br><span class="line"><span class="comment"># The URLs needed to be a comma-separated list.</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">'http://172.16.80.203:2379'</span></span><br><span class="line"><span class="comment"># Discovery URL used to bootstrap the cluster.</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="comment"># Valid values include 'exit', 'proxy'</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">'proxy'</span></span><br><span class="line"><span class="comment"># HTTP proxy to use for traffic to discovery service.</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="comment"># DNS domain used to bootstrap initial cluster.</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="comment"># Initial cluster configuration for bootstrapping.</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">'etcd1=http://172.16.80.201:2380,etcd2=http://172.16.80.202:2380,etcd3=http://172.16.80.203:2380'</span></span><br><span class="line"><span class="comment"># Initial cluster token for the etcd cluster during bootstrap.</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">'etcd-cluster'</span></span><br><span class="line"><span class="comment"># Initial cluster state ('new' or 'existing').</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">'new'</span></span><br><span class="line"><span class="comment"># Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Accept etcd V2 client requests</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Enable runtime profiling data via HTTP server</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Valid values include 'on', 'readonly', 'off'</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">'off'</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) an endpoint will be held in a failed state.</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) of the endpoints refresh interval.</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a dial to timeout.</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a write to timeout.</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="comment"># Time (in milliseconds) for a read to timeout.</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the client server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Client TLS using generated certificates</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS cert file.</span></span><br><span class="line"><span class="attr">  cert-file:</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS key file.</span></span><br><span class="line"><span class="attr">  key-file:</span></span><br><span class="line">  <span class="comment"># Enable peer client cert authentication.</span></span><br><span class="line"><span class="attr">  client-cert-auth:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line"><span class="attr">  trusted-ca-file:</span></span><br><span class="line">  <span class="comment"># Peer TLS using generated certificates.</span></span><br><span class="line"><span class="attr">  auto-tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># Enable debug-level logging for etcd.</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger:</span> <span class="string">zap</span></span><br><span class="line"><span class="comment"># Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span></span><br><span class="line"><span class="attr">log-outputs:</span> <span class="string">[stderr]</span></span><br><span class="line"><span class="comment"># Force to create a new one member cluster.</span></span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">auto-compaction-mode:</span> <span class="string">periodic</span></span><br><span class="line"><span class="attr">auto-compaction-retention:</span> <span class="string">"1"</span></span><br><span class="line"><span class="comment"># Set level of detail for exported metrics, specify 'extensive' to include histogram metrics.</span></span><br><span class="line"><span class="comment"># default is 'basic'</span></span><br><span class="line"><span class="attr">metrics:</span> <span class="string">'basic'</span></span><br></pre></td></tr></table></figure><h3 id="启动etcd集群"><a href="#启动etcd集群" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for NODE in 172.16.80.201 172.16.80.202 172.16.80.203;do</span><br><span class="line">ssh $NODE systemctl enable etcd</span><br><span class="line">ssh $NODE systemctl start etcd &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="检查etcd集群"><a href="#检查etcd集群" class="headerlink" title="检查etcd集群"></a>检查etcd集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=2</span><br><span class="line">etcdctl --endpoints 'http://172.16.80.201:2379,http://172.16.80.202:2379,http://172.16.80.202:2379' cluster-health</span><br><span class="line">member 222fd3b0bb4a5931 is healthy: got healthy result from http://172.16.80.203:2379</span><br><span class="line">member 8349ef180b115a83 is healthy: got healthy result from http://172.16.80.201:2379</span><br><span class="line">member f525d2d797a7c465 is healthy: got healthy result from http://172.16.80.202:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints='http://172.16.80.201:2379,http://172.16.80.202:2379,http://172.16.80.202:2379' endpoint health</span><br><span class="line">http://172.16.80.201:2379 is healthy: successfully committed proposal: took = 2.879402ms</span><br><span class="line">http://172.16.80.203:2379 is healthy: successfully committed proposal: took = 6.708566ms</span><br><span class="line">http://172.16.80.202:2379 is healthy: successfully committed proposal: took = 7.187607ms</span><br></pre></td></tr></table></figure><h1 id="SSL-TLS加密"><a href="#SSL-TLS加密" class="headerlink" title="SSL/TLS加密"></a>SSL/TLS加密</h1><blockquote><ul><li>此段翻译自<a href="https://coreos.com/etcd/docs/latest/op-guide/security.html" target="_blank" rel="noopener">官方文档</a></li></ul></blockquote><p>etcd支持自动TLS、客户端证书身份认证、客户端到服务器端以及对等集群的加密通信</p><h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><p>为方便起见，这里使用<code>CFSSL</code>工具生成证书</p><h3 id="下载CFSSL"><a href="#下载CFSSL" class="headerlink" title="下载CFSSL"></a>下载CFSSL</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">curl -s -L -o ~/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">curl -s -L -o ~/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x ~/bin/&#123;cfssl,cfssljson&#125;</span><br><span class="line">export PATH=$PATH:~/bin</span><br></pre></td></tr></table></figure><h3 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/cfssl</span><br><span class="line">cd ~/cfssl</span><br></pre></td></tr></table></figure><h3 id="创建默认配置文件"><a href="#创建默认配置文件" class="headerlink" title="创建默认配置文件"></a>创建默认配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults config &gt; ca-config.json</span><br><span class="line">cfssl print-defaults csr &gt; ca-csr.json</span><br></pre></td></tr></table></figure><h3 id="证书类型介绍"><a href="#证书类型介绍" class="headerlink" title="证书类型介绍"></a>证书类型介绍</h3><ul><li><strong>客户端证书</strong>用于服务器验证客户端身份</li><li><strong>服务器端证书</strong>用于客户端验证服务器端身份</li><li><strong>对等证书</strong>由etcd集群成员使用，同时使用<strong>客户端认证</strong>和<strong>服务器端认证</strong></li></ul><h3 id="配置CA"><a href="#配置CA" class="headerlink" title="配置CA"></a>配置CA</h3><p>修改<code>ca-config.json</code></p><p><strong>说明</strong></p><ul><li><code>expiry</code>定义过期时间，这里的43800h为5年</li><li><code>usages</code>字段定义用途<ul><li><code>signing</code>代表可以用于签发其他证书</li><li><code>key encipherment</code>代表将密钥加密</li><li><code>server auth</code></li><li><code>client auth</code></li></ul></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"signing"</span>: &#123;</span><br><span class="line">        <span class="attr">"default"</span>: &#123;</span><br><span class="line">            <span class="attr">"expiry"</span>: <span class="string">"43800h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"profiles"</span>: &#123;</span><br><span class="line">            <span class="attr">"server"</span>: &#123;</span><br><span class="line">                <span class="attr">"expiry"</span>: <span class="string">"43800h"</span>,</span><br><span class="line">                <span class="attr">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"client"</span>: &#123;</span><br><span class="line">                <span class="attr">"expiry"</span>: <span class="string">"43800h"</span>,</span><br><span class="line">                <span class="attr">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"peer"</span>: &#123;</span><br><span class="line">                <span class="attr">"expiry"</span>: <span class="string">"43800h"</span>,</span><br><span class="line">                <span class="attr">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置证书请求"><a href="#配置证书请求" class="headerlink" title="配置证书请求"></a>配置证书请求</h3><p>修改<code>ca-csr.json</code>，可以根据自己的需求修改对应字段</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"CN"</span>: <span class="string">"My own CA"</span>,</span><br><span class="line">    <span class="attr">"key"</span>: &#123;</span><br><span class="line">        <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"C"</span>: <span class="string">"US"</span>,</span><br><span class="line">            <span class="attr">"L"</span>: <span class="string">"CA"</span>,</span><br><span class="line">            <span class="attr">"O"</span>: <span class="string">"My Company Name"</span>,</span><br><span class="line">            <span class="attr">"ST"</span>: <span class="string">"San Francisco"</span>,</span><br><span class="line">            <span class="attr">"OU"</span>: <span class="string">"Org Unit 1"</span>,</span><br><span class="line">            <span class="attr">"OU"</span>: <span class="string">"Org Unit 2"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="生成CA证书"><a href="#生成CA证书" class="headerlink" title="生成CA证书"></a>生成CA证书</h3><p>运行以下命令生成CA证书</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ca-key.pem</span><br><span class="line">ca.csr</span><br><span class="line">ca.pem</span><br></pre></td></tr></table></figure><ul><li>ca-key.pem为CA的私钥，请妥善保管</li><li>csr文件为证书请求文件，可以删除</li></ul><h3 id="生成服务器端证书"><a href="#生成服务器端证书" class="headerlink" title="生成服务器端证书"></a>生成服务器端证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; server.json</span><br></pre></td></tr></table></figure><p>修改<code>server.json</code>的<strong>CN</strong>和<strong>hosts</strong>字段，<code>names</code>字段按需修改</p><p><strong>说明</strong></p><ul><li><strong>hosts</strong>字段为列表，服务器端需要将自己作为客户端访问集群，可以使用<code>hostname</code>或者<code>IP地址</code>的形式定义hosts</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"CN"</span>: <span class="string">"example.net"</span>,</span><br><span class="line">    <span class="attr">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"192.168.1.1"</span>,</span><br><span class="line">        <span class="string">"ext.example.com"</span>,</span><br><span class="line">        <span class="string">"coreos1.local"</span>,</span><br><span class="line">        <span class="string">"coreos1"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"key"</span>: &#123;</span><br><span class="line">        <span class="attr">"algo"</span>: <span class="string">"ecdsa"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">256</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"C"</span>: <span class="string">"US"</span>,</span><br><span class="line">            <span class="attr">"L"</span>: <span class="string">"CA"</span>,</span><br><span class="line">            <span class="attr">"ST"</span>: <span class="string">"San Francisco"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建服务器端证书和私钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server server.json | cfssljson -bare server</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server-key.pem</span><br><span class="line">server.csr</span><br><span class="line">server.pem</span><br></pre></td></tr></table></figure><h3 id="生成客户端证书"><a href="#生成客户端证书" class="headerlink" title="生成客户端证书"></a>生成客户端证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; client.json</span><br></pre></td></tr></table></figure><p>修改<code>client.json</code>，客户端证书不需要hosts字段，只需要CN字段设置为<code>client</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    "CN": "client",</span><br><span class="line">    "hosts": [""],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>创建客户端证书和私钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client.json | cfssljson -bare client</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">client-key.pem</span><br><span class="line">client.csr</span><br><span class="line">client.pem</span><br></pre></td></tr></table></figure><h3 id="生成对等证书"><a href="#生成对等证书" class="headerlink" title="生成对等证书"></a>生成对等证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; member1.json</span><br></pre></td></tr></table></figure><p>修改<code>member1.json</code>的<strong>CN</strong>字段和<strong>hosts</strong>字段</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    "CN": "member1",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "192.168.122.101",</span><br><span class="line">        "ext.example.com",</span><br><span class="line">        "member1.local",</span><br><span class="line">        <span class="string">"member1"</span></span><br><span class="line">    ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>创建<code>member1</code>的证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer member1.json | cfssljson -bare member1</span><br></pre></td></tr></table></figure><p>生成以下文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">member1-key.pem</span><br><span class="line">member1.csr</span><br><span class="line">member1.pem</span><br></pre></td></tr></table></figure><p>对于多个member需要重复此操作，用于生成相对应的对等证书</p><h3 id="验证证书"><a href="#验证证书" class="headerlink" title="验证证书"></a>验证证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in ca.pem -text -noout</span><br><span class="line">openssl x509 -in server.pem -text -noout</span><br><span class="line">openssl x509 -in client.pem -text -noout</span><br><span class="line">openssl x509 -in member1.pem -text -noout</span><br></pre></td></tr></table></figure><h2 id="示例1、客户端使用HTTPS传输数据给服务器端"><a href="#示例1、客户端使用HTTPS传输数据给服务器端" class="headerlink" title="示例1、客户端使用HTTPS传输数据给服务器端"></a>示例1、客户端使用HTTPS传输数据给服务器端</h2><p>准备CA证书<code>ca.pem</code>，密钥对<code>server.pem</code> <code>server-key.pem</code></p><h3 id="启动服务器端"><a href="#启动服务器端" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><p>启动参数如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra0 \</span><br><span class="line">--data-dir /var/lib/etcd/infra0 \</span><br><span class="line">--cert-file=/path/to/server.pem \</span><br><span class="line">--key-file=/path/to/server-key.pem \</span><br><span class="line">--advertise-client-urls=https://127.0.0.1:2379 \</span><br><span class="line">--listen-client-urls=https://127.0.0.1:2379</span><br></pre></td></tr></table></figure><h3 id="客户端使用HTTPS访问服务器端"><a href="#客户端使用HTTPS访问服务器端" class="headerlink" title="客户端使用HTTPS访问服务器端"></a>客户端使用HTTPS访问服务器端</h3><p>使用<code>curl</code>加载CA证书测试HTTPS连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /path/to/ca.pem \</span><br><span class="line">https://127.0.0.1:2379/v2/keys/foo \</span><br><span class="line">-X PUT \</span><br><span class="line">-d value=bar \</span><br><span class="line">-v</span><br></pre></td></tr></table></figure><h2 id="示例2、客户端使用客户端证书作为身份验证访问服务器端"><a href="#示例2、客户端使用客户端证书作为身份验证访问服务器端" class="headerlink" title="示例2、客户端使用客户端证书作为身份验证访问服务器端"></a>示例2、客户端使用客户端证书作为身份验证访问服务器端</h2><p>在示例1的基础上，需要客户端证书<code>client.pem</code>和<code>client-key.pem</code></p><h3 id="启动服务器端-1"><a href="#启动服务器端-1" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><p>启动参数如下，这里比示例1多了<code>client-cert-auth</code>和<code>truested-ca-file</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra0 \</span><br><span class="line">--data-dir /var/lib/etcd/infra0 \</span><br><span class="line">--cert-file=/path/to/server.pem \</span><br><span class="line">--key-file=/path/to/server-key.pem \</span><br><span class="line">--advertise-client-urls=https://127.0.0.1:2379 \</span><br><span class="line">--listen-client-urls=https://127.0.0.1:2379 \</span><br><span class="line">--client-cert-auth \</span><br><span class="line">--trusted-ca-file=/path/to/ca.crt</span><br></pre></td></tr></table></figure><p>重复示例1的访问</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /path/to/ca.crt https://127.0.0.1:2379/v2/keys/foo -XPUT -d value=bar -v</span><br></pre></td></tr></table></figure><p>此命令结果会提示被服务器端拒绝</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">routines:SSL3_READ_BYTES:sslv3 alert bad certificate</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>使用客户端证书访问服务器端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert /path/to/ca.pem \</span><br><span class="line">--cert /path/to/client.pem \</span><br><span class="line">--key /path/to/client-key.pem \</span><br><span class="line">-L https://127.0.0.1:2379/v2/keys/foo \</span><br><span class="line">-X PUT \</span><br><span class="line">-d value=bar \</span><br><span class="line">-v</span><br></pre></td></tr></table></figure><p>命令结果包含以下信息</p><ul><li>身份认证成功</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">SSLv3, TLS handshake, CERT verify (15):</span><br><span class="line">...</span><br><span class="line">TLS handshake, Finished (20)</span><br></pre></td></tr></table></figure><h2 id="示例3、在集群中传输安全和客户端证书"><a href="#示例3、在集群中传输安全和客户端证书" class="headerlink" title="示例3、在集群中传输安全和客户端证书"></a>示例3、在集群中传输安全和客户端证书</h2><p>这里需要为每个member配备对应的member证书，操作步骤见生成证书部分</p><p>假设有2个member，这两个member都已生成对应的证书(<code>member1.pem</code>、<code>member1-key.pem</code>、<code>member2.pem</code>、<code>member2-key.pem</code>)</p><p>etcd 成员将组成一个集群，集群中成员之间的所有通信将使用客户端证书进行加密和验证。</p><p>etcd的输出将显示其连接的地址使用HTTPS。</p><h3 id="启动服务器端-2"><a href="#启动服务器端-2" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><p>从<a href="https://discovery.etcd.io/new获取discovery_url作为启动集群的发现服务" target="_blank" rel="noopener">https://discovery.etcd.io/new获取discovery_url作为启动集群的发现服务</a></p><p>发现服务可以在内网环境搭建，详见<a href="https://github.com/coreos/discovery.etcd.io" target="_blank" rel="noopener">github地址</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISCOVERY_URL=$(curl https://discovery.etcd.io/new)</span><br></pre></td></tr></table></figure><h4 id="member1"><a href="#member1" class="headerlink" title="member1"></a>member1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra1 \</span><br><span class="line">--data-dir /var/lib/etcd/infra1 \</span><br><span class="line">--peer-client-cert-auth \</span><br><span class="line">--peer-trusted-ca-file=/path/to/ca.pem \</span><br><span class="line">--peer-cert-file=/path/to/member1.pem \</span><br><span class="line">--peer-key-file=/path/to/member1-key.pem \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h4 id="member2"><a href="#member2" class="headerlink" title="member2"></a>member2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra2 \</span><br><span class="line">--data-dir /var/lib/etcd/infra2 \</span><br><span class="line">--peer-client-cert-auth \</span><br><span class="line">--peer-trusted-ca-file=/path/to/ca.pem \</span><br><span class="line">--peer-cert-file=/path/to/member2.pem \</span><br><span class="line">--peer-key-file=/path/to/member2-key.pem \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h2 id="示例4、自动自签名"><a href="#示例4、自动自签名" class="headerlink" title="示例4、自动自签名"></a>示例4、自动自签名</h2><p>对于只需要加密传输数据而不需要身份验证的场景，etcd支持使用自动生成的自签名证书加密传输数据</p><h3 id="启动服务器端-3"><a href="#启动服务器端-3" class="headerlink" title="启动服务器端"></a>启动服务器端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISCOVERY_URL=$(curl https://discovery.etcd.io/new)</span><br></pre></td></tr></table></figure><h4 id="member1-1"><a href="#member1-1" class="headerlink" title="member1"></a>member1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra1 \</span><br><span class="line">--data-dir /var/lib/etcd/infra1 \</span><br><span class="line">--auto-tls \</span><br><span class="line">--peer-auto-tls \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.11:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h4 id="member2-1"><a href="#member2-1" class="headerlink" title="member2"></a>member2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">etcd --name infra2 \</span><br><span class="line">--data-dir /var/lib/etcd/infra2 \</span><br><span class="line">--auto-tls \</span><br><span class="line">--peer-auto-tls \</span><br><span class="line">--initial-advertise-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--listen-peer-urls=https://10.0.1.12:2380 \</span><br><span class="line">--discovery $&#123;DISCOVERY_URL&#125;</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>由于自签名证书不会进行身份认证，因此curl会返回错误，因此需要添加<code>-k</code>参数禁用证书链检查</p><h1 id="etcd维护操作"><a href="#etcd维护操作" class="headerlink" title="etcd维护操作"></a>etcd维护操作</h1><h2 id="请求最大字节数"><a href="#请求最大字节数" class="headerlink" title="请求最大字节数"></a>请求最大字节数</h2><p><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/dev-guide/limit.md" target="_blank" rel="noopener">官网文档说明</a></p><p><code>max-request-bytes</code>限制请求的大小，默认值是<code>1572864</code>，即1.5M。在某些场景可能会出现请求过大导致无法写入的情况，可以调大到<code>10485760</code>即10M。</p><h2 id="快照条目数量调整"><a href="#快照条目数量调整" class="headerlink" title="快照条目数量调整"></a>快照条目数量调整</h2><p><code>--snapshot-count</code>：指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘。从v3.2开始，<code>--snapshot-count</code>的默认值已从10000更改为100000。</p><blockquote><p><strong>注意</strong></p><p>此参数具体数值可以通过根据实际情况调整</p><p>过低会带来频繁的IO压力，影响集群可用性和写入吞吐量。</p><p>过高则导致内存占用过高以及会让etcd的GC变慢</p></blockquote><h2 id="历史数据压缩（针对v3的API）"><a href="#历史数据压缩（针对v3的API）" class="headerlink" title="历史数据压缩（针对v3的API）"></a>历史数据压缩（针对v3的API）</h2><p>由于etcd保存了key的历史记录，因此能通过MVCC机制获取多版本的数据，需要定期压缩历史记录避免性能下降和空间耗尽。</p><p>到达上限阈值时，集群将处于只读和只能删除key的状态，无法写操作。</p><p>历史数据压缩只是针对数据的历史版本进行清理，清理之后只能读取到清理点之后的历史版本</p><h3 id="手动压缩"><a href="#手动压缩" class="headerlink" title="手动压缩"></a>手动压缩</h3><p>清理revision为3之前的历史数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl compact 3</span><br></pre></td></tr></table></figure><p>清理之后，访问revision3之前的数据会提示不存在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl get KEY_NAME --rev=2</span><br><span class="line">Error:  etcdserver: mvcc: required revision has been compacted</span><br></pre></td></tr></table></figure><h3 id="自动压缩"><a href="#自动压缩" class="headerlink" title="自动压缩"></a>自动压缩</h3><p>启动参数中添加<code>--auto-compaction-retention=1</code>即为每小时压缩一次</p><h2 id="碎片整理-针对v3的API"><a href="#碎片整理-针对v3的API" class="headerlink" title="碎片整理(针对v3的API)"></a>碎片整理(针对v3的API)</h2><p>在数据压缩操作之后，旧的revision被压缩，会产生内部碎片，这些内部碎片可以被etcd使用，但是仍消耗磁盘空间。</p><p>碎片整理就是将这部分空间释放出来。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl defrag</span><br></pre></td></tr></table></figure><h2 id="空间配额"><a href="#空间配额" class="headerlink" title="空间配额"></a>空间配额</h2><p>etcd通过<code>--quota-backend-bytes</code>参数来限制etcd数据库的大小，以字节为单位。</p><p>默认是<code>2147483648</code>即2GB，最大值为<code>8589934592</code>即8GB。</p><p>容量限制见<a href="https://coreos.com/etcd/docs/latest/dev-guide/limit.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="数据备份-针对v3的API"><a href="#数据备份-针对v3的API" class="headerlink" title="数据备份(针对v3的API)"></a>数据备份(针对v3的API)</h2><h3 id="快照备份"><a href="#快照备份" class="headerlink" title="快照备份"></a>快照备份</h3><p>通过快照etcd集群可以作备份数据的用途。</p><p>可以通过快照备份的数据，将etcd集群恢复到快照的时间点。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl snapshot save /path/to/snapshot.db</span><br></pre></td></tr></table></figure><p>检查快照状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcd --write-out=table snapshot status /path/to/snapshot.db</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">| dd97719a |    24276 |       1113 |     3.0 MB |</span><br><span class="line">+----------+----------+------------+------------+</span><br></pre></td></tr></table></figure><h3 id="基于快照的定期备份脚本"><a href="#基于快照的定期备份脚本" class="headerlink" title="基于快照的定期备份脚本"></a>基于快照的定期备份脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">TIME=$(date +%Y%m%d)</span><br><span class="line">HOUR=$(date +%H)</span><br><span class="line">BACKUP_DIR="/data/etcd_backup/$&#123;TIME&#125;"</span><br><span class="line">mkdir -p $BACKUP_DIR</span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">/usr/local/bin/etcdctl --cacert=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">                       --cert=/etc/etcd/ssl/etcd-client.pem \</span><br><span class="line">                       --key=/etc/etcd/ssl/etcd-client-key.pem \</span><br><span class="line">                       --endpoints=https://member1:2379,https://member2:2379,https://member3:2379 \</span><br><span class="line">                       snapshot save $BACKUP_DIR/snapshot-$&#123;HOUR&#125;.db</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清理2天前的etcd备份</span></span><br><span class="line">find /data/etcd_backup -type d -mtime +2 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><h2 id="etcd镜像集群-针对v3的API"><a href="#etcd镜像集群-针对v3的API" class="headerlink" title="etcd镜像集群(针对v3的API)"></a>etcd镜像集群(针对v3的API)</h2><p>通过mirror-maker实时做镜像的方式同步数据，如果出现主机房服务挂了可以通过切换域名的形式切换到灾备机房；这个过程中数据是可以保持一致的。</p><p>提前部署好两套etcd集群之后，可以在主集群上面运行以下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl make-mirror --no-dest-prefix=true http://mirror1:2379,http://mirror2:2379,http://mirror3:2379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">488</span><br><span class="line">546</span><br><span class="line">604</span><br><span class="line">662</span><br><span class="line">720</span><br><span class="line">778</span><br><span class="line">836</span><br><span class="line">894</span><br><span class="line">950</span><br><span class="line">1009</span><br><span class="line">1067</span><br><span class="line">1125</span><br><span class="line">1183</span><br><span class="line">1241</span><br></pre></td></tr></table></figure><blockquote><p>make-mirror的输出为30s一次，程序为前台运行，可以通过nohup &gt;/path/to/log 2&gt;&amp;1 &amp;的方式扔到后台运行</p></blockquote><h1 id="etcd监控"><a href="#etcd监控" class="headerlink" title="etcd监控"></a>etcd监控</h1><h2 id="debug-endpoint"><a href="#debug-endpoint" class="headerlink" title="debug endpoint"></a>debug endpoint</h2><p>启动参数中添加<code>--debug</code>即可打开debug模式，etcd会在<code>http://x.x.x.x:2379/debug</code>路径下输出debug信息。</p><p>由于debug信息很多，会导致性能下降。</p><p><code>/debug/pprof</code>为go语言runtime的endpoint，可以用于分析CPU、heap、mutex和goroutine利用率。</p><p>这里示例为使用go命令获取etcd最耗时的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go tool pprof http://127.0.0.1:2379/debug/pprof/profile</span></span><br><span class="line">Fetching profile over HTTP from http://127.0.0.1:2379/debug/pprof/profile</span><br><span class="line">Saved profile in /root/pprof/pprof.etcd-3.2.24.samples.cpu.001.pb.gz</span><br><span class="line">File: etcd-3.2.24</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Feb 10, 2019 at 9:57pm (CST)</span><br><span class="line">Duration: 30s, Total samples = 60ms (  0.2%)</span><br><span class="line">Entering interactive mode (type "help" for commands, "o" for options)</span><br><span class="line">(pprof) </span><br><span class="line">(pprof) </span><br><span class="line">(pprof) top10</span><br><span class="line">Showing nodes accounting for 60ms, 100% of 60ms total</span><br><span class="line">Showing top 10 nodes out of 25</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">      60ms   100%   100%       60ms   100%  runtime.futex</span><br><span class="line">         0     0%   100%       10ms 16.67%  github.com/coreos/etcd/cmd/vendor/github.com/coreos/etcd/etcdserver.(*raftNode).start.func1</span><br><span class="line">         0     0%   100%       10ms 16.67%  github.com/coreos/etcd/cmd/vendor/github.com/coreos/etcd/etcdserver.(*raftNode).tick</span><br><span class="line">         0     0%   100%       10ms 16.67%  github.com/coreos/etcd/cmd/vendor/github.com/coreos/etcd/raft.(*node).Tick</span><br><span class="line">         0     0%   100%       20ms 33.33%  runtime.chansend</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscall</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscallfast</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscallfast.func1</span><br><span class="line">         0     0%   100%       30ms 50.00%  runtime.exitsyscallfast_pidle</span><br><span class="line">         0     0%   100%       60ms   100%  runtime.futexwakeup</span><br><span class="line">(pprof) exit</span><br></pre></td></tr></table></figure><h2 id="metrics-endpoint"><a href="#metrics-endpoint" class="headerlink" title="metrics endpoint"></a>metrics endpoint</h2><p>每个etcd节点都会在<code>/metrics</code>路径下输出监控信息，监控软件可以通过此路径获取指标信息</p><p>具体的metrics信息可以参看<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/metrics.md" target="_blank" rel="noopener">官方文档</a></p><ul><li><code>--listen-metrics-urls</code>定义metrics的location。</li><li><code>--metrics</code>可以定义<code>basic</code>和<code>extensive</code></li></ul><p>这里通过<code>curl</code>命令来获取metrics信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:2379/metrics</span><br></pre></td></tr></table></figure><h2 id="health-check"><a href="#health-check" class="headerlink" title="health check"></a>health check</h2><p>这里通过<code>curl</code>命令来获取health信息，返回结果为json</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:2379/health</span><br></pre></td></tr></table></figure><p>返回结果如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"health"</span>: <span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="对接Prometheus"><a href="#对接Prometheus" class="headerlink" title="对接Prometheus"></a>对接Prometheus</h2><h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">etcd-cluster-monitoring</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">['10.240.0.32:2379','10.240.0.33:2379','10.240.0.34:2379']</span></span><br></pre></td></tr></table></figure><h4 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">etcd-cluster-monitoring</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">['10.240.0.32:2379','10.240.0.33:2379','10.240.0.34:2379']</span></span><br><span class="line"><span class="attr">    scheme:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    tls_config:</span></span><br><span class="line">    <span class="comment"># CA certificate to validate API server certificate with.</span></span><br><span class="line"><span class="attr">      ca_file:</span> <span class="string">/path/to/etcd-ca.pem</span></span><br><span class="line"><span class="attr">      cert_file:</span> <span class="string">/path/to/etcd-cert.pem</span></span><br><span class="line"><span class="attr">      key_file:</span> <span class="string">/path/to/etcd-key.pem</span></span><br><span class="line">      <span class="comment"># insecure_skip_verify: true | false</span></span><br></pre></td></tr></table></figure><h3 id="监控告警"><a href="#监控告警" class="headerlink" title="监控告警"></a>监控告警</h3><p>使用Alertmanager进行监控告警</p><p><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/etcd3_alert.rules" target="_blank" rel="noopener">Prometheus 1.x 范例</a></p><p><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/etcd3_alert.rules.yml" target="_blank" rel="noopener">Prometheus 2.x 范例</a></p><h3 id="监控指标展示"><a href="#监控指标展示" class="headerlink" title="监控指标展示"></a>监控指标展示</h3><p>使用Grafana读取Prometheus的数据展示监控数据，<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/grafana.json" target="_blank" rel="noopener">Dashboard模板</a></p><p><img src="https://github.com/etcd-io/etcd/raw/master/Documentation/op-guide/etcd-sample-grafana.png" alt="img"></p><h1 id="etcd故障处理"><a href="#etcd故障处理" class="headerlink" title="etcd故障处理"></a>etcd故障处理</h1><h2 id="leader节点故障"><a href="#leader节点故障" class="headerlink" title="leader节点故障"></a>leader节点故障</h2><blockquote><ul><li>leader节点故障，etcd集群会自动选举出新的leader。</li><li>故障检测模型是基于超时的，因此选举新的leader节点不会在旧的leader节点故障之后立刻发生。</li><li>选举leader期间，集群不会处理写入操作。选举期间的写入请求会进入队列等待处理，直至选出新的leader节点。</li><li>已经发送给故障leader但尚未提交的数据可能会丢失。这是因为新的leader节点有权对旧leader节点的数据进行修改</li><li>客户端会发现一些写入请求可能会超时，没有提交的数据会丢失。</li></ul></blockquote><h2 id="follower节点故障"><a href="#follower节点故障" class="headerlink" title="follower节点故障"></a>follower节点故障</h2><blockquote><ul><li>follower故障节点数量少于集群节点的一半时，etcd集群是可以正常工作的。<ul><li>例如3个节点故障了1个，5个节点故障了2个</li></ul></li><li>follower节点故障后，客户端的etcd库应该自动连接到etcd集群的其他成员。</li></ul></blockquote><h2 id="超过半数节点故障"><a href="#超过半数节点故障" class="headerlink" title="超过半数节点故障"></a>超过半数节点故障</h2><blockquote><ul><li>由于Raft算法的原理所限，超过半数的集群节点故障会导致etcd集群进入不可写入的状态。</li><li>只要正常工作的节点超过集群节点的一半，那么etcd集群会自动选举leader节点并且自动恢复到健康状态</li><li>如果无法修复多数节点，那么就需要走灾难恢复的操作流程</li></ul></blockquote><h2 id="网络分区"><a href="#网络分区" class="headerlink" title="网络分区"></a>网络分区</h2><blockquote><ul><li>由于网络故障，导致etcd集群被切分成两个或者更多的部分。</li><li>那么占有多数节点的一方会成为可用集群，少数节点的一方不可写入。</li><li>如果对等切分了集群，那么每个部分都不可用。</li><li>这是因为Raft一致性算法保证了etcd是不存在<strong>脑裂</strong>现象。</li><li>只要网络分区的故障解除，少数节点的一方会自动从多数节点一方识别出leader节点，然后恢复状态。</li></ul></blockquote><h2 id="集群启动失败"><a href="#集群启动失败" class="headerlink" title="集群启动失败"></a>集群启动失败</h2><p>只有超过半数成员启动完成之后，集群的bootstrap才会成功。</p><p>Raft一致性算法保证了集群节点的数据一致性和稳定性，因此对于节点的恢复，更多的是恢复etcd节点服务，然后恢复数据</p><h3 id="新的集群"><a href="#新的集群" class="headerlink" title="新的集群"></a>新的集群</h3><p>可以删除所有成员的数据目录，然后重新走创建集群的步骤</p><h3 id="已有集群"><a href="#已有集群" class="headerlink" title="已有集群"></a>已有集群</h3><p>这个就要看无法启动的节点是数据文件损坏，还是其他原因导致的。</p><p>这里以数据文件损坏为例。</p><ul><li>寻找正常的节点，使用<code>etcdctl snapshot save</code>命令保存出快照文件</li><li>将故障节点的数据目录清空，使用<code>etcdctl snapshot restore</code>命令将数据恢复到数据目录</li><li>使用<code>etcdctl member list</code>确认故障节点的信息</li><li>使用<code>etcdctl member remove</code>删除故障节点</li><li>使用<code>etcdctl member add MEMBER_NAME --peer-urls=http://member:2379</code>重新添加成员</li><li>修改etcd启动参数<code>--initial-cluster-state=existing</code>启动故障节点的etcd服务</li></ul><h1 id="etcd灾难恢复"><a href="#etcd灾难恢复" class="headerlink" title="etcd灾难恢复"></a>etcd灾难恢复</h1><p>这里的灾难恢复，只能恢复v2或者v3的数据，不能同时恢复v2和v3。</p><p>两套API是相互隔离的。</p><h2 id="针对v3的API"><a href="#针对v3的API" class="headerlink" title="针对v3的API"></a>针对v3的API</h2><p>etcd v3的API提供了快照和恢复功能，可以在不损失快照点数据的情况下重建集群</p><h3 id="快照备份数据"><a href="#快照备份数据" class="headerlink" title="快照备份数据"></a>快照备份数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --endpoints http://member1:2379,http://member2:2379,http://member3:2379 snapshot save /path/to/snapshot.db</span><br></pre></td></tr></table></figure><h3 id="恢复集群"><a href="#恢复集群" class="headerlink" title="恢复集群"></a>恢复集群</h3><blockquote><ul><li>恢复etcd集群，只需要快照文件<code>db</code>即可。</li><li>使用<code>etcdctl snapshot restore</code>命令还原数据时会自动创建新的etcd数据目录。</li><li>恢复过程会覆盖快照文件里面的一些metadata（特别是member id和cluster id），该member会失去之前的id。覆盖metadata可以防止新成员无意中加入现有集群。</li><li>从快照中恢复集群，必须以新集群启动。</li><li>恢复时可以选择验证快照完整性hash。<ul><li>使用<code>etcdctl snapshot save</code>生成的快照，则具有完整性hash</li><li>如果是直接从数据目录拷贝数据快照，则没有完整性hash，需要使用<code>--skip-hash-check</code>跳过检查</li></ul></li></ul></blockquote><h4 id="恢复节点数据"><a href="#恢复节点数据" class="headerlink" title="恢复节点数据"></a>恢复节点数据</h4><blockquote><ul><li>这里假定原有的集群节点为member1、member2、member3</li></ul></blockquote><p>在member1、member2、member3上分别恢复快照数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ETCDCTL_API=3 etcdctl snapshot restore snapshot.db \</span></span><br><span class="line">  --name member1 \</span><br><span class="line">  --initial-cluster member1=http://member1:2380,member2=http://member2:2380,member3=http://member3:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-advertise-peer-urls http://member1:2380</span><br><span class="line"><span class="meta">$</span><span class="bash"> ETCDCTL_API=3 etcdctl snapshot restore snapshot.db \</span></span><br><span class="line">  --name member2 \</span><br><span class="line">  --initial-cluster member1=http://member1:2380,member2=http://member2:2380,member3=http://member3:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-advertise-peer-urls http://member2:2380</span><br><span class="line"><span class="meta">$</span><span class="bash"> ETCDCTL_API=3 etcdctl snapshot restore snapshot.db \</span></span><br><span class="line">  --name member3 \</span><br><span class="line">  --initial-cluster member1=http://member1:2380,member2=http://member2:2380,member3=http://member3:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-advertise-peer-urls http://member3:2380</span><br></pre></td></tr></table></figure><h4 id="启动etcd集群-1"><a href="#启动etcd集群-1" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h4><p>在member1、member2、member3上分别启动集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> etcd \</span></span><br><span class="line">  --name member1 \</span><br><span class="line">  --listen-client-urls http://member1:2379 \</span><br><span class="line">  --advertise-client-urls http://member1:2379 \</span><br><span class="line">  --listen-peer-urls http://member1:2380 &amp;</span><br><span class="line"><span class="meta">$</span><span class="bash"> etcd \</span></span><br><span class="line">  --name member2 \</span><br><span class="line">  --listen-client-urls http://member2:2379 \</span><br><span class="line">  --advertise-client-urls http://member2:2379 \</span><br><span class="line">  --listen-peer-urls http://member2:2380 &amp;</span><br><span class="line"><span class="meta">$</span><span class="bash"> etcd \</span></span><br><span class="line">  --name member3 \</span><br><span class="line">  --listen-client-urls http://member3:2379 \</span><br><span class="line">  --advertise-client-urls http://member3:2379 \</span><br><span class="line">  --listen-peer-urls http://member3:2380 &amp;</span><br></pre></td></tr></table></figure><h2 id="针对v2的API"><a href="#针对v2的API" class="headerlink" title="针对v2的API"></a>针对v2的API</h2><h3 id="备份数据"><a href="#备份数据" class="headerlink" title="备份数据"></a>备份数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3</span><br><span class="line">etcdctl backup \</span><br><span class="line">        --data-dir /path/to/data-dir \</span><br><span class="line">        --wal-dir /path/to/wal_dir \</span><br><span class="line">        --backup-dir /path/to/backup_data_dir \</span><br><span class="line">        --backup-wal-dir /path/to/backup_wal_dir</span><br></pre></td></tr></table></figure><h3 id="清理数据目录"><a href="#清理数据目录" class="headerlink" title="清理数据目录"></a>清理数据目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /path/to/data-dir</span><br><span class="line">rm -rf /path/to/wal-dir</span><br></pre></td></tr></table></figure><h3 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /path/to/backup_data_dir /path/to/data-dir</span><br><span class="line">mv /path/to/backup_wal_dir /path/to/wal_dir</span><br></pre></td></tr></table></figure><h3 id="启动etcd集群-2"><a href="#启动etcd集群-2" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h3><p>启动参数需要添加<code>--force-new-cluster</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcd --data-dir /path/to/data-dir \</span><br><span class="line">     --wal-dir /path/to/wal_dir \</span><br><span class="line">     --force-new-cluster</span><br></pre></td></tr></table></figure><h1 id="etcd版本升级"><a href="#etcd版本升级" class="headerlink" title="etcd版本升级"></a>etcd版本升级</h1><p>这里可以参考<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/upgrades/upgrading-etcd.md" target="_blank" rel="noopener">etcd的升级文档</a></p><h1 id="etcd的FAQ"><a href="#etcd的FAQ" class="headerlink" title="etcd的FAQ"></a>etcd的FAQ</h1><p>摘自<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/faq.md" target="_blank" rel="noopener">Frequently Asked Questions (FAQ)</a></p><h2 id="客户端是否需要向etcd集群的leader节点发送请求"><a href="#客户端是否需要向etcd集群的leader节点发送请求" class="headerlink" title="客户端是否需要向etcd集群的leader节点发送请求"></a>客户端是否需要向etcd集群的leader节点发送请求</h2><blockquote><ul><li>leader节点负责处理所有需要集群共识的请求（例如写请求）。</li><li>客户端不需要知道哪个节点是leader，follower节点会将所有需要集群共识的请求转发给leader节点。</li><li>所有节点都可以处理不需要集群共识的请求（例如序列化读取）。</li></ul></blockquote><h2 id="listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别"><a href="#listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别" class="headerlink" title="listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别"></a>listen-client-urls、listen-peer-urls、advertise-client-urls、initial-advertise-peer-urls的区别</h2><blockquote><ul><li><code>listen-client-urls</code>和<code>listen-peer-urls</code>指定etcd服务端用于接收传入连接的本地地址，要监听所有地址，请指定0.0.0.0作为监听地址。</li><li><code>advertise-client-urls</code> 和<code>initial-advertise-peer-urls</code>指定etcd的客户端及集群其他成员访问etcd服务的地址，此地址必须要被外部访问，因此不能设置127.0.0.1或者0.0.0.0等地址。</li></ul></blockquote><h2 id="为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl-member-list中列出的advertise-peer-urls"><a href="#为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl-member-list中列出的advertise-peer-urls" class="headerlink" title="为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl member list中列出的advertise peer urls"></a>为什么不能通过更改listen-peer-urls或者initial-advertise-peer-urls来更新etcdctl member list中列出的advertise peer urls</h2><blockquote><ul><li>每个member的advertise-peer-urls来自初始化集群时的<code>initial-advertise-peer-urls</code>参数</li><li>在member启动完成后修改listen-peer-urls或者initial-advertise-peer-urls参数不会影响现有的advertise-peer-urls，因为修改此参数需要通过集群仲裁以避免出现脑裂</li><li>修改<code>advertise-peer-url</code>请使用<code>etcd member update</code>命令操作</li></ul></blockquote><h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><blockquote><ul><li>etcd会将数据写入磁盘，因此高性能的磁盘会更好，推荐使用SSD</li><li>默认存储配额为2GB，最大值为8GB</li><li>为了避免使用swap或者内存不足，服务器内存至少要超过存储配额</li></ul></blockquote><h2 id="为什么etcd需要奇数个集群成员"><a href="#为什么etcd需要奇数个集群成员" class="headerlink" title="为什么etcd需要奇数个集群成员"></a>为什么etcd需要奇数个集群成员</h2><blockquote><ul><li>etcd集群需要通过大多数节点仲裁才能将集群状态更新到一致</li><li>仲裁为(n/2)+1</li><li>双数个集群成员并不比奇数个节点容错性强</li></ul></blockquote><h2 id="集群容错性列表"><a href="#集群容错性列表" class="headerlink" title="集群容错性列表"></a>集群容错性列表</h2><table><thead><tr><th>Cluster Size</th><th>Majority</th><th>Failure Tolerance</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>0</td></tr><tr><td>2</td><td>2</td><td>0</td></tr><tr><td>3</td><td>2</td><td>1</td></tr><tr><td>4</td><td>3</td><td>1</td></tr><tr><td>5</td><td>3</td><td>2</td></tr><tr><td>6</td><td>4</td><td>2</td></tr><tr><td>7</td><td>4</td><td>3</td></tr><tr><td>8</td><td>5</td><td>3</td></tr><tr><td>9</td><td>5</td><td>4</td></tr></tbody></table><h2 id="集群最大节点数量"><a href="#集群最大节点数量" class="headerlink" title="集群最大节点数量"></a>集群最大节点数量</h2><blockquote><ul><li>理论上没有硬性限制，一般不超过7个节点</li><li>建议5个节点，5个节点可以容忍2个节点故障下线，在大多数情况下已经足够</li><li>更多的节点可以提供更好的可用性，但是写入性能会有影响</li></ul></blockquote><h2 id="部署跨数据中心的etcd集群是否合适"><a href="#部署跨数据中心的etcd集群是否合适" class="headerlink" title="部署跨数据中心的etcd集群是否合适"></a>部署跨数据中心的etcd集群是否合适</h2><blockquote><ul><li>跨数据中心的etcd集群可以提高可用性</li><li>数据中心之间的网络延迟可能会影响节点的election</li><li>默认的etcd配置可能会因为网络延迟频繁选举或者心跳超时，需要调整对应的<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md" target="_blank" rel="noopener">参数</a></li></ul></blockquote><h2 id="为什么etcd会因为磁盘IO延迟而重新选举"><a href="#为什么etcd会因为磁盘IO延迟而重新选举" class="headerlink" title="为什么etcd会因为磁盘IO延迟而重新选举"></a>为什么etcd会因为磁盘IO延迟而重新选举</h2><blockquote><ul><li>这是故意设计的</li><li>磁盘IO延迟是leader节点存活指标的一部分</li><li>磁盘IO延迟很高导致选举超时，即使leader节点在选举间隔内能处理网络信息（例如发送心跳），但它实际上是不可用的，因为它无法及时提交新的提议</li><li>如果经常出现因磁盘IO延迟而重新选举，请关注一下磁盘或者修改etcd时间<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md" target="_blank" rel="noopener">参数</a></li></ul></blockquote><h1 id="etcd性能压测"><a href="#etcd性能压测" class="headerlink" title="etcd性能压测"></a>etcd性能压测</h1><p>这里参考<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/performance.md" target="_blank" rel="noopener">官方文档</a></p><h2 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h2><blockquote><ul><li>延迟<ul><li>完成操作所需的时间</li></ul></li><li>吞吐量<ul><li>一段时间内完成的总操作数量</li></ul></li></ul></blockquote><p>通常情况下，平均延迟会随着吞吐量的增加而增加。</p><p>etcd使用Raft一致性算法完成成员之间的数据同步并达成集群共识。</p><p>集群的共识性能，尤其是提交延迟，主要受到两个方面限制。</p><blockquote><ul><li>网络IO延迟</li><li>磁盘IO延迟</li></ul></blockquote><h3 id="提交延迟的构成"><a href="#提交延迟的构成" class="headerlink" title="提交延迟的构成"></a>提交延迟的构成</h3><blockquote><ul><li>成员之间的网络往返时间RTT<ul><li>同一个数据中心内部的RTT是ms级别</li><li>跨数据中心的RTT就需要考虑物理限制和网络质量</li></ul></li><li><code>fdatasync</code>数据落盘时间<ul><li>机械硬盘<code>fdatasync</code>延迟通常在10ms左右</li><li>固态硬盘则低于1ms</li></ul></li></ul></blockquote><h3 id="其他延迟构成"><a href="#其他延迟构成" class="headerlink" title="其他延迟构成"></a>其他延迟构成</h3><blockquote><ul><li>序列化etcd请求需要通过etcd后端boltdb的MVVC机制来完成，通常会在10ms完成。</li><li>etcd定期将最近提交的请求快照，然后跟磁盘上的快照合并，这个操作过程会导致延迟出现峰值。</li><li>正在进行的数据压缩也会影响到延迟，所以要跟业务错开</li></ul></blockquote><h2 id="benchmark跑分"><a href="#benchmark跑分" class="headerlink" title="benchmark跑分"></a>benchmark跑分</h2><p>etcd自带的<a href="https://github.com/coreos/etcd/tree/master/tools/benchmark" target="_blank" rel="noopener">benchmark</a>命令行工具可以用来测试etcd性能</p><h3 id="写入请求"><a href="#写入请求" class="headerlink" title="写入请求"></a>写入请求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假定 HOST_1 是 leader, 写入请求发到 leader</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span> \</span><br><span class="line">          --conns=1 \</span><br><span class="line">          --clients=1 \</span><br><span class="line">          put --key-size=8 \</span><br><span class="line">          --sequential-keys \</span><br><span class="line">          --total=10000 \</span><br><span class="line">          --val-size=256</span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          put --key-size=8 \</span><br><span class="line">          --sequential-keys \</span><br><span class="line">          --total=100000 \</span><br><span class="line">          --val-size=256</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 写入发到所有成员</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          put --key-size=8 \</span><br><span class="line">          --sequential-keys \</span><br><span class="line">          --total=100000 \</span><br><span class="line">          --val-size=256</span><br></pre></td></tr></table></figure><h3 id="序列化读取"><a href="#序列化读取" class="headerlink" title="序列化读取"></a>序列化读取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Single connection read requests</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=1 \</span><br><span class="line">          --clients=1 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=l \</span><br><span class="line">          --total=10000</span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=1 \</span><br><span class="line">          --clients=1 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=s \</span><br><span class="line">          --total=10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Many concurrent read requests</span></span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=l \</span><br><span class="line">          --total=100000</span><br><span class="line">benchmark --endpoints=<span class="variable">$&#123;HOST_1&#125;</span>,<span class="variable">$&#123;HOST_2&#125;</span>,<span class="variable">$&#123;HOST_3&#125;</span> \</span><br><span class="line">          --conns=100 \</span><br><span class="line">          --clients=1000 \</span><br><span class="line">          range YOUR_KEY \</span><br><span class="line">          --consistency=s \</span><br><span class="line">          --total=100000</span><br></pre></td></tr></table></figure><h1 id="etcd性能调优"><a href="#etcd性能调优" class="headerlink" title="etcd性能调优"></a>etcd性能调优</h1><p>参考<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md" target="_blank" rel="noopener">官方文档</a></p><p>etcd默认配置是基于同一个数据中心，网络延迟较低的情况。</p><p>对于网络延迟较高，那么就需要优化心跳间隔和选举超时时间</p><h2 id="时间参数（time-parameter）"><a href="#时间参数（time-parameter）" class="headerlink" title="时间参数（time parameter）"></a>时间参数（time parameter）</h2><p>延迟不止有网络延迟，还可能受到节点磁盘IO影响。</p><p>每一次超时设置应该包括请求发出到响应成功的时间。</p><h3 id="心跳间隔（heartbeat-interval）"><a href="#心跳间隔（heartbeat-interval）" class="headerlink" title="心跳间隔（heartbeat interval）"></a>心跳间隔（heartbeat interval）</h3><p>leader节点通知各follower节点自己的存活信息。</p><p>最佳实践是通过ping命令获取RTT最大值，然后设置为RTT的0.5~1.5倍。</p><p>默认是100ms。</p><h3 id="选举超时（election-timeout）"><a href="#选举超时（election-timeout）" class="headerlink" title="选举超时（election timeout）"></a>选举超时（election timeout）</h3><p>follower节点在多久之后没收到leader节点的心跳信息，就开始选举新leader节点。</p><p>默认是1000ms。选举超时应该设置为至少是RTT的10倍，以避免网络出现波动导致重新选举。</p><h2 id="快照（snapshot）"><a href="#快照（snapshot）" class="headerlink" title="快照（snapshot）"></a>快照（snapshot）</h2><p>etcd会将所有变更的key追加写入到wal日志文件中。</p><p>一行记录一个key的变更，因此日志会不断增长。</p><p>为避免日志过大，etcd会定期做快照。</p><p>快照操作会保存当前系统状态并移除旧的日志。</p><p><code>snapshot-count</code>参数控制快照的频率，默认是10000，即每10000次变更会触发一次快照操作。</p><p>如果内存使用率高并且磁盘使用率高，可以尝试调低这个参数。</p><h2 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h2><p>etcd集群对磁盘IO延迟非常的敏感。</p><p>etcd需要存储变更日志、快照等操作，可能会导致磁盘IO出现很高的<code>fsync</code>延迟。</p><p>磁盘IO延迟高会导致leader节点心跳信息超时、请求超时、重新选举等。</p><blockquote><ul><li>etcd所使用的磁盘与系统盘分开</li><li>data目录和wal目录分别挂载不同的磁盘</li><li>有条件推荐使用SSD固态硬盘</li><li>使用<code>ionice</code>调高etcd进程的IO优先级（这个针对etcd数据目录在系统盘的情况）</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ionice -c2 -n0 -p `pgrep etcd`</span><br></pre></td></tr></table></figure><h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>如果leader节点接收来自客户端的大量请求，无法及时处理follower的请求，那么follower节点处理的请求也会因此出现延迟。</p><p>具体表现为follower会提示sending buffer is full。</p><p>可以通过调高leader的网络优先级或者通过流量管控机制来提高对follower的请求响应。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;kubernetes底层数据存放在etcd中，这里记录一下学习的笔记。&lt;/p&gt;&lt;h1 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h1&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;Etcd 是 Core
      
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://luanlengli.github.io/tags/kubernetes/"/>
    
      <category term="etcd" scheme="https://luanlengli.github.io/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7使用社区YUM源安装Mariadb Galera集群</title>
    <link href="https://luanlengli.github.io/2018/12/11/CentOS7%E4%BD%BF%E7%94%A8%E7%A4%BE%E5%8C%BAYUM%E6%BA%90%E5%AE%89%E8%A3%85Mariadb-Galera%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2018/12/11/CentOS7使用社区YUM源安装Mariadb-Galera集群.html</id>
    <published>2018-12-10T16:07:07.000Z</published>
    <updated>2018-12-10T16:34:31.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote><ul><li>本文以MariaDB官方文档为基础，记录操作步骤</li></ul></blockquote><h1 id="安装Mariadb数据库前的准备工作"><a href="#安装Mariadb数据库前的准备工作" class="headerlink" title="安装Mariadb数据库前的准备工作"></a>安装Mariadb数据库前的准备工作</h1><h2 id="准备虚拟机三台"><a href="#准备虚拟机三台" class="headerlink" title="准备虚拟机三台"></a>准备虚拟机三台</h2><table><thead><tr><th style="text-align:center">IP地址</th><th style="text-align:center">主机名</th><th style="text-align:center">CPU</th><th style="text-align:center">内存</th></tr></thead><tbody><tr><td style="text-align:center">172.16.10.101</td><td style="text-align:center">db1</td><td style="text-align:center">2</td><td style="text-align:center">3G</td></tr><tr><td style="text-align:center">172.16.10.102</td><td style="text-align:center">db2</td><td style="text-align:center">2</td><td style="text-align:center">3G</td></tr><tr><td style="text-align:center">172.16.10.103</td><td style="text-align:center">db3</td><td style="text-align:center">2</td><td style="text-align:center">3G</td></tr></tbody></table><h2 id="添加Mariadb官方YUM源，下面以Mariadb-10-1为例"><a href="#添加Mariadb官方YUM源，下面以Mariadb-10-1为例" class="headerlink" title="添加Mariadb官方YUM源，下面以Mariadb 10.1为例"></a>添加Mariadb官方YUM源，下面以Mariadb 10.1为例</h2><p><a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=neusoft&amp;distro=CentOS&amp;distro_release=centos7-amd64--centos7&amp;version=10.1" target="_blank" rel="noopener">官方YUM源编辑器</a></p><p>使用以下命令快速添加YUM源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/yum.repos.d/mariadb.repo &lt;&lt;-'EOF'</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.1/centos7-amd64</span><br><span class="line">gpgkey=https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1 </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="刷新YUM缓存"><a href="#刷新YUM缓存" class="headerlink" title="刷新YUM缓存"></a>刷新YUM缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h2 id="查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字"><a href="#查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字" class="headerlink" title="查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字"></a>查看Mariadb相关的安装包，注意软件包版本和对应的YUM源名字</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list MariaDB* galera</span><br></pre></td></tr></table></figure><h2 id="关闭firewalld防火墙"><a href="#关闭firewalld防火墙" class="headerlink" title="关闭firewalld防火墙"></a>关闭firewalld防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld --now</span><br></pre></td></tr></table></figure><h2 id="设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）"><a href="#设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）" class="headerlink" title="设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）"></a>设置主机名（设置三台虚拟机主机名分别为db1，db2，db3）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname db1</span><br><span class="line">hostnamectl set-hostname db2</span><br><span class="line">hostnamectl set-hostname db3</span><br></pre></td></tr></table></figure><h2 id="编辑-etc-hosts文件"><a href="#编辑-etc-hosts文件" class="headerlink" title="编辑/etc/hosts文件"></a>编辑/etc/hosts文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/hosts &lt;&lt;EOF</span><br><span class="line">172.16.10.101 db1</span><br><span class="line">172.16.10.102 db2</span><br><span class="line">172.16.10.103 db3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 </span><br><span class="line"></span><br><span class="line">sed -i 's,^SELINUX=enforcing,SELINUX=disabled,g' /etc/selinux/config</span><br></pre></td></tr></table></figure><h1 id="部署MariaDB-Galera集群"><a href="#部署MariaDB-Galera集群" class="headerlink" title="部署MariaDB Galera集群"></a>部署MariaDB Galera集群</h1><h2 id="安装相关软件包"><a href="#安装相关软件包" class="headerlink" title="安装相关软件包"></a>安装相关软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install MariaDB-server MariaDB-client MariaDB-client</span><br></pre></td></tr></table></figure><h2 id="启用xtrabackup-v2功能"><a href="#启用xtrabackup-v2功能" class="headerlink" title="启用xtrabackup-v2功能"></a>启用xtrabackup-v2功能</h2><blockquote><ul><li>需要额外安装percona提供的软件包</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.10/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.10-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><h2 id="启动MariaDB数据库"><a href="#启动MariaDB数据库" class="headerlink" title="启动MariaDB数据库"></a>启动MariaDB数据库</h2><blockquote><ul><li>在db1上启动MariaDB数据库，设置galera集群同步账号,进行安全初始化</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb.service</span><br><span class="line">mysql -uroot -e "grant all privileges on *.* to 'sst'@'localhost' identified by 'password';" </span><br><span class="line">mysql_secure_installation  </span><br><span class="line">systemctl stop mariadb.service</span><br></pre></td></tr></table></figure><h2 id="编辑MariaDB配置文件"><a href="#编辑MariaDB配置文件" class="headerlink" title="编辑MariaDB配置文件"></a>编辑MariaDB配置文件</h2><blockquote><ul><li>在三个节点上编辑MariaDB配置文件，以开启galera集群功能</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/my.cnf.d/galera.cnf</span><br><span class="line">[server]</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听哪个地址，这里每个节点填对应的ip地址</span></span><br><span class="line">bind-address=172.16.10.101 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听哪个端口</span></span><br><span class="line">port = 3306 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认字符编码集</span></span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">init-connect = SET NAMES utf8</span><br><span class="line">character-set-server = utf8</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置日志路径</span></span><br><span class="line">log-error = /var/log/mariadb/mariadb.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置binlog</span></span><br><span class="line">log-bin = mysql-bin</span><br><span class="line">binlog_format=ROW</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认数据目录</span></span><br><span class="line">datadir = /var/lib/mysql/ </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认存储引擎</span></span><br><span class="line">default-storage-engine=innodb</span><br><span class="line">innodb_autoinc_lock_mode=2 </span><br><span class="line">[galera]</span><br><span class="line">wsrep_on=ON</span><br><span class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</span><br><span class="line"><span class="meta">#</span><span class="bash"> galera集群名字</span></span><br><span class="line">wsrep_cluster_name="galera_cluster" </span><br><span class="line"><span class="meta">#</span><span class="bash"> 本节点的主机名，这里每个节点填对应的ip地址</span></span><br><span class="line">wsrep_node_name="db1" </span><br><span class="line">wsrep_cluster_address = "gcomm://172.16.10.101:4567,172.16.10.102:4567,172.16.10.103:4567"</span><br><span class="line">wsrep_provider_options = "gmcast.listen_addr=tcp://172.16.10.101:4567;ist.recv_addr=172.16.10.101:4568" </span><br><span class="line">wsrep_node_address="172.16.10.101:4567" </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置galera集群同步的方法和用户名密码</span></span><br><span class="line">wsrep_sst_auth=sst:password</span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line">max_connections = 10000 </span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">tmp_table_size = 64M</span><br><span class="line">innodb_buffer_pool_size = 128M</span><br><span class="line">[embedded]</span><br><span class="line">[mariadb]</span><br><span class="line">[mariadb-10.1]</span><br></pre></td></tr></table></figure><h1 id="启动galera集群"><a href="#启动galera集群" class="headerlink" title="启动galera集群"></a>启动galera集群</h1><h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><blockquote><ul><li>在db1上运行galera_new_cluster命令</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">galera_new_cluster</span><br></pre></td></tr></table></figure><h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><blockquote><ul><li>在db1上查看集群状态</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysql -uroot -p -e <span class="string">"show status like 'wsrep_cluster_size';"</span></span></span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_size       | 1                                    |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="监控MariaDB日志"><a href="#监控MariaDB日志" class="headerlink" title="监控MariaDB日志"></a>监控MariaDB日志</h2><blockquote><ul><li>监控db1上的MariaDB日志</li><li>在启动其他节点的时候，能看到其他节点加入到galera集群</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/mariadb/mariadb.log</span><br></pre></td></tr></table></figure><h2 id="启动其他节点数据库"><a href="#启动其他节点数据库" class="headerlink" title="启动其他节点数据库"></a>启动其他节点数据库</h2><blockquote><ul><li>在db2和db3上运行MariaDB数据库</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure><h2 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h2><blockquote><ul><li>在db1上检查集群状态</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "show status like 'wsrep_cluster_size';"</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_size       | 3                                    |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><h1 id="验证MariaDB-galera集群的同步功能是否正常"><a href="#验证MariaDB-galera集群的同步功能是否正常" class="headerlink" title="验证MariaDB galera集群的同步功能是否正常"></a>验证MariaDB galera集群的同步功能是否正常</h1><h2 id="在db1上创建用户、数据库"><a href="#在db1上创建用户、数据库" class="headerlink" title="在db1上创建用户、数据库"></a>在db1上创建用户、数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "user add testuser;"</span><br><span class="line">mysql -uroot -p -e "create database testdb;"</span><br><span class="line">mysql -uroot -p -e "grant all privileges on testdb.* to 'testuser'@'localhost' identified by 'password';"</span><br></pre></td></tr></table></figure><h2 id="在db2上检查用户、数据库是否存在"><a href="#在db2上检查用户、数据库是否存在" class="headerlink" title="在db2上检查用户、数据库是否存在"></a>在db2上检查用户、数据库是否存在</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "select user,host from mysql.user;"</span><br><span class="line">mysql -uroot -p -e "show databases;"</span><br></pre></td></tr></table></figure><h2 id="在db3上删除用户和数据库"><a href="#在db3上删除用户和数据库" class="headerlink" title="在db3上删除用户和数据库"></a>在db3上删除用户和数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "delete user 'testuser'"</span><br><span class="line">mysql -uroot -p -e "drop database testdb"</span><br></pre></td></tr></table></figure><h2 id="在db1上检查用户和数据库是否还在"><a href="#在db1上检查用户和数据库是否还在" class="headerlink" title="在db1上检查用户和数据库是否还在"></a>在db1上检查用户和数据库是否还在</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p -e "select user,host from mysql.user;"</span><br><span class="line">mysql -uroot -p -e "show databases;"</span><br></pre></td></tr></table></figure><h1 id="至此，MariaDB-galera集群已经部署完成"><a href="#至此，MariaDB-galera集群已经部署完成" class="headerlink" title="至此，MariaDB galera集群已经部署完成"></a>至此，MariaDB galera集群已经部署完成</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;本文以MariaDB官方文档为基础，记录操作步骤&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;&lt;h1 id
      
    
    </summary>
    
    
      <category term="Mariadb/MySQL" scheme="https://luanlengli.github.io/tags/Mariadb-MySQL/"/>
    
      <category term="Linux" scheme="https://luanlengli.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>使用Docker打包shadowsocks-libev镜像</title>
    <link href="https://luanlengli.github.io/2018/12/11/%E4%BD%BF%E7%94%A8Docker%E6%89%93%E5%8C%85shadowsocks-libev%E9%95%9C%E5%83%8F.html"/>
    <id>https://luanlengli.github.io/2018/12/11/使用Docker打包shadowsocks-libev镜像.html</id>
    <published>2018-12-10T16:03:06.000Z</published>
    <updated>2018-12-10T16:31:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>记录一下使用Dockerfile制作shadowsocks-libev镜像的过程</p><blockquote><ul><li>基于Alpine-3.8和shadowsocks-libev-v3.2.3制作</li><li>参考shadowsocks-libev项目上面的<a href="https://raw.githubusercontent.com/shadowsocks/shadowsocks-libev/v3.2.3/docker/alpine/Dockerfile" target="_blank" rel="noopener">Dockerfile</a></li></ul></blockquote><h1 id="以下是Dockerfile内容"><a href="#以下是Dockerfile内容" class="headerlink" title="以下是Dockerfile内容"></a>以下是Dockerfile内容</h1><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># README</span></span><br><span class="line"><span class="comment"># /*  BUILD IMAGE  */</span></span><br><span class="line"><span class="comment"># dokcer image build -t shadowsocks-libev:v3.2.3 .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /*  RUN CONATIANER  */</span></span><br><span class="line"><span class="comment"># docker container run -d -e SERVER_PORT=111 -e PASSWORD='password' -e METHOD='aes-256-gcm' --net host --name ss-libev-port111 shadowsocks-libev:v3.2-alpine3.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /*  SS-SERVER HELP  */</span></span><br><span class="line"><span class="comment"># shadowsocks-libev 3.2.3</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   maintained by Max Lv &lt;max.c.lv@gmail.com&gt; and Linus Yang &lt;laokongzi@gmail.com&gt;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   usage:</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#     ss-server</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#        -s &lt;server_host&gt;           Host name or IP address of your remote server.</span></span><br><span class="line"><span class="comment">#        -p &lt;server_port&gt;           Port number of your remote server.</span></span><br><span class="line"><span class="comment">#        -l &lt;local_port&gt;            Port number of your local server.</span></span><br><span class="line"><span class="comment">#        -k &lt;password&gt;              Password of your remote server.</span></span><br><span class="line"><span class="comment">#        -m &lt;encrypt_method&gt;        Encrypt method: rc4-md5, </span></span><br><span class="line"><span class="comment">#                                   aes-128-gcm, aes-192-gcm, aes-256-gcm,</span></span><br><span class="line"><span class="comment">#                                   aes-128-cfb, aes-192-cfb, aes-256-cfb,</span></span><br><span class="line"><span class="comment">#                                   aes-128-ctr, aes-192-ctr, aes-256-ctr,</span></span><br><span class="line"><span class="comment">#                                   camellia-128-cfb, camellia-192-cfb,</span></span><br><span class="line"><span class="comment">#                                   camellia-256-cfb, bf-cfb,</span></span><br><span class="line"><span class="comment">#                                   chacha20-ietf-poly1305,</span></span><br><span class="line"><span class="comment">#                                   xchacha20-ietf-poly1305,</span></span><br><span class="line"><span class="comment">#                                   salsa20, chacha20 and chacha20-ietf.</span></span><br><span class="line"><span class="comment">#                                   The default cipher is chacha20-ietf-poly1305.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#        [-a &lt;user&gt;]                Run as another user.</span></span><br><span class="line"><span class="comment">#        [-f &lt;pid_file&gt;]            The file path to store pid.</span></span><br><span class="line"><span class="comment">#        [-t &lt;timeout&gt;]             Socket timeout in seconds.</span></span><br><span class="line"><span class="comment">#        [-c &lt;config_file&gt;]         The path to config file.</span></span><br><span class="line"><span class="comment">#        [-n &lt;number&gt;]              Max number of open files.</span></span><br><span class="line"><span class="comment">#        [-i &lt;interface&gt;]           Network interface to bind.</span></span><br><span class="line"><span class="comment">#        [-b &lt;local_address&gt;]       Local address to bind.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#        [-u]                       Enable UDP relay.</span></span><br><span class="line"><span class="comment">#        [-U]                       Enable UDP relay and disable TCP relay.</span></span><br><span class="line"><span class="comment">#        [-6]                       Resovle hostname to IPv6 address first.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#        [-d &lt;addr&gt;]                Name servers for internal DNS resolver.</span></span><br><span class="line"><span class="comment">#        [--reuse-port]             Enable port reuse.</span></span><br><span class="line"><span class="comment">#        [--fast-open]              Enable TCP fast open.</span></span><br><span class="line"><span class="comment">#                                   with Linux kernel &gt; 3.7.0.</span></span><br><span class="line"><span class="comment">#        [--acl &lt;acl_file&gt;]         Path to ACL (Access Control List).</span></span><br><span class="line"><span class="comment">#        [--manager-address &lt;addr&gt;] UNIX domain socket address.</span></span><br><span class="line"><span class="comment">#        [--mtu &lt;MTU&gt;]              MTU of your network interface.</span></span><br><span class="line"><span class="comment">#        [--mptcp]                  Enable Multipath TCP on MPTCP Kernel.</span></span><br><span class="line"><span class="comment">#        [--no-delay]               Enable TCP_NODELAY.</span></span><br><span class="line"><span class="comment">#        [--key &lt;key_in_base64&gt;]    Key of your remote server.</span></span><br><span class="line"><span class="comment">#        [--plugin &lt;name&gt;]          Enable SIP003 plugin. (Experimental)</span></span><br><span class="line"><span class="comment">#        [--plugin-opts &lt;options&gt;]  Set SIP003 plugin options. (Experimental)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#        [-v]                       Verbose mode.</span></span><br><span class="line"><span class="comment">#        [-h, --help]               Print this message.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ <span class="string">'Asia/Shanghai'</span></span><br><span class="line"><span class="keyword">ENV</span> SS_VERSION <span class="number">3.2</span>.<span class="number">3</span></span><br><span class="line"><span class="keyword">ENV</span> SS_DOWNLOAD_URL https://github.com/shadowsocks/shadowsocks-libev/releases/download/v$&#123;SS_VERSION&#125;/shadowsocks-libev-$&#123;SS_VERSION&#125;.tar.gz</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk upgrade \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add bash tzdata libsodium rng-tools \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --virtual .build-deps \</span></span><br><span class="line"><span class="bash">    autoconf \</span></span><br><span class="line"><span class="bash">    automake \</span></span><br><span class="line"><span class="bash">    xmlto \</span></span><br><span class="line"><span class="bash">    build-base \</span></span><br><span class="line"><span class="bash">    curl \</span></span><br><span class="line"><span class="bash">    c-ares-dev \</span></span><br><span class="line"><span class="bash">    libev-dev \</span></span><br><span class="line"><span class="bash">    libtool \</span></span><br><span class="line"><span class="bash">    linux-headers \</span></span><br><span class="line"><span class="bash">    udns-dev \</span></span><br><span class="line"><span class="bash">    libsodium-dev \</span></span><br><span class="line"><span class="bash">    mbedtls-dev \</span></span><br><span class="line"><span class="bash">    pcre-dev \</span></span><br><span class="line"><span class="bash">    udns-dev \</span></span><br><span class="line"><span class="bash">    tar \</span></span><br><span class="line"><span class="bash">    git \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O - <span class="variable">$SS_DOWNLOAD_URL</span> | tar xz  \</span></span><br><span class="line"><span class="bash">    &amp;&amp; (<span class="built_in">cd</span> shadowsocks-libev-<span class="variable">$&#123;SS_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./configure --prefix=/usr --<span class="built_in">disable</span>-documentation \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make install) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ln -sf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk del .build-deps \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf shadowsocks-libev-<span class="variable">$&#123;SS_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">    /var/cache/apk/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache \</span></span><br><span class="line"><span class="bash">    rng-tools \</span></span><br><span class="line"><span class="bash">    $(scanelf --needed --nobanner /usr/bin/ss-* \</span></span><br><span class="line"><span class="bash">    | awk <span class="string">'&#123; gsub(/,/, "\nso:", $2); print "so:" $2 &#125;'</span> \</span></span><br><span class="line"><span class="bash">    | sort -u)</span></span><br><span class="line"><span class="bash">    </span></span><br><span class="line"><span class="bash">CMD [<span class="string">"/usr/bin/ss-server"</span>]</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h1&gt;&lt;p&gt;记录一下使用Dockerfile制作shadowsocks-libev镜像的过程&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;基于Alpi
      
    
    </summary>
    
    
      <category term="docker" scheme="https://luanlengli.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>【不定时更新】二进制部署 kubernetes v1.11.x 高可用集群</title>
    <link href="https://luanlengli.github.io/2018/12/08/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%20kubernetes%20v1.11.x%20%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4.html"/>
    <id>https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.x 高可用集群.html</id>
    <published>2018-12-08T03:34:08.000Z</published>
    <updated>2019-02-21T03:20:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h1><blockquote><ul><li>2019年2月13日由于runc逃逸漏洞<a href="https://www.anquanke.com/post/id/170762" target="_blank" rel="noopener">CVE-2019-5736</a>，根据kubernetes的<a href="https://kubernetes.io/blog/2019/02/11/runc-and-cve-2019-5736/" target="_blank" rel="noopener">文档建议</a>，修改docker-ce版本为18.09.2</li><li>2019年1月7日添加基于ingress-nginx使用域名+HTTPS的方式访问kubernetes-Dashboard</li><li>2019年1月2日添加RBAC规则，修复kube-apiserver无法访问kubelet的问题</li><li>2019年1月1日调整master节点和worker节点的操作步骤，添加CoreDNS的configmap中的hosts静态解析</li><li>2018年12月28日修改kube-prometheus部分，修复Prometheus的Targets无法发现的问题</li><li>2018年12月26日修改kubernetes-dashboard链接指向</li><li>2018年12月25日修改kubele.config.file路径问题</li><li>2018年12月18日修改kubelet和kube-proxy启动时加载config file</li><li>2018年12月17日添加EFK部署内容</li><li>2018年12月16日添加prometheus-operator部署内容</li><li>2018年12月14日添加helm部署内容，拆分etcd的server证书和client证书</li><li>2018年12月13日添加rook-ceph部署内容</li><li>2018年12月12日添加Metrics-Server内容</li><li>2018年12月11日添加Dashboard、Ingress内容</li><li>2018年12月10日添加kube-flannel、calico、CoreDNS内容</li><li>2018年12月9日分拆master节点和work节点的内容</li><li>2018年12月8日初稿</li></ul></blockquote><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>本次部署方式为二进制可执行文件的方式部署</p><blockquote><ul><li>注意<font color="red">请根据自己的实际情况调整</font></li><li>对于生产环境部署，请注意某些参数的选择</li></ul></blockquote><p>如无特殊说明，均在<font color="red">k8s-m1</font>节点上执行</p><h2 id="参考博文"><a href="#参考博文" class="headerlink" title="参考博文"></a>参考博文</h2><p>感谢两位大佬的文章，这里整合一下两位大佬的内容，结合自己的理解整理本文</p><blockquote><ul><li><a href="https://mritd.me/2018/04/19/set-up-kubernetes-1.10.1-cluster-by-hyperkube/" target="_blank" rel="noopener">【漠然】Kubernetes 1.10.1 集群搭建</a></li><li><a href="https://mritd.me/2018/08/28/kubernetes-tls-bootstrapping-with-bootstrap-token/" target="_blank" rel="noopener">【漠然】使用 Bootstrap Token 完成 TLS Bootstrapping</a></li><li><a href="https://zhangguanzhang.github.io/2018/09/18/kubernetes-1-11-x-bin/" target="_blank" rel="noopener">【张馆长】二进制部署Kubernetes v1.11.x(1.12.x) HA可选</a></li></ul></blockquote><h2 id="软件版本"><a href="#软件版本" class="headerlink" title="软件版本"></a>软件版本</h2><blockquote><ul><li><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md" target="_blank" rel="noopener">kubernetes v1.11.5</a> <font color="red">【下载链接需要爬墙，自行解决】</font>&gt;</li><li><a href="https://docs.docker.com/install/linux/docker-ce/" target="_blank" rel="noopener">docker-ce 18.03</a></li><li><a href="https://github.com/containernetworking/plugins/releases" target="_blank" rel="noopener">cni-plugin v0.7.4</a></li><li><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">etcd v3.3.10</a></li></ul></blockquote><h2 id="网络信息"><a href="#网络信息" class="headerlink" title="网络信息"></a>网络信息</h2><blockquote><ul><li>基于CNI的模式实现容器网络</li><li>Cluster IP CIDR: <code>10.244.0.0/16</code></li><li>Service Cluster IP CIDR: <code>10.96.0.0/12</code></li><li>Service DNS IP: <code>10.96.0.10</code></li><li>Kubernetes API VIP: <code>172.16.80.200</code></li></ul></blockquote><h2 id="节点信息"><a href="#节点信息" class="headerlink" title="节点信息"></a>节点信息</h2><blockquote><ul><li>操作系统可采用 <code>Ubuntu Server 16.04+</code> 和 <code>CentOS 7.4+</code>，本文使用CentOS 7.6 (1810) Minimal</li><li>由<code>keepalived</code>提供VIP</li><li>由<code>haproxy</code>提供kube-apiserver四层负载均衡</li><li>由于实验环境受限，以3台服务器同时作为master和worker节点运行</li><li>服务器配置请根据实际情况适当调整</li></ul></blockquote><table><thead><tr><th style="text-align:center">IP地址</th><th style="text-align:center">主机名</th><th style="text-align:center">角色</th><th style="text-align:center">CPU</th><th style="text-align:center">内存</th></tr></thead><tbody><tr><td style="text-align:center">172.16.80.201</td><td style="text-align:center">k8s-m1</td><td style="text-align:center">master+worker</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.202</td><td style="text-align:center">k8s-m2</td><td style="text-align:center">master+worker</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr><tr><td style="text-align:center">172.16.80.203</td><td style="text-align:center">k8s-m3</td><td style="text-align:center">master+worker</td><td style="text-align:center">4</td><td style="text-align:center">8G</td></tr></tbody></table><h2 id="目录说明"><a href="#目录说明" class="headerlink" title="目录说明"></a>目录说明</h2><blockquote><ul><li>/usr/local/bin/：存放kubernetes和etcd二进制文件</li><li>/opt/cni/bin/： 存放cni-plugin二进制文件</li><li>/etc/etcd/：存放etcd配置文件和SSL证书</li><li>/etc/kubernetes/：存放kubernetes配置和SSL证书</li><li>/etc/cni/net.d/：安装CNI插件后会在这里生成配置文件</li><li>$HOME/.kube/：kubectl命令会在家目录下建立此目录，用于保存访问kubernetes集群的配置和缓存</li><li>$HOME/.helm/：helm命令会建立此目录，用于保存helm缓存和repository信息</li></ul></blockquote><h1 id="事前准备"><a href="#事前准备" class="headerlink" title="事前准备"></a>事前准备</h1><blockquote><p>事情准备在所有服务器上都需要完成</p><p>部署过程以<code>root用户</code>完成</p></blockquote><ul><li>所有服务器<code>网络互通</code>，<code>k8s-m1</code>可以通过SSH证书免密登录到其他master节点，用于分发文件</li><li>编辑<code>/etc/hosts</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.200 k8s-vip</span><br><span class="line">172.16.80.201 k8s-m1</span><br><span class="line">172.16.80.202 k8s-m2</span><br><span class="line">172.16.80.203 k8s-m3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>时间同步服务</li></ul><p>集群系统需要各节点时间同步</p><p>参考链接：<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/sect-using_chrony" target="_blank" rel="noopener">RHEL7官方文档</a></p><p>这里使用公网对时，如果需要内网对时，请自行配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y chrony</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">systemctl start chronyd</span><br></pre></td></tr></table></figure><ul><li>关闭firewalld和SELINUX（可根据实际情况自行决定关闭不需要的服务）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl mask firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清空iptables规则</span></span><br><span class="line">iptables -t filter -F</span><br><span class="line">iptables -t filter -X</span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables -t nat -X</span><br><span class="line">iptables -t mangle -F</span><br><span class="line">iptables -t mangle -X</span><br><span class="line">iptables -t raw -F</span><br><span class="line">iptables -t raw -X</span><br><span class="line">iptables -t security -F</span><br><span class="line">iptables -t security -X</span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -ri '/^[^#]*SELINUX=/s#=.+$#=disabled#' /etc/selinux/config</span><br></pre></td></tr></table></figure><ul><li>禁用swap</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab</span><br></pre></td></tr></table></figure><ul><li>添加<code>sysctl</code>参数</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/centos.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=1024000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在CentOS7.4引入了一个新的参数来控制内核的行为。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /proc/sys/fs/may_detach_mounts 默认设置为0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统有容器运行的时候，需要将该值设置为1。</span></span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1024000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示最大限度使用物理内存，然后才是swap空间</span></span><br><span class="line">vm.swappiness = 0 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置系统TCP连接keepalive的持续时间，默认7200</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 10</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 让sysctl参数生效</span></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><ul><li>确保操作系统已经最新</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><ul><li>安装软件包</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum groups install base -y</span><br><span class="line">yum install epel-release bash-completion-extras -y</span><br><span class="line">yum install git vim ipvsadm tree dstat iotop htop socat ipset conntrack -y</span><br></pre></td></tr></table></figure><ul><li>加载ipvs模块</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 开机自动加载ipvs模块</span></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"</span><br><span class="line">for kernel_module in \$&#123;ipvs_modules&#125;; do</span><br><span class="line">    /sbin/modinfo -F filename \$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe \$&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br></pre></td></tr></table></figure><ul><li>安装docker-ce 18.09.2</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine -y</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 -y</span><br><span class="line">yum-config-manager --add-repo http://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sed -e 's,download.docker.com,mirrors.aliyun.com/docker-ce,g' -i /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum install docker-ce-18.09.2 -y</span><br></pre></td></tr></table></figure><ul><li>创建docker配置文件</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash">/etc/docker/daemon.json&lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["https://registry.docker-cn.com"],</span><br><span class="line">    "insecure-registries": [],</span><br><span class="line">    "log-driver": "json-file",</span><br><span class="line">    "log-opts": &#123;</span><br><span class="line">        "max-size": "100m",</span><br><span class="line">        "max-file": "3"</span><br><span class="line">    &#125;,</span><br><span class="line">    "max-concurrent-downloads": 10</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>配置docker命令补全</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/bash-completion/completions/docker /etc/bash_completion.d/</span><br><span class="line">source /etc/bash_completion.d/docker</span><br></pre></td></tr></table></figure><ul><li>配置docker服务开机自启动</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker.service</span><br><span class="line">systemctl start docker.service</span><br></pre></td></tr></table></figure><ul><li>查看docker信息</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure><ul><li>禁用docker源</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 为避免yum update时更新docker，将docker源禁用</span></span><br><span class="line">sed -e 's,enabled=1,enabled=0,g' -i /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure><ul><li>确保以最新的内核启动系统</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><h1 id="定义集群变量"><a href="#定义集群变量" class="headerlink" title="定义集群变量"></a><strong><font color="red">定义集群变量</font></strong></h1><blockquote><font color="red"><strong>注意</strong></font><ul><li>这里的变量只对当前会话生效，如果会话断开或者重启服务器，都需要重新定义变量</li><li><code>HostArray</code>定义集群中所有节点的主机名和IP</li><li><code>MasterArray</code>定义master节点的主机名和IP</li><li><code>WorkerArray</code>定义worker节点的主机名和IP，这里master和worker都在一起，所以MasterArray和WorkerArray一样</li><li><code>VIP_IFACE</code>定义keepalived的VIP绑定在哪一个网卡</li><li><code>ETCD_SERVERS</code>以MasterArray的信息生成etcd集群服务器列表</li><li><code>ETCD_INITIAL_CLUSTER</code>以MasterArray信息生成etcd集群初始化列表</li><li><code>POD_DNS_SERVER_IP</code>定义Pod的DNS服务器IP地址</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">declare -A HostArray MasterArray WorkerArray</span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明所有节点的信息</span></span><br><span class="line">HostArray=(['k8s-m1']=172.16.80.201 ['k8s-m2']=172.16.80.202 ['k8s-m3']=172.16.80.203)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果节点多，可以按照下面的方式声明Array</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> HostArray=([<span class="string">'k8s-m1'</span>]=172.16.80.201 [<span class="string">'k8s-m2'</span>]=172.16.80.202 [<span class="string">'k8s-m3'</span>]=172.16.80.203 [<span class="string">'k8s-n1'</span>]=172.16.80.204 [<span class="string">'k8s-n2'</span>]=172.16.80.205)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明master节点信息</span></span><br><span class="line">MasterArray=(['k8s-m1']=172.16.80.201 ['k8s-m2']=172.16.80.202 ['k8s-m3']=172.16.80.203)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明worker节点信息</span></span><br><span class="line">WorkerArray=(['k8s-m1']=172.16.80.201 ['k8s-m2']=172.16.80.202 ['k8s-m3']=172.16.80.203)</span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line">VIP="172.16.80.200"</span><br><span class="line">KUBE_APISERVER="https://172.16.80.200:8443"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd版本号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubeadm-v1.11.5里面使用的是v3.2.18，这里直接上到最新的v3.3.10</span></span><br><span class="line">ETCD_VERSION="v3.3.10"</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubernetes版本号</span></span><br><span class="line">KUBERNETES_VERSION="v1.11.5"</span><br><span class="line"><span class="meta">#</span><span class="bash"> cni-plugin版本号</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubernetes YUM源里用的还是v0.6.0版，这里上到最新的v0.7.4</span></span><br><span class="line">CNI_PLUGIN_VERSION="v0.7.4"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明VIP所在的网卡名称，以ens33为例</span></span><br><span class="line">VIP_IFACE="ens33"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 声明etcd_server</span></span><br><span class="line">ETCD_SERVERS=$( xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#^#https://#;s#$#:2379#;$s#\n##' | paste -d, -s - )</span><br><span class="line">ETCD_INITIAL_CLUSTER=$( for i in $&#123;!MasterArray[@]&#125;;do  echo $i=https://$&#123;MasterArray[$i]&#125;:2380; done | sort | paste -d, -s - )</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义POD_CLUSTER_CIDR</span></span><br><span class="line">POD_NET_CIDR="10.244.0.0/16"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义SVC_CLUSTER_CIDR</span></span><br><span class="line">SVC_CLUSTER_CIDR="10.96.0.0/12"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义POD_DNS_SERVER_IP</span></span><br><span class="line">POD_DNS_SERVER_IP="10.96.0.10"</span><br></pre></td></tr></table></figure><h1 id="下载所需软件包"><a href="#下载所需软件包" class="headerlink" title="下载所需软件包"></a>下载所需软件包</h1><blockquote><ul><li>创建工作目录</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/software</span><br><span class="line">cd /root/software</span><br></pre></td></tr></table></figure><blockquote><ul><li>二进制文件需要分发到master和worker节点</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载kubernetes二进制包</span></span><br><span class="line">echo "--- 下载kubernetes $&#123;KUBERNETES_VERSION&#125; 二进制包 ---"</span><br><span class="line">wget https://dl.k8s.io/$&#123;KUBERNETES_VERSION&#125;/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar xzf kubernetes-server-linux-amd64.tar.gz \</span><br><span class="line">        kubernetes/server/bin/hyperkube \</span><br><span class="line">        kubernetes/server/bin/kube-controller-manager \</span><br><span class="line">        kubernetes/server/bin/kubectl \</span><br><span class="line">        kubernetes/server/bin/apiextensions-apiserver \</span><br><span class="line">        kubernetes/server/bin/kube-proxy \</span><br><span class="line">        kubernetes/server/bin/kube-apiserver \</span><br><span class="line">        kubernetes/server/bin/kubelet \</span><br><span class="line">        kubernetes/server/bin/kubeadm \</span><br><span class="line">        kubernetes/server/bin/kube-aggregator \</span><br><span class="line">        kubernetes/server/bin/kube-scheduler \</span><br><span class="line">        kubernetes/server/bin/cloud-controller-manager \</span><br><span class="line">        kubernetes/server/bin/mounter</span><br><span class="line">chown -R root:root kubernetes/server/bin/*</span><br><span class="line">chmod 0755 kubernetes/server/bin/*</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里需要先拷贝kubectl到/usr/<span class="built_in">local</span>/bin目录下，用于生成kubeconfig文件</span></span><br><span class="line">rsync -avpt kubernetes/server/bin/kubectl /usr/local/bin/kubectl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载etcd二进制包</span></span><br><span class="line">echo "--- 下载etcd $&#123;ETCD_VERSION&#125; 二进制包 ---"</span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/$&#123;ETCD_VERSION&#125;/etcd-$&#123;ETCD_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzf etcd-$&#123;ETCD_VERSION&#125;-linux-amd64.tar.gz \</span><br><span class="line">        etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl \</span><br><span class="line">        etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd</span><br><span class="line">chown root:root etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd</span><br><span class="line">chmod 0755 etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载CNI-plugin</span></span><br><span class="line">echo "--- 下载cni-plugins $&#123;CNI_PLUGIN_VERSION&#125; 二进制包 ---"</span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/$&#123;CNI_PLUGIN_VERSION&#125;/cni-plugins-amd64-$&#123;CNI_PLUGIN_VERSION&#125;.tgz</span><br><span class="line">mkdir /root/software/cni-plugins</span><br><span class="line">tar xzf cni-plugins-amd64-$&#123;CNI_PLUGIN_VERSION&#125;.tgz -C /root/software/cni-plugins/</span><br></pre></td></tr></table></figure><h1 id="生成集群Key和Certificates"><a href="#生成集群Key和Certificates" class="headerlink" title="生成集群Key和Certificates"></a>生成集群Key和Certificates</h1><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>本次部署，需要为<code>etcd-server</code>、<code>etcd-client</code>、<code>kube-apiserver</code>、<code>kube-controller-manager</code>、<code>kube-scheduler</code>、<code>kube-proxy</code>生成证书。另外还需要生成<code>sa</code>、<code>front-proxy-ca</code>、<code>front-proxy-client</code>证书用于集群的其他功能。</p><blockquote><ul><li>要注意CA JSON文件的<code>CN(Common Name)</code>与<code>O(Organization)</code>等内容是会影响Kubernetes组件认证的。<ul><li><code>CN</code> Common Name，kube-apiserver会从证书中提取该字段作为请求的用户名（User Name）</li><li><code>O</code> Oragnization，kube-apiserver会从证书中提取该字段作为请求用户的所属组（Group）</li></ul></li><li>CA是自签名根证书，用来给后续各种证书签名</li><li>kubernetes集群的所有状态信息都保存在etcd中，kubernetes组件会通过kube-apiserver读写etcd里面的信息</li><li>etcd如果暴露在公网且没做SSL/TLS验证，那么任何人都能读写数据，那么很可能会无端端在kubernetes集群里面多了挖坑Pod或者肉鸡Pod</li><li>本文使用<code>CFSSL</code>创建证书，证书有效期10年</li><li>建立证书过程在<font color="red" size="3">k8s-m1</font>上完成</li></ul></blockquote><h2 id="下载CFSSL工具"><a href="#下载CFSSL工具" class="headerlink" title="下载CFSSL工具"></a>下载CFSSL工具</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/local/bin/cfssl-certinfo</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/local/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/local/bin/cfssljson</span><br><span class="line">chmod 755 /usr/local/bin/cfssl-certinfo \</span><br><span class="line">          /usr/local/bin/cfssl \</span><br><span class="line">          /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure><h2 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/pki /root/master /root/worker</span><br><span class="line">cd /root/pki</span><br></pre></td></tr></table></figure><h2 id="创建用于生成证书的json文件"><a href="#创建用于生成证书的json文件" class="headerlink" title="创建用于生成证书的json文件"></a>创建用于生成证书的json文件</h2><h3 id="ca-config-json"><a href="#ca-config-json" class="headerlink" title="ca-config.json"></a>ca-config.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "signing": &#123;</span><br><span class="line">    "default": &#123;</span><br><span class="line">      "expiry": "87600h"</span><br><span class="line">    &#125;,</span><br><span class="line">    "profiles": &#123;</span><br><span class="line">      "kubernetes": &#123;</span><br><span class="line">        "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ],</span><br><span class="line">        "expiry": "87600h"</span><br><span class="line">      &#125;,</span><br><span class="line">      "etcd-server": &#123;</span><br><span class="line">        "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ],</span><br><span class="line">        "expiry": "87600h"</span><br><span class="line">      &#125;,</span><br><span class="line">      "etcd-client": &#123;</span><br><span class="line">          "usages": [</span><br><span class="line">              "signing",</span><br><span class="line">              "key encipherment",</span><br><span class="line">              "client auth"</span><br><span class="line">          ],</span><br><span class="line">          "expiry": "87600h"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="ca-csr-json"><a href="#ca-csr-json" class="headerlink" title="ca-csr.json"></a>ca-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="etcd-ca-csr-json"><a href="#etcd-ca-csr-json" class="headerlink" title="etcd-ca-csr.json"></a>etcd-ca-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="etcd-server-csr-json"><a href="#etcd-server-csr-json" class="headerlink" title="etcd-server-csr.json"></a>etcd-server-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-server-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd-server",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="etcd-client-csr-json"><a href="#etcd-client-csr-json" class="headerlink" title="etcd-client-csr.json"></a>etcd-client-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd-client",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "hosts": [</span><br><span class="line">    ""</span><br><span class="line">  ],</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-apiserver-csr-json"><a href="#kube-apiserver-csr-json" class="headerlink" title="kube-apiserver-csr.json"></a>kube-apiserver-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kube-apiserver",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-manager-csr-json"><a href="#kube-manager-csr-json" class="headerlink" title="kube-manager-csr.json"></a>kube-manager-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-controller-manager",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-controller-manager",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-scheduler-csr-json"><a href="#kube-scheduler-csr-json" class="headerlink" title="kube-scheduler-csr.json"></a>kube-scheduler-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-scheduler",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-scheduler",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-proxy-csr-json"><a href="#kube-proxy-csr-json" class="headerlink" title="kube-proxy-csr.json"></a>kube-proxy-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-proxy",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-proxy",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-admin-csr-json"><a href="#kube-admin-csr-json" class="headerlink" title="kube-admin-csr.json"></a>kube-admin-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "admin",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:masters",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="front-proxy-ca-csr-json"><a href="#front-proxy-ca-csr-json" class="headerlink" title="front-proxy-ca-csr.json"></a>front-proxy-ca-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="front-proxy-client-csr-json"><a href="#front-proxy-client-csr-json" class="headerlink" title="front-proxy-client-csr.json"></a>front-proxy-client-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "front-proxy-client",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="sa-csr-json"><a href="#sa-csr-json" class="headerlink" title="sa-csr.json"></a>sa-csr.json</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; sa-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "service-accounts",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="创建etcd证书"><a href="#创建etcd证书" class="headerlink" title="创建etcd证书"></a>创建etcd证书</h2><h3 id="etcd-ca证书"><a href="#etcd-ca证书" class="headerlink" title="etcd-ca证书"></a>etcd-ca证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建etcd-ca证书 ---'</span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca</span><br></pre></td></tr></table></figure><h3 id="etcd-server证书"><a href="#etcd-server证书" class="headerlink" title="etcd-server证书"></a>etcd-server证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建etcd-server证书 ---'</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=etcd-ca.pem \</span><br><span class="line">      -ca-key=etcd-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -hostname=127.0.0.1,$(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort  | paste -d, -s -) \</span><br><span class="line">      -profile=etcd-server etcd-server-csr.json | cfssljson -bare etcd-server</span><br></pre></td></tr></table></figure><h3 id="etcd-client证书"><a href="#etcd-client证书" class="headerlink" title="etcd-client证书"></a>etcd-client证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建etcd-client证书 ---'</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=etcd-ca.pem \</span><br><span class="line">      -ca-key=etcd-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=etcd-client etcd-client-csr.json | cfssljson -bare etcd-client</span><br></pre></td></tr></table></figure><h2 id="创建kubernetes证书"><a href="#创建kubernetes证书" class="headerlink" title="创建kubernetes证书"></a>创建kubernetes证书</h2><h3 id="kubernetes-CA-证书"><a href="#kubernetes-CA-证书" class="headerlink" title="kubernetes-CA 证书"></a>kubernetes-CA 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kubernetes-ca证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kubernetes-ca证书</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare kube-ca</span><br></pre></td></tr></table></figure><h3 id="kube-apiserver证书"><a href="#kube-apiserver证书" class="headerlink" title="kube-apiserver证书"></a>kube-apiserver证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-apiserver证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-apiserver证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里的hostname字段中的10.96.0.1要跟上文提到的service cluster ip cidr对应</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -hostname=10.96.0.1,127.0.0.1,localhost,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,$&#123;VIP&#125;,$(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort  | paste -d, -s -) \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br></pre></td></tr></table></figure><h3 id="kube-controller-manager证书"><a href="#kube-controller-manager证书" class="headerlink" title="kube-controller-manager证书"></a>kube-controller-manager证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-controller-manager证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-controller-manager证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure><h3 id="kube-scheduler证书"><a href="#kube-scheduler证书" class="headerlink" title="kube-scheduler证书"></a>kube-scheduler证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-scheduler证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-scheduler证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure><h3 id="kube-proxy证书"><a href="#kube-proxy证书" class="headerlink" title="kube-proxy证书"></a>kube-proxy证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-proxy证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-proxy证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure><h3 id="kube-admin证书"><a href="#kube-admin证书" class="headerlink" title="kube-admin证书"></a>kube-admin证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-admin证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建kube-admin证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-admin-csr.json | cfssljson -bare kube-admin</span><br></pre></td></tr></table></figure><h3 id="Front-Proxy证书"><a href="#Front-Proxy证书" class="headerlink" title="Front Proxy证书"></a>Front Proxy证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建Front Proxy Certificate证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建Front Proxy Certificate证书</span></span><br><span class="line">cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=front-proxy-ca.pem \</span><br><span class="line">      -ca-key=front-proxy-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br></pre></td></tr></table></figure><h3 id="Service-Account证书"><a href="#Service-Account证书" class="headerlink" title="Service Account证书"></a>Service Account证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建service account证书 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建创建service account证书</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      sa-csr.json | cfssljson -bare sa</span><br></pre></td></tr></table></figure><h3 id="bootstrap-token"><a href="#bootstrap-token" class="headerlink" title="bootstrap-token"></a>bootstrap-token</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOTSTRAP_TOKEN=$(dd if=/dev/urandom bs=128 count=1 2&gt;/dev/null | base64 | tr -d "=+/[:space:]" | dd bs=32 count=1 2&gt;/dev/null)</span><br><span class="line">echo "BOOTSTRAP_TOKEN: $&#123;BOOTSTRAP_TOKEN&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建token.csv文件</span></span><br><span class="line">cat &gt; token.csv &lt;&lt;EOF</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,<span class="string">"system:bootstrappers"</span></span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="encryption-yaml"><a href="#encryption-yaml" class="headerlink" title="encryption.yaml"></a>encryption.yaml</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ENCRYPTION_TOKEN=$(head -c 32 /dev/urandom | base64)</span><br><span class="line">echo "ENCRYPTION_TOKEN: $&#123;ENCRYPTION_TOKEN&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建encryption.yaml文件</span></span><br><span class="line">cat &gt; encryption.yaml &lt;&lt;EOF</span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: $&#123;ENCRYPTION_TOKEN&#125;</span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="audit-policy-yaml"><a href="#audit-policy-yaml" class="headerlink" title="audit-policy.yaml"></a>audit-policy.yaml</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建创建高级审计配置 ---'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建高级审计配置</span></span><br><span class="line">cat &gt;&gt; audit-policy.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> The following requests were manually identified as high-volume and low-risk,</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> so drop them.</span></span><br><span class="line">  - level: None</span><br><span class="line">    users: ["system:kube-proxy"]</span><br><span class="line">    verbs: ["watch"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["endpoints", "services", "services/status"]</span><br><span class="line">  - level: None</span><br><span class="line">    # Ingress controller reads 'configmaps/ingress-uid' through the unsecured port.</span><br><span class="line">    # TODO(#46983): Change this to the ingress controller service account.</span><br><span class="line">    users: ["system:unsecured"]</span><br><span class="line">    namespaces: ["kube-system"]</span><br><span class="line">    verbs: ["get"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["configmaps"]</span><br><span class="line">  - level: None</span><br><span class="line">    users: ["kubelet"] # legacy kubelet identity</span><br><span class="line">    verbs: ["get"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["nodes", "nodes/status"]</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: ["system:nodes"]</span><br><span class="line">    verbs: ["get"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["nodes", "nodes/status"]</span><br><span class="line">  - level: None</span><br><span class="line">    users:</span><br><span class="line">      - system:kube-controller-manager</span><br><span class="line">      - system:kube-scheduler</span><br><span class="line">      - system:serviceaccount:kube-system:endpoint-controller</span><br><span class="line">    verbs: ["get", "update"]</span><br><span class="line">    namespaces: ["kube-system"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["endpoints"]</span><br><span class="line">  - level: None</span><br><span class="line">    users: ["system:apiserver"]</span><br><span class="line">    verbs: ["get"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["namespaces", "namespaces/status", "namespaces/finalize"]</span><br><span class="line">  - level: None</span><br><span class="line">    users: ["cluster-autoscaler"]</span><br><span class="line">    verbs: ["get", "update"]</span><br><span class="line">    namespaces: ["kube-system"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["configmaps", "endpoints"]</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">'t log HPA fetching metrics.</span></span></span><br><span class="line">  - level: None</span><br><span class="line">    users:</span><br><span class="line">      - system:kube-controller-manager</span><br><span class="line">    verbs: ["get", "list"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "metrics.k8s.io"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">'t log these read-only URLs.</span></span></span><br><span class="line">  - level: None</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">      - /healthz*</span><br><span class="line">      - /version</span><br><span class="line">      - /swagger*</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Don<span class="string">'t log events requests.</span></span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["events"]</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> node and pod status calls from nodes are high-volume and can be large, don<span class="string">'t log responses for expected updates from nodes</span></span></span><br><span class="line">  - level: Request</span><br><span class="line">    users: ["kubelet", "system:node-problem-detector", "system:serviceaccount:kube-system:node-problem-detector"]</span><br><span class="line">    verbs: ["update","patch"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["nodes/status", "pods/status"]</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br><span class="line">  - level: Request</span><br><span class="line">    userGroups: ["system:nodes"]</span><br><span class="line">    verbs: ["update","patch"]</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["nodes/status", "pods/status"]</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> deletecollection calls can be large, don<span class="string">'t log responses for expected namespace deletions</span></span></span><br><span class="line">  - level: Request</span><br><span class="line">    users: ["system:serviceaccount:kube-system:namespace-controller"]</span><br><span class="line">    verbs: ["deletecollection"]</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> so only <span class="built_in">log</span> at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">      - group: "" # core</span><br><span class="line">        resources: ["secrets", "configmaps"]</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">        resources: ["tokenreviews"]</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Get repsonses can be large; skip them.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    verbs: ["get", "list", "watch"]</span><br><span class="line">    resources: </span><br><span class="line">      - group: "" # core</span><br><span class="line">      - group: "admissionregistration.k8s.io"</span><br><span class="line">      - group: "apiextensions.k8s.io"</span><br><span class="line">      - group: "apiregistration.k8s.io"</span><br><span class="line">      - group: "apps"</span><br><span class="line">      - group: "authentication.k8s.io"</span><br><span class="line">      - group: "authorization.k8s.io"</span><br><span class="line">      - group: "autoscaling"</span><br><span class="line">      - group: "batch"</span><br><span class="line">      - group: "certificates.k8s.io"</span><br><span class="line">      - group: "extensions"</span><br><span class="line">      - group: "metrics.k8s.io"</span><br><span class="line">      - group: "networking.k8s.io"</span><br><span class="line">      - group: "policy"</span><br><span class="line">      - group: "rbac.authorization.k8s.io"</span><br><span class="line">      - group: "scheduling.k8s.io"</span><br><span class="line">      - group: "settings.k8s.io"</span><br><span class="line">      - group: "storage.k8s.io"</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Default level <span class="keyword">for</span> known APIs</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources: </span><br><span class="line">      - group: "" # core</span><br><span class="line">      - group: "admissionregistration.k8s.io"</span><br><span class="line">      - group: "apiextensions.k8s.io"</span><br><span class="line">      - group: "apiregistration.k8s.io"</span><br><span class="line">      - group: "apps"</span><br><span class="line">      - group: "authentication.k8s.io"</span><br><span class="line">      - group: "authorization.k8s.io"</span><br><span class="line">      - group: "autoscaling"</span><br><span class="line">      - group: "batch"</span><br><span class="line">      - group: "certificates.k8s.io"</span><br><span class="line">      - group: "extensions"</span><br><span class="line">      - group: "metrics.k8s.io"</span><br><span class="line">      - group: "networking.k8s.io"</span><br><span class="line">      - group: "policy"</span><br><span class="line">      - group: "rbac.authorization.k8s.io"</span><br><span class="line">      - group: "scheduling.k8s.io"</span><br><span class="line">      - group: "settings.k8s.io"</span><br><span class="line">      - group: "storage.k8s.io"</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Default level <span class="keyword">for</span> all other requests.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><blockquote><ul><li>kubeconfig 文件用于组织关于集群、用户、命名空间和认证机制的信息。</li><li>命令行工具 <code>kubectl</code> 从 kubeconfig 文件中得到它要选择的集群以及跟集群 API server 交互的信息。</li><li>默认情况下，<code>kubectl</code> 会从 <code>$HOME/.kube</code> 目录下查找文件名为 <code>config</code> 的文件。</li></ul></blockquote><blockquote><p><strong>注意：</strong> 用于配置集群访问信息的文件叫作 <code>kubeconfig文件</code>，这是一种引用配置文件的通用方式，并不是说它的文件名就是 <code>kubeconfig</code>。</p></blockquote><h3 id="kube-controller-manager-kubeconfig"><a href="#kube-controller-manager-kubeconfig" class="headerlink" title="kube-controller-manager.kubeconfig"></a>kube-controller-manager.kubeconfig</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-controller-manager kubeconfig..."</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="kube-scheduler-kubeconfig"><a href="#kube-scheduler-kubeconfig" class="headerlink" title="kube-scheduler.kubeconfig"></a>kube-scheduler.kubeconfig</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-scheduler kubeconfig..."</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="kube-proxy-kubeconfig"><a href="#kube-proxy-kubeconfig" class="headerlink" title="kube-proxy.kubeconfig"></a>kube-proxy.kubeconfig</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-proxy kubeconfig..."</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials system:kube-proxy \</span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="kube-admin-kubeconfig"><a href="#kube-admin-kubeconfig" class="headerlink" title="kube-admin.kubeconfig"></a>kube-admin.kubeconfig</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-admin kubeconfig..."</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-admin.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials kubernetes-admin \</span><br><span class="line">  --client-certificate=kube-admin.pem \</span><br><span class="line">  --client-key=kube-admin-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-admin.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubernetes-admin \</span><br><span class="line">  --kubeconfig=kube-admin.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-admin.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="bootstrap-kubeconfig"><a href="#bootstrap-kubeconfig" class="headerlink" title="bootstrap.kubeconfig"></a>bootstrap.kubeconfig</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kubelet bootstrapping kubeconfig..."</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure><h3 id="清理证书CSR文件"><a href="#清理证书CSR文件" class="headerlink" title="清理证书CSR文件"></a>清理证书CSR文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 删除*.csr文件 ---'</span><br><span class="line">rm -rf *csr</span><br></pre></td></tr></table></figure><h2 id="修改文件权限"><a href="#修改文件权限" class="headerlink" title="修改文件权限"></a>修改文件权限</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown root:root *pem *kubeconfig *yaml *csv</span><br><span class="line">chmod 0444 *pem *kubeconfig *yaml *csv</span><br><span class="line">chmod 0400 *key.pem</span><br></pre></td></tr></table></figure><h2 id="检查生成的文件"><a href="#检查生成的文件" class="headerlink" title="检查生成的文件"></a>检查生成的文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ls -l | grep -v json</span><br><span class="line">-r--r--r-- 1 root root  113 Dec  6 15:36 audit-policy.yaml</span><br><span class="line">-r--r--r-- 1 root root 2207 Dec  6 15:36 bootstrap.kubeconfig</span><br><span class="line">-r--r--r-- 1 root root  240 Dec  6 15:36 encryption.yaml</span><br><span class="line">-r-------- 1 root root 1675 Dec  6 15:36 etcd-ca-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1375 Dec  6 15:36 etcd-ca.pem</span><br><span class="line">-r-------- 1 root root 1679 Dec  6 15:36 etcd-client-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1424 Dec  6 15:36 etcd-client.pem</span><br><span class="line">-r-------- 1 root root 1679 Dec  6 15:36 etcd-server-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1468 Dec  6 15:36 etcd-server.pem</span><br><span class="line">-r-------- 1 root root 1679 Dec  6 15:36 front-proxy-ca-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1143 Dec  6 15:36 front-proxy-ca.pem</span><br><span class="line">-r-------- 1 root root 1675 Dec  6 15:36 front-proxy-client-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1188 Dec  6 15:36 front-proxy-client.pem</span><br><span class="line">-r-------- 1 root root 1679 Dec  6 15:36 kube-admin-key.pem</span><br><span class="line">-r--r--r-- 1 root root 6345 Dec  6 15:36 kube-admin.kubeconfig</span><br><span class="line">-r--r--r-- 1 root root 1419 Dec  6 15:36 kube-admin.pem</span><br><span class="line">-r-------- 1 root root 1675 Dec  6 15:36 kube-apiserver-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1688 Dec  6 15:36 kube-apiserver.pem</span><br><span class="line">-r-------- 1 root root 1679 Dec  6 15:36 kube-ca-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1387 Dec  6 15:36 kube-ca.pem</span><br><span class="line">-r-------- 1 root root 1679 Dec  6 15:36 kube-controller-manager-key.pem</span><br><span class="line">-r--r--r-- 1 root root 6449 Dec  6 15:36 kube-controller-manager.kubeconfig</span><br><span class="line">-r--r--r-- 1 root root 1476 Dec  6 15:36 kube-controller-manager.pem</span><br><span class="line">-r-------- 1 root root 1675 Dec  6 15:36 kube-proxy-key.pem</span><br><span class="line">-r--r--r-- 1 root root 6371 Dec  6 15:36 kube-proxy.kubeconfig</span><br><span class="line">-r--r--r-- 1 root root 1440 Dec  6 15:36 kube-proxy.pem</span><br><span class="line">-r-------- 1 root root 1675 Dec  6 15:36 kube-scheduler-key.pem</span><br><span class="line">-r--r--r-- 1 root root 6395 Dec  6 15:36 kube-scheduler.kubeconfig</span><br><span class="line">-r--r--r-- 1 root root 1452 Dec  6 15:36 kube-scheduler.pem</span><br><span class="line">-r-------- 1 root root 1675 Dec  6 15:36 sa-key.pem</span><br><span class="line">-r--r--r-- 1 root root 1432 Dec  6 15:36 sa.pem</span><br><span class="line">-r--r--r-- 1 root root   80 Dec  6 15:36 token.csv</span><br></pre></td></tr></table></figure><h1 id="kubernetes-master节点"><a href="#kubernetes-master节点" class="headerlink" title="kubernetes-master节点"></a>kubernetes-master节点</h1><p>本节介绍如何部署kubernetes master节点</p><h2 id="master节点说明"><a href="#master节点说明" class="headerlink" title="master节点说明"></a><strong>master节点说明</strong></h2><blockquote><ul><li>原则上，master节点不应该运行业务Pod，且不应该暴露到公网环境！！</li><li>边界节点，应该交由<code>worker</code>节点或者运行<code>Ingress</code>的节点来承担</li><li>以<code>kubeadm</code>部署为例，部署完成后，会给master节点添加<code>node-role.kubernetes.io/master=&#39;&#39;</code>标签（Labels）并且会对带有此标签的节点添加<code>node-role.kubernetes.io/master:NoSchedule</code>污点（taints），这样不能容忍此污点的Pod无法调度到master节点</li><li>本文中，在kubelet启动参数里，默认添加<code>node-role.kubernetes.io/node=&#39;&#39;</code>标签（Labels），且没有对master节点添加<code>node-role.kubernetes.io/master:NoSchedule</code>污点（taints）</li><li>生产环境中最好参照kubeadm，对master节点添加<code>node-role.kubernetes.io/master=&#39;&#39;</code>标签（Labels）和<code>node-role.kubernetes.io/master:NoSchedule</code>污点（taints）</li></ul></blockquote><p><strong>kube-apiserver</strong></p><blockquote><ul><li>以 REST APIs 提供 Kubernetes 资源的 CRUD,如授权、认证、存取控制与 API 注册等机制。</li><li>关闭默认非安全端口8080,在安全端口 6443 接收 https 请求</li><li>严格的认证和授权策略 (x509、token、RBAC)</li><li>开启 bootstrap token 认证，支持 kubelet TLS bootstrapping</li><li>使用 https 访问 kubelet、etcd，加密通信</li></ul></blockquote><p><strong>kube-controller-manager</strong></p><blockquote><ul><li>通过核心控制循环(Core Control Loop)监听 Kubernetes API<br>的资源来维护集群的状态，这些资源会被不同的控制器所管理，如 Replication Controller、Namespace<br>Controller 等等。而这些控制器会处理着自动扩展、滚动更新等等功能。</li><li>关闭非安全端口，在安全端口 10252 接收 https 请求</li><li>使用 kubeconfig 访问 kube-apiserver 的安全端口</li></ul></blockquote><p><strong>kube-scheduler</strong></p><blockquote><ul><li>负责将一个(或多个)容器依据调度策略分配到对应节点上让容器引擎(如 Docker)执行。</li><li>调度受到 QoS 要求、软硬性约束、亲和性(Affinity)等等因素影响。</li></ul></blockquote><p><strong>HAProxy</strong></p><blockquote><ul><li>提供多个 API Server 的负载均衡(Load Balance)</li><li>监听VIP的<code>8443</code>端口负载均衡到三台master节点的<code>6443</code>端口</li></ul></blockquote><p><strong>Keepalived</strong></p><blockquote><ul><li>提供虚拟IP位址(VIP),来让vip落在可用的master主机上供所有组件访问master节点</li><li>提供健康检查脚本用于切换VIP</li></ul></blockquote><h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><blockquote><ul><li>这里强迫症发作，指定了<code>UID</code>和<code>GID</code></li><li>不指定<code>UID</code>和<code>GID</code>也可以</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- master节点添加用户 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/sbin/groupadd -r -g 10000 kube</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/sbin/groupadd -r -g 10001 etcd</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/sbin/useradd -r -g kube -u 10000 -s /bin/false kube</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/sbin/useradd -r -g etcd -u 10001 -s /bin/false etcd</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">echo '--- master节点创建目录 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    echo "--- 创建目录 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/bin/mkdir -p /etc/etcd/ssl \</span><br><span class="line">                                  /etc/kubernetes/pki \</span><br><span class="line">                                  /etc/kubernetes/manifests \</span><br><span class="line">                                  /var/lib/etcd \</span><br><span class="line">                                  /var/lib/kubelet \</span><br><span class="line">                                  /var/run/kubernetes \</span><br><span class="line">                                  /var/log/kube-audit \</span><br><span class="line">                                  /etc/cni/net.d \</span><br><span class="line">                                  /opt/cni/bin </span><br><span class="line">    echo "--- 修改目录权限 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; /usr/bin/chmod 0755 /etc/etcd \</span><br><span class="line">                                    /etc/etcd/ssl \</span><br><span class="line">                                    /etc/kubernetes \</span><br><span class="line">                                    /etc/kubernetes/pki \</span><br><span class="line">                                    /var/lib/etcd \</span><br><span class="line">                                    /var/lib/kubelet \</span><br><span class="line">                                    /var/log/kube-audit \</span><br><span class="line">                                    /var/run/kubernetes \</span><br><span class="line">                                    /etc/cni/net.d \</span><br><span class="line">                                    /opt/cni/bin </span><br><span class="line">    echo "--- 修改目录属组 ---"</span><br><span class="line">    ssh $&#123;NODE&#125; chown -R etcd:etcd /etc/etcd/ /var/lib/etcd</span><br><span class="line">    ssh $&#123;NODE&#125; chown -R kube:kube /etc/kubernetes \</span><br><span class="line">                                   /var/lib/kubelet \</span><br><span class="line">                                   /var/log/kube-audit \</span><br><span class="line">                                   /var/run/kubernetes</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="分发证书文件和kubeconfig到master节点"><a href="#分发证书文件和kubeconfig到master节点" class="headerlink" title="分发证书文件和kubeconfig到master节点"></a>分发证书文件和kubeconfig到master节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">    echo '---- 分发etcd证书 ----'</span><br><span class="line">    rsync -avpt /root/pki/etcd-ca-key.pem \</span><br><span class="line">                /root/pki/etcd-ca.pem \</span><br><span class="line">                /root/pki/etcd-client-key.pem \</span><br><span class="line">                /root/pki/etcd-client.pem \</span><br><span class="line">                /root/pki/etcd-server-key.pem \</span><br><span class="line">                /root/pki/etcd-server.pem \</span><br><span class="line">                $NODE:/etc/etcd/ssl/</span><br><span class="line">    echo '---- 分发kubeconfig文件 yaml文件 token.csv ----'</span><br><span class="line">    rsync -avpt /root/pki/kube-admin.kubeconfig \</span><br><span class="line">                /root/pki/kube-controller-manager.kubeconfig \</span><br><span class="line">                /root/pki/kube-scheduler.kubeconfig \</span><br><span class="line">                /root/pki/audit-policy.yaml \</span><br><span class="line">                /root/pki/encryption.yaml \</span><br><span class="line">                /root/pki/token.csv \</span><br><span class="line">                $NODE:/etc/kubernetes/</span><br><span class="line">    echo '---- 分发sa证书 kube证书 front-proxy证书 ----'</span><br><span class="line">    rsync -avpt /root/pki/etcd-ca.pem \</span><br><span class="line">                /root/pki/etcd-client-key.pem \</span><br><span class="line">                /root/pki/etcd-client.pem \</span><br><span class="line">                /root/pki/front-proxy-ca.pem \</span><br><span class="line">                /root/pki/front-proxy-client-key.pem \</span><br><span class="line">                /root/pki/front-proxy-client.pem \</span><br><span class="line">                /root/pki/kube-apiserver-key.pem \</span><br><span class="line">                /root/pki/kube-apiserver.pem \</span><br><span class="line">                /root/pki/kube-ca.pem \</span><br><span class="line">                /root/pki/kube-ca-key.pem \</span><br><span class="line">                /root/pki/sa-key.pem \</span><br><span class="line">                /root/pki/sa.pem \</span><br><span class="line">                $NODE:/etc/kubernetes/pki/</span><br><span class="line">    ssh $NODE chown -R etcd:etcd /etc/etcd</span><br><span class="line">    ssh $NODE chown -R kube:kube /etc/kubernetes</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="分发二进制文件"><a href="#分发二进制文件" class="headerlink" title="分发二进制文件"></a>分发二进制文件</h2><blockquote><ul><li>在<font color="red" size="3">k8s-m1</font>上操作</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 分发kubernetes和etcd二进制文件 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    rsync -avpt /root/software/kubernetes/server/bin/hyperkube \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-controller-manager \</span><br><span class="line">                /root/software/kubernetes/server/bin/kubectl \</span><br><span class="line">                /root/software/kubernetes/server/bin/apiextensions-apiserver \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-apiserver \</span><br><span class="line">                /root/software/kubernetes/server/bin/kubeadm \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-aggregator \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-scheduler \</span><br><span class="line">                /root/software/kubernetes/server/bin/cloud-controller-manager \</span><br><span class="line">                /root/software/kubernetes/server/bin/mounter \</span><br><span class="line">                /root/software/etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcdctl \</span><br><span class="line">                /root/software/etcd-$&#123;ETCD_VERSION&#125;-linux-amd64/etcd \</span><br><span class="line">                $NODE:/usr/local/bin/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="部署配置Keepalived和HAProxy"><a href="#部署配置Keepalived和HAProxy" class="headerlink" title="部署配置Keepalived和HAProxy"></a>部署配置Keepalived和HAProxy</h2><blockquote><ul><li>在<font color="red" size="3">k8s-m1</font>上操作</li></ul></blockquote><h3 id="切换工作目录"><a href="#切换工作目录" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/master</span><br></pre></td></tr></table></figure><h3 id="安装Keepalived和HAProxy"><a href="#安装Keepalived和HAProxy" class="headerlink" title="安装Keepalived和HAProxy"></a>安装Keepalived和HAProxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">    echo "---- 安装haproxy和keepalived ----"</span><br><span class="line">    ssh $NODE yum install keepalived haproxy -y</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h3><blockquote><ul><li>编辑<code>keepalived.conf</code>模板</li><li>替换<code>keepalived.conf</code>的字符串</li><li>编辑<code>check_haproxy.sh</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; keepalived.conf.example &lt;&lt;EOF</span><br><span class="line">vrrp_script haproxy-check &#123;</span><br><span class="line">    script "/bin/bash /etc/keepalived/check_haproxy.sh"</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance haproxy-vip &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 101</span><br><span class="line">    interface &#123;&#123; VIP_IFACE &#125;&#125;</span><br><span class="line">    virtual_router_id 47</span><br><span class="line">    advert_int 3</span><br><span class="line"></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        &#123;&#123; VIP &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        haproxy-check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换字符</span></span><br><span class="line">sed -r -e "s#\&#123;\&#123; VIP \&#125;\&#125;#$&#123;VIP&#125;#" \</span><br><span class="line">       -e "s#\&#123;\&#123; VIP_IFACE \&#125;\&#125;#$&#123;VIP_IFACE&#125;#" \</span><br><span class="line">       -e '/unicast_peer/r '&lt;(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#^#\t#') \</span><br><span class="line">       keepalived.conf.example &gt; keepalived.conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; check_haproxy.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">VIRTUAL_IP=$&#123;VIP&#125;</span><br><span class="line"></span><br><span class="line">errorExit() &#123;</span><br><span class="line">    echo "*** $*" 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ip addr | grep -q \$VIRTUAL_IP ; then</span><br><span class="line">    curl -s --max-time 2 --insecure https://\$&#123;VIRTUAL_IP&#125;:8443/ -o /dev/null || errorExit "Error GET https://\$&#123;VIRTUAL_IP&#125;:8443/"</span><br><span class="line">fi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置haproxy"><a href="#配置haproxy" class="headerlink" title="配置haproxy"></a>配置haproxy</h3><blockquote><ul><li>编辑<code>haproxy.cfg</code>模板</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; haproxy.cfg.example &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  ulimit-n  16384</span><br><span class="line">  log  127.0.0.1 local0 err</span><br><span class="line">  stats timeout 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  log global</span><br><span class="line">  mode  http</span><br><span class="line">  option  httplog</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  timeout http-request 15s</span><br><span class="line">  timeout http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">frontend monitor-in</span><br><span class="line">  bind $&#123;VIP&#125;:33305</span><br><span class="line">  mode http</span><br><span class="line">  option httplog</span><br><span class="line">  monitor-uri /monitor</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">  bind    $&#123;VIP&#125;:8006</span><br><span class="line">  mode    http</span><br><span class="line">  stats   enable</span><br><span class="line">  stats   hide-version</span><br><span class="line">  stats   uri       /stats</span><br><span class="line">  stats   refresh   30s</span><br><span class="line">  stats   realm     Haproxy\ Statistics</span><br><span class="line">  stats   auth      admin:admin</span><br><span class="line"></span><br><span class="line">frontend k8s-api</span><br><span class="line">  bind $&#123;VIP&#125;:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-api</span><br><span class="line"></span><br><span class="line">backend k8s-api</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换字符</span></span><br><span class="line">sed -e '$r '&lt;(paste &lt;( seq -f'  server k8s-api-%g'  $&#123;#MasterArray[@]&#125; ) &lt;( xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#$#:6443  check#')) haproxy.cfg.example &gt; haproxy.cfg</span><br></pre></td></tr></table></figure><h3 id="分发配置文件到master节点"><a href="#分发配置文件到master节点" class="headerlink" title="分发配置文件到master节点"></a>分发配置文件到master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">rsync -avpt haproxy.cfg $NODE:/etc/haproxy/</span><br><span class="line">rsync -avpt keepalived.conf \</span><br><span class="line">            check_haproxy.sh \</span><br><span class="line">            $NODE:/etc/keepalived/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="启动keepalived和haproxy"><a href="#启动keepalived和haproxy" class="headerlink" title="启动keepalived和haproxy"></a>启动keepalived和haproxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">ssh $NODE systemctl enable --now keepalived haproxy</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="验证VIP"><a href="#验证VIP" class="headerlink" title="验证VIP"></a>验证VIP</h3><blockquote><ul><li>需要大约十秒的时间等待keepalived和haproxy服务起来</li><li>这里由于后端的kube-apiserver服务还没启动，只测试是否能ping通VIP</li><li>如果VIP没起来，就要去确认一下各master节点的keepalived服务是否正常</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sleep 15</span><br><span class="line">ping -c 4 $VIP</span><br></pre></td></tr></table></figure><h2 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h2><blockquote><ul><li>每个etcd节点的配置都需要做对应更改</li><li>在<font color="red" size="3">k8s-m1</font>上操作</li></ul></blockquote><h3 id="配置etcd-service文件"><a href="#配置etcd-service文件" class="headerlink" title="配置etcd.service文件"></a>配置etcd.service文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=etcd</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yaml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="etcd-config-yaml模板"><a href="#etcd-config-yaml模板" class="headerlink" title="etcd.config.yaml模板"></a>etcd.config.yaml模板</h3><blockquote><ul><li>关于各个参数的说明可以看<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/configuration.md" target="_blank" rel="noopener">这里</a></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd.config.yaml.example &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> This is the configuration file <span class="keyword">for</span> the etcd server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Human-readable name <span class="keyword">for</span> this member.</span></span><br><span class="line">name: '&#123;HOSTNAME&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Path to the data directory.</span></span><br><span class="line">data-dir: '/var/lib/etcd/&#123;HOSTNAME&#125;.data/'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Path to the dedicated wal directory.</span></span><br><span class="line">wal-dir: '/var/lib/etcd/&#123;HOSTNAME&#125;.wal/'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Number of committed transactions to trigger a snapshot to disk.</span></span><br><span class="line">snapshot-count: 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) of a heartbeat interval.</span></span><br><span class="line">heartbeat-interval: 100</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> an election to timeout.</span></span><br><span class="line">election-timeout: 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Raise alarms when backend size exceeds the given quota. 0 means use the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default quota.</span></span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of comma separated URLs to listen on <span class="keyword">for</span> peer traffic.</span></span><br><span class="line">listen-peer-urls: 'https://&#123;PUBLIC_IP&#125;:2380'</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of comma separated URLs to listen on <span class="keyword">for</span> client traffic.</span></span><br><span class="line">listen-client-urls: 'https://&#123;PUBLIC_IP&#125;:2379,http://127.0.0.1:2379'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maximum number of snapshot files to retain (0 is unlimited).</span></span><br><span class="line">max-snapshots: 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> Maximum number of wal files to retain (0 is unlimited).</span></span><br><span class="line">max-wals: 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> Comma-separated white list of origins <span class="keyword">for</span> CORS (cross-origin resource sharing).</span></span><br><span class="line">cors:</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of this member<span class="string">'s peer URLs to advertise to the rest of the cluster.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The URLs needed to be a comma-separated list.</span></span><br><span class="line">initial-advertise-peer-urls: 'https://&#123;PUBLIC_IP&#125;:2380'</span><br><span class="line"><span class="meta">#</span><span class="bash"> List of this member<span class="string">'s client URLs to advertise to the public.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The URLs needed to be a comma-separated list.</span></span><br><span class="line">advertise-client-urls: 'https://&#123;PUBLIC_IP&#125;:2379'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Discovery URL used to bootstrap the cluster.</span></span><br><span class="line">discovery:</span><br><span class="line"><span class="meta">#</span><span class="bash"> Valid values include <span class="string">'exit'</span>, <span class="string">'proxy'</span></span></span><br><span class="line">discovery-fallback: 'proxy'</span><br><span class="line"><span class="meta">#</span><span class="bash"> HTTP proxy to use <span class="keyword">for</span> traffic to discovery service.</span></span><br><span class="line">discovery-proxy:</span><br><span class="line"><span class="meta">#</span><span class="bash"> DNS domain used to bootstrap initial cluster.</span></span><br><span class="line">discovery-srv:</span><br><span class="line"><span class="meta">#</span><span class="bash"> Initial cluster configuration <span class="keyword">for</span> bootstrapping.</span></span><br><span class="line">initial-cluster: '$&#123;ETCD_INITIAL_CLUSTER&#125;'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Initial cluster token <span class="keyword">for</span> the etcd cluster during bootstrap.</span></span><br><span class="line">initial-cluster-token: 'etcd-k8s-cluster'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Initial cluster state (<span class="string">'new'</span> or <span class="string">'existing'</span>).</span></span><br><span class="line">initial-cluster-state: 'new'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Reject reconfiguration requests that would cause quorum loss.</span></span><br><span class="line">strict-reconfig-check: false</span><br><span class="line"><span class="meta">#</span><span class="bash"> Accept etcd V2 client requests</span></span><br><span class="line">enable-v2: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> Enable runtime profiling data via HTTP server</span></span><br><span class="line">enable-pprof: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> Valid values include <span class="string">'on'</span>, <span class="string">'readonly'</span>, <span class="string">'off'</span></span></span><br><span class="line">proxy: 'off'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) an endpoint will be held <span class="keyword">in</span> a failed state.</span></span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) of the endpoints refresh interval.</span></span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> a dial to timeout.</span></span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> a write to timeout.</span></span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Time (<span class="keyword">in</span> milliseconds) <span class="keyword">for</span> a <span class="built_in">read</span> to timeout.</span></span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the client server TLS cert file.</span></span><br><span class="line">  cert-file: '/etc/etcd/ssl/etcd-server.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the client server TLS key file.</span></span><br><span class="line">  key-file: '/etc/etcd/ssl/etcd-server-key.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Enable client cert authentication.</span></span><br><span class="line">  client-cert-auth: true</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the client server TLS trusted CA cert file.</span></span><br><span class="line">  trusted-ca-file: '/etc/etcd/ssl/etcd-ca.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Client TLS using generated certificates</span></span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the peer server TLS cert file.</span></span><br><span class="line">  cert-file: '/etc/etcd/ssl/etcd-server.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the peer server TLS key file.</span></span><br><span class="line">  key-file: '/etc/etcd/ssl/etcd-server-key.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Enable peer client cert authentication.</span></span><br><span class="line">  client-cert-auth: true</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Path to the peer server TLS trusted CA cert file.</span></span><br><span class="line">  trusted-ca-file: '/etc/etcd/ssl/etcd-ca.pem'</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Peer TLS using generated certificates.</span></span><br><span class="line">  auto-tls: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> Enable debug-level logging <span class="keyword">for</span> etcd.</span></span><br><span class="line">debug: false</span><br><span class="line">logger: 'zap'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify <span class="string">'stdout'</span> or <span class="string">'stderr'</span> to skip journald logging even when running under systemd.</span></span><br><span class="line">log-outputs: [default]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Force to create a new one member cluster.</span></span><br><span class="line">force-new-cluster: false</span><br><span class="line">auto-compaction-mode: 'periodic'</span><br><span class="line">auto-compaction-retention: '1'</span><br><span class="line"><span class="meta">#</span><span class="bash"> Set level of detail <span class="keyword">for</span> exported metrics, specify <span class="string">'extensive'</span> to include histogram metrics.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default is <span class="string">'basic'</span></span></span><br><span class="line">metrics: 'basic'</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="分发配置文件"><a href="#分发配置文件" class="headerlink" title="分发配置文件"></a>分发配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 根据节点信息替换文本，分发到各etcd节点</span></span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    sed -e "s/&#123;HOSTNAME&#125;/$NODE/g" \</span><br><span class="line">        -e "s/&#123;PUBLIC_IP&#125;/$&#123;MasterArray[$NODE]&#125;/g" \</span><br><span class="line">        etcd.config.yaml.example &gt; etcd.config.yaml.$&#123;NODE&#125;</span><br><span class="line">    rsync -avpt etcd.config.yaml.$&#123;NODE&#125; $&#123;NODE&#125;:/etc/etcd/etcd.config.yaml</span><br><span class="line">    rsync -avpt etcd.service $&#123;NODE&#125;:/usr/lib/systemd/system/etcd.service</span><br><span class="line">    ssh $&#123;NODE&#125; systemctl daemon-reload</span><br><span class="line">    ssh $&#123;NODE&#125; chown -R etcd:etcd /etc/etcd</span><br><span class="line">    rm -rf etcd.config.yaml.$&#123;NODE&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="启动etcd集群"><a href="#启动etcd集群" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h3><blockquote><ul><li>etcd 进程首次启动时会等待其它节点的 etcd 加入集群，命令 systemctl start etcd 会卡住一段时间，为正常现象</li><li>启动之后可以通过<code>etcdctl</code>命令查看集群状态</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE systemctl enable etcd</span><br><span class="line">    ssh $NODE systemctl start etcd &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><blockquote><ul><li>为方便维护，可使用alias简化etcdctl命令</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /root/.bashrc &lt;&lt;EOF</span><br><span class="line">alias etcdctl2="export ETCDCTL_API=2;etcdctl --ca-file '/etc/etcd/ssl/etcd-ca.pem' --cert-file '/etc/etcd/ssl/etcd-client.pem' --key-file '/etc/etcd/ssl/etcd-client-key.pem' --endpoints $&#123;ETCD_SERVERS&#125;"</span><br><span class="line">alias etcdctl3="export ETCDCTL_API=3;etcdctl --cacert=/etc/etcd/ssl/etcd-ca.pem --cert=/etc/etcd/ssl/etcd-client.pem --key=/etc/etcd/ssl/etcd-client-key.pem --endpoints=$&#123;ETCD_SERVERS&#125;"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="验证etcd集群状态"><a href="#验证etcd集群状态" class="headerlink" title="验证etcd集群状态"></a>验证etcd集群状态</h3><blockquote><ul><li>etcd提供v2和v3两套API，kubernetes使用v3</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 应用上面定义的<span class="built_in">alias</span></span></span><br><span class="line">source /root/.bashrc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用v2 API访问etcd的集群状态</span></span><br><span class="line">etcdctl2 cluster-health</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">member 222fd3b0bb4a5931 is healthy: got healthy result from https://172.16.80.203:2379</span><br><span class="line">member 8349ef180b115a83 is healthy: got healthy result from https://172.16.80.201:2379</span><br><span class="line">member f525d2d797a7c465 is healthy: got healthy result from https://172.16.80.202:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用v2 API访问etcd成员列表</span></span><br><span class="line">etcdctl2 member list</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">222fd3b0bb4a5931: name=k8s-m3 peerURLs=https://172.16.80.203:2380 clientURLs=https://172.16.80.203:2379 isLeader=false</span><br><span class="line">8349ef180b115a83: name=k8s-m1 peerURLs=https://172.16.80.201:2380 clientURLs=https://172.16.80.201:2379 isLeader=false</span><br><span class="line">f525d2d797a7c465: name=k8s-m2 peerURLs=https://172.16.80.202:2380 clientURLs=https://172.16.80.202:2379 isLeader=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用v3 API访问etcd的endpoint状态</span></span><br><span class="line">etcdctl3 endpoint health</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">https://172.16.80.201:2379 is healthy: successfully committed proposal: took = 2.879402ms</span><br><span class="line">https://172.16.80.203:2379 is healthy: successfully committed proposal: took = 6.708566ms</span><br><span class="line">https://172.16.80.202:2379 is healthy: successfully committed proposal: took = 7.187607ms</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用v3 API访问etcd成员列表</span></span><br><span class="line">etcdctl3 member list --write-out=table</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+</span><br><span class="line">|        ID        | STATUS  |  NAME  |         PEER ADDRS         |        CLIENT ADDRS        |</span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+</span><br><span class="line">| 222fd3b0bb4a5931 | started | k8s-m3 | https://172.16.80.203:2380 | https://172.16.80.203:2379 |</span><br><span class="line">| 8349ef180b115a83 | started | k8s-m1 | https://172.16.80.201:2380 | https://172.16.80.201:2379 |</span><br><span class="line">| f525d2d797a7c465 | started | k8s-m2 | https://172.16.80.202:2380 | https://172.16.80.202:2379 |</span><br><span class="line">+------------------+---------+--------+----------------------------+----------------------------+</span><br></pre></td></tr></table></figure><h2 id="Master组件服务"><a href="#Master组件服务" class="headerlink" title="Master组件服务"></a>Master组件服务</h2><h3 id="master组件配置模板"><a href="#master组件配置模板" class="headerlink" title="master组件配置模板"></a>master组件配置模板</h3><h4 id="kube-apiserver-conf"><a href="#kube-apiserver-conf" class="headerlink" title="kube-apiserver.conf"></a>kube-apiserver.conf</h4><blockquote><ul><li><p><code>--allow-privileged=true</code>启用容器特权模式</p></li><li><p><code>--apiserver-count=3</code>指定集群运行模式，其它节点处于阻塞状态</p></li><li><p><code>--audit-policy-file=/etc/kubernetes/audit-policy.yaml</code> 基于audit-policy.yaml文件定义的内容启动审计功能</p></li><li><p><code>--authorization-mode=Node,RBAC</code>开启 Node 和 RBAC 授权模式，拒绝未授权的请求</p></li><li><p><code>--disable-admission-plugins=</code>和<code>--enable-admission-plugins</code>禁用和启用准入控制插件。</p></li></ul><p>准入控制插件会在请求通过认证和授权之后、对象被持久化之前拦截到达apiserver的请求。</p><p>准入控制插件依次执行，因此需要注意顺序。</p><p>如果插件序列中任何一个拒绝了请求，则整个请求将立刻被拒绝并返回错误给客户端。</p><p>关于admission-plugins官方文档里面有推荐配置，这里直接采用官方配置，注意针对不同kubernetes版本都会有不一样的配置，具体可以看<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#is-there-a-recommended-set-of-admission-controllers-to-use" target="_blank" rel="noopener">这里</a></p><ul><li><code>--enable-bootstrap-token-auth=true</code>启用 kubelet bootstrap 的 token 认证</li><li><code>--experimental-encryption-provider-config=/etc/kubernetes/encryption.yaml</code>启用加密特性将Secret数据加密存储到etcd</li><li><code>--insecure-port=0</code>关闭监听非安全端口8080</li><li><code>--runtime-config=api/all=true</code>启用所有版本的 APIs</li><li><code>--service-cluster-ip-range=10.96.0.0/12</code>指定 Service Cluster IP 地址段</li><li><code>--service-node-port-range=30000-32767</code>指定 NodePort 的端口范围</li><li><code>--token-auth-file=/etc/kubernetes/token.csv</code>保存bootstrap的token信息</li><li><code>--target-ram-mb</code>配置缓存大小，参考值为<code>节点数*60</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_APISERVER_ARGS=" \\</span><br><span class="line">--advertise-address=&#123;PUBLIC_IP&#125;  \\</span><br><span class="line">--allow-privileged=true  \\</span><br><span class="line">--apiserver-count=3 \\</span><br><span class="line">--audit-log-maxage=30  \\</span><br><span class="line">--audit-log-maxbackup=3  \\</span><br><span class="line">--audit-log-maxsize=1000  \\</span><br><span class="line">--audit-log-path=/var/log/kube-audit/audit.log  \\</span><br><span class="line">--audit-policy-file=/etc/kubernetes/audit-policy.yaml  \\</span><br><span class="line">--authorization-mode=Node,RBAC  \\</span><br><span class="line">--bind-address=0.0.0.0 \\</span><br><span class="line">--client-ca-file=/etc/kubernetes/pki/kube-ca.pem  \\</span><br><span class="line">--disable-admission-plugins=PersistentVolumeLabel \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,PodPreset  \\</span><br><span class="line">--enable-aggregator-routing=true \\</span><br><span class="line">--enable-bootstrap-token-auth=true  \\</span><br><span class="line">--enable-garbage-collector=true \\</span><br><span class="line">--etcd-compaction-interval=1h \\</span><br><span class="line">--etcd-cafile=/etc/kubernetes/pki/etcd-ca.pem  \\</span><br><span class="line">--etcd-certfile=/etc/kubernetes/pki/etcd-client.pem  \\</span><br><span class="line">--etcd-keyfile=/etc/kubernetes/pki/etcd-client-key.pem  \\</span><br><span class="line">--etcd-servers=$ETCD_SERVERS  \\</span><br><span class="line">--experimental-encryption-provider-config=/etc/kubernetes/encryption.yaml  \\</span><br><span class="line">--event-ttl=1h  \\</span><br><span class="line">--feature-gates=PodShareProcessNamespace=true,ExpandPersistentVolumes=true \\</span><br><span class="line">--insecure-port=0  \\</span><br><span class="line">--kubelet-client-certificate=/etc/kubernetes/pki/kube-apiserver.pem  \\</span><br><span class="line">--kubelet-client-key=/etc/kubernetes/pki/kube-apiserver-key.pem  \\</span><br><span class="line">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">--logtostderr=true  \\</span><br><span class="line">--max-mutating-requests-inflight=500  \\</span><br><span class="line">--max-requests-inflight=1500  \\</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">--requestheader-allowed-names=aggregator  \\</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">--requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">--requestheader-username-headers=X-Remote-User  \\</span><br><span class="line">--runtime-config=api/all=true  \\</span><br><span class="line">--secure-port=6443  \\</span><br><span class="line">--service-account-key-file=/etc/kubernetes/pki/sa.pem  \\</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/12  \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--storage-backend=etcd3 \\</span><br><span class="line">--target-ram-mb=300 \\</span><br><span class="line">--tls-cert-file=/etc/kubernetes/pki/kube-apiserver.pem  \\</span><br><span class="line">--tls-private-key-file=/etc/kubernetes/pki/kube-apiserver-key.pem  \\</span><br><span class="line">--token-auth-file=/etc/kubernetes/token.csv \\</span><br><span class="line">--v=2  \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="kube-controller-manager-conf"><a href="#kube-controller-manager-conf" class="headerlink" title="kube-controller-manager.conf"></a>kube-controller-manager.conf</h4><blockquote><ul><li><code>--allocate-node-cidrs=true</code>在cloud provider上分配和设置pod的CIDR</li><li><code>--cluster-cidr</code>集群内的pod的CIDR范围，需要 <code>--allocate-node-cidrs</code>设为true</li><li><code>--experimental-cluster-signing-duration=8670h0m0s</code>指定 TLS Bootstrap 证书的有效期</li><li><code>--feature-gates=RotateKubeletServerCertificate=true</code>开启 kublet server 证书的自动更新特性</li><li><code>--horizontal-pod-autoscaler-use-rest-clients=true</code>能够使用自定义资源（Custom Metrics）进行自动水平扩展</li><li><code>--leader-elect=true</code>集群运行模式，启用选举功能，被选为 leader 的节点负责处理工作，其它节点为阻塞状态</li><li><code>--node-cidr-mask-size=24</code>集群中node cidr的掩码</li><li><code>--service-cluster-ip-range=10.96.0.0/16</code>指定 Service Cluster IP 网段，必须和 kube-apiserver 中的同名参数一致</li><li><code>--terminated-pod-gc-threshold</code>exit状态的pod超过多少会触发gc</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-controller-manager.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=" \\</span><br><span class="line">--address=0.0.0.0 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=$POD_NET_CIDR \\</span><br><span class="line">--cluster-signing-cert-file=/etc/kubernetes/pki/kube-ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/etc/kubernetes/pki/kube-ca-key.pem \\</span><br><span class="line">--concurrent-service-syncs=10 \\</span><br><span class="line">--concurrent-serviceaccount-token-syncs=20 \\</span><br><span class="line">--controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">--enable-garbage-collector=true \\</span><br><span class="line">--experimental-cluster-signing-duration=8670h0m0s \\</span><br><span class="line">--feature-gates=RotateKubeletServerCertificate=true,ExpandPersistentVolumes=true \\</span><br><span class="line">--horizontal-pod-autoscaler-sync-period=10s \\</span><br><span class="line">--horizontal-pod-autoscaler-use-rest-clients=true \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--node-cidr-mask-size=24 \\</span><br><span class="line">--node-monitor-grace-period=40s \\</span><br><span class="line">--node-monitor-period=5s \\</span><br><span class="line">--pod-eviction-timeout=2m0s \\</span><br><span class="line">--root-ca-file=/etc/kubernetes/pki/kube-ca.pem \\</span><br><span class="line">--service-account-private-key-file=/etc/kubernetes/pki/sa-key.pem \\</span><br><span class="line">--service-cluster-ip-range=$SVC_CLUSTER_CIDR \\</span><br><span class="line">--terminated-pod-gc-threshold=12500 \\</span><br><span class="line">--use-service-account-credentials=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="kube-scheduler-conf"><a href="#kube-scheduler-conf" class="headerlink" title="kube-scheduler.conf"></a>kube-scheduler.conf</h4><blockquote><ul><li><code>--leader-elect=true</code>集群运行模式，启用选举功能，被选为 leader 的节点负责处理工作，其它节点为阻塞状态</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_SCHEDULER_ARGS="\\</span><br><span class="line">--address=0.0.0.0 \\</span><br><span class="line">--algorithm-provider=DefaultProvider \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="systemd服务文件"><a href="#systemd服务文件" class="headerlink" title="systemd服务文件"></a>systemd服务文件</h3><h4 id="kube-apiserver-service"><a href="#kube-apiserver-service" class="headerlink" title="kube-apiserver.service"></a>kube-apiserver.service</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">After=etcd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \$KUBE_APISERVER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="kube-controller-manager-service"><a href="#kube-controller-manager-service" class="headerlink" title="kube-controller-manager.service"></a>kube-controller-manager.service</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-controller-manager.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="kube-scheduler-service"><a href="#kube-scheduler-service" class="headerlink" title="kube-scheduler.service"></a>kube-scheduler.service</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \$KUBE_SCHEDULER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="分发配置文件到各master节点"><a href="#分发配置文件到各master节点" class="headerlink" title="分发配置文件到各master节点"></a>分发配置文件到各master节点</h3><blockquote><ul><li>根据master节点的信息替换配置文件里面的字段</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    rsync -avpt kube*service $NODE:/usr/lib/systemd/system/</span><br><span class="line">    sed -e "s/&#123;PUBLIC_IP&#125;/$&#123;MasterArray[$NODE]&#125;/g" kube-apiserver.conf.example &gt; kube-apiserver.conf.$&#123;NODE&#125;</span><br><span class="line">    rsync -avpt kube-apiserver.conf.$&#123;NODE&#125; $NODE:/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">    rsync -avpt kube-controller-manager.conf.example $NODE:/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">    rsync -avpt kube-scheduler.conf.example $NODE:/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">    rm -rf *conf.$&#123;NODE&#125;</span><br><span class="line">    ssh $NODE systemctl daemon-reload</span><br><span class="line">    ssh $NODE chown -R kube:kube /etc/kubernetes</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="启动kubernetes服务"><a href="#启动kubernetes服务" class="headerlink" title="启动kubernetes服务"></a>启动kubernetes服务</h3><blockquote><ul><li>可以先在<font color="red" size="3">k8s-m1</font>上面启动服务，确认正常之后再在其他master节点启动</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now kube-apiserver.service</span><br><span class="line">systemctl enable --now kube-controller-manager.service</span><br><span class="line">systemctl enable --now kube-scheduler.service</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kube-admin.kubeconfig get cs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;"health":"true"&#125;</span><br><span class="line"></span><br><span class="line">kubectl --kubeconfig=/etc/kubernetes/kube-admin.kubeconfig get endpoints</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME         ENDPOINTS            AGE</span><br><span class="line">kubernetes   172.16.80.201:6443   27s</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE "systemctl enable --now kube-apiserver"</span><br><span class="line">    ssh $NODE "systemctl enable --now kube-controller-manager"</span><br><span class="line">    ssh $NODE "systemctl enable --now kube-scheduler"</span><br><span class="line">done</span><br></pre></td></tr></table></figure><blockquote><ul><li>三台master节点的<code>kube-apiserver</code>、<code>kube-controller-manager</code>、<code>kube-scheduler</code>服务启动成功后可以测试一下</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kube-admin.kubeconfig get endpoints</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME         ENDPOINTS                                                  AGE</span><br><span class="line">kubernetes   172.16.80.201:6443,172.16.80.202:6443,172.16.80.203:6443   12m</span><br></pre></td></tr></table></figure><h3 id="设置kubectl"><a href="#设置kubectl" class="headerlink" title="设置kubectl"></a>设置kubectl</h3><blockquote><ul><li>kubectl命令默认会加载<code>~/.kube/config</code>文件，如果文件不存在则连接<code>http://127.0.0.1:8080</code>，这显然不符合预期，这里使用之前生成的kube-admin.kubeconfig</li><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE mkdir -p /root/.kube</span><br><span class="line">    rsync -avpt /root/pki/kube-admin.kubeconfig $NODE:/root/.kube/config</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="设置命令补全"><a href="#设置命令补全" class="headerlink" title="设置命令补全"></a>设置命令补全</h3><blockquote><ul><li>设置<code>kubectl</code> 命令自动补全</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    echo "--- kubectl命令自动补全 ---"</span><br><span class="line">    ssh $NODE kubectl completion bash &gt;&gt; /etc/bash_completion.d/kubectl</span><br><span class="line">    echo "--- kubeadm命令自动补全 ---"</span><br><span class="line">    ssh $NODE kubeadm completion bash &gt;&gt; /etc/bash_completion.d/kubeadm</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">source /etc/bash_completion.d/kubectl</span><br></pre></td></tr></table></figure><h3 id="设置kubelet的bootstrap启动所需的RBAC"><a href="#设置kubelet的bootstrap启动所需的RBAC" class="headerlink" title="设置kubelet的bootstrap启动所需的RBAC"></a>设置kubelet的bootstrap启动所需的RBAC</h3><blockquote><ul><li><p>当集群开启了 TLS 认证后，每个节点的 kubelet 组件都要使用由 apiserver 使用的 CA 签发的有效证书才能与<br>apiserver 通讯；此时如果节点多起来，为每个节点单独签署证书将是一件非常繁琐的事情；TLS bootstrapping 功能就是让 kubelet 先使用一个预定的低权限用户连接到 apiserver，然后向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署；</p></li><li><p>在其中一个master节点上执行就可以，以<font color="red"><strong>k8s-m1</strong></font>为例</p></li></ul></blockquote><h4 id="创建工作目录-1"><a href="#创建工作目录-1" class="headerlink" title="创建工作目录"></a>创建工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/tls-bootstrap</span><br><span class="line">cd /root/yaml/tls-bootstrap/</span><br></pre></td></tr></table></figure><h4 id="kubelet-bootstrap-rbac-yaml"><a href="#kubelet-bootstrap-rbac-yaml" class="headerlink" title="kubelet-bootstrap-rbac.yaml"></a>kubelet-bootstrap-rbac.yaml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建yaml文件</span></span><br><span class="line">cat &gt; kubelet-bootstrap-rbac.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给予 kubelet-bootstrap 用户进行 node-bootstrapper 的权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubelet-bootstrap</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node-bootstrapper</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: kubelet-bootstrap</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="tls-bootstrap-clusterrole-yaml"><a href="#tls-bootstrap-clusterrole-yaml" class="headerlink" title="tls-bootstrap-clusterrole.yaml"></a>tls-bootstrap-clusterrole.yaml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建yaml文件</span></span><br><span class="line">cat &gt; tls-bootstrap-clusterrole.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> A ClusterRole <span class="built_in">which</span> instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> serving cert matching its client cert.</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: ["certificates.k8s.io"]</span><br><span class="line">  resources: ["certificatesigningrequests/selfnodeserver"]</span><br><span class="line">  verbs: ["create"]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="node-client-auto-approve-csr-yaml"><a href="#node-client-auto-approve-csr-yaml" class="headerlink" title="node-client-auto-approve-csr.yaml"></a>node-client-auto-approve-csr.yaml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建yaml文件</span></span><br><span class="line">cat &gt; node-client-auto-approve-csr.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动批准 system:bootstrappers 组用户 TLS bootstrapping 首次申请证书的 CSR 请求</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-client-auto-approve-csr</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:bootstrappers</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="node-client-auto-renew-crt-yaml"><a href="#node-client-auto-renew-crt-yaml" class="headerlink" title="node-client-auto-renew-crt.yaml"></a>node-client-auto-renew-crt.yaml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建yaml文件</span></span><br><span class="line">cat &gt; node-client-auto-renew-crt.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-client-auto-renew-crt</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:nodes</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="node-server-auto-renew-crt-yaml"><a href="#node-server-auto-renew-crt-yaml" class="headerlink" title="node-server-auto-renew-crt.yaml"></a>node-server-auto-renew-crt.yaml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建yaml文件</span></span><br><span class="line">cat &gt; node-server-auto-renew-crt.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动批准 system:nodes 组用户更新 kubelet 10250 api 端口证书的 CSR 请求</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-server-auto-renew-crt</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:nodes</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建tls-bootstrap-rbac"><a href="#创建tls-bootstrap-rbac" class="headerlink" title="创建tls-bootstrap-rbac"></a>创建tls-bootstrap-rbac</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure><h3 id="设置kube-apiserver获取node信息的权限"><a href="#设置kube-apiserver获取node信息的权限" class="headerlink" title="设置kube-apiserver获取node信息的权限"></a>设置kube-apiserver获取node信息的权限</h3><h4 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h4><p>本文部署的<code>kubelet</code>关闭了匿名访问，因此需要额外为<code>kube-apiserver</code>添加权限用于访问kubelet的信息</p><p>若没添加此<code>RBAC</code>，则<code>kubectl</code>在执行<code>logs</code>、<code>exec</code>等指令的时候会提示<code>401 Forbidden</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system logs calico-node-pc8lq </span><br><span class="line">Error from server (Forbidden): Forbidden (user=kube-apiserver, verb=get, resource=nodes, subresource=proxy) ( pods/log calico-node-pc8lq)</span><br></pre></td></tr></table></figure><p>参考文档：<a href="https://jimmysong.io/kubernetes-handbook/guide/kubelet-authentication-authorization.html" target="_blank" rel="noopener">Kublet的认证授权</a></p><h4 id="创建yaml文件"><a href="#创建yaml文件" class="headerlink" title="创建yaml文件"></a>创建yaml文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/apiserver-to-kubelet-rbac.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: "true"</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - ""</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">    verbs:</span><br><span class="line">      - "*"</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: ""</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kube-apiserver</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure><h1 id="kubernetes-worker节点"><a href="#kubernetes-worker节点" class="headerlink" title="kubernetes worker节点"></a>kubernetes worker节点</h1><h2 id="worker节点说明"><a href="#worker节点说明" class="headerlink" title="worker节点说明"></a><strong>worker节点说明</strong></h2><blockquote><ul><li>安装Docker-ce，配置与master节点一致即可</li><li>安装cni-plugins、kubelet、kube-proxy</li><li>关闭防火墙和SELINUX</li><li>kubelet和kube-proxy运行需要root权限</li><li>这里是以k8s-m1、k8s-m2、k8s-m3作为Work节点加入集群</li></ul></blockquote><p><strong>kubelet</strong></p><blockquote><ul><li>管理容器生命周期、节点状态监控</li><li>目前 kubelet 支持三种数据源来获取节点Pod信息：<ul><li>本地文件</li><li>通过 url 从网络上某个地址来获取信息</li><li>API Server：从 kubernetes master 节点获取信息</li></ul></li><li>使用kubeconfig与kube-apiserver通信</li><li>这里启用<code>TLS-Bootstrap</code>实现kubelet证书动态签署证书，并自动生成kubeconfig</li></ul></blockquote><p><strong>kube-proxy</strong></p><blockquote><ul><li>Kube-proxy是实现Service的关键插件，kube-proxy会在每台节点上执行，然后监听API Server的Service与Endpoint资源物件的改变，然后来依据变化调用相应的组件来实现网路的转发</li><li>kube-proxy可以使用<code>userspace</code>（基本已废弃）、<code>iptables</code>（默认方式）和<code>ipvs</code>来实现数据报文的转发</li><li>这里使用的是性能更好、适合大规模使用的<code>ipvs</code></li><li>使用kubeconfig与kube-apiserver通信</li></ul></blockquote><h2 id="切换工作目录-1"><a href="#切换工作目录-1" class="headerlink" title="切换工作目录"></a>切换工作目录</h2><blockquote><ul><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/worker</span><br></pre></td></tr></table></figure><h2 id="worker组件配置模板"><a href="#worker组件配置模板" class="headerlink" title="worker组件配置模板"></a>worker组件配置模板</h2><h3 id="kubelet-conf"><a href="#kubelet-conf" class="headerlink" title="kubelet.conf"></a>kubelet.conf</h3><blockquote><ul><li><code>--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig</code>指定bootstrap启动时使用的kubeconfig</li><li><code>--network-plugin=cni</code>定义网络插件，Pod生命周期使用此网络插件</li><li><code>--node-labels=node-role.kubernetes.io/node=&#39;&#39;</code>kubelet注册当前Node时设置的Label，以key=value的格式表示，多个labe以逗号分隔</li><li><code>--pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.1</code>Pod的pause镜像</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.conf &lt;&lt;EOF</span><br><span class="line">KUBELET_ARGS=" \\</span><br><span class="line">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \\</span><br><span class="line">--cert-dir=/etc/kubernetes/ssl \\</span><br><span class="line">--config=/etc/kubernetes/kubelet.config.file \\</span><br><span class="line">--cni-conf-dir=/etc/cni/net.d \\</span><br><span class="line">--cni-bin-dir=/opt/cni/bin \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--network-plugin=cni \\</span><br><span class="line">--node-labels=node-role.kubernetes.io/node='' \\</span><br><span class="line">--pod-infra-container-image=gcrxio/pause:3.1 \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kubelet-config-file"><a href="#kubelet-config-file" class="headerlink" title="kubelet.config.file"></a>kubelet.config.file</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.config.file &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">authentication:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 匿名访问</span></span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    # 这里写kubernetes-ca证书的路径</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/kube-ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line"><span class="meta">#</span><span class="bash"> cgroups的驱动，可选systemd和cgroupfs</span></span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定Pod的DNS服务器IP地址</span></span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群的域名</span></span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 达到某些阈值之后，kubelet会驱逐Pod</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A <span class="built_in">set</span> of eviction thresholds (e.g. memory.available&lt;1Gi) that <span class="keyword">if</span> met would trigger a pod eviction.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (default imagefs.available&lt;15%,memory.available&lt;100Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5%)</span></span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 1000Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 10%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测到系统已启用swap分区时kubelet会启动失败</span></span><br><span class="line">failSwapOn: false</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义feature gates</span></span><br><span class="line">featureGates:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> kubelet 在证书即将到期时会自动发起一个 renew 自己证书的 CSR 请求</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 其实rotate证书已经默认开启，这里显示定义是为了方便查看</span></span><br><span class="line">  RotateKubeletClientCertificate: true</span><br><span class="line">  RotateKubeletServerCertificate: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查kubelet配置文件变更的间隔</span></span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许endpoint在尝试访问自己的服务时会被负载均衡分发到自身</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可选值<span class="string">"promiscuous-bridge"</span>, <span class="string">"hairpin-veth"</span> and <span class="string">"none"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认值为promiscuous-bridge</span></span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里定义容器镜像触发回收空间的上限值和下限值</span></span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubelet进程最大能打开的文件数量，默认是1000000</span></span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前节点kubelet所能运行的最大Pod数量</span></span><br><span class="line">maxPods: 110</span><br><span class="line"><span class="meta">#</span><span class="bash"> node状态上报间隔</span></span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubelet服务端口</span></span><br><span class="line">port: 10250</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定域名解析文件</span></span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拉镜像时，同一时间只拉取一个镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> We recommend *not* changing the default value on nodes that run docker daemon with version &lt; 1.9 or an Aufs storage backend. Issue <span class="comment">#10959 has more details. (default true)</span></span></span><br><span class="line">serializeImagePulls: true</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-proxy-conf"><a href="#kube-proxy-conf" class="headerlink" title="kube-proxy.conf"></a>kube-proxy.conf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy.conf &lt;&lt;EOF</span><br><span class="line">KUBE_PROXY_ARGS=" \\</span><br><span class="line">--config=/etc/kubernetes/kube-proxy.config.file \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-proxy-config-file"><a href="#kube-proxy-config-file" class="headerlink" title="kube-proxy.config.file"></a>kube-proxy.config.file</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy.config.file &lt;&lt;EOF</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: ""</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">  qps: 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群中pod的CIDR范围，从这个范围以外发送到服务集群IP的流量将被伪装，从POD发送到外部LoadBalanceIP的流量将被定向到各自的集群IP</span></span><br><span class="line">clusterCIDR: "10.244.0.0/16"</span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 每个核心最大能跟踪的NAT连接数，默认32768</span></span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: ""</span><br><span class="line">iptables:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> SNAT所有通过服务集群ip发送的通信</span></span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ipvs调度类型，默认是rr</span></span><br><span class="line">  scheduler: "rr"</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: "ipvs"</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: ""</span><br><span class="line">resourceContainer: /kube-proxy</span><br><span class="line">udpIdleTimeout: 250ms</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="systemd服务文件-1"><a href="#systemd服务文件-1" class="headerlink" title="systemd服务文件"></a>systemd服务文件</h2><h3 id="kubelet-service"><a href="#kubelet-service" class="headerlink" title="kubelet.service"></a>kubelet.service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet.conf</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \$KUBELET_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="kube-proxy-service"><a href="#kube-proxy-service" class="headerlink" title="kube-proxy.service"></a>kube-proxy.service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-proxy.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里启动时使用ipvsadm将TCP的keepalive时间设置，默认是900</span></span><br><span class="line">ExecStartPre=/usr/sbin/ipvsadm --set 900 120 300 </span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \$KUBE_PROXY_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="分发证书和kubeconfig文件"><a href="#分发证书和kubeconfig文件" class="headerlink" title="分发证书和kubeconfig文件"></a>分发证书和kubeconfig文件</h2><blockquote><ul><li>在<font color="red">k8s-m1</font>上操作</li><li>在worker节点建立对应的目录</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    echo "--- 创建目录 ---"</span><br><span class="line">    ssh $NODE mkdir -p /opt/cni/bin \</span><br><span class="line">                       /etc/cni/net.d \</span><br><span class="line">                       /etc/kubernetes/pki \</span><br><span class="line">                       /etc/kubernetes/manifests \</span><br><span class="line">                       /var/lib/kubelet</span><br><span class="line">    rsync -avpt /root/pki/kube-proxy.kubeconfig \</span><br><span class="line">                /root/pki/bootstrap.kubeconfig \</span><br><span class="line">                $NODE:/etc/kubernetes/</span><br><span class="line">    rsync -avpt /root/pki/kube-ca.pem \</span><br><span class="line">                /root/pki/front-proxy-ca.pem \</span><br><span class="line">                $NODE:/etc/kubernetes/pki/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="分发二进制文件-1"><a href="#分发二进制文件-1" class="headerlink" title="分发二进制文件"></a>分发二进制文件</h2><blockquote><ul><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    echo "--- 分发kubernetes二进制文件 ---"</span><br><span class="line">    rsync -avpt /root/software/kubernetes/server/bin/kubelet \</span><br><span class="line">                /root/software/kubernetes/server/bin/kube-proxy \</span><br><span class="line">                $NODE:/usr/local/bin/</span><br><span class="line">    echo "--- 分发CNI-Plugins ---"</span><br><span class="line">    rsync -avpt /root/software/cni-plugins/* $NODE:/opt/cni/bin/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="分发配置文件和服务文件"><a href="#分发配置文件和服务文件" class="headerlink" title="分发配置文件和服务文件"></a>分发配置文件和服务文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    rsync -avpt kubelet.conf kubelet.config.file kube-proxy.conf kube-proxy.config.file $NODE:/etc/kubernetes/</span><br><span class="line">    rsync -avpt kubelet.service kube-proxy.service $NODE:/usr/lib/systemd/system/</span><br><span class="line">    ssh $NODE systemctl daemon-reload</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    ssh $NODE systemctl enable --now docker.service kubelet.service kube-proxy.service</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h2><blockquote><ul><li>此时由于未按照网络插件，所以节点状态为<font color="red"><code>NotReady</code></font></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node -o wide</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">NAME      STATUS     ROLES     AGE       VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION              CONTAINER-RUNTIME</span><br><span class="line">k8s-m1    NotReady   node      12s       v1.11.5   172.16.80.201   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.1.3.el7.x86_64   docker://18.3.1</span><br><span class="line">k8s-m2    NotReady   node      12s       v1.11.5   172.16.80.202   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.1.3.el7.x86_64   docker://18.3.1</span><br><span class="line">k8s-m3    NotReady   node      12s       v1.11.5   172.16.80.203   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.1.3.el7.x86_64   docker://18.3.1</span><br></pre></td></tr></table></figure><h1 id="kubernetes-Core-Addons"><a href="#kubernetes-Core-Addons" class="headerlink" title="kubernetes Core Addons"></a>kubernetes Core Addons</h1><h2 id="网络组件部署（二选其一）"><a href="#网络组件部署（二选其一）" class="headerlink" title="网络组件部署（二选其一）"></a>网络组件部署（二选其一）</h2><blockquote><ul><li>只要符合CNI规范的网络组件都可以给kubernetes使用</li><li>网络组件清单可以在这里看到<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">Network Plugins</a></li><li>这里只列举<code>kube-flannel</code>和<code>calico</code>，flannel和calico的区别可以自己去找资料</li><li><font color="red">网络组件只能选一个来部署</font></li><li>本文使用<code>kube-flannel</code>部署网络组件，<code>calico</code>已测试可用</li><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><h3 id="创建工作目录-2"><a href="#创建工作目录-2" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/network-plugin/&#123;kube-flannel,calico&#125;</span><br></pre></td></tr></table></figure><h3 id="kube-flannel"><a href="#kube-flannel" class="headerlink" title="kube-flannel"></a>kube-flannel</h3><h4 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h4><blockquote><ul><li>kube-flannel基于VXLAN的方式创建容器二层网络，使用端口<font color="red"><code>8472/UDP</code></font>通信</li><li>flannel 第一次启动时，从 etcd 获取 Pod 网段信息，为本节点分配一个未使用的 /24 段地址，然后创建 flannel.1（也可能是其它名称，如 flannel1 等） 接口。</li><li>官方提供yaml文件部署为<code>DeamonSet</code></li><li>若需要使用<code>NetworkPolicy</code>功能，可以关注这个项目<a href="https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/flannel" target="_blank" rel="noopener">canal</a></li></ul></blockquote><h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><p><img src="https://jimmysong.io/kubernetes-handbook/images/flannel-networking.png" alt=""></p><h4 id="切换工作目录-2"><a href="#切换工作目录-2" class="headerlink" title="切换工作目录"></a>切换工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/network-plugin/kube-flannel</span><br></pre></td></tr></table></figure><h4 id="下载yaml文件"><a href="#下载yaml文件" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><blockquote><ul><li><p>官方yaml文件包含多个平台的daemonset，包括amd64、arm64、arm、ppc64le、s390x</p></li><li><p>这里以amd64作为例子，其他的可以自行根据需要修改或者直接删除不需要的daemonset</p></li><li><p>官方yaml文件已经配置好容器网络为<code>10.244.0.0/16</code>，这里需要跟<code>kube-controller-manager.conf</code>里面的<code>--cluster-cidr</code>匹配</p></li><li><p>如果在<code>kube-controller-manager.conf</code>里面把<code>--cluster-cidr</code>改成了其他地址段，例如<code>192.168.0.0/16</code>，用以下命令替换<code>kube-flannel.yaml</code>相应的字段</p></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,"Network": "10.244.0.0/16","Network": "192.168.0.0/16," -i kube-flannel.yml</span><br></pre></td></tr></table></figure><blockquote><ul><li><p>如果服务器有多个网卡，需要指定网卡用于flannel通信，以网卡ens33为例</p><ul><li>在<code>args</code>下面添加一行<font color="red"><code>- --iface=ens33</code></font></li></ul></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">- name: kube-flannel</span><br><span class="line">  image: quay.io/coreos/flannel:v0.10.0-amd64</span><br><span class="line">  command:</span><br><span class="line">  - /opt/bin/flanneld</span><br><span class="line">  args:</span><br><span class="line">  - --ip-masq</span><br><span class="line">  - --kube-subnet-mgr</span><br><span class="line">  - --iface=ens33</span><br></pre></td></tr></table></figure><h4 id="修改backend"><a href="#修改backend" class="headerlink" title="修改backend"></a>修改backend</h4><blockquote><ul><li>flannel支持多种后端实现，可选值为<code>VXLAN</code>、<code>host-gw</code>、<code>UDP</code></li><li>从性能上，<code>host-gw</code>是最好的，<code>VXLAN</code>和<code>UDP</code>次之</li><li>默认值是<code>VXLAN</code>，这里以修改为<code>host-gw</code>为例，位置大概在75行左右</li></ul></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    "Network": "10.244.0.0/16",</span></span><br><span class="line"><span class="string">    "Backend": &#123;</span></span><br><span class="line"><span class="string">      "Type": "host-gw"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br></pre></td></tr></table></figure><h4 id="部署kube-flannel"><a href="#部署kube-flannel" class="headerlink" title="部署kube-flannel"></a>部署kube-flannel</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><h4 id="检查部署情况"><a href="#检查部署情况" class="headerlink" title="检查部署情况"></a>检查部署情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=flannel</span><br><span class="line">NAME                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-27jwl   2/2       Running   0          59s</span><br><span class="line">kube-flannel-ds-4fgv6   2/2       Running   0          59s</span><br><span class="line">kube-flannel-ds-mvrt7   2/2       Running   0          59s</span><br></pre></td></tr></table></figure><blockquote><ul><li>如果等很久都没Running，可能是quay.io对你来说太慢了</li><li>可以替换一下镜像，重新apply</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,quay.io/coreos/,zhangguanzhang/quay.io.coreos.,g' -i kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yaml</span><br></pre></td></tr></table></figure><h3 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h3><h4 id="说明-4"><a href="#说明-4" class="headerlink" title="说明"></a>说明</h4><blockquote><ul><li>Calico 是一款纯 Layer 3 的网络，节点之间基于BGP协议来通信。</li><li>这里以<code>calico-v3.4.0</code>来作为示例</li><li><a href="https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/calico" target="_blank" rel="noopener">部署文档</a></li></ul></blockquote><h4 id="架构图-1"><a href="#架构图-1" class="headerlink" title="架构图"></a>架构图</h4><p><img src="https://docs.projectcalico.org/images/calico-arch-gen-v3.2.svg" alt=""></p><h4 id="切换工作目录-3"><a href="#切换工作目录-3" class="headerlink" title="切换工作目录"></a>切换工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/network-plugin/calico</span><br></pre></td></tr></table></figure><h4 id="下载yaml文件-1"><a href="#下载yaml文件-1" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h4><blockquote><ul><li>这里使用kubernetes API来保存网络信息</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://docs.projectcalico.org/v3.4/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml</span><br><span class="line">wget https://docs.projectcalico.org/v3.4/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calicoctl.yaml</span><br></pre></td></tr></table></figure><blockquote><ul><li>官方yaml文件默认配置容器网络为<code>192.168.0.0/16</code>，这里需要跟<code>kube-controller-manager.conf</code>里面的<code>--cluster-cidr</code>匹配，需要替换相应字段</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e "s,192.168.0.0/16,$&#123;POD_NET_CIDR&#125;,g" -i calico.yaml</span><br></pre></td></tr></table></figure><blockquote><ul><li>官方yaml文件定义calicoctl为Pod，而不是deployment，所以需要调整一下</li><li>修改<code>kind: Pod</code>为<code>kind: Deployment</code>并补充其他字段</li></ul></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.cloudprovider.kubernetes.io/uninitialized</span></span><br><span class="line"><span class="attr">        value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">quay.io/calico/ctl:v3.4.0</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["/bin/sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"while true; do sleep 3600; done"</span><span class="string">]</span></span><br><span class="line"><span class="attr">        tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DATASTORE_TYPE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">kubernetes</span></span><br></pre></td></tr></table></figure><h4 id="部署Calico"><a href="#部署Calico" class="headerlink" title="部署Calico"></a>部署Calico</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/network-plugin/calico/</span><br></pre></td></tr></table></figure><h4 id="检查部署情况-1"><a href="#检查部署情况-1" class="headerlink" title="检查部署情况"></a>检查部署情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=calico-node</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE</span><br><span class="line">calico-node-fjcj4   2/2       Running   0          6m</span><br><span class="line">calico-node-tzppt   2/2       Running   0          6m</span><br><span class="line">calico-node-zdq64   2/2       Running   0          6m</span><br><span class="line"></span><br><span class="line">kubectl get pod -n kube-system -l k8s-app=calicoctl</span><br><span class="line">NAME                         READY     STATUS    RESTARTS   AGE</span><br><span class="line">calicoctl-58df8955f6-sp8q9   0/1       Running   0          38s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl -n kube-system exec -it calicoctl-58df8955f6-sp8q9 -- /calicoctl get node -o wide</span><br><span class="line">NAME     ASN         IPV4               IPV6   </span><br><span class="line">k8s-m1   (unknown)   172.16.80.201/24          </span><br><span class="line">k8s-m2   (unknown)   172.16.80.202/24          </span><br><span class="line">k8s-m3   (unknown)   172.16.80.203/24</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system exec -it calicoctl-58df8955f6-sp8q9 -- /calicoctl get profiles -o wide</span><br><span class="line">NAME              LABELS   </span><br><span class="line">kns.default       map[]    </span><br><span class="line">kns.kube-public   map[]    </span><br><span class="line">kns.kube-system   map[]</span><br></pre></td></tr></table></figure><blockquote><ul><li>如果镜像pull不下来，可以替换一下</li><li>替换完重新apply</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,quay.io/calico/,zhangguanzhang/quay.io.calico.,g' -i *yaml</span><br><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure><h3 id="检查节点状态"><a href="#检查节点状态" class="headerlink" title="检查节点状态"></a>检查节点状态</h3><blockquote><ul><li>网络组件部署完成之后，可以看到node状态已经为<code>Ready</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node </span><br><span class="line">NAME      STATUS    ROLES     AGE       VERSION</span><br><span class="line">k8s-m1    Ready     node      1d        v1.11.5</span><br><span class="line">k8s-m2    Ready     node      1d        v1.11.5</span><br><span class="line">k8s-m3    Ready     node      1d        v1.11.5</span><br></pre></td></tr></table></figure><h2 id="服务发现组件部署"><a href="#服务发现组件部署" class="headerlink" title="服务发现组件部署"></a>服务发现组件部署</h2><blockquote><ul><li>kubernetes从v1.11之后，已经使用CoreDNS取代原来的KUBE DNS作为服务发现的组件</li><li>CoreDNS 是由 CNCF 维护的开源 DNS 方案，前身是 SkyDNS</li><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><h3 id="创建工作目录-3"><a href="#创建工作目录-3" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/coredns</span><br></pre></td></tr></table></figure><blockquote><ul><li>切换工作目录</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/coredns</span><br></pre></td></tr></table></figure><h3 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h3><h4 id="创建yaml文件-1"><a href="#创建yaml文件-1" class="headerlink" title="创建yaml文件"></a>创建yaml文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; coredns.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: "true"</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">          pods insecure</span><br><span class="line">          upstream</span><br><span class="line">          fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: ""</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      # 使用podAntiAffinity</span><br><span class="line">      # CoreDNS的Pod不会被调度到同一台宿主机</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity: </span><br><span class="line">          preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - weight: 100</span><br><span class="line">            podAffinityTerm:</span><br><span class="line">              labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                - key: k8s-app </span><br><span class="line">                  operator: In </span><br><span class="line">                  values:</span><br><span class="line">                  - kube-dns</span><br><span class="line">              topologyKey: kubernetes.io/hostname</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: CriticalAddonsOnly</span><br><span class="line">        operator: Exists</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/master</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: gcrxio/coredns:1.2.6</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args: [ "-conf", "/etc/coredns/Corefile" ]</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: host-time</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">      - name: host-time</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/localtime</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: coredns</span><br><span class="line">          items:</span><br><span class="line">          - key: Corefile</span><br><span class="line">            path: Corefile</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/port: "9153"</span><br><span class="line">    prometheus.io/scrape: "true"</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  clusterIP: $&#123;POD_DNS_SERVER_IP&#125;</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: TCP</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="修改yaml文件"><a href="#修改yaml文件" class="headerlink" title="修改yaml文件"></a>修改yaml文件</h4><blockquote><ul><li>yaml文件里面定义了<code>clusterIP</code>这里需要与<code>kubelet.config.file</code>里面定义的<code>cluster-dns</code>一致</li><li>如果kubelet.conf里面的<code>--cluster-dns</code>改成别的，例如<code>x.x.x.x</code>，这里也要做相应变动，不然Pod找不到DNS，无法正常工作</li><li>这里定义静态的hosts解析，这样Pod可以通过hostname来访问到各节点主机</li><li>用下面的命令根据<code>HostArray</code>的信息生成静态的hosts解析</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sed -e '57r '&lt;(\</span><br><span class="line">    echo '        hosts &#123;'; \</span><br><span class="line">    for NODE in "$&#123;!HostArray[@]&#125;";do \</span><br><span class="line">        echo "          $&#123;HostArray[$NODE]&#125; $NODE"; \</span><br><span class="line">    done;\</span><br><span class="line">    echo '          fallthrough'; \</span><br><span class="line">    echo '        &#125;';) \</span><br><span class="line">-i coredns.yaml</span><br></pre></td></tr></table></figure><blockquote><ul><li>上面的命令的作用是，通过<code>HostArray</code>的信息生成hosts解析配置，顺序是打乱的，可以手工调整顺序</li><li>也可以手动修改<code>coredns.yaml</code>文件来添加对应字段</li></ul></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors</span></span><br><span class="line"><span class="string">        log</span></span><br><span class="line"><span class="string">        health</span></span><br><span class="line"><span class="string">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span></span><br><span class="line"><span class="string">          pods insecure</span></span><br><span class="line"><span class="string">          upstream</span></span><br><span class="line"><span class="string">          fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        hosts &#123;</span></span><br><span class="line"><span class="string">          172.16.80.202 k8s-m2</span></span><br><span class="line"><span class="string">          172.16.80.203 k8s-m3</span></span><br><span class="line"><span class="string">          172.16.80.201 k8s-m1</span></span><br><span class="line"><span class="string">          fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        prometheus :9153</span></span><br><span class="line"><span class="string">        proxy . /etc/resolv.conf</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure><h4 id="部署CoreDNS"><a href="#部署CoreDNS" class="headerlink" title="部署CoreDNS"></a>部署CoreDNS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f coredns.yaml</span><br></pre></td></tr></table></figure><h4 id="检查部署状态"><a href="#检查部署状态" class="headerlink" title="检查部署状态"></a>检查部署状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=kube-dns</span><br><span class="line">NAME                       READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5566c96697-6gzzc   1/1       Running   0          45s</span><br><span class="line">coredns-5566c96697-q5slk   1/1       Running   0          45s</span><br></pre></td></tr></table></figure><h3 id="验证集群DNS服务"><a href="#验证集群DNS服务" class="headerlink" title="验证集群DNS服务"></a>验证集群DNS服务</h3><blockquote><ul><li>创建一个deployment测试DNS解析</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建一个基于busybox的deployment</span></span><br><span class="line">cat &gt; /root/yaml/busybox-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: busybox</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: busybox</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: busybox</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: busybox</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        image: busybox:1.26</span><br><span class="line">        command:</span><br><span class="line">        - sleep</span><br><span class="line">        - "3600"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于文件创建deployment</span></span><br><span class="line">kubectl apply -f /root/yaml/busybox-deployment.yaml</span><br></pre></td></tr></table></figure><blockquote><ul><li>检查deployment部署情况</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">NAME                       READY     STATUS    RESTARTS   AGE</span><br><span class="line">busybox-7b9bfb5658-872gj   1/1       Running   0          6s</span><br></pre></td></tr></table></figure><blockquote><ul><li>验证集群DNS解析</li><li>上一个命令获取到pod名字为<code>busybox-7b9bfb5658-872gj</code></li><li>通过kubectl命令连接到Pod运行<code>nslookup</code>命令测试使用域名来访问kube-apiserver和各节点主机</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">echo "--- 通过CoreDNS访问kubernetes ---"</span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup kubernetes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo "--- 通过CoreDNS访问k8s-m1 ---"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup k8s-m1</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">Name:      k8s-m1</span><br><span class="line">Address 1: 172.16.80.201 k8s-m1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo "--- 通过CoreDNS访问k8s-m2 ---"</span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup k8s-m2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">Name:      k8s-n2</span><br><span class="line">Address 1: 172.16.80.202 k8s-m2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo "--- 通过CoreDNS访问并不存在的k8s-n3 ---"</span><br><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup k8s-n3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例输出</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">nslookup: can't resolve 'k8s-n3'</span><br></pre></td></tr></table></figure><h2 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h2><blockquote><ul><li><a href="https://github.com/kubernetes-incubator/metrics-server" target="_blank" rel="noopener">Metrics Server</a><br>是实现了 Metrics API 的元件,其目标是取代 Heapster 作位 Pod 与 Node 提供资源的 Usage<br>metrics,该元件会从每个 Kubernetes 节点上的 Kubelet 所公开的 Summary API 中收集 Metrics</li><li>Horizontal Pod Autoscaler（HPA）控制器用于实现基于CPU使用率进行自动Pod伸缩的功能。</li><li>HPA控制器基于Master的kube-controller-manager服务启动参数–horizontal-pod-autoscaler-sync-period定义是时长（默认30秒）,周期性监控目标Pod的CPU使用率,并在满足条件时对ReplicationController或Deployment中的Pod副本数进行调整,以符合用户定义的平均Pod<br>CPU使用率。</li><li>在新版本的kubernetes中 Pod CPU使用率不在来源于heapster,而是来自于metrics-server</li><li>官网原话是 The –horizontal-pod-autoscaler-use-rest-clients is true or unset. Setting this to false switches to Heapster-based autoscaling, which is deprecated.</li><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><h3 id="额外参数"><a href="#额外参数" class="headerlink" title="额外参数"></a>额外参数</h3><blockquote><ul><li>设置kube-apiserver参数，这里在配置kube-apiserver阶段已经加进去了</li><li>front-proxy证书，在证书生成阶段已经完成且已分发</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem</span><br><span class="line">--requestheader-allowed-names=aggregator</span><br><span class="line">--requestheader-group-headers=X-Remote-Group</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">--requestheader-username-headers=X-Remote-User</span><br></pre></td></tr></table></figure><h3 id="创建工作目录-4"><a href="#创建工作目录-4" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/metrics-server</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-4"><a href="#切换工作目录-4" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/metrics-server</span><br></pre></td></tr></table></figure><h3 id="下载yaml文件-2"><a href="#下载yaml文件-2" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/aggregated-metrics-reader.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/auth-delegator.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/auth-reader.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/metrics-apiservice.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/metrics-server-service.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/resource-reader.yaml</span><br></pre></td></tr></table></figure><h3 id="创建metrics-server-deployment-yaml"><a href="#创建metrics-server-deployment-yaml" class="headerlink" title="创建metrics-server-deployment.yaml"></a>创建metrics-server-deployment.yaml</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; metrics-server-deployment.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      volumes:</span><br><span class="line">      # mount in tmp so we can safely use from-scratch images and/or read-only containers</span><br><span class="line">      - name: ca-ssl</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/kubernetes/pki</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: gcrxio/metrics-server-amd64:v0.3.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - /metrics-server</span><br><span class="line">        - --metric-resolution=30s</span><br><span class="line">        - --kubelet-port=10250</span><br><span class="line">        - --kubelet-preferred-address-types=InternalDNS,InternalIP,ExternalDNS,ExternalIP,Hostname</span><br><span class="line">        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">        - --requestheader-username-headers=X-Remote-User </span><br><span class="line">        - --requestheader-group-headers=X-Remote-Group </span><br><span class="line">        - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        - -v=2</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: ca-ssl</span><br><span class="line">          mountPath: /etc/kubernetes/pki</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="部署metrics-server"><a href="#部署metrics-server" class="headerlink" title="部署metrics-server"></a>部署metrics-server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure><h3 id="查看pod状态"><a href="#查看pod状态" class="headerlink" title="查看pod状态"></a>查看pod状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=metrics-server</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/metrics-server-86bd9d7667-5hbn6   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h3 id="验证metrics"><a href="#验证metrics" class="headerlink" title="验证metrics"></a>验证metrics</h3><blockquote><ul><li>完成后,等待一段时间(约 30s - 1m)收集 Metrics</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 请求metrics api的结果</span></span><br><span class="line">kubectl get --raw /apis/metrics.k8s.io/v1beta1</span><br><span class="line">&#123;"kind":"APIResourceList","apiVersion":"v1","groupVersion":"metrics.k8s.io/v1beta1","resources":[&#123;"name":"nodes","singularName":"","namespaced":false,"kind":"NodeMetrics","verbs":["get","list"]&#125;,&#123;"name":"pods","singularName":"","namespaced":true,"kind":"PodMetrics","verbs":["get","list"]&#125;]&#125;</span><br><span class="line"></span><br><span class="line">kubectl get apiservice|grep metrics</span><br><span class="line">v1beta1.metrics.k8s.io                  2018-12-09T08:17:26Z</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取节点性能信息</span></span><br><span class="line">kubectl top node</span><br><span class="line">NAME      CPU(cores)   CPU%      MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-m1    113m         2%        1080Mi          14%       </span><br><span class="line">k8s-m2    133m         3%        1086Mi          14%       </span><br><span class="line">k8s-m3    100m         2%        1029Mi          13%</span><br></pre></td></tr></table></figure><h1 id="至此集群已具备基本功能"><a href="#至此集群已具备基本功能" class="headerlink" title="至此集群已具备基本功能"></a>至此集群已具备基本功能</h1><blockquote><p>下面的Extra Addons就是一些额外的功能</p></blockquote><h1 id="kubernetes-Extra-Addons"><a href="#kubernetes-Extra-Addons" class="headerlink" title="kubernetes Extra Addons"></a>kubernetes Extra Addons</h1><h2 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h2><blockquote><ul><li>Dashboard 是kubernetes社区提供的GUI界面，用于图形化管理kubernetes集群，同时可以看到资源报表。</li><li>官方提供yaml文件直接部署，但是需要更改<code>image</code>以便国内部署</li><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><h3 id="创建工作目录-5"><a href="#创建工作目录-5" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-5"><a href="#切换工作目录-5" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="获取yaml文件"><a href="#获取yaml文件" class="headerlink" title="获取yaml文件"></a>获取yaml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure><h3 id="修改镜像地址"><a href="#修改镜像地址" class="headerlink" title="修改镜像地址"></a>修改镜像地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,k8s.gcr.io/kubernetes-dashboard-amd64,gcrxio/kubernetes-dashboard-amd64,g' -i kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure><h3 id="创建kubernetes-Dashboard"><a href="#创建kubernetes-Dashboard" class="headerlink" title="创建kubernetes-Dashboard"></a>创建kubernetes-Dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure><h3 id="创建ServiceAccount-RBAC"><a href="#创建ServiceAccount-RBAC" class="headerlink" title="创建ServiceAccount RBAC"></a>创建ServiceAccount RBAC</h3><blockquote><ul><li>官方的yaml文件，ServiceAccount绑定的RBAC权限很低，很多资源无法查看</li><li>需要创建一个用于管理全局的ServiceAccount</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; cluster-admin.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在kube-system中创建名为admin-user的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将admin-user和cluster-admin绑定在一起</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-admin是kubernetes内置的clusterrole，具有集群管理员权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他内置的clusterrole可以通过kubectl get clusterrole查看</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f cluster-admin.yaml</span><br></pre></td></tr></table></figure><h3 id="获取ServiceAccount的Token"><a href="#获取ServiceAccount的Token" class="headerlink" title="获取ServiceAccount的Token"></a>获取ServiceAccount的Token</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span><br></pre></td></tr></table></figure><h3 id="查看部署情况"><a href="#查看部署情况" class="headerlink" title="查看部署情况"></a>查看部署情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n kube-system --selector k8s-app=kubernetes-dashboard</span><br></pre></td></tr></table></figure><h3 id="访问Dashboard"><a href="#访问Dashboard" class="headerlink" title="访问Dashboard"></a>访问Dashboard</h3><blockquote><ul><li>kubernetes-dashborad的svc默认是<code>clusterIP</code>，需要修改为<code>nodePort</code>才能被外部访问</li><li>随机分配<code>NodePort</code>，分配范围由<code>kube-apiserver</code>的<code>--service-node-port-range</code>参数指定</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -n kube-system svc kubernetes-dashboard -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;'</span><br></pre></td></tr></table></figure><blockquote><ul><li>修改完之后，通过以下命令获取访问kubernetes-Dashboard的端口</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get svc --selector k8s-app=kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.106.183.192   &lt;none&gt;        443:30216/TCP   12s</span><br></pre></td></tr></table></figure><blockquote><ul><li>可以看到已经将节点的<code>30216</code>端口暴露出来</li></ul></blockquote><blockquote><ul><li><p>IP地址不固定，只要运行了kube-proxy组件，都会在节点上添加<code>30216</code>端口规则用于转发请求到Pod</p><p><a href="https://172.16.80.200:30216" target="_blank" rel="noopener">https://172.16.80.200:30216</a></p><p><a href="https://172.16.80.201:30216" target="_blank" rel="noopener">https://172.16.80.201:30216</a></p><p><a href="https://172.16.80.202:30216" target="_blank" rel="noopener">https://172.16.80.202:30216</a></p><p><a href="https://172.16.80.203:30216" target="_blank" rel="noopener">https://172.16.80.203:30216</a></p></li><li><p>登录Dashboard，上面已经获取了token，这里只需要把token的值填入输入框，点击<code>SIGN IN</code>即可登录</p></li></ul></blockquote><h3 id="Dashboard-UI预览图"><a href="#Dashboard-UI预览图" class="headerlink" title="Dashboard UI预览图"></a>Dashboard UI预览图</h3><p><img src="https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.0/docs/dashboard-ui.png" alt=""></p><h2 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h2><blockquote><ul><li>Ingress 是 Kubernetes 中的一个抽象资源，其功能是通过 Web Server 的 Virtual Host<br>概念以域名(Domain Name)方式转发到內部 Service，这避免了使用 Service 中的 NodePort 与<br>LoadBalancer 类型所带來的限制(如 Port 数量上限)，而实现 Ingress 功能则是通过 Ingress Controller<br>来达成，它会负责监听 Kubernetes API 中的 Ingress 与 Service 资源，并在发生资源变化时，根据资源预期的结果来设置 Web Server。</li><li>Ingress Controller 有许多实现可以选择，这里只是列举一小部分<ul><li><a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Ingress NGINX</a>：Kubernetes 官方维护的方案，<font color="red">本次安装使用此方案</font></li><li><a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">kubernetes-ingress</a>：由nginx社区维护的方案，使用社区版nginx和nginx-plus</li><li><a href="https://github.com/containous/traefik" target="_blank" rel="noopener">treafik</a>：一款开源的反向代理与负载均衡工具。它最大的优点是能够与常见的微服务系统直接整合，可以实现自动化动态配置</li></ul></li><li>在<font color="red">k8s-m1</font>上操作</li></ul></blockquote><h3 id="创建工作目录-6"><a href="#创建工作目录-6" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/ingress/ingress-nginx</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-6"><a href="#切换工作目录-6" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/ingress/ingress-nginx</span><br></pre></td></tr></table></figure><h3 id="下载yaml文件-3"><a href="#下载yaml文件-3" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.20.0/deploy/mandatory.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.20.0/deploy/provider/baremetal/service-nodeport.yaml</span><br></pre></td></tr></table></figure><h3 id="修改镜像地址-1"><a href="#修改镜像地址-1" class="headerlink" title="修改镜像地址"></a>修改镜像地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,k8s.gcr.io/,zhangguanzhang/gcr.io.google_containers.,g' \</span><br><span class="line">    -e 's,quay.io/kubernetes-ingress-controller/,zhangguanzhang/quay.io.kubernetes-ingress-controller.,g' \</span><br><span class="line">    -i mandatory.yaml</span><br></pre></td></tr></table></figure><h3 id="创建ingress-nginx"><a href="#创建ingress-nginx" class="headerlink" title="创建ingress-nginx"></a>创建ingress-nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure><h3 id="检查部署情况-2"><a href="#检查部署情况-2" class="headerlink" title="检查部署情况"></a>检查部署情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n ingress-nginx get pod</span><br></pre></td></tr></table></figure><h3 id="访问ingress"><a href="#访问ingress" class="headerlink" title="访问ingress"></a>访问ingress</h3><blockquote><ul><li>默认的backend会返回404</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n ingress-nginx get svc</span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx   NodePort   10.96.250.140   &lt;none&gt;        80:32603/TCP,443:30083/TCP   1m</span><br><span class="line"></span><br><span class="line">curl http://172.16.80.200:32603</span><br><span class="line">default backend - 404</span><br><span class="line"></span><br><span class="line">curl -k https://172.16.80.200:30083</span><br><span class="line">default backend - 404</span><br></pre></td></tr></table></figure><blockquote><font color="red"><strong>注意</strong></font><ul><li><p>这里部署之后，是<code>deployment</code>，且通过<code>nodePort</code>暴露服务</p></li><li><p>也可以修改yaml文件，将<code>Ingress-nginx</code>部署为<code>DaemonSet</code></p><ul><li>使用<code>labels</code>和<code>nodeSelector</code>来指定运行ingress-nginx的节点</li><li>使用<code>hostNetwork=true</code>来共享主机网络命名空间，或者使用<code>hostPort</code>指定主机端口映射</li><li>如果使用<code>hostNetwork</code>共享宿主机网络栈或者<code>hostPort</code>映射宿主机端口，记得要看看有没有端口冲突，否则无法启动</li><li>修改监听端口可以在<code>ingress-nginx</code>启动命令中添加<code>--http-port=8180</code>和<code>--https-port=8543</code>，还有下面的端口定义也相应变更即可</li></ul></li></ul></blockquote><h3 id="创建kubernetes-Dashboard的Ingress"><a href="#创建kubernetes-Dashboard的Ingress" class="headerlink" title="创建kubernetes-Dashboard的Ingress"></a>创建kubernetes-Dashboard的Ingress</h3><blockquote><ul><li>kubernetes-Dashboard默认是开启了HTTPS访问的</li><li>ingress-nginx需要以HTTPS的方式反向代理kubernetes-Dashboard</li><li>以HTTP方式访问kubernetes-Dashboard的时候会被重定向到HTTPS</li><li>需要创建HTTPS证书，用于访问ingress-nginx的HTTPS端口</li></ul></blockquote><h4 id="创建HTTPS证书"><a href="#创建HTTPS证书" class="headerlink" title="创建HTTPS证书"></a>创建HTTPS证书</h4><blockquote><ul><li>这里的<code>CN=域名/O=域名</code>需要跟后面的ingress主机名匹配</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -days 3650 \</span><br><span class="line">            -newkey rsa:2048 \</span><br><span class="line">            -keyout tls.key \</span><br><span class="line">            -out tls.crt \</span><br><span class="line">            -subj "/CN=dashboard.k8s.local/O=dashboard.k8s.local"</span><br></pre></td></tr></table></figure><h4 id="创建secret对象"><a href="#创建secret对象" class="headerlink" title="创建secret对象"></a>创建secret对象</h4><blockquote><ul><li>这里将HTTPS证书创建为kubernetes的secret对象<code>dashboard-tls</code></li><li>ingress创建的时候需要加载这个作为HTTPS证书</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system create secret tls dashboard-tls --key ./tls.key --cert ./tls.crt</span><br></pre></td></tr></table></figure><h4 id="创建dashboard-ingress-yaml"><a href="#创建dashboard-ingress-yaml" class="headerlink" title="创建dashboard-ingress.yaml"></a>创建dashboard-ingress.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/secure-backends:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">  - hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">dashboard.k8s.local</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">dashboard-tls</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">dashboard.k8s.local</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">        - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">          backend:</span></span><br><span class="line"><span class="attr">            serviceName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">            servicePort:</span> <span class="number">443</span></span><br></pre></td></tr></table></figure><h4 id="创建ingress"><a href="#创建ingress" class="headerlink" title="创建ingress"></a>创建ingress</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f dashboard-ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="检查ingress"><a href="#检查ingress" class="headerlink" title="检查ingress"></a>检查ingress</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get ingress</span><br><span class="line">NAME                HOSTS                 ADDRESS         PORTS     AGE</span><br><span class="line">dashboard-ingress   dashboard.k8s.local                   80, 443   16m</span><br></pre></td></tr></table></figure><h4 id="访问kubernetes-Dashboard"><a href="#访问kubernetes-Dashboard" class="headerlink" title="访问kubernetes-Dashboard"></a>访问kubernetes-Dashboard</h4><ul><li>修改主机hosts静态域名解析，以本文为例在hosts文件里添加<code>172.16.80.200 dashboard.k8s.local</code></li><li>使用<code>https://dashboard.k8s.local:30083</code>访问kubernetesDashboard了</li><li>添加了TLS之后，访问HTTP会被跳转到HTTPS端口，这里比较坑爹，没法自定义跳转HTTPS的端口</li><li>此处使用的是自签名证书，浏览器会提示不安全，请忽略</li><li>建议搭配<code>external-DNS</code>和<code>LoadBalancer</code>一起食用，效果更佳</li></ul><p><img src="/2018/12/08/./二进制部署 kubernetes v1.11.x 高可用集群\访问kubernetes-dashboard-ingress.png" alt=""></p><h2 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h2><blockquote><ul><li><a href="http://helm.sh/" target="_blank" rel="noopener">Helm</a>是一个kubernetes应用的包管理工具，用来管理<a href="https://github.com/kubernetes/charts" target="_blank" rel="noopener">charts</a>——预先配置好的安装包资源，有点类似于Ubuntu的APT和CentOS中的yum。</li><li>Helm chart是用来封装kubernetes原生应用程序的yaml文件，可以在你部署应用的时候自定义应用程序的一些metadata，便与应用程序的分发。</li><li>Helm和charts的主要作用：<ul><li>应用程序封装</li><li>版本管理</li><li>依赖检查</li><li>便于应用程序分发</li></ul></li></ul></blockquote><h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h3><blockquote><ul><li>kubernetes v1.6及以上的版本，启用RBAC</li><li>集群可以访问到chart仓库</li><li>helm客户端主机能访问kubernetes集群</li></ul></blockquote><h3 id="安装客户端"><a href="#安装客户端" class="headerlink" title="安装客户端"></a>安装客户端</h3><blockquote><p>安装方式二选一，需要<font color="red">科学上网</font></p></blockquote><h4 id="直接脚本安装"><a href="#直接脚本安装" class="headerlink" title="直接脚本安装"></a>直接脚本安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 使用脚本安装，默认是最新版 ---'</span><br><span class="line">curl https://raw.githubusercontent.com/helm/helm/master/scripts/get | bash</span><br></pre></td></tr></table></figure><h4 id="下载二进制文件安装"><a href="#下载二进制文件安装" class="headerlink" title="下载二进制文件安装"></a>下载二进制文件安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 下载二进制文件安装 ---'</span><br><span class="line">wget https://storage.googleapis.com/kubernetes-helm/helm-v2.12.0-linux-amd64.tar.gz</span><br><span class="line">tar xzf helm-v2.12.0-linux-amd64.tar.gz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="创建工作目录-7"><a href="#创建工作目录-7" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/yaml/helm/</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-7"><a href="#切换工作目录-7" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/helm</span><br></pre></td></tr></table></figure><h3 id="创建RBAC规则"><a href="#创建RBAC规则" class="headerlink" title="创建RBAC规则"></a>创建RBAC规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/yaml/helm/helm-rbac.yaml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f /root/yaml/helm/helm-rbac.yaml</span><br></pre></td></tr></table></figure><h3 id="安装服务端"><a href="#安装服务端" class="headerlink" title="安装服务端"></a>安装服务端</h3><blockquote><ul><li>这里指定了helm的stable repo国内镜像地址</li><li>具体说明请看<a href="https://github.com/BurdenBear/kube-charts-mirror" target="_blank" rel="noopener">这里</a></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image gcrxio/tiller:v2.12.0 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h3 id="检查安装情况"><a href="#检查安装情况" class="headerlink" title="检查安装情况"></a>检查安装情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br><span class="line"></span><br><span class="line">helm version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.12.0", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.12.0", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h3 id="添加命令行补全"><a href="#添加命令行补全" class="headerlink" title="添加命令行补全"></a>添加命令行补全</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm completion bash  &gt; /etc/bash_completion.d/helm</span><br><span class="line">source /etc/bash_completion.d/helm</span><br></pre></td></tr></table></figure><h2 id="Rook（测试用途）"><a href="#Rook（测试用途）" class="headerlink" title="Rook（测试用途）"></a>Rook（<font color="red">测试用途</font>）</h2><h3 id="说明-5"><a href="#说明-5" class="headerlink" title="说明"></a>说明</h3><blockquote><ul><li><a href="https://github.com/rook/rook" target="_blank" rel="noopener">Rook</a>是一款云原生环境下的开源分布式存储编排系统，目前已进入CNCF孵化。Rook的官方网站是<a href="https://rook.io" target="_blank" rel="noopener">https://rook.io</a></li><li>Rook将分布式存储软件转变为自我管理，自我缩放和自我修复的存储服务。它通过自动化部署，引导、配置、供应、扩展、升级、迁移、灾难恢复、监控和资源管理来实现。 Rook使用基础的云原生容器管理、调度和编排平台提供的功能来履行其职责。</li><li>Rook利用扩展点深入融入云原生环境，为调度、生命周期管理、资源管理、安全性、监控和用户体验提供无缝体验。</li><li>Ceph Custom Resource Definition（CRD）已经在Rook v0.8版本升级到Beta</li><li>其他特性请查看项目文档</li><li><font color="red"><strong>这里只用作测试环境中提供StorageClass和持久化存储</strong></font></li><li><font color="red"><strong>请慎重考虑是否部署在生产环境中</strong></font></li></ul></blockquote><h3 id="Rook与kubernetes的集成"><a href="#Rook与kubernetes的集成" class="headerlink" title="Rook与kubernetes的集成"></a>Rook与kubernetes的集成</h3><p><img src="https://rook.io/docs/rook/v0.8/media/rook-architecture.png" alt=""></p><h3 id="Rook架构图"><a href="#Rook架构图" class="headerlink" title="Rook架构图"></a>Rook架构图</h3><p><img src="https://rook.io/docs/rook/v0.8/media/kubernetes.png" alt=""></p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul><li>这里以<code>Rook v0.8.3</code>作为示例</li><li>这里默认使用<code>/var/lib/rook/osd*</code>目录来运行OSD</li><li>需要<font color="red">最少3个节点</font>，否则无足够的节点启动集群</li><li>可以使用<code>yaml文件</code>部署和使用<code>helm chart</code>部署，这里使用<code>yaml文件</code>部署</li></ul><h4 id="创建工作目录-8"><a href="#创建工作目录-8" class="headerlink" title="创建工作目录"></a>创建工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/rook/</span><br></pre></td></tr></table></figure><h4 id="进入工作目录"><a href="#进入工作目录" class="headerlink" title="进入工作目录"></a>进入工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/rook/</span><br></pre></td></tr></table></figure><h4 id="下载yaml文件-4"><a href="#下载yaml文件-4" class="headerlink" title="下载yaml文件"></a>下载yaml文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> operator实现自定义API用于管理rook-ceph</span></span><br><span class="line">wget https://raw.githubusercontent.com/rook/rook/v0.8.3/cluster/examples/kubernetes/ceph/operator.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster用于部署rook-ceph集群</span></span><br><span class="line">wget https://raw.githubusercontent.com/rook/rook/v0.8.3/cluster/examples/kubernetes/ceph/cluster.yaml</span><br></pre></td></tr></table></figure><h4 id="部署operator"><a href="#部署operator" class="headerlink" title="部署operator"></a>部署operator</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f operator.yaml</span><br></pre></td></tr></table></figure><h4 id="检查operator安装情况"><a href="#检查operator安装情况" class="headerlink" title="检查operator安装情况"></a>检查operator安装情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n rook-ceph-system get all</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/rook-ceph-agent-4qwvd                 1/1       Running   0          11m</span><br><span class="line">pod/rook-ceph-agent-v5ghj                 1/1       Running   0          11m</span><br><span class="line">pod/rook-ceph-agent-zv8s6                 1/1       Running   0          11m</span><br><span class="line">pod/rook-ceph-operator-745f756bd8-9gdpk   1/1       Running   0          12m</span><br><span class="line">pod/rook-discover-44lx5                   1/1       Running   0          11m</span><br><span class="line">pod/rook-discover-4d6mn                   1/1       Running   0          11m</span><br><span class="line">pod/rook-discover-mvqfv                   1/1       Running   0          11m</span><br><span class="line"></span><br><span class="line">NAME                             DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/rook-ceph-agent   3         3         3         3            3           &lt;none&gt;          11m</span><br><span class="line">daemonset.apps/rook-discover     3         3         3         3            3           &lt;none&gt;          11m</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/rook-ceph-operator   1         1         1            1           12m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/rook-ceph-operator-745f756bd8   1         1         1         12m</span><br></pre></td></tr></table></figure><h4 id="部署cluster"><a href="#部署cluster" class="headerlink" title="部署cluster"></a>部署cluster</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f cluster.yaml</span><br></pre></td></tr></table></figure><h4 id="检查cluster部署情况"><a href="#检查cluster部署情况" class="headerlink" title="检查cluster部署情况"></a>检查cluster部署情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n rook-ceph get all</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME                                      READY     STATUS      RESTARTS   AGE</span><br><span class="line">pod/rook-ceph-mgr-a-7944d8d79b-pvrsf      1/1       Running     0          10m</span><br><span class="line">pod/rook-ceph-mon0-ll7fc                  1/1       Running     0          11m</span><br><span class="line">pod/rook-ceph-mon1-cd2gb                  1/1       Running     0          11m</span><br><span class="line">pod/rook-ceph-mon2-vlmfc                  1/1       Running     0          10m</span><br><span class="line">pod/rook-ceph-osd-id-0-745486df7b-4dxdc   1/1       Running     0          10m</span><br><span class="line">pod/rook-ceph-osd-id-1-85fdf4cd64-ftmc4   1/1       Running     0          10m</span><br><span class="line">pod/rook-ceph-osd-id-2-6bc4fbb457-295pn   1/1       Running     0          10m</span><br><span class="line">pod/rook-ceph-osd-prepare-k8s-m1-klv5j    0/1       Completed   0          10m</span><br><span class="line">pod/rook-ceph-osd-prepare-k8s-m2-dt2pl    0/1       Completed   0          10m</span><br><span class="line">pod/rook-ceph-osd-prepare-k8s-m3-ndqpl    0/1       Completed   0          10m</span><br><span class="line"></span><br><span class="line">NAME                                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/rook-ceph-mgr                      ClusterIP   10.100.158.219   &lt;none&gt;        9283/TCP         10m</span><br><span class="line">service/rook-ceph-mgr-dashboard            ClusterIP   10.107.141.138   &lt;none&gt;        7000/TCP         10m</span><br><span class="line">service/rook-ceph-mgr-dashboard-external   NodePort    10.99.89.12      &lt;none&gt;        7000:30660/TCP   10m</span><br><span class="line">service/rook-ceph-mon0                     ClusterIP   10.100.50.229    &lt;none&gt;        6790/TCP         11m</span><br><span class="line">service/rook-ceph-mon1                     ClusterIP   10.110.105.207   &lt;none&gt;        6790/TCP         11m</span><br><span class="line">service/rook-ceph-mon2                     ClusterIP   10.103.223.166   &lt;none&gt;        6790/TCP         10m</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/rook-ceph-mgr-a      1         1         1            1           10m</span><br><span class="line">deployment.apps/rook-ceph-osd-id-0   1         1         1            1           10m</span><br><span class="line">deployment.apps/rook-ceph-osd-id-1   1         1         1            1           10m</span><br><span class="line">deployment.apps/rook-ceph-osd-id-2   1         1         1            1           10m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/rook-ceph-mgr-a-7944d8d79b      1         1         1         10m</span><br><span class="line">replicaset.apps/rook-ceph-mon0                  1         1         1         11m</span><br><span class="line">replicaset.apps/rook-ceph-mon1                  1         1         1         11m</span><br><span class="line">replicaset.apps/rook-ceph-mon2                  1         1         1         10m</span><br><span class="line">replicaset.apps/rook-ceph-osd-id-0-745486df7b   1         1         1         10m</span><br><span class="line">replicaset.apps/rook-ceph-osd-id-1-85fdf4cd64   1         1         1         10m</span><br><span class="line">replicaset.apps/rook-ceph-osd-id-2-6bc4fbb457   1         1         1         10m</span><br><span class="line"></span><br><span class="line">NAME                                     DESIRED   SUCCESSFUL   AGE</span><br><span class="line">job.batch/rook-ceph-osd-prepare-k8s-m1   1         1            10m</span><br><span class="line">job.batch/rook-ceph-osd-prepare-k8s-m2   1         1            10m</span><br><span class="line">job.batch/rook-ceph-osd-prepare-k8s-m3   1         1            10m</span><br></pre></td></tr></table></figure><h4 id="检查ceph集群状态"><a href="#检查ceph集群状态" class="headerlink" title="检查ceph集群状态"></a>检查ceph集群状态</h4><blockquote><ul><li>上面命令已经获取ceph-mon0节点的pod名<code>rook-ceph-mon0-ll7fc</code>，以此pod为例运行以下命令</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n rook-ceph exec -it rook-ceph-mon0-ll7fc -- ceph -s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">  cluster:</span><br><span class="line">    id:     1fcee02c-fd98-4b13-bfed-de7b6605a237</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"> </span><br><span class="line">  services:</span><br><span class="line">    mon: 3 daemons, quorum rook-ceph-mon0,rook-ceph-mon2,rook-ceph-mon1</span><br><span class="line">    mgr: a(active)</span><br><span class="line">    osd: 3 osds: 3 up, 3 in</span><br><span class="line"> </span><br><span class="line">  data:</span><br><span class="line">    pools:   1 pools, 100 pgs</span><br><span class="line">    objects: 0 objects, 0 bytes</span><br><span class="line">    usage:   22767 MB used, 96979 MB / 116 GB avail</span><br><span class="line">    pgs:     100 active+clean</span><br></pre></td></tr></table></figure><h3 id="暴露ceph-mgr的dashboard"><a href="#暴露ceph-mgr的dashboard" class="headerlink" title="暴露ceph-mgr的dashboard"></a>暴露ceph-mgr的dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/rook/rook/v0.8.3/cluster/examples/kubernetes/ceph/dashboard-external.yaml</span><br><span class="line">kubectl apply -f dashboard-external.yaml</span><br></pre></td></tr></table></figure><h3 id="访问已暴露的dashboard"><a href="#访问已暴露的dashboard" class="headerlink" title="访问已暴露的dashboard"></a>访问已暴露的dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n rook-ceph get svc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">rook-ceph-mgr                      ClusterIP   10.100.158.219   &lt;none&gt;        9283/TCP         12m</span><br><span class="line">rook-ceph-mgr-dashboard            ClusterIP   10.107.141.138   &lt;none&gt;        7000/TCP         12m</span><br><span class="line">rook-ceph-mgr-dashboard-external   NodePort    10.99.89.12      &lt;none&gt;        7000:30660/TCP   11m</span><br><span class="line">rook-ceph-mon0                     ClusterIP   10.100.50.229    &lt;none&gt;        6790/TCP         13m</span><br><span class="line">rook-ceph-mon1                     ClusterIP   10.110.105.207   &lt;none&gt;        6790/TCP         13m</span><br><span class="line">rook-ceph-mon2                     ClusterIP   10.103.223.166   &lt;none&gt;        6790/TCP         12m</span><br></pre></td></tr></table></figure><blockquote><ul><li>可以见到这里暴露<code>30660</code>端口，通过此端口可以访问Dashboard</li></ul></blockquote><h3 id="添加StorageClass"><a href="#添加StorageClass" class="headerlink" title="添加StorageClass"></a>添加StorageClass</h3><blockquote><ul><li>添加<code>多副本</code>存储池</li><li>注释部分是创建<code>纠删码</code>存储池</li><li>添加<code>StorageClass</code>指定使用<code>多副本</code>存储池，格式化为<code>xfs</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; rbd-storageclass.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: ceph.rook.io/v1beta1</span><br><span class="line">kind: Pool</span><br><span class="line">metadata:</span><br><span class="line">  name: replicapool</span><br><span class="line">  namespace: rook-ceph</span><br><span class="line">spec:</span><br><span class="line">  replicated:</span><br><span class="line">    size: 3</span><br><span class="line"><span class="meta">  #</span><span class="bash"> For an erasure-coded pool, comment out the replication size above and uncomment the following settings.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Make sure you have enough OSDs to support the replica size or erasure code chunks.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">erasureCoded:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">  dataChunks: 2</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">  codingChunks: 1</span></span><br><span class="line">---</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">   name: rook-ceph-block</span><br><span class="line">provisioner: ceph.rook.io/block</span><br><span class="line">parameters:</span><br><span class="line">  pool: replicapool</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Specify the namespace of the rook cluster from <span class="built_in">which</span> to create volumes.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> If not specified, it will use `rook` as the default namespace of the cluster.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> This is also the namespace <span class="built_in">where</span> the cluster will be</span></span><br><span class="line">  clusterNamespace: rook-ceph</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Specify the filesystem <span class="built_in">type</span> of the volume. If not specified, it will use `ext4`.</span></span><br><span class="line">  fstype: xfs</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f rbd-storageclass.yaml</span><br></pre></td></tr></table></figure><blockquote><ul><li>还可以添加<code>cephFS</code>和<code>object</code>类型的存储池，然后创建对应的<code>StorageClass</code></li></ul></blockquote><p>具体可以看<a href="https://raw.githubusercontent.com/rook/rook/v0.8.3/cluster/examples/kubernetes/ceph/filesystem.yaml" target="_blank" rel="noopener">filesystem.yaml</a>和<a href="https://raw.githubusercontent.com/rook/rook/v0.8.3/cluster/examples/kubernetes/ceph/object.yaml" target="_blank" rel="noopener">object.yaml</a></p><h3 id="检查StorageClass"><a href="#检查StorageClass" class="headerlink" title="检查StorageClass"></a>检查StorageClass</h3><blockquote><ul><li>创建sc时，会在<code>rook-ceph</code>上创建对应的Pool</li><li>这里以<code>rbd-storageclass.yaml</code>为例</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME              PROVISIONER          AGE</span><br><span class="line">rook-ceph-block   ceph.rook.io/block   15m</span><br><span class="line"></span><br><span class="line">kubectl describe sc rook-ceph-block </span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">Name:            rook-ceph-block</span><br><span class="line">IsDefaultClass:  No</span><br><span class="line">Annotations:     kubectl.kubernetes.io/last-applied-configuration=&#123;"apiVersion":"storage.k8s.io/v1","kind":"StorageClass","metadata":&#123;"annotations":&#123;&#125;,"name":"rook-ceph-block","namespace":""&#125;,"parameters":&#123;"clusterNamespace":"rook-ceph","fstype":"xfs","pool":"replicapool"&#125;,"provisioner":"ceph.rook.io/block"&#125;</span><br><span class="line"></span><br><span class="line">Provisioner:           ceph.rook.io/block</span><br><span class="line">Parameters:            clusterNamespace=rook-ceph,fstype=xfs,pool=replicapool</span><br><span class="line">AllowVolumeExpansion:  &lt;unset&gt;</span><br><span class="line">MountOptions:          &lt;none&gt;</span><br><span class="line">ReclaimPolicy:         Delete</span><br><span class="line">VolumeBindingMode:     Immediate</span><br><span class="line">Events:                &lt;none&gt;</span><br><span class="line"></span><br><span class="line">kubectl -n rook-ceph exec -it rook-ceph-mon0-ll7fc -- ceph df</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">GLOBAL:</span><br><span class="line">    SIZE     AVAIL      RAW USED     %RAW USED </span><br><span class="line">    116G     96979M       22767M         19.01 </span><br><span class="line">POOLS:</span><br><span class="line">    NAME            ID     USED     %USED     MAX AVAIL     OBJECTS </span><br><span class="line">    replicapool     1         0         0        29245M           0</span><br></pre></td></tr></table></figure><h3 id="卸载Rook-ceph"><a href="#卸载Rook-ceph" class="headerlink" title="卸载Rook-ceph"></a>卸载Rook-ceph</h3><blockquote><ul><li>这里提供卸载的操作步骤，请按需操作！</li></ul></blockquote><h4 id="删除StorageClass"><a href="#删除StorageClass" class="headerlink" title="删除StorageClass"></a>删除StorageClass</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f rbd-storageclass.yaml</span><br></pre></td></tr></table></figure><h4 id="删除Rook-Ceph-Cluster"><a href="#删除Rook-Ceph-Cluster" class="headerlink" title="删除Rook-Ceph-Cluster"></a>删除Rook-Ceph-Cluster</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f cluster.yaml</span><br></pre></td></tr></table></figure><h4 id="删除Rook-Operator"><a href="#删除Rook-Operator" class="headerlink" title="删除Rook-Operator"></a>删除Rook-Operator</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f operator.yaml</span><br></pre></td></tr></table></figure><h4 id="清理目录"><a href="#清理目录" class="headerlink" title="清理目录"></a>清理目录</h4><blockquote><ul><li><font color="red">注意！</font>这里是所有运行rook-ceph集群的节点都需要做清理</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/lib/rook</span><br></pre></td></tr></table></figure><h2 id="Prometheus-Operator"><a href="#Prometheus-Operator" class="headerlink" title="Prometheus Operator"></a>Prometheus Operator</h2><h3 id="说明-6"><a href="#说明-6" class="headerlink" title="说明"></a>说明</h3><blockquote><ul><li>Prometheus Operator 是 CoreOS 开发的基于 Prometheus 的 Kubernetes 监控方案，也可能是目前功能最全面的开源方案。</li><li>Prometheus Operator 通过 Grafana 展示监控数据，预定义了一系列的 Dashboard</li><li>要求kubernetes版本大于等于<code>1.8.0</code></li><li><a href="https://github.com/coreos/prometheus-operator" target="_blank" rel="noopener">CoreOS/Prometheus-Operator项目地址</a></li></ul></blockquote><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><blockquote><ul><li>Prometheus 是一套开源的系统监控报警框架，启发于 Google 的 borgmon 监控系统，作为社区开源项目进行开发，并成为CNCF第二个毕业的项目（第一个是kubernetes）</li><li>特点<ul><li>强大的多维度数据模型</li><li>灵活而强大的查询语句（PromQL）</li><li>易于管理，高效</li><li>使用 pull 模式采集时间序列数据，这样不仅有利于本机测试而且可以避免有问题的服务器推送坏的 metrics。</li><li>可以采用 push gateway 的方式把时间序列数据推送至 Prometheus server 端</li><li>可以通过服务发现或者静态配置去获取监控的 targets</li><li>有多种可视化图形界面</li><li>易于伸缩</li></ul></li></ul></blockquote><h4 id="Prometheus组成架构"><a href="#Prometheus组成架构" class="headerlink" title="Prometheus组成架构"></a>Prometheus组成架构</h4><blockquote><ul><li><strong>Prometheus Server</strong>: 用于收集和存储时间序列数据</li><li><strong>Client Library</strong>: 客户端库，为需要监控的服务生成相应的 metrics 并暴露给<br>Prometheus server</li><li><strong>Push Gateway</strong>: 主要用于短期的 jobs。 jobs 可以直接向 Prometheus server 端推送它们的<br>metrics。这种方式主要用于服务层面的 metrics。</li><li><strong>Exporters</strong>: 用于暴露已有的第三方服务的 metrics 给 Prometheus。</li><li><strong>Alertmanager</strong>: 从 Prometheus server 端接收到 alerts<br>后，会进行去除重复数据，分组，并路由到对收的接受方式，发出报警。</li></ul></blockquote><h4 id="架构图-2"><a href="#架构图-2" class="headerlink" title="架构图"></a>架构图</h4><p><img src="https://prometheus.io/assets/architecture.png" alt=""></p><h3 id="Operator架构"><a href="#Operator架构" class="headerlink" title="Operator架构"></a>Operator架构</h3><blockquote><ul><li><p><strong>Operator</strong></p><p>即 Prometheus Operator，在 Kubernetes 中以 Deployment 运行。其职责是部署和管理<br>Prometheus Server，根据 ServiceMonitor 动态更新 Prometheus Server 的监控对象。</p></li><li><p><strong>Prometheus Server</strong></p><p>Prometheus Server 会作为 Kubernetes 应用部署到集群中。为了更好地在 Kubernetes 中管理 Prometheus，CoreOS 的开发人员专门定义了一个命名为 <code>Prometheus</code> 类型的 Kubernetes 定制化资源。我们可以把 <code>Prometheus</code>看作是一种特殊的 Deployment，它的用途就是专门部署 Prometheus Server。</p></li><li><p><strong>Service</strong></p><p>这里的<br>Service 就是 Cluster 中的 Service 资源，也是 Prometheus 要监控的对象，在 Prometheus 中叫做<br>Target。每个监控对象都有一个对应的 Service。比如要监控 Kubernetes Scheduler，就得有一个与 Scheduler<br>对应的 Service。当然，Kubernetes 集群默认是没有这个 Service 的，Prometheus Operator<br>会负责创建。</p></li><li><p><strong>ServiceMonitor</strong></p><p>Operator<br>能够动态更新 Prometheus 的 Target 列表，ServiceMonitor 就是 Target 的抽象。比如想监控<br>Kubernetes Scheduler，用户可以创建一个与 Scheduler Service 相映射的 ServiceMonitor<br>对象。Operator 则会发现这个新的 ServiceMonitor，并将 Scheduler 的 Target 添加到 Prometheus<br>的监控列表中。</p><p>ServiceMonitor 也是 Prometheus Operator 专门开发的一种 Kubernetes 定制化资源类型。</p></li><li><p><strong>Alertmanager</strong></p><p>除了 Prometheus 和 ServiceMonitor，Alertmanager 是 Operator 开发的第三种 Kubernetes 定制化资源。我们可以把 <code>Alertmanager</code> 看作是一种特殊的 Deployment，它的用途就是专门部署 Alertmanager 组件。</p></li></ul></blockquote><p><img src="https://github.com/coreos/prometheus-operator/raw/release-0.26/Documentation/user-guides/images/architecture.png" alt=""></p><h3 id="部署Prometheus-Operator"><a href="#部署Prometheus-Operator" class="headerlink" title="部署Prometheus-Operator"></a>部署Prometheus-Operator</h3><h4 id="切换工作目录-8"><a href="#切换工作目录-8" class="headerlink" title="切换工作目录"></a>切换工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/prometheus-operator</span><br><span class="line">cd /root/yaml/prometheus-operator</span><br></pre></td></tr></table></figure><h4 id="添加coreos源"><a href="#添加coreos源" class="headerlink" title="添加coreos源"></a>添加coreos源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加coreos源</span></span><br><span class="line">helm repo add coreos https://s3-eu-west-1.amazonaws.com/coreos-charts/stable/</span><br></pre></td></tr></table></figure><h4 id="创建命名空间"><a href="#创建命名空间" class="headerlink" title="创建命名空间"></a>创建命名空间</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace monitoring</span><br></pre></td></tr></table></figure><h4 id="部署prometheus-operator"><a href="#部署prometheus-operator" class="headerlink" title="部署prometheus-operator"></a>部署prometheus-operator</h4><blockquote><ul><li>这里通过<code>--set</code>指定了image的地址</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">helm install coreos/prometheus-operator \</span><br><span class="line">    --name coreos-prometheus-operator \</span><br><span class="line">    --namespace monitoring \</span><br><span class="line">    --set global.hyperkube.repository=zhangguanzhang/quay.io.coreos.hyperkube \</span><br><span class="line">    --set image.repository=zhangguanzhang/quay.io.coreos.prometheus-operator \</span><br><span class="line">    --set prometheusConfigReloader.repository=zhangguanzhang/quay.io.coreos.prometheus-config-reloader \</span><br><span class="line">    --set rbacEnable=true</span><br></pre></td></tr></table></figure><h4 id="部署kube-prometheus"><a href="#部署kube-prometheus" class="headerlink" title="部署kube-prometheus"></a>部署kube-prometheus</h4><blockquote><ul><li>通过运行<code>helm</code>命令安装时，指定一些变量来达到自定义配置的目的</li><li>定义<code>grafana</code>初始admin密码为<code>password</code>，默认值是<code>admin</code></li><li>定义<code>alertmanager</code>和<code>prometheus</code>使用名为<code>rook-ceph-block</code>的<code>StorageClass</code>，访问模式为<code>ReadWriteOnce</code>，大小<code>5Gi</code>，默认是<code>50Gi</code></li><li>定义<code>grafana</code>、<code>alertmanager</code>、<code>prometheus</code>的<code>Service</code>类型为<code>NodePort</code>，默认是<code>ClusterIP</code></li><li>这里的<code>--set</code>可以定义很多变量，具体可以在<a href="https://github.com/coreos/prometheus-operator/tree/master/helm" target="_blank" rel="noopener">这里</a>，查看里面每个文件夹的<code>values.yaml</code></li><li>这里<font color="red">配置的变量</font>请自己根据情况修改</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">helm install coreos/kube-prometheus \</span><br><span class="line">    --name kube-prometheus \</span><br><span class="line">    --namespace monitoring \</span><br><span class="line">    --set alertmanager.image.repository="zhangguanzhang/quay.io.prometheus.alertmanager" \</span><br><span class="line">    --set alertmanager.service.type="NodePort" \</span><br><span class="line">    --set alertmanager.storageSpec.volumeClaimTemplate.spec.storageClassName="rook-ceph-block" \</span><br><span class="line">    --set alertmanager.storageSpec.volumeClaimTemplate.spec.accessModes[0]="ReadWriteOnce" \</span><br><span class="line">    --set alertmanager.storageSpec.volumeClaimTemplate.spec.resources.requests.storage="5Gi" \</span><br><span class="line">    --set grafana.adminPassword="password" \</span><br><span class="line">    --set grafana.service.type="NodePort" \</span><br><span class="line">    --set prometheus.image.repository="zhangguanzhang/quay.io.prometheus.prometheus" \</span><br><span class="line">    --set prometheus.service.type="NodePort" \</span><br><span class="line">    --set prometheus.storageSpec.volumeClaimTemplate.spec.storageClassName="rook-ceph-block" \</span><br><span class="line">    --set prometheus.storageSpec.volumeClaimTemplate.spec.accessModes[0]="ReadWriteOnce" \</span><br><span class="line">    --set prometheus.storageSpec.volumeClaimTemplate.spec.resources.requests.storage="5Gi" \</span><br><span class="line">    --set prometheus.deployCoreDNS=true \</span><br><span class="line">    --set prometheus.deployKubeDNS=false \</span><br><span class="line">    --set prometheus.deployKubeEtcd=true \</span><br><span class="line">    --set exporter-kube-controller-manager.endpoints[0]="172.16.80.201" \</span><br><span class="line">    --set exporter-kube-controller-manager.endpoints[1]="172.16.80.202" \</span><br><span class="line">    --set exporter-kube-controller-manager.endpoints[2]="172.16.80.203" \</span><br><span class="line">    --set exporter-kube-etcd.etcdPort=2379 \</span><br><span class="line">    --set exporter-kube-etcd.scheme="https" \</span><br><span class="line">    --set exporter-kube-etcd.endpoints[0]="172.16.80.201" \</span><br><span class="line">    --set exporter-kube-etcd.endpoints[1]="172.16.80.202" \</span><br><span class="line">    --set exporter-kube-etcd.endpoints[2]="172.16.80.203" \</span><br><span class="line">    --set exporter-kube-scheduler.endpoints[0]="172.16.80.201" \</span><br><span class="line">    --set exporter-kube-scheduler.endpoints[1]="172.16.80.202" \</span><br><span class="line">    --set exporter-kube-scheduler.endpoints[2]="172.16.80.203" \</span><br><span class="line">    --set exporter-kube-state.kube_state_metrics.image.repository="gcrxio/kube-state-metrics" \</span><br><span class="line">    --set exporter-kube-state.addon_resizer.image.repository="gcrxio/addon-resizer"</span><br></pre></td></tr></table></figure><h4 id="检查部署情况-3"><a href="#检查部署情况-3" class="headerlink" title="检查部署情况"></a>检查部署情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n monitoring get all</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出示例</span></span><br><span class="line">NAME                                                       READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/alertmanager-kube-prometheus-0                         2/2       Running   0          43m</span><br><span class="line">pod/kube-prometheus-exporter-kube-state-66b8849c9b-cq5pp   2/2       Running   0          42m</span><br><span class="line">pod/kube-prometheus-exporter-node-p6z67                    1/1       Running   0          43m</span><br><span class="line">pod/kube-prometheus-exporter-node-qnmjt                    1/1       Running   0          43m</span><br><span class="line">pod/kube-prometheus-exporter-node-vr4sp                    1/1       Running   0          43m</span><br><span class="line">pod/kube-prometheus-grafana-f869c754-x5x7n                 2/2       Running   0          43m</span><br><span class="line">pod/prometheus-kube-prometheus-0                           3/3       Running   1          43m</span><br><span class="line">pod/prometheus-operator-5db9df7ffc-dxtqh                   1/1       Running   0          49m</span><br><span class="line"></span><br><span class="line">NAME                                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/alertmanager-operated                 ClusterIP   None             &lt;none&gt;        9093/TCP,6783/TCP   43m</span><br><span class="line">service/kube-prometheus                       NodePort    10.97.183.252    &lt;none&gt;        9090:30900/TCP      43m</span><br><span class="line">service/kube-prometheus-alertmanager          NodePort    10.105.140.173   &lt;none&gt;        9093:30903/TCP      43m</span><br><span class="line">service/kube-prometheus-exporter-kube-state   ClusterIP   10.108.236.146   &lt;none&gt;        80/TCP              43m</span><br><span class="line">service/kube-prometheus-exporter-node         ClusterIP   10.96.14.75      &lt;none&gt;        9100/TCP            43m</span><br><span class="line">service/kube-prometheus-grafana               NodePort    10.109.4.170     &lt;none&gt;        80:30164/TCP        43m</span><br><span class="line">service/prometheus-operated                   ClusterIP   None             &lt;none&gt;        9090/TCP            43m</span><br><span class="line"></span><br><span class="line">NAME                                           DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/kube-prometheus-exporter-node   3         3         3         3            3           &lt;none&gt;          43m</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/kube-prometheus-exporter-kube-state   1         1         1            1           43m</span><br><span class="line">deployment.apps/kube-prometheus-grafana               1         1         1            1           43m</span><br><span class="line">deployment.apps/prometheus-operator                   1         1         1            1           49m</span><br><span class="line"></span><br><span class="line">NAME                                                             DESIRED   CURRENT   READY     AGE</span><br><span class="line">replicaset.apps/kube-prometheus-exporter-kube-state-658f46b8dd   0         0         0         43m</span><br><span class="line">replicaset.apps/kube-prometheus-exporter-kube-state-66b8849c9b   1         1         1         42m</span><br><span class="line">replicaset.apps/kube-prometheus-grafana-f869c754                 1         1         1         43m</span><br><span class="line">replicaset.apps/prometheus-operator-5db9df7ffc                   1         1         1         49m</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   AGE</span><br><span class="line">statefulset.apps/alertmanager-kube-prometheus   1         1         43m</span><br><span class="line">statefulset.apps/prometheus-kube-prometheus     1         1         43m</span><br></pre></td></tr></table></figure><h3 id="访问Prometheus-Operator"><a href="#访问Prometheus-Operator" class="headerlink" title="访问Prometheus-Operator"></a>访问Prometheus-Operator</h3><blockquote><ul><li>部署时已经定义alertmanager、prometheus、grafana的Service为NodePort</li><li>根据检查部署的情况，得知<ul><li><code>kube-prometheus</code>的<code>NodePort</code>为<code>30900</code></li><li><code>kube-prometheus-alertmanager</code>的<code>NodePort</code>为<code>30903</code></li><li><code>kube-prometheus-grafana</code>的<code>NodePort</code>为<code>30164</code></li></ul></li><li>直接通过这些端口访问即可</li><li>grafana已内嵌了基础的Dashboard模板，以<code>admin</code>用户登录即可见</li></ul></blockquote><h2 id="EFK"><a href="#EFK" class="headerlink" title="EFK"></a>EFK</h2><h3 id="说明-7"><a href="#说明-7" class="headerlink" title="说明"></a>说明</h3><blockquote><ul><li>官方提供简单的<code>fluentd-elasticsearch</code>样例，可以作为测试用途</li><li>已经包含在<code>kubernetes</code>项目当中<a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch" target="_blank" rel="noopener">链接</a></li><li>这里使用<code>kubernetes-server-linux-amd64.tar.gz</code>里面的<code>kubernetes-src.tar.gz</code>提供的Addons</li><li>修改<code>elasticsearch</code>使用<code>rook-ceph</code>提供的<code>StorageClass</code>作为持久化存储，默认是使用<code>emptyDir</code></li></ul></blockquote><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a><font color="red">注意</font></h3><blockquote><ul><li>EFK集群部署之后，<code>kibana</code>和<code>elasticsearch</code>初始化过程会极大的消耗服务器资源</li><li>请保证你的环境能撑的住！！！！</li><li>配置不够，服务器真的会失去响应</li><li>实测3节点4C 16G SSD硬盘，CPU持续十几分钟的满载</li></ul></blockquote><h3 id="解压源代码"><a href="#解压源代码" class="headerlink" title="解压源代码"></a>解压源代码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tar xzf kubernetes-server-linux-amd64.tar.gz kubernetes/kubernetes-src.tar.gz</span><br><span class="line">cd kubernetes</span><br><span class="line">tar xzf kubernetes/kubernetes-src.tar.gz</span><br><span class="line">tar xzf kubernetes-src.tar.gz \</span><br><span class="line">cluster/addons/fluentd-elasticsearch/es-service.yaml \</span><br><span class="line">cluster/addons/fluentd-elasticsearch/es-statefulset.yaml \</span><br><span class="line">cluster/addons/fluentd-elasticsearch/fluentd-es-configmap.yaml \</span><br><span class="line">cluster/addons/fluentd-elasticsearch/fluentd-es-ds.yaml \</span><br><span class="line">cluster/addons/fluentd-elasticsearch/kibana-deployment.yaml \</span><br><span class="line">cluster/addons/fluentd-elasticsearch/kibana-service.yaml</span><br></pre></td></tr></table></figure><h3 id="切换工作目录-9"><a href="#切换工作目录-9" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd cluster/addons/fluentd-elasticsearch/</span><br></pre></td></tr></table></figure><h3 id="修改yaml文件-1"><a href="#修改yaml文件-1" class="headerlink" title="修改yaml文件"></a>修改yaml文件</h3><blockquote><ul><li>删除es-statefuleset.yaml里面的字段，位置大概在100行左右</li></ul></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">    emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><blockquote><ul><li>添加<code>volumeClaimTemplates</code>字段，声明使用<code>rook-ceph</code>提供的<code>StorageClass</code>，大小5Gi</li><li>位置在<code>StatefulSet.spec</code>，大概67行左右</li></ul></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">- metadata:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  spec:</span></span><br><span class="line"><span class="attr">    accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">    storageClassName:</span> <span class="string">"rook-ceph-block"</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><blockquote><ul><li>修改后，<code>es-statefulset.yaml</code>内容如下</li></ul></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RBAC authn and authz</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"services"</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"namespaces"</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"endpoints"</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"get"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">""</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Elasticsearch deployment itself</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">    version:</span> <span class="string">v5.6.4</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v5.6.4</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">  - metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">rook-ceph-block</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">        version:</span> <span class="string">v5.6.4</span></span><br><span class="line">        <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">gcrxio/elasticsearch:v5.6.4</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line">          <span class="comment"># need more cpu upon initialization, therefore burstable class</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">transport</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/data</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">"NAMESPACE"</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">elasticsearch-logging</span></span><br><span class="line"><span class="attr">        emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment"># Elasticsearch requires vm.max_map_count to be at least 262144.</span></span><br><span class="line">      <span class="comment"># If your OS already sets up this number to a higher value, feel free</span></span><br><span class="line">      <span class="comment"># to remove this init container.</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="attr">alpine:3.6</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["/sbin/sysctl",</span> <span class="string">"-w"</span><span class="string">,</span> <span class="string">"vm.max_map_count=262144"</span><span class="string">]</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">elasticsearch-logging-init</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><ul><li>注释<code>kibana-deployment.yaml</code>定义的环境变量</li><li>大概在35行左右</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> - name: SERVER_BASEPATH</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   value: /api/v1/namespaces/kube-system/services/kibana-logging/proxy</span></span><br></pre></td></tr></table></figure><h3 id="修改镜像地址-2"><a href="#修改镜像地址-2" class="headerlink" title="修改镜像地址"></a>修改镜像地址</h3><blockquote><ul><li>默认yaml定义的镜像地址是<code>k8s.gcr.io</code>，需要科学上网</li><li>变更成<code>gcrxio</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,k8s.gcr.io,gcrxio,g' -i *yaml</span><br></pre></td></tr></table></figure><h3 id="给节点打Label"><a href="#给节点打Label" class="headerlink" title="给节点打Label"></a>给节点打Label</h3><blockquote><ul><li><code>fluentd-es-ds.yaml</code>有<code>nodeSelector</code>字段定义了运行在带有<code>beta.kubernetes.io/fluentd-ds-ready: &quot;true&quot;</code>标签的节点上</li><li>这里为了方便，直接给所有节点都打上标签</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node --all beta.kubernetes.io/fluentd-ds-ready=true</span><br></pre></td></tr></table></figure><h3 id="部署EFK"><a href="#部署EFK" class="headerlink" title="部署EFK"></a>部署EFK</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure><h3 id="查看部署情况-1"><a href="#查看部署情况-1" class="headerlink" title="查看部署情况"></a>查看部署情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=elasticsearch-logging</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">elasticsearch-logging-0   1/1       Running   1          10m</span><br><span class="line">elasticsearch-logging-1   1/1       Running   0          10m</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system get pod -l k8s-app=kibana-logging</span><br><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">kibana-logging-56fb9d765-l95kj   1/1       Running   1          37m</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system get pod -l k8s-app=fluentd-es</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">fluentd-es-v2.0.4-2mwz7   1/1       Running   0          3m</span><br><span class="line">fluentd-es-v2.0.4-7mk4d   1/1       Running   0          3m</span><br><span class="line">fluentd-es-v2.0.4-zqtpc   1/1       Running   0          3m</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system get svc -l k8s-app=elasticsearch-logging</span><br><span class="line">NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">elasticsearch-logging   ClusterIP   10.111.107.21   &lt;none&gt;        9200/TCP   39m</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system get svc -l k8s-app=kibana-logging</span><br><span class="line">NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kibana-logging   ClusterIP   10.96.170.77   &lt;none&gt;        5601/TCP   39m</span><br></pre></td></tr></table></figure><h3 id="访问EFK"><a href="#访问EFK" class="headerlink" title="访问EFK"></a>访问EFK</h3><blockquote><ul><li>修改<code>elasticsearch</code>和<code>kibana</code>的<code>svc</code>为<code>nodePort</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -n kube-system svc elasticsearch-logging -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;'</span><br><span class="line">kubectl patch -n kube-system svc kibana-logging -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;'</span><br></pre></td></tr></table></figure><blockquote><ul><li>查看分配的<code>nodePort</code></li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get svc -l k8s-app=elasticsearch-logging</span><br><span class="line">NAME                    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">elasticsearch-logging   NodePort   10.111.107.21   &lt;none&gt;        9200:30542/TCP   42m</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system get svc -l k8s-app=kibana-logging</span><br><span class="line">NAME             TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kibana-logging   NodePort   10.96.170.77   &lt;none&gt;        5601:30998/TCP   42m</span><br></pre></td></tr></table></figure><blockquote><ul><li>可以看到端口分别为<code>30542</code>和<code>30998</code></li></ul></blockquote><h3 id="在github上获取yaml文件"><a href="#在github上获取yaml文件" class="headerlink" title="在github上获取yaml文件"></a>在github上获取yaml文件</h3><blockquote><ul><li>如果不想用<code>kubernetes-src.tar.gz</code>里面的Addons</li><li>可以直接下载github上面的文件，也是一样的</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/$&#123;KUBERNETES_VERSION&#125;/cluster/addons/fluentd-elasticsearch/es-service.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/$&#123;KUBERNETES_VERSION&#125;/cluster/addons/fluentd-elasticsearch/es-statefulset.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/$&#123;KUBERNETES_VERSION&#125;/cluster/addons/fluentd-elasticsearch/fluentd-es-configmap.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/$&#123;KUBERNETES_VERSION&#125;/cluster/addons/fluentd-elasticsearch/fluentd-es-ds.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/$&#123;KUBERNETES_VERSION&#125;/cluster/addons/fluentd-elasticsearch/kibana-deployment.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/$&#123;KUBERNETES_VERSION&#125;/cluster/addons/fluentd-elasticsearch/kibana-service.yaml</span><br></pre></td></tr></table></figure><h1 id="本文至此结束"><a href="#本文至此结束" class="headerlink" title="本文至此结束"></a>本文至此结束</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;更新记录&quot;&gt;&lt;a href=&quot;#更新记录&quot; class=&quot;headerlink&quot; title=&quot;更新记录&quot;&gt;&lt;/a&gt;更新记录&lt;/h1&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;2019年2月13日由于runc逃逸漏洞&lt;a href=&quot;https://www.anqu
      
    
    </summary>
    
    
      <category term="kubernetes docker" scheme="https://luanlengli.github.io/tags/kubernetes-docker/"/>
    
  </entry>
  
  <entry>
    <title>CentOS-7.6(1810)虚拟机模板制作</title>
    <link href="https://luanlengli.github.io/2018/12/05/CentOS-7-6-1810-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A8%A1%E6%9D%BF%E5%88%B6%E4%BD%9C.html"/>
    <id>https://luanlengli.github.io/2018/12/05/CentOS-7-6-1810-虚拟机模板制作.html</id>
    <published>2018-12-05T04:23:05.000Z</published>
    <updated>2019-04-17T02:45:49.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CentOS-7-6-1810-虚拟机模板制作"><a href="#CentOS-7-6-1810-虚拟机模板制作" class="headerlink" title="CentOS-7.6(1810)虚拟机模板制作"></a>CentOS-7.6(1810)虚拟机模板制作</h1><blockquote><ul><li>基于RHEL7.6的CentOS-7.6(1810)在12月初正式发布了</li><li><a href="https://wiki.centos.org/zh/Manuals/ReleaseNotes/CentOS7.1810" target="_blank" rel="noopener">发行注记</a></li><li>顺便更新一下虚拟机模板，这里记录一下操作过程。</li></ul></blockquote><h1 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h1><blockquote><ul><li>可以在CentOS官网下载，也可以通过国内镜像源下载</li><li>下载镜像名<code>CentOS-7-x86_64-Minimal-1810.iso</code></li><li><a href="http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso" target="_blank" rel="noopener">CentOS官网下载链接</a></li><li><a href="https://mirrors.aliyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso" target="_blank" rel="noopener">阿里云下载链接</a></li></ul></blockquote><h1 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h1><blockquote><ul><li>这里使用VMware Workstation 14 Pro 版本号14.1.3 build-9474260</li><li>虚拟机规格<ul><li>客户机操作系统版本<code>Red Hat Enterprise Linux 7 64 位</code></li><li>处理器数量1</li><li>内存2GB</li><li>硬盘40GB</li><li>网络适配器<code>NAT模式</code></li></ul></li></ul></blockquote><h1 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h1><blockquote><ul><li>语言选择<code>English</code></li><li>软件包选择<code>Minimal Install</code></li><li>硬盘分区<ul><li>/dev/sda1<code>boot分区、1GB、EXT4</code></li><li>/dev/sda2<code>/分区、39GB、XFS</code></li><li>这里不使用swap分区，有需要可以自己增加swap分区</li></ul></li><li>网络设置<ul><li>NAT地址段为<code>172.16.80.0/24</code></li><li>这里设置为<ul><li>IP地址<code>172.16.80.200</code></li><li>子网掩码<code>255.255.255.0</code></li><li>网关<code>172.16.80.2</code></li><li>DNS<code>114.114.114.114</code></li></ul></li></ul></li><li>时区选择<code>Asia/Shanghai</code></li><li>打开网络对时</li><li>KDUMP看情况选择<code>打开</code>或者<code>关闭</code>，这里我选择<code>关闭</code></li><li>设置ROOT密码</li></ul></blockquote><h1 id="操作系统启动后初始化设置"><a href="#操作系统启动后初始化设置" class="headerlink" title="操作系统启动后初始化设置"></a>操作系统启动后初始化设置</h1><h2 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's,SELINUX=enforcing,SELINUX=disabled,' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl mask firewalld</span><br></pre></td></tr></table></figure><h2 id="清空iptables规则"><a href="#清空iptables规则" class="headerlink" title="清空iptables规则"></a>清空iptables规则</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -Z</span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure><h2 id="配置ssh证书登录"><a href="#配置ssh证书登录" class="headerlink" title="配置ssh证书登录"></a>配置ssh证书登录</h2><blockquote><ul><li>通过ssh命令生成密钥对</li><li>将~/.ssh/id_rsa.pub提取出来</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 2048 -N "" -f ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure><h2 id="添加sysctl参数"><a href="#添加sysctl参数" class="headerlink" title="添加sysctl参数"></a>添加sysctl参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/99-centos.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件句柄数</span></span><br><span class="line">fs.file-max=1024000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在CentOS7.4引入了一个新的参数来控制内核的行为。 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /proc/sys/fs/may_detach_mounts 默认设置为0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当系统有容器运行的时候，需要将该值设置为1。</span></span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大文件打开数</span></span><br><span class="line">fs.nr_open=1024000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭严格校验数据包的反向路径</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改动态NAT跟踪记录参数</span></span><br><span class="line">net.netfilter.nf_conntrack_max = 655350</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加快系统关闭处于 FIN_WAIT2 状态的 TCP 连接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统中处于 SYN_RECV 状态的 TCP 连接数量</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内核中管理 TIME_WAIT 状态的数量</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口最大的监听队列的长度</span></span><br><span class="line">net.core.somaxconn=4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开ipv4数据包转发</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许应用程序能够绑定到不属于本地网卡的地址</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存耗尽才使用swap分区</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom = 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改limits参数"><a href="#修改limits参数" class="headerlink" title="修改limits参数"></a>修改limits参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/99-centos.conf &lt;&lt;EOF</span><br><span class="line">* soft nproc 1024000</span><br><span class="line">* hard nproc 1024000</span><br><span class="line">* soft nofile 1024000</span><br><span class="line">* hard nofile 1024000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改journal设置"><a href="#修改journal设置" class="headerlink" title="修改journal设置"></a>修改journal设置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,^#Compress=yes,Compress=yes,' \</span><br><span class="line">    -e 's,^#SystemMaxUse=,SystemMaxUse=1G,' \</span><br><span class="line">    -e 's,^#Seal=yes,Seal=yes,' \</span><br><span class="line">    -e 's,^#RateLimitBurst=1000,RateLimitBurst=2000,' \</span><br><span class="line">    -i /etc/systemd/journald.conf</span><br></pre></td></tr></table></figure><h2 id="修改终端提示符"><a href="#修改终端提示符" class="headerlink" title="修改终端提示符"></a>修改终端提示符</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export PS1='[\t]\[\033[1;31m\]&lt;\u@\h:\w&gt;\[\033[0m\]\$ '</span><br><span class="line">cat &gt;&gt; /root/.bashrc &lt;&lt; EOF</span><br><span class="line">export PS1='[\t]\[\033[1;31m\]&lt;\u@\h:\w&gt;\[\033[0m\]\\$ '</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="修改网卡配置信息"><a href="#修改网卡配置信息" class="headerlink" title="修改网卡配置信息"></a>修改网卡配置信息</h2><blockquote><ul><li>CentOS安装设置网卡后，会添加很多不需要的字段，例如UUID、HWADDR什么的</li><li>删减后字段信息如下</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysconfig/network-scripts/ifcfg-ens33 </span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">NAME=ens33</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=172.16.80.200</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=172.16.80.2</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">NM_CONTROLLED=no</span><br><span class="line">USERCTL=no</span><br></pre></td></tr></table></figure><h2 id="更新软件包"><a href="#更新软件包" class="headerlink" title="更新软件包"></a>更新软件包</h2><blockquote><ul><li>通常来说，安装完操作系统，都需要更新一下软件包</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure><h2 id="安装常用软件包"><a href="#安装常用软件包" class="headerlink" title="安装常用软件包"></a>安装常用软件包</h2><blockquote><ul><li>CentOS最小化安装不能满足我的使用，需要额外安装一些软件包</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum groups install base -y</span><br><span class="line">yum install epel-release -y</span><br><span class="line">yum install redhat-lsb vim ipvsadm tree dstat iotop htop socat ipset conntrack bash-completion-extras -y</span><br></pre></td></tr></table></figure><h2 id="添加vim设置（可选）"><a href="#添加vim设置（可选）" class="headerlink" title="添加vim设置（可选）"></a>添加vim设置（可选）</h2><blockquote><ul><li>将vim设置写入<code>~/.vimrc</code>文件</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/.vimrc &lt;&lt;EOF</span><br><span class="line">" 显示行号</span><br><span class="line">set number</span><br><span class="line">" 高亮光标所在行</span><br><span class="line">set cursorline</span><br><span class="line">" 打开语法显示</span><br><span class="line">syntax on</span><br><span class="line">" 关闭备份</span><br><span class="line">set nobackup</span><br><span class="line">" 没有保存或文件只读时弹出确认</span><br><span class="line">set confirm</span><br><span class="line">" tab缩进</span><br><span class="line">set tabstop=4</span><br><span class="line">set shiftwidth=4</span><br><span class="line">set expandtab</span><br><span class="line">set smarttab</span><br><span class="line">" 默认缩进4个空格大小 </span><br><span class="line">set shiftwidth=4 </span><br><span class="line">" 文件自动检测外部更改</span><br><span class="line">set autoread</span><br><span class="line">" 高亮查找匹配</span><br><span class="line">set hlsearch</span><br><span class="line">" 显示匹配</span><br><span class="line">set showmatch</span><br><span class="line">" 背景色设置为黑色</span><br><span class="line">set background=dark</span><br><span class="line">" 浅色高亮显示当前行</span><br><span class="line">autocmd InsertLeave * se nocul</span><br><span class="line">" 显示输入的命令</span><br><span class="line">set showcmd</span><br><span class="line">" 字符编码</span><br><span class="line">set encoding=utf-8</span><br><span class="line">" 开启终端256色显示</span><br><span class="line">set t_Co=256</span><br><span class="line">" 增量式搜索 </span><br><span class="line">set incsearch</span><br><span class="line">" 设置默认进行大小写不敏感查找</span><br><span class="line">set ignorecase</span><br><span class="line">" 如果有一个大写字母，则切换到大小写敏感查找</span><br><span class="line">set smartcase</span><br><span class="line">" 不产生swap文件</span><br><span class="line">set noswapfile</span><br><span class="line">" 关闭提示音</span><br><span class="line">set noerrorbells</span><br><span class="line">" 历史记录</span><br><span class="line">set history=10000</span><br><span class="line">" 显示行尾空格</span><br><span class="line">set listchars=tab:»■,trail:■</span><br><span class="line">" 显示非可见字符</span><br><span class="line">set list</span><br><span class="line">" c文件自动缩进</span><br><span class="line">set cindent</span><br><span class="line">" 文件自动缩进</span><br><span class="line">set autoindent</span><br><span class="line">" 检测文件类型</span><br><span class="line">filetype on</span><br><span class="line">" 智能缩进</span><br><span class="line">set smartindent</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="编写ipvs模块启动关闭脚本（可选）"><a href="#编写ipvs模块启动关闭脚本（可选）" class="headerlink" title="编写ipvs模块启动关闭脚本（可选）"></a>编写ipvs模块启动关闭脚本（可选）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动脚本</span></span><br><span class="line">cat &gt; /usr/local/bin/enable_ipvs.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"</span><br><span class="line">for kernel_module in \$&#123;ipvs_modules&#125;; do</span><br><span class="line">    /sbin/modinfo -F filename \$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe \$&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 /usr/local/bin/enable_ipvs.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 关闭脚本</span></span><br><span class="line">cat &gt; /usr/local/bin/disable_ipvs.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"</span><br><span class="line">for kernel_module in \$&#123;ipvs_modules&#125;; do</span><br><span class="line">    /sbin/modinfo -F filename \$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe -r \$&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 /usr/local/bin/disable_ipvs.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 开机启动脚本</span></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"</span><br><span class="line">for kernel_module in \$&#123;ipvs_modules&#125;; do</span><br><span class="line">    /sbin/modinfo -F filename \$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe \$&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules</span><br></pre></td></tr></table></figure><h2 id="安装docker（可选）"><a href="#安装docker（可选）" class="headerlink" title="安装docker（可选）"></a>安装docker（可选）</h2><blockquote><ul><li>版本可以自行选择自带的Docker1.13或者docker-ce</li><li>这里以docker-ce 18.03版本为例</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除原有的Docker包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖包</span></span><br><span class="line">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine -y</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 -y</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加Docker-CE YUM源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改Docker—CE源地址</span></span><br><span class="line">sed -e 's,https://download.docker.com,https://mirrors.ustc.edu.cn/docker-ce,g' -i /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装Docker-CE 18.03</span></span><br><span class="line">yum install docker-ce-18.03.1.ce -y</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置docker</span></span><br><span class="line">mkdir -p /etc/docker</span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash">/etc/docker/daemon.json&lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["https://registry.docker-cn.com"],</span><br><span class="line">    "insecure-registries": [],</span><br><span class="line">    "log-driver": "json-file",</span><br><span class="line">    "log-opts": &#123;</span><br><span class="line">        "max-size": "10m",</span><br><span class="line">        "max-file": "3"</span><br><span class="line">    &#125;,</span><br><span class="line">    "max-concurrent-downloads": 10</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="修改HISTORY参数"><a href="#修改HISTORY参数" class="headerlink" title="修改HISTORY参数"></a>修改HISTORY参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/profile &lt;&lt;EOF</span><br><span class="line">export HISTSIZE=10000</span><br><span class="line">export HISTFILESIZE=10000</span><br><span class="line">export HISTCONTROL=ignoredups</span><br><span class="line">export HISTTIMEFORMAT="`whoami` %F %T "</span><br><span class="line">export HISTIGNORE="ls:pwd:"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="清理现场"><a href="#清理现场" class="headerlink" title="清理现场"></a>清理现场</h1><h3 id="清理yum缓存"><a href="#清理yum缓存" class="headerlink" title="清理yum缓存"></a>清理yum缓存</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br></pre></td></tr></table></figure><h3 id="关闭操作系统"><a href="#关闭操作系统" class="headerlink" title="关闭操作系统"></a>关闭操作系统</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history -c &amp;&amp; sys-unconfig</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CentOS-7-6-1810-虚拟机模板制作&quot;&gt;&lt;a href=&quot;#CentOS-7-6-1810-虚拟机模板制作&quot; class=&quot;headerlink&quot; title=&quot;CentOS-7.6(1810)虚拟机模板制作&quot;&gt;&lt;/a&gt;CentOS-7.6(1810)虚
      
    
    </summary>
    
    
      <category term="linux" scheme="https://luanlengli.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>hello world~</title>
    <link href="https://luanlengli.github.io/2018/12/01/hello-world.html"/>
    <id>https://luanlengli.github.io/2018/12/01/hello-world.html</id>
    <published>2018-12-01T04:50:07.000Z</published>
    <updated>2018-12-09T06:07:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>参考了<a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">Hexo文档</a>，简单搭建完hexo之后，又花了一些时间来调整主题什么的。</p><p>慢慢会将以前积累的文档，放到这里来。</p><p>用<code>输出</code>倒逼<code>输入</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;参考了&lt;a href=&quot;https://hexo.io/zh-cn/docs/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo文档&lt;/a&gt;，简单搭建完hexo之后，又花了一些时间来调整主题什么的。&lt;/p&gt;&lt;p&gt;慢慢会将以前积累的
      
    
    </summary>
    
    
      <category term="杂谈" scheme="https://luanlengli.github.io/tags/%E6%9D%82%E8%B0%88/"/>
    
  </entry>
  
</feed>
