<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Kubernetes,TiDB,"><meta name="description" content="说明仅记录操作过程和部署过程操作系统使用的CentOS-7.6.1810 x86_64虚拟机配置4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘BKubernetes集群版本v1.14.4使用本地PV作为数据存储TiDB-Operator版本v1.0.0TiDB组件版本v3.0.1服务器拓扑服务器IP部署实例172.16.80.201TiKv*1 TiDB*1 PD*1172.16.8"><meta name="keywords" content="Kubernetes,TiDB"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes部署TiDB数据库集群"><meta property="og:url" content="https://luanlengli.github.io/2019/07/29/Kubernetes部署TiDB数据库集群.html"><meta property="og:site_name" content="luanlengli&#39;s Blog"><meta property="og:description" content="说明仅记录操作过程和部署过程操作系统使用的CentOS-7.6.1810 x86_64虚拟机配置4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘BKubernetes集群版本v1.14.4使用本地PV作为数据存储TiDB-Operator版本v1.0.0TiDB组件版本v3.0.1服务器拓扑服务器IP部署实例172.16.80.201TiKv*1 TiDB*1 PD*1172.16.8"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-08-04T03:47:24.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kubernetes部署TiDB数据库集群"><meta name="twitter:description" content="说明仅记录操作过程和部署过程操作系统使用的CentOS-7.6.1810 x86_64虚拟机配置4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘BKubernetes集群版本v1.14.4使用本地PV作为数据存储TiDB-Operator版本v1.0.0TiDB组件版本v3.0.1服务器拓扑服务器IP部署实例172.16.80.201TiKv*1 TiDB*1 PD*1172.16.8"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://luanlengli.github.io/2019/07/29/Kubernetes部署TiDB数据库集群.html"><title>Kubernetes部署TiDB数据库集群 | luanlengli's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">luanlengli's Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">“不知道”的五大理由，不读，不查，不试，理解能力差，满脑子想着怎么利用他人</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://luanlengli.github.io/2019/07/29/Kubernetes部署TiDB数据库集群.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="乱愣黎"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="luanlengli's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Kubernetes部署TiDB数据库集群</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-29T14:29:58+08:00">2019-07-29 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于&#58;</span> <time title="更新于" itemprop="dateModified" datetime="2019-08-04T11:47:24+08:00">2019-08-04 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/TiDB/" itemprop="url" rel="index"><span itemprop="name">TiDB</span> </a></span></span><span id="/2019/07/29/Kubernetes部署TiDB数据库集群.html" class="leancloud_visitors" data-flag-title="Kubernetes部署TiDB数据库集群"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数&#58;</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">5.2k</span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul><li>仅记录操作过程和部署过程</li><li>操作系统使用的<code>CentOS-7.6.1810 x86_64</code></li><li>虚拟机配置<code>4CPU 8G内存 30G系统盘 20G数据盘A 5G数据盘B</code></li><li>Kubernetes集群版本<code>v1.14.4</code></li><li>使用本地PV作为数据存储</li><li>TiDB-Operator版本<code>v1.0.0</code></li><li>TiDB组件版本<code>v3.0.1</code></li></ul><h2 id="服务器拓扑"><a href="#服务器拓扑" class="headerlink" title="服务器拓扑"></a>服务器拓扑</h2><table><thead><tr><th>服务器IP</th><th>部署实例</th></tr></thead><tbody><tr><td>172.16.80.201</td><td>TiKv*1 TiDB*1 PD*1</td></tr><tr><td>172.16.80.202</td><td>TiKv*1 TiDB*1 PD*1</td></tr><tr><td>172.16.80.203</td><td>TiKv*1 TiDB*1 PD*1</td></tr></tbody></table><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h2><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz | tar xz linux-amd64/helm</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure><h3 id="创建RBAC"><a href="#创建RBAC" class="headerlink" title="创建RBAC"></a>创建RBAC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl apply -f -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建名为tiller的ServiceAccount</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span><span class="bash"> 给tiller绑定cluster-admin权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller-cluster-rule</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="安装Helm服务端"><a href="#安装Helm服务端" class="headerlink" title="安装Helm服务端"></a>安装Helm服务端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm init --tiller-image gcr.azk8s.cn/google_containers/tiller:v2.14.1 \</span><br><span class="line">          --service-account tiller \</span><br><span class="line">          --stable-repo-url http://mirror.azure.cn/kubernetes/charts/</span><br></pre></td></tr></table></figure><h3 id="检查部署结果"><a href="#检查部署结果" class="headerlink" title="检查部署结果"></a>检查部署结果</h3><h4 id="查看Pod状态"><a href="#查看Pod状态" class="headerlink" title="查看Pod状态"></a>查看Pod状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l app=helm,name=tiller</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-84fc6cd5f9-nz4m7   1/1       Running   0          1m</span><br></pre></td></tr></table></figure><h4 id="查看Helm版本信息"><a href="#查看Helm版本信息" class="headerlink" title="查看Helm版本信息"></a>查看Helm版本信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm version</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:"v2.14.1", GitCommit:"d325d2a9c179b33af1a024cdb5a4472b6288016a", GitTreeState:"clean"&#125;</span><br></pre></td></tr></table></figure><h2 id="添加Helm-Repo"><a href="#添加Helm-Repo" class="headerlink" title="添加Helm Repo"></a>添加Helm Repo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add pingcap https://charts.pingcap.org/</span><br></pre></td></tr></table></figure><h2 id="更新helm缓存"><a href="#更新helm缓存" class="headerlink" title="更新helm缓存"></a>更新helm缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure><h2 id="查看TiDB-Operator版本"><a href="#查看TiDB-Operator版本" class="headerlink" title="查看TiDB-Operator版本"></a>查看TiDB-Operator版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search pingcap -l</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME                 	CHART VERSION	APP VERSION	DESCRIPTION                            </span><br><span class="line">pingcap/tidb-backup  	v1.0.0       	           	A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  	v1.0.0-rc.1  	           	A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  	v1.0.0-beta.3	           	A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-backup  	v1.0.0-beta.2	           	A Helm chart for TiDB Backup or Restore</span><br><span class="line">pingcap/tidb-cluster 	v1.0.0       	           	A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster 	v1.0.0-rc.1  	           	A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster 	v1.0.0-beta.3	           	A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-cluster 	v1.0.0-beta.2	           	A Helm chart for TiDB Cluster          </span><br><span class="line">pingcap/tidb-operator	v1.0.0       	           	tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operator	v1.0.0-rc.1  	           	tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operator	v1.0.0-beta.3	           	tidb-operator Helm chart for Kubernetes</span><br><span class="line">pingcap/tidb-operator	v1.0.0-beta.2	           	tidb-operator Helm chart for Kubernetes</span><br></pre></td></tr></table></figure><h2 id="配置本地PV"><a href="#配置本地PV" class="headerlink" title="配置本地PV"></a>配置本地PV</h2><p>参考【<a href="https://luanlengli.github.io/2019/07/23/Kubernetes创建本地PV.html">Kubernetes创建本地PV</a>】</p><p><font color="red">修改ext4挂载选项</font>为<code>defaults,nodelalloc,noatime</code></p><blockquote><p>示例如下</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=f8727d20-3ef9-4f83-b865-25943bc342a6 /mnt/disks/f8727d20-3ef9-4f83-b865-25943bc342a6 ext4 defaults,nodelalloc,noatime 0 2</span><br></pre></td></tr></table></figure><h2 id="创建CRD"><a href="#创建CRD" class="headerlink" title="创建CRD"></a>创建CRD</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/crd.yaml</span><br></pre></td></tr></table></figure><h1 id="部署TiDB-Operator"><a href="#部署TiDB-Operator" class="headerlink" title="部署TiDB-Operator"></a>部署TiDB-Operator</h1><h2 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/TiDB</span><br></pre></td></tr></table></figure><h2 id="下载TiDB-Operator-Chart包"><a href="#下载TiDB-Operator-Chart包" class="headerlink" title="下载TiDB-Operator Chart包"></a>下载TiDB-Operator Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/TiDB</span><br><span class="line">helm fetch pingcap/tidb-operator --version=v1.0.0</span><br></pre></td></tr></table></figure><h2 id="解压Chart包"><a href="#解压Chart包" class="headerlink" title="解压Chart包"></a>解压Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf tidb-operator-v1.0.0.tgz</span><br></pre></td></tr></table></figure><h2 id="编辑values-yaml"><a href="#编辑values-yaml" class="headerlink" title="编辑values.yaml"></a>编辑values.yaml</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default values for tidb-operator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clusterScoped is whether tidb-operator should manage kubernetes cluster wide tidb clusters</span></span><br><span class="line"><span class="comment"># Also see rbac.create and controllerManager.serviceAccount</span></span><br><span class="line"><span class="attr">clusterScoped:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Also see clusterScoped and controllerManager.serviceAccount</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># operatorImage is TiDB Operator image</span></span><br><span class="line"><span class="attr">operatorImage:</span> <span class="string">pingcap/tidb-operator:v1.0.0</span></span><br><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">defaultStorageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line"><span class="attr">controllerManager:</span></span><br><span class="line">  <span class="comment"># With rbac.create=false, the user is responsible for creating this account</span></span><br><span class="line">  <span class="comment"># With rbac.create=true, this service account will be created</span></span><br><span class="line">  <span class="comment"># Also see rbac.create and clusterScoped</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">tidb-controller-manager</span></span><br><span class="line"><span class="attr">  logLevel:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line">  <span class="comment"># autoFailover is whether tidb-operator should auto failover when failure occurs</span></span><br><span class="line"><span class="attr">  autoFailover:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># pd failover period default(5m)</span></span><br><span class="line"><span class="attr">  pdFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line">  <span class="comment"># tikv failover period default(5m)</span></span><br><span class="line"><span class="attr">  tikvFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line">  <span class="comment"># tidb failover period default(5m)</span></span><br><span class="line"><span class="attr">  tidbFailoverPeriod:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="comment"># With rbac.create=false, the user is responsible for creating this account</span></span><br><span class="line">  <span class="comment"># With rbac.create=true, this service account will be created</span></span><br><span class="line">  <span class="comment"># Also see rbac.create and clusterScoped</span></span><br><span class="line"><span class="attr">  serviceAccount:</span> <span class="string">tidb-scheduler</span></span><br><span class="line"><span class="attr">  logLevel:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  schedulerName:</span> <span class="string">tidb-scheduler</span></span><br><span class="line">  <span class="comment"># features:</span></span><br><span class="line">  <span class="comment"># - StableScheduling=true</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">  kubeSchedulerImageName:</span> <span class="string">gcr.azk8s.cn/google_containers/kube-scheduler</span></span><br><span class="line">  <span class="comment"># This will default to matching your kubernetes version</span></span><br><span class="line">  <span class="comment"># kubeSchedulerImageTag:</span></span><br></pre></td></tr></table></figure><h2 id="部署Operator"><a href="#部署Operator" class="headerlink" title="部署Operator"></a>部署Operator</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install pingcap/tidb-operator \</span><br><span class="line">     --name=tidb-operator \</span><br><span class="line">     --namespace=tidb-admin \</span><br><span class="line">     --version=v1.0.0 \</span><br><span class="line">     -f /home/tidb/tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Operator部署情况"><a href="#查看Operator部署情况" class="headerlink" title="查看Operator部署情况"></a>查看Operator部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb-admin get pod -l app.kubernetes.io/name=tidb-operator</span><br></pre></td></tr></table></figure><h1 id="部署TiDB-Cluster"><a href="#部署TiDB-Cluster" class="headerlink" title="部署TiDB-Cluster"></a>部署TiDB-Cluster</h1><h2 id="创建工作目录-1"><a href="#创建工作目录-1" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/TiDB</span><br></pre></td></tr></table></figure><h2 id="下载Chart包"><a href="#下载Chart包" class="headerlink" title="下载Chart包"></a>下载Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/TiDB</span><br><span class="line">helm fetch pingcap/tidb-cluster --version=v1.0.0</span><br></pre></td></tr></table></figure><h2 id="解压Chart包-1"><a href="#解压Chart包-1" class="headerlink" title="解压Chart包"></a>解压Chart包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzf tidb-cluster-v1.0.0.tgz</span><br></pre></td></tr></table></figure><h2 id="编辑values-yaml-1"><a href="#编辑values-yaml-1" class="headerlink" title="编辑values.yaml"></a>编辑values.yaml</h2><p>配置含义请看这里【<a href="https://pingcap.com/docs-cn/v3.0/tidb-in-kubernetes/reference/configuration/tidb-cluster/" target="_blank" rel="noopener">Kubernetes 上的 TiDB 集群配置</a>】</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim tidb-cluster/values.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改后如下</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default values for tidb-cluster.</span></span><br><span class="line"><span class="comment"># This is a YAML-formatted file.</span></span><br><span class="line"><span class="comment"># Declare variables to be passed into your templates.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Also see monitor.serviceAccount</span></span><br><span class="line"><span class="comment"># If you set rbac.create to false, you need to provide a value for monitor.serviceAccount</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clusterName is the TiDB cluster name, if not specified, the chart release name will be used</span></span><br><span class="line"><span class="comment"># clusterName: demo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add additional TidbCluster labels</span></span><br><span class="line"><span class="comment"># ref: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/</span></span><br><span class="line"><span class="attr">extraLabels:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># schedulerName must be same with charts/tidb-operator/values#scheduler.schedulerName</span></span><br><span class="line"><span class="attr">schedulerName:</span> <span class="string">tidb-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># timezone is the default system timzone for TiDB</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default reclaim policy of a PV</span></span><br><span class="line"><span class="attr">pvReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># services is the service list to expose, default is ClusterIP</span></span><br><span class="line"><span class="comment"># can be ClusterIP | NodePort | LoadBalancer</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">pd</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tidb-operator:v1.0.0</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">150</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">80</span><span class="string">m</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Whether enable ConfigMap Rollout management.</span></span><br><span class="line"><span class="comment"># When enabling, change of ConfigMap will trigger a graceful rolling-update of the component.</span></span><br><span class="line"><span class="comment"># This feature is only available in tidb-operator v1.0 or higher.</span></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> Switch this variable against an existing cluster will cause an rolling-update of each component even</span></span><br><span class="line"><span class="comment"># if the ConfigMap was not changed.</span></span><br><span class="line"><span class="attr">enableConfigMapRollout:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pd:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/pingcap/pd/blob/master/conf/config.toml for the default</span></span><br><span class="line">  <span class="comment"># pd configurations (change to the tags of your pd version), </span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/pd-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your pd) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [log]</span></span><br><span class="line"><span class="string">    level = "info"</span></span><br><span class="line"><span class="string">    [replication]</span></span><br><span class="line"><span class="string">    location-labels = ["region", "zone", "rack", "host"]</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/pd:v3.0.1</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 8000m</span></span><br><span class="line">    <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line">      <span class="comment"># cpu: 4000m</span></span><br><span class="line">      <span class="comment"># memory: 4Gi</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines pd scheduling rules,it's default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment">## The following is typical example of affinity settings:</span></span><br><span class="line">  <span class="comment">## The PodAntiAffinity setting of the example keeps PD pods does not co-locate on a topology node as far as possible to improve the disaster tolerance of PD on Kubernetes.</span></span><br><span class="line">  <span class="comment">## The NodeAffinity setting of the example ensure that the PD pods can only be scheduled to nodes with label:[type="pd"],</span></span><br><span class="line">  <span class="comment"># affinity:</span></span><br><span class="line">  <span class="comment">#   podAntiAffinity:</span></span><br><span class="line">  <span class="comment">#     preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named region</span></span><br><span class="line">  <span class="comment">#     - weight: 10</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "region"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named zone</span></span><br><span class="line">  <span class="comment">#     - weight: 20</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "zone"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named rack</span></span><br><span class="line">  <span class="comment">#     - weight: 40</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "rack"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#     # this term work when the nodes have the label named kubernetes.io/hostname</span></span><br><span class="line">  <span class="comment">#     - weight: 80</span></span><br><span class="line">  <span class="comment">#       podAffinityTerm:</span></span><br><span class="line">  <span class="comment">#         labelSelector:</span></span><br><span class="line">  <span class="comment">#           matchLabels:</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/instance: &lt;release name&gt;</span></span><br><span class="line">  <span class="comment">#             app.kubernetes.io/component: "pd"</span></span><br><span class="line">  <span class="comment">#         topologyKey: "kubernetes.io/hostname"</span></span><br><span class="line">  <span class="comment">#         namespaces:</span></span><br><span class="line">  <span class="comment">#         - &lt;helm namespace&gt;</span></span><br><span class="line">  <span class="comment">#   nodeAffinity:</span></span><br><span class="line">  <span class="comment">#     requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">  <span class="comment">#       nodeSelectorTerms:</span></span><br><span class="line">  <span class="comment">#       - matchExpressions:</span></span><br><span class="line">  <span class="comment">#         - key: "kind"</span></span><br><span class="line">  <span class="comment">#           operator: In</span></span><br><span class="line">  <span class="comment">#           values:</span></span><br><span class="line">  <span class="comment">#           - "pd"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tikv:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/tikv/tikv/blob/master/etc/config-template.toml for the default</span></span><br><span class="line">  <span class="comment"># tikv configurations (change to the tags of your tikv version),</span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/tikv-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your tikv) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    log-level = "info"</span></span><br><span class="line"><span class="string">    [server]</span></span><br><span class="line"><span class="string">    status-addr = "0.0.0.0:20180"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Here are some parameters you may want to customize (Please configure in the above 'config' section):</span></span><br><span class="line"><span class="string">  # [readpool.storage]</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for high-priority operations.</span></span><br><span class="line"><span class="string">  # # high-concurrency = 4</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for normal-priority operations.</span></span><br><span class="line"><span class="string">  # # normal-concurrency = 4</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for low-priority operations.</span></span><br><span class="line"><span class="string">  # # low-concurrency = 4</span></span><br><span class="line"><span class="string">  # [readpool.coprocessor]</span></span><br><span class="line"><span class="string">  # ## Most read requests from TiDB are sent to the coprocessor of TiKV. high/normal/low-concurrency is</span></span><br><span class="line"><span class="string">  # ## used to set the number of threads of the coprocessor.</span></span><br><span class="line"><span class="string">  # ## If there are many read requests, you can increase these config values (but keep it within the</span></span><br><span class="line"><span class="string">  # ## number of system CPU cores). For example, for a 32-core machine deployed with TiKV, you can even</span></span><br><span class="line"><span class="string">  # ## set these config to 30 in heavy read scenarios.</span></span><br><span class="line"><span class="string">  # ## If CPU_NUM &gt; 8, the default thread pool size for coprocessors is set to CPU_NUM * 0.8.</span></span><br><span class="line"><span class="string">  # # high-concurrency = 8</span></span><br><span class="line"><span class="string">  # # normal-concurrency = 8</span></span><br><span class="line"><span class="string">  # # low-concurrency = 8</span></span><br><span class="line"><span class="string">  # [server]</span></span><br><span class="line"><span class="string">  # ## Size of the thread pool for the gRPC server.</span></span><br><span class="line"><span class="string">  # # grpc-concurrency = 4</span></span><br><span class="line"><span class="string">  # [storage]</span></span><br><span class="line"><span class="string">  # ## Scheduler's worker pool size, i.e. the number of write threads.</span></span><br><span class="line"><span class="string">  # ## It should be less than total CPU cores. When there are frequent write operations, set it to a</span></span><br><span class="line"><span class="string">  # ## higher value. More specifically, you can run `top -H -p tikv-pid` to check whether the threads</span></span><br><span class="line"><span class="string">  # ## named `sched-worker-pool` are busy.</span></span><br><span class="line"><span class="string">  # # scheduler-worker-pool-size = 4</span></span><br><span class="line"><span class="string">  #### Below parameters available in TiKV 2.x only</span></span><br><span class="line"><span class="string">  # [rocksdb.defaultcf]</span></span><br><span class="line"><span class="string">  # ## block-cache used to cache uncompressed blocks, big block-cache can speed up read.</span></span><br><span class="line"><span class="string">  # ## in normal cases should tune to 30%-50% tikv.resources.limits.memory</span></span><br><span class="line"><span class="string">  # # block-cache-size = "1GB"</span></span><br><span class="line"><span class="string">  # [rocksdb.writecf]</span></span><br><span class="line"><span class="string">  # ## in normal cases should tune to 10%-30% tikv.resources.limits.memory</span></span><br><span class="line"><span class="string">  # # block-cache-size = "256MB"</span></span><br><span class="line"><span class="string">  #### Below parameters available in TiKV 3.x and above only</span></span><br><span class="line"><span class="string">  # [storage.block-cache]</span></span><br><span class="line"><span class="string">  # ## Size of the shared block cache. Normally it should be tuned to 30%-50% of container's total memory.</span></span><br><span class="line"><span class="string">  # # capacity = "1GB"</span></span><br><span class="line"><span class="string">  # [raftstore]</span></span><br><span class="line"><span class="string">  # ## true (default value) for high reliability, this can prevent data loss when power failure.</span></span><br><span class="line"><span class="string">  # # sync-log = true</span></span><br><span class="line"><span class="string">  # # apply-pool-size = 2</span></span><br><span class="line"><span class="string">  # # store-pool-size = 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tikv:v3.0.1</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 16000m</span></span><br><span class="line">    <span class="comment">#   memory: 32Gi</span></span><br><span class="line">    <span class="comment">#   storage: 300Gi</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line">      <span class="comment"># cpu: 12000m</span></span><br><span class="line">      <span class="comment"># memory: 24Gi</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines tikv scheduling rules,affinity default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    local-pv:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tidb:</span></span><br><span class="line">  <span class="comment"># Please refer to https://github.com/pingcap/tidb/blob/master/config/config.toml.example for the default</span></span><br><span class="line">  <span class="comment"># tidb configurations(change to the tags of your tidb version),</span></span><br><span class="line">  <span class="comment"># just follow the format in the file and configure in the 'config' section</span></span><br><span class="line">  <span class="comment"># as below if you want to customize any configuration.</span></span><br><span class="line">  <span class="comment"># Please refer to https://pingcap.com/docs-cn/v3.0/reference/configuration/tidb-server/configuration-file/</span></span><br><span class="line">  <span class="comment"># (choose the version matching your tidb) for detailed explanation of each parameter.</span></span><br><span class="line"><span class="attr">  config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [log]</span></span><br><span class="line"><span class="string">    level = "info"</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># The secret name of root password, you can create secret with following command:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic tidb-secret --from-literal=root=&lt;root-password&gt; --namespace=&lt;namespace&gt;</span></span><br><span class="line">  <span class="comment"># If unset, the root password will be empty and you can set it after connecting</span></span><br><span class="line">  <span class="comment"># passwordSecretName: tidb-secret</span></span><br><span class="line">  <span class="comment"># initSql is the SQL statements executed after the TiDB cluster is bootstrapped.</span></span><br><span class="line">  <span class="comment"># initSql: |-</span></span><br><span class="line">  <span class="comment">#   create database app;</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">pingcap/tidb:v3.0.1</span></span><br><span class="line">  <span class="comment"># Image pull policy.</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 16000m</span></span><br><span class="line">    <span class="comment">#   memory: 16Gi</span></span><br><span class="line"><span class="attr">    requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#   cpu: 12000m</span></span><br><span class="line">    <span class="comment">#   memory: 12Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">## affinity defines tikv scheduling rules,affinity default settings is empty.</span></span><br><span class="line">  <span class="comment">## please read the affinity document before set your scheduling rule:</span></span><br><span class="line">  <span class="comment">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## nodeSelector ensure pods only assigning to nodes which have each of the indicated key-value pairs as labels</span></span><br><span class="line">  <span class="comment">## ref:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## Tolerations are applied to pods, and allow pods to schedule onto nodes with matching taints.</span></span><br><span class="line">  <span class="comment">## refer to https://kubernetes.io/docs/concepts/configuration/taint-and-toleration</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"><span class="attr">  annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  maxFailoverCount:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">    exposeStatus:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># annotations:</span></span><br><span class="line">      <span class="comment"># cloud.google.com/load-balancer-type: Internal</span></span><br><span class="line"><span class="attr">  separateSlowLog:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  slowLogTailer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:1.26.2</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">20</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">5</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># tidb plugin configuration</span></span><br><span class="line"><span class="attr">  plugin:</span></span><br><span class="line">    <span class="comment"># enable plugin or not</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># the start argument to specify the folder containing</span></span><br><span class="line"><span class="attr">    directory:</span> <span class="string">/plugins</span></span><br><span class="line">    <span class="comment"># the start argument to specify the plugin id (name "-" version) that needs to be loaded, e.g. 'conn_limit-1'.</span></span><br><span class="line"><span class="attr">    list:</span> <span class="string">["whitelist-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysqlClient is used to set password for TiDB</span></span><br><span class="line"><span class="comment"># it must has Python MySQL client installed</span></span><br><span class="line"><span class="attr">mysqlClient:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">tnir/mysqlclient</span></span><br><span class="line"><span class="attr">  imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">monitor:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Also see rbac.create</span></span><br><span class="line">  <span class="comment"># If you set rbac.create to false, you need to provide a value here.</span></span><br><span class="line">  <span class="comment"># If you set rbac.create to true, you should leave this empty.</span></span><br><span class="line">  <span class="comment"># serviceAccount:</span></span><br><span class="line"><span class="attr">  persistent:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  initializer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-monitor-initializer:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  reloader:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-monitor-reloader:v1.0.0</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  grafana:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">grafana/grafana:6.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 8000m</span></span><br><span class="line">      <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">      requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 4000m</span></span><br><span class="line">      <span class="comment">#   memory: 4Gi</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line">      <span class="comment"># Configure Grafana using environment variables except GF_PATHS_DATA, GF_SECURITY_ADMIN_USER and GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">      <span class="comment"># Ref https://grafana.com/docs/installation/configuration/#using-environment-variables</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ENABLED:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ORG_NAME:</span> <span class="string">"Main Org."</span></span><br><span class="line"><span class="attr">      GF_AUTH_ANONYMOUS_ORG_ROLE:</span> <span class="string">"Viewer"</span></span><br><span class="line">      <span class="comment"># if grafana is running behind a reverse proxy with subpath http://foo.bar/grafana</span></span><br><span class="line">      <span class="comment"># GF_SERVER_DOMAIN: foo.bar</span></span><br><span class="line">      <span class="comment"># GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s/grafana/"</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  prometheus:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">prom/prometheus:v2.11.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 8000m</span></span><br><span class="line">      <span class="comment">#   memory: 8Gi</span></span><br><span class="line"><span class="attr">      requests:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment">#   cpu: 4000m</span></span><br><span class="line">      <span class="comment">#   memory: 4Gi</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">    reserveDays:</span> <span class="number">12</span></span><br><span class="line">    <span class="comment"># alertmanagerURL: ""</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># kind: monitor</span></span><br><span class="line">    <span class="comment"># zone: cn-bj1-01,cn-bj1-02</span></span><br><span class="line">    <span class="comment"># region: cn-bj1</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># - key: node-role</span></span><br><span class="line">  <span class="comment">#   operator: Equal</span></span><br><span class="line">  <span class="comment">#   value: tidb</span></span><br><span class="line">  <span class="comment">#   effect: "NoSchedule"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">binlog:</span></span><br><span class="line"><span class="attr">  pump:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-binlog:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line">    <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">    <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">    <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">    <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">    storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">    syncLog:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># a integer value to control expiry date of the binlog data, indicates for how long (in days) the binlog data would be stored.</span></span><br><span class="line">    <span class="comment"># must bigger than 0</span></span><br><span class="line"><span class="attr">    gc:</span> <span class="number">7</span></span><br><span class="line">    <span class="comment"># number of seconds between heartbeat ticks (in 2 seconds)</span></span><br><span class="line"><span class="attr">    heartbeatInterval:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  drainer:</span></span><br><span class="line"><span class="attr">    create:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pingcap/tidb-binlog:v3.0.1</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    logLevel:</span> <span class="string">info</span></span><br><span class="line">    <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">    <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">    <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">    <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">    storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line">    <span class="comment"># the number of the concurrency of the downstream for synchronization. The bigger the value,</span></span><br><span class="line">    <span class="comment"># the better throughput performance of the concurrency (16 by default)</span></span><br><span class="line"><span class="attr">    workerCount:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># the interval time (in seconds) of detect pumps' status (default 10)</span></span><br><span class="line"><span class="attr">    detectInterval:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># disbale detect causality</span></span><br><span class="line"><span class="attr">    disableDetect:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># disable dispatching sqls that in one same binlog; if set true, work-count and txn-batch would be useless</span></span><br><span class="line"><span class="attr">    disableDispatch:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># # disable sync these schema</span></span><br><span class="line"><span class="attr">    ignoreSchemas:</span> <span class="string">"INFORMATION_SCHEMA,PERFORMANCE_SCHEMA,mysql,test"</span></span><br><span class="line">    <span class="comment"># if drainer donesn't have checkpoint, use initial commitTS to initial checkpoint</span></span><br><span class="line"><span class="attr">    initialCommitTs:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># enable safe mode to make syncer reentrant</span></span><br><span class="line"><span class="attr">    safeMode:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># the number of SQL statements of a transaction that are output to the downstream database (20 by default)</span></span><br><span class="line"><span class="attr">    txnBatch:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># downstream storage, equal to --dest-db-type</span></span><br><span class="line">    <span class="comment"># valid values are "mysql", "pb", "kafka"</span></span><br><span class="line"><span class="attr">    destDBType:</span> <span class="string">pb</span></span><br><span class="line"><span class="attr">    mysql:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment"># host: "127.0.0.1"</span></span><br><span class="line">      <span class="comment"># user: "root"</span></span><br><span class="line">      <span class="comment"># password: ""</span></span><br><span class="line">      <span class="comment"># port: 3306</span></span><br><span class="line">      <span class="comment"># # Time and size limits for flash batch write</span></span><br><span class="line">      <span class="comment"># timeLimit: "30s"</span></span><br><span class="line">      <span class="comment"># sizeLimit: "100000"</span></span><br><span class="line"><span class="attr">    kafka:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="comment"># only need config one of zookeeper-addrs and kafka-addrs, will get kafka address if zookeeper-addrs is configed.</span></span><br><span class="line">      <span class="comment"># zookeeperAddrs: "127.0.0.1:2181"</span></span><br><span class="line">      <span class="comment"># kafkaAddrs: "127.0.0.1:9092"</span></span><br><span class="line">      <span class="comment"># kafkaVersion: "0.8.2.0"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scheduledBackup:</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># https://github.com/pingcap/tidb-cloud-backup</span></span><br><span class="line"><span class="attr">  mydumperImage:</span> <span class="string">pingcap/tidb-cloud-backup:20190610</span></span><br><span class="line"><span class="attr">  mydumperImagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="comment"># storageClassName is a StorageClass provides a way for administrators to describe the "classes" of storage they offer.</span></span><br><span class="line">  <span class="comment"># different classes might map to quality-of-service levels, or to backup policies,</span></span><br><span class="line">  <span class="comment"># or to arbitrary policies determined by the cluster administrators.</span></span><br><span class="line">  <span class="comment"># refer to https://kubernetes.io/docs/concepts/storage/storage-classes</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">  storage:</span> <span class="number">100</span><span class="string">Gi</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#schedule</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">"0 0 * * *"</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#suspend</span></span><br><span class="line"><span class="attr">  suspend:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#jobs-history-limits</span></span><br><span class="line"><span class="attr">  successfulJobsHistoryLimit:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  failedJobsHistoryLimit:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#starting-deadline</span></span><br><span class="line"><span class="attr">  startingDeadlineSeconds:</span> <span class="number">3600</span></span><br><span class="line">  <span class="comment"># https://github.com/maxbube/mydumper/blob/master/docs/mydumper_usage.rst#options</span></span><br><span class="line"><span class="attr">  options:</span> <span class="string">"--verbose=3"</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores user and password used for backup</span></span><br><span class="line">  <span class="comment"># <span class="doctag">Note:</span> you must give the user enough privilege to do the backup</span></span><br><span class="line">  <span class="comment"># you can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic backup-secret --from-literal=user=root --from-literal=password=&lt;password&gt;</span></span><br><span class="line"><span class="attr">  secretName:</span> <span class="string">backup-secret</span></span><br><span class="line">  <span class="comment"># backup to gcp</span></span><br><span class="line"><span class="attr">  gcp:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores the gcp service account credentials json file</span></span><br><span class="line">  <span class="comment"># The service account must have read/write permission to the above bucket.</span></span><br><span class="line">  <span class="comment"># Read the following document to create the service account and download the credentials file as credentials.json:</span></span><br><span class="line">  <span class="comment"># https://cloud.google.com/docs/authentication/production#obtaining_and_providing_service_account_credentials_manually</span></span><br><span class="line">  <span class="comment"># And then create the secret by: kubectl create secret generic gcp-backup-secret --from-file=./credentials.json</span></span><br><span class="line">  <span class="comment"># secretName: gcp-backup-secret</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># backup to ceph object storage</span></span><br><span class="line"><span class="attr">  ceph:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># endpoint: ""</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores ceph object store access key and secret key</span></span><br><span class="line">  <span class="comment"># You can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic ceph-backup-secret --from-literal=access_key=&lt;access-key&gt; --from-literal=secret_key=&lt;secret-key&gt;</span></span><br><span class="line">  <span class="comment"># secretName: ceph-backup-secret</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># backup to s3</span></span><br><span class="line"><span class="attr">  s3:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment"># region: ""</span></span><br><span class="line">  <span class="comment"># bucket: ""</span></span><br><span class="line">  <span class="comment"># secretName is the name of the secret which stores s3 object store access key and secret key</span></span><br><span class="line">  <span class="comment"># You can create the secret by:</span></span><br><span class="line">  <span class="comment"># kubectl create secret generic s3-backup-secret --from-literal=access_key=&lt;access-key&gt; --from-literal=secret_key=&lt;secret-key&gt;</span></span><br><span class="line">  <span class="comment"># secretName: s3-backup-secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metaInstance:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">metaType:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.type &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">metaValue:</span> <span class="string">"<span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><h2 id="部署Cluster"><a href="#部署Cluster" class="headerlink" title="部署Cluster"></a>部署Cluster</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm install pingcap/tidb-cluster \</span><br><span class="line">     --name=tidb-cluster \</span><br><span class="line">     --namespace=tidb \</span><br><span class="line">     --version=v1.0.0 \</span><br><span class="line">     -f /home/tidb/tidb-cluster/values.yaml</span><br></pre></td></tr></table></figure><h2 id="查看Cluster部署情况"><a href="#查看Cluster部署情况" class="headerlink" title="查看Cluster部署情况"></a>查看Cluster部署情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get pods -l app.kubernetes.io/instance=tidb-cluster</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">tidb-cluster-discovery-84d6cf454c-6c2cl   1/1     Running   0          77m</span><br><span class="line">tidb-cluster-monitor-77cd9d7965-49v8t     3/3     Running   0          77m</span><br><span class="line">tidb-cluster-pd-0                         1/1     Running   0          23m</span><br><span class="line">tidb-cluster-pd-1                         1/1     Running   0          72m</span><br><span class="line">tidb-cluster-pd-2                         1/1     Running   0          72m</span><br><span class="line">tidb-cluster-tidb-0                       2/2     Running   0          2m11s</span><br><span class="line">tidb-cluster-tidb-1                       2/2     Running   0          2m2s</span><br><span class="line">tidb-cluster-tidb-2                       2/2     Running   0          100s</span><br><span class="line">tidb-cluster-tikv-0                       1/1     Running   0          8m56s</span><br><span class="line">tidb-cluster-tikv-1                       1/1     Running   0          8m54s</span><br><span class="line">tidb-cluster-tikv-2                       1/1     Running   0          8m52s</span><br></pre></td></tr></table></figure><h1 id="访问TiDB"><a href="#访问TiDB" class="headerlink" title="访问TiDB"></a>访问TiDB</h1><blockquote><p>TiDB兼容MySQL，因此能直接使用MySQL客户端连接TiDB集群</p><p>这里使用<code>mysql-community-client-5.7.27-1.el7</code>作为客户端程序</p></blockquote><h2 id="获取TiDB-Service信息"><a href="#获取TiDB-Service信息" class="headerlink" title="获取TiDB Service信息"></a>获取TiDB Service信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get svc -l app.kubernetes.io/component=tidb</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">tidb-cluster-tidb        NodePort    10.96.129.51   &lt;none&gt;        4000:30944/TCP,10080:32052/TCP   85m</span><br><span class="line">tidb-cluster-tidb-peer   ClusterIP   None           &lt;none&gt;        10080/TCP                        19m</span><br></pre></td></tr></table></figure><p>从输出示例，可以看到<code>tidb-cluster-tidb</code>是<code>NodePort</code>类型，业务端口<code>4000</code>被映射为节点的<code>30944</code>端口，直接通过此端口即可访问TiDB。</p><h2 id="登录TiDB"><a href="#登录TiDB" class="headerlink" title="登录TiDB"></a>登录TiDB</h2><p>默认集群部署完成后，root用户是无密码的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -P 30944 -h k8s-master</span><br></pre></td></tr></table></figure><h2 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h2><h3 id="查看系统表mysql-tidb"><a href="#查看系统表mysql-tidb" class="headerlink" title="查看系统表mysql.tidb"></a>查看系统表mysql.tidb</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select VARIABLE_NAME,VARIABLE_VALUE from mysql.tidb;</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| VARIABLE_NAME            | VARIABLE_VALUE                                                                                   |</span><br><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| bootstrapped             | True                                                                                             |</span><br><span class="line">| tidb_server_version      | 33                                                                                               |</span><br><span class="line">| system_tz                | Asia/Shanghai                                                                                    |</span><br><span class="line">| tikv_gc_leader_uuid      | 5b16245c9840001                                                                                  |</span><br><span class="line">| tikv_gc_leader_desc      | host:tidb-cluster-tidb-0, pid:1, start at 2019-08-04 01:40:22.757972817 +0800 CST m=+0.859764216 |</span><br><span class="line">| tikv_gc_leader_lease     | 20190804-01:58:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_enable           | true                                                                                             |</span><br><span class="line">| tikv_gc_run_interval     | 10m0s                                                                                            |</span><br><span class="line">| tikv_gc_life_time        | 10m0s                                                                                            |</span><br><span class="line">| tikv_gc_last_run_time    | 20190804-01:48:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_safe_point       | 20190804-01:38:22 +0800                                                                          |</span><br><span class="line">| tikv_gc_auto_concurrency | true                                                                                             |</span><br><span class="line">| tikv_gc_mode             | distributed                                                                                      |</span><br><span class="line">+--------------------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="查看系统变量"><a href="#查看系统变量" class="headerlink" title="查看系统变量"></a>查看系统变量</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like '%tidb%';</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">| Variable_name                       | Value                 |</span><br><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">| tidb_optimizer_selectivity_level    | 0                     |</span><br><span class="line">| tidb_slow_log_threshold             | 300                   |</span><br><span class="line">| tidb_distsql_scan_concurrency       | 15                    |</span><br><span class="line">| tidb_check_mb4_value_in_utf8        | 1                     |</span><br><span class="line">| tidb_checksum_table_concurrency     | 4                     |</span><br><span class="line">| tidb_query_log_max_len              | 2048                  |</span><br><span class="line">| tidb_mem_quota_sort                 | 34359738368           |</span><br><span class="line">| tidb_low_resolution_tso             | 0                     |</span><br><span class="line">| tidb_skip_utf8_check                | 0                     |</span><br><span class="line">| tidb_constraint_check_in_place      | 0                     |</span><br><span class="line">| tidb_snapshot                       |                       |</span><br><span class="line">| tidb_current_ts                     | 0                     |</span><br><span class="line">| tidb_opt_write_row_id               | 0                     |</span><br><span class="line">| tidb_opt_join_reorder_threshold     | 0                     |</span><br><span class="line">| tidb_build_stats_concurrency        | 4                     |</span><br><span class="line">| tidb_mem_quota_topn                 | 34359738368           |</span><br><span class="line">| tidb_batch_insert                   | 0                     |</span><br><span class="line">| tidb_config                         |                       |</span><br><span class="line">| tidb_batch_delete                   | 0                     |</span><br><span class="line">| tidb_opt_correlation_exp_factor     | 1                     |</span><br><span class="line">| tidb_auto_analyze_ratio             | 0.5                   |</span><br><span class="line">| tidb_index_serial_scan_concurrency  | 1                     |</span><br><span class="line">| tidb_ddl_error_count_limit          | 512                   |</span><br><span class="line">| tidb_batch_commit                   | 0                     |</span><br><span class="line">| tidb_wait_split_region_timeout      | 300                   |</span><br><span class="line">| tidb_mem_quota_query                | 34359738368           |</span><br><span class="line">| tidb_dml_batch_size                 | 20000                 |</span><br><span class="line">| tidb_mem_quota_mergejoin            | 34359738368           |</span><br><span class="line">| tidb_projection_concurrency         | 4                     |</span><br><span class="line">| tidb_index_join_batch_size          | 25000                 |</span><br><span class="line">| tidb_wait_split_region_finish       | 1                     |</span><br><span class="line">| tidb_back_off_weight                | 2                     |</span><br><span class="line">| tidb_enable_fast_analyze            | 0                     |</span><br><span class="line">| tidb_skip_isolation_level_check     | 0                     |</span><br><span class="line">| tidb_mem_quota_hashjoin             | 34359738368           |</span><br><span class="line">| tidb_hash_join_concurrency          | 5                     |</span><br><span class="line">| tidb_scatter_region                 | 0                     |</span><br><span class="line">| tidb_enable_window_function         | 1                     |</span><br><span class="line">| tidb_max_chunk_size                 | 1024                  |</span><br><span class="line">| tidb_enable_cascades_planner        | 0                     |</span><br><span class="line">| tidb_ddl_reorg_batch_size           | 1024                  |</span><br><span class="line">| tidb_txn_mode                       |                       |</span><br><span class="line">| tidb_opt_correlation_threshold      | 0.9                   |</span><br><span class="line">| tidb_hashagg_final_concurrency      | 4                     |</span><br><span class="line">| tidb_opt_agg_push_down              | 0                     |</span><br><span class="line">| tidb_index_lookup_concurrency       | 4                     |</span><br><span class="line">| tidb_enable_table_partition         | auto                  |</span><br><span class="line">| tidb_auto_analyze_end_time          | 23:59 +0000           |</span><br><span class="line">| tidb_index_lookup_size              | 20000                 |</span><br><span class="line">| tidb_hashagg_partial_concurrency    | 4                     |</span><br><span class="line">| tidb_opt_insubq_to_join_and_agg     | 1                     |</span><br><span class="line">| tidb_ddl_reorg_worker_cnt           | 16                    |</span><br><span class="line">| tidb_mem_quota_indexlookupreader    | 34359738368           |</span><br><span class="line">| tidb_mem_quota_indexlookupjoin      | 34359738368           |</span><br><span class="line">| tidb_mem_quota_nestedloopapply      | 34359738368           |</span><br><span class="line">| tidb_general_log                    | 0                     |</span><br><span class="line">| tidb_force_priority                 | NO_PRIORITY           |</span><br><span class="line">| tidb_enable_streaming               | 0                     |</span><br><span class="line">| tidb_retry_limit                    | 10                    |</span><br><span class="line">| tidb_enable_radix_join              | 0                     |</span><br><span class="line">| tidb_ddl_reorg_priority             | PRIORITY_LOW          |</span><br><span class="line">| tidb_backoff_lock_fast              | 100                   |</span><br><span class="line">| tidb_auto_analyze_start_time        | 00:00 +0000           |</span><br><span class="line">| tidb_init_chunk_size                | 32                    |</span><br><span class="line">| tidb_expensive_query_time_threshold | 60                    |</span><br><span class="line">| tidb_disable_txn_auto_retry         | 1                     |</span><br><span class="line">| tidb_slow_query_file                | /var/log/tidb/slowlog |</span><br><span class="line">| tidb_index_lookup_join_concurrency  | 4                     |</span><br><span class="line">+-------------------------------------+-----------------------+</span><br><span class="line">68 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><h1 id="查看监控信息"><a href="#查看监控信息" class="headerlink" title="查看监控信息"></a>查看监控信息</h1><ul><li>TiDB 通过 Prometheus 和 Grafana 监控 TiDB 集群。</li><li>在通过 TiDB Operator 创建新的 TiDB 集群时，对于每个 TiDB 集群，会同时创建、配置一套独立的监控系统，与 TiDB 集群运行在同一 Namespace，包括 Prometheus 和 Grafana 两个组件。</li><li>监控数据默认没有持久化，如果由于某些原因监控容器重启，已有的监控数据会丢失。可以在 <code>values.yaml</code> 中设置 <code>monitor.persistent</code> 为 <code>true</code> 来持久化监控数据。</li></ul><h2 id="获取监控端口"><a href="#获取监控端口" class="headerlink" title="获取监控端口"></a>获取监控端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n tidb get svc -l app.kubernetes.io/component=monitor</span><br></pre></td></tr></table></figure><blockquote><p>输出示例</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">tidb-cluster-grafana            NodePort   10.96.136.52    &lt;none&gt;        3000:30009/TCP   93m</span><br><span class="line">tidb-cluster-monitor-reloader   NodePort   10.96.211.160   &lt;none&gt;        9089:31302/TCP   93m</span><br><span class="line">tidb-cluster-prometheus         NodePort   10.96.75.4      &lt;none&gt;        9090:31666/TCP   93m</span><br></pre></td></tr></table></figure><h2 id="访问监控"><a href="#访问监控" class="headerlink" title="访问监控"></a>访问监控</h2><p>可以看到监控服务都是NodePort类型，直接通过节点端口即可访问监控服务</p><h1 id="更新和升级"><a href="#更新和升级" class="headerlink" title="更新和升级"></a>更新和升级</h1><h2 id="TiDB-Operator"><a href="#TiDB-Operator" class="headerlink" title="TiDB-Operator"></a>TiDB-Operator</h2><p>当新版本 tidb-operator 发布，只要更新 <code>values.yaml</code> 中的 <code>operatorImage</code> 然后执行上述命令就可以。但是安全起见，最好从新版本 <code>tidb-operator</code> chart 中获取新版本 <code>values.yaml</code> 并和旧版本 <code>values.yaml</code> 合并生成新的 <code>values.yaml</code>，然后升级。</p><p>TiDB Operator 是用来管理 TiDB 集群的，也就是说，如果 TiDB 集群已经启动并正常运行，你甚至可以停掉 TiDB Operator，而 TiDB 集群仍然能正常工作，直到你需要维护 TiDB 集群，比如伸缩、升级等等。</p><h3 id="升级TiDB-Operator"><a href="#升级TiDB-Operator" class="headerlink" title="升级TiDB-Operator"></a>升级TiDB-Operator</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-operator pingcap/tidb-operator --version=v1.0.0 -f /home/tidb/tidb-operator/values.yaml</span><br></pre></td></tr></table></figure><h3 id="Kubernetes集群版本升级"><a href="#Kubernetes集群版本升级" class="headerlink" title="Kubernetes集群版本升级"></a>Kubernetes集群版本升级</h3><p>当你的 Kubernetes 集群有版本升级，请确保 <code>kubeSchedulerImageTag</code> 与之匹配。默认情况下，这个值是由 Helm 在安装或者升级过程中生成的，要修改它你需要执行 <code>helm upgrade</code>。</p><h2 id="TiDB-Cluster"><a href="#TiDB-Cluster" class="headerlink" title="TiDB-Cluster"></a>TiDB-Cluster</h2><p>滚动更新 TiDB 集群时，会按 PD、TiKV、TiDB 的顺序，串行删除 Pod，并创建新版本的 Pod，当新版本的 Pod 正常运行后，再处理下一个 Pod。</p><p>滚动升级过程会自动处理 PD、TiKV 的 Leader 迁移与 TiDB 的 DDL Owner 迁移。因此，在多节点的部署拓扑下（最小环境：PD <em>3、TiKV </em>3、TiDB * 2），滚动更新 TiKV、PD 不会影响业务正常运行。</p><p>对于有连接重试功能的客户端，滚动更新 TiDB 同样不会影响业务。</p><p>对于无法进行重试的客户端，滚动更新 TiDB 则会导致连接到被关闭节点的数据库连接失效，造成部分业务请求失败。对于这类业务，推荐在客户端添加重试功能或在低峰期进行 TiDB 的滚动升级操作。</p><p>滚动更新可以用于升级 TiDB 版本，也可以用于更新集群配置。</p><h3 id="更新TiDB-Cluster配置"><a href="#更新TiDB-Cluster配置" class="headerlink" title="更新TiDB-Cluster配置"></a>更新TiDB-Cluster配置</h3><p>默认条件下，修改配置文件不会自动应用到 TiDB 集群中，只有在实例重启时，才会重新加载新的配置文件。</p><p><strong>操作步骤如下</strong></p><ol><li><p>修改集群的 <code>values.yaml</code> 文件，将 <code>enableConfigMapRollout</code> 的值设为 <code>true</code></p></li><li><p>修改集群的 <code>values.yaml</code> 文件中需要调整的集群配置项，例如修改<code>pd.replicas</code>、<code>tidb.replicas</code>、<code>tikv.replicas</code>来进行水平扩容和缩容</p></li><li><p>执行<code>helm upgrade</code>命令升级</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-cluster pingcap/tidb-cluster -f /home/tidb/tidb-cluster/values.yaml --version=v1.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看升级进度</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 'kubectl -n tidb get pod -o wide'</span><br></pre></td></tr></table></figure></li></ol><h3 id="升级-TiDB-Cluster-版本"><a href="#升级-TiDB-Cluster-版本" class="headerlink" title="升级 TiDB-Cluster 版本"></a>升级 TiDB-Cluster 版本</h3><ol><li><p>修改集群的 <code>values.yaml</code> 文件中的 <code>tidb.image</code>、<code>tikv.image</code>、<code>pd.image</code> 的值为新版本镜像；</p></li><li><p>执行 <code>helm upgrade</code> 命令进行升级：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade tidb-cluster pingcap/tidb-cluster -f /home/tidb/tidb-cluster/values.yaml --version=v1.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看升级进度</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 1 'kubectl -n tidb get pod -o wide'</span><br></pre></td></tr></table></figure></li></ol><p><strong>注意：</strong></p><ul><li>将 <code>enableConfigMapRollout</code> 特性从关闭状态打开时，即使没有配置变更，也会触发一次 PD、TiKV、TiDB 的滚动更新。</li><li>目前 PD 的 <code>scheduler</code> 和 <code>replication</code> 配置（<code>values.yaml</code> 中的 <code>maxStoreDownTime</code> 和 <code>maxReplicas</code> 字段）在集群安装完成后无法自动更新，需要通过 <a href="https://pingcap.com/docs-cn/v3.0/reference/tools/pd-control" target="_blank" rel="noopener">pd-ctl</a> 手动更新。</li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 乱愣黎</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://luanlengli.github.io/2019/07/29/Kubernetes部署TiDB数据库集群.html" title="Kubernetes部署TiDB数据库集群">https://luanlengli.github.io/2019/07/29/Kubernetes部署TiDB数据库集群.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Kubernetes/" rel="tag"><i class="fa fa-tag"></i> Kubernetes</a> <a href="/tags/TiDB/" rel="tag"><i class="fa fa-tag"></i> TiDB</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/07/23/Kubernetes创建本地PV.html" rel="next" title="Kubernetes创建本地PV"><i class="fa fa-chevron-left"></i> Kubernetes创建本地PV</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2019/08/03/Kubernetes集群使用ECK部署elasticsearch和kibana.html" rel="prev" title="Kubernetes集群使用ECK部署elasticsearch和kibana">Kubernetes集群使用ECK部署elasticsearch和kibana <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="乱愣黎"><p class="site-author-name" itemprop="name">乱愣黎</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">63</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">41</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/luanlengli" target="_blank" title="GitHub"><i class="fa fa-fw fa-globe"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:huangbopei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-globe"></i>E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#说明"><span class="nav-number">1.</span> <span class="nav-text">说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器拓扑"><span class="nav-number">1.1.</span> <span class="nav-text">服务器拓扑</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#准备工作"><span class="nav-number">2.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Helm"><span class="nav-number">2.1.</span> <span class="nav-text">安装Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#二进制安装"><span class="nav-number">2.1.1.</span> <span class="nav-text">二进制安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建RBAC"><span class="nav-number">2.1.2.</span> <span class="nav-text">创建RBAC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Helm服务端"><span class="nav-number">2.1.3.</span> <span class="nav-text">安装Helm服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查部署结果"><span class="nav-number">2.1.4.</span> <span class="nav-text">检查部署结果</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查看Pod状态"><span class="nav-number">2.1.4.1.</span> <span class="nav-text">查看Pod状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看Helm版本信息"><span class="nav-number">2.1.4.2.</span> <span class="nav-text">查看Helm版本信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加Helm-Repo"><span class="nav-number">2.2.</span> <span class="nav-text">添加Helm Repo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新helm缓存"><span class="nav-number">2.3.</span> <span class="nav-text">更新helm缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看TiDB-Operator版本"><span class="nav-number">2.4.</span> <span class="nav-text">查看TiDB-Operator版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置本地PV"><span class="nav-number">2.5.</span> <span class="nav-text">配置本地PV</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建CRD"><span class="nav-number">2.6.</span> <span class="nav-text">创建CRD</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署TiDB-Operator"><span class="nav-number">3.</span> <span class="nav-text">部署TiDB-Operator</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建工作目录"><span class="nav-number">3.1.</span> <span class="nav-text">创建工作目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下载TiDB-Operator-Chart包"><span class="nav-number">3.2.</span> <span class="nav-text">下载TiDB-Operator Chart包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解压Chart包"><span class="nav-number">3.3.</span> <span class="nav-text">解压Chart包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编辑values-yaml"><span class="nav-number">3.4.</span> <span class="nav-text">编辑values.yaml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Operator"><span class="nav-number">3.5.</span> <span class="nav-text">部署Operator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看Operator部署情况"><span class="nav-number">3.6.</span> <span class="nav-text">查看Operator部署情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署TiDB-Cluster"><span class="nav-number">4.</span> <span class="nav-text">部署TiDB-Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建工作目录-1"><span class="nav-number">4.1.</span> <span class="nav-text">创建工作目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下载Chart包"><span class="nav-number">4.2.</span> <span class="nav-text">下载Chart包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解压Chart包-1"><span class="nav-number">4.3.</span> <span class="nav-text">解压Chart包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编辑values-yaml-1"><span class="nav-number">4.4.</span> <span class="nav-text">编辑values.yaml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Cluster"><span class="nav-number">4.5.</span> <span class="nav-text">部署Cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看Cluster部署情况"><span class="nav-number">4.6.</span> <span class="nav-text">查看Cluster部署情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#访问TiDB"><span class="nav-number">5.</span> <span class="nav-text">访问TiDB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#获取TiDB-Service信息"><span class="nav-number">5.1.</span> <span class="nav-text">获取TiDB Service信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#登录TiDB"><span class="nav-number">5.2.</span> <span class="nav-text">登录TiDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简单查询"><span class="nav-number">5.3.</span> <span class="nav-text">简单查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看系统表mysql-tidb"><span class="nav-number">5.3.1.</span> <span class="nav-text">查看系统表mysql.tidb</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看系统变量"><span class="nav-number">5.3.2.</span> <span class="nav-text">查看系统变量</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查看监控信息"><span class="nav-number">6.</span> <span class="nav-text">查看监控信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#获取监控端口"><span class="nav-number">6.1.</span> <span class="nav-text">获取监控端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问监控"><span class="nav-number">6.2.</span> <span class="nav-text">访问监控</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#更新和升级"><span class="nav-number">7.</span> <span class="nav-text">更新和升级</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TiDB-Operator"><span class="nav-number">7.1.</span> <span class="nav-text">TiDB-Operator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#升级TiDB-Operator"><span class="nav-number">7.1.1.</span> <span class="nav-text">升级TiDB-Operator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes集群版本升级"><span class="nav-number">7.1.2.</span> <span class="nav-text">Kubernetes集群版本升级</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TiDB-Cluster"><span class="nav-number">7.2.</span> <span class="nav-text">TiDB-Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#更新TiDB-Cluster配置"><span class="nav-number">7.2.1.</span> <span class="nav-text">更新TiDB-Cluster配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#升级-TiDB-Cluster-版本"><span class="nav-number">7.2.2.</span> <span class="nav-text">升级 TiDB-Cluster 版本</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">乱愣黎</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">156.9k</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("Ud2l4uLerav3PFrmAnVI4tDz-gzGzoHsz","vy29JxqPATrJXMXqS1I3nlg1")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script></body></html>