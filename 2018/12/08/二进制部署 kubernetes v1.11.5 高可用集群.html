<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="kubernetes,">










<meta name="description" content="介绍本次部署方式为二进制可执行文件的方式部署  注意请根据自己的实际情况调整  如无特殊说明，均在k8s-m1节点上执行 参考博文 感谢两位大佬的文章，这里整合一下两位大佬的内容，结合自己的理解整理本文   【漠然】Kubernetes 1.10.1 集群搭建  【张馆长】二进制部署Kubernetes v1.11.x(1.12.x) HA可选    软件版本   kubernetes v1.11">
<meta name="keywords" content="kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="【持续填坑中】二进制部署 kubernetes v1.11.5 高可用集群">
<meta property="og:url" content="https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.5 高可用集群.html">
<meta property="og:site_name" content="luanlengli&#39;s Blog">
<meta property="og:description" content="介绍本次部署方式为二进制可执行文件的方式部署  注意请根据自己的实际情况调整  如无特殊说明，均在k8s-m1节点上执行 参考博文 感谢两位大佬的文章，这里整合一下两位大佬的内容，结合自己的理解整理本文   【漠然】Kubernetes 1.10.1 集群搭建  【张馆长】二进制部署Kubernetes v1.11.x(1.12.x) HA可选    软件版本   kubernetes v1.11">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-12-12T03:48:23.771Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【持续填坑中】二进制部署 kubernetes v1.11.5 高可用集群">
<meta name="twitter:description" content="介绍本次部署方式为二进制可执行文件的方式部署  注意请根据自己的实际情况调整  如无特殊说明，均在k8s-m1节点上执行 参考博文 感谢两位大佬的文章，这里整合一下两位大佬的内容，结合自己的理解整理本文   【漠然】Kubernetes 1.10.1 集群搭建  【张馆长】二进制部署Kubernetes v1.11.x(1.12.x) HA可选    软件版本   kubernetes v1.11">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.5 高可用集群.html">





  <title>【持续填坑中】二进制部署 kubernetes v1.11.5 高可用集群 | luanlengli's Blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">luanlengli's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">“不知道”的五大理由，不读，不查，不试，理解能力差，满脑子想着怎么利用他人</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.5 高可用集群.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="乱愣黎">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="luanlengli's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">【持续填坑中】二进制部署 kubernetes v1.11.5 高可用集群</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-08T11:34:08+08:00">
                2018-12-08
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-12-12T11:48:23+08:00">
                2018-12-12
              </time>
            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/08/二进制部署 kubernetes v1.11.5 高可用集群.html" class="leancloud_visitors" data-flag-title="【持续填坑中】二进制部署 kubernetes v1.11.5 高可用集群">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  13.3k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>本次部署方式为二进制可执行文件的方式部署</p>
<blockquote>
<p>注意<font color="red">请根据自己的实际情况调整</font></p>
</blockquote>
<p>如无特殊说明，均在<font color="red">k8s-m1</font>节点上执行</p>
<p><strong>参考博文</strong></p>
<p>感谢两位大佬的文章，这里整合一下两位大佬的内容，结合自己的理解整理本文</p>
<blockquote>
<ul>
<li><p><a href="https://mritd.me/2018/04/19/set-up-kubernetes-1.10.1-cluster-by-hyperkube/" target="_blank" rel="noopener">【漠然】Kubernetes 1.10.1 集群搭建</a></p>
</li>
<li><p><a href="https://zhangguanzhang.github.io/2018/09/18/kubernetes-1-11-x-bin/" target="_blank" rel="noopener">【张馆长】二进制部署Kubernetes v1.11.x(1.12.x) HA可选</a></p>
</li>
</ul>
</blockquote>
<p><strong>软件版本</strong></p>
<blockquote>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md" target="_blank" rel="noopener">kubernetes v1.11.5</a> 【下载链接需要爬墙，自行解决】</li>
<li>docker-ce 18.03</li>
<li><a href="https://github.com/containernetworking/plugins/releases" target="_blank" rel="noopener">cni-plugin v0.7.4</a></li>
<li>etcd v3.3.10</li>
</ul>
</blockquote>
<p><strong>网络信息</strong></p>
<blockquote>
<ul>
<li>基于CNI的模式实现容器网络</li>
<li>Cluster IP CIDR: 10.244.0.0/16</li>
<li>Service Cluster IP CIDR: 10.96.0.0/12</li>
<li>Service DNS IP: 10.96.0.10</li>
<li>Kubernetes API VIP: 172.16.80.200</li>
</ul>
</blockquote>
<p><strong>节点信息</strong></p>
<blockquote>
<ul>
<li>操作系统可采用 <code>Ubuntu Server 16.04+</code> 和 <code>CentOS 7.4+</code>，本文使用CentOS 7.5 (1804) Minimal</li>
<li>由<code>keepalived</code>提供，VIP为172.16.80.200</li>
<li>由<code>haproxy</code>提供kube-apiserver负载均衡</li>
<li>由于实验环境受限，以3台服务器同时作为master和worker节点运行</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">IP地址</th>
<th style="text-align:center">主机名</th>
<th style="text-align:center">角色</th>
<th style="text-align:center">CPU</th>
<th style="text-align:center">内存</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">172.16.80.201</td>
<td style="text-align:center">k8s-m1</td>
<td style="text-align:center">master+worker</td>
<td style="text-align:center">2</td>
<td style="text-align:center">3G</td>
</tr>
<tr>
<td style="text-align:center">172.16.80.202</td>
<td style="text-align:center">k8s-m2</td>
<td style="text-align:center">master+worker</td>
<td style="text-align:center">2</td>
<td style="text-align:center">3G</td>
</tr>
<tr>
<td style="text-align:center">172.16.80.203</td>
<td style="text-align:center">k8s-m3</td>
<td style="text-align:center">master+worker</td>
<td style="text-align:center">2</td>
<td style="text-align:center">3G</td>
</tr>
</tbody>
</table>
<p><strong>二进制文件路径</strong></p>
<blockquote>
<ul>
<li>/usr/local/bin/：存放kubernetes和etcd二进制文件</li>
<li>/opt/cni/bin/： 存放cni-plugin二进制文件</li>
</ul>
</blockquote>
<h1 id="事前准备"><a href="#事前准备" class="headerlink" title="事前准备"></a>事前准备</h1><blockquote>
<p>事情准备在所有服务器上都需要完成</p>
<p>部署过程以root用户完成</p>
</blockquote>
<ul>
<li>所有服务器<code>网络互通</code>，<code>k8s-m1</code>可以通过SSH证书免密登录到其他master节点，用于分发文件</li>
<li>编辑<code>/etc/hosts</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">172.16.80.200 k8s-vip</span><br><span class="line">172.16.80.201 k8s-m1</span><br><span class="line">172.16.80.202 k8s-m2</span><br><span class="line">172.16.80.203 k8s-m3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>时间同步服务</li>
</ul>
<p>集群系统需要各节点时间同步</p>
<p>参考链接：<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/sect-using_chrony" target="_blank" rel="noopener">RHEL7官方文档</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y chrony</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">systemctl start chronyd</span><br></pre></td></tr></table></figure>
<ul>
<li>关闭firewalld和SELINUX（可根据实际情况自行决定关闭不需要的服务）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl mask firewalld</span><br><span class="line"><span class="meta">#</span> 清空iptables规则</span><br><span class="line">iptables -Z</span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -ri '/^[^#]*SELINUX=/s#=.+$#=disabled#' /etc/selinux/config</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用swap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab</span><br></pre></td></tr></table></figure>
<ul>
<li>添加<code>sysctl</code>参数</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/centos.conf &lt;&lt;EOF </span><br><span class="line"><span class="meta">#</span> 最大文件句柄数</span><br><span class="line">fs.file-max=1024000</span><br><span class="line"><span class="meta">#</span> 在CentOS7.4引入了一个新的参数来控制内核的行为。 </span><br><span class="line"><span class="meta">#</span> /proc/sys/fs/may_detach_mounts 默认设置为0</span><br><span class="line"><span class="meta">#</span> 当系统有容器运行的时候，需要将该值设置为1。</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line"><span class="meta">#</span> 最大文件打开数</span><br><span class="line">fs.nr_open=1024000</span><br><span class="line"><span class="meta">#</span> 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span> 关闭严格校验数据包的反向路径</span><br><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"><span class="meta">#</span> 打开ipv4数据包转发</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="meta">#</span> 允许应用程序能够绑定到不属于本地网卡的地址</span><br><span class="line">net.ipv4.ip_nonlocal_bind=1 </span><br><span class="line"><span class="meta">#</span> 内存耗尽才使用swap分区</span><br><span class="line">vm.swappiness = 0 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 让sysctl参数生效</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>
<ul>
<li>确保操作系统已经最新</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure>
<ul>
<li>安装软件包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum groups install base -y</span><br><span class="line">yum install epel-release bash-completion-extras -y</span><br><span class="line">yum install vim ipvsadm tree dstat iotop htop socat ipset conntrack -y</span><br></pre></td></tr></table></figure>
<ul>
<li>加载ipvs模块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 开机自动加载ipvs模块</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">ipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"</span><br><span class="line">for kernel_module in \$&#123;ipvs_modules&#125;; do</span><br><span class="line">    /sbin/modinfo -F filename \$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe \$&#123;kernel_module&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br></pre></td></tr></table></figure>
<ul>
<li>安装docker-ce 18.03</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine -y</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 -y</span><br><span class="line">yum-config-manager --add-repo http://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sed -e 's,download.docker.com,mirrors.aliyun.com/docker-ce,g' -i /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum install docker-ce-18.03.1.ce -y</span><br></pre></td></tr></table></figure>
<ul>
<li>创建docker配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line"><span class="meta">cat&gt;</span>/etc/docker/daemon.json&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["https://registry.docker-cn.com"],</span><br><span class="line">    "live-restore": true,</span><br><span class="line">    "log-driver": "json-file",</span><br><span class="line">    "log-opts": &#123;</span><br><span class="line">        "max-size": "100m",</span><br><span class="line">        "max-file": "3"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>配置docker命令补全</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/bash-completion/completions/docker /etc/bash_completion.d/</span><br><span class="line">source /etc/bash_completion.d/docker</span><br></pre></td></tr></table></figure>
<ul>
<li>配置docker服务开机自启动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker.service</span><br><span class="line">systemctl start docker.service</span><br></pre></td></tr></table></figure>
<ul>
<li>查看docker信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用docker源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 为避免yum update时更新docker，将docker源禁用</span><br><span class="line">sed -e 's,enabled=1,enabled=0,g' -i /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure>
<ul>
<li>添加etcd和kube用户</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r -g 10000 kube;</span><br><span class="line">groupadd -r -g 10001 etcd;</span><br><span class="line">useradd -r -g kube -u 10000 -s /bin/false kube;</span><br><span class="line">useradd -r -g etcd -u 10001 -s /bin/false etcd;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建目录</span><br><span class="line">mkdir -p /etc/etcd/ssl /etc/kubernetes/ssl /etc/kubernetes/pki /etc/kubernetes/manifests /var/lib/etcd /var/lib/kubelet /var/run/kubernetes /var/log/kube-audit/ /etc/cni/net.d /opt/cni/bin </span><br><span class="line"><span class="meta">#</span> 修改权限</span><br><span class="line">chmod 755 -R /etc/etcd/ssl /etc/kubernetes/ssl /etc/kubernetes/pki /etc/kubernetes/manifests /var/lib/etcd /var/lib/kubelet /var/log/kube-audit /etc/cni/net.d /opt/cni/bin</span><br><span class="line">chown -R etcd:etcd /etc/etcd/ /var/lib/etcd</span><br><span class="line">chown -R kube:kube /etc/kubernetes /var/lib/kubelet /var/log/kube-audit /var/run/kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>确保以最新的内核启动系统</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h1 id="定义集群变量"><a href="#定义集群变量" class="headerlink" title="定义集群变量"></a><strong><font color="red">定义集群变量</font></strong></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">declare -A MasterArray WorkerArray</span><br><span class="line"><span class="meta">#</span> 声明master节点信息</span><br><span class="line">MasterArray=(['k8s-m1']=172.16.80.201 ['k8s-m2']=172.16.80.202 ['k8s-m3']=172.16.80.203)</span><br><span class="line"><span class="meta">#</span> 声明worker节点信息，这里与master节点信息一致</span><br><span class="line">WorkerArray=(['k8s-m1']=172.16.80.201 ['k8s-m2']=172.16.80.202 ['k8s-m3']=172.16.80.203)</span><br><span class="line">export VIP="172.16.80.200"</span><br><span class="line">export KUBE_APISERVER="https://172.16.80.200:6443"</span><br><span class="line"><span class="meta">#</span> 声明VIP所在的网卡名称，以ens33为例</span><br><span class="line">export VIP_IFACE="ens33"</span><br></pre></td></tr></table></figure>
<h1 id="下载所需的二进制文件"><a href="#下载所需的二进制文件" class="headerlink" title="下载所需的二进制文件"></a>下载所需的二进制文件</h1><blockquote>
<p>二进制文件需要分发到master和worker节点</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 下载kubernetes二进制包</span><br><span class="line">echo '--- 下载kubernetes v1.11.5二进制包 ---'</span><br><span class="line">wget https://dl.k8s.io/v1.11.5/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar xzf kubernetes-server-linux-amd64.tar.gz \</span><br><span class="line">        kubernetes/server/bin/hyperkube \</span><br><span class="line">        kubernetes/server/bin/kube-controller-manager \</span><br><span class="line">        kubernetes/server/bin/kubectl \</span><br><span class="line">        kubernetes/server/bin/apiextensions-apiserver \</span><br><span class="line">        kubernetes/server/bin/kube-proxy \</span><br><span class="line">        kubernetes/server/bin/kube-apiserver \</span><br><span class="line">        kubernetes/server/bin/kubelet \</span><br><span class="line">        kubernetes/server/bin/kubeadm \</span><br><span class="line">        kubernetes/server/bin/kube-aggregator \</span><br><span class="line">        kubernetes/server/bin/kube-scheduler \</span><br><span class="line">        kubernetes/server/bin/cloud-controller-manager \</span><br><span class="line">        kubernetes/server/bin/mounter</span><br><span class="line">chown -R kube:kube kubernetes/server/bin/*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 下载etcd二进制包</span><br><span class="line">echo '--- 下载etcd v3.3.10二进制包 ---'</span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">tar xzf etcd-v3.3.10-linux-amd64.tar.gz \</span><br><span class="line">        etcd-v3.3.10-linux-amd64/etcdctl \</span><br><span class="line">        etcd-v3.3.10-linux-amd64/etcd</span><br><span class="line">chown etcd:etcd etcd-v3.3.10-linux-amd64/etcdctl etcd-v3.3.10-linux-amd64/etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 下载CNI-plugin</span><br><span class="line">echo '--- 下载cni-plugins v0.7.4 ---'</span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v0.7.4/cni-plugins-amd64-v0.7.4.tgz</span><br><span class="line">mkdir cni-plugins</span><br><span class="line">tar xzf cni-plugins-amd64-v0.7.4.tgz -C ./cni-plugins/</span><br></pre></td></tr></table></figure>
<h2 id="分发二进制文件到master节点"><a href="#分发二进制文件到master节点" class="headerlink" title="分发二进制文件到master节点"></a>分发二进制文件到master节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 分发kubernetes和etcd二进制文件 ---'</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    rsync -avpt kubernetes/server/bin/* etcd-v3.3.10-linux-amd64/etcdctl etcd-v3.3.10-linux-amd64/etcd $NODE:/usr/local/bin/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="分发二进制文件到worker节点"><a href="#分发二进制文件到worker节点" class="headerlink" title="分发二进制文件到worker节点"></a>分发二进制文件到worker节点</h2><blockquote>
<ul>
<li>这里针对已有的worker节点分发二进制文件</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 分发kubernetes和CNI二进制文件 ---'</span><br><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    rsync -avpt ./cni-plugins/* $NODE:/opt/cni/bin/</span><br><span class="line">    rsync -avpt kubernetes/server/bin/kubelet kubernetes/server/bin/kube-proxy $NODE:/usr/local/bin/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h1 id="生成集群Key和Certificates"><a href="#生成集群Key和Certificates" class="headerlink" title="生成集群Key和Certificates"></a>生成集群Key和Certificates</h1><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>本次部署，需要为etcd、kube-apiserver、kube-controller-manager、kube-scheduler、kube-proxy生成证书。另外还需要生成sa.key、sa.pub、front-proxy-ca、front-proxy-client证书用于集群的其他功能。</p>
<blockquote>
<ul>
<li>要注意CA JSON文件的<code>CN(Common Name)</code>与<code>O(Organization)</code>等内容是会影响Kubernetes组件认证的。<ul>
<li><code>CN</code> Common Name，kube-apiserver会从证书中提取该字段作为请求的用户名（User Name）</li>
<li><code>O</code> Oragnization，kube-apiserver会从证书中提取该字段作为请求用户的所属组（Group）</li>
</ul>
</li>
<li>CA是自签名根证书，用来给后续各种证书签名</li>
<li>kubernetes集群的所有状态信息都保存在etcd中，kubernetes组件会通过kube-apiserver读写etcd里面的信息</li>
<li>etcd如果暴露在公网且没做SSL/TLS验证，那么任何人都能读写数据，那么很可能会无端端在kubernetes集群里面多了挖坑Pod或者肉鸡Pod</li>
<li>本文使用CFSSL创建证书</li>
<li>建立证书过程在<font color="red" size="3">k8s-m1</font>上完成</li>
</ul>
</blockquote>
<h2 id="下载CFSSL工具"><a href="#下载CFSSL工具" class="headerlink" title="下载CFSSL工具"></a>下载CFSSL工具</h2><p>​<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/local/bin/cfssl-certinfo</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/local/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/local/bin/cfssljson</span><br><span class="line">chmod 755 /usr/local/bin/cfssl-certinfo \</span><br><span class="line">​          /usr/local/bin/cfssl \</span><br><span class="line">​          /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure></p>
<h2 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h2><p>​<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/pki /root/master /root/worker</span><br><span class="line">cd /root/pki</span><br></pre></td></tr></table></figure></p>
<h2 id="创建用于生成证书的json文件"><a href="#创建用于生成证书的json文件" class="headerlink" title="创建用于生成证书的json文件"></a>创建用于生成证书的json文件</h2><ul>
<li>ca-config.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "signing": &#123;</span><br><span class="line">    "default": &#123;</span><br><span class="line">      "expiry": "87600h"</span><br><span class="line">    &#125;,</span><br><span class="line">    "profiles": &#123;</span><br><span class="line">      "kubernetes": &#123;</span><br><span class="line">        "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ],</span><br><span class="line">        "expiry": "87600h"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>ca-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>etcd-ca-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>etcd-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "etcd",</span><br><span class="line">      "OU": "Etcd Security"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-apiserver-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kube-apiserver",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-manager-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-controller-manager",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-controller-manager",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-scheduler-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-scheduler",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-scheduler",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-proxy-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-proxy",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:kube-proxy",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-admin-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "admin",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "system:masters",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>front-proxy-ca-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>front-proxy-client-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "front-proxy-client",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>sa-csr.json</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; sa-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "service-accounts",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "Guangdong",</span><br><span class="line">      "L": "Guangzhou",</span><br><span class="line">      "O": "Kubernetes",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="创建etcd证书"><a href="#创建etcd证书" class="headerlink" title="创建etcd证书"></a>创建etcd证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建etcd证书 ---'</span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=etcd-ca.pem \</span><br><span class="line">      -ca-key=etcd-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -hostname=127.0.0.1,$(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort  | paste -d, -s -) \</span><br><span class="line">      -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure>
<h2 id="创建kubernetes证书"><a href="#创建kubernetes证书" class="headerlink" title="创建kubernetes证书"></a>创建kubernetes证书</h2><ul>
<li>CA 证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kubernetes-ca证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建kubernetes-ca证书</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare kube-ca</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-apiserver证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-apiserver证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建kube-apiserver证书</span><br><span class="line"><span class="meta">#</span> 这里的hostname字段中的10.96.0.1要跟上文提到的service cluster ip cidr对应</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -hostname=10.96.0.1,127.0.0.1,localhost,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,$&#123;VIP&#125;,$(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort  | paste -d, -s -) \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-controller-manager证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-controller-manager证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建kube-controller-manager证书</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-scheduler证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-scheduler证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建kube-scheduler证书</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-proxy证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-proxy证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建kube-proxy证书</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-admin证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建kube-admin证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建kube-admin证书</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      kube-admin-csr.json | cfssljson -bare kube-admin</span><br></pre></td></tr></table></figure>
<ul>
<li>Front Proxy证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建Front Proxy Certificate证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建Front Proxy Certificate证书</span><br><span class="line">cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=front-proxy-ca.pem \</span><br><span class="line">      -ca-key=front-proxy-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br></pre></td></tr></table></figure>
<ul>
<li>Service Account证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建service account证书 ---'</span><br><span class="line"><span class="meta">#</span> 创建创建service account证书</span><br><span class="line">cfssl gencert \</span><br><span class="line">      -ca=kube-ca.pem \</span><br><span class="line">      -ca-key=kube-ca-key.pem \</span><br><span class="line">      -config=ca-config.json \</span><br><span class="line">      -profile=kubernetes \</span><br><span class="line">      sa-csr.json | cfssljson -bare sa</span><br></pre></td></tr></table></figure>
<ul>
<li>bootstrap-token</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOTSTRAP_TOKEN=$(dd if=/dev/urandom bs=128 count=1 2&gt;/dev/null | base64 | tr -d "=+/[:space:]" | dd bs=32 count=1 2&gt;/dev/null)</span><br><span class="line">echo "BOOTSTRAP_TOKEN: $&#123;BOOTSTRAP_TOKEN&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建token.csv文件</span><br><span class="line">cat &gt; token.csv &lt;&lt;EOF</span><br><span class="line"><span class="meta">$</span>&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,"system:bootstrappers"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>encryption.yml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ENCRYPTION_TOKEN=$(head -c 32 /dev/urandom | base64)</span><br><span class="line">echo "ENCRYPTION_TOKEN: $&#123;ENCRYPTION_TOKEN&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建encryption.yml文件</span><br><span class="line">cat &gt; encryption.yml &lt;&lt;EOF</span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: $&#123;ENCRYPTION_TOKEN&#125;</span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>audit-policy.yml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 创建创建高级审计配置 ---'</span><br><span class="line"><span class="meta">#</span> 创建高级审计配置</span><br><span class="line">cat &gt;&gt; audit-policy.yml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span> Log all requests at the Metadata level.</span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h2><ul>
<li>kube-controller-manager.kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-controller-manager kubeconfig..."</span><br><span class="line"><span class="meta">#</span> 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置上下文参数</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-scheduler.kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-scheduler kubeconfig..."</span><br><span class="line"><span class="meta">#</span> 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置上下文参数</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-proxy.kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-proxy kubeconfig..."</span><br><span class="line"><span class="meta">#</span> 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-proxy \</span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置上下文参数</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-admin.kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kube-admin kubeconfig..."</span><br><span class="line"><span class="meta">#</span> 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-admin.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubernetes-admin \</span><br><span class="line">  --client-certificate=kube-admin.pem \</span><br><span class="line">  --client-key=kube-admin-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-admin.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置上下文参数</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubernetes-admin \</span><br><span class="line">  --kubeconfig=kube-admin.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-admin.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>bootstrap.kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">echo "Create kubelet bootstrapping kubeconfig..."</span><br><span class="line"><span class="meta">#</span> 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=kube-ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置上下文参数</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"><span class="meta">#</span> 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>
<h2 id="清理证书CSR文件"><a href="#清理证书CSR文件" class="headerlink" title="清理证书CSR文件"></a>清理证书CSR文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 删除*.csr文件 ---'</span><br><span class="line">rm -rf *csr</span><br></pre></td></tr></table></figure>
<h2 id="修改文件权限和属主"><a href="#修改文件权限和属主" class="headerlink" title="修改文件权限和属主"></a>修改文件权限和属主</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo '--- 修改etcd证书权限 ---'</span><br><span class="line">chown etcd:etcd etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem</span><br><span class="line">chmod 0444 etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem</span><br><span class="line">echo '--- 修改kubernetes证书、SA、kubeconfig权限 ---'</span><br><span class="line">chown kube:kube kube*pem sa.pem sa-key.pem front*pem *yml *kubeconfig token.csv</span><br><span class="line">chmod 0400 kube*.pem *kubeconfig sa.pem sa-key.pem *yml token.csv front*.pem</span><br></pre></td></tr></table></figure>
<h2 id="检查生成的文件"><a href="#检查生成的文件" class="headerlink" title="检查生成的文件"></a>检查生成的文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ls -l | grep 'etcd etcd'</span><br><span class="line">-r--r--r--. 1 etcd etcd 1679 Dec  6 15:36 etcd-ca-key.pem</span><br><span class="line">-r--r--r--. 1 etcd etcd 1375 Dec  6 15:36 etcd-ca.pem</span><br><span class="line">-r--r--r--. 1 etcd etcd 1671 Dec  6 15:36 etcd-key.pem</span><br><span class="line">-r--r--r--. 1 etcd etcd 1460 Dec  6 15:36 etcd.pem</span><br><span class="line">ls -l | grep 'kube kube'</span><br><span class="line">-r--------. 1 kube kube  113 Dec  6 15:39 audit-policy.yml</span><br><span class="line">-r--------. 1 kube kube 2207 Dec  6 15:39 bootstrap.kubeconfig</span><br><span class="line">-r--------. 1 kube kube  240 Dec  6 15:39 encryption.yml</span><br><span class="line">-r--------. 1 kube kube 1675 Dec  6 15:38 front-proxy-ca-key.pem</span><br><span class="line">-r--------. 1 kube kube 1143 Dec  6 15:38 front-proxy-ca.pem</span><br><span class="line">-r--------. 1 kube kube 1679 Dec  6 15:38 front-proxy-client-key.pem</span><br><span class="line">-r--------. 1 kube kube 1188 Dec  6 15:38 front-proxy-client.pem</span><br><span class="line">-r--------. 1 kube kube 1675 Dec  6 15:38 kube-admin-key.pem</span><br><span class="line">-r--------. 1 kube kube 6341 Dec  6 15:39 kube-admin.kubeconfig</span><br><span class="line">-r--------. 1 kube kube 1419 Dec  6 15:38 kube-admin.pem</span><br><span class="line">-r--------. 1 kube kube 1675 Dec  6 15:38 kube-apiserver-key.pem</span><br><span class="line">-r--------. 1 kube kube 1688 Dec  6 15:38 kube-apiserver.pem</span><br><span class="line">-r--------. 1 kube kube 1679 Dec  6 15:38 kube-ca-key.pem</span><br><span class="line">-r--------. 1 kube kube 1387 Dec  6 15:38 kube-ca.pem</span><br><span class="line">-r--------. 1 kube kube 1679 Dec  6 15:38 kube-controller-manager-key.pem</span><br><span class="line">-r--------. 1 kube kube 6449 Dec  6 15:39 kube-controller-manager.kubeconfig</span><br><span class="line">-r--------. 1 kube kube 1476 Dec  6 15:38 kube-controller-manager.pem</span><br><span class="line">-r--------. 1 kube kube 1675 Dec  6 15:38 kube-proxy-key.pem</span><br><span class="line">-r--------. 1 kube kube 6371 Dec  6 15:39 kube-proxy.kubeconfig</span><br><span class="line">-r--------. 1 kube kube 1440 Dec  6 15:38 kube-proxy.pem</span><br><span class="line">-r--------. 1 kube kube 1675 Dec  6 15:38 kube-scheduler-key.pem</span><br><span class="line">-r--------. 1 kube kube 6395 Dec  6 15:39 kube-scheduler.kubeconfig</span><br><span class="line">-r--------. 1 kube kube 1452 Dec  6 15:38 kube-scheduler.pem</span><br><span class="line">-r--------. 1 kube kube 1675 Dec  6 15:38 sa-key.pem</span><br><span class="line">-r--------. 1 kube kube 1432 Dec  6 15:38 sa.pem</span><br><span class="line">-r--------. 1 kube kube   80 Dec  6 15:39 token.csv</span><br></pre></td></tr></table></figure>
<h2 id="分发证书文件和kubeconfig到master节点"><a href="#分发证书文件和kubeconfig到master节点" class="headerlink" title="分发证书文件和kubeconfig到master节点"></a>分发证书文件和kubeconfig到master节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">    echo '---- 分发etcd证书 ----'</span><br><span class="line">    rsync -avpt etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem $NODE:/etc/etcd/ssl/</span><br><span class="line">    echo '---- 分发kubeconfig文件 yml文件 token.csv ----'</span><br><span class="line">    rsync -avpt *kubeconfig *yml token.csv $NODE:/etc/kubernetes/</span><br><span class="line">    echo '---- 分发sa证书 kube证书 front-proxy证书 ----'</span><br><span class="line">    rsync -avpt sa.pem sa-key.pem  front*pem kube-*pem kube-ca*pem  $NODE:/etc/kubernetes/pki/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h1 id="kubernetes-master节点"><a href="#kubernetes-master节点" class="headerlink" title="kubernetes-master节点"></a>kubernetes-master节点</h1><p>本节介绍如何部署kubernetes master节点</p>
<h2 id="master节点说明"><a href="#master节点说明" class="headerlink" title="master节点说明"></a><strong>master节点说明</strong></h2><blockquote>
<ul>
<li>原则上，master节点不应该运行业务Pod，且不应该暴露到公网环境！！</li>
<li>边界节点，应该交由<code>worker</code>节点或者运行<code>Ingress</code>的节点来承担</li>
<li>以<code>kubeadm</code>部署为例，部署完成后，会给master节点添加<code>node-role.kubernetes.io/master=&#39;&#39;</code>标签（Labels）并且会对带有此标签的节点添加<code>node-role.kubernetes.io/master:NoSchedule</code>污点（taints），这样不能容忍此污点的Pod无法调度到master节点</li>
<li>本文中，在kubelet启动参数里，默认添加<code>node-role.kubernetes.io/node=&#39;&#39;</code>标签（Labels），且没有对master节点添加<code>node-role.kubernetes.io/master:NoSchedule</code>污点（taints）</li>
<li>生产环境中最好参照kubeadm，对master节点添加<code>node-role.kubernetes.io/master=&#39;&#39;</code>标签（Labels）和<code>node-role.kubernetes.io/master:NoSchedule</code>污点（taints）</li>
</ul>
</blockquote>
<p><strong>kube-apiserver</strong></p>
<blockquote>
<ul>
<li>以 REST APIs 提供 Kubernetes 资源的 CRUD,如授权、认证、存取控制与 API 注册等机制。</li>
<li>关闭默认非安全端口8080,在安全端口 6443 接收 https 请求</li>
<li>严格的认证和授权策略 (x509、token、RBAC)</li>
<li>开启 bootstrap token 认证，支持 kubelet TLS bootstrapping</li>
<li>使用 https 访问 kubelet、etcd，加密通信</li>
</ul>
</blockquote>
<p><strong>kube-controller-manager</strong></p>
<blockquote>
<ul>
<li>通过核心控制循环(Core Control Loop)监听 Kubernetes API<br>的资源来维护集群的状态,这些资源会被不同的控制器所管理,如 Replication Controller、Namespace<br>Controller 等等。而这些控制器会处理着自动扩展、滚动更新等等功能。</li>
<li>关闭非安全端口，在安全端口 10252 接收 https 请求</li>
<li>使用 kubeconfig 访问 kube-apiserver 的安全端口</li>
</ul>
</blockquote>
<p><strong>kube-scheduler</strong></p>
<blockquote>
<ul>
<li>负责将一個(或多个)容器依据调度策略分配到对应节点上让容器引擎(如 Docker)执行。</li>
<li>调度受到 QoS 要求、软硬性约束、亲和性(Affinity)等等因素影响。</li>
</ul>
</blockquote>
<p><strong>HAProxy</strong></p>
<blockquote>
<ul>
<li>提供多个 API Server 的负载均衡(Load Balance)</li>
<li>监听VIP的6443端口负载均衡到三台master节点的6443端口</li>
</ul>
</blockquote>
<p><strong>Keepalived</strong></p>
<blockquote>
<ul>
<li>提供虚拟IP位址(VIP),来让vip落在可用的master主机上供所有组件访问master节点</li>
<li>提供健康检查脚本用于切换VIP</li>
</ul>
</blockquote>
<h2 id="部署配置Keepalived和HAProxy"><a href="#部署配置Keepalived和HAProxy" class="headerlink" title="部署配置Keepalived和HAProxy"></a>部署配置Keepalived和HAProxy</h2><blockquote>
<ul>
<li>在<font color="red" size="3">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<h3 id="切换工作目录"><a href="#切换工作目录" class="headerlink" title="切换工作目录"></a>切换工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/master</span><br></pre></td></tr></table></figure>
<h3 id="安装Keepalived和HAProxy"><a href="#安装Keepalived和HAProxy" class="headerlink" title="安装Keepalived和HAProxy"></a>安装Keepalived和HAProxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">	ssh $NODE yum install keepalived haproxy -y</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h3><blockquote>
<ul>
<li>编辑<code>keepalived.conf</code>模板</li>
<li>替换keepalived.conf的字符串</li>
<li>编辑<code>check_haproxy.sh</code></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; keepalived.conf.example &lt;&lt;EOF</span><br><span class="line">vrrp_script haproxy-check &#123;</span><br><span class="line">    script "/bin/bash /etc/keepalived/check_haproxy.sh"</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance haproxy-vip &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 101</span><br><span class="line">    interface &#123;&#123; VIP_IFACE &#125;&#125;</span><br><span class="line">    virtual_router_id 47</span><br><span class="line">    advert_int 3</span><br><span class="line"></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        &#123;&#123; VIP &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        haproxy-check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 替换字符</span><br><span class="line">sed -r -e "s#\&#123;\&#123; VIP \&#125;\&#125;#$&#123;VIP&#125;#" \</span><br><span class="line">       -e "s#\&#123;\&#123; VIP_IFACE \&#125;\&#125;#$&#123;VIP_IFACE&#125;#" \</span><br><span class="line">       -e '/unicast_peer/r '&lt;(xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#^#\t#') \</span><br><span class="line">       keepalived.conf.example &gt; keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; check_haproxy.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">VIRTUAL_IP=$&#123;VIP&#125;</span><br><span class="line"></span><br><span class="line">errorExit() &#123;</span><br><span class="line">    echo "*** $*" 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ip addr | grep -q \$VIRTUAL_IP ; then</span><br><span class="line">    curl -s --max-time 2 --insecure https://\$&#123;VIRTUAL_IP&#125;:6443/ -o /dev/null || errorExit "Error GET https://\$&#123;VIRTUAL_IP&#125;:6443/"</span><br><span class="line">fi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="配置haproxy"><a href="#配置haproxy" class="headerlink" title="配置haproxy"></a>配置haproxy</h3><blockquote>
<ul>
<li>编辑<code>haproxy.cfg</code>模板</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; haproxy.cfg.example &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  ulimit-n  16384</span><br><span class="line">  log  127.0.0.1 local0 err</span><br><span class="line">  stats timeout 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  log global</span><br><span class="line">  mode  http</span><br><span class="line">  option  httplog</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  timeout http-request 15s</span><br><span class="line">  timeout http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">frontend monitor-in</span><br><span class="line">  bind $&#123;VIP&#125;:33305</span><br><span class="line">  mode http</span><br><span class="line">  option httplog</span><br><span class="line">  monitor-uri /monitor</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">  bind    $&#123;VIP&#125;:8006</span><br><span class="line">  mode    http</span><br><span class="line">  stats   enable</span><br><span class="line">  stats   hide-version</span><br><span class="line">  stats   uri       /stats</span><br><span class="line">  stats   refresh   30s</span><br><span class="line">  stats   realm     Haproxy\ Statistics</span><br><span class="line">  stats   auth      admin:admin</span><br><span class="line"></span><br><span class="line">frontend k8s-api</span><br><span class="line">  bind $&#123;VIP&#125;:6443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-api</span><br><span class="line"></span><br><span class="line">backend k8s-api</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 替换字符</span><br><span class="line">sed -e '$r '&lt;(paste &lt;( seq -f'  server k8s-api-%g'  $&#123;#MasterArray[@]&#125; ) &lt;( xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#$#:6443  check#')) haproxy.cfg.example &gt; haproxy.cfg</span><br></pre></td></tr></table></figure>
<h3 id="分发配置文件到master节点"><a href="#分发配置文件到master节点" class="headerlink" title="分发配置文件到master节点"></a>分发配置文件到master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">	rsync -avpt haproxy.cfg $NODE:/etc/haproxy/</span><br><span class="line">	rsync -avpt keepalived.conf check_haproxy.sh $NODE:/etc/keepalived/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="启动keepalived和haproxy"><a href="#启动keepalived和haproxy" class="headerlink" title="启动keepalived和haproxy"></a>启动keepalived和haproxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "---- $NODE ----"</span><br><span class="line">	ssh $NODE systemctl enable keepalived haproxy</span><br><span class="line">	ssh $NODE systemctl restart keepalived haproxy</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="验证VIP"><a href="#验证VIP" class="headerlink" title="验证VIP"></a>验证VIP</h3><blockquote>
<ul>
<li>需要大约十秒的时间等待keepalived和haproxy服务起来</li>
<li>这里由于后端的kube-apiserver服务还没启动，只测试是否能ping通VIP</li>
<li>如果VIP没起来，就要去确认一下各master节点的keepalived服务是否正常</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -c 4 $VIP</span><br></pre></td></tr></table></figure>
<h2 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h2><blockquote>
<ul>
<li>每个etcd节点的配置都需要做对应更改</li>
<li>在<font color="red" size="3">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<h3 id="配置etcd-service文件"><a href="#配置etcd-service文件" class="headerlink" title="配置etcd.service文件"></a>配置etcd.service文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=etcd</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="etcd-config-yml模板"><a href="#etcd-config-yml模板" class="headerlink" title="etcd.config.yml模板"></a>etcd.config.yml模板</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd.config.yml.example &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span> This is the configuration file for the etcd server.</span><br><span class="line"><span class="meta">#</span> Human-readable name for this member.</span><br><span class="line">name: '&#123;HOSTNAME&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Path to the data directory.</span><br><span class="line">data-dir: '/var/lib/etcd/'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Path to the dedicated wal directory.</span><br><span class="line">wal-dir: '/var/lib/etcd/wal/'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Number of committed transactions to trigger a snapshot to disk.</span><br><span class="line">snapshot-count: 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Time (in milliseconds) of a heartbeat interval.</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Time (in milliseconds) for an election to timeout.</span><br><span class="line">election-timeout: 1000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Raise alarms when backend size exceeds the given quota. 0 means use the</span><br><span class="line"><span class="meta">#</span> default quota.</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> List of comma separated URLs to listen on for peer traffic.</span><br><span class="line">listen-peer-urls: 'https://&#123;PUBLIC_IP&#125;:2380'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> List of comma separated URLs to listen on for client traffic.</span><br><span class="line">listen-client-urls: 'https://&#123;PUBLIC_IP&#125;:2379,http://127.0.0.1:2379'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Maximum number of snapshot files to retain (0 is unlimited).</span><br><span class="line">max-snapshots: 3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Maximum number of wal files to retain (0 is unlimited).</span><br><span class="line">max-wals: 5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Comma-separated white list of origins for CORS (cross-origin resource sharing).</span><br><span class="line">cors:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> List of this member's peer URLs to advertise to the rest of the cluster.</span><br><span class="line"><span class="meta">#</span> The URLs needed to be a comma-separated list.</span><br><span class="line">initial-advertise-peer-urls: 'https://&#123;PUBLIC_IP&#125;:2380'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> List of this member's client URLs to advertise to the public.</span><br><span class="line"><span class="meta">#</span> The URLs needed to be a comma-separated list.</span><br><span class="line">advertise-client-urls: 'https://&#123;PUBLIC_IP&#125;:2379'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Discovery URL used to bootstrap the cluster.</span><br><span class="line">discovery:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Valid values include 'exit', 'proxy'</span><br><span class="line">discovery-fallback: 'proxy'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> HTTP proxy to use for traffic to discovery service.</span><br><span class="line">discovery-proxy:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> DNS domain used to bootstrap initial cluster.</span><br><span class="line">discovery-srv:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Initial cluster configuration for bootstrapping.</span><br><span class="line">initial-cluster: '&#123;&#123; etcd_initial_cluster &#125;&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Initial cluster token for the etcd cluster during bootstrap.</span><br><span class="line">initial-cluster-token: 'etcd-k8s-cluster'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Initial cluster state ('new' or 'existing').</span><br><span class="line">initial-cluster-state: 'new'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Reject reconfiguration requests that would cause quorum loss.</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Accept etcd V2 client requests</span><br><span class="line">enable-v2: true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Enable runtime profiling data via HTTP server</span><br><span class="line">enable-pprof: true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Valid values include 'on', 'readonly', 'off'</span><br><span class="line">proxy: 'off'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Time (in milliseconds) an endpoint will be held in a failed state.</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Time (in milliseconds) of the endpoints refresh interval.</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Time (in milliseconds) for a dial to timeout.</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Time (in milliseconds) for a write to timeout.</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Time (in milliseconds) for a read to timeout.</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line"></span><br><span class="line">client-transport-security:</span><br><span class="line"><span class="meta">  #</span> Path to the client server TLS cert file.</span><br><span class="line">  cert-file: /etc/etcd/ssl/etcd.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Path to the client server TLS key file.</span><br><span class="line">  key-file: /etc/etcd/ssl/etcd-key.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Enable client cert authentication.</span><br><span class="line">  client-cert-auth: true</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Path to the client server TLS trusted CA cert file.</span><br><span class="line">  trusted-ca-file: /etc/etcd/ssl/etcd-ca.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Client TLS using generated certificates</span><br><span class="line">  auto-tls: true</span><br><span class="line"></span><br><span class="line">peer-transport-security:</span><br><span class="line"><span class="meta">  #</span> Path to the peer server TLS cert file.</span><br><span class="line">  cert-file: /etc/etcd/ssl/etcd.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Path to the peer server TLS key file.</span><br><span class="line">  key-file: /etc/etcd/ssl/etcd-key.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Enable peer client cert authentication.</span><br><span class="line">  client-cert-auth: true</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Path to the peer server TLS trusted CA cert file.</span><br><span class="line">  trusted-ca-file: /etc/etcd/ssl/etcd-ca.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Peer TLS using generated certificates.</span><br><span class="line">  auto-tls: true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Enable debug-level logging for etcd.</span><br><span class="line">debug: false</span><br><span class="line"></span><br><span class="line">logger: zap</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Specify 'stdout' or 'stderr' to skip journald logging even when running under systemd.</span><br><span class="line">log-outputs: [default]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Force to create a new one member cluster.</span><br><span class="line">force-new-cluster: false</span><br><span class="line"></span><br><span class="line">auto-compaction-mode: periodic</span><br><span class="line">auto-compaction-retention: "1"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="分发配置文件"><a href="#分发配置文件" class="headerlink" title="分发配置文件"></a>分发配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">etcd_servers=$( xargs -n1&lt;&lt;&lt;$&#123;MasterArray[@]&#125; | sort | sed 's#^#https://#;s#$#:2379#;$s#\n##' | paste -d, -s - )</span><br><span class="line">etcd_initial_cluster=$( for i in $&#123;!MasterArray[@]&#125;;do  echo $i=https://$&#123;MasterArray[$i]&#125;:2380; done | sort | paste -d, -s - )</span><br><span class="line">sed -r "/initial-cluster:/s#'.+'#'$&#123;etcd_initial_cluster&#125;'#" -i etcd.config.yml.example</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 根据节点信息替换文本，分发到各etcd节点</span><br><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    sed -e "s/&#123;HOSTNAME&#125;/$NODE/g" -e "s/&#123;PUBLIC_IP&#125;/$&#123;MasterArray[$NODE]&#125;/g" etcd.config.yml.example &gt; etcd.config.yml.$&#123;NODE&#125;</span><br><span class="line">    chown etcd:etcd etcd.config.yml.$&#123;NODE&#125;</span><br><span class="line">    rsync -avpt etcd.config.yml.$&#123;NODE&#125; $&#123;NODE&#125;:/etc/etcd/etcd.config.yml</span><br><span class="line">    rsync -avpt etcd.service $&#123;NODE&#125;:/usr/lib/systemd/system/etcd.service</span><br><span class="line">    ssh $&#123;NODE&#125; systemctl daemon-reload</span><br><span class="line">    rm -rf etcd.config.yml.$&#123;NODE&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="启动etcd集群"><a href="#启动etcd集群" class="headerlink" title="启动etcd集群"></a>启动etcd集群</h3><blockquote>
<ul>
<li>etcd 进程首次启动时会等待其它节点的 etcd 加入集群，命令 systemctl start etcd 会卡住一段时间，为正常现象</li>
<li>启动之后可以通过<code>etcdctl</code>命令查看集群状态</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE systemctl enable etcd</span><br><span class="line">    ssh $NODE systemctl start etcd &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>为方便维护，可使用alias简化etcdctl命令</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /root/.bashrc &lt;&lt;EOF</span><br><span class="line">alias etcdctl2="export ETCDCTL_API=2;etcdctl --ca-file '/etc/etcd/ssl/etcd-ca.pem' --cert-file '/etc/etcd/ssl/etcd.pem' --key-file '/etc/etcd/ssl/etcd-key.pem' --endpoints $&#123;etcd_servers&#125;"</span><br><span class="line">alias etcdctl3="export ETCDCTL_API=3;etcdctl --cacert=/etc/etcd/ssl/etcd-ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints=$&#123;etcd_servers&#125;"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="验证etcd集群状态"><a href="#验证etcd集群状态" class="headerlink" title="验证etcd集群状态"></a>验证etcd集群状态</h3><blockquote>
<ul>
<li>etcd提供v2和v3两套API，kubernetes使用v3</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 应用上面定义的alias</span><br><span class="line">source /root/.bashrc</span><br><span class="line"><span class="meta">#</span> 使用v2 API访问etcd</span><br><span class="line">etcdctl2 cluster-health</span><br><span class="line"><span class="meta">#</span> 示例输出</span><br><span class="line">member 222fd3b0bb4a5931 is healthy: got healthy result from https://172.16.80.203:2379</span><br><span class="line">member 8349ef180b115a83 is healthy: got healthy result from https://172.16.80.201:2379</span><br><span class="line">member f525d2d797a7c465 is healthy: got healthy result from https://172.16.80.202:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"><span class="meta">#</span> 使用v3 API访问etcd</span><br><span class="line">etcdctl3 endpoint health</span><br><span class="line"><span class="meta">#</span> 示例输出</span><br><span class="line">https://172.16.80.201:2379 is healthy: successfully committed proposal: took = 2.879402ms</span><br><span class="line">https://172.16.80.203:2379 is healthy: successfully committed proposal: took = 6.708566ms</span><br><span class="line">https://172.16.80.202:2379 is healthy: successfully committed proposal: took = 7.187607ms</span><br></pre></td></tr></table></figure>
<h2 id="Master组件服务"><a href="#Master组件服务" class="headerlink" title="Master组件服务"></a>Master组件服务</h2><h3 id="master组件配置模板"><a href="#master组件配置模板" class="headerlink" title="master组件配置模板"></a>master组件配置模板</h3><ul>
<li>kube-apiserver.conf</li>
</ul>
<blockquote>
<ul>
<li>–allow-privileged=true<code>启用容器特权模式</code></li>
<li>–apiserver-count=3<code>指定集群运行模式，其它节点处于阻塞状态</code></li>
<li>–audit-policy-file=/etc/kubernetes/audit-policy.yml <code>基于audit-policy.yml文件定义的内容启动审计功能</code></li>
<li>–authorization-mode=Node,RBAC<code>开启 Node 和 RBAC 授权模式，拒绝未授权的请求</code></li>
<li>–enable-bootstrap-token-auth=true<code>启用 kubelet bootstrap 的 token 认证</code></li>
<li>–experimental-encryption-provider-config=/etc/kubernetes/encryption.yml<code>启用加密特性将Secret数据加密存储到etcd</code></li>
<li>–insecure-port=0<code>关闭监听非安全端口8080</code></li>
<li>–runtime-config=api/all=true<code>启用所有版本的 APIs</code></li>
<li>–service-cluster-ip-range=10.96.0.0/12<code>指定 Service Cluster IP 地址段</code></li>
<li>–service-node-port-range=30000-32767<code>指定 NodePort 的端口范围</code></li>
<li>–token-auth-file=/etc/kubernetes/token.csv<code>保存bootstrap的token信息</code></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_APISERVER_ARGS=" \\</span><br><span class="line">--advertise-address=&#123;PUBLIC_IP&#125;  \\</span><br><span class="line">--allow-privileged=true  \\</span><br><span class="line">--apiserver-count=3 \\</span><br><span class="line">--audit-log-maxage=30  \\</span><br><span class="line">--audit-log-maxbackup=3  \\</span><br><span class="line">--audit-log-maxsize=100  \\</span><br><span class="line">--audit-log-path=/var/log/kube-audit/audit.log  \\</span><br><span class="line">--audit-policy-file=/etc/kubernetes/audit-policy.yml  \\</span><br><span class="line">--authorization-mode=Node,RBAC  \\</span><br><span class="line">--bind-address=&#123;PUBLIC_IP&#125; \\</span><br><span class="line">--client-ca-file=/etc/kubernetes/pki/kube-ca.pem  \\</span><br><span class="line">--enable-admission-plugins=Initializers,NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">--enable-bootstrap-token-auth=true  \\</span><br><span class="line">--etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">--etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">--etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">--etcd-servers=$etcd_servers  \\</span><br><span class="line">--experimental-encryption-provider-config=/etc/kubernetes/encryption.yml  \\</span><br><span class="line">--event-ttl=1h  \\</span><br><span class="line">--insecure-port=0  \\</span><br><span class="line">--kubelet-client-certificate=/etc/kubernetes/pki/kube-apiserver.pem  \\</span><br><span class="line">--kubelet-client-key=/etc/kubernetes/pki/kube-apiserver-key.pem  \\</span><br><span class="line">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">--logtostderr=true  \\</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">--requestheader-allowed-names=aggregator  \\</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">--requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">--requestheader-username-headers=X-Remote-User  \\</span><br><span class="line">--runtime-config=api/all=true  \\</span><br><span class="line">--secure-port=6443  \\</span><br><span class="line">--service-account-key-file=/etc/kubernetes/pki/sa.pem  \\</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/12  \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--storage-backend=etcd3 \\</span><br><span class="line">--tls-cert-file=/etc/kubernetes/pki/kube-apiserver.pem  \\</span><br><span class="line">--tls-private-key-file=/etc/kubernetes/pki/kube-apiserver-key.pem  \\</span><br><span class="line">--token-auth-file=/etc/kubernetes/token.csv \\</span><br><span class="line">--v=2  \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-controller-manager.conf</li>
</ul>
<blockquote>
<ul>
<li>–allocate-node-cidrs=true<code>在cloud provider上分配和设置pod的CIDR</code></li>
<li>–cluster-cidr=10.244.0.0/16<code>集群内的pod的CIDR范围，需要 --allocate-node-cidrs设为true</code></li>
<li>–experimental-cluster-signing-duration=8670h0m0s<code>指定 TLS Bootstrap 证书的有效期</code></li>
<li>–feature-gates=RotateKubeletServerCertificate=true<code>开启 kublet server 证书的自动更新特性</code></li>
<li>–horizontal-pod-autoscaler-use-rest-clients=true<code>能够使用自定义资源（Custom Metrics）进行自动水平扩展</code></li>
<li>–leader-elect=true<code>集群运行模式，启用选举功能，被选为 leader 的节点负责处理工作，其它节点为阻塞状态</code></li>
<li>–node-cidr-mask-size=24<code>集群中node cidr的掩码</code></li>
<li>–service-cluster-ip-range=10.96.0.0/16<code>指定 Service Cluster IP 网段，必须和 kube-apiserver 中的同名参数一致</code></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-controller-manager.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=" \\</span><br><span class="line">--address=127.0.0.1 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">--cluster-signing-cert-file=/etc/kubernetes/pki/kube-ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/etc/kubernetes/pki/kube-ca-key.pem \\</span><br><span class="line">--controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">--experimental-cluster-signing-duration=8670h0m0s \\</span><br><span class="line">--feature-gates=RotateKubeletServerCertificate=true \\</span><br><span class="line">--horizontal-pod-autoscaler-sync-period=10s \\</span><br><span class="line">--horizontal-pod-autoscaler-use-rest-clients=true \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--node-cidr-mask-size=24 \\</span><br><span class="line">--node-monitor-grace-period=40s \\</span><br><span class="line">--node-monitor-period=5s \\</span><br><span class="line">--pod-eviction-timeout=2m0s \\</span><br><span class="line">--root-ca-file=/etc/kubernetes/pki/kube-ca.pem \\</span><br><span class="line">--service-account-private-key-file=/etc/kubernetes/pki/sa-key.pem \\</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/16 \\</span><br><span class="line">--use-service-account-credentials=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-scheduler.conf</li>
</ul>
<blockquote>
<ul>
<li>–leader-elect=true<code>集群运行模式，启用选举功能，被选为 leader 的节点负责处理工作，其它节点为阻塞状态</code></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_SCHEDULER_ARGS="\\</span><br><span class="line">--address=127.0.0.1 \\</span><br><span class="line">--algorithm-provider=DefaultProvider \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="systemd服务文件"><a href="#systemd服务文件" class="headerlink" title="systemd服务文件"></a>systemd服务文件</h3><ul>
<li>kube-apiserver.service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-apiserver.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">After=etcd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \$KUBE_APISERVER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-controller-manager.service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-controller-manager.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-scheduler.service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-scheduler.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=kube</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \$KUBE_SCHEDULER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="分发配置文件到各master节点"><a href="#分发配置文件到各master节点" class="headerlink" title="分发配置文件到各master节点"></a>分发配置文件到各master节点</h3><blockquote>
<ul>
<li>根据master节点的信息替换配置文件里面的字段</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    rsync -avpt kube*service $NODE:/usr/lib/systemd/system/</span><br><span class="line">    sed -e "s/&#123;PUBLIC_IP&#125;/$&#123;MasterArray[$NODE]&#125;/g" kube-apiserver.conf.example &gt; kube-apiserver.conf.$&#123;NODE&#125;</span><br><span class="line">    rsync -avpt kube-apiserver.conf.$&#123;NODE&#125; $NODE:/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">    rsync -avpt kube-controller-manager.conf.example $NODE:/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">    rsync -avpt kube-scheduler.conf.example $NODE:/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">    rm -rf *conf.$&#123;NODE&#125;</span><br><span class="line">    ssh $NODE systemctl daemon-reload</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="启动kubernetes服务"><a href="#启动kubernetes服务" class="headerlink" title="启动kubernetes服务"></a>启动kubernetes服务</h3><blockquote>
<ul>
<li>可以先在<font color="red" size="3">k8s-m1</font>上面启动服务，确认正常之后再在其他master节点启动</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl start kube-scheduler</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kube-admin.kubeconfig get cs</span><br><span class="line"><span class="meta">#</span> 输出示例</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;"health":"true"&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>三台master节点的kube-apiserver、kube-controller-manager、kube-scheduler服务启动成功后可以测试一下</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kube-admin.kubeconfig get endpoints</span><br><span class="line"><span class="meta">#</span> 输出示例</span><br><span class="line">NAME         ENDPOINTS                                                  AGE</span><br><span class="line">kubernetes   172.16.80.201:6443,172.16.80.202:6443,172.16.80.203:6443   12m</span><br></pre></td></tr></table></figure>
<h3 id="设置kubectl"><a href="#设置kubectl" class="headerlink" title="设置kubectl"></a>设置kubectl</h3><blockquote>
<ul>
<li>kubectl命令默认会加载<code>~/.kube/config</code>文件，如果文件不存在则连接<code>http://127.0.0.1:8080</code>，这显然不符合预期，这里使用之前生成的kube-admin.kubeconfig</li>
<li>在<font color="red">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE mkdir -p /root/.kube</span><br><span class="line">    rsync -avpt /root/pki/kube-admin.kubeconfig $NODE:/root/.kube/config</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="设置命令补全"><a href="#设置命令补全" class="headerlink" title="设置命令补全"></a>设置命令补全</h3><blockquote>
<ul>
<li>kubectl 自带生成命令补全的子命令</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!MasterArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE $&#123;MasterArray[$NODE]&#125; ---"</span><br><span class="line">    ssh $NODE kubectl completion bash &gt;&gt; /etc/bash_completion.d/kubectl</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">source /etc/bash_completion.d/kubectl</span><br></pre></td></tr></table></figure>
<h3 id="设置kubelet的bootstrap启动所需的RBAC"><a href="#设置kubelet的bootstrap启动所需的RBAC" class="headerlink" title="设置kubelet的bootstrap启动所需的RBAC"></a>设置kubelet的bootstrap启动所需的RBAC</h3><blockquote>
<ul>
<li><p>当集群开启了 TLS 认证后，每个节点的 kubelet 组件都要使用由 apiserver 使用的 CA 签发的有效证书才能与<br>apiserver 通讯；此时如果节点多起来，为每个节点单独签署证书将是一件非常繁琐的事情；TLS bootstrapping 功能就是让 kubelet 先使用一个预定的低权限用户连接到 apiserver，然后向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署；</p>
</li>
<li><p>在其中一个master节点上执行就可以，以<font color="red"><strong>k8s-m1</strong></font>为例</p>
</li>
</ul>
</blockquote>
<ul>
<li>创建工作目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/tls-bootstrap</span><br><span class="line">cd /root/yaml/tls-bootstrap/</span><br></pre></td></tr></table></figure>
<ul>
<li>kubelet-bootstrap-rbac.yml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建yml文件</span><br><span class="line">cat &gt; kubelet-bootstrap-rbac.yml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span> 给与 kubelet-bootstrap 用户进行 node-bootstrapper 的权限</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubelet-bootstrap</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node-bootstrapper</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: kubelet-bootstrap</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>tls-bootstrap-clusterrole.yml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建yml文件</span><br><span class="line">cat &gt; tls-bootstrap-clusterrole.yml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span> A ClusterRole which instructs the CSR approver to approve a node requesting a</span><br><span class="line"><span class="meta">#</span> serving cert matching its client cert.</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: ["certificates.k8s.io"]</span><br><span class="line">  resources: ["certificatesigningrequests/selfnodeserver"]</span><br><span class="line">  verbs: ["create"]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>node-client-auto-approve-csr.yml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建yml文件</span><br><span class="line">cat &gt; node-client-auto-approve-csr.yml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span> 自动批准 system:bootstrappers 组用户 TLS bootstrapping 首次申请证书的 CSR 请求</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-client-auto-approve-csr</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:bootstrappers</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>node-client-auto-renew-crt.yml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建yml文件</span><br><span class="line">cat &gt; node-client-auto-renew-crt.yml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span> 自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-client-auto-renew-crt</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:nodes</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>node-server-auto-renew-crt.yml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建yml文件</span><br><span class="line">cat &gt; node-server-auto-renew-crt.yml &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span> 自动批准 system:nodes 组用户更新 kubelet 10250 api 端口证书的 CSR 请求</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-server-auto-renew-crt</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:nodes</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>创建tls-bootstrap-rbac</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/tls-bootstrap/</span><br></pre></td></tr></table></figure>
<h1 id="kubernetes-worker节点"><a href="#kubernetes-worker节点" class="headerlink" title="kubernetes worker节点"></a>kubernetes worker节点</h1><h2 id="worker节点说明"><a href="#worker节点说明" class="headerlink" title="worker节点说明"></a><strong>worker节点说明</strong></h2><blockquote>
<ul>
<li>安装Docker-ce，配置与master节点一致即可</li>
<li>安装cni-plugins、kubelet、kube-proxy</li>
<li>关闭防火墙和SELINUX</li>
<li>kubelet和kube-proxy运行需要root权限</li>
<li>这里是以k8s-m1、k8s-m2、k8s-m3作为Work节点加入集群</li>
</ul>
</blockquote>
<p><strong>kubelet</strong></p>
<blockquote>
<ul>
<li>管理容器生命周期、节点状态监控</li>
<li>目前 kubelet 支持三种数据源来获取节点Pod信息：<ul>
<li>本地文件</li>
<li>通过 url 从网络上某个地址来获取信息</li>
<li>API Server：从 kubernetes master 节点获取信息</li>
</ul>
</li>
<li>使用kubeconfig与kube-apiserver通信</li>
<li>这里启用<code>TLS-Bootstrap</code>实现kubelet证书动态签署证书，并自动生成kubeconfig</li>
</ul>
</blockquote>
<p><strong>kube-proxy</strong></p>
<blockquote>
<ul>
<li>Kube-proxy是实现Service的关键插件，kube-proxy会在每台节点上执行，然后监听API Server的Service与Endpoint资源物件的改变，然后来依据变化调用相应的组件来实现网路的转发</li>
<li>kube-proxy可以使用<code>userspace</code>（基本已废弃）、<code>iptables</code>（默认方式）和<code>ipvs</code>来实现数据报文的转发</li>
<li>这里使用的是性能更好、适合大规模使用的<code>ipvs</code></li>
<li>使用kubeconfig与kube-apiserver通信</li>
</ul>
</blockquote>
<h2 id="切换工作目录-1"><a href="#切换工作目录-1" class="headerlink" title="切换工作目录"></a>切换工作目录</h2><blockquote>
<ul>
<li>在<font color="red">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/worker</span><br></pre></td></tr></table></figure>
<h2 id="worker组件配置模板"><a href="#worker组件配置模板" class="headerlink" title="worker组件配置模板"></a>worker组件配置模板</h2><ul>
<li>kube-proxy.conf</li>
</ul>
<blockquote>
<ul>
<li>–cleanup-ipvs=true<code>启动前清除ipvs规则</code></li>
<li>–cluster-cidr=10.244.0.0/16<code>集群中pod的CIDR范围，从这个范围以外发送到服务集群IP的流量将被伪装，从POD发送到外部LoadBalanceIP的流量将被定向到各自的集群IP</code></li>
<li>–ipvs-scheduler=rr<code>ipvs调度类型</code></li>
<li>–masquerade-all<code>SNAT所有通过服务集群ip发送的通信</code></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy.conf.example &lt;&lt;EOF</span><br><span class="line">KUBE_PROXY_ARGS=" \\</span><br><span class="line">--bind-address=0.0.0.0 \\</span><br><span class="line">--cleanup-ipvs=true \\</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">--config-sync-period=15m0s \\</span><br><span class="line">--ipvs-min-sync-period=0s \\</span><br><span class="line">--ipvs-scheduler=rr \\</span><br><span class="line">--ipvs-sync-period=30s \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--masquerade-all \\</span><br><span class="line">--proxy-mode=ipvs \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kubelet.conf</li>
</ul>
<blockquote>
<ul>
<li>–allow-privileged=true<code>允许以特权模式启动容器</code></li>
<li>–bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig<code>指定bootstrap启动时使用的kubeconfig</code></li>
<li>–cgroup-driver=cgroupfs<code>cgroups的驱动，可选systemd和cgroupfs</code></li>
<li>–cluster-dns=10.96.0.10<code>集群内DNS服务的IP地址</code></li>
<li>–cluster-domain=cluster.local.<code>集群的域名</code></li>
<li>–fail-swap-on=false<code>检测到系统已启用swap分区时kubelet就会启动失败，这里关闭此功能</code></li>
<li>–feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true<code>kubelet 在证书即将到期时会自动发起一个 renew 自己证书的 CSR 请求</code></li>
<li>–hairpin-mode=promiscuous-bridge<code>hairpin-mode设置，默认值为promiscuous-bridge</code></li>
<li>–kube-reserved=cpu=200m,memory=500Mi,ephemeral-storage=1Gi<code>Kubernetes系统预留的资源配置</code></li>
<li>–max-pods=110<code>当前节点kubelet所能运行的最大Pod数量</code></li>
<li>–network-plugin=cni<code>定义网络插件，Pod声明周期管理使用此网络插件</code></li>
<li>–node-labels<code>kubelet注册当前Node时设置的Label，以key=value的格式表示，多个labe以逗号分隔</code></li>
<li>–pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.1<code>Pod的pause镜像</code></li>
<li>–resolv-conf=/etc/resolv.conf<code>命名服务配置文件，用于容器内应用的DNS解析</code></li>
<li>–serialize-image-pulls=true<code>顺序pull镜像</code></li>
<li>–system-reserved=cpu=200m,memory=500Mi,ephemeral-storage=1Gi<code>系统预留的资源配置</code></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.conf.example &lt;&lt;EOF</span><br><span class="line">KUBELET_ARGS=" \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \\</span><br><span class="line">--cert-dir=/etc/kubernetes/ssl \\</span><br><span class="line">--cgroup-driver=cgroupfs \\</span><br><span class="line">--cluster-dns=10.96.0.10 \\</span><br><span class="line">--cluster-domain=cluster.local. \\</span><br><span class="line">--cni-conf-dir=/etc/cni/net.d \\</span><br><span class="line">--cni-bin-dir=/opt/cni/bin \\</span><br><span class="line">--fail-swap-on=false \\</span><br><span class="line">--feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true \\</span><br><span class="line">--file-check-frequency=20s \\</span><br><span class="line">--hairpin-mode=promiscuous-bridge \\</span><br><span class="line">--healthz-bind-address=127.0.0.1 \\</span><br><span class="line">--healthz-port=10248 \\</span><br><span class="line">--image-gc-high-threshold=70 \\</span><br><span class="line">--image-gc-low-threshold=50 \\</span><br><span class="line">--kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">--kube-reserved=cpu=200m,memory=500Mi,ephemeral-storage=1Gi \\</span><br><span class="line">--logtostderr=true \\</span><br><span class="line">--max-open-files=1000000 \\</span><br><span class="line">--max-pods=110 \\</span><br><span class="line">--network-plugin=cni \\</span><br><span class="line">--node-ip=&#123;PUBLIC_IP&#125; \\</span><br><span class="line">--node-labels=node-role.kubernetes.io/node='' \\</span><br><span class="line">--node-status-update-frequency=20s \\</span><br><span class="line">--pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.1 \\</span><br><span class="line">--pod-manifest-path=/etc/kubernetes/manifests \\</span><br><span class="line">--pod-max-pids=-1 \\</span><br><span class="line">--port=10250 \\</span><br><span class="line">--read-only-port=10255 \\</span><br><span class="line">--resolv-conf=/etc/resolv.conf \\</span><br><span class="line">--serialize-image-pulls=true \\</span><br><span class="line">--sync-frequency=30s \\</span><br><span class="line">--system-reserved=cpu=200m,memory=500Mi,ephemeral-storage=1Gi \\</span><br><span class="line">--v=2 \\</span><br><span class="line">"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="systemd服务文件-1"><a href="#systemd服务文件-1" class="headerlink" title="systemd服务文件"></a>systemd服务文件</h2><ul>
<li>kubelet.service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet.conf</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \$KUBELET_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-proxy.service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-proxy.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \$KUBE_PROXY_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="分发二进制文件"><a href="#分发二进制文件" class="headerlink" title="分发二进制文件"></a>分发二进制文件</h2><blockquote>
<ul>
<li>对于新增的worker节点，需要分发二进制文件</li>
<li>直接使用master节点上面的二进制文件分发</li>
<li>这里在分发二进制文件前，会先给worker节点建立对应的目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    ssh $NODE mkdir -p /opt/cni/bin /etc/cni/net.d /etc/kubernetes/pki</span><br><span class="line">    rsync -avpt /usr/local/bin/kubelet /usr/local/bin/kube-proxy $NODE:/usr/local/bin/</span><br><span class="line">    rsync -avpt /opt/cni/bin/* $NODE:/opt/cni/bin/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="分发配置文件和服务文件"><a href="#分发配置文件和服务文件" class="headerlink" title="分发配置文件和服务文件"></a>分发配置文件和服务文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    sed -e "s/&#123;PUBLIC_IP&#125;/$&#123;WorkerArray[$NODE]&#125;/g" -e "s/&#123;VIP&#125;/$VIP/g" kubelet.conf.example &gt; kubelet.conf.$&#123;NODE&#125;</span><br><span class="line">    rsync -avpt kubelet.conf.$&#123;NODE&#125; $NODE:/etc/kubernetes/kubelet.conf</span><br><span class="line">    rsync -avpt kube-proxy.conf.example $NODE:/etc/kubernetes/kube-proxy.conf</span><br><span class="line">    rsync -avpt /etc/kubernetes/kube-proxy.kubeconfig /etc/kubernetes/bootstrap.kubeconfig $NODE:/etc/kubernetes/</span><br><span class="line">    rsync -avpt /etc/kubernetes/pki/front*pem $NODE:/etc/kubernetes/pki/</span><br><span class="line">    rsync -avpt kubelet.service kube-proxy.service $NODE:/usr/lib/systemd/system/</span><br><span class="line">    ssh $NODE systemctl daemon-reload</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for NODE in "$&#123;!WorkerArray[@]&#125;";do</span><br><span class="line">    echo "--- $NODE ---"</span><br><span class="line">    ssh $NODE systemctl enable --now docker kubelet kube-proxy</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h2><blockquote>
<ul>
<li>此时由于未按照网络插件，所以节点状态为<font color="red"><code>NotReady</code></font></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME      STATUS       ROLES        AGE       VERSION</span><br><span class="line">k8s-m1    NotReady     k8s-master   11m       v1.11.5</span><br><span class="line">k8s-m2    NotReady     k8s-master   11m       v1.11.5</span><br><span class="line">k8s-m3    NotReady     k8s-master   11m       v1.11.5</span><br></pre></td></tr></table></figure>
<h1 id="kubernetes-Core-Addons"><a href="#kubernetes-Core-Addons" class="headerlink" title="kubernetes Core Addons"></a>kubernetes Core Addons</h1><h2 id="网络组件部署（任选其一）"><a href="#网络组件部署（任选其一）" class="headerlink" title="网络组件部署（任选其一）"></a>网络组件部署（任选其一）</h2><blockquote>
<ul>
<li>只要符合CNI规范的网络组件都可以给kubernetes使用</li>
<li>网络组件清单可以在这里看到<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">Network Plugins</a></li>
<li>这里只列举<code>kube-flannel</code>和<code>calico</code>，flannel和calico的区别可以自己去找资料</li>
<li><font color="red">网络组件只能选一个来部署</font></li>
<li>本文使用<code>kube-flannel</code>部署网络组件，<code>calico</code>已测试可用</li>
<li>在<font color="red">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<h3 id="创建工作目录-1"><a href="#创建工作目录-1" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/network-plugin/&#123;kube-flannel,calico&#125;</span><br></pre></td></tr></table></figure>
<h3 id="kube-flannel"><a href="#kube-flannel" class="headerlink" title="kube-flannel"></a>kube-flannel</h3><blockquote>
<ul>
<li>切换工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/network-plugin/kube-flannel</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>kube-flannel基于VXLAN的方式创建容器二层网络，使用端口<font color="red"><code>8472/UDP</code></font>通信</li>
<li>flannel 第一次启动时，从 etcd 获取 Pod 网段信息，为本节点分配一个未使用的 /24 段地址，然后创建 flannel.1（也可能是其它名称，如 flannel1 等） 接口。</li>
<li>部署方法非常简单，官方提供yml文件部署为DeamonSet</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><p>官方yml文件包含多个平台的daemonset，包括amd64、arm64、arm、ppc64le、s390x</p>
</li>
<li><p>这里以amd64作为例子，其他的可以自行根据需要修改或者直接删除不需要的daemonset</p>
</li>
<li><p>官方yml文件已经配置好容器网络为<code>10.244.0.0/16</code>，这里需要跟<code>kube-controller-manager.conf</code>里面的<code>--cluster-cidr</code>匹配</p>
</li>
<li><p>如果在<code>kube-controller-manager.conf</code>里面把<code>--cluster-cidr</code>改成了其他地址段，例如<code>192.168.0.0/16</code>，用以下命令替换<code>kube-flannel.yml</code>相应的字段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span>   sed -e 's,"Network": "10.244.0.0/16","Network": "192.168.0.0/16," -i kube-flannel.yml</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>如果服务器有多个网卡，需要指定网卡用于flannel通信，以网卡ens33为例</p>
<ul>
<li>在<code>args</code>下面添加一行<font color="red"><code>- --iface=ens33</code></font></li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">- name: kube-flannel</span><br><span class="line">  image: zhangguanzhang/quay.io.coreos.flannel:v0.10.0-amd64</span><br><span class="line">  command:</span><br><span class="line">  - /opt/bin/flanneld</span><br><span class="line">  args:</span><br><span class="line">  - --ip-masq</span><br><span class="line">  - --kube-subnet-mgr</span><br><span class="line">  - --iface=ens33</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>部署kube-flannel</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>检查kube-flannel的部署情况</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=flannel</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-27jwl   2/2       Running   0          59s</span><br><span class="line">kube-flannel-ds-4fgv6   2/2       Running   0          59s</span><br><span class="line">kube-flannel-ds-mvrt7   2/2       Running   0          59s</span><br></pre></td></tr></table></figure>
<h3 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h3><blockquote>
<ul>
<li>Calico 是一款纯 Layer 3 的网络，节点之间基于BGP协议来通信。</li>
<li><a href="https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/calico" target="_blank" rel="noopener">部署文档</a></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>切换工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/network-plugin/calico</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>这里使用kubernetes API来保存网络信息</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml</span><br><span class="line">wget https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml</span><br><span class="line">wget https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calicoctl.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>官方yml文件默认配置容器网络为<code>192.168.0.0/16</code>，这里需要跟<code>kube-controller-manager.conf</code>里面的<code>--cluster-cidr</code>匹配，需要替换相应字段</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,value: "192.168.0.0/16",value: "10.244.0.0/16",g' -i calico.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>官方yml文件定义calicoctl为Pod，而不是deployment，所以需要调整一下</li>
<li>修改<code>kind: Pod</code>为<code>kind: Deployment</code>并补充其他字段</li>
</ul>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">      - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">        key:</span> <span class="string">node.cloudprovider.kubernetes.io/uninitialized</span></span><br><span class="line"><span class="attr">        value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">calicoctl</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">quay.io/calico/ctl:v3.3.2</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["/bin/sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"while true; do sleep 3600; done"</span><span class="string">]</span></span><br><span class="line"><span class="attr">        tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DATASTORE_TYPE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">kubernetes</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>部署Calico</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f rbac-kdd.yaml</span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line">kubectl apply -f calicoctl.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>检查Calico部署情况</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=calico-node</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE</span><br><span class="line">calico-node-fjcj4   2/2       Running   0          6m</span><br><span class="line">calico-node-tzppt   2/2       Running   0          6m</span><br><span class="line">calico-node-zdq64   2/2       Running   0          6m</span><br><span class="line"></span><br><span class="line">kubectl get pod -n kube-system -l k8s-app=calicoctl</span><br><span class="line">NAME                         READY     STATUS    RESTARTS   AGE</span><br><span class="line">calicoctl-58df8955f6-sp8q9   0/1       Running   0          38s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl -n kube-system exec -it calicoctl-58df8955f6-sp8q9 -- /calicoctl get node -o wide</span><br><span class="line">NAME     ASN         IPV4               IPV6   </span><br><span class="line">k8s-m1   (unknown)   172.16.80.201/24          </span><br><span class="line">k8s-m2   (unknown)   172.16.80.202/24          </span><br><span class="line">k8s-m3   (unknown)   172.16.80.203/24</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system exec -it calicoctl-58df8955f6-sp8q9 -- /calicoctl get profiles -o wide</span><br><span class="line">NAME              LABELS   </span><br><span class="line">kns.default       map[]    </span><br><span class="line">kns.kube-public   map[]    </span><br><span class="line">kns.kube-system   map[]</span><br></pre></td></tr></table></figure>
<h3 id="检查节点状态"><a href="#检查节点状态" class="headerlink" title="检查节点状态"></a>检查节点状态</h3><blockquote>
<ul>
<li>网络组件部署完成之后，可以看到node状态已经为Ready</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node </span><br><span class="line">NAME      STATUS    ROLES     AGE       VERSION</span><br><span class="line">k8s-m1    Ready     node      1d        v1.11.5</span><br><span class="line">k8s-m2    Ready     node      1d        v1.11.5</span><br><span class="line">k8s-m3    Ready     node      1d        v1.11.5</span><br></pre></td></tr></table></figure>
<h2 id="服务发现组件部署"><a href="#服务发现组件部署" class="headerlink" title="服务发现组件部署"></a>服务发现组件部署</h2><blockquote>
<ul>
<li>kubernetes从v1.11之后，已经使用CoreDNS取代原来的KUBE DNS作为服务发现的组件</li>
<li>CoreDNS 是由 CNCF 维护的开源 DNS 方案，前身是 SkyDNS</li>
<li>在<font color="red">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<h3 id="创建工作目录-2"><a href="#创建工作目录-2" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/coredns</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>切换工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/coredns</span><br></pre></td></tr></table></figure>
<h3 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h3><blockquote>
<ul>
<li>创建coredns.yml文件</li>
<li>在configmap中定义的Corefile可以根据需要修改hosts内容</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; coredns.yml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: "true"</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">          pods insecure</span><br><span class="line">          upstream</span><br><span class="line">          fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: ""</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: CriticalAddonsOnly</span><br><span class="line">        operator: Exists</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/master</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: gcrxio/coredns:1.2.6</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args: [ "-conf", "/etc/coredns/Corefile" ]</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: host-time</span><br><span class="line">          mountPath: /etc/localtime</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">      - name: host-time</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/localtime</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: coredns</span><br><span class="line">          items:</span><br><span class="line">          - key: Corefile</span><br><span class="line">            path: Corefile</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/port: "9153"</span><br><span class="line">    prometheus.io/scrape: "true"</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  clusterIP: 10.96.0.10</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: TCP</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>yml文件里面定义了<code>clusterIP: 10.96.0.10</code>这里需要与kubelet.conf里面定义的<code>--cluster-dns=10.96.0.10</code>一致</li>
<li>如果kubelet.conf里面的<code>--cluster-dns</code>改成别的，例如<code>192.168.0.10</code>，这里也要做相应变动，不然pod找不到DNS，无法正常工作</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,clusterIP: 10.96.0.10,clusterIP: 192.168.0.10,g' -i coredns.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>部署CoreDNS</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f coredns.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>检查部署状态</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get po -l k8s-app=kube-dns</span><br><span class="line">NAME                       READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5566c96697-6gzzc   1/1       Running   0          45s</span><br><span class="line">coredns-5566c96697-q5slk   1/1       Running   0          45s</span><br></pre></td></tr></table></figure>
<h3 id="验证集群DNS服务"><a href="#验证集群DNS服务" class="headerlink" title="验证集群DNS服务"></a>验证集群DNS服务</h3><blockquote>
<ul>
<li>创建一个deployment测试DNS解析</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建一个基于busybox的deployment</span><br><span class="line">cat &gt; /root/yaml/busybox-deployment.yml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: busybox</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: busybox</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: busybox</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: busybox</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        image: busybox:1.26</span><br><span class="line">        command:</span><br><span class="line">        - sleep</span><br><span class="line">        - "3600"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 基于文件创建deployment</span><br><span class="line">kubectl apply -f /root/yaml/busybox-deployment.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>检查deployment部署情况</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">NAME                       READY     STATUS    RESTARTS   AGE</span><br><span class="line">busybox-7b9bfb5658-872gj   1/1       Running   0          6s</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>验证集群DNS解析</li>
<li>上一个命令获取到pod名字为<code>busybox-7b9bfb5658-872gj</code>，通过kubectl命令连接到pod终端运行nslookup命令</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it busybox-7b9bfb5658-4cz94 -- nslookup kubernetes</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>
<h2 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h2><blockquote>
<ul>
<li><a href="https://github.com/kubernetes-incubator/metrics-server" target="_blank" rel="noopener">Metrics Server</a><br>是实现了 Metrics API 的元件,其目标是取代 Heapster 作位 Pod 与 Node 提供资源的 Usage<br>metrics,该元件会从每个 Kubernetes 节点上的 Kubelet 所公开的 Summary API 中收集 Metrics</li>
<li>Horizontal Pod Autoscaler（HPA）控制器用于实现基于CPU使用率进行自动Pod伸缩的功能。</li>
<li>HPA控制器基于Master的kube-controller-manager服务启动参数–horizontal-pod-autoscaler-sync-period定义是时长（默认30秒）,周期性监控目标Pod的CPU使用率,并在满足条件时对ReplicationController或Deployment中的Pod副本数进行调整,以符合用户定义的平均Pod<br>CPU使用率。</li>
<li>在新版本的kubernetes中 Pod CPU使用率不在来源于heapster,而是来自于metrics-server</li>
<li>官网原话是 The –horizontal-pod-autoscaler-use-rest-clients is true or unset.<br>Setting this to false switches to Heapster-based autoscaling, which is<br>deprecated.</li>
<li>在<font color="red">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>设置kube-apiserver参数，这里在配置kube-apiserver阶段已经加进去了</li>
<li>front-proxy证书，在证书生成阶段已经完成且已分发</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">--requestheader-allowed-names=aggregator  \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">--requestheader-username-headers=X-Remote-User  \</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>创建工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/metrics-server</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>切换工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/metrics-server</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>下载metrics-server的yaml文件</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/aggregated-metrics-reader.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/auth-delegator.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/auth-reader.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/metrics-apiservice.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/metrics-server-service.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/resource-reader.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>创建metrics-server-deployment.yaml</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; metrics-server-deployment.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      volumes:</span><br><span class="line">      # mount in tmp so we can safely use from-scratch images and/or read-only containers</span><br><span class="line">      - name: ca-ssl</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/kubernetes/pki</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: gcrxio/metrics-server-amd64:v0.3.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - /metrics-server</span><br><span class="line">        - --metric-resolution=30s</span><br><span class="line">        - --kubelet-port=10255</span><br><span class="line">        - --deprecated-kubelet-completely-insecure=true</span><br><span class="line">        - --kubelet-preferred-address-types=InternalDNS,InternalIP,ExternalDNS,ExternalIP,Hostname</span><br><span class="line">        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">        - --requestheader-username-headers=X-Remote-User </span><br><span class="line">        - --requestheader-group-headers=X-Remote-Group </span><br><span class="line">        - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: ca-ssl</span><br><span class="line">          mountPath: /etc/kubernetes/pki</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>部署metrics-server</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/yaml/metrics-server/</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>查看pod状态</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -l k8s-app=metrics-server</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/metrics-server-86bd9d7667-5hbn6   1/1       Running   0          1m</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>完成后,等待一段时间(约 30s - 1m)收集 Metrics</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 请求metrics api的结果</span><br><span class="line">kubectl get --raw /apis/metrics.k8s.io/v1beta1</span><br><span class="line">&#123;"kind":"APIResourceList","apiVersion":"v1","groupVersion":"metrics.k8s.io/v1beta1","resources":[&#123;"name":"nodes","singularName":"","namespaced":false,"kind":"NodeMetrics","verbs":["get","list"]&#125;,&#123;"name":"pods","singularName":"","namespaced":true,"kind":"PodMetrics","verbs":["get","list"]&#125;]&#125;</span><br><span class="line"></span><br><span class="line">kubectl get apiservice|grep metrics</span><br><span class="line">v1beta1.metrics.k8s.io                  2018-12-09T08:17:26Z</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 获取节点性能信息</span><br><span class="line">kubectl top node</span><br><span class="line">NAME      CPU(cores)   CPU%      MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-m1    113m         2%        1080Mi          14%       </span><br><span class="line">k8s-m2    133m         3%        1086Mi          14%       </span><br><span class="line">k8s-m3    100m         2%        1029Mi          13%</span><br></pre></td></tr></table></figure>
<h1 id="至此集群已具备基本功能"><a href="#至此集群已具备基本功能" class="headerlink" title="至此集群已具备基本功能"></a>至此集群已具备基本功能</h1><blockquote>
<ul>
<li>下面的Extra Addons就是一些额外的功能</li>
</ul>
</blockquote>
<h1 id="kubernetes-Extra-Addons"><a href="#kubernetes-Extra-Addons" class="headerlink" title="kubernetes Extra Addons"></a>kubernetes Extra Addons</h1><h2 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h2><blockquote>
<ul>
<li>Dashboard 是kubernetes社区提供的GUI界面，用于图形化管理kubernetes集群，同时可以看到资源报表。</li>
<li>官方提供yml文件直接部署，但是需要更改<code>image</code>以便国内部署</li>
<li>在<font color="red">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>创建工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>切换工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>获取yml文件</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>修改image</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,k8s.gcr.io/kubernetes-dashboard-amd64,gcrxio/kubernetes-dashboard-amd64,g' -i kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>创建kubernetes-Dashboard</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>官方的yaml文件，ServiceAccount绑定的RBAC权限很低，很多资源无法查看</li>
<li>需要创建一个用于管理全局的ServiceAccount</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; cluster-admin.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span> 在kube-system中创建名为admin-user的ServiceAccount</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="meta">#</span> 将admin-user和cluster-admin绑定在一起</span><br><span class="line"><span class="meta">#</span> cluster-admin是kubernetes内置的clusterrole，具有集群管理员权限</span><br><span class="line"><span class="meta">#</span> 其他内置的clusterrole可以通过kubectl get clusterrole查看</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>创建ServiceAccount</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f cluster-admin.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>运行以下命令获取ServiceAccount的token</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>查看部署情况</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n kube-system --selector k8s-app=kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>kubernetes-dashborad的svc默认是<code>clusterIP</code>，需要修改为<code>nodePort</code>才能被外部访问</li>
<li>此处指定nodePort为<code>30443</code></li>
<li>如不指定<code>&quot;nodePort&quot;:30443</code>，则随机分配端口，分配范围在kube-apiserver的<code>--service-node-port-range</code>指定</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -n kube-system svc kubernetes-dashboard -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;'</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>修改完之后，通过以下命令获取访问kubernetes-Dashboard的端口</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get svc --selector k8s-app=kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.106.183.192   &lt;none&gt;        443:30216/TCP   12s</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>可以看到已经将节点的<code>30216</code>端口暴露出来</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>IP地址不固定，只要运行了kube-proxy组件，都会在节点上添加<code>30216</code>端口规则用于转发请求到Pod</p>
<p><a href="https://172.16.80.201:30216" target="_blank" rel="noopener">https://172.16.80.201:30216</a></p>
<p><a href="https://172.16.80.202:30216" target="_blank" rel="noopener">https://172.16.80.202:30216</a></p>
<p><a href="https://172.16.80.203:30216" target="_blank" rel="noopener">https://172.16.80.203:30216</a></p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>登录Dashboard，上面已经获取了token，这里只需要把token的值填入输入框，点击<code>SIGN IN</code>即可登录</li>
</ul>
</blockquote>
<h2 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h2><blockquote>
<ul>
<li>Ingress 是 Kubernetes 中的一个抽象资源，其功能是通过 Web Server 的 Virtual Host<br>概念以域名(Domain Name)方式转发到內部 Service，这避免了使用 Service 中的 NodePort 与<br>LoadBalancer 类型所带來的限制(如 Port 数量上限)，而实现 Ingress 功能则是通过 Ingress Controller<br>来达成，它会负责监听 Kubernetes API 中的 Ingress 与 Service 资源，并在发生资源变化时，根据资源预期的结果来设置 Web Server。</li>
<li>Ingress Controller 有许多实现可以选择，这里只是列举一小部分<ul>
<li><a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Ingress NGINX</a>：Kubernetes 官方维护的方案，<font color="red">本次安装使用此方案</font></li>
<li><a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">kubernetes-ingress</a>：由nginx社区维护的方案，使用社区版nginx和nginx-plus</li>
<li><a href="https://github.com/containous/traefik" target="_blank" rel="noopener">treafik</a>：一款开源的反向代理与负载均衡工具。它最大的优点是能够与常见的微服务系统直接整合，可以实现自动化动态配置</li>
</ul>
</li>
<li>在<font color="red">k8s-m1</font>上操作</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>创建工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/yaml/ingress/ingress-nginx</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>切换工作目录</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/yaml/ingress/ingress-nginx</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>下载yaml文件</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.20.0/deploy/mandatory.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.20.0/deploy/provider/baremetal/service-nodeport.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>修改镜像地址</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e 's,k8s.gcr.io/defaultbackend-amd64:1.5,gcrxio/defaultbackend:1.4,g' -i mandatory.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>创建ingress-nginx</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>检查部署情况</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n ingress-nginx</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>访问ingress</li>
<li>默认的backend会返回404</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n ingress-nginx --show-labels</span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx   NodePort   10.96.250.140   &lt;none&gt;        80:32603/TCP,443:30083/TCP   1m</span><br><span class="line"></span><br><span class="line">curl http://172.16.80.201:32603</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.15.6&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一些需要注意的点</p>
<ul>
<li><p>这里部署之后，是<code>deployment</code>，且通过<code>nodePort</code>暴露服务</p>
</li>
<li><p>也可以修改yml文件，将<code>Ingress-nginx</code>部署为<code>DaemonSet</code></p>
<ul>
<li>使用<code>labels</code>和<code>nodeSelector</code>来指定运行ingress-nginx的节点</li>
<li>使用<code>hostNetwork=true</code>来共享主机网络命名空间，或者使用<code>hostPort</code>指定主机端口映射</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Helm（填坑中）"><a href="#Helm（填坑中）" class="headerlink" title="Helm（填坑中）"></a>Helm（填坑中）</h2><h2 id="Prometheus（填坑中）"><a href="#Prometheus（填坑中）" class="headerlink" title="Prometheus（填坑中）"></a>Prometheus（填坑中）</h2><h2 id="ELK（填坑中）"><a href="#ELK（填坑中）" class="headerlink" title="ELK（填坑中）"></a>ELK（填坑中）</h2>
      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    乱愣黎
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.5 高可用集群.html" title="【持续填坑中】二进制部署 kubernetes v1.11.5 高可用集群">https://luanlengli.github.io/2018/12/08/二进制部署 kubernetes v1.11.5 高可用集群.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            
            <a href="/tags/kubernetes/" rel="tag"><i class="fa fa-tag"></i> kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/05/CentOS-7-6-1810-虚拟机模板制作.html" rel="next" title="CentOS-7.6(1810)虚拟机模板制作">
                <i class="fa fa-chevron-left"></i> CentOS-7.6(1810)虚拟机模板制作
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/11/使用Docker打包shadowsocks-libev镜像.html" rel="prev" title="使用Docker打包shadowsocks-libev镜像">
                使用Docker打包shadowsocks-libev镜像 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="乱愣黎">
            
              <p class="site-author-name" itemprop="name">乱愣黎</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/luanlengli" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:huangbopei@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事前准备"><span class="nav-number">2.</span> <span class="nav-text">事前准备</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#定义集群变量"><span class="nav-number">3.</span> <span class="nav-text">定义集群变量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#下载所需的二进制文件"><span class="nav-number">4.</span> <span class="nav-text">下载所需的二进制文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#分发二进制文件到master节点"><span class="nav-number">4.1.</span> <span class="nav-text">分发二进制文件到master节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分发二进制文件到worker节点"><span class="nav-number">4.2.</span> <span class="nav-text">分发二进制文件到worker节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#生成集群Key和Certificates"><span class="nav-number">5.</span> <span class="nav-text">生成集群Key和Certificates</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#说明"><span class="nav-number">5.1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下载CFSSL工具"><span class="nav-number">5.2.</span> <span class="nav-text">下载CFSSL工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建工作目录"><span class="nav-number">5.3.</span> <span class="nav-text">创建工作目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建用于生成证书的json文件"><span class="nav-number">5.4.</span> <span class="nav-text">创建用于生成证书的json文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建etcd证书"><span class="nav-number">5.5.</span> <span class="nav-text">创建etcd证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建kubernetes证书"><span class="nav-number">5.6.</span> <span class="nav-text">创建kubernetes证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建kubeconfig文件"><span class="nav-number">5.7.</span> <span class="nav-text">创建kubeconfig文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#清理证书CSR文件"><span class="nav-number">5.8.</span> <span class="nav-text">清理证书CSR文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改文件权限和属主"><span class="nav-number">5.9.</span> <span class="nav-text">修改文件权限和属主</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查生成的文件"><span class="nav-number">5.10.</span> <span class="nav-text">检查生成的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分发证书文件和kubeconfig到master节点"><span class="nav-number">5.11.</span> <span class="nav-text">分发证书文件和kubeconfig到master节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kubernetes-master节点"><span class="nav-number">6.</span> <span class="nav-text">kubernetes-master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#master节点说明"><span class="nav-number">6.1.</span> <span class="nav-text">master节点说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署配置Keepalived和HAProxy"><span class="nav-number">6.2.</span> <span class="nav-text">部署配置Keepalived和HAProxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#切换工作目录"><span class="nav-number">6.2.1.</span> <span class="nav-text">切换工作目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Keepalived和HAProxy"><span class="nav-number">6.2.2.</span> <span class="nav-text">安装Keepalived和HAProxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置keepalived"><span class="nav-number">6.2.3.</span> <span class="nav-text">配置keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置haproxy"><span class="nav-number">6.2.4.</span> <span class="nav-text">配置haproxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发配置文件到master节点"><span class="nav-number">6.2.5.</span> <span class="nav-text">分发配置文件到master节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动keepalived和haproxy"><span class="nav-number">6.2.6.</span> <span class="nav-text">启动keepalived和haproxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证VIP"><span class="nav-number">6.2.7.</span> <span class="nav-text">验证VIP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署etcd集群"><span class="nav-number">6.3.</span> <span class="nav-text">部署etcd集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置etcd-service文件"><span class="nav-number">6.3.1.</span> <span class="nav-text">配置etcd.service文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd-config-yml模板"><span class="nav-number">6.3.2.</span> <span class="nav-text">etcd.config.yml模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发配置文件"><span class="nav-number">6.3.3.</span> <span class="nav-text">分发配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动etcd集群"><span class="nav-number">6.3.4.</span> <span class="nav-text">启动etcd集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证etcd集群状态"><span class="nav-number">6.3.5.</span> <span class="nav-text">验证etcd集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Master组件服务"><span class="nav-number">6.4.</span> <span class="nav-text">Master组件服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#master组件配置模板"><span class="nav-number">6.4.1.</span> <span class="nav-text">master组件配置模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd服务文件"><span class="nav-number">6.4.2.</span> <span class="nav-text">systemd服务文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发配置文件到各master节点"><span class="nav-number">6.4.3.</span> <span class="nav-text">分发配置文件到各master节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动kubernetes服务"><span class="nav-number">6.4.4.</span> <span class="nav-text">启动kubernetes服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置kubectl"><span class="nav-number">6.4.5.</span> <span class="nav-text">设置kubectl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置命令补全"><span class="nav-number">6.4.6.</span> <span class="nav-text">设置命令补全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置kubelet的bootstrap启动所需的RBAC"><span class="nav-number">6.4.7.</span> <span class="nav-text">设置kubelet的bootstrap启动所需的RBAC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kubernetes-worker节点"><span class="nav-number">7.</span> <span class="nav-text">kubernetes worker节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#worker节点说明"><span class="nav-number">7.1.</span> <span class="nav-text">worker节点说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#切换工作目录-1"><span class="nav-number">7.2.</span> <span class="nav-text">切换工作目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#worker组件配置模板"><span class="nav-number">7.3.</span> <span class="nav-text">worker组件配置模板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#systemd服务文件-1"><span class="nav-number">7.4.</span> <span class="nav-text">systemd服务文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分发二进制文件"><span class="nav-number">7.5.</span> <span class="nav-text">分发二进制文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分发配置文件和服务文件"><span class="nav-number">7.6.</span> <span class="nav-text">分发配置文件和服务文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动服务"><span class="nav-number">7.7.</span> <span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取节点信息"><span class="nav-number">7.8.</span> <span class="nav-text">获取节点信息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kubernetes-Core-Addons"><span class="nav-number">8.</span> <span class="nav-text">kubernetes Core Addons</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#网络组件部署（任选其一）"><span class="nav-number">8.1.</span> <span class="nav-text">网络组件部署（任选其一）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建工作目录-1"><span class="nav-number">8.1.1.</span> <span class="nav-text">创建工作目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-flannel"><span class="nav-number">8.1.2.</span> <span class="nav-text">kube-flannel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calico"><span class="nav-number">8.1.3.</span> <span class="nav-text">Calico</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查节点状态"><span class="nav-number">8.1.4.</span> <span class="nav-text">检查节点状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务发现组件部署"><span class="nav-number">8.2.</span> <span class="nav-text">服务发现组件部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建工作目录-2"><span class="nav-number">8.2.1.</span> <span class="nav-text">创建工作目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CoreDNS"><span class="nav-number">8.2.2.</span> <span class="nav-text">CoreDNS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证集群DNS服务"><span class="nav-number">8.2.3.</span> <span class="nav-text">验证集群DNS服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Metrics-Server"><span class="nav-number">8.3.</span> <span class="nav-text">Metrics Server</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#至此集群已具备基本功能"><span class="nav-number">9.</span> <span class="nav-text">至此集群已具备基本功能</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kubernetes-Extra-Addons"><span class="nav-number">10.</span> <span class="nav-text">kubernetes Extra Addons</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dashboard"><span class="nav-number">10.1.</span> <span class="nav-text">Dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ingress-Controller"><span class="nav-number">10.2.</span> <span class="nav-text">Ingress Controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm（填坑中）"><span class="nav-number">10.3.</span> <span class="nav-text">Helm（填坑中）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prometheus（填坑中）"><span class="nav-number">10.4.</span> <span class="nav-text">Prometheus（填坑中）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELK（填坑中）"><span class="nav-number">10.5.</span> <span class="nav-text">ELK（填坑中）</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">乱愣黎</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">16.4k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("Ud2l4uLerav3PFrmAnVI4tDz-gzGzoHsz", "vy29JxqPATrJXMXqS1I3nlg1");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
